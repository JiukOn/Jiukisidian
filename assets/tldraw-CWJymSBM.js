import{c as Xt,g as lo,R as Ye,r as v,j as h,a as nm,b as gk,d as mk,w as yk,p as Sk,T as xk,D as bk,I as wk,S as vk,e as Pk,P as qd,f as Ik,h as sm,i as rm,C as im,k as l0,l as _k,m as om,n as d0,o as u0,q as h0,A as p0,s as Ck,t as Tk,B as Ek,u as kk,v as Ak,x as Mk,y as jk,z as am,E as cm,F as lm,G as dm,H as Dk,J as Ok,K as Lk,L as Rk,M as Fk,N as Bk,O as zk,Q as $k,U as Nk,V as Uk,W as Hk,X as Kk,Y as Wk,Z as qk,_ as Gk,$ as Yk,a0 as Vk,a1 as Xk,a2 as Zk,a3 as Jk,a4 as Qk,a5 as eA,a6 as nS}from"./vendor-yedBMiyQ.js";import{N as tA,g as nA,a as sA,E as rA,C as iA,H as f0,S as oA,e as aA,b as cA,c as lA,d as dA,f as uA}from"./tiptap-Da36d8-z.js";const Sh="__TLDRAW_LIBRARY_VERSIONS__";function hA(){if(globalThis[Sh])return globalThis[Sh];const t={versions:[],didWarn:!1,scheduledNotice:null};return Object.defineProperty(globalThis,Sh,{value:t,writable:!1,configurable:!1,enumerable:!1}),t}function Di(t,e,n){if(!t||!e||!n)throw new Error("Missing name/version/module system in built version of tldraw library");const s=hA();if(s.versions.push({name:t,version:e,modules:n}),!s.scheduledNotice)try{s.scheduledNotice=setTimeout(()=>{s.scheduledNotice=null,sS(s)},100)}catch{sS(s)}}function sS(t){if(!t.versions.length||t.didWarn)return;const e=t.versions.sort((a,c)=>rS(a.version,c.version)),n=e[e.length-1].version,s=new Set,r=new Map;for(const a of e){if(r.has(a.name)){s.delete(a.name),xh(r,a.name,new Set).add(a.version);continue}a.version===n?s.add(a.name):(s.delete(a.name),xh(r,a.name,new Set).add(a.version))}if(r.size>0){const a=[`${Ur("[tldraw]",["bold","bgRed","textWhite"])} ${Ur("You have multiple versions of tldraw libraries installed. This can lead to bugs and unexpected behavior.",["textRed","bold"])}`,"",`The latest version you have installed is ${Ur(`v${n}`,["bold","textBlue"])}. The following libraries are on the latest version:`,...Array.from(s,c=>`  • ✅ ${Ur(c,["bold"])}`),"","The following libraries are not on the latest version, or have multiple versions installed:",...Array.from(r,([c,l])=>{const u=Array.from(l).sort(rS).map(d=>Ur(`v${d}`,d===n?["textGreen"]:["textRed"]));return`  • ❌ ${Ur(c,["bold"])} (${u.join(", ")})`})];console.log(a.join(`
`)),t.didWarn=!0;return}const i=new Map;for(const a of e)xh(i,a.name,{version:a.version,modules:[]}).modules.push(a.modules);const o=new Map;for(const[a,c]of i)c.modules.length>1&&o.set(a,c);if(o.size>0){const a=[`${Ur("[tldraw]",["bold","bgRed","textWhite"])} ${Ur("You have multiple instances of some tldraw libraries active. This can lead to bugs and unexpected behavior. ",["textRed","bold"])}`,"","This usually means that your bundler is misconfigured, and is importing the same library multiple times - usually once as an ES Module, and once as a CommonJS module.","","The following libraries have been imported multiple times:",...Array.from(o,([c,l])=>{const u=l.modules.map((d,p)=>d==="esm"?`      ${p+1}. ES Modules`:`      ${p+1}. CommonJS`).join(`
`);return`  • ❌ ${Ur(c,["bold"])} v${l.version}: 
${u}`}),"","You should configure your bundler to only import one version of each library."];console.log(a.join(`
`)),t.didWarn=!0;return}}function rS(t,e){const n=t.match(/^(\d+)\.(\d+)\.(\d+)(?:-(\w+))?$/),s=e.match(/^(\d+)\.(\d+)\.(\d+)(?:-(\w+))?$/);return!n||!s?t.localeCompare(e):n[1]!==s[1]?Number(n[1])-Number(s[1]):n[2]!==s[2]?Number(n[2])-Number(s[2]):n[3]!==s[3]?Number(n[3])-Number(s[3]):n[4]&&s[4]?n[4].localeCompare(s[4]):n[4]?1:s[4]?-1:0}const pA={bold:"1",textBlue:"94",textRed:"31",textGreen:"32",bgRed:"41",textWhite:"97"};function Ur(t,e=[]){return`\x1B[${e.map(n=>pA[n]).join(";")}m${t}\x1B[m`}function xh(t,e,n){return t.has(e)?t.get(e):(t.set(e,n),n)}var Ha={exports:{}};Ha.exports;var iS;function fA(){return iS||(iS=1,(function(t,e){var n=200,s="__lodash_hash_undefined__",r=1,i=2,o=9007199254740991,a="[object Arguments]",c="[object Array]",l="[object AsyncFunction]",u="[object Boolean]",d="[object Date]",p="[object Error]",f="[object Function]",g="[object GeneratorFunction]",x="[object Map]",y="[object Number]",m="[object Null]",S="[object Object]",w="[object Promise]",P="[object Proxy]",_="[object RegExp]",I="[object Set]",C="[object String]",E="[object Symbol]",O="[object Undefined]",k="[object WeakMap]",T="[object ArrayBuffer]",D="[object DataView]",R="[object Float32Array]",M="[object Float64Array]",L="[object Int8Array]",U="[object Int16Array]",V="[object Int32Array]",J="[object Uint8Array]",Z="[object Uint8ClampedArray]",Q="[object Uint16Array]",Y="[object Uint32Array]",Ie=/[\\^$.*+?()[\]{}|]/g,be=/^\[object .+?Constructor\]$/,me=/^(?:0|[1-9]\d*)$/,ne={};ne[R]=ne[M]=ne[L]=ne[U]=ne[V]=ne[J]=ne[Z]=ne[Q]=ne[Y]=!0,ne[a]=ne[c]=ne[T]=ne[u]=ne[D]=ne[d]=ne[p]=ne[f]=ne[x]=ne[y]=ne[S]=ne[_]=ne[I]=ne[C]=ne[k]=!1;var Me=typeof Xt=="object"&&Xt&&Xt.Object===Object&&Xt,ge=typeof self=="object"&&self&&self.Object===Object&&self,ce=Me||ge||Function("return this")(),_e=e&&!e.nodeType&&e,ye=_e&&!0&&t&&!t.nodeType&&t,ht=ye&&ye.exports===_e,st=ht&&Me.process,Ze=(function(){try{return st&&st.binding&&st.binding("util")}catch{}})(),rt=Ze&&Ze.isTypedArray;function it(A,B){for(var G=-1,ue=A==null?0:A.length,lt=0,Fe=[];++G<ue;){var It=A[G];B(It,G,A)&&(Fe[lt++]=It)}return Fe}function en(A,B){for(var G=-1,ue=B.length,lt=A.length;++G<ue;)A[lt+G]=B[G];return A}function Vn(A,B){for(var G=-1,ue=A==null?0:A.length;++G<ue;)if(B(A[G],G,A))return!0;return!1}function cs(A,B){for(var G=-1,ue=Array(A);++G<A;)ue[G]=B(G);return ue}function ls(A){return function(B){return A(B)}}function kn(A,B){return A.has(B)}function pn(A,B){return A?.[B]}function Er(A){var B=-1,G=Array(A.size);return A.forEach(function(ue,lt){G[++B]=[lt,ue]}),G}function ci(A,B){return function(G){return A(B(G))}}function li(A){var B=-1,G=Array(A.size);return A.forEach(function(ue){G[++B]=ue}),G}var ds=Array.prototype,kr=Function.prototype,di=Object.prototype,Ar=ce["__core-js_shared__"],$i=kr.toString,H=di.hasOwnProperty,te=(function(){var A=/[^.]+$/.exec(Ar&&Ar.keys&&Ar.keys.IE_PROTO||"");return A?"Symbol(src)_1."+A:""})(),we=di.toString,Je=RegExp("^"+$i.call(H).replace(Ie,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),An=ht?ce.Buffer:void 0,fn=ce.Symbol,Mr=ce.Uint8Array,us=di.propertyIsEnumerable,Mn=ds.splice,Es=fn?fn.toStringTag:void 0,Hs=Object.getOwnPropertySymbols,jr=An?An.isBuffer:void 0,bo=ci(Object.keys,Object),va=zr(ce,"DataView"),ui=zr(ce,"Map"),Ni=zr(ce,"Promise"),Ks=zr(ce,"Set"),Pa=zr(ce,"WeakMap"),Ui=zr(Object,"create"),Gu=he(va),Yu=he(ui),Vu=he(Ni),Ws=he(Ks),Xu=he(Pa),ll=fn?fn.prototype:void 0,Ia=ll?ll.valueOf:void 0;function Dr(A){var B=-1,G=A==null?0:A.length;for(this.clear();++B<G;){var ue=A[B];this.set(ue[0],ue[1])}}function Zu(){this.__data__=Ui?Ui(null):{},this.size=0}function Or(A){var B=this.has(A)&&delete this.__data__[A];return this.size-=B?1:0,B}function Ju(A){var B=this.__data__;if(Ui){var G=B[A];return G===s?void 0:G}return H.call(B,A)?B[A]:void 0}function Qu(A){var B=this.__data__;return Ui?B[A]!==void 0:H.call(B,A)}function eh(A,B){var G=this.__data__;return this.size+=this.has(A)?0:1,G[A]=Ui&&B===void 0?s:B,this}Dr.prototype.clear=Zu,Dr.prototype.delete=Or,Dr.prototype.get=Ju,Dr.prototype.has=Qu,Dr.prototype.set=eh;function qs(A){var B=-1,G=A==null?0:A.length;for(this.clear();++B<G;){var ue=A[B];this.set(ue[0],ue[1])}}function th(){this.__data__=[],this.size=0}function wo(A){var B=this.__data__,G=Fr(B,A);if(G<0)return!1;var ue=B.length-1;return G==ue?B.pop():Mn.call(B,G,1),--this.size,!0}function nh(A){var B=this.__data__,G=Fr(B,A);return G<0?void 0:B[G][1]}function sh(A){return Fr(this.__data__,A)>-1}function or(A,B){var G=this.__data__,ue=Fr(G,A);return ue<0?(++this.size,G.push([A,B])):G[ue][1]=B,this}qs.prototype.clear=th,qs.prototype.delete=wo,qs.prototype.get=nh,qs.prototype.has=sh,qs.prototype.set=or;function Lr(A){var B=-1,G=A==null?0:A.length;for(this.clear();++B<G;){var ue=A[B];this.set(ue[0],ue[1])}}function rh(){this.size=0,this.__data__={hash:new Dr,map:new(ui||qs),string:new Dr}}function ih(A){var B=vo(this,A).delete(A);return this.size-=B?1:0,B}function oh(A){return vo(this,A).get(A)}function ah(A){return vo(this,A).has(A)}function ch(A,B){var G=vo(this,A),ue=G.size;return G.set(A,B),this.size+=G.size==ue?0:1,this}Lr.prototype.clear=rh,Lr.prototype.delete=ih,Lr.prototype.get=oh,Lr.prototype.has=ah,Lr.prototype.set=ch;function Rr(A){var B=-1,G=A==null?0:A.length;for(this.__data__=new Lr;++B<G;)this.add(A[B])}function lh(A){return this.__data__.set(A,s),this}function dl(A){return this.__data__.has(A)}Rr.prototype.add=Rr.prototype.push=lh,Rr.prototype.has=dl;function ar(A){var B=this.__data__=new qs(A);this.size=B.size}function dh(){this.__data__=new qs,this.size=0}function uh(A){var B=this.__data__,G=B.delete(A);return this.size=B.size,G}function hh(A){return this.__data__.get(A)}function ul(A){return this.__data__.has(A)}function ph(A,B){var G=this.__data__;if(G instanceof qs){var ue=G.__data__;if(!ui||ue.length<n-1)return ue.push([A,B]),this.size=++G.size,this;G=this.__data__=new Lr(ue)}return G.set(A,B),this.size=G.size,this}ar.prototype.clear=dh,ar.prototype.delete=uh,ar.prototype.get=hh,ar.prototype.has=ul,ar.prototype.set=ph;function fh(A,B){var G=Rt(A),ue=!G&&Oe(A),lt=!G&&!ue&&Ft(A),Fe=!G&&!ue&&!lt&&Dn(A),It=G||ue||lt||Fe,qt=It?cs(A.length,String):[],tn=qt.length;for(var xt in A)H.call(A,xt)&&!(It&&(xt=="length"||lt&&(xt=="offset"||xt=="parent")||Fe&&(xt=="buffer"||xt=="byteLength"||xt=="byteOffset")||yh(xt,tn)))&&qt.push(xt);return qt}function Fr(A,B){for(var G=A.length;G--;)if(pt(A[G][0],B))return G;return-1}function hi(A,B,G){var ue=B(A);return Rt(A)?ue:en(ue,G(A))}function Xn(A){return A==null?A===void 0?O:m:Es&&Es in Object(A)?Sl(A):ee(A)}function hl(A){return Wt(A)&&Xn(A)==a}function pl(A,B,G,ue,lt){return A===B?!0:A==null||B==null||!Wt(A)&&!Wt(B)?A!==A&&B!==B:gh(A,B,G,ue,pl,lt)}function gh(A,B,G,ue,lt,Fe){var It=Rt(A),qt=Rt(B),tn=It?c:ks(A),xt=qt?c:ks(B);tn=tn==a?S:tn,xt=xt==a?S:xt;var hs=tn==S,Ys=xt==S,yn=tn==xt;if(yn&&Ft(A)){if(!Ft(B))return!1;It=!0,hs=!1}if(yn&&!hs)return Fe||(Fe=new ar),It||Dn(A)?gl(A,B,G,ue,lt,Fe):_a(A,B,tn,G,ue,lt,Fe);if(!(G&r)){var As=hs&&H.call(A,"__wrapped__"),Ms=Ys&&H.call(B,"__wrapped__");if(As||Ms){var pi=As?A.value():A,Nr=Ms?B.value():B;return Fe||(Fe=new ar),lt(pi,Nr,G,ue,Fe)}}return yn?(Fe||(Fe=new ar),ml(A,B,G,ue,lt,Fe)):!1}function mh(A){if(!Kt(A)||j(A))return!1;var B=jn(A)?Je:be;return B.test(he(A))}function Br(A){return Wt(A)&&Zn(A.length)&&!!ne[Xn(A)]}function fl(A){if(!N(A))return bo(A);var B=[];for(var G in Object(A))H.call(A,G)&&G!="constructor"&&B.push(G);return B}function gl(A,B,G,ue,lt,Fe){var It=G&r,qt=A.length,tn=B.length;if(qt!=tn&&!(It&&tn>qt))return!1;var xt=Fe.get(A);if(xt&&Fe.get(B))return xt==B;var hs=-1,Ys=!0,yn=G&i?new Rr:void 0;for(Fe.set(A,B),Fe.set(B,A);++hs<qt;){var As=A[hs],Ms=B[hs];if(ue)var pi=It?ue(Ms,As,hs,B,A,Fe):ue(As,Ms,hs,A,B,Fe);if(pi!==void 0){if(pi)continue;Ys=!1;break}if(yn){if(!Vn(B,function(Nr,Hi){if(!kn(yn,Hi)&&(As===Nr||lt(As,Nr,G,ue,Fe)))return yn.push(Hi)})){Ys=!1;break}}else if(!(As===Ms||lt(As,Ms,G,ue,Fe))){Ys=!1;break}}return Fe.delete(A),Fe.delete(B),Ys}function _a(A,B,G,ue,lt,Fe,It){switch(G){case D:if(A.byteLength!=B.byteLength||A.byteOffset!=B.byteOffset)return!1;A=A.buffer,B=B.buffer;case T:return!(A.byteLength!=B.byteLength||!Fe(new Mr(A),new Mr(B)));case u:case d:case y:return pt(+A,+B);case p:return A.name==B.name&&A.message==B.message;case _:case C:return A==B+"";case x:var qt=Er;case I:var tn=ue&r;if(qt||(qt=li),A.size!=B.size&&!tn)return!1;var xt=It.get(A);if(xt)return xt==B;ue|=i,It.set(A,B);var hs=gl(qt(A),qt(B),ue,lt,Fe,It);return It.delete(A),hs;case E:if(Ia)return Ia.call(A)==Ia.call(B)}return!1}function ml(A,B,G,ue,lt,Fe){var It=G&r,qt=yl(A),tn=qt.length,xt=yl(B),hs=xt.length;if(tn!=hs&&!It)return!1;for(var Ys=tn;Ys--;){var yn=qt[Ys];if(!(It?yn in B:H.call(B,yn)))return!1}var As=Fe.get(A);if(As&&Fe.get(B))return As==B;var Ms=!0;Fe.set(A,B),Fe.set(B,A);for(var pi=It;++Ys<tn;){yn=qt[Ys];var Nr=A[yn],Hi=B[yn];if(ue)var tS=It?ue(Hi,Nr,yn,B,A,Fe):ue(Nr,Hi,yn,A,B,Fe);if(!(tS===void 0?Nr===Hi||lt(Nr,Hi,G,ue,Fe):tS)){Ms=!1;break}pi||(pi=yn=="constructor")}if(Ms&&!pi){var bl=A.constructor,wl=B.constructor;bl!=wl&&"constructor"in A&&"constructor"in B&&!(typeof bl=="function"&&bl instanceof bl&&typeof wl=="function"&&wl instanceof wl)&&(Ms=!1)}return Fe.delete(A),Fe.delete(B),Ms}function yl(A){return hi(A,cr,Ca)}function vo(A,B){var G=A.__data__;return xl(B)?G[typeof B=="string"?"string":"hash"]:G.map}function zr(A,B){var G=pn(A,B);return mh(G)?G:void 0}function Sl(A){var B=H.call(A,Es),G=A[Es];try{A[Es]=void 0;var ue=!0}catch{}var lt=we.call(A);return ue&&(B?A[Es]=G:delete A[Es]),lt}var Ca=Hs?function(A){return A==null?[]:(A=Object(A),it(Hs(A),function(B){return us.call(A,B)}))}:Gs,ks=Xn;(va&&ks(new va(new ArrayBuffer(1)))!=D||ui&&ks(new ui)!=x||Ni&&ks(Ni.resolve())!=w||Ks&&ks(new Ks)!=I||Pa&&ks(new Pa)!=k)&&(ks=function(A){var B=Xn(A),G=B==S?A.constructor:void 0,ue=G?he(G):"";if(ue)switch(ue){case Gu:return D;case Yu:return x;case Vu:return w;case Ws:return I;case Xu:return k}return B});function yh(A,B){return B=B??o,!!B&&(typeof A=="number"||me.test(A))&&A>-1&&A%1==0&&A<B}function xl(A){var B=typeof A;return B=="string"||B=="number"||B=="symbol"||B=="boolean"?A!=="__proto__":A===null}function j(A){return!!te&&te in A}function N(A){var B=A&&A.constructor,G=typeof B=="function"&&B.prototype||di;return A===G}function ee(A){return we.call(A)}function he(A){if(A!=null){try{return $i.call(A)}catch{}try{return A+""}catch{}}return""}function pt(A,B){return A===B||A!==A&&B!==B}var Oe=hl((function(){return arguments})())?hl:function(A){return Wt(A)&&H.call(A,"callee")&&!us.call(A,"callee")},Rt=Array.isArray;function gn(A){return A!=null&&Zn(A.length)&&!jn(A)}var Ft=jr||$r;function mn(A,B){return pl(A,B)}function jn(A){if(!Kt(A))return!1;var B=Xn(A);return B==f||B==g||B==l||B==P}function Zn(A){return typeof A=="number"&&A>-1&&A%1==0&&A<=o}function Kt(A){var B=typeof A;return A!=null&&(B=="object"||B=="function")}function Wt(A){return A!=null&&typeof A=="object"}var Dn=rt?ls(rt):Br;function cr(A){return gn(A)?fh(A):fl(A)}function Gs(){return[]}function $r(){return!1}t.exports=mn})(Ha,Ha.exports)),Ha.exports}var gA=fA();const xr=lo(gA);var Ka={exports:{}};Ka.exports;var oS;function mA(){return oS||(oS=1,(function(t,e){var n=200,s="__lodash_hash_undefined__",r=1,i=2,o=9007199254740991,a="[object Arguments]",c="[object Array]",l="[object Boolean]",u="[object Date]",d="[object Error]",p="[object Function]",f="[object GeneratorFunction]",g="[object Map]",x="[object Number]",y="[object Object]",m="[object Promise]",S="[object RegExp]",w="[object Set]",P="[object String]",_="[object Symbol]",I="[object WeakMap]",C="[object ArrayBuffer]",E="[object DataView]",O="[object Float32Array]",k="[object Float64Array]",T="[object Int8Array]",D="[object Int16Array]",R="[object Int32Array]",M="[object Uint8Array]",L="[object Uint8ClampedArray]",U="[object Uint16Array]",V="[object Uint32Array]",J=/[\\^$.*+?()[\]{}|]/g,Z=/^\[object .+?Constructor\]$/,Q=/^(?:0|[1-9]\d*)$/,Y={};Y[O]=Y[k]=Y[T]=Y[D]=Y[R]=Y[M]=Y[L]=Y[U]=Y[V]=!0,Y[a]=Y[c]=Y[C]=Y[l]=Y[E]=Y[u]=Y[d]=Y[p]=Y[g]=Y[x]=Y[y]=Y[S]=Y[w]=Y[P]=Y[I]=!1;var Ie=typeof Xt=="object"&&Xt&&Xt.Object===Object&&Xt,be=typeof self=="object"&&self&&self.Object===Object&&self,me=Ie||be||Function("return this")(),ne=e&&!e.nodeType&&e,Me=ne&&!0&&t&&!t.nodeType&&t,ge=Me&&Me.exports===ne,ce=ge&&Ie.process,_e=(function(){try{return ce&&ce.binding("util")}catch{}})(),ye=_e&&_e.isTypedArray;function ht(j,N){for(var ee=-1,he=j?j.length:0;++ee<he;)if(N(j[ee],ee,j))return!0;return!1}function st(j,N){for(var ee=-1,he=Array(j);++ee<j;)he[ee]=N(ee);return he}function Ze(j){return function(N){return j(N)}}function rt(j,N){return j?.[N]}function it(j){var N=!1;if(j!=null&&typeof j.toString!="function")try{N=!!(j+"")}catch{}return N}function en(j){var N=-1,ee=Array(j.size);return j.forEach(function(he,pt){ee[++N]=[pt,he]}),ee}function Vn(j,N){return function(ee){return j(N(ee))}}function cs(j){var N=-1,ee=Array(j.size);return j.forEach(function(he){ee[++N]=he}),ee}var ls=Array.prototype,kn=Function.prototype,pn=Object.prototype,Er=me["__core-js_shared__"],ci=(function(){var j=/[^.]+$/.exec(Er&&Er.keys&&Er.keys.IE_PROTO||"");return j?"Symbol(src)_1."+j:""})(),li=kn.toString,ds=pn.hasOwnProperty,kr=pn.toString,di=RegExp("^"+li.call(ds).replace(J,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Ar=me.Symbol,$i=me.Uint8Array,H=pn.propertyIsEnumerable,te=ls.splice,we=Vn(Object.keys,Object),Je=hi(me,"DataView"),An=hi(me,"Map"),fn=hi(me,"Promise"),Mr=hi(me,"Set"),us=hi(me,"WeakMap"),Mn=hi(Object,"create"),Es=Br(Je),Hs=Br(An),jr=Br(fn),bo=Br(Mr),va=Br(us),ui=Ar?Ar.prototype:void 0,Ni=ui?ui.valueOf:void 0;function Ks(j){var N=-1,ee=j?j.length:0;for(this.clear();++N<ee;){var he=j[N];this.set(he[0],he[1])}}function Pa(){this.__data__=Mn?Mn(null):{}}function Ui(j){return this.has(j)&&delete this.__data__[j]}function Gu(j){var N=this.__data__;if(Mn){var ee=N[j];return ee===s?void 0:ee}return ds.call(N,j)?N[j]:void 0}function Yu(j){var N=this.__data__;return Mn?N[j]!==void 0:ds.call(N,j)}function Vu(j,N){var ee=this.__data__;return ee[j]=Mn&&N===void 0?s:N,this}Ks.prototype.clear=Pa,Ks.prototype.delete=Ui,Ks.prototype.get=Gu,Ks.prototype.has=Yu,Ks.prototype.set=Vu;function Ws(j){var N=-1,ee=j?j.length:0;for(this.clear();++N<ee;){var he=j[N];this.set(he[0],he[1])}}function Xu(){this.__data__=[]}function ll(j){var N=this.__data__,ee=Rr(N,j);if(ee<0)return!1;var he=N.length-1;return ee==he?N.pop():te.call(N,ee,1),!0}function Ia(j){var N=this.__data__,ee=Rr(N,j);return ee<0?void 0:N[ee][1]}function Dr(j){return Rr(this.__data__,j)>-1}function Zu(j,N){var ee=this.__data__,he=Rr(ee,j);return he<0?ee.push([j,N]):ee[he][1]=N,this}Ws.prototype.clear=Xu,Ws.prototype.delete=ll,Ws.prototype.get=Ia,Ws.prototype.has=Dr,Ws.prototype.set=Zu;function Or(j){var N=-1,ee=j?j.length:0;for(this.clear();++N<ee;){var he=j[N];this.set(he[0],he[1])}}function Ju(){this.__data__={hash:new Ks,map:new(An||Ws),string:new Ks}}function Qu(j){return Fr(this,j).delete(j)}function eh(j){return Fr(this,j).get(j)}function qs(j){return Fr(this,j).has(j)}function th(j,N){return Fr(this,j).set(j,N),this}Or.prototype.clear=Ju,Or.prototype.delete=Qu,Or.prototype.get=eh,Or.prototype.has=qs,Or.prototype.set=th;function wo(j){var N=-1,ee=j?j.length:0;for(this.__data__=new Or;++N<ee;)this.add(j[N])}function nh(j){return this.__data__.set(j,s),this}function sh(j){return this.__data__.has(j)}wo.prototype.add=wo.prototype.push=nh,wo.prototype.has=sh;function or(j){this.__data__=new Ws(j)}function Lr(){this.__data__=new Ws}function rh(j){return this.__data__.delete(j)}function ih(j){return this.__data__.get(j)}function oh(j){return this.__data__.has(j)}function ah(j,N){var ee=this.__data__;if(ee instanceof Ws){var he=ee.__data__;if(!An||he.length<n-1)return he.push([j,N]),this;ee=this.__data__=new Or(he)}return ee.set(j,N),this}or.prototype.clear=Lr,or.prototype.delete=rh,or.prototype.get=ih,or.prototype.has=oh,or.prototype.set=ah;function ch(j,N){var ee=_a(j)||gl(j)?st(j.length,String):[],he=ee.length,pt=!!he;for(var Oe in j)ds.call(j,Oe)&&!(pt&&(Oe=="length"||hl(Oe,he)))&&ee.push(Oe);return ee}function Rr(j,N){for(var ee=j.length;ee--;)if(fl(j[ee][0],N))return ee;return-1}function lh(j){return kr.call(j)}function dl(j,N,ee,he,pt){return j===N?!0:j==null||N==null||!Ca(j)&&!ks(N)?j!==j&&N!==N:ar(j,N,dl,ee,he,pt)}function ar(j,N,ee,he,pt,Oe){var Rt=_a(j),gn=_a(N),Ft=c,mn=c;Rt||(Ft=Xn(j),Ft=Ft==a?y:Ft),gn||(mn=Xn(N),mn=mn==a?y:mn);var jn=Ft==y&&!it(j),Zn=mn==y&&!it(N),Kt=Ft==mn;if(Kt&&!jn)return Oe||(Oe=new or),Rt||yh(j)?ul(j,N,ee,he,pt,Oe):ph(j,N,Ft,ee,he,pt,Oe);if(!(pt&i)){var Wt=jn&&ds.call(j,"__wrapped__"),Dn=Zn&&ds.call(N,"__wrapped__");if(Wt||Dn){var cr=Wt?j.value():j,Gs=Dn?N.value():N;return Oe||(Oe=new or),ee(cr,Gs,he,pt,Oe)}}return Kt?(Oe||(Oe=new or),fh(j,N,ee,he,pt,Oe)):!1}function dh(j){if(!Ca(j)||gh(j))return!1;var N=zr(j)||it(j)?di:Z;return N.test(Br(j))}function uh(j){return ks(j)&&Sl(j.length)&&!!Y[kr.call(j)]}function hh(j){if(!mh(j))return we(j);var N=[];for(var ee in Object(j))ds.call(j,ee)&&ee!="constructor"&&N.push(ee);return N}function ul(j,N,ee,he,pt,Oe){var Rt=pt&i,gn=j.length,Ft=N.length;if(gn!=Ft&&!(Rt&&Ft>gn))return!1;var mn=Oe.get(j);if(mn&&Oe.get(N))return mn==N;var jn=-1,Zn=!0,Kt=pt&r?new wo:void 0;for(Oe.set(j,N),Oe.set(N,j);++jn<gn;){var Wt=j[jn],Dn=N[jn];if(he)var cr=Rt?he(Dn,Wt,jn,N,j,Oe):he(Wt,Dn,jn,j,N,Oe);if(cr!==void 0){if(cr)continue;Zn=!1;break}if(Kt){if(!ht(N,function(Gs,$r){if(!Kt.has($r)&&(Wt===Gs||ee(Wt,Gs,he,pt,Oe)))return Kt.add($r)})){Zn=!1;break}}else if(!(Wt===Dn||ee(Wt,Dn,he,pt,Oe))){Zn=!1;break}}return Oe.delete(j),Oe.delete(N),Zn}function ph(j,N,ee,he,pt,Oe,Rt){switch(ee){case E:if(j.byteLength!=N.byteLength||j.byteOffset!=N.byteOffset)return!1;j=j.buffer,N=N.buffer;case C:return!(j.byteLength!=N.byteLength||!he(new $i(j),new $i(N)));case l:case u:case x:return fl(+j,+N);case d:return j.name==N.name&&j.message==N.message;case S:case P:return j==N+"";case g:var gn=en;case w:var Ft=Oe&i;if(gn||(gn=cs),j.size!=N.size&&!Ft)return!1;var mn=Rt.get(j);if(mn)return mn==N;Oe|=r,Rt.set(j,N);var jn=ul(gn(j),gn(N),he,pt,Oe,Rt);return Rt.delete(j),jn;case _:if(Ni)return Ni.call(j)==Ni.call(N)}return!1}function fh(j,N,ee,he,pt,Oe){var Rt=pt&i,gn=xl(j),Ft=gn.length,mn=xl(N),jn=mn.length;if(Ft!=jn&&!Rt)return!1;for(var Zn=Ft;Zn--;){var Kt=gn[Zn];if(!(Rt?Kt in N:ds.call(N,Kt)))return!1}var Wt=Oe.get(j);if(Wt&&Oe.get(N))return Wt==N;var Dn=!0;Oe.set(j,N),Oe.set(N,j);for(var cr=Rt;++Zn<Ft;){Kt=gn[Zn];var Gs=j[Kt],$r=N[Kt];if(he)var A=Rt?he($r,Gs,Kt,N,j,Oe):he(Gs,$r,Kt,j,N,Oe);if(!(A===void 0?Gs===$r||ee(Gs,$r,he,pt,Oe):A)){Dn=!1;break}cr||(cr=Kt=="constructor")}if(Dn&&!cr){var B=j.constructor,G=N.constructor;B!=G&&"constructor"in j&&"constructor"in N&&!(typeof B=="function"&&B instanceof B&&typeof G=="function"&&G instanceof G)&&(Dn=!1)}return Oe.delete(j),Oe.delete(N),Dn}function Fr(j,N){var ee=j.__data__;return pl(N)?ee[typeof N=="string"?"string":"hash"]:ee.map}function hi(j,N){var ee=rt(j,N);return dh(ee)?ee:void 0}var Xn=lh;(Je&&Xn(new Je(new ArrayBuffer(1)))!=E||An&&Xn(new An)!=g||fn&&Xn(fn.resolve())!=m||Mr&&Xn(new Mr)!=w||us&&Xn(new us)!=I)&&(Xn=function(j){var N=kr.call(j),ee=N==y?j.constructor:void 0,he=ee?Br(ee):void 0;if(he)switch(he){case Es:return E;case Hs:return g;case jr:return m;case bo:return w;case va:return I}return N});function hl(j,N){return N=N??o,!!N&&(typeof j=="number"||Q.test(j))&&j>-1&&j%1==0&&j<N}function pl(j){var N=typeof j;return N=="string"||N=="number"||N=="symbol"||N=="boolean"?j!=="__proto__":j===null}function gh(j){return!!ci&&ci in j}function mh(j){var N=j&&j.constructor,ee=typeof N=="function"&&N.prototype||pn;return j===ee}function Br(j){if(j!=null){try{return li.call(j)}catch{}try{return j+""}catch{}}return""}function fl(j,N){return j===N||j!==j&&N!==N}function gl(j){return yl(j)&&ds.call(j,"callee")&&(!H.call(j,"callee")||kr.call(j)==a)}var _a=Array.isArray;function ml(j){return j!=null&&Sl(j.length)&&!zr(j)}function yl(j){return ks(j)&&ml(j)}function vo(j,N,ee){ee=typeof ee=="function"?ee:void 0;var he=ee?ee(j,N):void 0;return he===void 0?dl(j,N,ee):!!he}function zr(j){var N=Ca(j)?kr.call(j):"";return N==p||N==f}function Sl(j){return typeof j=="number"&&j>-1&&j%1==0&&j<=o}function Ca(j){var N=typeof j;return!!j&&(N=="object"||N=="function")}function ks(j){return!!j&&typeof j=="object"}var yh=ye?Ze(ye):uh;function xl(j){return ml(j)?ch(j):hh(j)}t.exports=vo})(Ka,Ka.exports)),Ka.exports}var yA=mA();const SA=lo(yA);var bh,aS;function xA(){if(aS)return bh;aS=1;var t="Expected a function",e=NaN,n="[object Symbol]",s=/^\s+|\s+$/g,r=/^[-+]0x[0-9a-f]+$/i,i=/^0b[01]+$/i,o=/^0o[0-7]+$/i,a=parseInt,c=typeof Xt=="object"&&Xt&&Xt.Object===Object&&Xt,l=typeof self=="object"&&self&&self.Object===Object&&self,u=c||l||Function("return this")(),d=Object.prototype,p=d.toString,f=Math.max,g=Math.min,x=function(){return u.Date.now()};function y(I,C,E){var O,k,T,D,R,M,L=0,U=!1,V=!1,J=!0;if(typeof I!="function")throw new TypeError(t);C=_(C)||0,S(E)&&(U=!!E.leading,V="maxWait"in E,T=V?f(_(E.maxWait)||0,C):T,J="trailing"in E?!!E.trailing:J);function Z(ce){var _e=O,ye=k;return O=k=void 0,L=ce,D=I.apply(ye,_e),D}function Q(ce){return L=ce,R=setTimeout(be,C),U?Z(ce):D}function Y(ce){var _e=ce-M,ye=ce-L,ht=C-_e;return V?g(ht,T-ye):ht}function Ie(ce){var _e=ce-M,ye=ce-L;return M===void 0||_e>=C||_e<0||V&&ye>=T}function be(){var ce=x();if(Ie(ce))return me(ce);R=setTimeout(be,Y(ce))}function me(ce){return R=void 0,J&&O?Z(ce):(O=k=void 0,D)}function ne(){R!==void 0&&clearTimeout(R),L=0,O=M=k=R=void 0}function Me(){return R===void 0?D:me(x())}function ge(){var ce=x(),_e=Ie(ce);if(O=arguments,k=this,M=ce,_e){if(R===void 0)return Q(M);if(V)return R=setTimeout(be,C),Z(M)}return R===void 0&&(R=setTimeout(be,C)),D}return ge.cancel=ne,ge.flush=Me,ge}function m(I,C,E){var O=!0,k=!0;if(typeof I!="function")throw new TypeError(t);return S(E)&&(O="leading"in E?!!E.leading:O,k="trailing"in E?!!E.trailing:k),y(I,C,{leading:O,maxWait:C,trailing:k})}function S(I){var C=typeof I;return!!I&&(C=="object"||C=="function")}function w(I){return!!I&&typeof I=="object"}function P(I){return typeof I=="symbol"||w(I)&&p.call(I)==n}function _(I){if(typeof I=="number")return I;if(P(I))return e;if(S(I)){var C=typeof I.valueOf=="function"?I.valueOf():I;I=S(C)?C+"":C}if(typeof I!="string")return I===0?I:+I;I=I.replace(s,"");var E=i.test(I);return E||o.test(I)?a(I.slice(2),E?2:8):r.test(I)?e:+I}return bh=m,bh}var bA=xA();const g0=lo(bA);var wh,cS;function wA(){if(cS)return wh;cS=1;var t=200,e="__lodash_hash_undefined__",n=1/0,s="[object Function]",r="[object GeneratorFunction]",i=/[\\^$.*+?()[\]{}|]/g,o=/^\[object .+?Constructor\]$/,a=typeof Xt=="object"&&Xt&&Xt.Object===Object&&Xt,c=typeof self=="object"&&self&&self.Object===Object&&self,l=a||c||Function("return this")();function u(H,te){var we=H?H.length:0;return!!we&&p(H,te,0)>-1}function d(H,te,we,Je){for(var An=H.length,fn=we+-1;++fn<An;)if(te(H[fn],fn,H))return fn;return-1}function p(H,te,we){if(te!==te)return d(H,f,we);for(var Je=we-1,An=H.length;++Je<An;)if(H[Je]===te)return Je;return-1}function f(H){return H!==H}function g(H,te){return H.has(te)}function x(H,te){return H?.[te]}function y(H){var te=!1;if(H!=null&&typeof H.toString!="function")try{te=!!(H+"")}catch{}return te}function m(H){var te=-1,we=Array(H.size);return H.forEach(function(Je){we[++te]=Je}),we}var S=Array.prototype,w=Function.prototype,P=Object.prototype,_=l["__core-js_shared__"],I=(function(){var H=/[^.]+$/.exec(_&&_.keys&&_.keys.IE_PROTO||"");return H?"Symbol(src)_1."+H:""})(),C=w.toString,E=P.hasOwnProperty,O=P.toString,k=RegExp("^"+C.call(E).replace(i,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),T=S.splice,D=pn(l,"Map"),R=pn(l,"Set"),M=pn(Object,"create");function L(H){var te=-1,we=H?H.length:0;for(this.clear();++te<we;){var Je=H[te];this.set(Je[0],Je[1])}}function U(){this.__data__=M?M(null):{}}function V(H){return this.has(H)&&delete this.__data__[H]}function J(H){var te=this.__data__;if(M){var we=te[H];return we===e?void 0:we}return E.call(te,H)?te[H]:void 0}function Z(H){var te=this.__data__;return M?te[H]!==void 0:E.call(te,H)}function Q(H,te){var we=this.__data__;return we[H]=M&&te===void 0?e:te,this}L.prototype.clear=U,L.prototype.delete=V,L.prototype.get=J,L.prototype.has=Z,L.prototype.set=Q;function Y(H){var te=-1,we=H?H.length:0;for(this.clear();++te<we;){var Je=H[te];this.set(Je[0],Je[1])}}function Ie(){this.__data__=[]}function be(H){var te=this.__data__,we=en(te,H);if(we<0)return!1;var Je=te.length-1;return we==Je?te.pop():T.call(te,we,1),!0}function me(H){var te=this.__data__,we=en(te,H);return we<0?void 0:te[we][1]}function ne(H){return en(this.__data__,H)>-1}function Me(H,te){var we=this.__data__,Je=en(we,H);return Je<0?we.push([H,te]):we[Je][1]=te,this}Y.prototype.clear=Ie,Y.prototype.delete=be,Y.prototype.get=me,Y.prototype.has=ne,Y.prototype.set=Me;function ge(H){var te=-1,we=H?H.length:0;for(this.clear();++te<we;){var Je=H[te];this.set(Je[0],Je[1])}}function ce(){this.__data__={hash:new L,map:new(D||Y),string:new L}}function _e(H){return kn(this,H).delete(H)}function ye(H){return kn(this,H).get(H)}function ht(H){return kn(this,H).has(H)}function st(H,te){return kn(this,H).set(H,te),this}ge.prototype.clear=ce,ge.prototype.delete=_e,ge.prototype.get=ye,ge.prototype.has=ht,ge.prototype.set=st;function Ze(H){var te=-1,we=H?H.length:0;for(this.__data__=new ge;++te<we;)this.add(H[te])}function rt(H){return this.__data__.set(H,e),this}function it(H){return this.__data__.has(H)}Ze.prototype.add=Ze.prototype.push=rt,Ze.prototype.has=it;function en(H,te){for(var we=H.length;we--;)if(kr(H[we][0],te))return we;return-1}function Vn(H){if(!Ar(H)||ci(H))return!1;var te=di(H)||y(H)?k:o;return te.test(li(H))}function cs(H,te,we){var Je=-1,An=u,fn=H.length,Mr=!0,us=[],Mn=us;if(fn>=t){var Es=ls(H);if(Es)return m(Es);Mr=!1,An=g,Mn=new Ze}else Mn=us;e:for(;++Je<fn;){var Hs=H[Je],jr=Hs;if(Hs=Hs!==0?Hs:0,Mr&&jr===jr){for(var bo=Mn.length;bo--;)if(Mn[bo]===jr)continue e;us.push(Hs)}else An(Mn,jr,we)||(Mn!==us&&Mn.push(jr),us.push(Hs))}return us}var ls=R&&1/m(new R([,-0]))[1]==n?function(H){return new R(H)}:$i;function kn(H,te){var we=H.__data__;return Er(te)?we[typeof te=="string"?"string":"hash"]:we.map}function pn(H,te){var we=x(H,te);return Vn(we)?we:void 0}function Er(H){var te=typeof H;return te=="string"||te=="number"||te=="symbol"||te=="boolean"?H!=="__proto__":H===null}function ci(H){return!!I&&I in H}function li(H){if(H!=null){try{return C.call(H)}catch{}try{return H+""}catch{}}return""}function ds(H){return H&&H.length?cs(H):[]}function kr(H,te){return H===te||H!==H&&te!==te}function di(H){var te=Ar(H)?O.call(H):"";return te==s||te==r}function Ar(H){var te=typeof H;return!!H&&(te=="object"||te=="function")}function $i(){}return wh=ds,wh}var vA=wA();const PA=lo(vA);function um(t,e){const n=[];e:for(const s of t){for(const r of n)if(e?e(s,r):s===r)continue e;n.push(s)}return n}function ve(t){return t.filter(e=>e!=null)}function Fs(t){return t[t.length-1]}function m0(t,e){let n,s=1/0;for(const r of t){const i=e(r);i<s&&(n=r,s=i)}return n}function IA(t,e){let n,s=-1/0;for(const r of t){const i=e(r);i>s&&(n=r,s=i)}return n}function ud(t,e){if(t===e)return!0;if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(!Object.is(t[n],e[n]))return!1;return!0}function oc(t,e,n){const s=new Set(e.map(i=>i[t])),r=[];for(const i of n)s.has(i[t])||r.push(i);for(const i of e)r.push(i);return r}function y0(t){const e=(...n)=>{try{return t(...n)}catch(s){throw s instanceof Error&&Error.captureStackTrace&&Error.captureStackTrace(s,e),s}};return e}const yc=()=>{},Bs={ok(t){return{ok:!0,value:t}},err(t){return{ok:!1,error:t}},all(t){return t.every(e=>e.ok)?Bs.ok(t.map(e=>e.value)):Bs.err(t.find(e=>!e.ok)?.error)}};function Ke(t,e){const n=e&&t&&typeof t=="object"&&e in t?t[e]:t;throw new Error(`Unknown switch case ${n}`)}const le=y0((t,e)=>{if(!t)throw new Error(e||"Assertion Error")}),Gt=y0((t,e)=>{if(t==null)throw new Error(e??"value must be defined");return t});function hm(){let t,e;const n=new Promise((s,r)=>{t=s,e=r});return Object.assign(n,{resolve:t,reject:e})}function pg(t){return new Promise(e=>setTimeout(e,t))}function rs(...t){if(t.length===2){const[e,n]=t;n.addInitializer(function(){le(Reflect.isExtensible(this),"Cannot bind to a non-extensible class.");const r=e.bind(this),i=Reflect.defineProperty(this,n.name,{value:r,writable:!0,configurable:!0});le(i,"Cannot bind a non-configurable class method.")})}else{const[e,n,s]=t;if(!s||typeof s.value!="function")throw new TypeError(`Only methods can be decorated with @bind. <${n}> is not a method!`);return{configurable:!0,get(){const r=s.value.bind(this);return Object.defineProperty(this,n,{value:r,configurable:!0,writable:!0}),r}}}}class dn{items=new WeakMap;get(e,n){return this.items.has(e)||this.items.set(e,n(e)),this.items.get(e)}}function Gd(t,e){let n;const s=(...r)=>(n||(n={},n.promise=new Promise((i,o)=>{n.resolve=i,n.reject=o})),clearTimeout(n.timeout),n.latestArgs=r,n.timeout=setTimeout(()=>{const i=n;n=void 0;try{i.resolve(t(...i.latestArgs))}catch(o){i.reject(o)}},e),n.promise);return s.cancel=()=>{n&&clearTimeout(n.timeout)},s}const lS=new WeakMap;function pm(t,e){if(typeof t!="object"||t===null)return;let n=lS.get(t);n||(n={tags:{},extras:{}},lS.set(t,n)),e.tags&&(n.tags={...n.tags,...e.tags}),e.extras&&(n.extras={...n.extras,...e.extras})}async function Qr(t,e){return window.fetch(t,{referrerPolicy:"strict-origin-when-cross-origin",...e})}const Sc=(t,e)=>{const n=new window.Image(t,e);return n.referrerPolicy="strict-origin-when-cross-origin",n};class vn{static async urlToArrayBuffer(e){return await(await Qr(e)).arrayBuffer()}static async urlToBlob(e){return await(await Qr(e)).blob()}static async urlToDataUrl(e){if(e.startsWith("data:"))return e;const n=await vn.urlToBlob(e);return await vn.blobToDataUrl(n)}static async blobToDataUrl(e){return await new Promise((n,s)=>{if(e){const r=new FileReader;r.onload=()=>n(r.result),r.onerror=i=>s(i),r.onabort=i=>s(i),r.readAsDataURL(e)}})}static async blobToText(e){return await new Promise((n,s)=>{if(e){const r=new FileReader;r.onload=()=>n(r.result),r.onerror=i=>s(i),r.onabort=i=>s(i),r.readAsText(e)}})}static rewriteMimeType(e,n){return e.type===n?e:e instanceof File?new File([e],e.name,{type:n}):new Blob([e],{type:n})}}function S0(t){let e=0;for(let n=0;n<t.length;n++)e=(e<<5)-e+t.charCodeAt(n),e|=0;return e+""}function x0(t){const e=new DataView(t);let n=0;for(let s=0;s<e.byteLength;s++)n=(n<<5)-n+e.getUint8(s),n|=0;return n+""}const dS=globalThis.crypto,_A="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",CA=128;let qi,Ro;function TA(t){!qi||qi.length<t?(qi=new Uint8Array(t*CA),dS.getRandomValues(qi),Ro=0):Ro+t>qi.length&&(dS.getRandomValues(qi),Ro=0),Ro+=t}function EA(t=21){TA(t-=0);let e="";for(let n=Ro-t;n<Ro;n++)e+=_A[qi[n]&63];return e}let kA=EA;function Ge(t){return kA(t)}function AA(t){const e=new Uint8Array(t);if(!e||!(typeof Buffer<"u"&&Buffer.isBuffer(e)||e instanceof Uint8Array)||e.length<16||!(e[0]===137&&e[1]===80&&e[2]===78&&e[3]===71&&e[4]===13&&e[5]===10&&e[6]===26&&e[7]===10))return!1;function s(i,o,a,c,l=1024){if(!o)return-1;o=new RegExp(o,"g");const u=o.source.length,d=new TextDecoder,p=i.length;if(typeof c>"u"&&(c=p),a>=p||c<=0||a>=c)return-1;i=i.subarray(a,c);let f=-1,g=0,x=0,y="";e:for(;g<i.length;){const m=g+l,S=i.subarray(g,m),w=d.decode(S,{stream:!0}),P=y+w;let _,I=-1;for(;(_=o.exec(P))!==null;){I=_.index-y.length,f=x+I;break e}g=m,x+=w.length;const C=I>-1?I+u:w.length-u;y=w.slice(C)}return f>=0&&(f+=a>=0?a:p+a),f}const r=s(e,"IDAT",12);return r>=12?s(e,"acTL",8,r)>=8:!1}const MA=t=>new Uint8Array(t)[3]===44;function uS(t,e){let n=0;for(;t[e+n];)n+=t[e+n]+1;return n+1}function jA(t){return new TextDecoder("ascii").decode(t.slice(0,3))==="GIF"}function DA(t){const e=new Uint8Array(t);let n,s,r=0,i=0;if(!jA(t))return!1;for(n=e[10]&128,s=e[10]&7,r+=6,r+=7,r+=n?3*Math.pow(2,s+1):0;i<2&&r<e.length;)switch(e[r]){case 44:i+=1,n=e[r+9]&128,s=e[r+9]&7,r+=10,r+=n?3*Math.pow(2,s+1):0,r+=uS(e,r+1)+1;break;case 33:r+=2,r+=uS(e,r);break;case 59:r=e.length;break;default:r=e.length;break}return i>1}let fg=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117];typeof Int32Array<"u"&&(fg=new Int32Array(fg));const OA=(t,e)=>{let n=-1;for(let s=0;s<t.length;s++)n=fg[(n^t[s])&255]^n>>>8;return n^-1},hS=4,pS=4;class gr{static isPng(e,n){return e.getUint8(n+0)===137&&e.getUint8(n+1)===80&&e.getUint8(n+2)===78&&e.getUint8(n+3)===71&&e.getUint8(n+4)===13&&e.getUint8(n+5)===10&&e.getUint8(n+6)===26&&e.getUint8(n+7)===10}static getChunkType(e,n){return[String.fromCharCode(e.getUint8(n)),String.fromCharCode(e.getUint8(n+1)),String.fromCharCode(e.getUint8(n+2)),String.fromCharCode(e.getUint8(n+3))].join("")}static readChunks(e,n=0){const s={};if(!gr.isPng(e,n))throw new Error("Not a PNG");for(n+=8;n<=e.buffer.byteLength;){const r=n,i=e.getInt32(n);n+=4;const o=gr.getChunkType(e,n);if(o==="IDAT"&&s[o]){n+=i+hS+pS;continue}if(o==="IEND")break;s[o]={start:r,dataOffset:n+4,size:i},n+=i+hS+pS}return s}static parsePhys(e,n){return{ppux:e.getUint32(n),ppuy:e.getUint32(n+4),unit:e.getUint8(n+8)}}static findChunk(e,n){return gr.readChunks(e)[n]}static setPhysChunk(e,n=1,s){let r=46,i=0;const o=gr.findChunk(e,"pHYs");o&&(r=o.start,i=o.size);const a=gr.findChunk(e,"IDAT");a&&(r=a.start,i=0);const c=new ArrayBuffer(21),l=new DataView(c);l.setUint32(0,9),l.setUint8(4,112),l.setUint8(5,72),l.setUint8(6,89),l.setUint8(7,115);const u=2835.5;l.setInt32(8,u*n),l.setInt32(12,u*n),l.setInt8(16,1);const d=new Uint8Array(c.slice(4,17));l.setInt32(17,OA(d));const p=e.buffer.slice(0,r),f=e.buffer.slice(r+i);return new Blob([p,c,f],s)}}function LA(t){return!t||t.length<12?!1:t[8]===87&&t[9]===69&&t[10]===66&&t[11]===80}function RA(t){const e=new Uint8Array(t);return!LA(e)||!e||e.length<21?!1:(e[20]>>1&1)===1}const b0=Object.freeze(["image/svg+xml"]),w0=Object.freeze(["image/jpeg","image/png","image/webp"]),v0=Object.freeze(["image/gif","image/apng","image/avif"]),da=Object.freeze([...w0,...b0,...v0]),Yd=Object.freeze(["video/mp4","video/webm","video/quicktime"]),FA=Object.freeze([...da,...Yd]);FA.join(",");class ms{static loadVideo(e){return new Promise((n,s)=>{const r=document.createElement("video");r.onloadeddata=()=>n(r),r.onerror=i=>{console.error(i),s(new Error("Could not load video"))},r.crossOrigin="anonymous",r.src=e})}static async getVideoFrameAsDataUrl(e,n=0){const s=hm();let r=!1;const i=()=>{if(!r)if(e.readyState>=e.HAVE_METADATA)r=!0,e.currentTime=n;else return;if(e.readyState>=e.HAVE_CURRENT_DATA){const a=document.createElement("canvas");a.width=e.videoWidth,a.height=e.videoHeight;const c=a.getContext("2d");if(!c)throw new Error("Could not get 2d context");c.drawImage(e,0,0),s.resolve(a.toDataURL())}},o=a=>{console.error(a),s.reject(new Error("Could not get video frame"))};e.addEventListener("loadedmetadata",i),e.addEventListener("loadeddata",i),e.addEventListener("canplay",i),e.addEventListener("seeked",i),e.addEventListener("error",o),e.addEventListener("stalled",o),i();try{return await s}finally{e.removeEventListener("loadedmetadata",i),e.removeEventListener("loadeddata",i),e.removeEventListener("canplay",i),e.removeEventListener("seeked",i),e.removeEventListener("error",o),e.removeEventListener("stalled",o)}}static getImageAndDimensions(e){return new Promise((n,s)=>{const r=Sc();r.onload=()=>{let i;r.naturalWidth?i={w:r.naturalWidth,h:r.naturalHeight}:(document.body.appendChild(r),i={w:r.clientWidth,h:r.clientHeight},document.body.removeChild(r)),n({...i,image:r})},r.onerror=i=>{console.error(i),s(new Error("Could not load image"))},r.crossOrigin="anonymous",r.referrerPolicy="strict-origin-when-cross-origin",r.style.visibility="hidden",r.style.position="absolute",r.style.opacity="0",r.style.zIndex="-9999",r.src=e})}static async getVideoSize(e){return ms.usingObjectURL(e,async n=>{const s=await ms.loadVideo(n);return{w:s.videoWidth,h:s.videoHeight}})}static async getImageSize(e){const{w:n,h:s}=await ms.usingObjectURL(e,ms.getImageAndDimensions);try{if(e.type==="image/png"){const r=new DataView(await e.arrayBuffer());if(gr.isPng(r,0)){const i=gr.findChunk(r,"pHYs");if(i){const o=gr.parsePhys(r,i.dataOffset);if(o.unit===1&&o.ppux===o.ppuy){const c=Math.max(o.ppux/2834.645669291339,1);return{w:Math.round(n/c),h:Math.round(s/c)}}}}}}catch(r){return console.error(r),{w:n,h:s}}return{w:n,h:s}}static async isAnimated(e){return e.type==="image/gif"?DA(await e.arrayBuffer()):e.type==="image/avif"?MA(await e.arrayBuffer()):e.type==="image/webp"?RA(await e.arrayBuffer()):e.type==="image/apng"?AA(await e.arrayBuffer()):!1}static isAnimatedImageType(e){return v0.includes(e||"")}static isStaticImageType(e){return w0.includes(e||"")}static isVectorImageType(e){return b0.includes(e||"")}static isImageType(e){return da.includes(e||"")}static async usingObjectURL(e,n){const s=URL.createObjectURL(e);try{return await n(s)}finally{URL.revokeObjectURL(s)}}}function ke(t,e,n){return t+(e-t)*n}function xc(t,e,n){return(n-t)/(e-t)}function uo(t=""){let e=0,n=0,s=0,r=0;function i(){const o=e^e<<11;return e=n,n=s,s=r,r^=(r>>>19^o^o>>>8)>>>0,r/4294967296*2}for(let o=0;o<t.length+64;o++)e^=t.charCodeAt(o)|0,i();return i}function sr(t,e,n,s=!1){const[r,i]=e,[o,a]=n,c=o+(t-r)/(i-r)*(a-o);return s?o<a?Math.max(Math.min(c,a),o):Math.max(Math.min(c,o),a):c}function Ut(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function Nt(t,e){if(Ut(t,e))return t[e]}function ac(t){return Object.keys(t)}function _t(t){return Object.values(t)}function zs(t){return Object.entries(t)}function P0(t){return Object.fromEntries(t)}function cc(t,e){const n={};let s=!1;for(const r in t){if(!Object.prototype.hasOwnProperty.call(t,r))continue;const i=t[r];e(r,i)?n[r]=i:s=!0}return s?n:t}function Oi(t,e){const n={};for(const s in t)Object.prototype.hasOwnProperty.call(t,s)&&(n[s]=e(s,t[s]));return n}function I0(t,e){if(t===e)return!0;const n=Object.keys(t);if(n.length!==Object.keys(e).length)return!1;for(const s of n)if(!Ut(e,s)||!Object.is(t[s],e[s]))return!1;return!0}function BA(t,e){const n=[];for(const s in t)Object.is(t[s],e[s])||n.push(s);return n}function zA(t,e,n=1e-6){return SA(t,e,(s,r)=>{if(typeof s=="number"&&typeof r=="number")return Math.abs(s-r)<n})}const Wa={Good:"#40C057",Mid:"#FFC078",Poor:"#E03131"},$A=Wa.Good;class _0{startTime=0;name="";frames=0;started=!1;frame=null;recordFrame=()=>{this.frames++,this.started&&(this.frame=requestAnimationFrame(this.recordFrame))};start(e){this.name=e,this.frames=0,this.started=!0,this.frame!==null&&cancelAnimationFrame(this.frame),this.frame=requestAnimationFrame(this.recordFrame),this.startTime=performance.now()}stop(){this.started=!1,this.frame!==null&&cancelAnimationFrame(this.frame);const e=(performance.now()-this.startTime)/1e3,n=e===0?0:Math.floor(this.frames/e),s=n>55?Wa.Good:n>30?Wa.Mid:Wa.Poor,r=s===Wa.Mid?"black":"white",i=this.name[0].toUpperCase()+this.name.slice(1);console.debug(`%cPerf%c ${i} %c${n}%c fps`,`color: white; background: ${$A};padding: 2px;border-radius: 3px;`,"font-weight: normal",`font-weight: bold; padding: 2px; background: ${s};color: ${r};`,"font-weight: normal")}isStarted(){return this.started}}const C0="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";function Fo(t,e,n){const s=n[0];if(e!=null&&t>=e)throw new Error(t+" >= "+e);if(t.slice(-1)===s||e&&e.slice(-1)===s)throw new Error("trailing zero");if(e){let o=0;for(;(t[o]||s)===e[o];)o++;if(o>0)return e.slice(0,o)+Fo(t.slice(o),e.slice(o),n)}const r=t?n.indexOf(t[0]):0,i=e!=null?n.indexOf(e[0]):n.length;if(i-r>1){const o=Math.round(.5*(r+i));return n[o]}else return e&&e.length>1?e.slice(0,1):n[r]+Fo(t.slice(1),null,n)}function T0(t){if(t.length!==E0(t[0]))throw new Error("invalid integer part of order key: "+t)}function E0(t){if(t>="a"&&t<="z")return t.charCodeAt(0)-97+2;if(t>="A"&&t<="Z")return 90-t.charCodeAt(0)+2;throw new Error("invalid order key head: "+t)}function qa(t){const e=E0(t[0]);if(e>t.length)throw new Error("invalid order key: "+t);return t.slice(0,e)}function fS(t,e){if(t==="A"+e[0].repeat(26))throw new Error("invalid order key: "+t);const n=qa(t);if(t.slice(n.length).slice(-1)===e[0])throw new Error("invalid order key: "+t)}function gS(t,e){T0(t);const[n,...s]=t.split("");let r=!0;for(let i=s.length-1;r&&i>=0;i--){const o=e.indexOf(s[i])+1;o===e.length?s[i]=e[0]:(s[i]=e[o],r=!1)}if(r){if(n==="Z")return"a"+e[0];if(n==="z")return null;const i=String.fromCharCode(n.charCodeAt(0)+1);return i>"a"?s.push(e[0]):s.pop(),i+s.join("")}else return n+s.join("")}function NA(t,e){T0(t);const[n,...s]=t.split("");let r=!0;for(let i=s.length-1;r&&i>=0;i--){const o=e.indexOf(s[i])-1;o===-1?s[i]=e.slice(-1):(s[i]=e[o],r=!1)}if(r){if(n==="a")return"Z"+e.slice(-1);if(n==="A")return null;const i=String.fromCharCode(n.charCodeAt(0)-1);return i<"Z"?s.push(e.slice(-1)):s.pop(),i+s.join("")}else return n+s.join("")}function wi(t,e,n=C0){if(t!=null&&fS(t,n),e!=null&&fS(e,n),t!=null&&e!=null&&t>=e)throw new Error(t+" >= "+e);if(t==null){if(e==null)return"a"+n[0];const c=qa(e),l=e.slice(c.length);if(c==="A"+n[0].repeat(26))return c+Fo("",l,n);if(c<e)return c;const u=NA(c,n);if(u==null)throw new Error("cannot decrement any more");return u}if(e==null){const c=qa(t),l=t.slice(c.length),u=gS(c,n);return u??c+Fo(l,null,n)}const s=qa(t),r=t.slice(s.length),i=qa(e),o=e.slice(i.length);if(s===i)return s+Fo(r,o,n);const a=gS(s,n);if(a==null)throw new Error("cannot increment any more");return a<e?a:s+Fo(r,null,n)}function hd(t,e,n,s=C0){if(n===0)return[];if(n===1)return[wi(t,e,s)];if(e==null){let o=wi(t,e,s);const a=[o];for(let c=0;c<n-1;c++)o=wi(o,e,s),a.push(o);return a}if(t==null){let o=wi(t,e,s);const a=[o];for(let c=0;c<n-1;c++)o=wi(t,o,s),a.push(o);return a.reverse(),a}const r=Math.floor(n/2),i=wi(t,e,s);return[...hd(t,i,r,s),i,...hd(i,e,n-r-1,s)]}const UA=30,HA=()=>Math.random()<.5;function k0(t,e){if(!Number.isInteger(e))throw new Error(`"${t}" must be an integer, got '${e}'`);if(e<0)throw new Error(`"${t}" must be greater than or equal to 0, got '${e}'`)}function A0(t,e,n){const{digits:s,jitterBits:r=UA,getRandomBit:i=HA}=n??{};k0("jitterBits",r);let o=r,a=t,c=e,l=wi(t,e,s);for(;o>0;)(i()?1:0)===1?a=l:c=l,l=wi(a,c,s),o--;return l}function KA(t,e,n,s){const{digits:r,jitterBits:i}=s??{};if(k0("n",n),n===0)return[];if(i===0)return hd(t,e,n,r);const o=hd(t,e,n+1,r),a=[];for(let c=0;c<n;c++){const l=o[c],u=o[c+1];a.push(A0(l,u,s))}return a}const ua=KA,fm="a0";function WA(t){try{A0(t,null)}catch{throw new Error("invalid index: "+t)}}function Ji(t,e,n){return ua(t??null,e??null,n)}function vh(t,e){return ua(t??null,null,e)}function Qo(t,e){return ua(t??null,e??null,1)[0]}function Ls(t=null){return ua(t,null,1)[0]}function qA(t=null){return ua(null,t,1)[0]}function bc(t,e="a1"){return[e,...ua(e,null,t)]}function Yt(t,e){return t.index<e.index?-1:t.index>e.index?1:0}function GA(t,e){return t.id>e.id?1:-1}function gm(t){try{return localStorage.getItem(t)}catch{return null}}function mm(t,e){try{localStorage.setItem(t,e)}catch{}}function YA(){try{localStorage.clear()}catch{}}function M0(t){try{return sessionStorage.getItem(t)}catch{return null}}function ym(t,e){try{sessionStorage.setItem(t,e)}catch{}}function j0(t){try{sessionStorage.removeItem(t)}catch{}}function VA(){try{sessionStorage.clear()}catch{}}const Bo=[],XA=60,D0=Math.floor(1e3/XA)*.9;let Ph,vl,Ih=-D0;const mS=()=>{const t=Bo.splice(0,Bo.length);for(const e of t)e()};function O0(t=!1){if(Ph)return;const e=Date.now();if(e-Ih<D0){Ph=requestAnimationFrame(()=>{Ph=void 0,O0(!0)});return}if(t){if(vl)return;Ih=e,mS()}else{if(vl)return;vl=requestAnimationFrame(()=>{vl=void 0,Ih=e,mS()})}}function Sm(t){return Bo.includes(t)||(Bo.push(t),O0()),()=>{const e=Bo.indexOf(t);e>-1&&Bo.splice(e,1)}}class ZA{timeouts=new Map;intervals=new Map;rafs=new Map;constructor(){this.setTimeout=this.setTimeout.bind(this),this.setInterval=this.setInterval.bind(this),this.requestAnimationFrame=this.requestAnimationFrame.bind(this),this.dispose=this.dispose.bind(this)}setTimeout(e,n,s,...r){const i=window.setTimeout(n,s,r),o=this.timeouts.get(e)??[];return this.timeouts.set(e,[...o,i]),i}setInterval(e,n,s,...r){const i=window.setInterval(n,s,r),o=this.intervals.get(e)??[];return this.intervals.set(e,[...o,i]),i}requestAnimationFrame(e,n){const s=window.requestAnimationFrame(n),r=this.rafs.get(e)??[];return this.rafs.set(e,[...r,s]),s}dispose(e){this.timeouts.get(e)?.forEach(n=>clearTimeout(n)),this.intervals.get(e)?.forEach(n=>clearInterval(n)),this.rafs.get(e)?.forEach(n=>cancelAnimationFrame(n)),this.timeouts.delete(e),this.intervals.delete(e),this.rafs.delete(e)}disposeAll(){for(const e of this.timeouts.keys())this.dispose(e)}forContext(e){return{setTimeout:(n,s,...r)=>this.setTimeout(e,n,s,r),setInterval:(n,s,...r)=>this.setInterval(e,n,s,r),requestAnimationFrame:n=>this.requestAnimationFrame(e,n),dispose:()=>this.dispose(e)}}}const Ee=(t,e)=>{try{return new URL(t,e)}catch{return}};function JA(t){return t!==void 0}function QA(){return typeof globalThis<"u"&&globalThis.structuredClone?[globalThis.structuredClone,!0]:typeof global<"u"&&global.structuredClone?[global.structuredClone,!0]:typeof window<"u"&&window.structuredClone?[window.structuredClone,!0]:[t=>t&&JSON.parse(JSON.stringify(t)),!1]}const L0=QA(),wt=L0[0];L0[1];const R0=Object.getPrototypeOf(wt({})),yS=new Set;function eM(t){yS.has(t)||(yS.add(t),console.warn(`[tldraw] ${t}`))}Di("@tldraw/utils","4.3.1","esm");var SS={},Ta,xS;function _n(){if(xS)return Ta;xS=1;var t=function(e){return e&&e.Math===Math&&e};return Ta=t(typeof globalThis=="object"&&globalThis)||t(typeof window=="object"&&window)||t(typeof self=="object"&&self)||t(typeof Xt=="object"&&Xt)||t(typeof Ta=="object"&&Ta)||(function(){return this})()||Function("return this")(),Ta}var _h={},Ch,bS;function Cn(){return bS||(bS=1,Ch=function(t){try{return!!t()}catch{return!0}}),Ch}var Th,wS;function ti(){if(wS)return Th;wS=1;var t=Cn();return Th=!t(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!==7}),Th}var Eh,vS;function Vd(){if(vS)return Eh;vS=1;var t=Cn();return Eh=!t(function(){var e=(function(){}).bind();return typeof e!="function"||e.hasOwnProperty("prototype")}),Eh}var kh,PS;function ni(){if(PS)return kh;PS=1;var t=Vd(),e=Function.prototype.call;return kh=t?e.bind(e):function(){return e.apply(e,arguments)},kh}var Ah={},IS;function tM(){if(IS)return Ah;IS=1;var t={}.propertyIsEnumerable,e=Object.getOwnPropertyDescriptor,n=e&&!t.call({1:2},1);return Ah.f=n?function(r){var i=e(this,r);return!!i&&i.enumerable}:t,Ah}var Mh,_S;function xm(){return _S||(_S=1,Mh=function(t,e){return{enumerable:!(t&1),configurable:!(t&2),writable:!(t&4),value:e}}),Mh}var jh,CS;function Zt(){if(CS)return jh;CS=1;var t=Vd(),e=Function.prototype,n=e.call,s=t&&e.bind.bind(n,n);return jh=t?s:function(r){return function(){return n.apply(r,arguments)}},jh}var Dh,TS;function ha(){if(TS)return Dh;TS=1;var t=Zt(),e=t({}.toString),n=t("".slice);return Dh=function(s){return n(e(s),8,-1)},Dh}var Oh,ES;function nM(){if(ES)return Oh;ES=1;var t=Zt(),e=Cn(),n=ha(),s=Object,r=t("".split);return Oh=e(function(){return!s("z").propertyIsEnumerable(0)})?function(i){return n(i)==="String"?r(i,""):s(i)}:s,Oh}var Lh,kS;function F0(){return kS||(kS=1,Lh=function(t){return t==null}),Lh}var Rh,AS;function pa(){if(AS)return Rh;AS=1;var t=F0(),e=TypeError;return Rh=function(n){if(t(n))throw new e("Can't call method on "+n);return n},Rh}var Fh,MS;function Xd(){if(MS)return Fh;MS=1;var t=nM(),e=pa();return Fh=function(n){return t(e(n))},Fh}var Bh,jS;function qn(){if(jS)return Bh;jS=1;var t=typeof document=="object"&&document.all;return Bh=typeof t>"u"&&t!==void 0?function(e){return typeof e=="function"||e===t}:function(e){return typeof e=="function"},Bh}var zh,DS;function si(){if(DS)return zh;DS=1;var t=qn();return zh=function(e){return typeof e=="object"?e!==null:t(e)},zh}var $h,OS;function Zd(){if(OS)return $h;OS=1;var t=_n(),e=qn(),n=function(s){return e(s)?s:void 0};return $h=function(s,r){return arguments.length<2?n(t[s]):t[s]&&t[s][r]},$h}var Nh,LS;function B0(){if(LS)return Nh;LS=1;var t=Zt();return Nh=t({}.isPrototypeOf),Nh}var Uh,RS;function sM(){if(RS)return Uh;RS=1;var t=_n(),e=t.navigator,n=e&&e.userAgent;return Uh=n?String(n):"",Uh}var Hh,FS;function rM(){if(FS)return Hh;FS=1;var t=_n(),e=sM(),n=t.process,s=t.Deno,r=n&&n.versions||s&&s.version,i=r&&r.v8,o,a;return i&&(o=i.split("."),a=o[0]>0&&o[0]<4?1:+(o[0]+o[1])),!a&&e&&(o=e.match(/Edge\/(\d+)/),(!o||o[1]>=74)&&(o=e.match(/Chrome\/(\d+)/),o&&(a=+o[1]))),Hh=a,Hh}var Kh,BS;function z0(){if(BS)return Kh;BS=1;var t=rM(),e=Cn(),n=_n(),s=n.String;return Kh=!!Object.getOwnPropertySymbols&&!e(function(){var r=Symbol("symbol detection");return!s(r)||!(Object(r)instanceof Symbol)||!Symbol.sham&&t&&t<41}),Kh}var Wh,zS;function $0(){if(zS)return Wh;zS=1;var t=z0();return Wh=t&&!Symbol.sham&&typeof Symbol.iterator=="symbol",Wh}var qh,$S;function N0(){if($S)return qh;$S=1;var t=Zd(),e=qn(),n=B0(),s=$0(),r=Object;return qh=s?function(i){return typeof i=="symbol"}:function(i){var o=t("Symbol");return e(o)&&n(o.prototype,r(i))},qh}var Gh,NS;function iM(){if(NS)return Gh;NS=1;var t=String;return Gh=function(e){try{return t(e)}catch{return"Object"}},Gh}var Yh,US;function bm(){if(US)return Yh;US=1;var t=qn(),e=iM(),n=TypeError;return Yh=function(s){if(t(s))return s;throw new n(e(s)+" is not a function")},Yh}var Vh,HS;function wm(){if(HS)return Vh;HS=1;var t=bm(),e=F0();return Vh=function(n,s){var r=n[s];return e(r)?void 0:t(r)},Vh}var Xh,KS;function oM(){if(KS)return Xh;KS=1;var t=ni(),e=qn(),n=si(),s=TypeError;return Xh=function(r,i){var o,a;if(i==="string"&&e(o=r.toString)&&!n(a=t(o,r))||e(o=r.valueOf)&&!n(a=t(o,r))||i!=="string"&&e(o=r.toString)&&!n(a=t(o,r)))return a;throw new s("Can't convert object to primitive value")},Xh}var Zh={exports:{}},Jh,WS;function U0(){return WS||(WS=1,Jh=!1),Jh}var Qh,qS;function vm(){if(qS)return Qh;qS=1;var t=_n(),e=Object.defineProperty;return Qh=function(n,s){try{e(t,n,{value:s,configurable:!0,writable:!0})}catch{t[n]=s}return s},Qh}var GS;function Pm(){if(GS)return Zh.exports;GS=1;var t=U0(),e=_n(),n=vm(),s="__core-js_shared__",r=Zh.exports=e[s]||n(s,{});return(r.versions||(r.versions=[])).push({version:"3.48.0",mode:t?"pure":"global",copyright:"© 2013–2025 Denis Pushkarev (zloirock.ru), 2025–2026 CoreJS Company (core-js.io). All rights reserved.",license:"https://github.com/zloirock/core-js/blob/v3.48.0/LICENSE",source:"https://github.com/zloirock/core-js"}),Zh.exports}var ep,YS;function Im(){if(YS)return ep;YS=1;var t=Pm();return ep=function(e,n){return t[e]||(t[e]=n||{})},ep}var tp,VS;function Bc(){if(VS)return tp;VS=1;var t=pa(),e=Object;return tp=function(n){return e(t(n))},tp}var np,XS;function Li(){if(XS)return np;XS=1;var t=Zt(),e=Bc(),n=t({}.hasOwnProperty);return np=Object.hasOwn||function(r,i){return n(e(r),i)},np}var sp,ZS;function H0(){if(ZS)return sp;ZS=1;var t=Zt(),e=0,n=Math.random(),s=t(1.1.toString);return sp=function(r){return"Symbol("+(r===void 0?"":r)+")_"+s(++e+n,36)},sp}var rp,JS;function ri(){if(JS)return rp;JS=1;var t=_n(),e=Im(),n=Li(),s=H0(),r=z0(),i=$0(),o=t.Symbol,a=e("wks"),c=i?o.for||o:o&&o.withoutSetter||s;return rp=function(l){return n(a,l)||(a[l]=r&&n(o,l)?o[l]:c("Symbol."+l)),a[l]},rp}var ip,QS;function aM(){if(QS)return ip;QS=1;var t=ni(),e=si(),n=N0(),s=wm(),r=oM(),i=ri(),o=TypeError,a=i("toPrimitive");return ip=function(c,l){if(!e(c)||n(c))return c;var u=s(c,a),d;if(u){if(l===void 0&&(l="default"),d=t(u,c,l),!e(d)||n(d))return d;throw new o("Can't convert object to primitive value")}return l===void 0&&(l="number"),r(c,l)},ip}var op,ex;function K0(){if(ex)return op;ex=1;var t=aM(),e=N0();return op=function(n){var s=t(n,"string");return e(s)?s:s+""},op}var ap,tx;function W0(){if(tx)return ap;tx=1;var t=_n(),e=si(),n=t.document,s=e(n)&&e(n.createElement);return ap=function(r){return s?n.createElement(r):{}},ap}var cp,nx;function q0(){if(nx)return cp;nx=1;var t=ti(),e=Cn(),n=W0();return cp=!t&&!e(function(){return Object.defineProperty(n("div"),"a",{get:function(){return 7}}).a!==7}),cp}var sx;function G0(){if(sx)return _h;sx=1;var t=ti(),e=ni(),n=tM(),s=xm(),r=Xd(),i=K0(),o=Li(),a=q0(),c=Object.getOwnPropertyDescriptor;return _h.f=t?c:function(u,d){if(u=r(u),d=i(d),a)try{return c(u,d)}catch{}if(o(u,d))return s(!e(n.f,u,d),u[d])},_h}var lp={},dp,rx;function Y0(){if(rx)return dp;rx=1;var t=ti(),e=Cn();return dp=t&&e(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!==42}),dp}var up,ix;function ho(){if(ix)return up;ix=1;var t=si(),e=String,n=TypeError;return up=function(s){if(t(s))return s;throw new n(e(s)+" is not an object")},up}var ox;function fa(){if(ox)return lp;ox=1;var t=ti(),e=q0(),n=Y0(),s=ho(),r=K0(),i=TypeError,o=Object.defineProperty,a=Object.getOwnPropertyDescriptor,c="enumerable",l="configurable",u="writable";return lp.f=t?n?function(p,f,g){if(s(p),f=r(f),s(g),typeof p=="function"&&f==="prototype"&&"value"in g&&u in g&&!g[u]){var x=a(p,f);x&&x[u]&&(p[f]=g.value,g={configurable:l in g?g[l]:x[l],enumerable:c in g?g[c]:x[c],writable:!1})}return o(p,f,g)}:o:function(p,f,g){if(s(p),f=r(f),s(g),e)try{return o(p,f,g)}catch{}if("get"in g||"set"in g)throw new i("Accessors not supported");return"value"in g&&(p[f]=g.value),p},lp}var hp,ax;function _m(){if(ax)return hp;ax=1;var t=ti(),e=fa(),n=xm();return hp=t?function(s,r,i){return e.f(s,r,n(1,i))}:function(s,r,i){return s[r]=i,s},hp}var pp={exports:{}},fp,cx;function cM(){if(cx)return fp;cx=1;var t=ti(),e=Li(),n=Function.prototype,s=t&&Object.getOwnPropertyDescriptor,r=e(n,"name"),i=r&&(function(){}).name==="something",o=r&&(!t||t&&s(n,"name").configurable);return fp={EXISTS:r,PROPER:i,CONFIGURABLE:o},fp}var gp,lx;function V0(){if(lx)return gp;lx=1;var t=Zt(),e=qn(),n=Pm(),s=t(Function.toString);return e(n.inspectSource)||(n.inspectSource=function(r){return s(r)}),gp=n.inspectSource,gp}var mp,dx;function lM(){if(dx)return mp;dx=1;var t=_n(),e=qn(),n=t.WeakMap;return mp=e(n)&&/native code/.test(String(n)),mp}var yp,ux;function X0(){if(ux)return yp;ux=1;var t=Im(),e=H0(),n=t("keys");return yp=function(s){return n[s]||(n[s]=e(s))},yp}var Sp,hx;function Cm(){return hx||(hx=1,Sp={}),Sp}var xp,px;function Z0(){if(px)return xp;px=1;var t=lM(),e=_n(),n=si(),s=_m(),r=Li(),i=Pm(),o=X0(),a=Cm(),c="Object already initialized",l=e.TypeError,u=e.WeakMap,d,p,f,g=function(S){return f(S)?p(S):d(S,{})},x=function(S){return function(w){var P;if(!n(w)||(P=p(w)).type!==S)throw new l("Incompatible receiver, "+S+" required");return P}};if(t||i.state){var y=i.state||(i.state=new u);y.get=y.get,y.has=y.has,y.set=y.set,d=function(S,w){if(y.has(S))throw new l(c);return w.facade=S,y.set(S,w),w},p=function(S){return y.get(S)||{}},f=function(S){return y.has(S)}}else{var m=o("state");a[m]=!0,d=function(S,w){if(r(S,m))throw new l(c);return w.facade=S,s(S,m,w),w},p=function(S){return r(S,m)?S[m]:{}},f=function(S){return r(S,m)}}return xp={set:d,get:p,has:f,enforce:g,getterFor:x},xp}var fx;function dM(){if(fx)return pp.exports;fx=1;var t=Zt(),e=Cn(),n=qn(),s=Li(),r=ti(),i=cM().CONFIGURABLE,o=V0(),a=Z0(),c=a.enforce,l=a.get,u=String,d=Object.defineProperty,p=t("".slice),f=t("".replace),g=t([].join),x=r&&!e(function(){return d(function(){},"length",{value:8}).length!==8}),y=String(String).split("String"),m=pp.exports=function(S,w,P){p(u(w),0,7)==="Symbol("&&(w="["+f(u(w),/^Symbol\(([^)]*)\).*$/,"$1")+"]"),P&&P.getter&&(w="get "+w),P&&P.setter&&(w="set "+w),(!s(S,"name")||i&&S.name!==w)&&(r?d(S,"name",{value:w,configurable:!0}):S.name=w),x&&P&&s(P,"arity")&&S.length!==P.arity&&d(S,"length",{value:P.arity});try{P&&s(P,"constructor")&&P.constructor?r&&d(S,"prototype",{writable:!1}):S.prototype&&(S.prototype=void 0)}catch{}var _=c(S);return s(_,"source")||(_.source=g(y,typeof w=="string"?w:"")),S};return Function.prototype.toString=m(function(){return n(this)&&l(this).source||o(this)},"toString"),pp.exports}var bp,gx;function J0(){if(gx)return bp;gx=1;var t=qn(),e=fa(),n=dM(),s=vm();return bp=function(r,i,o,a){a||(a={});var c=a.enumerable,l=a.name!==void 0?a.name:i;if(t(o)&&n(o,l,a),a.global)c?r[i]=o:s(i,o);else{try{a.unsafe?r[i]&&(c=!0):delete r[i]}catch{}c?r[i]=o:e.f(r,i,{value:o,enumerable:!1,configurable:!a.nonConfigurable,writable:!a.nonWritable})}return r},bp}var wp={},vp,mx;function uM(){if(mx)return vp;mx=1;var t=Math.ceil,e=Math.floor;return vp=Math.trunc||function(s){var r=+s;return(r>0?e:t)(r)},vp}var Pp,yx;function po(){if(yx)return Pp;yx=1;var t=uM();return Pp=function(e){var n=+e;return n!==n||n===0?0:t(n)},Pp}var Ip,Sx;function hM(){if(Sx)return Ip;Sx=1;var t=po(),e=Math.max,n=Math.min;return Ip=function(s,r){var i=t(s);return i<0?e(i+r,0):n(i,r)},Ip}var _p,xx;function Q0(){if(xx)return _p;xx=1;var t=po(),e=Math.min;return _p=function(n){var s=t(n);return s>0?e(s,9007199254740991):0},_p}var Cp,bx;function zc(){if(bx)return Cp;bx=1;var t=Q0();return Cp=function(e){return t(e.length)},Cp}var Tp,wx;function pM(){if(wx)return Tp;wx=1;var t=Xd(),e=hM(),n=zc(),s=function(r){return function(i,o,a){var c=t(i),l=n(c);if(l===0)return!r&&-1;var u=e(a,l),d;if(r&&o!==o){for(;l>u;)if(d=c[u++],d!==d)return!0}else for(;l>u;u++)if((r||u in c)&&c[u]===o)return r||u||0;return!r&&-1}};return Tp={includes:s(!0),indexOf:s(!1)},Tp}var Ep,vx;function e1(){if(vx)return Ep;vx=1;var t=Zt(),e=Li(),n=Xd(),s=pM().indexOf,r=Cm(),i=t([].push);return Ep=function(o,a){var c=n(o),l=0,u=[],d;for(d in c)!e(r,d)&&e(c,d)&&i(u,d);for(;a.length>l;)e(c,d=a[l++])&&(~s(u,d)||i(u,d));return u},Ep}var kp,Px;function Tm(){return Px||(Px=1,kp=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"]),kp}var Ix;function fM(){if(Ix)return wp;Ix=1;var t=e1(),e=Tm(),n=e.concat("length","prototype");return wp.f=Object.getOwnPropertyNames||function(r){return t(r,n)},wp}var Ap={},_x;function gM(){return _x||(_x=1,Ap.f=Object.getOwnPropertySymbols),Ap}var Mp,Cx;function mM(){if(Cx)return Mp;Cx=1;var t=Zd(),e=Zt(),n=fM(),s=gM(),r=ho(),i=e([].concat);return Mp=t("Reflect","ownKeys")||function(a){var c=n.f(r(a)),l=s.f;return l?i(c,l(a)):c},Mp}var jp,Tx;function yM(){if(Tx)return jp;Tx=1;var t=Li(),e=mM(),n=G0(),s=fa();return jp=function(r,i,o){for(var a=e(i),c=s.f,l=n.f,u=0;u<a.length;u++){var d=a[u];!t(r,d)&&!(o&&t(o,d))&&c(r,d,l(i,d))}},jp}var Dp,Ex;function SM(){if(Ex)return Dp;Ex=1;var t=Cn(),e=qn(),n=/#|\.prototype\./,s=function(c,l){var u=i[r(c)];return u===a?!0:u===o?!1:e(l)?t(l):!!l},r=s.normalize=function(c){return String(c).replace(n,".").toLowerCase()},i=s.data={},o=s.NATIVE="N",a=s.POLYFILL="P";return Dp=s,Dp}var Op,kx;function ga(){if(kx)return Op;kx=1;var t=_n(),e=G0().f,n=_m(),s=J0(),r=vm(),i=yM(),o=SM();return Op=function(a,c){var l=a.target,u=a.global,d=a.stat,p,f,g,x,y,m;if(u?f=t:d?f=t[l]||r(l,{}):f=t[l]&&t[l].prototype,f)for(g in c){if(y=c[g],a.dontCallGetSet?(m=e(f,g),x=m&&m.value):x=f[g],p=o(u?g:l+(d?".":"#")+g,a.forced),!p&&x!==void 0){if(typeof y==typeof x)continue;i(y,x)}(a.sham||x&&x.sham)&&n(y,"sham",!0),s(f,g,y,a)}},Op}var Lp={},Rp,Ax;function xM(){if(Ax)return Rp;Ax=1;var t=e1(),e=Tm();return Rp=Object.keys||function(s){return t(s,e)},Rp}var Mx;function bM(){if(Mx)return Lp;Mx=1;var t=ti(),e=Y0(),n=fa(),s=ho(),r=Xd(),i=xM();return Lp.f=t&&!e?Object.defineProperties:function(a,c){s(a);for(var l=r(c),u=i(c),d=u.length,p=0,f;d>p;)n.f(a,f=u[p++],l[f]);return a},Lp}var Fp,jx;function wM(){if(jx)return Fp;jx=1;var t=Zd();return Fp=t("document","documentElement"),Fp}var Bp,Dx;function t1(){if(Dx)return Bp;Dx=1;var t=ho(),e=bM(),n=Tm(),s=Cm(),r=wM(),i=W0(),o=X0(),a=">",c="<",l="prototype",u="script",d=o("IE_PROTO"),p=function(){},f=function(S){return c+u+a+S+c+"/"+u+a},g=function(S){S.write(f("")),S.close();var w=S.parentWindow.Object;return S=null,w},x=function(){var S=i("iframe"),w="java"+u+":",P;return S.style.display="none",r.appendChild(S),S.src=String(w),P=S.contentWindow.document,P.open(),P.write(f("document.F=Object")),P.close(),P.F},y,m=function(){try{y=new ActiveXObject("htmlfile")}catch{}m=typeof document<"u"?document.domain&&y?g(y):x():g(y);for(var S=n.length;S--;)delete m[l][n[S]];return m()};return s[d]=!0,Bp=Object.create||function(w,P){var _;return w!==null?(p[l]=t(w),_=new p,p[l]=null,_[d]=w):_=m(),P===void 0?_:e.f(_,P)},Bp}var zp,Ox;function Em(){if(Ox)return zp;Ox=1;var t=ri(),e=t1(),n=fa().f,s=t("unscopables"),r=Array.prototype;return r[s]===void 0&&n(r,s,{configurable:!0,value:e(null)}),zp=function(i){r[s][i]=!0},zp}var Lx;function vM(){if(Lx)return SS;Lx=1;var t=ga(),e=Bc(),n=zc(),s=po(),r=Em();return t({target:"Array",proto:!0},{at:function(o){var a=e(this),c=n(a),l=s(o),u=l>=0?l:c+l;return u<0||u>=c?void 0:a[u]}}),r("at"),SS}var $p,Rx;function $c(){if(Rx)return $p;Rx=1;var t=_n(),e=Zt();return $p=function(n,s){return e(t[n].prototype[s])},$p}var Np,Fx;function PM(){if(Fx)return Np;Fx=1,vM();var t=$c();return Np=t("Array","at"),Np}var Up,Bx;function IM(){if(Bx)return Up;Bx=1;var t=PM();return Up=t,Up}IM();var zx={},Hp,$x;function n1(){if($x)return Hp;$x=1;var t=ha();return Hp=Array.isArray||function(n){return t(n)==="Array"},Hp}var Kp,Nx;function _M(){if(Nx)return Kp;Nx=1;var t=TypeError,e=9007199254740991;return Kp=function(n){if(n>e)throw t("Maximum allowed index exceeded");return n},Kp}var Wp,Ux;function CM(){if(Ux)return Wp;Ux=1;var t=ha(),e=Zt();return Wp=function(n){if(t(n)==="Function")return e(n)},Wp}var qp,Hx;function TM(){if(Hx)return qp;Hx=1;var t=CM(),e=bm(),n=Vd(),s=t(t.bind);return qp=function(r,i){return e(r),i===void 0?r:n?s(r,i):function(){return r.apply(i,arguments)}},qp}var Gp,Kx;function EM(){if(Kx)return Gp;Kx=1;var t=ti(),e=fa(),n=xm();return Gp=function(s,r,i){t?e.f(s,r,n(0,i)):s[r]=i},Gp}var Yp,Wx;function s1(){if(Wx)return Yp;Wx=1;var t=n1(),e=zc(),n=_M(),s=TM(),r=EM(),i=function(o,a,c,l,u,d,p,f){for(var g=u,x=0,y=p?s(p,f):!1,m,S;x<l;)x in c&&(m=y?y(c[x],x,a):c[x],d>0&&t(m)?(S=e(m),g=i(o,a,m,S,g,d-1)-1):(n(g+1),r(o,g,m)),g++),x++;return g};return Yp=i,Yp}var Vp,qx;function kM(){if(qx)return Vp;qx=1;var t=ri(),e=t("toStringTag"),n={};return n[e]="z",Vp=String(n)==="[object z]",Vp}var Xp,Gx;function r1(){if(Gx)return Xp;Gx=1;var t=kM(),e=qn(),n=ha(),s=ri(),r=s("toStringTag"),i=Object,o=n((function(){return arguments})())==="Arguments",a=function(c,l){try{return c[l]}catch{}};return Xp=t?n:function(c){var l,u,d;return c===void 0?"Undefined":c===null?"Null":typeof(u=a(l=i(c),r))=="string"?u:o?n(l):(d=n(l))==="Object"&&e(l.callee)?"Arguments":d},Xp}var Zp,Yx;function AM(){if(Yx)return Zp;Yx=1;var t=Zt(),e=Cn(),n=qn(),s=r1(),r=Zd(),i=V0(),o=function(){},a=r("Reflect","construct"),c=/^\s*(?:class|function)\b/,l=t(c.exec),u=!c.test(o),d=function(g){if(!n(g))return!1;try{return a(o,[],g),!0}catch{return!1}},p=function(g){if(!n(g))return!1;switch(s(g)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return u||!!l(c,i(g))}catch{return!0}};return p.sham=!0,Zp=!a||e(function(){var f;return d(d.call)||!d(Object)||!d(function(){f=!0})||f})?p:d,Zp}var Jp,Vx;function MM(){if(Vx)return Jp;Vx=1;var t=n1(),e=AM(),n=si(),s=ri(),r=s("species"),i=Array;return Jp=function(o){var a;return t(o)&&(a=o.constructor,e(a)&&(a===i||t(a.prototype))?a=void 0:n(a)&&(a=a[r],a===null&&(a=void 0))),a===void 0?i:a},Jp}var Qp,Xx;function i1(){if(Xx)return Qp;Xx=1;var t=MM();return Qp=function(e,n){return new(t(e))(n===0?0:n)},Qp}var Zx;function jM(){if(Zx)return zx;Zx=1;var t=ga(),e=s1(),n=bm(),s=Bc(),r=zc(),i=i1();return t({target:"Array",proto:!0},{flatMap:function(a){var c=s(this),l=r(c),u;return n(a),u=i(c,0),e(u,c,c,l,0,1,a,arguments.length>1?arguments[1]:void 0),u}}),zx}var Jx={},Qx;function DM(){if(Qx)return Jx;Qx=1;var t=Em();return t("flatMap"),Jx}var ef,eb;function OM(){if(eb)return ef;eb=1,jM(),DM();var t=$c();return ef=t("Array","flatMap"),ef}var tf,tb;function LM(){if(tb)return tf;tb=1;var t=OM();return tf=t,tf}LM();var nb={},sb;function RM(){if(sb)return nb;sb=1;var t=ga(),e=s1(),n=Bc(),s=zc(),r=po(),i=i1();return t({target:"Array",proto:!0},{flat:function(){var a=arguments.length?arguments[0]:void 0,c=n(this),l=s(c),u=i(c,0);return e(u,c,c,l,0,a===void 0?1:r(a)),u}}),nb}var rb={},ib;function FM(){if(ib)return rb;ib=1;var t=Em();return t("flat"),rb}var nf,ob;function BM(){if(ob)return nf;ob=1,RM(),FM();var t=$c();return nf=t("Array","flat"),nf}var sf,ab;function zM(){if(ab)return sf;ab=1;var t=BM();return sf=t,sf}zM();var cb={},rf,lb;function Nc(){if(lb)return rf;lb=1;var t=r1(),e=String;return rf=function(n){if(t(n)==="Symbol")throw new TypeError("Cannot convert a Symbol value to a string");return e(n)},rf}var db;function $M(){if(db)return cb;db=1;var t=ga(),e=Zt(),n=pa(),s=po(),r=Nc(),i=Cn(),o=e("".charAt),a=i(function(){return"𠮷".at(-2)!=="\uD842"});return t({target:"String",proto:!0,forced:a},{at:function(l){var u=r(n(this)),d=u.length,p=s(l),f=p>=0?p:d+p;return f<0||f>=d?void 0:o(u,f)}}),cb}var of,ub;function NM(){if(ub)return of;ub=1,$M();var t=$c();return of=t("String","at"),of}var af,hb;function UM(){if(hb)return af;hb=1;var t=NM();return af=t,af}UM();var pb={},cf,fb;function o1(){if(fb)return cf;fb=1;var t=ho();return cf=function(){var e=t(this),n="";return e.hasIndices&&(n+="d"),e.global&&(n+="g"),e.ignoreCase&&(n+="i"),e.multiline&&(n+="m"),e.dotAll&&(n+="s"),e.unicode&&(n+="u"),e.unicodeSets&&(n+="v"),e.sticky&&(n+="y"),n},cf}var lf,gb;function HM(){if(gb)return lf;gb=1;var t=Cn(),e=_n(),n=e.RegExp,s=t(function(){var o=n("a","y");return o.lastIndex=2,o.exec("abcd")!==null}),r=s||t(function(){return!n("a","y").sticky}),i=s||t(function(){var o=n("^r","gy");return o.lastIndex=2,o.exec("str")!==null});return lf={BROKEN_CARET:i,MISSED_STICKY:r,UNSUPPORTED_Y:s},lf}var df,mb;function KM(){if(mb)return df;mb=1;var t=Cn(),e=_n(),n=e.RegExp;return df=t(function(){var s=n(".","s");return!(s.dotAll&&s.test(`
`)&&s.flags==="s")}),df}var uf,yb;function WM(){if(yb)return uf;yb=1;var t=Cn(),e=_n(),n=e.RegExp;return uf=t(function(){var s=n("(?<a>b)","g");return s.exec("b").groups.a!=="b"||"b".replace(s,"$<a>c")!=="bc"}),uf}var hf,Sb;function km(){if(Sb)return hf;Sb=1;var t=ni(),e=Zt(),n=Nc(),s=o1(),r=HM(),i=Im(),o=t1(),a=Z0().get,c=KM(),l=WM(),u=i("native-string-replace",String.prototype.replace),d=RegExp.prototype.exec,p=d,f=e("".charAt),g=e("".indexOf),x=e("".replace),y=e("".slice),m=(function(){var _=/a/,I=/b*/g;return t(d,_,"a"),t(d,I,"a"),_.lastIndex!==0||I.lastIndex!==0})(),S=r.BROKEN_CARET,w=/()??/.exec("")[1]!==void 0,P=m||w||S||c||l;return P&&(p=function(I){var C=this,E=a(C),O=n(I),k=E.raw,T,D,R,M,L,U,V;if(k)return k.lastIndex=C.lastIndex,T=t(p,k,O),C.lastIndex=k.lastIndex,T;var J=E.groups,Z=S&&C.sticky,Q=t(s,C),Y=C.source,Ie=0,be=O;if(Z&&(Q=x(Q,"y",""),g(Q,"g")===-1&&(Q+="g"),be=y(O,C.lastIndex),C.lastIndex>0&&(!C.multiline||C.multiline&&f(O,C.lastIndex-1)!==`
`)&&(Y="(?: "+Y+")",be=" "+be,Ie++),D=new RegExp("^(?:"+Y+")",Q)),w&&(D=new RegExp("^"+Y+"$(?!\\s)",Q)),m&&(R=C.lastIndex),M=t(d,Z?D:C,be),Z?M?(M.input=y(M.input,Ie),M[0]=y(M[0],Ie),M.index=C.lastIndex,C.lastIndex+=M[0].length):C.lastIndex=0:m&&M&&(C.lastIndex=C.global?M.index+M[0].length:R),w&&M&&M.length>1&&t(u,M[0],D,function(){for(L=1;L<arguments.length-2;L++)arguments[L]===void 0&&(M[L]=void 0)}),M&&J)for(M.groups=U=o(null),L=0;L<J.length;L++)V=J[L],U[V[0]]=M[V[1]];return M}),hf=p,hf}var xb;function a1(){if(xb)return pb;xb=1;var t=ga(),e=km();return t({target:"RegExp",proto:!0,forced:/./.exec!==e},{exec:e}),pb}var bb={},pf,wb;function qM(){if(wb)return pf;wb=1;var t=Vd(),e=Function.prototype,n=e.apply,s=e.call;return pf=typeof Reflect=="object"&&Reflect.apply||(t?s.bind(n):function(){return s.apply(n,arguments)}),pf}var ff,vb;function GM(){if(vb)return ff;vb=1,a1();var t=ni(),e=J0(),n=km(),s=Cn(),r=ri(),i=_m(),o=r("species"),a=RegExp.prototype;return ff=function(c,l,u,d){var p=r(c),f=!s(function(){var m={};return m[p]=function(){return 7},""[c](m)!==7}),g=f&&!s(function(){var m=!1,S=/a/;if(c==="split"){var w={};w[o]=function(){return S},S={constructor:w,flags:""},S[p]=/./[p]}return S.exec=function(){return m=!0,null},S[p](""),!m});if(!f||!g||u){var x=/./[p],y=l(p,""[c],function(m,S,w,P,_){var I=S.exec;return I===n||I===a.exec?f&&!_?{done:!0,value:t(x,S,w,P)}:{done:!0,value:t(m,w,S,P)}:{done:!1}});e(String.prototype,c,y[0]),e(a,p,y[1])}d&&i(a[p],"sham",!0)},ff}var gf,Pb;function YM(){if(Pb)return gf;Pb=1;var t=Zt(),e=po(),n=Nc(),s=pa(),r=t("".charAt),i=t("".charCodeAt),o=t("".slice),a=function(c){return function(l,u){var d=n(s(l)),p=e(u),f=d.length,g,x;return p<0||p>=f?c?"":void 0:(g=i(d,p),g<55296||g>56319||p+1===f||(x=i(d,p+1))<56320||x>57343?c?r(d,p):g:c?o(d,p,p+2):(g-55296<<10)+(x-56320)+65536)}};return gf={codeAt:a(!1),charAt:a(!0)},gf}var mf,Ib;function VM(){if(Ib)return mf;Ib=1;var t=YM().charAt;return mf=function(e,n,s){return n+(s?t(e,n).length:1)},mf}var yf,_b;function c1(){if(_b)return yf;_b=1;var t=Zt(),e=Bc(),n=Math.floor,s=t("".charAt),r=t("".replace),i=t("".slice),o=/\$([$&'`]|\d{1,2}|<[^>]*>)/g,a=/\$([$&'`]|\d{1,2})/g;return yf=function(c,l,u,d,p,f){var g=u+c.length,x=d.length,y=a;return p!==void 0&&(p=e(p),y=o),r(f,y,function(m,S){var w;switch(s(S,0)){case"$":return"$";case"&":return c;case"`":return i(l,0,u);case"'":return i(l,g);case"<":w=p[i(S,1,-1)];break;default:var P=+S;if(P===0)return m;if(P>x){var _=n(P/10);return _===0?m:_<=x?d[_-1]===void 0?s(S,1):d[_-1]+s(S,1):m}w=d[P-1]}return w===void 0?"":w})},yf}var Sf,Cb;function XM(){if(Cb)return Sf;Cb=1;var t=_n(),e=Cn(),n=t.RegExp,s=!e(function(){var r=!0;try{n(".","d")}catch{r=!1}var i={},o="",a=r?"dgimsy":"gimsy",c=function(p,f){Object.defineProperty(i,p,{get:function(){return o+=f,!0}})},l={dotAll:"s",global:"g",ignoreCase:"i",multiline:"m",sticky:"y"};r&&(l.hasIndices="d");for(var u in l)c(u,l[u]);var d=Object.getOwnPropertyDescriptor(n.prototype,"flags").get.call(i);return d!==a||o!==a});return Sf={correct:s},Sf}var xf,Tb;function l1(){if(Tb)return xf;Tb=1;var t=ni(),e=Li(),n=B0(),s=XM(),r=o1(),i=RegExp.prototype;return xf=s.correct?function(o){return o.flags}:function(o){return!s.correct&&n(i,o)&&!e(o,"flags")?t(r,o):o.flags},xf}var bf,Eb;function ZM(){if(Eb)return bf;Eb=1;var t=ni(),e=ho(),n=qn(),s=ha(),r=km(),i=TypeError;return bf=function(o,a){var c=o.exec;if(n(c)){var l=t(c,o,a);return l!==null&&e(l),l}if(s(o)==="RegExp")return t(r,o,a);throw new i("RegExp#exec called on incompatible receiver")},bf}var kb;function JM(){if(kb)return bb;kb=1;var t=qM(),e=ni(),n=Zt(),s=GM(),r=Cn(),i=ho(),o=qn(),a=si(),c=po(),l=Q0(),u=Nc(),d=pa(),p=VM(),f=wm(),g=c1(),x=l1(),y=ZM(),m=ri(),S=m("replace"),w=Math.max,P=Math.min,_=n([].concat),I=n([].push),C=n("".indexOf),E=n("".slice),O=function(R){return R===void 0?R:String(R)},k=(function(){return"a".replace(/./,"$0")==="$0"})(),T=(function(){return/./[S]?/./[S]("a","$0")==="":!1})(),D=!r(function(){var R=/./;return R.exec=function(){var M=[];return M.groups={a:"7"},M},"".replace(R,"$<a>")!=="7"});return s("replace",function(R,M,L){var U=T?"$":"$0";return[function(J,Z){var Q=d(this),Y=a(J)?f(J,S):void 0;return Y?e(Y,J,Q,Z):e(M,u(Q),J,Z)},function(V,J){var Z=i(this),Q=u(V);if(typeof J=="string"&&C(J,U)===-1&&C(J,"$<")===-1){var Y=L(M,Z,Q,J);if(Y.done)return Y.value}var Ie=o(J);Ie||(J=u(J));var be=u(x(Z)),me=C(be,"g")!==-1,ne;me&&(ne=C(be,"u")!==-1,Z.lastIndex=0);for(var Me=[],ge;ge=y(Z,Q),!(ge===null||(I(Me,ge),!me));){var ce=u(ge[0]);ce===""&&(Z.lastIndex=p(Q,l(Z.lastIndex),ne))}for(var _e="",ye=0,ht=0;ht<Me.length;ht++){ge=Me[ht];for(var st=u(ge[0]),Ze=w(P(c(ge.index),Q.length),0),rt=[],it,en=1;en<ge.length;en++)I(rt,O(ge[en]));var Vn=ge.groups;if(Ie){var cs=_([st],rt,Ze,Q);Vn!==void 0&&I(cs,Vn),it=u(t(J,void 0,cs))}else it=g(st,Q,Ze,rt,Vn,J);Ze>=ye&&(_e+=E(Q,ye,Ze)+it,ye=Ze+st.length)}return _e+E(Q,ye)}]},!D||!k||T),bb}var Ab={},wf,Mb;function QM(){if(Mb)return wf;Mb=1;var t=si(),e=ha(),n=ri(),s=n("match");return wf=function(r){var i;return t(r)&&((i=r[s])!==void 0?!!i:e(r)==="RegExp")},wf}var jb;function ej(){if(jb)return Ab;jb=1;var t=ga(),e=ni(),n=Zt(),s=pa(),r=qn(),i=si(),o=QM(),a=Nc(),c=wm(),l=l1(),u=c1(),d=ri(),p=U0(),f=d("replace"),g=TypeError,x=n("".indexOf),y=n("".replace),m=n("".slice),S=Math.max;return t({target:"String",proto:!0},{replaceAll:function(P,_){var I=s(this),C,E,O,k,T,D,R,M,L,U,V=0,J="";if(i(P)){if(C=o(P),C&&(E=a(s(l(P))),!~x(E,"g")))throw new g("`.replaceAll` does not allow non-global regexes");if(O=c(P,f),O)return e(O,P,I,_);if(p&&C)return y(a(I),P,_)}for(k=a(I),T=a(P),D=r(_),D||(_=a(_)),R=T.length,M=S(1,R),L=x(k,T);L!==-1;)U=D?a(_(T,L,k)):u(T,k,L,[],void 0,_),J+=m(k,V,L)+U,V=L+R,L=L+M>k.length?-1:x(k,T,L+M);return V<k.length&&(J+=m(k,V)),J}}),Ab}var vf,Db;function tj(){if(Db)return vf;Db=1,a1(),JM(),ej();var t=$c();return vf=t("String","replaceAll"),vf}var Pf,Ob;function nj(){if(Ob)return Pf;Ob=1;var t=tj();return Pf=t,Pf}nj();function d1(t){return t&&typeof t=="object"&&"parents"in t}function u1(t){for(let e=0,n=t.parents.length;e<n;e++)if(t.parents[e].__unsafe__getWithoutCapture(!0),t.parents[e].lastChangedEpoch!==t.parentEpochs[e])return!0;return!1}function pd(t,e){if(t.children.remove(e)&&t.children.isEmpty&&d1(t))for(let n=0,s=t.parents.length;n<s;n++)pd(t.parents[n],t)}function Am(t,e){if(t.children.add(e)&&d1(t))for(let n=0,s=t.parents.length;n<s;n++)Am(t.parents[n],t)}function h1(t,e){return t===e||Object.is(t,e)||!!(t&&e&&typeof t.equals=="function"&&t.equals(e))}function Ri(t,e){const n=Symbol.for(`com.tldraw.state/${t}`),s=globalThis;return s[n]??=e(),s[n]}const Ct=Ri("empty_array",()=>Object.freeze([])),Lb=8;class fd{arraySize=0;array=Array(Lb);set=null;get isEmpty(){if(this.array)return this.arraySize===0;if(this.set)return this.set.size===0;throw new Error("no set or array")}add(e){if(this.array)return this.array.indexOf(e)!==-1?!1:this.arraySize<Lb?(this.array[this.arraySize]=e,this.arraySize++,!0):(this.set=new Set(this.array),this.array=null,this.set.add(e),!0);if(this.set)return this.set.has(e)?!1:(this.set.add(e),!0);throw new Error("no set or array")}remove(e){if(this.array){const n=this.array.indexOf(e);return n===-1?!1:(this.array[n]=void 0,this.arraySize--,n!==this.arraySize&&(this.array[n]=this.array[this.arraySize],this.array[this.arraySize]=void 0),!0)}if(this.set)return this.set.has(e)?(this.set.delete(e),!0):!1;throw new Error("no set or array")}visit(e){if(this.array){for(let n=0;n<this.arraySize;n++){const s=this.array[n];typeof s<"u"&&e(s)}return}if(this.set){this.set.forEach(e);return}throw new Error("no set or array")}*[Symbol.iterator](){if(this.array)for(let e=0;e<this.arraySize;e++){const n=this.array[e];typeof n<"u"&&(yield n)}else if(this.set)yield*this.set;else throw new Error("no set or array")}has(e){return this.array?this.array.indexOf(e)!==-1:this.set.has(e)}clear(){this.set?this.set.clear():(this.arraySize=0,this.array=[])}size(){return this.set?this.set.size:this.arraySize}}const Ss=Symbol.for("com.tldraw.state/RESET_VALUE");class p1{constructor(e){this.capacity=e,this.buffer=new Array(e)}index=0;buffer;pushEntry(e,n,s){if(s!==void 0){if(s===Ss){this.clear();return}this.buffer[this.index]=[e,n,s],this.index=(this.index+1)%this.capacity}}clear(){this.index=0,this.buffer.fill(void 0)}getChangesSince(e){const{index:n,capacity:s,buffer:r}=this;for(let i=0;i<s;i++){const o=(n-1+s-i)%s,a=r[o];if(!a)return Ss;const[c,l]=a;if(i===0&&e>=l)return[];if(c<=e&&e<l){const u=i+1,d=new Array(u);for(let p=0;p<u;p++)d[p]=r[(o+p)%s][2];return d}}return Ss}}const Pi=-1;class sj{constructor(e,n,s){this.name=e,this.runEffect=n,this._scheduleEffect=s?.scheduleEffect}_isActivelyListening=!1;get isActivelyListening(){return this._isActivelyListening}lastTraversedEpoch=Pi;lastReactedEpoch=Pi;_scheduleCount=0;__debug_ancestor_epochs__=null;get scheduleCount(){return this._scheduleCount}parentSet=new fd;parentEpochs=[];parents=[];_scheduleEffect;maybeScheduleEffect(){if(this._isActivelyListening&&this.lastReactedEpoch!==ts()){if(this.parents.length&&!u1(this)){this.lastReactedEpoch=ts();return}this.scheduleEffect()}}scheduleEffect(){this._scheduleCount++,this._scheduleEffect?this._scheduleEffect(this.maybeExecute):this.execute()}maybeExecute=()=>{this._isActivelyListening&&this.execute()};attach(){this._isActivelyListening=!0;for(let e=0,n=this.parents.length;e<n;e++)Am(this.parents[e],this)}detach(){this._isActivelyListening=!1;for(let e=0,n=this.parents.length;e<n;e++)pd(this.parents[e],this)}execute(){try{x1(this);const e=ts(),n=this.runEffect(this.lastReactedEpoch);return this.lastReactedEpoch=e,n}finally{b1()}}}const fo=Ri("EffectScheduler",()=>sj);function is(t,e,n){const s=new fo(t,e,n);return s.attach(),s.scheduleEffect(),()=>{s.detach()}}function rj(t,e,n){const s=new fo(t,e,n);return{scheduler:s,start:r=>{const i=r?.force??!1;s.attach(),i?s.scheduleEffect():s.maybeScheduleEffect()},stop:()=>{s.detach()}}}class ij{constructor(e,n){this.parent=e,this.isSync=n}asyncProcessCount=0;initialAtomValues=new Map;get isRoot(){return this.parent===null}commit(){if(Xe.globalIsReacting)for(const e of this.initialAtomValues.keys())y1(e);else this.isRoot?m1(this.initialAtomValues.keys()):this.initialAtomValues.forEach((e,n)=>{this.parent.initialAtomValues.has(n)||this.parent.initialAtomValues.set(n,e)})}abort(){Xe.globalEpoch++,this.initialAtomValues.forEach((e,n)=>{n.set(e),n.historyBuffer?.clear()}),this.commit()}}const Xe=Ri("transactions",()=>({globalEpoch:Pi+1,globalIsReacting:!1,currentTransaction:null,cleanupReactors:null,reactionEpoch:Pi+1}));function oj(){return Xe.reactionEpoch}function ts(){return Xe.globalEpoch}function aj(){return Xe.globalIsReacting}let Mm;function f1(t){t.lastTraversedEpoch!==Xe.globalEpoch&&(t.lastTraversedEpoch=Xe.globalEpoch,t instanceof fo?Mm.add(t):t.children.visit(f1))}function g1(t,e){Mm=t,f1(e)}function m1(t){if(Xe.globalIsReacting)throw new Error("flushChanges cannot be called during a reaction");const e=Xe.currentTransaction;try{Xe.currentTransaction=null,Xe.globalIsReacting=!0,Xe.reactionEpoch=Xe.globalEpoch;const n=new Set;for(const r of t)r.children.visit(i=>g1(n,i));for(const r of n)r.maybeScheduleEffect();let s=0;for(;Xe.cleanupReactors?.size;){if(s++>1e3)throw new Error("Reaction update depth limit exceeded");const r=Xe.cleanupReactors;Xe.cleanupReactors=null;for(const i of r)i.maybeScheduleEffect()}}finally{Xe.cleanupReactors=null,Xe.globalIsReacting=!1,Xe.currentTransaction=e,Mm=void 0}}function cj(t,e){Xe.currentTransaction?Xe.currentTransaction.initialAtomValues.has(t)||Xe.currentTransaction.initialAtomValues.set(t,e):Xe.globalIsReacting?y1(t):m1([t])}function y1(t){const e=Xe.cleanupReactors??=new Set;t.children.visit(n=>g1(e,n))}function lj(){Xe.globalEpoch++}function dj(t){const e=new ij(Xe.currentTransaction,!0);Xe.currentTransaction=e;try{let n,s=!1;try{n=t(()=>s=!0)}catch(r){throw e.abort(),r}if(Xe.currentTransaction!==e)throw new Error("Transaction boundaries overlap");return s?e.abort():e.commit(),n}finally{Xe.currentTransaction=e.parent}}function xs(t){return Xe.currentTransaction?t():dj(t)}let Rb=!1;function uj(){Rb||(Rb=!0,console.warn(`Using \`@computed\` as a decorator for getters is deprecated and will be removed in the near future. Please refactor to use \`@computed\` as a decorator for methods.

// Before
@computed
get foo() {
	return 'foo'
}

// After
@computed
getFoo() {
	return 'foo'
}
`))}const wn=Symbol.for("com.tldraw.state/UNINITIALIZED");function Xi(t){return t===wn}const gg=Ri("WithDiff",()=>class{constructor(e,n){this.value=e,this.diff=n}});function Ga(t,e){return new gg(t,e)}class hj{constructor(e,n,s){this.name=e,this.derive=n,s?.historyLength&&(this.historyBuffer=new p1(s.historyLength)),this.computeDiff=s?.computeDiff,this.isEqual=s?.isEqual??h1}lastChangedEpoch=Pi;lastTraversedEpoch=Pi;__debug_ancestor_epochs__=null;lastCheckedEpoch=Pi;parentSet=new fd;parents=[];parentEpochs=[];children=new fd;get isActivelyListening(){return!this.children.isEmpty}historyBuffer;state=wn;error=null;computeDiff;isEqual;__unsafe__getWithoutCapture(e){const n=this.lastChangedEpoch===Pi,s=ts();if(!n&&(this.lastCheckedEpoch===s||this.isActivelyListening&&aj()&&this.lastTraversedEpoch<oj()||!u1(this)))if(this.lastCheckedEpoch=s,this.error){if(e)return this.state;throw this.error.thrownValue}else return this.state;try{x1(this);const r=this.derive(this.state,this.lastCheckedEpoch),i=r instanceof gg?r.value:r,o=this.state===wn;if(o||!this.isEqual(i,this.state)){if(this.historyBuffer&&!o){const a=r instanceof gg?r.diff:void 0;this.historyBuffer.pushEntry(this.lastChangedEpoch,ts(),a??this.computeDiff?.(this.state,i,this.lastCheckedEpoch,ts())??Ss)}this.lastChangedEpoch=ts(),this.state=i}return this.error=null,this.lastCheckedEpoch=ts(),this.state}catch(r){if(this.state!==wn&&(this.state=wn,this.lastChangedEpoch=ts()),this.lastCheckedEpoch=ts(),this.historyBuffer&&this.historyBuffer.clear(),this.error={thrownValue:r},!e)throw r;return this.state}finally{b1()}}get(){try{return this.__unsafe__getWithoutCapture()}finally{gd(this)}}getDiffSince(e){return this.__unsafe__getWithoutCapture(!0),gd(this),e>=this.lastChangedEpoch?Ct:this.historyBuffer?.getChangesSince(e)??Ss}}const Uc=Ri("Computed",()=>hj);function pj(t={},e,n,s){const r=s.value,i=Symbol.for("__@tldraw/state__computed__"+n);return s.value=function(){let o=this[i];return o||(o=new Uc(n,r.bind(this),t),Object.defineProperty(this,i,{enumerable:!1,configurable:!1,writable:!1,value:o})),o.get()},s.value[S1]=!0,s}function fj(t={},e,n,s){const r=s.get,i=Symbol.for("__@tldraw/state__computed__"+n);return s.get=function(){let o=this[i];return o||(o=new Uc(n,r.bind(this),t),Object.defineProperty(this,i,{enumerable:!1,configurable:!1,writable:!1,value:o})),o.get()},s}function gj(t,e,n){le(n.kind==="method","@computed can only be used on methods");const s=Symbol.for("__@tldraw/state__computed__"+String(n.name)),r=function(){let i=this[s];return i||(i=new Uc(String(n.name),e.bind(this),t),Object.defineProperty(this,s,{enumerable:!1,configurable:!1,writable:!1,value:i})),i.get()};return r[S1]=!0,r}function Fb(t={},e){if(e.length===2){const[n,s]=e;return gj(t,n,s)}else{const[n,s,r]=e;return r.get?(uj(),fj(t,n,s,r)):pj(t,n,s,r)}}const S1="@@__isComputedMethod__@@";function K(){if(arguments.length===1){const t=arguments[0];return(...e)=>Fb(t,e)}else return typeof arguments[0]=="string"?new Uc(arguments[0],arguments[1],arguments[2]):Fb(void 0,arguments)}function jm(t){return!!(t&&t instanceof Uc)}class mj{constructor(e,n){this.below=e,this.child=n}offset=0;maybeRemoved}const ft=Ri("capture",()=>({stack:null}));function Yi(t){const e=ft.stack;ft.stack=null;try{return t()}finally{ft.stack=e}}function x1(t){if(ft.stack=new mj(ft.stack,t),t.__debug_ancestor_epochs__){const e=t.__debug_ancestor_epochs__;t.__debug_ancestor_epochs__=null;for(const n of t.parents)n.__unsafe__getWithoutCapture(!0);yj(t,e)}t.parentSet.clear()}function b1(){const t=ft.stack;if(ft.stack=t.below,t.offset<t.child.parents.length){for(let e=t.offset;e<t.child.parents.length;e++){const n=t.child.parents[e];t.child.parentSet.has(n)||pd(n,t.child)}t.child.parents.length=t.offset,t.child.parentEpochs.length=t.offset}if(t.maybeRemoved)for(let e=0;e<t.maybeRemoved.length;e++){const n=t.maybeRemoved[e];t.child.parentSet.has(n)||pd(n,t.child)}t.child.__debug_ancestor_epochs__&&w1(t.child,t.child.__debug_ancestor_epochs__)}function gd(t){if(ft.stack){if(ft.stack.child.parentSet.has(t))return;if(ft.stack.child.parentSet.add(t),ft.stack.child.isActivelyListening&&Am(t,ft.stack.child),ft.stack.offset<ft.stack.child.parents.length){const n=ft.stack.child.parents[ft.stack.offset];n!==t&&(ft.stack.maybeRemoved?ft.stack.maybeRemoved.push(n):ft.stack.maybeRemoved=[n])}ft.stack.child.parents[ft.stack.offset]=t,ft.stack.child.parentEpochs[ft.stack.offset]=t.lastChangedEpoch,ft.stack.offset++}}function w1(t,e){for(let n=0;n<t.parents.length;n++){const s=t.parents[n],r=t.parentEpochs[n];e.set(s,r),jm(s)&&w1(s,e)}return e}function v1(t,e){const n={};for(let s=0;s<t.parents.length;s++){const r=t.parents[s];if(!e.has(r))continue;const i=e.get(r);r.lastChangedEpoch!==i&&(jm(r)?n[r.name]=v1(r,e):n[r.name]=null)}return n}function yj(t,e){const n=v1(t,e);if(Object.keys(n).length===0){console.log(`Effect(${t.name}) was executed manually.`);return}let s=jm(t)?`Computed(${t.name}) is recomputing because:`:`Effect(${t.name}) is executing because:`;function r(i,o){const a=`
`+" ".repeat(o)+"↳ ";for(const[c,l]of Object.entries(i))l?(s+=`${a}Computed(${c}) changed`,r(l,o+2)):s+=`${a}Atom(${c}) changed`}r(n,1),console.log(s)}class Sj{constructor(e,n,s){this.name=e,this.current=n,this.isEqual=s?.isEqual??null,s&&(s.historyLength&&(this.historyBuffer=new p1(s.historyLength)),this.computeDiff=s.computeDiff)}isEqual;computeDiff;lastChangedEpoch=ts();children=new fd;historyBuffer;__unsafe__getWithoutCapture(e){return this.current}get(){return gd(this),this.current}set(e,n){if(this.isEqual?.(this.current,e)??h1(this.current,e))return this.current;lj(),this.historyBuffer&&this.historyBuffer.pushEntry(this.lastChangedEpoch,ts(),n??this.computeDiff?.(this.current,e,this.lastChangedEpoch,ts())??Ss),this.lastChangedEpoch=ts();const s=this.current;return this.current=e,cj(this,s),e}update(e){return this.set(e(this.current))}getDiffSince(e){return gd(this),e>=this.lastChangedEpoch?Ct:this.historyBuffer?.getChangesSince(e)??Ss}}const xj=Ri("Atom",()=>Sj);function je(t,e,n){return new xj(t,e,n)}const P1=1,bj=Ri("apiVersion",()=>P1);if(bj!==P1)throw new Error("You have multiple incompatible versions of @tldraw/state in your app. Please deduplicate the package.");Di("@tldraw/state","4.3.1","esm");function Jd(t,e,n=[]){const s=Ye.useRef(e);s.current=e;const[r,i,o]=Ye.useMemo(()=>{let a=null;const c=d=>(a=d,()=>{a=null}),l=new fo(`useStateTracking(${t})`,()=>s.current?.(),{scheduleEffect(){a?.()}});return[l,c,()=>l.scheduleCount]},[t,...n]);return Ye.useSyncExternalStore(i,o,o),Ye.useEffect(()=>(r.attach(),r.maybeScheduleEffect(),()=>{r.detach()}),[r]),r.execute()}const Bb={apply(t,e,n){return Jd(t.displayName??t.name??"tracked(???)",()=>t.apply(e,n))}},wj=Symbol.for("react.memo"),vj=Symbol.for("react.forward_ref");function Ot(t){let e=null;const n=t.$$typeof;return n===wj&&(t=t.type,e=t.compare),n===vj?v.memo(v.forwardRef(new Proxy(t.render,Bb))):v.memo(new Proxy(t,Bb),e)}function Hc(t,e,n){return v.useState(()=>{const s=typeof e=="function"?e():e;return je(`useAtom(${t})`,s,n)})[0]}function Pj(){const t=arguments[0],e=arguments[1],n=arguments.length===3?void 0:arguments[2],s=arguments.length===3?arguments[2]:arguments[3];return v.useMemo(()=>K(`useComputed(${t})`,e,n),s)}function Qi(t,e,n=Ct){v.useEffect(()=>{const s=new fo(t,e);return s.attach(),s.execute(),()=>{s.detach()}},n)}function Qd(t,e,n=[]){v.useEffect(()=>{let s;const r=new fo(t,e,{scheduleEffect:i=>{s=Sm(i)}});return r.attach(),r.execute(),()=>{r.detach(),s?.()}},n)}function $(){const t=arguments,e=t.length===3?t[2]:[t[0]],n=t.length===3?t[0]:`useValue(${t[0].name})`,{$val:s,subscribe:r,getSnapshot:i}=v.useMemo(()=>{const o=t.length===1?t[0]:K(n,t[1]);return{$val:o,subscribe:a=>is(`useValue(${n})`,()=>{try{o.get()}catch{}a()}),getSnapshot:()=>o.lastChangedEpoch}},e);return v.useSyncExternalStore(r,i,i),s.__unsafe__getWithoutCapture()}Di("@tldraw/state-react","4.3.1","esm");function Dm(t){return t>>>1&1073741824|t&3221225471}const Ij=Object.prototype.valueOf;function eo(t){if(t==null)return zb(t);if(typeof t.hashCode=="function")return Dm(t.hashCode(t));const e=kj(t);if(e==null)return zb(e);switch(typeof e){case"boolean":return e?1108378657:1108378656;case"number":return _j(e);case"string":return e.length>Aj?Cj(e):mg(e);case"object":case"function":return Ej(e);case"symbol":return Tj(e);default:if(typeof e.toString=="function")return mg(e.toString());throw new Error("Value type "+typeof e+" cannot be hashed.")}}function zb(t){return t===null?1108378658:1108378659}function _j(t){if(t!==t||t===1/0)return 0;let e=t|0;for(e!==t&&(e^=t*4294967295);t>4294967295;)t/=4294967295,e^=t;return Dm(e)}function Cj(t){let e=Cf[t];return e===void 0&&(e=mg(t),_f===Mj&&(_f=0,Cf={}),_f++,Cf[t]=e),e}function mg(t){let e=0;for(let n=0;n<t.length;n++)e=31*e+t.charCodeAt(n)|0;return Dm(e)}function Tj(t){let e=Nb[t];return e!==void 0||(e=I1(),Nb[t]=e),e}function Ej(t){let e=$b.get(t);return e!==void 0||(e=I1(),$b.set(t,e)),e}function kj(t){return t.valueOf!==Ij&&typeof t.valueOf=="function"?t.valueOf(t):t}function I1(){const t=++If;return If&1073741824&&(If=0),t}const $b=new WeakMap,Nb=Object.create(null);let If=0;const Aj=16,Mj=255;let _f=0,Cf={};const ea=5,Kc=1<<ea,ta=Kc-1,ei={};function Ub(){return{value:!1}}function Js(t){t&&(t.value=!0)}function Om(t,e=0){return t.slice(e)}class _1{}class Lm{_root;size;__ownerID;__hash;__altered;constructor(e){return e==null?Wo():e instanceof Lm?e:Wo().withMutations(n=>{for(const[s,r]of e)n.set(s,r)})}get(e,n){return this._root?this._root.get(0,void 0,e,n):n}set(e,n){return Wb(this,e,n)}delete(e){return Wb(this,e,ei)}deleteAll(e){return this.withMutations(n=>{for(const s of e)n.delete(s)})}__ensureOwner(e){return e===this.__ownerID?this:e?Bm(this.size,this._root,e,this.__hash):this.size===0?Wo():(this.__ownerID=e,this.__altered=!1,this)}withMutations(e){const n=this.asMutable();return e(n),n.wasAltered()?n.__ensureOwner(this.__ownerID):this}wasAltered(){return this.__altered}asMutable(){return this.__ownerID?this:this.__ensureOwner(new _1)}[Symbol.iterator](){return this.entries()[Symbol.iterator]()}entries(){return new Tf(this,jj,!1)}keys(){return new Tf(this,C1,!1)}values(){return new Tf(this,T1,!1)}}class Rm{constructor(e,n){this.ownerID=e,this.entries=n}get(e,n,s,r){const i=this.entries;for(let o=0,a=i.length;o<a;o++)if(Object.is(s,i[o][0]))return i[o][1];return r}update(e,n,s,r,i,o,a){const c=i===ei,l=this.entries;let u=0;const d=l.length;for(;u<d&&!Object.is(r,l[u][0]);u++);const p=u<d;if(p?l[u][1]===i:c)return this;if(Js(a),(c||!p)&&Js(o),c&&l.length===1)return;if(!p&&!c&&l.length>=$j)return Lj(e,l,r,i);const f=e&&e===this.ownerID,g=f?l:Om(l);return p?c?u===d-1?g.pop():g[u]=g.pop():g[u]=[r,i]:g.push([r,i]),f?(this.entries=g,this):new Rm(e,g)}}class eu{constructor(e,n,s){this.ownerID=e,this.bitmap=n,this.nodes=s}get(e,n,s,r){n===void 0&&(n=eo(s));const i=1<<((e===0?n:n>>>e)&ta),o=this.bitmap;return(o&i)===0?r:this.nodes[Gb(o&i-1)].get(e+ea,n,s,r)}update(e,n,s,r,i,o,a){s===void 0&&(s=eo(r));const c=(n===0?s:s>>>n)&ta,l=1<<c,u=this.bitmap,d=(u&l)!==0;if(!d&&i===ei)return this;const p=Gb(u&l-1),f=this.nodes,g=d?f[p]:void 0,x=zm(g,e,n+ea,s,r,i,o,a);if(x===g)return this;if(!d&&x&&f.length>=Nj)return Fj(e,f,u,c,x);if(d&&!x&&f.length===2&&qb(f[p^1]))return f[p^1];if(d&&x&&f.length===1&&qb(x))return x;const y=e&&e===this.ownerID,m=d?x?u:u^l:u|l,S=d?x?E1(f,p,x,y):zj(f,p,y):Bj(f,p,x,y);return y?(this.bitmap=m,this.nodes=S,this):new eu(e,m,S)}}class Fm{constructor(e,n,s){this.ownerID=e,this.count=n,this.nodes=s}get(e,n,s,r){n===void 0&&(n=eo(s));const i=(e===0?n:n>>>e)&ta,o=this.nodes[i];return o?o.get(e+ea,n,s,r):r}update(e,n,s,r,i,o,a){s===void 0&&(s=eo(r));const c=(n===0?s:s>>>n)&ta,l=i===ei,u=this.nodes,d=u[c];if(l&&!d)return this;const p=zm(d,e,n+ea,s,r,i,o,a);if(p===d)return this;let f=this.count;if(!d)f++;else if(!p&&(f--,f<Uj))return Rj(e,u,f,c);const g=e&&e===this.ownerID,x=E1(u,c,p,g);return g?(this.count=f,this.nodes=x,this):new Fm(e,f,x)}}class tu{constructor(e,n,s){this.ownerID=e,this.keyHash=n,this.entries=s}get(e,n,s,r){const i=this.entries;for(let o=0,a=i.length;o<a;o++)if(Object.is(s,i[o][0]))return i[o][1];return r}update(e,n,s,r,i,o,a){s===void 0&&(s=eo(r));const c=i===ei;if(s!==this.keyHash)return c?this:(Js(a),Js(o),$m(this,e,n,s,[r,i]));const l=this.entries;let u=0;const d=l.length;for(;u<d&&!Object.is(r,l[u][0]);u++);const p=u<d;if(p?l[u][1]===i:c)return this;if(Js(a),(c||!p)&&Js(o),c&&d===2)return new go(e,this.keyHash,l[u^1]);const f=e&&e===this.ownerID,g=f?l:Om(l);return p?c?u===d-1?g.pop():g[u]=g.pop():g[u]=[r,i]:g.push([r,i]),f?(this.entries=g,this):new tu(e,this.keyHash,g)}}class go{constructor(e,n,s){this.ownerID=e,this.keyHash=n,this.entry=s}get(e,n,s,r){return Object.is(s,this.entry[0])?this.entry[1]:r}update(e,n,s,r,i,o,a){const c=i===ei,l=Object.is(r,this.entry[0]);if(l?i===this.entry[1]:c)return this;if(Js(a),c){Js(o);return}return l?e&&e===this.ownerID?(this.entry[1]=i,this):new go(e,this.keyHash,[r,i]):(Js(o),$m(this,e,n,eo(r),[r,i]))}}class Tf{constructor(e,n,s){this._type=n,this._reverse=s,this._stack=e._root&&Hb(e._root)}_stack;[Symbol.iterator](){return this}next(){const e=this._type;let n=this._stack;for(;n;){const s=n.node,r=n.index++;let i;if(s.entry){if(r===0)return Ef(e,s.entry)}else if("entries"in s&&s.entries){if(i=s.entries.length-1,r<=i)return Ef(e,s.entries[this._reverse?i-r:r])}else if(i=s.nodes.length-1,r<=i){const o=s.nodes[this._reverse?i-r:r];if(o){if(o.entry)return Ef(e,o.entry);n=this._stack=Hb(o,n)}continue}n=this._stack=this._stack.__prev}return Oj()}}function Ef(t,e){return Dj(t,e[0],e[1])}function Hb(t,e){return{node:t,index:0,__prev:e}}const C1=0,T1=1,jj=2;function Dj(t,e,n,s){const r=t===C1?e:t===T1?n:[e,n];return s?s.value=r:s={value:r,done:!1},s}function Oj(){return{value:void 0,done:!0}}function Bm(t,e,n,s){const r=Object.create(Lm.prototype);return r.size=t,r._root=e,r.__ownerID=n,r.__hash=s,r.__altered=!1,r}let Kb;function Wo(){return Kb||(Kb=Bm(0))}function Wb(t,e,n){let s,r;if(t._root){const i=Ub(),o=Ub();if(s=zm(t._root,t.__ownerID,0,void 0,e,n,i,o),!o.value)return t;r=t.size+(i.value?n===ei?-1:1:0)}else{if(n===ei)return t;r=1,s=new Rm(t.__ownerID,[[e,n]])}return t.__ownerID?(t.size=r,t._root=s,t.__hash=void 0,t.__altered=!0,t):s?Bm(r,s):Wo()}function zm(t,e,n,s,r,i,o,a){return t?t.update(e,n,s,r,i,o,a):i===ei?t:(Js(a),Js(o),new go(e,s,[r,i]))}function qb(t){return t.constructor===go||t.constructor===tu}function $m(t,e,n,s,r){if(t.keyHash===s)return new tu(e,s,[t.entry,r]);const i=(n===0?t.keyHash:t.keyHash>>>n)&ta,o=(n===0?s:s>>>n)&ta;let a;const c=i===o?[$m(t,e,n+ea,s,r)]:(a=new go(e,s,r),i<o?[t,a]:[a,t]);return new eu(e,1<<i|1<<o,c)}function Lj(t,e,n,s){t||(t=new _1);let r=new go(t,eo(n),[n,s]);for(let i=0;i<e.length;i++){const o=e[i];r=r.update(t,0,void 0,o[0],o[1])}return r}function Rj(t,e,n,s){let r=0,i=0;const o=new Array(n);for(let a=0,c=1,l=e.length;a<l;a++,c<<=1){const u=e[a];u!==void 0&&a!==s&&(r|=c,o[i++]=u)}return new eu(t,r,o)}function Fj(t,e,n,s,r){let i=0;const o=new Array(Kc);for(let a=0;n!==0;a++,n>>>=1)o[a]=n&1?e[i++]:void 0;return o[s]=r,new Fm(t,i+1,o)}function Gb(t){return t-=t>>1&1431655765,t=(t&858993459)+(t>>2&858993459),t=t+(t>>4)&252645135,t+=t>>8,t+=t>>16,t&127}function E1(t,e,n,s){const r=s?t:Om(t);return r[e]=n,r}function Bj(t,e,n,s){const r=t.length+1;if(s&&e+1===r)return t[e]=n,t;const i=new Array(r);let o=0;for(let a=0;a<r;a++)a===e?(i[a]=n,o=-1):i[a]=t[a+o];return i}function zj(t,e,n){const s=t.length-1;if(n&&e===s)return t.pop(),t;const r=new Array(s);let i=0;for(let o=0;o<s;o++)o===e&&(i=1),r[o]=t[o+i];return r}const $j=Kc/4,Nj=Kc/2,Uj=Kc/4;class md{constructor(e,n){this.name=e;let s=Wo();n&&(s=s.withMutations(r=>{for(const[i,o]of n)r.set(i,je(`${e}:${String(i)}`,o))})),this.atoms=je(`${e}:atoms`,s)}atoms;getAtom(e){const n=this.atoms.__unsafe__getWithoutCapture().get(e);if(!n){this.atoms.get();return}return n}get(e){const n=this.getAtom(e)?.get();return le(n!==wn),n}__unsafe__getWithoutCapture(e){const n=this.atoms.__unsafe__getWithoutCapture().get(e);if(!n)return;const s=n.__unsafe__getWithoutCapture();return le(s!==wn),s}has(e){const n=this.getAtom(e);return n?n.get()!==wn:!1}__unsafe__hasWithoutCapture(e){const n=this.atoms.__unsafe__getWithoutCapture().get(e);return n?(le(n.__unsafe__getWithoutCapture()!==wn),!0):!1}set(e,n){const s=this.atoms.__unsafe__getWithoutCapture().get(e);return s?s.set(n):this.atoms.update(r=>r.set(e,je(`${this.name}:${String(e)}`,n))),this}update(e,n){const s=this.atoms.__unsafe__getWithoutCapture().get(e);if(!s)throw new Error(`AtomMap: key ${e} not found`);const r=s.__unsafe__getWithoutCapture();le(r!==wn),s.set(n(r))}delete(e){const n=this.atoms.__unsafe__getWithoutCapture().get(e);return n?(xs(()=>{n.set(wn),this.atoms.update(s=>s.delete(e))}),!0):!1}deleteMany(e){return xs(()=>{const n=[],s=this.atoms.get().withMutations(r=>{for(const i of e){const o=r.get(i);if(!o)continue;const a=o.get();le(a!==wn),n.push([i,a]),r.delete(i),o.set(wn)}});return n.length&&this.atoms.set(s),n})}clear(){return xs(()=>{for(const e of this.atoms.__unsafe__getWithoutCapture().values())e.set(wn);this.atoms.set(Wo())})}*entries(){for(const[e,n]of this.atoms.get()){const s=n.get();le(s!==wn),yield[e,s]}}*keys(){for(const e of this.atoms.get().keys())yield e}*values(){for(const e of this.atoms.get().values()){const n=e.get();le(n!==wn),yield n}}get size(){return this.atoms.get().size}forEach(e,n){for(const[s,r]of this.entries())e.call(n,r,s,this)}[Symbol.iterator](){return this.entries()}[Symbol.toStringTag]="AtomMap"}class Yb{constructor(e,n){this.name=e;const s=n?Array.from(n,r=>[r,r]):void 0;this.map=new md(e,s)}map;add(e){return this.map.set(e,e),this}clear(){this.map.clear()}delete(e){return this.map.delete(e)}forEach(e,n){for(const s of this)e.call(n,s,s,this)}has(e){return this.map.has(e)}get size(){return this.map.size}entries(){return this.map.entries()}keys(){return this.map.keys()}values(){return this.map.keys()}[Symbol.iterator](){return this.map.keys()}[Symbol.toStringTag]="AtomSet"}let yd=!1;try{yd=!1}catch{}try{yd=yd||!1||void 0||!1||!1}catch{}function Hj(){return yd}function qo(t){if(!Hj())return t;const e=Object.getPrototypeOf(t);if(e&&!(Array.isArray(t)||e===Object.prototype||e===null||e===R0))throw console.error("cannot include non-js data in a record",t),new Error("cannot include non-js data in a record");if(Object.isFrozen(t))return t;const n=Object.getOwnPropertyNames(t);for(const s of n){const r=t[s];r&&typeof r=="object"&&qo(r)}return Object.freeze(t)}class sd{constructor(e){this.previousValue=e}nextValue;diff;get(){const e=this.diff?.removed?.size??0,n=this.diff?.added?.size??0;if(!(e===0&&n===0))return{value:this.nextValue,diff:this.diff}}_add(e,n){this.nextValue??=new Set(this.previousValue),this.nextValue.add(e),this.diff??={},n?this.diff.removed?.delete(e):(this.diff.added??=new Set,this.diff.added.add(e))}add(e){const n=this.previousValue.has(e);if(n)return this.diff?.removed?.has(e)?this._add(e,n):void 0;this.nextValue?.has(e)||this._add(e,n)}_remove(e,n){this.nextValue??=new Set(this.previousValue),this.nextValue.delete(e),this.diff??={},n?(this.diff.removed??=new Set,this.diff.removed.add(e)):this.diff.added?.delete(e)}remove(e){const n=this.previousValue.has(e);if(!n)return this.diff?.added?.has(e)?this._remove(e,n):void 0;this.diff?.removed?.has(e)||this._remove(e,n)}}function Kj(t){const e=[];for(let n=t.length-1;n>=0;n--){const s=t[n];if("id"in s)e.unshift(s);else{const r=s.dependsOn,i=e[0];i&&(e[0]={...i,dependsOn:r.concat(i.dependsOn??[])})}}return e}function Go({sequence:t,sequenceId:e,retroactive:n=!0}){const s={sequenceId:e,retroactive:n,sequence:Kj(t)};return k1(s),s}function as(t,e){return Object.fromEntries(zs(e).map(([n,s])=>[n,`${t}/${s}`]))}function Is(t){const e=t.sequenceId;return Go({sequenceId:e,retroactive:t.retroactive??!0,sequence:t.sequence.map(n=>"id"in n?{...n,scope:"record",filter:s=>s.typeName===t.recordType&&(n.filter?.(s)??!0)&&(t.filter?.(s)??!0)}:n)})}function Wj(t){if(t.length===0)return[];const e=new Map(t.map(c=>[c.id,c])),n=new Map,s=new Map,r=new Map;for(const c of t)s.set(c.id,0),n.set(c.id,new Set),r.set(c.id,new Set);for(const c of t){const{version:l,sequenceId:u}=Sd(c.id),d=`${u}/${l-1}`;if(e.has(d)&&(n.get(d).add(c.id),s.set(c.id,s.get(c.id)+1)),c.dependsOn)for(const p of c.dependsOn)e.has(p)&&(n.get(p).add(c.id),r.get(c.id).add(p),s.set(c.id,s.get(c.id)+1))}const i=t.filter(c=>s.get(c.id)===0),o=[],a=new Set;for(;i.length>0;){let c,l=-1/0;for(const d of i){let p=0;for(const f of n.get(d.id)||[])a.has(f)||(p+=1,r.get(f).has(d.id)&&(p+=100));(p>l||p===l&&d.id.localeCompare(c?.id??"")<0)&&(c=d,l=p)}const u=c;i.splice(i.indexOf(u),1),o.push(u),a.add(u.id);for(const d of n.get(u.id)||[])a.has(d)||(s.set(d,s.get(d)-1),s.get(d)===0&&i.push(e.get(d)))}if(o.length!==t.length){const c=t.filter(l=>!a.has(l.id));le(!1,`Circular dependency in migrations: ${c[0].id}`)}return o}function Sd(t){const[e,n]=t.split("/");return{sequenceId:e,version:parseInt(n)}}function Vb(t,e){e&&le(t.startsWith(e+"/"),`Every migration in sequence '${e}' must have an id starting with '${e}/'. Got invalid id: '${t}'`),le(t.match(/^(.*?)\/(0|[1-9]\d*)$/),`Invalid migration id: '${t}'`)}function k1(t){if(le(!t.sequenceId.includes("/"),`sequenceId cannot contain a '/', got ${t.sequenceId}`),le(t.sequenceId.length,"sequenceId must be a non-empty string"),t.sequence.length===0)return;Vb(t.sequence[0].id,t.sequenceId);let e=Sd(t.sequence[0].id).version;le(e===1,`Expected the first migrationId to be '${t.sequenceId}/1' but got '${t.sequence[0].id}'`);for(let n=1;n<t.sequence.length;n++){const s=t.sequence[n].id;Vb(s,t.sequenceId);const r=Sd(s).version;le(r===e+1,`Migration id numbers must increase in increments of 1, expected ${t.sequenceId}/${e+1} but got '${t.sequence[n].id}'`),e=r}}var xi=(t=>(t.IncompatibleSubtype="incompatible-subtype",t.UnknownType="unknown-type",t.TargetVersionTooNew="target-version-too-new",t.TargetVersionTooOld="target-version-too-old",t.MigrationError="migration-error",t.UnrecognizedSubtype="unrecognized-subtype",t))(xi||{});function xd(){return{added:{},updated:{},removed:{}}}function yg(t){const e={added:t.removed,removed:t.added,updated:{}};for(const[n,s]of Object.values(t.updated))e.updated[n.id]=[s,n];return e}function A1(t){return Object.keys(t.added).length===0&&Object.keys(t.updated).length===0&&Object.keys(t.removed).length===0}function Nm(t,e){const n=e?.mutateFirstDiff?t[0]:{added:{},removed:{},updated:{}};return lc(n,t),n}function lc(t,e){for(const n of e){for(const[s,r]of zs(n.added))if(t.removed[s]){const i=t.removed[s];delete t.removed[s],i!==r&&(t.updated[s]=[i,r])}else t.added[s]=r;for(const[s,[r,i]]of zs(n.updated)){if(t.added[s]){t.added[s]=i,delete t.updated[s],delete t.removed[s];continue}if(t.updated[s]){t.updated[s]=[t.updated[s][0],i],delete t.removed[s];continue}t.updated[s]=n.updated[s],delete t.removed[s]}for(const[s,r]of zs(n.removed))t.added[s]?delete t.added[s]:t.updated[s]?(t.removed[s]=t.updated[s][0],delete t.updated[s]):t.removed[s]=r}}class nu{constructor(e,n){this.typeName=e,this.createDefaultProperties=n.createDefaultProperties,this.validator=n.validator??{validate:r=>r},this.scope=n.scope??"document",this.ephemeralKeys=n.ephemeralKeys;const s=new Set;if(n.ephemeralKeys)for(const[r,i]of zs(n.ephemeralKeys))i&&s.add(r);this.ephemeralKeySet=s}createDefaultProperties;validator;ephemeralKeys;ephemeralKeySet;scope;create(e){const n={...this.createDefaultProperties(),id:"id"in e?e.id:this.createId()};for(const[s,r]of Object.entries(e))r!==void 0&&(n[s]=r);return n.typeName=this.typeName,n}clone(e){return{...wt(e),id:this.createId()}}createId(e){return this.typeName+":"+(e??Ge())}parseId(e){if(!this.isId(e))throw new Error(`ID "${e}" is not a valid ID for type "${this.typeName}"`);return e.slice(this.typeName.length+1)}isInstance(e){return e?.typeName===this.typeName}isId(e){if(!e)return!1;for(let n=0;n<this.typeName.length;n++)if(e[n]!==this.typeName[n])return!1;return e[this.typeName.length]===":"}withDefaultProperties(e){return new nu(this.typeName,{createDefaultProperties:e,validator:this.validator,scope:this.scope,ephemeralKeys:this.ephemeralKeys})}validate(e,n){return n&&this.validator.validateUsingKnownGoodVersion?this.validator.validateUsingKnownGoodVersion(n,e):this.validator.validate(e)}}function vr(t,e){return new nu(t,{createDefaultProperties:()=>({}),validator:e.validator,scope:e.scope,ephemeralKeys:e.ephemeralKeys})}function qj(t){if(t.length===0)return new Set;const e=t[0],n=t.slice(1),s=new Set;for(const r of e)n.every(i=>i.has(r))&&s.add(r);return s}function Gj(t,e){const n={};for(const s of e)t.has(s)||(n.added??=new Set,n.added.add(s));for(const s of t)e.has(s)||(n.removed??=new Set,n.removed.add(s));return n.added||n.removed?n:void 0}function M1(t){return typeof t!="object"||t===null?!1:"eq"in t||"neq"in t||"gt"in t}function j1(t,e=""){const n=[];for(const[s,r]of Object.entries(t)){const i=e?`${e}\\${s}`:s;M1(r)?n.push({path:i,matcher:r}):typeof r=="object"&&r!==null&&n.push(...j1(r,i))}return n}function Sg(t,e){for(const[n,s]of Object.entries(t)){const r=e[n];if(M1(s)){if("eq"in s&&r!==s.eq||"neq"in s&&r===s.neq||"gt"in s&&(typeof r!="number"||r<=s.gt))return!1;continue}if(typeof r!="object"||r===null||!Sg(s,r))return!1}return!0}function Xb(t,e,n){const s=j1(n),r=Object.fromEntries(s.map(({path:i})=>[i,new Set]));for(const{path:i,matcher:o}of s){const a=t.index(e,i);if("eq"in o){const c=a.get().get(o.eq);if(c)for(const l of c)r[i].add(l)}else if("neq"in o){for(const[c,l]of a.get())if(c!==o.neq)for(const u of l)r[i].add(u)}else if("gt"in o){for(const[c,l]of a.get())if(typeof c=="number"&&c>o.gt)for(const u of l)r[i].add(u)}if(r[i].size===0)return new Set}return qj(Object.values(r))}class Yj{constructor(e,n){this.recordMap=e,this.history=n}indexCache=new Map;historyCache=new Map;getAllIdsForType(e){const n=new Set;for(const s of this.recordMap.values())s.typeName===e&&n.add(s.id);return n}getRecordById(e,n){const s=this.recordMap.get(n);if(s&&s.typeName===e)return s}getNestedValue(e,n){let s=e;for(const r of n){if(s==null||typeof s!="object")return;s=s[r]}return s}filterHistory(e){if(this.historyCache.has(e))return this.historyCache.get(e);const n=K("filterHistory:"+e,(s,r)=>{if(Xi(s))return this.history.get();const i=this.history.getDiffSince(r);if(i===Ss)return this.history.get();const o={added:{},removed:{},updated:{}};let a=0,c=0,l=0;for(const u of i){for(const d of _t(u.added))if(d.typeName===e)if(o.removed[d.id]){const p=o.removed[d.id];delete o.removed[d.id],c--,p!==d&&(o.updated[d.id]=[p,d],l++)}else o.added[d.id]=d,a++;for(const[d,p]of _t(u.updated))p.typeName===e&&(o.added[p.id]?o.added[p.id]=p:o.updated[p.id]?o.updated[p.id]=[o.updated[p.id][0],p]:(o.updated[p.id]=[d,p],l++));for(const d of _t(u.removed))d.typeName===e&&(o.added[d.id]?(delete o.added[d.id],a--):o.updated[d.id]?(o.removed[d.id]=o.updated[d.id][0],delete o.updated[d.id],l--,c++):(o.removed[d.id]=d,c++))}return a||c||l?Ga(this.history.get(),o):s},{historyLength:100});return this.historyCache.set(e,n),n}index(e,n){const s=e+":"+n;if(this.indexCache.has(s))return this.indexCache.get(s);const r=this.__uncached_createIndex(e,n);return this.indexCache.set(s,r),r}__uncached_createIndex(e,n){const s=this.filterHistory(e),r=n.split("\\"),i=r.length>1?a=>this.getNestedValue(a,r):a=>a[n],o=()=>{s.get();const a=new Map;for(const c of this.recordMap.values())if(c.typeName===e){const l=i(c);l!==void 0&&(a.has(l)||a.set(l,new Set),a.get(l).add(c.id))}return a};return K("index:"+e+":"+n,(a,c)=>{if(Xi(a))return o();const l=s.getDiffSince(c);if(l===Ss)return o();const u=new Map,d=(x,y)=>{let m=u.get(x);m||(m=new sd(a.get(x)??new Set)),m.add(y),u.set(x,m)},p=(x,y)=>{let m=u.get(x);m||(m=new sd(a.get(x)??new Set)),m.remove(y),u.set(x,m)};for(const x of l){for(const y of _t(x.added))if(y.typeName===e){const m=i(y);m!==void 0&&d(m,y.id)}for(const[y,m]of _t(x.updated))if(m.typeName===e){const S=i(y),w=i(m);S!==w&&(S!==void 0&&p(S,m.id),w!==void 0&&d(w,m.id))}for(const y of _t(x.removed))if(y.typeName===e){const m=i(y);m!==void 0&&p(m,y.id)}}let f,g;for(const[x,y]of u){const m=y.get();m&&(f||(f=new Map(a)),g||(g=new Map),m.value.size===0?f.delete(x):f.set(x,m.value),g.set(x,m.diff))}return f&&g?Ga(f,g):a},{historyLength:100})}record(e,n=()=>({}),s="record:"+e+(n?":"+n.toString():"")){const r=this.ids(e,n,s);return K(s,()=>{for(const i of r.get())return this.recordMap.get(i)})}records(e,n=()=>({}),s="records:"+e+(n?":"+n.toString():"")){const r=this.ids(e,n,"ids:"+s);return K(s,()=>Array.from(r.get(),i=>this.recordMap.get(i)),{isEqual:ud})}ids(e,n=()=>({}),s="ids:"+e+(n?":"+n.toString():"")){const r=this.filterHistory(e),i=()=>{r.get();const c=n();return Object.keys(c).length===0?this.getAllIdsForType(e):Xb(this,e,c)},o=c=>{const l=i(),u=Gj(c,l);return u?Ga(l,u):c},a=K("ids_query:"+s,n,{isEqual:xr});return K("query:"+s,(c,l)=>{const u=a.get();if(Xi(c))return i();if(l<a.lastChangedEpoch)return o(c);const d=r.getDiffSince(l);if(d===Ss)return o(c);const p=new sd(c);for(const g of d){for(const x of _t(g.added))x.typeName===e&&Sg(u,x)&&p.add(x.id);for(const[x,y]of _t(g.updated))y.typeName===e&&(Sg(u,y)?p.add(y.id):p.remove(y.id));for(const x of _t(g.removed))x.typeName===e&&p.remove(x.id)}const f=p.get();return f?Ga(f.value,f.diff):c},{historyLength:50})}exec(e,n){const s=Xb(this,e,n);return s.size===0?Ct:Array.from(s,r=>this.recordMap.get(r))}}class Vj{constructor(e){this.store=e}_beforeCreateHandlers={};_afterCreateHandlers={};_beforeChangeHandlers={};_afterChangeHandlers={};_beforeDeleteHandlers={};_afterDeleteHandlers={};_operationCompleteHandlers=[];_isEnabled=!0;isEnabled(){return this._isEnabled}setIsEnabled(e){this._isEnabled=e}handleBeforeCreate(e,n){if(!this._isEnabled)return e;const s=this._beforeCreateHandlers[e.typeName];if(s){let r=e;for(const i of s)r=i(r,n);return r}return e}handleAfterCreate(e,n){if(!this._isEnabled)return;const s=this._afterCreateHandlers[e.typeName];if(s)for(const r of s)r(e,n)}handleBeforeChange(e,n,s){if(!this._isEnabled)return n;const r=this._beforeChangeHandlers[n.typeName];if(r){let i=n;for(const o of r)i=o(e,i,s);return i}return n}handleAfterChange(e,n,s){if(!this._isEnabled)return;const r=this._afterChangeHandlers[n.typeName];if(r)for(const i of r)i(e,n,s)}handleBeforeDelete(e,n){if(!this._isEnabled)return!0;const s=this._beforeDeleteHandlers[e.typeName];if(s){for(const r of s)if(r(e,n)===!1)return!1}return!0}handleAfterDelete(e,n){if(!this._isEnabled)return;const s=this._afterDeleteHandlers[e.typeName];if(s)for(const r of s)r(e,n)}handleOperationComplete(e){if(this._isEnabled)for(const n of this._operationCompleteHandlers)n(e)}register(e){const n=[];for(const[s,r]of Object.entries(e))r?.beforeCreate&&n.push(this.registerBeforeCreateHandler(s,r.beforeCreate)),r?.afterCreate&&n.push(this.registerAfterCreateHandler(s,r.afterCreate)),r?.beforeChange&&n.push(this.registerBeforeChangeHandler(s,r.beforeChange)),r?.afterChange&&n.push(this.registerAfterChangeHandler(s,r.afterChange)),r?.beforeDelete&&n.push(this.registerBeforeDeleteHandler(s,r.beforeDelete)),r?.afterDelete&&n.push(this.registerAfterDeleteHandler(s,r.afterDelete));return()=>{for(const s of n)s()}}registerBeforeCreateHandler(e,n){return this._beforeCreateHandlers[e]||(this._beforeCreateHandlers[e]=[]),this._beforeCreateHandlers[e].push(n),()=>Ki(this._beforeCreateHandlers[e],n)}registerAfterCreateHandler(e,n){return this._afterCreateHandlers[e]||(this._afterCreateHandlers[e]=[]),this._afterCreateHandlers[e].push(n),()=>Ki(this._afterCreateHandlers[e],n)}registerBeforeChangeHandler(e,n){return this._beforeChangeHandlers[e]||(this._beforeChangeHandlers[e]=[]),this._beforeChangeHandlers[e].push(n),()=>Ki(this._beforeChangeHandlers[e],n)}registerAfterChangeHandler(e,n){return this._afterChangeHandlers[e]||(this._afterChangeHandlers[e]=[]),this._afterChangeHandlers[e].push(n),()=>Ki(this._afterChangeHandlers[e],n)}registerBeforeDeleteHandler(e,n){return this._beforeDeleteHandlers[e]||(this._beforeDeleteHandlers[e]=[]),this._beforeDeleteHandlers[e].push(n),()=>Ki(this._beforeDeleteHandlers[e],n)}registerAfterDeleteHandler(e,n){return this._afterDeleteHandlers[e]||(this._afterDeleteHandlers[e]=[]),this._afterDeleteHandlers[e].push(n),()=>Ki(this._afterDeleteHandlers[e],n)}registerOperationCompleteHandler(e){return this._operationCompleteHandlers.push(e),()=>Ki(this._operationCompleteHandlers,e)}}function Ki(t,e){const n=t.indexOf(e);n>=0&&t.splice(n,1)}class Um{id;records;history=je("history",0,{historyLength:1e3});query;listeners=new Set;historyAccumulator=new Zj;historyReactor;cancelHistoryReactor(){}schema;props;scopedTypes;sideEffects=new Vj(this);constructor(e){const{initialData:n,schema:s,id:r}=e;this.id=r??Ge(),this.schema=s,this.props=e.props,n?this.records=new md("store",zs(n).map(([i,o])=>[i,qo(this.schema.validateRecord(this,o,"initialize",null))])):this.records=new md("store"),this.query=new Yj(this.records,this.history),this.historyReactor=rj("Store.historyReactor",()=>{this.history.get(),this._flushHistory()},{scheduleEffect:i=>this.cancelHistoryReactor=Sm(i)}),this.scopedTypes={document:new Set(_t(this.schema.types).filter(i=>i.scope==="document").map(i=>i.typeName)),session:new Set(_t(this.schema.types).filter(i=>i.scope==="session").map(i=>i.typeName)),presence:new Set(_t(this.schema.types).filter(i=>i.scope==="presence").map(i=>i.typeName))}}_flushHistory(){if(this.historyAccumulator.hasChanges()){const e=this.historyAccumulator.flush();for(const{changes:n,source:s}of e){let r=null,i=null,o=null;for(const{onHistory:a,filters:c}of this.listeners)if(!(c.source!=="all"&&c.source!==s))if(c.scope!=="all")if(c.scope==="document"){if(i??=this.filterChangesByScope(n,"document"),!i)continue;a({changes:i,source:s})}else if(c.scope==="session"){if(r??=this.filterChangesByScope(n,"session"),!r)continue;a({changes:r,source:s})}else{if(o??=this.filterChangesByScope(n,"presence"),!o)continue;a({changes:o,source:s})}else a({changes:n,source:s})}}}dispose(){this.cancelHistoryReactor()}filterChangesByScope(e,n){const s={added:cc(e.added,(r,i)=>this.scopedTypes[n].has(i.typeName)),updated:cc(e.updated,(r,i)=>this.scopedTypes[n].has(i[1].typeName)),removed:cc(e.removed,(r,i)=>this.scopedTypes[n].has(i.typeName))};return Object.keys(s.added).length===0&&Object.keys(s.updated).length===0&&Object.keys(s.removed).length===0?null:s}updateHistory(e){this.historyAccumulator.add({changes:e,source:this.isMergingRemoteChanges?"remote":"user"}),this.listeners.size===0&&this.historyAccumulator.clear(),this.history.set(this.history.get()+1,e)}validate(e){this.allRecords().forEach(n=>this.schema.validateRecord(this,n,e,null))}put(e,n){this.atomic(()=>{const s={},r={};let i,o=!1;const a=this.isMergingRemoteChanges?"remote":"user";for(let c=0,l=e.length;c<l;c++){i=e[c];const u=this.records.__unsafe__getWithoutCapture(i.id);if(u){if(i=this.sideEffects.handleBeforeChange(u,i,a),this.schema.validateRecord(this,i,n??"updateRecord",u)===u)continue;i=qo(i),this.records.set(i.id,i),o=!0,s[i.id]=[u,i],this.addDiffForAfterEvent(u,i)}else i=this.sideEffects.handleBeforeCreate(i,a),o=!0,i=this.schema.validateRecord(this,i,n??"createRecord",null),i=qo(i),r[i.id]=i,this.addDiffForAfterEvent(null,i),this.records.set(i.id,i)}o&&this.updateHistory({added:r,updated:s,removed:{}})})}remove(e){this.atomic(()=>{const n=new Set(e),s=this.isMergingRemoteChanges?"remote":"user";if(this.sideEffects.isEnabled())for(const o of e){const a=this.records.__unsafe__getWithoutCapture(o);a&&this.sideEffects.handleBeforeDelete(a,s)===!1&&n.delete(o)}const r=this.records.deleteMany(n);if(r.length===0)return;const i={};for(const[o,a]of r)i[o]=a,this.addDiffForAfterEvent(a,null);this.updateHistory({added:{},updated:{},removed:i})})}get(e){return this.records.get(e)}unsafeGetWithoutCapture(e){return this.records.__unsafe__getWithoutCapture(e)}serialize(e="document"){const n={};for(const[s,r]of this.records)(e==="all"||this.scopedTypes[e].has(r.typeName))&&(n[s]=r);return n}getStoreSnapshot(e="document"){return{store:this.serialize(e),schema:this.schema.serialize()}}migrateSnapshot(e){const n=this.schema.migrateStoreSnapshot(e);if(n.type==="error")throw new Error(`Failed to migrate snapshot: ${n.reason}`);return{store:n.value,schema:this.schema.serialize()}}loadStoreSnapshot(e){const n=this.schema.migrateStoreSnapshot(e);if(n.type==="error")throw new Error(`Failed to migrate snapshot: ${n.reason}`);const s=this.sideEffects.isEnabled();try{this.sideEffects.setIsEnabled(!1),this.atomic(()=>{this.clear(),this.put(Object.values(n.value)),this.ensureStoreIsUsable()})}finally{this.sideEffects.setIsEnabled(s)}}allRecords(){return Array.from(this.records.values())}clear(){this.remove(Array.from(this.records.keys()))}update(e,n){const s=this.unsafeGetWithoutCapture(e);if(!s){console.error(`Record ${e} not found. This is probably an error`);return}this.put([n(s)])}has(e){return this.records.has(e)}listen(e,n){this._flushHistory();const s={onHistory:e,filters:{source:n?.source??"all",scope:n?.scope??"all"}};return this.historyReactor.scheduler.isActivelyListening||(this.historyReactor.start(),this.historyReactor.scheduler.execute()),this.listeners.add(s),()=>{this.listeners.delete(s),this.listeners.size===0&&this.historyReactor.stop()}}isMergingRemoteChanges=!1;mergeRemoteChanges(e){if(this.isMergingRemoteChanges)return e();if(this._isInAtomicOp)throw new Error("Cannot merge remote changes while in atomic operation");try{this.atomic(e,!0,!0)}finally{this.ensureStoreIsUsable()}}extractingChanges(e){const n=[],s=this.historyAccumulator.addInterceptor(r=>n.push(r.changes));try{return xs(e),Nm(n)}finally{s()}}applyDiff(e,{runCallbacks:n=!0,ignoreEphemeralKeys:s=!1}={}){this.atomic(()=>{const r=_t(e.added);for(const[o,a]of _t(e.updated)){const c=this.schema.getType(a.typeName);if(s&&c.ephemeralKeySet.size){const l=this.get(a.id);if(!l){r.push(a);continue}let u=null;for(const[d,p]of Object.entries(a))c.ephemeralKeySet.has(d)||Object.is(p,Nt(l,d))||(u||(u={...l}),u[d]=p);u&&r.push(u)}else r.push(a)}const i=ac(e.removed);r.length&&this.put(r),i.length&&this.remove(i)},n)}createCache(e){const n=new dn;return{get:s=>{const r=this.records.getAtom(s);if(r)return n.get(r,()=>e(s,r)).get()}}}createComputedCache(e,n,s){return this.createCache((r,i)=>{const o=s?.areRecordsEqual?K(`${e}:${r}:isEqual`,()=>i.get(),{isEqual:s.areRecordsEqual}):i;return K(e+":"+r,()=>n(o.get()),{isEqual:s?.areResultsEqual})})}_integrityChecker;ensureStoreIsUsable(){this.atomic(()=>{this._integrityChecker??=this.schema.createIntegrityChecker(this),this._integrityChecker?.()})}_isPossiblyCorrupted=!1;markAsPossiblyCorrupted(){this._isPossiblyCorrupted=!0}isPossiblyCorrupted(){return this._isPossiblyCorrupted}pendingAfterEvents=null;addDiffForAfterEvent(e,n){if(le(this.pendingAfterEvents,"must be in event operation"),e===n||(e&&n&&le(e.id===n.id),!e&&!n))return;const s=(e||n).id,r=this.pendingAfterEvents.get(s);r?r.after=n:this.pendingAfterEvents.set(s,{before:e,after:n})}flushAtomicCallbacks(e){let n=0,s=e?"remote":"user";for(;this.pendingAfterEvents;){const r=this.pendingAfterEvents;if(this.pendingAfterEvents=null,!!this.sideEffects.isEnabled()){if(n++,n>100)throw new Error("Maximum store update depth exceeded, bailing out");for(const{before:i,after:o}of r.values())i&&o&&i!==o&&!xr(i,o)?this.sideEffects.handleAfterChange(i,o,s):i&&!o?this.sideEffects.handleAfterDelete(i,s):!i&&o&&this.sideEffects.handleAfterCreate(o,s);this.pendingAfterEvents?s="user":this.sideEffects.handleOperationComplete(s)}}}_isInAtomicOp=!1;atomic(e,n=!0,s=!1){return xs(()=>{if(this._isInAtomicOp){this.pendingAfterEvents||(this.pendingAfterEvents=new Map);const i=this.sideEffects.isEnabled();le(!s,"cannot call mergeRemoteChanges while in atomic operation");try{return i&&!n&&this.sideEffects.setIsEnabled(!1),e()}finally{this.sideEffects.setIsEnabled(i)}}this.pendingAfterEvents=new Map;const r=this.sideEffects.isEnabled();this.sideEffects.setIsEnabled(n??r),this._isInAtomicOp=!0,s&&(this.isMergingRemoteChanges=!0);try{const i=e();return this.isMergingRemoteChanges=!1,this.flushAtomicCallbacks(s),i}finally{this.pendingAfterEvents=null,this.sideEffects.setIsEnabled(r),this._isInAtomicOp=!1,this.isMergingRemoteChanges=!1}})}addHistoryInterceptor(e){return this.historyAccumulator.addInterceptor(n=>e(n,this.isMergingRemoteChanges?"remote":"user"))}}function Xj(t){if(t.length===0)return[];const e=[];let n=[t[0]],s;for(let r=1,i=t.length;r<i;r++)s=t[r],n[0].source!==s.source&&(e.push(n),n=[]),n.push(s);return e.push(n),qo(e.map(r=>({source:r[0].source,changes:Nm(r.map(i=>i.changes))})))}class Zj{_history=[];_interceptors=new Set;addInterceptor(e){return this._interceptors.add(e),()=>{this._interceptors.delete(e)}}add(e){this._history.push(e);for(const n of this._interceptors)n(e)}flush(){const e=Xj(this._history);return this._history=[],e}clear(){this._history=[]}hasChanges(){return this._history.length>0}}function su(t,e,n){const s=new dn;return{get(r,i){return s.get(r,()=>(r instanceof Um?r:r.store).createComputedCache(t,c=>e(r,c),n)).get(i)}}}function Jj(t){if(t.schemaVersion>2||t.schemaVersion<1)return Bs.err("Bad schema version");if(t.schemaVersion===2)return Bs.ok(t);const e={schemaVersion:2,sequences:{"com.tldraw.store":t.storeVersion}};for(const[n,s]of Object.entries(t.recordVersions))if(e.sequences[`com.tldraw.${n}`]=s.version,"subTypeKey"in s)for(const[r,i]of Object.entries(s.subTypeVersions))e.sequences[`com.tldraw.${n}.${r}`]=i;return Bs.ok(e)}class Hm{constructor(e,n){this.types=e,this.options=n;for(const r of n.migrations??[])le(!this.migrations[r.sequenceId],`Duplicate migration sequenceId ${r.sequenceId}`),k1(r),this.migrations[r.sequenceId]=r;const s=Object.values(this.migrations).flatMap(r=>r.sequence);this.sortedMigrations=Wj(s);for(const r of this.sortedMigrations)if(r.dependsOn?.length)for(const i of r.dependsOn){const o=s.find(a=>a.id===i);le(o,`Migration '${r.id}' depends on missing migration '${i}'`)}}static create(e,n){return new Hm(e,n??{})}migrations={};sortedMigrations;migrationCache=new WeakMap;validateRecord(e,n,s,r){try{const i=Nt(this.types,n.typeName);if(!i)throw new Error(`Missing definition for record type ${n.typeName}`);return i.validate(n,r??void 0)}catch(i){if(this.options.onValidationFailure)return this.options.onValidationFailure({store:e,record:n,phase:s,recordBefore:r,error:i});throw i}}getMigrationsSince(e){const n=this.migrationCache.get(e);if(n)return n;const s=Jj(e);if(!s.ok)return this.migrationCache.set(e,s),s;const r=s.value,i=new Set(Object.keys(r.sequences).filter(c=>this.migrations[c]));for(const c in this.migrations)r.sequences[c]===void 0&&this.migrations[c].retroactive&&i.add(c);if(i.size===0){const c=Bs.ok([]);return this.migrationCache.set(e,c),c}const o=new Set;for(const c of i){const l=r.sequences[c];if(typeof l!="number"&&this.migrations[c].retroactive||l===0){for(const p of this.migrations[c].sequence)o.add(p.id);continue}const u=`${c}/${l}`,d=this.migrations[c].sequence.findIndex(p=>p.id===u);if(d===-1){const p=Bs.err("Incompatible schema?");return this.migrationCache.set(e,p),p}for(const p of this.migrations[c].sequence.slice(d+1))o.add(p.id)}const a=Bs.ok(this.sortedMigrations.filter(({id:c})=>o.has(c)));return this.migrationCache.set(e,a),a}migratePersistedRecord(e,n,s="up"){const r=this.getMigrationsSince(n);if(!r.ok)return console.error("Error migrating record",r.error),{type:"error",reason:xi.MigrationError};let i=r.value;if(i.length===0)return{type:"success",value:e};if(!i.every(o=>o.scope==="record"))return{type:"error",reason:s==="down"?xi.TargetVersionTooOld:xi.TargetVersionTooNew};if(s==="down"){if(!i.every(o=>o.scope==="record"&&o.down))return{type:"error",reason:xi.TargetVersionTooOld};i=i.slice().reverse()}e=wt(e);try{for(const o of i){if(o.scope==="store")throw new Error;if(o.scope==="storage")throw new Error;if(!(o.filter?o.filter(e):!0))continue;const c=o[s](e);c&&(e=wt(c))}}catch(o){return console.error("Error migrating record",o),{type:"error",reason:xi.MigrationError}}return{type:"success",value:e}}migrateStorage(e){const n=e.getSchema();le(n,"Schema is missing.");const s=this.getMigrationsSince(n);if(!s.ok)throw console.error("Error migrating store",s.error),new Error(s.error);const r=s.value;if(r.length!==0){e.setSchema(this.serialize());for(const i of r)if(i.scope==="record"){const o=[];for(const[a,c]of e.entries()){if(!(i.filter?i.filter(c):!0))continue;const u=wt(c),d=i.up(u)??u;xr(d,c)||o.push([a,d])}for(const[a,c]of o)e.set(a,c)}else if(i.scope==="store"){const o=Object.fromEntries(e.entries());let a=wt(o);a=i.up(a)??a;for(const[c,l]of Object.entries(a))l&&(xr(l,o[c])||e.set(c,l));for(const c of Object.keys(o))a[c]||e.delete(c)}else i.scope==="storage"?i.up(e):Ke(i);for(const[i,o]of e.entries())this.getType(o.typeName).scope!=="document"&&e.delete(i)}}migrateStoreSnapshot(e,n){const s=this.getMigrationsSince(e.schema);if(!s.ok)return console.error("Error migrating store",s.error),{type:"error",reason:xi.MigrationError};if(s.value.length===0)return{type:"success",value:e.store};const i=Object.assign(new Map(zs(e.store).map(qo)),{getSchema:()=>e.schema,setSchema:o=>{}});try{if(this.migrateStorage(i),n?.mutateInputStore){for(const[o,a]of i.entries())e.store[o]=a;for(const o of Object.keys(e.store))i.has(o)||delete e.store[o];return{type:"success",value:e.store}}else return{type:"success",value:Object.fromEntries(i.entries())}}catch(o){return console.error("Error migrating store",o),{type:"error",reason:xi.MigrationError}}}createIntegrityChecker(e){return this.options.createIntegrityChecker?.(e)??void 0}serialize(){return{schemaVersion:2,sequences:Object.fromEntries(Object.values(this.migrations).map(({sequenceId:e,sequence:n})=>[e,n.length?Sd(n.at(-1).id).version:0]))}}serializeEarliestVersion(){return{schemaVersion:2,sequences:Object.fromEntries(Object.values(this.migrations).map(({sequenceId:e})=>[e,0]))}}getType(e){const n=Nt(this.types,e);return le(n,"record type does not exists"),n}}Di("@tldraw/store","4.3.1","esm");function Qj(t){if(!t.length)return null;let e="";for(const n of t)typeof n=="number"?e+=`.${n}`:n.startsWith("(")?e.endsWith(")")?e=`${e.slice(0,-1)}, ${n.slice(1)}`:e+=n:e+=`.${n}`;return e=e.replace(/id = [^,]+, /,"").replace(/id = [^)]+/,""),e.startsWith(".")?e.slice(1):e}class se extends Error{constructor(e,n=[]){const s=Qj(n),r=e.split(`
`).map((i,o)=>o===0?i:`  ${i}`).join(`
`);super(n?`At ${s}: ${r}`:r),this.rawMessage=e,this.path=n}name="ValidationError"}function Yo(t,e){try{return e()}catch(n){throw n instanceof se?new se(n.rawMessage,[t,...n.path]):new se(n.toString(),[t])}}function Nn(t){if(t===null)return"null";if(Array.isArray(t))return"an array";const e=typeof t;switch(e){case"bigint":case"boolean":case"function":case"number":case"string":case"symbol":return`a ${e}`;case"object":return`an ${e}`;case"undefined":return"undefined";default:Ke(e)}}class ut{constructor(e,n,s=!1){this.validationFn=e,this.validateUsingKnownGoodVersionFn=n,this.skipSameValueCheck=s}validate(e){return this.validationFn(e)}validateUsingKnownGoodVersion(e,n){return Object.is(e,n)?e:this.validateUsingKnownGoodVersionFn?this.validateUsingKnownGoodVersionFn(e,n):this.validate(n)}isValid(e){try{return this.validate(e),!0}catch{return!1}}nullable(){return oD(this)}optional(){return L1(this)}refine(e){return new ut(n=>e(this.validate(n)),(n,s)=>{const r=this.validateUsingKnownGoodVersion(n,s);return Object.is(n,r)?n:e(r)},!0)}check(e,n){return typeof e=="string"?this.refine(s=>(Yo(`(check ${e})`,()=>n(s)),s)):this.refine(s=>(e(s),s))}}class eD extends ut{constructor(e){super(n=>{const s=Zb.validate(n);for(let r=0;r<s.length;r++)try{e.validate(s[r])}catch(i){throw i instanceof se?new se(i.rawMessage,[r,...i.path]):new se(i.toString(),[r])}return s},(n,s)=>{if(Object.is(n,s))return n;if(!e.validateUsingKnownGoodVersion)return this.validate(s);const r=Zb.validate(s);let i=n.length!==r.length;for(let o=0;o<r.length;o++){const a=r[o];if(o>=n.length){i=!0;try{e.validate(a)}catch(c){throw c instanceof se?new se(c.rawMessage,[o,...c.path]):new se(c.toString(),[o])}continue}if(!Object.is(n[o],a))try{const c=e.validateUsingKnownGoodVersion(n[o],a);Object.is(c,n[o])||(i=!0)}catch(c){throw c instanceof se?new se(c.rawMessage,[o,...c.path]):new se(c.toString(),[o])}}return i?s:n}),this.itemValidator=e}nonEmpty(){return this.check(e=>{if(e.length===0)throw new se("Expected a non-empty array")})}lengthGreaterThan1(){return this.check(e=>{if(e.length<=1)throw new se("Expected an array with length greater than 1")})}}class bd extends ut{constructor(e,n=!1){super(s=>{if(typeof s!="object"||s===null)throw new se(`Expected object, got ${Nn(s)}`);for(const r in e){if(!Ut(e,r))continue;const i=e[r];try{i.validate(Nt(s,r))}catch(o){throw o instanceof se?new se(o.rawMessage,[r,...o.path]):new se(o.toString(),[r])}}if(!n){for(const r of Object.keys(s))if(!Ut(e,r))throw new se("Unexpected property",[r])}return s},(s,r)=>{if(Object.is(s,r))return s;if(typeof r!="object"||r===null)throw new se(`Expected object, got ${Nn(r)}`);let i=!1;for(const o in e){if(!Ut(e,o))continue;const a=e[o],c=Nt(s,o),l=Nt(r,o);if(!Object.is(c,l))try{const u=a,d=u.validateUsingKnownGoodVersion?u.validateUsingKnownGoodVersion(c,l):u.validate(l);Object.is(d,c)||(i=!0)}catch(u){throw u instanceof se?new se(u.rawMessage,[o,...u.path]):new se(u.toString(),[o])}}if(!n){for(const o of Object.keys(r))if(!Ut(e,o))throw new se("Unexpected property",[o])}for(const o of Object.keys(s))if(!Ut(r,o)){i=!0;break}return i?r:s}),this.config=e,this.shouldAllowUnknownProperties=n}allowUnknownProperties(){return new bd(this.config,!0)}extend(e){return new bd({...this.config,...e})}}class ru extends ut{constructor(e,n,s,r){super(i=>{this.expectObject(i);const{matchingSchema:o,variant:a}=this.getMatchingSchemaAndVariant(i);return o===void 0?this.unknownValueValidation(i,a):Yo(`(${e} = ${a})`,()=>o.validate(i))},(i,o)=>{this.expectObject(o),this.expectObject(i);const{matchingSchema:a,variant:c}=this.getMatchingSchemaAndVariant(o);return a===void 0?this.unknownValueValidation(o,c):Nt(i,e)!==Nt(o,e)?Yo(`(${e} = ${c})`,()=>a.validate(o)):Yo(`(${e} = ${c})`,()=>a.validateUsingKnownGoodVersion?a.validateUsingKnownGoodVersion(i,o):a.validate(o))}),this.key=e,this.config=n,this.unknownValueValidation=s,this.useNumberKeys=r}expectObject(e){if(typeof e!="object"||e===null)throw new se(`Expected an object, got ${Nn(e)}`,[])}getMatchingSchemaAndVariant(e){const n=Nt(e,this.key);if(!this.useNumberKeys&&typeof n!="string")throw new se(`Expected a string for key "${this.key}", got ${Nn(n)}`);if(this.useNumberKeys){const r=Number(n);if(r-r!==0)throw new se(`Expected a number for key "${this.key}", got "${n}"`)}return{matchingSchema:Ut(this.config,n)?this.config[n]:void 0,variant:n}}validateUnknownVariants(e){return new ru(this.key,this.config,e,this.useNumberKeys)}}class tD extends ut{constructor(e,n){super(s=>{if(typeof s!="object"||s===null)throw new se(`Expected object, got ${Nn(s)}`);for(const r in s)if(Ut(s,r))try{e.validate(r),n.validate(s[r])}catch(i){throw i instanceof se?new se(i.rawMessage,[r,...i.path]):new se(i.toString(),[r])}return s},(s,r)=>{if(typeof r!="object"||r===null)throw new se(`Expected object, got ${Nn(r)}`);const i=r;let o=!1,a=0;for(const c in i){if(!Ut(i,c))continue;a++;const l=i[c];if(!Ut(s,c)){o=!0;try{e.validate(c),n.validate(l)}catch(d){throw d instanceof se?new se(d.rawMessage,[c,...d.path]):new se(d.toString(),[c])}continue}const u=s[c];if(!Object.is(u,l))try{const d=n.validateUsingKnownGoodVersion?n.validateUsingKnownGoodVersion(u,l):n.validate(l);Object.is(d,u)||(o=!0)}catch(d){throw d instanceof se?new se(d.rawMessage,[c,...d.path]):new se(d.toString(),[c])}}if(!o){let c=0;for(const l in s)Ut(s,l)&&c++;c!==a&&(o=!0)}return o?r:s}),this.keyValidator=e,this.valueValidator=n}}function D1(t){return new ut(e=>{if(typeof e!==t)throw new se(`Expected ${t}, got ${Nn(e)}`);return e})}const nD=new ut(t=>t),O1=new ut(t=>t),De=D1("string"),Te=new ut(t=>{if(Number.isFinite(t))return t;throw typeof t!="number"?new se(`Expected number, got ${Nn(t)}`):t!==t?new se("Expected a number, got NaN"):new se(`Expected a finite number, got ${t}`)}),wd=new ut(t=>{if(Number.isFinite(t)&&t>=0)return t;throw typeof t!="number"?new se(`Expected number, got ${Nn(t)}`):t!==t?new se("Expected a number, got NaN"):t<0?new se(`Expected a positive number, got ${t}`):new se(`Expected a finite number, got ${t}`)}),jt=new ut(t=>{if(Number.isFinite(t)&&t>0)return t;throw typeof t!="number"?new se(`Expected number, got ${Nn(t)}`):t!==t?new se("Expected a number, got NaN"):t<=0?new se(`Expected a non-zero positive number, got ${t}`):new se(`Expected a finite number, got ${t}`)}),vd=new ut(t=>{if(Number.isFinite(t)&&t!==0)return t;throw typeof t!="number"?new se(`Expected number, got ${Nn(t)}`):t!==t?new se("Expected a number, got NaN"):t===0?new se("Expected a non-zero number, got 0"):new se(`Expected a finite number, got ${t}`)}),sD=new ut(t=>{if(Number.isFinite(t)&&t>=0&&t<=1)return t;throw typeof t!="number"?new se(`Expected number, got ${Nn(t)}`):t!==t?new se("Expected a number, got NaN"):new se(`Expected a number between 0 and 1, got ${t}`)}),rd=new ut(t=>{if(Number.isInteger(t)&&t>=0)return t;throw typeof t!="number"?new se(`Expected number, got ${Nn(t)}`):t!==t?new se("Expected a number, got NaN"):t-t!==0?new se(`Expected a finite number, got ${t}`):t<0?new se(`Expected a positive integer, got ${t}`):new se(`Expected an integer, got ${t}`)}),rD=new ut(t=>{if(Number.isInteger(t)&&t>0)return t;throw typeof t!="number"?new se(`Expected number, got ${Nn(t)}`):t!==t?new se("Expected a number, got NaN"):t-t!==0?new se(`Expected a finite number, got ${t}`):t<=0?new se(`Expected a non-zero positive integer, got ${t}`):new se(`Expected an integer, got ${t}`)}),Le=D1("boolean");function In(t){return new ut(e=>{if(e!==t)throw new se(`Expected ${t}, got ${JSON.stringify(e)}`);return t})}const Zb=new ut(t=>{if(!Array.isArray(t))throw new se(`Expected an array, got ${Nn(t)}`);return t});function on(t){return new eD(t)}function Ne(t){return new bd(t)}function xg(t){return typeof t=="object"&&t!==null&&(Object.getPrototypeOf(t)===Object.prototype||Object.getPrototypeOf(t)===null||Object.getPrototypeOf(t)===R0)}function bg(t){return t===null||typeof t=="number"||typeof t=="string"||typeof t=="boolean"?!0:Array.isArray(t)?t.every(bg):xg(t)?Object.values(t).every(bg):!1}const an=new ut(t=>{if(bg(t))return t;throw new se(`Expected json serializable value, got ${typeof t}`)},(t,e)=>{if(Array.isArray(t)&&Array.isArray(e)){let n=t.length!==e.length;for(let s=0;s<e.length;s++){if(s>=t.length){n=!0,an.validate(e[s]);continue}const r=t[s],i=e[s];if(Object.is(r,i))continue;const o=an.validateUsingKnownGoodVersion(r,i);Object.is(o,r)||(n=!0)}return n?e:t}else if(xg(t)&&xg(e)){let n=!1;for(const s of Object.keys(e)){if(!Ut(t,s)){n=!0,an.validate(e[s]);continue}const r=t[s],i=e[s];if(Object.is(r,i))continue;const o=an.validateUsingKnownGoodVersion(r,i);Object.is(o,r)||(n=!0)}for(const s of Object.keys(t))if(!Ut(e,s)){n=!0;break}return n?e:t}else return an.validate(e)});function Pd(t,e){return new tD(t,e)}function Km(t,e){return new ru(t,e,(n,s)=>{throw new se(`Expected one of ${Object.keys(e).map(r=>JSON.stringify(r)).join(" or ")}, got ${JSON.stringify(s)}`,[t])},!1)}function iD(t,e){return new ru(t,e,(n,s)=>{throw new se(`Expected one of ${Object.keys(e).map(r=>JSON.stringify(r)).join(" or ")}, got ${JSON.stringify(s)}`,[t])},!0)}function Pr(t,e){return new ut(n=>Yo(t,()=>e.validate(n)),(n,s)=>Yo(t,()=>e.validateUsingKnownGoodVersion?e.validateUsingKnownGoodVersion(n,s):e.validate(s)))}function iu(t){return new ut(e=>{if(!t.has(e)){const n=Array.from(t,s=>JSON.stringify(s)).join(" or ");throw new se(`Expected ${n}, got ${e}`)}return e})}function L1(t){return new ut(e=>{if(e!==void 0)return t.validate(e)},(e,n)=>{if(n!==void 0)return t.validateUsingKnownGoodVersion&&e!==void 0?t.validateUsingKnownGoodVersion(e,n):t.validate(n)},t instanceof ut&&t.skipSameValueCheck)}function oD(t){return new ut(e=>e===null?null:t.validate(e),(e,n)=>n===null?null:t.validateUsingKnownGoodVersion&&e!==null?t.validateUsingKnownGoodVersion(e,n):t.validate(n),t instanceof ut&&t.skipSameValueCheck)}function to(...t){return iu(new Set(t))}function Wm(t){try{return new URL(t)}catch{if(t.startsWith("/")||t.startsWith("./"))try{return new URL(t,"http://example.com")}catch{throw new se(`Expected a valid url, got ${JSON.stringify(t)}`)}throw new se(`Expected a valid url, got ${JSON.stringify(t)}`)}}const aD=new Set(["http:","https:","mailto:"]),ws=De.check(t=>{if(t==="")return;const e=Wm(t);if(!aD.has(e.protocol.toLowerCase()))throw new se(`Expected a valid url, got ${JSON.stringify(t)} (invalid protocol)`)}),cD=new Set(["http:","https:","data:","asset:"]),no=De.check(t=>{if(t==="")return;const e=Wm(t);if(!cD.has(e.protocol.toLowerCase()))throw new se(`Expected a valid url, got ${JSON.stringify(t)} (invalid protocol)`)});De.check(t=>{if(t==="")return;if(!Wm(t).protocol.toLowerCase().match(/^https?:$/))throw new se(`Expected a valid url, got ${JSON.stringify(t)} (invalid protocol)`)});const qm=De.refine(t=>{try{return WA(t),t}catch{throw new se(`Expected an index key, got ${JSON.stringify(t)}`)}});Di("@tldraw/validate","4.3.1","esm");function bs(t){return De.refine(e=>{if(!e.startsWith(`${t}:`))throw new Error(`${t} ID must start with "${t}:"`);return e})}const ou=bs("asset");function Gm(t,e){return Ne({id:ou,typeName:In("asset"),type:In(t),props:e,meta:an})}const na=Ne({x:Te,y:Te,z:Te.optional()}),dc=Ne({x:Te,y:Te,w:Te,h:Te}),R1=sD,lD=De.refine(t=>{if(!t.startsWith("page:")&&!t.startsWith("shape:"))throw new Error('Parent ID must start with "page:" or "shape:"');return t}),Ds=bs("shape");function dD(t,e,n){return Ne({id:Ds,typeName:In("shape"),x:Te,y:Te,rotation:Te,index:qm,parentId:lD,type:In(t),isLocked:Le,opacity:R1,props:e?Ne(e):an,meta:n?Ne(n):an})}const uD=bs("binding");function hD(t,e,n){return Ne({id:uD,typeName:In("binding"),type:In(t),fromId:Ds,toId:Ds,props:e?Ne(e):an,meta:n?Ne(n):an})}as("com.tldraw.binding",{});Is({sequenceId:"com.tldraw.binding",recordType:"binding",sequence:[]});function Zi(t){return`binding:${Ge()}`}function pD(t,e){return Oi(e,(n,s)=>`com.tldraw.binding.${t}/${s}`)}function fD(t){return vr("binding",{scope:"document",validator:Pr("binding",Km("type",Oi(t,(e,{props:n,meta:s})=>hD(e,n,s))))}).withDefaultProperties(()=>({meta:{}}))}const Wc=Ne({type:De,content:on(nD),attrs:O1.optional()});function ln(t){return{type:"doc",content:t.split(`
`).map(s=>s?{type:"paragraph",content:[{type:"text",text:s}]}:{type:"paragraph"})}}class Jt{constructor(e,n,s){this.id=e,this.defaultValue=n,this.type=s}static define(e,n){const{defaultValue:s,type:r=O1}=n;return new Jt(e,s,r)}static defineEnum(e,n){const{defaultValue:s,values:r}=n;return new gD(e,s,r)}setDefaultValue(e){this.defaultValue=e}validate(e){return this.type.validate(e)}validateUsingKnownGoodVersion(e,n){return this.type.validateUsingKnownGoodVersion?this.type.validateUsingKnownGoodVersion(e,n):this.validate(n)}}class gD extends Jt{constructor(e,n,s){super(e,n,to(...s)),this.values=s}}const Pl=as("com.tldraw.shape",{AddIsLocked:1,HoistOpacity:2,AddMeta:3,AddWhite:4}),mD=Is({sequenceId:"com.tldraw.shape",recordType:"shape",sequence:[{id:Pl.AddIsLocked,up:t=>{t.isLocked=!1},down:t=>{delete t.isLocked}},{id:Pl.HoistOpacity,up:t=>{t.opacity=Number(t.props.opacity??"1"),delete t.props.opacity},down:t=>{const e=t.opacity;delete t.opacity,t.props.opacity=e<.175?"0.1":e<.375?"0.25":e<.625?"0.5":e<.875?"0.75":"1"}},{id:Pl.AddMeta,up:t=>{t.meta={}}},{id:Pl.AddWhite,up:t=>{},down:t=>{t.props.color==="white"&&(t.props.color="black")}}]});function zo(t){return t?t.typeName==="shape":!1}function On(t){return t?t.startsWith("shape:"):!1}function tt(t){return`shape:${t??Ge()}`}function F1(t){const e=new Map;for(const[n,s]of Object.entries(t))if(s instanceof Jt){if(e.has(s))throw new Error(`Duplicate style prop ${s.id}. Each style prop can only be used once within a shape.`);e.set(s,n)}return e}function $s(t,e){return Oi(e,(n,s)=>`com.tldraw.shape.${t}/${s}`)}function yD(t){return vr("shape",{scope:"document",validator:Pr("shape",Km("type",Oi(t,(e,{props:n,meta:s})=>dD(e,n,s))))}).withDefaultProperties(()=>({x:0,y:0,rotation:0,isLocked:!1,opacity:1,meta:{}}))}function Jb(t,e){const n=[];for(const[s,{migrations:r}]of Object.entries(e)){const i=`com.tldraw.${t}.${s}`;r?"sequenceId"in r?(le(i===r.sequenceId,`sequenceId mismatch for ${s} ${nu} migrations. Expected '${i}', got '${r.sequenceId}'`),n.push(r)):"sequence"in r?n.push(Go({sequenceId:i,retroactive:!0,sequence:r.sequence.map(o=>"id"in o?B1(t,s,o):o)})):n.push(Go({sequenceId:i,retroactive:!0,sequence:Object.keys(r.migrators).map(o=>Number(o)).sort((o,a)=>o-a).map(o=>({id:`${i}/${o}`,scope:"record",filter:a=>a.typeName===t&&a.type===s,up:a=>{const c=r.migrators[o].up(a);if(c)return c},down:a=>{const c=r.migrators[o].down(a);if(c)return c}}))})):n.push(Go({sequenceId:i,retroactive:!0,sequence:[]}))}return n}function B1(t,e,n){return{id:n.id,dependsOn:n.dependsOn,scope:"record",filter:s=>s.typeName===t&&s.type===e,up:s=>{const r=n.up(s.props);r&&(s.props=r)},down:typeof n.down=="function"?s=>{const r=n.down(s.props);r&&(s.props=r)}:void 0}}const Ym=["black","grey","light-violet","violet","blue","light-blue","yellow","orange","green","light-green","light-red","red","white"],Id={lightMode:{id:"light",text:"#000000",background:"#f9fafb",solid:"#fcfffe",black:{solid:"#1d1d1d",fill:"#1d1d1d",linedFill:"#363636",frameHeadingStroke:"#717171",frameHeadingFill:"#ffffff",frameStroke:"#717171",frameFill:"#ffffff",frameText:"#000000",noteFill:"#FCE19C",noteText:"#000000",semi:"#e8e8e8",pattern:"#494949",highlightSrgb:"#fddd00",highlightP3:"color(display-p3 0.972 0.8205 0.05)"},blue:{solid:"#4465e9",fill:"#4465e9",linedFill:"#6580ec",frameHeadingStroke:"#6681ec",frameHeadingFill:"#f9fafe",frameStroke:"#6681ec",frameFill:"#f9fafe",frameText:"#000000",noteFill:"#8AA3FF",noteText:"#000000",semi:"#dce1f8",pattern:"#6681ee",highlightSrgb:"#10acff",highlightP3:"color(display-p3 0.308 0.6632 0.9996)"},green:{solid:"#099268",fill:"#099268",linedFill:"#0bad7c",frameHeadingStroke:"#37a684",frameHeadingFill:"#f8fcfa",frameStroke:"#37a684",frameFill:"#f8fcfa",frameText:"#000000",noteFill:"#6FC896",noteText:"#000000",semi:"#d3e9e3",pattern:"#39a785",highlightSrgb:"#00ffc8",highlightP3:"color(display-p3 0.2536 0.984 0.7981)"},grey:{solid:"#9fa8b2",fill:"#9fa8b2",linedFill:"#bbc1c9",frameHeadingStroke:"#aaaaab",frameHeadingFill:"#fbfcfc",frameStroke:"#aaaaab",frameFill:"#fcfcfd",frameText:"#000000",noteFill:"#C0CAD3",noteText:"#000000",semi:"#eceef0",pattern:"#bcc3c9",highlightSrgb:"#cbe7f1",highlightP3:"color(display-p3 0.8163 0.9023 0.9416)"},"light-blue":{solid:"#4ba1f1",fill:"#4ba1f1",linedFill:"#7abaf5",frameHeadingStroke:"#6cb2f3",frameHeadingFill:"#f8fbfe",frameStroke:"#6cb2f3",frameFill:"#fafcff",frameText:"#000000",noteFill:"#9BC4FD",noteText:"#000000",semi:"#ddedfa",pattern:"#6fbbf8",highlightSrgb:"#00f4ff",highlightP3:"color(display-p3 0.1512 0.9414 0.9996)"},"light-green":{solid:"#4cb05e",fill:"#4cb05e",linedFill:"#7ec88c",frameHeadingStroke:"#6dbe7c",frameHeadingFill:"#f8fcf9",frameStroke:"#6dbe7c",frameFill:"#fafdfa",frameText:"#000000",noteFill:"#98D08A",noteText:"#000000",semi:"#dbf0e0",pattern:"#65cb78",highlightSrgb:"#65f641",highlightP3:"color(display-p3 0.563 0.9495 0.3857)"},"light-red":{solid:"#f87777",fill:"#f87777",linedFill:"#f99a9a",frameHeadingStroke:"#f89090",frameHeadingFill:"#fffafa",frameStroke:"#f89090",frameFill:"#fffbfb",frameText:"#000000",noteFill:"#F7A5A1",noteText:"#000000",semi:"#f4dadb",pattern:"#fe9e9e",highlightSrgb:"#ff7fa3",highlightP3:"color(display-p3 0.9988 0.5301 0.6397)"},"light-violet":{solid:"#e085f4",fill:"#e085f4",linedFill:"#e9abf7",frameHeadingStroke:"#e59bf5",frameHeadingFill:"#fefaff",frameStroke:"#e59bf5",frameFill:"#fefbff",frameText:"#000000",noteFill:"#DFB0F9",noteText:"#000000",semi:"#f5eafa",pattern:"#e9acf8",highlightSrgb:"#ff88ff",highlightP3:"color(display-p3 0.9676 0.5652 0.9999)"},orange:{solid:"#e16919",fill:"#e16919",linedFill:"#ea8643",frameHeadingStroke:"#e68544",frameHeadingFill:"#fef9f6",frameStroke:"#e68544",frameFill:"#fef9f6",frameText:"#000000",noteFill:"#FAA475",noteText:"#000000",semi:"#f8e2d4",pattern:"#f78438",highlightSrgb:"#ffa500",highlightP3:"color(display-p3 0.9988 0.6905 0.266)"},red:{solid:"#e03131",fill:"#e03131",linedFill:"#e75f5f",frameHeadingStroke:"#e55757",frameHeadingFill:"#fef7f7",frameStroke:"#e55757",frameFill:"#fef9f9",frameText:"#000000",noteFill:"#FC8282",noteText:"#000000",semi:"#f4dadb",pattern:"#e55959",highlightSrgb:"#ff636e",highlightP3:"color(display-p3 0.9992 0.4376 0.45)"},violet:{solid:"#ae3ec9",fill:"#ae3ec9",linedFill:"#be68d4",frameHeadingStroke:"#bc62d3",frameHeadingFill:"#fcf7fd",frameStroke:"#bc62d3",frameFill:"#fdf9fd",frameText:"#000000",noteFill:"#DB91FD",noteText:"#000000",semi:"#ecdcf2",pattern:"#bd63d3",highlightSrgb:"#c77cff",highlightP3:"color(display-p3 0.7469 0.5089 0.9995)"},yellow:{solid:"#f1ac4b",fill:"#f1ac4b",linedFill:"#f5c27a",frameHeadingStroke:"#f3bb6c",frameHeadingFill:"#fefcf8",frameStroke:"#f3bb6c",frameFill:"#fffdfa",frameText:"#000000",noteFill:"#FED49A",noteText:"#000000",semi:"#f9f0e6",pattern:"#fecb92",highlightSrgb:"#fddd00",highlightP3:"color(display-p3 0.972 0.8705 0.05)"},white:{solid:"#FFFFFF",fill:"#FFFFFF",linedFill:"#ffffff",semi:"#f5f5f5",pattern:"#f9f9f9",frameHeadingStroke:"#7d7d7d",frameHeadingFill:"#ffffff",frameStroke:"#7d7d7d",frameFill:"#ffffff",frameText:"#000000",noteFill:"#FFFFFF",noteText:"#000000",highlightSrgb:"#ffffff",highlightP3:"color(display-p3 1 1 1)"}},darkMode:{id:"dark",text:"hsl(210, 17%, 98%)",background:"hsl(240, 5%, 6.5%)",solid:"#010403",black:{solid:"#f2f2f2",fill:"#f2f2f2",linedFill:"#ffffff",frameHeadingStroke:"#5c5c5c",frameHeadingFill:"#252525",frameStroke:"#5c5c5c",frameFill:"#0c0c0c",frameText:"#f2f2f2",noteFill:"#2c2c2c",noteText:"#f2f2f2",semi:"#2c3036",pattern:"#989898",highlightSrgb:"#d2b700",highlightP3:"color(display-p3 0.8078 0.6225 0.0312)"},blue:{solid:"#4f72fc",fill:"#4f72fc",linedFill:"#3c5cdd",frameHeadingStroke:"#384994",frameHeadingFill:"#1C2036",frameStroke:"#384994",frameFill:"#11141f",frameText:"#f2f2f2",noteFill:"#2A3F98",noteText:"#f2f2f2",semi:"#262d40",pattern:"#3a4b9e",highlightSrgb:"#0079d2",highlightP3:"color(display-p3 0.0032 0.4655 0.7991)"},green:{solid:"#099268",fill:"#099268",linedFill:"#087856",frameHeadingStroke:"#10513C",frameHeadingFill:"#14241f",frameStroke:"#10513C",frameFill:"#0E1614",frameText:"#f2f2f2",noteFill:"#014429",noteText:"#f2f2f2",semi:"#253231",pattern:"#366a53",highlightSrgb:"#009774",highlightP3:"color(display-p3 0.0085 0.582 0.4604)"},grey:{solid:"#9398b0",fill:"#9398b0",linedFill:"#8388a5",frameHeadingStroke:"#42474D",frameHeadingFill:"#23262A",frameStroke:"#42474D",frameFill:"#151719",frameText:"#f2f2f2",noteFill:"#56595F",noteText:"#f2f2f2",semi:"#33373c",pattern:"#7c8187",highlightSrgb:"#9cb4cb",highlightP3:"color(display-p3 0.6299 0.7012 0.7856)"},"light-blue":{solid:"#4dabf7",fill:"#4dabf7",linedFill:"#2793ec",frameHeadingStroke:"#075797",frameHeadingFill:"#142839",frameStroke:"#075797",frameFill:"#0B1823",frameText:"#f2f2f2",noteFill:"#1F5495",noteText:"#f2f2f2",semi:"#2a3642",pattern:"#4d7aa9",highlightSrgb:"#00bdc8",highlightP3:"color(display-p3 0.0023 0.7259 0.7735)"},"light-green":{solid:"#40c057",fill:"#40c057",linedFill:"#37a44b",frameHeadingStroke:"#1C5427",frameHeadingFill:"#18251A",frameStroke:"#1C5427",frameFill:"#0F1911",frameText:"#f2f2f2",noteFill:"#21581D",noteText:"#f2f2f2",semi:"#2a3830",pattern:"#4e874e",highlightSrgb:"#00a000",highlightP3:"color(display-p3 0.2711 0.6172 0.0195)"},"light-red":{solid:"#ff8787",fill:"#ff8787",linedFill:"#ff6666",frameHeadingStroke:"#6f3232",frameHeadingFill:"#341818",frameStroke:"#6f3232",frameFill:"#181212",frameText:"#f2f2f2",noteFill:"#7a3333",noteText:"#f2f2f2",semi:"#3c2b2b",pattern:"#a56767",highlightSrgb:"#db005b",highlightP3:"color(display-p3 0.7849 0.0585 0.3589)"},"light-violet":{solid:"#e599f7",fill:"#e599f7",linedFill:"#dc71f4",frameHeadingStroke:"#6c367a",frameHeadingFill:"#2D2230",frameStroke:"#6c367a",frameFill:"#1C151E",frameText:"#f2f2f2",noteFill:"#762F8E",noteText:"#f2f2f2",semi:"#383442",pattern:"#9770a9",highlightSrgb:"#c400c7",highlightP3:"color(display-p3 0.7024 0.0403 0.753)"},orange:{solid:"#f76707",fill:"#f76707",linedFill:"#f54900",frameHeadingStroke:"#773a0e",frameHeadingFill:"#2f1d13",frameStroke:"#773a0e",frameFill:"#1c1512",frameText:"#f2f2f2",noteFill:"#7c3905",noteText:"#f2f2f2",semi:"#3b2e27",pattern:"#9f552d",highlightSrgb:"#d07a00",highlightP3:"color(display-p3 0.7699 0.4937 0.0085)"},red:{solid:"#e03131",fill:"#e03131",linedFill:"#c31d1d",frameHeadingStroke:"#701e1e",frameHeadingFill:"#301616",frameStroke:"#701e1e",frameFill:"#1b1313",frameText:"#f2f2f2",noteFill:"#7e201f",noteText:"#f2f2f2",semi:"#382726",pattern:"#8f3734",highlightSrgb:"#de002c",highlightP3:"color(display-p3 0.7978 0.0509 0.2035)"},violet:{solid:"#ae3ec9",fill:"#ae3ec9",linedFill:"#8f2fa7",frameHeadingStroke:"#6d1583",frameHeadingFill:"#27152e",frameStroke:"#6d1583",frameFill:"#1b0f21",frameText:"#f2f2f2",noteFill:"#5f1c70",noteText:"#f2f2f2",semi:"#342938",pattern:"#763a8b",highlightSrgb:"#9e00ee",highlightP3:"color(display-p3 0.5651 0.0079 0.8986)"},yellow:{solid:"#ffc034",fill:"#ffc034",linedFill:"#ffae00",frameHeadingStroke:"#684e12",frameHeadingFill:"#2a2113",frameStroke:"#684e12",frameFill:"#1e1911",frameText:"#f2f2f2",noteFill:"#8a5e1c",noteText:"#f2f2f2",semi:"#3b352b",pattern:"#fecb92",highlightSrgb:"#d2b700",highlightP3:"color(display-p3 0.8078 0.7225 0.0312)"},white:{solid:"#f3f3f3",fill:"#f3f3f3",linedFill:"#f3f3f3",semi:"#f5f5f5",pattern:"#f9f9f9",frameHeadingStroke:"#ffffff",frameHeadingFill:"#ffffff",frameStroke:"#ffffff",frameFill:"#ffffff",frameText:"#000000",noteFill:"#eaeaea",noteText:"#1d1d1d",highlightSrgb:"#ffffff",highlightP3:"color(display-p3 1 1 1)"}}};function Fi(t){return t.isDarkMode?Id.darkMode:Id.lightMode}const Un=Jt.defineEnum("tldraw:color",{defaultValue:"black",values:Ym}),Vm=Jt.defineEnum("tldraw:labelColor",{defaultValue:"black",values:Ym}),SD=new Set(Ym);function xD(t){return SD.has(t)}function Ue(t,e,n){return xD(e)?t[e][n]:e}const so=Jt.defineEnum("tldraw:dash",{defaultValue:"draw",values:["draw","solid","dashed","dotted"]}),Ti=Jt.defineEnum("tldraw:fill",{defaultValue:"none",values:["none","semi","solid","pattern","fill","lined-fill"]}),Ei=Jt.defineEnum("tldraw:font",{defaultValue:"draw",values:["draw","sans","serif","mono"]}),bD={draw:"'tldraw_draw', sans-serif",sans:"'tldraw_sans', sans-serif",serif:"'tldraw_serif', serif",mono:"'tldraw_mono', monospace"},br=Jt.defineEnum("tldraw:size",{defaultValue:"m",values:["s","m","l","xl"]}),wD=["arc","elbow"],_d=Jt.defineEnum("tldraw:arrowKind",{defaultValue:"arc",values:wD}),z1=["arrow","triangle","square","dot","pipe","diamond","inverted","bar","none"],wg=Jt.defineEnum("tldraw:arrowheadStart",{defaultValue:"none",values:z1}),vg=Jt.defineEnum("tldraw:arrowheadEnd",{defaultValue:"arrow",values:z1}),$1={kind:_d,labelColor:Vm,color:Un,fill:Ti,dash:so,size:br,arrowheadStart:wg,arrowheadEnd:vg,font:Ei,start:na,end:na,bend:Te,richText:Wc,labelPosition:Te,scale:jt,elbowMidPoint:Te},Gr=$s("arrow",{AddLabelColor:1,AddIsPrecise:2,AddLabelPosition:3,ExtractBindings:4,AddScale:5,AddElbow:6,AddRichText:7,AddRichTextAttrs:8});function Wi(t){return B1("shape","arrow",t)}const N1=Go({sequenceId:"com.tldraw.shape.arrow",retroactive:!1,sequence:[Wi({id:Gr.AddLabelColor,up:t=>{t.labelColor="black"},down:"retired"}),Wi({id:Gr.AddIsPrecise,up:({start:t,end:e})=>{t.type==="binding"&&(t.isPrecise=!(t.normalizedAnchor.x===.5&&t.normalizedAnchor.y===.5)),e.type==="binding"&&(e.isPrecise=!(e.normalizedAnchor.x===.5&&e.normalizedAnchor.y===.5))},down:({start:t,end:e})=>{t.type==="binding"&&(t.isPrecise||(t.normalizedAnchor={x:.5,y:.5}),delete t.isPrecise),e.type==="binding"&&(e.isPrecise||(e.normalizedAnchor={x:.5,y:.5}),delete e.isPrecise)}}),Wi({id:Gr.AddLabelPosition,up:t=>{t.labelPosition=.5},down:t=>{delete t.labelPosition}}),{id:Gr.ExtractBindings,scope:"storage",up:t=>{const e=[];for(const n of t.values()){if(n.typeName!=="shape"||n.type!=="arrow")continue;const s=n,r=wt(s),{start:i,end:o}=s.props;if(i.type==="binding"){const a=Zi(),c={typeName:"binding",id:a,type:"arrow",fromId:s.id,toId:i.boundShapeId,meta:{},props:{terminal:"start",normalizedAnchor:i.normalizedAnchor,isExact:i.isExact,isPrecise:i.isPrecise}};e.push([a,c]),r.props.start={x:0,y:0}}else delete r.props.start.type;if(o.type==="binding"){const a=Zi(),c={typeName:"binding",id:a,type:"arrow",fromId:s.id,toId:o.boundShapeId,meta:{},props:{terminal:"end",normalizedAnchor:o.normalizedAnchor,isExact:o.isExact,isPrecise:o.isPrecise}};e.push([a,c]),r.props.end={x:0,y:0}}else delete r.props.end.type;e.push([s.id,r])}for(const[n,s]of e)t.set(n,s)}},Wi({id:Gr.AddScale,up:t=>{t.scale=1},down:t=>{delete t.scale}}),Wi({id:Gr.AddElbow,up:t=>{t.kind="arc",t.elbowMidPoint=.5},down:t=>{delete t.kind,delete t.elbowMidPoint}}),Wi({id:Gr.AddRichText,up:t=>{t.richText=ln(t.text),delete t.text}}),Wi({id:Gr.AddRichTextAttrs,up:t=>{},down:t=>{t.richText&&"attrs"in t.richText&&delete t.richText.attrs}})]}),vD=to("center","edge-point","edge","none"),U1={terminal:to("start","end"),normalizedAnchor:na,isExact:Le,isPrecise:Le,snap:vD},PD=pD("arrow",{AddSnap:1}),H1={sequence:[{dependsOn:[Gr.ExtractBindings]},{id:PD.AddSnap,up:t=>{t.snap="none"},down:t=>{delete t.snap}}]},ID=Pr("camera",Ne({typeName:In("camera"),id:bs("camera"),x:Te,y:Te,z:Te,meta:an})),_D=as("com.tldraw.camera",{AddMeta:1}),CD=Is({sequenceId:"com.tldraw.camera",recordType:"camera",sequence:[{id:_D.AddMeta,up:t=>{t.meta={}}}]}),mr=vr("camera",{validator:ID,scope:"session"}).withDefaultProperties(()=>({x:0,y:0,z:1,meta:{}})),TD=new Set(["none","default","pointer","cross","grab","rotate","grabbing","resize-edge","resize-corner","text","move","ew-resize","ns-resize","nesw-resize","nwse-resize","nesw-rotate","nwse-rotate","swne-rotate","senw-rotate","zoom-in","zoom-out"]),K1=iu(TD),ED=Ne({type:K1,rotation:Te}),kD=new Set(["accent","white","black","selection-stroke","selection-fill","laser","muted-1"]),AD=iu(kD),MD=new Set(["starting","paused","active","stopping"]),W1=Ne({id:De,points:on(na),size:wd,color:AD,opacity:Te,state:iu(MD),delay:Te,shrink:Te,taper:Le}),wc=bs("page"),jD=Pr("page",Ne({typeName:In("page"),id:wc,name:De,index:qm,meta:an})),DD=as("com.tldraw.page",{AddMeta:1}),OD=Is({sequenceId:"com.tldraw.page",recordType:"page",sequence:[{id:DD.AddMeta,up:t=>{t.meta={}}}]}),zn=vr("page",{validator:jD,scope:"document"}).withDefaultProperties(()=>({meta:{}}));function nn(t){return zn.isId(t)}const LD={id:!1,typeName:!1,currentPageId:!1,opacityForNextShape:!1,stylesForNextShape:!1,followingUserId:!1,highlightedUserIds:!1,brush:!1,cursor:!1,scribbles:!1,isFocusMode:!0,isDebugMode:!0,isToolLocked:!0,exportBackground:!0,screenBounds:!0,insets:!0,zoomBrush:!1,chatMessage:!1,isChatting:!1,isPenMode:!1,isGridMode:!0,isFocused:!0,devicePixelRatio:!0,isCoarsePointer:!0,isHoveringCanvas:!1,openMenus:!1,isChangingStyle:!1,isReadonly:!0,meta:!1,duplicateProps:!1};function q1(t){return t?cc(t,e=>LD[e]):null}bs("instance");function RD(t){const e={};for(const[s,r]of t)e[s]=L1(r);const n=Pr("instance",Ne({typeName:In("instance"),id:bs("instance"),currentPageId:wc,followingUserId:De.nullable(),brush:dc.nullable(),opacityForNextShape:R1,stylesForNextShape:Ne(e),cursor:ED,scribbles:on(W1),isFocusMode:Le,isDebugMode:Le,isToolLocked:Le,exportBackground:Le,screenBounds:dc,insets:on(Le),zoomBrush:dc.nullable(),isPenMode:Le,isGridMode:Le,chatMessage:De,isChatting:Le,highlightedUserIds:on(De),isFocused:Le,devicePixelRatio:Te,isCoarsePointer:Le,isHoveringCanvas:Le.nullable(),openMenus:on(De),isChangingStyle:Le,isReadonly:Le,meta:an,duplicateProps:Ne({shapeIds:on(bs("shape")),offset:Ne({x:Te,y:Te})}).nullable()}));return vr("instance",{validator:n,scope:"session",ephemeralKeys:{currentPageId:!1,meta:!1,followingUserId:!0,opacityForNextShape:!0,stylesForNextShape:!0,brush:!0,cursor:!0,scribbles:!0,isFocusMode:!0,isDebugMode:!0,isToolLocked:!0,exportBackground:!0,screenBounds:!0,insets:!0,zoomBrush:!0,isPenMode:!0,isGridMode:!0,chatMessage:!0,isChatting:!0,highlightedUserIds:!0,isFocused:!0,devicePixelRatio:!0,isCoarsePointer:!0,isHoveringCanvas:!0,openMenus:!0,isChangingStyle:!0,isReadonly:!0,duplicateProps:!0}}).withDefaultProperties(()=>({followingUserId:null,opacityForNextShape:1,stylesForNextShape:{},brush:null,scribbles:[],cursor:{type:"default",rotation:0},isFocusMode:!1,exportBackground:!1,isDebugMode:!1,isToolLocked:!1,screenBounds:{x:0,y:0,w:1080,h:720},insets:[!1,!1,!1,!1],zoomBrush:null,isGridMode:!1,isPenMode:!1,chatMessage:"",isChatting:!1,highlightedUserIds:[],isFocused:!1,devicePixelRatio:typeof window>"u"?1:window.devicePixelRatio,isCoarsePointer:!1,isHoveringCanvas:null,openMenus:[],isChangingStyle:!1,isReadonly:!1,meta:{},duplicateProps:null}))}const dt=as("com.tldraw.instance",{AddTransparentExportBgs:1,RemoveDialog:2,AddToolLockMode:3,RemoveExtraPropsForNextShape:4,AddLabelColor:5,AddFollowingUserId:6,RemoveAlignJustify:7,AddZoom:8,AddVerticalAlign:9,AddScribbleDelay:10,RemoveUserId:11,AddIsPenModeAndIsGridMode:12,HoistOpacity:13,AddChat:14,AddHighlightedUserIds:15,ReplacePropsForNextShapeWithStylesForNextShape:16,AddMeta:17,RemoveCursorColor:18,AddLonelyProperties:19,ReadOnlyReadonly:20,AddHoveringCanvas:21,AddScribbles:22,AddInset:23,AddDuplicateProps:24,RemoveCanMoveCamera:25}),FD=Is({sequenceId:"com.tldraw.instance",recordType:"instance",sequence:[{id:dt.AddTransparentExportBgs,up:t=>({...t,exportBackground:!0})},{id:dt.RemoveDialog,up:({dialog:t,...e})=>e},{id:dt.AddToolLockMode,up:t=>({...t,isToolLocked:!1})},{id:dt.RemoveExtraPropsForNextShape,up:({propsForNextShape:t,...e})=>({...e,propsForNextShape:Object.fromEntries(Object.entries(t).filter(([n])=>["color","labelColor","dash","fill","size","font","align","verticalAlign","icon","geo","arrowheadStart","arrowheadEnd","spline"].includes(n)))})},{id:dt.AddLabelColor,up:({propsForNextShape:t,...e})=>({...e,propsForNextShape:{...t,labelColor:"black"}})},{id:dt.AddFollowingUserId,up:t=>({...t,followingUserId:null})},{id:dt.RemoveAlignJustify,up:t=>{let e=t.propsForNextShape.align;return e==="justify"&&(e="start"),{...t,propsForNextShape:{...t.propsForNextShape,align:e}}}},{id:dt.AddZoom,up:t=>({...t,zoomBrush:null})},{id:dt.AddVerticalAlign,up:t=>({...t,propsForNextShape:{...t.propsForNextShape,verticalAlign:"middle"}})},{id:dt.AddScribbleDelay,up:t=>t.scribble!==null?{...t,scribble:{...t.scribble,delay:0}}:{...t}},{id:dt.RemoveUserId,up:({userId:t,...e})=>e},{id:dt.AddIsPenModeAndIsGridMode,up:t=>({...t,isPenMode:!1,isGridMode:!1})},{id:dt.HoistOpacity,up:({propsForNextShape:{opacity:t,...e},...n})=>({...n,opacityForNextShape:Number(t??"1"),propsForNextShape:e})},{id:dt.AddChat,up:t=>({...t,chatMessage:"",isChatting:!1})},{id:dt.AddHighlightedUserIds,up:t=>({...t,highlightedUserIds:[]})},{id:dt.ReplacePropsForNextShapeWithStylesForNextShape,up:({propsForNextShape:t,...e})=>({...e,stylesForNextShape:{}})},{id:dt.AddMeta,up:t=>({...t,meta:{}})},{id:dt.RemoveCursorColor,up:t=>{const{color:e,...n}=t.cursor;return{...t,cursor:n}}},{id:dt.AddLonelyProperties,up:t=>({...t,canMoveCamera:!0,isFocused:!1,devicePixelRatio:1,isCoarsePointer:!1,openMenus:[],isChangingStyle:!1,isReadOnly:!1})},{id:dt.ReadOnlyReadonly,up:({isReadOnly:t,...e})=>({...e,isReadonly:t})},{id:dt.AddHoveringCanvas,up:t=>({...t,isHoveringCanvas:null})},{id:dt.AddScribbles,up:({scribble:t,...e})=>({...e,scribbles:[]})},{id:dt.AddInset,up:t=>({...t,insets:[!1,!1,!1,!1]}),down:({insets:t,...e})=>({...e})},{id:dt.AddDuplicateProps,up:t=>({...t,duplicateProps:null}),down:({duplicateProps:t,...e})=>({...e})},{id:dt.RemoveCanMoveCamera,up:({canMoveCamera:t,...e})=>({...e}),down:t=>({...t,canMoveCamera:!0})}]}),Fn="instance:instance",BD=Pr("instance_page_state",Ne({typeName:In("instance_page_state"),id:bs("instance_page_state"),pageId:wc,selectedShapeIds:on(Ds),hintingShapeIds:on(Ds),erasingShapeIds:on(Ds),hoveredShapeId:Ds.nullable(),editingShapeId:Ds.nullable(),croppingShapeId:Ds.nullable(),focusedGroupId:Ds.nullable(),meta:an})),Ea=as("com.tldraw.instance_page_state",{AddCroppingId:1,RemoveInstanceIdAndCameraId:2,AddMeta:3,RenameProperties:4,RenamePropertiesAgain:5}),zD=Is({sequenceId:"com.tldraw.instance_page_state",recordType:"instance_page_state",sequence:[{id:Ea.AddCroppingId,up(t){t.croppingShapeId=null}},{id:Ea.RemoveInstanceIdAndCameraId,up(t){delete t.instanceId,delete t.cameraId}},{id:Ea.AddMeta,up:t=>{t.meta={}}},{id:Ea.RenameProperties,up:t=>{},down:t=>{}},{id:Ea.RenamePropertiesAgain,up:t=>{t.selectedShapeIds=t.selectedIds,delete t.selectedIds,t.hintingShapeIds=t.hintingIds,delete t.hintingIds,t.erasingShapeIds=t.erasingIds,delete t.erasingIds,t.hoveredShapeId=t.hoveredId,delete t.hoveredId,t.editingShapeId=t.editingId,delete t.editingId,t.croppingShapeId=t.croppingShapeId??t.croppingId??null,delete t.croppingId,t.focusedGroupId=t.focusLayerId,delete t.focusLayerId},down:t=>{t.selectedIds=t.selectedShapeIds,delete t.selectedShapeIds,t.hintingIds=t.hintingShapeIds,delete t.hintingShapeIds,t.erasingIds=t.erasingShapeIds,delete t.erasingShapeIds,t.hoveredId=t.hoveredShapeId,delete t.hoveredShapeId,t.editingId=t.editingShapeId,delete t.editingShapeId,t.croppingId=t.croppingShapeId,delete t.croppingShapeId,t.focusLayerId=t.focusedGroupId,delete t.focusedGroupId}}]}),Qs=vr("instance_page_state",{validator:BD,scope:"session",ephemeralKeys:{pageId:!1,selectedShapeIds:!1,editingShapeId:!1,croppingShapeId:!1,meta:!1,hintingShapeIds:!0,erasingShapeIds:!0,hoveredShapeId:!0,focusedGroupId:!0}}).withDefaultProperties(()=>({editingShapeId:null,croppingShapeId:null,selectedShapeIds:[],hoveredShapeId:null,erasingShapeIds:[],hintingShapeIds:[],focusedGroupId:null,meta:{}})),$D=Pr("pointer",Ne({typeName:In("pointer"),id:bs("pointer"),x:Te,y:Te,lastActivityTimestamp:Te,meta:an})),ND=as("com.tldraw.pointer",{AddMeta:1}),UD=Is({sequenceId:"com.tldraw.pointer",recordType:"pointer",sequence:[{id:ND.AddMeta,up:t=>{t.meta={}}}]}),Xm=vr("pointer",{validator:$D,scope:"session"}).withDefaultProperties(()=>({x:0,y:0,lastActivityTimestamp:0,meta:{}})),Cd=Xm.createId("pointer"),HD=Pr("instance_presence",Ne({typeName:In("instance_presence"),id:bs("instance_presence"),userId:De,userName:De,lastActivityTimestamp:Te.nullable(),followingUserId:De.nullable(),cursor:Ne({x:Te,y:Te,type:K1,rotation:Te}).nullable(),color:De,camera:Ne({x:Te,y:Te,z:Te}).nullable(),screenBounds:dc.nullable(),selectedShapeIds:on(bs("shape")),currentPageId:bs("page"),brush:dc.nullable(),scribbles:on(W1),chatMessage:De,meta:an})),Po=as("com.tldraw.instance_presence",{AddScribbleDelay:1,RemoveInstanceId:2,AddChatMessage:3,AddMeta:4,RenameSelectedShapeIds:5,NullableCameraCursor:6}),KD=Is({sequenceId:"com.tldraw.instance_presence",recordType:"instance_presence",sequence:[{id:Po.AddScribbleDelay,up:t=>{t.scribble!==null&&(t.scribble.delay=0)}},{id:Po.RemoveInstanceId,up:t=>{delete t.instanceId}},{id:Po.AddChatMessage,up:t=>{t.chatMessage=""}},{id:Po.AddMeta,up:t=>{t.meta={}}},{id:Po.RenameSelectedShapeIds,up:t=>{}},{id:Po.NullableCameraCursor,up:t=>{},down:t=>{t.camera===null&&(t.camera={x:0,y:0,z:1}),t.lastActivityTimestamp===null&&(t.lastActivityTimestamp=0),t.cursor===null&&(t.cursor={type:"default",x:0,y:0,rotation:0}),t.screenBounds===null&&(t.screenBounds={x:0,y:0,w:1,h:1})}}]}),WD=vr("instance_presence",{validator:HD,scope:"presence"}).withDefaultProperties(()=>({lastActivityTimestamp:null,followingUserId:null,color:"#FF0000",camera:null,cursor:null,screenBounds:null,selectedShapeIds:[],brush:null,scribbles:[],chatMessage:"",meta:{}})),qD=Pr("document",Ne({typeName:In("document"),id:In("document:document"),gridSize:Te,name:De,meta:an})),Qb=as("com.tldraw.document",{AddName:1,AddMeta:2}),GD=Is({sequenceId:"com.tldraw.document",recordType:"document",sequence:[{id:Qb.AddName,up:t=>{t.name=""},down:t=>{delete t.name}},{id:Qb.AddMeta,up:t=>{t.meta={}}}]}),Zm=vr("document",{validator:qD,scope:"document"}).withDefaultProperties(()=>({gridSize:10,name:"",meta:{}})),Pg=Zm.createId("document");function ew(t){t.typeName==="asset"&&("src"in t&&(t.src="<redacted>"),"src"in t.props&&(t.props.src="<redacted>"))}function YD({error:t,phase:e,record:n,recordBefore:s}){throw pm(t,{tags:{origin:"store.validateRecord",storePhase:e,isExistingValidationIssue:e==="initialize"},extras:{recordBefore:s?ew(wt(s)):void 0,recordAfter:ew(wt(n))}}),t}function VD(){return[zn.create({id:"page:page",name:"Page 1",index:"a1",meta:{}})]}function XD(t){const e=t.query.ids("page"),n=t.query.records("instance_page_state"),s=()=>{if(!t.has(Pg))return t.put([Zm.create({id:Pg,name:t.props.defaultName})]),s();if(!t.has(Cd))return t.put([Xm.create({id:Cd})]),s();const r=e.get();if(r.size===0)return t.put(VD()),s();const i=()=>[...r].map(u=>t.get(u)).sort(Yt)[0].id,o=t.get(Fn);if(o){if(!r.has(o.currentPageId))return t.put([{...o,currentPageId:i()}]),s()}else return t.put([t.schema.types.instance.create({id:Fn,currentPageId:i(),exportBackground:!0})]),s();const a=new Set,c=new Set;for(const u of r){const d=Qs.createId(u);t.get(d)||a.add(d);const f=mr.createId(u);t.has(f)||c.add(f)}a.size>0&&t.put([...a].map(u=>Qs.create({id:u,pageId:Qs.parseId(u)}))),c.size>0&&t.put([...c].map(u=>mr.create({id:u})));const l=n.get();for(const u of l){if(!r.has(u.pageId)){t.remove([u.id]);continue}if(u.croppingShapeId&&!t.has(u.croppingShapeId))return t.put([{...u,croppingShapeId:null}]),s();if(u.focusedGroupId&&!t.has(u.focusedGroupId))return t.put([{...u,focusedGroupId:null}]),s();if(u.hoveredShapeId&&!t.has(u.hoveredShapeId))return t.put([{...u,hoveredShapeId:null}]),s();const d=u.selectedShapeIds.filter(g=>t.has(g));if(d.length!==u.selectedShapeIds.length)return t.put([{...u,selectedShapeIds:d}]),s();const p=u.hintingShapeIds.filter(g=>t.has(g));if(p.length!==u.hintingShapeIds.length)return t.put([{...u,hintingShapeIds:p}]),s();const f=u.erasingShapeIds.filter(g=>t.has(g));if(f.length!==u.erasingShapeIds.length)return t.put([{...u,erasingShapeIds:f}]),s()}};return s}const ZD=Gm("bookmark",Ne({title:De,description:De,image:De,favicon:De,src:no.nullable()})),tw=as("com.tldraw.asset.bookmark",{MakeUrlsValid:1,AddFavicon:2}),JD=Is({sequenceId:"com.tldraw.asset.bookmark",recordType:"asset",filter:t=>t.type==="bookmark",sequence:[{id:tw.MakeUrlsValid,up:t=>{no.isValid(t.props.src)||(t.props.src="")},down:t=>{}},{id:tw.AddFavicon,up:t=>{no.isValid(t.props.favicon)||(t.props.favicon="")},down:t=>{delete t.props.favicon}}]}),QD=Gm("image",Ne({w:Te,h:Te,name:De,isAnimated:Le,mimeType:De.nullable(),src:no.nullable(),fileSize:jt.optional()})),ka=as("com.tldraw.asset.image",{AddIsAnimated:1,RenameWidthHeight:2,MakeUrlsValid:3,AddFileSize:4,MakeFileSizeOptional:5}),eO=Is({sequenceId:"com.tldraw.asset.image",recordType:"asset",filter:t=>t.type==="image",sequence:[{id:ka.AddIsAnimated,up:t=>{t.props.isAnimated=!1},down:t=>{delete t.props.isAnimated}},{id:ka.RenameWidthHeight,up:t=>{t.props.w=t.props.width,t.props.h=t.props.height,delete t.props.width,delete t.props.height},down:t=>{t.props.width=t.props.w,t.props.height=t.props.h,delete t.props.w,delete t.props.h}},{id:ka.MakeUrlsValid,up:t=>{no.isValid(t.props.src)||(t.props.src="")},down:t=>{}},{id:ka.AddFileSize,up:t=>{t.props.fileSize=-1},down:t=>{delete t.props.fileSize}},{id:ka.MakeFileSizeOptional,up:t=>{t.props.fileSize===-1&&(t.props.fileSize=void 0)},down:t=>{t.props.fileSize===void 0&&(t.props.fileSize=-1)}}]}),tO=Gm("video",Ne({w:Te,h:Te,name:De,isAnimated:Le,mimeType:De.nullable(),src:no.nullable(),fileSize:Te.optional()})),Aa=as("com.tldraw.asset.video",{AddIsAnimated:1,RenameWidthHeight:2,MakeUrlsValid:3,AddFileSize:4,MakeFileSizeOptional:5}),nO=Is({sequenceId:"com.tldraw.asset.video",recordType:"asset",filter:t=>t.type==="video",sequence:[{id:Aa.AddIsAnimated,up:t=>{t.props.isAnimated=!1},down:t=>{delete t.props.isAnimated}},{id:Aa.RenameWidthHeight,up:t=>{t.props.w=t.props.width,t.props.h=t.props.height,delete t.props.width,delete t.props.height},down:t=>{t.props.width=t.props.w,t.props.height=t.props.h,delete t.props.w,delete t.props.h}},{id:Aa.MakeUrlsValid,up:t=>{no.isValid(t.props.src)||(t.props.src="")},down:t=>{}},{id:Aa.AddFileSize,up:t=>{t.props.fileSize=-1},down:t=>{delete t.props.fileSize}},{id:Aa.MakeFileSizeOptional,up:t=>{t.props.fileSize===-1&&(t.props.fileSize=void 0)},down:t=>{t.props.fileSize===void 0&&(t.props.fileSize=-1)}}]}),sO=Pr("asset",Km("type",{image:QD,video:tO,bookmark:ZD})),rO=as("com.tldraw.asset",{AddMeta:1}),iO=Is({sequenceId:"com.tldraw.asset",recordType:"asset",sequence:[{id:rO.AddMeta,up:t=>{t.meta={}}}]}),mo=vr("asset",{validator:sO,scope:"document"}).withDefaultProperties(()=>({meta:{}})),G1={w:jt,h:jt,assetId:ou.nullable(),url:ws},nw=$s("bookmark",{NullAssetId:1,MakeUrlsValid:2}),Y1={sequence:[{id:nw.NullAssetId,up:t=>{t.assetId===void 0&&(t.assetId=null)},down:"retired"},{id:nw.MakeUrlsValid,up:t=>{ws.isValid(t.url)||(t.url="")},down:t=>{}}]},kf=16,Ya="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Va=new Uint8Array(128);for(let t=0;t<64;t++)Va[Ya.charCodeAt(t)]=t;const V1=new Float64Array(31);for(let t=0;t<31;t++)V1[t]=Math.pow(2,t-15);const sw=Math.pow(2,-14)/1024,X1=new Float64Array(1024);for(let t=0;t<1024;t++)X1[t]=1+t/1024;function oO(t,e){return t.getFloat16(e,!0)}function aO(t,e){return fO(t.getUint16(e,!0))}const Hr=typeof DataView.prototype.getFloat16=="function"?oO:aO;function cO(t,e,n){t.setFloat16(e,n,!0)}function lO(t,e,n){t.setUint16(e,gO(n),!0)}const Kr=typeof DataView.prototype.setFloat16=="function"?cO:lO;function dO(t){return Uint8Array.fromBase64(t)}function uO(t){const e=Math.floor(t.length*3/4),n=new Uint8Array(e);let s=0;for(let r=0;r<t.length;r+=4){const i=Va[t.charCodeAt(r)],o=Va[t.charCodeAt(r+1)],a=Va[t.charCodeAt(r+2)],c=Va[t.charCodeAt(r+3)],l=i<<18|o<<12|a<<6|c;n[s++]=l>>16&255,n[s++]=l>>8&255,n[s++]=l&255}return n}function hO(t){return t.toBase64()}function pO(t){le(t.length%3===0,"Uint8Array length must be a multiple of 3");let e="";for(let n=0;n<t.length;n+=3){const s=t[n],r=t[n+1],i=t[n+2],o=s<<16|r<<8|i;e+=Ya[o>>18&63]+Ya[o>>12&63]+Ya[o>>6&63]+Ya[o&63]}return e}const Af=typeof Uint8Array.prototype.toBase64=="function"?hO:pO,Il=typeof Uint8Array.fromBase64=="function"?dO:uO;function fO(t){const e=t>>15,n=t>>10&31,s=t&1023;if(n===0)return e?-s*sw:s*sw;if(n===31)return s?NaN:e?-1/0:1/0;const r=V1[n]*X1[s];return e?-r:r}function gO(t){if(t===0)return Object.is(t,-0)?32768:0;if(!Number.isFinite(t))return Number.isNaN(t)?32256:t>0?31744:64512;const e=t<0?1:0;t=Math.abs(t);const n=Math.floor(Math.log2(t));let s=n+15;if(s>=31)return e<<15|31744;if(s<=0){const o=Math.round(t*Math.pow(2,14)*1024);return e<<15|o&1023}const r=t/Math.pow(2,n)-1;let i=Math.round(r*1024);return i>=1024&&(i=0,s++,s>=31)?e<<15|31744:e<<15|s<<10|i}class He{static _legacyEncodePoint(e,n,s){const r=new Uint8Array(6),i=new DataView(r.buffer);return Kr(i,0,e),Kr(i,2,n),Kr(i,4,s),Af(r)}static _legacyEncodePoints(e){if(e.length===0)return"";const n=new Uint8Array(e.length*6),s=new DataView(n.buffer);for(let r=0;r<e.length;r++){const i=e[r],o=r*6;Kr(s,o,i.x),Kr(s,o+2,i.y),Kr(s,o+4,i.z??.5)}return Af(n)}static _legacyDecodePoints(e){const n=Il(e),s=new DataView(n.buffer,n.byteOffset,n.byteLength),r=[];for(let i=0;i<n.length;i+=6)r.push({x:Hr(s,i),y:Hr(s,i+2),z:Hr(s,i+4)});return r}static encodePoints(e){if(e.length===0)return"";const n=12,s=(e.length-1)*6,r=n+s,i=new Uint8Array(r),o=new DataView(i.buffer),a=e[0];o.setFloat32(0,a.x,!0),o.setFloat32(4,a.y,!0),o.setFloat32(8,a.z??.5,!0);let c=a.x,l=a.y,u=a.z??.5;for(let d=1;d<e.length;d++){const p=e[d],f=p.z??.5,g=n+(d-1)*6;Kr(o,g,p.x-c),Kr(o,g+2,p.y-l),Kr(o,g+4,f-u),c=p.x,l=p.y,u=f}return Af(i)}static decodePoints(e){if(e.length===0)return[];const n=Il(e),s=new DataView(n.buffer,n.byteOffset,n.byteLength),r=[];let i=s.getFloat32(0,!0),o=s.getFloat32(4,!0),a=s.getFloat32(8,!0);r.push({x:i,y:o,z:a});const c=12;for(let l=c;l<n.length;l+=6)i+=Hr(s,l),o+=Hr(s,l+2),a+=Hr(s,l+4),r.push({x:i,y:o,z:a});return r}static decodeFirstPoint(e){if(e.length<kf)return null;const n=Il(e.slice(0,kf)),s=new DataView(n.buffer,n.byteOffset,n.byteLength);return{x:s.getFloat32(0,!0),y:s.getFloat32(4,!0),z:s.getFloat32(8,!0)}}static decodeLastPoint(e){if(e.length<kf)return null;const n=Il(e),s=new DataView(n.buffer,n.byteOffset,n.byteLength);let r=s.getFloat32(0,!0),i=s.getFloat32(4,!0),o=s.getFloat32(8,!0);const a=12;for(let c=a;c<n.length;c+=6)r+=Hr(s,c),i+=Hr(s,c+2),o+=Hr(s,c+4);return{x:r,y:i,z:o}}}const Z1=Ne({type:to("free","straight"),path:De}),J1={color:Un,fill:Ti,dash:so,size:br,segments:on(Z1),isComplete:Le,isClosed:Le,isPen:Le,scale:jt,scaleX:vd,scaleY:vd},_l=$s("draw",{AddInPen:1,AddScale:2,Base64:3,LegacyPointsConversion:4}),Q1={sequence:[{id:_l.AddInPen,up:t=>{const{points:e}=t.segments[0];if(e.length===0){t.isPen=!1;return}let n=!(e[0].z===0||e[0].z===.5);e[1]&&(n=n&&!(e[1].z===0||e[1].z===.5)),t.isPen=n},down:"retired"},{id:_l.AddScale,up:t=>{t.scale=1},down:t=>{delete t.scale}},{id:_l.Base64,up:t=>{t.segments=t.segments.map(e=>{if(e.path!==void 0)return e;const{points:n,...s}=e,r=Array.isArray(n)?n:He._legacyDecodePoints(n);return{...s,path:He.encodePoints(r)}}),t.scaleX=t.scaleX??1,t.scaleY=t.scaleY??1},down:t=>{t.segments=t.segments.map(e=>{const{path:n,...s}=e;return{...s,points:He.decodePoints(n)}}),delete t.scaleX,delete t.scaleY}},{id:_l.LegacyPointsConversion,up:t=>{t.segments=t.segments.map(e=>{if(e.path!==void 0)return e;const{points:n,...s}=e,r=Array.isArray(n)?n:He._legacyDecodePoints(n);return{...s,path:He.encodePoints(r)}})},down:t=>{}}]},mO=/(^\/r\/[^/]+\/?$)/,yO=[{hostnames:["beta.tldraw.com","tldraw.com","localhost:3000"],canEditWhileLocked:!0,fromEmbedUrl:t=>{const e=Ee(t);if(e&&e.pathname.match(mO))return t}},{hostnames:["figma.com"],canEditWhileLocked:!0,fromEmbedUrl:t=>{const e=Ee(t);if(e&&e.pathname.match(/^\/embed\/?$/)){const n=e.searchParams.get("url");if(n)return n}}},{hostnames:["google.*"],canEditWhileLocked:!0,fromEmbedUrl:t=>{const e=Ee(t);if(!e)return;if(e.pathname.match(/^\/maps\/embed\/v1\/view\/?$/)&&e.searchParams.has("center")&&e.searchParams.get("zoom")){const s=e.searchParams.get("zoom"),[r,i]=e.searchParams.get("center").split(",");return`https://www.google.com/maps/@${r},${i},${s}z`}}},{hostnames:["val.town"],canEditWhileLocked:!0,fromEmbedUrl:t=>{const e=Ee(t),n=e&&e.pathname.match(/\/embed\/(.+)\/?/);if(n)return`https://www.val.town/v/${n[1]}`}},{hostnames:["codesandbox.io"],canEditWhileLocked:!0,fromEmbedUrl:t=>{const e=Ee(t),n=e&&e.pathname.match(/\/embed\/([^/]+)\/?/);if(n)return`https://codesandbox.io/s/${n[1]}`}},{hostnames:["codepen.io"],canEditWhileLocked:!0,fromEmbedUrl:t=>{const e=/https:\/\/codepen.io\/([^/]+)\/embed\/([^/]+)/,n=t.match(e);if(n){const[s,r,i]=n;return`https://codepen.io/${r}/pen/${i}`}}},{hostnames:["scratch.mit.edu"],canEditWhileLocked:!0,fromEmbedUrl:t=>{const e=/https:\/\/scratch.mit.edu\/projects\/embed\/([^/]+)/,n=t.match(e);if(n){const[s,r]=n;return`https://scratch.mit.edu/projects/${r}`}}},{hostnames:["*.youtube.com","youtube.com","youtu.be"],canEditWhileLocked:!0,fromEmbedUrl:t=>{const e=Ee(t);if(!e)return;if(e.hostname.replace(/^www./,"")==="youtube.com"){const s=e.pathname.match(/^\/embed\/([^/]+)\/?/);if(s)return`https://www.youtube.com/watch?v=${s[1]}`}}},{hostnames:["calendar.google.*"],canEditWhileLocked:!0,fromEmbedUrl:t=>{const e=Ee(t),n=e?.searchParams.get("src");if(e?.pathname.match(/\/calendar\/embed/)&&n){e.pathname="/calendar/u/0";const s=Array.from(e.searchParams.keys());for(const r of s)e.searchParams.delete(r);return e.searchParams.set("cid",n),e.href}}},{hostnames:["docs.google.*"],canEditWhileLocked:!0,fromEmbedUrl:t=>{const e=Ee(t);if(e?.pathname.match(/^\/presentation/)&&e?.pathname.match(/\/embed\/?$/)){e.pathname=e.pathname.replace(/\/embed$/,"/pub");const n=Array.from(e.searchParams.keys());for(const s of n)e.searchParams.delete(s);return e.href}}},{hostnames:["gist.github.com"],canEditWhileLocked:!0,fromEmbedUrl:t=>{const e=Ee(t);if(e&&e.pathname.match(/\/([^/]+)\/([^/]+)/))return t.split("/").pop()?t:void 0}},{hostnames:["replit.com"],canEditWhileLocked:!0,fromEmbedUrl:t=>{const e=Ee(t);if(e&&e.pathname.match(/\/@([^/]+)\/([^/]+)/)&&e.searchParams.has("embed"))return e.searchParams.delete("embed"),e.href}},{hostnames:["felt.com"],canEditWhileLocked:!0,fromEmbedUrl:t=>{const e=Ee(t);if(e&&e.pathname.match(/^\/embed\/map\//))return e.pathname=e.pathname.replace(/^\/embed/,""),e.href}},{hostnames:["open.spotify.com"],canEditWhileLocked:!0,fromEmbedUrl:t=>{const e=Ee(t);if(e&&e.pathname.match(/^\/embed\/(artist|album)\//))return e.origin+e.pathname.replace(/^\/embed/,"")}},{hostnames:["vimeo.com","player.vimeo.com"],canEditWhileLocked:!0,fromEmbedUrl:t=>{const e=Ee(t);if(e&&e.hostname==="player.vimeo.com"){const n=e.pathname.match(/^\/video\/([^/]+)\/?$/);if(n)return"https://vimeo.com/"+n[1]}}},{hostnames:["observablehq.com"],canEditWhileLocked:!0,fromEmbedUrl:t=>{const e=Ee(t);if(e&&e.pathname.match(/^\/embed\/@([^/]+)\/([^/]+)\/?$/))return`${e.origin}${e.pathname.replace("/embed","")}#cell-*`;if(e&&e.pathname.match(/^\/embed\/([^/]+)\/?$/))return`${e.origin}${e.pathname.replace("/embed","/d")}#cell-*`}},{hostnames:["desmos.com"],canEditWhileLocked:!0,fromEmbedUrl:t=>{const e=Ee(t);if(e&&e.hostname==="www.desmos.com"&&e.pathname.match(/^\/calculator\/([^/]+)\/?$/)&&e.search==="?embed"&&e.hash==="")return t.replace("?embed","")}}],eP={w:jt,h:jt,url:De},Cl=$s("embed",{GenOriginalUrlInEmbed:1,RemoveDoesResize:2,RemoveTmpOldUrl:3,RemovePermissionOverrides:4}),tP={sequence:[{id:Cl.GenOriginalUrlInEmbed,up:t=>{try{const e=t.url,n=new URL(e).host.replace("www.","");let s;for(const r of yO)if(r.hostnames.includes(n))try{s=r.fromEmbedUrl(e)}catch(i){console.warn(i)}t.tmpOldUrl=t.url,t.url=s??""}catch{t.url="",t.tmpOldUrl=t.url}},down:"retired"},{id:Cl.RemoveDoesResize,up:t=>{delete t.doesResize},down:"retired"},{id:Cl.RemoveTmpOldUrl,up:t=>{delete t.tmpOldUrl},down:"retired"},{id:Cl.RemovePermissionOverrides,up:t=>{delete t.overridePermissions},down:"retired"}]},nP={w:jt,h:jt,name:De,color:to(...Un.values)},SO=$s("frame",{AddColorProp:1}),sP={sequence:[{id:SO.AddColorProp,up:t=>{t.color="black"},down:t=>{delete t.color}}]},Td=Jt.defineEnum("tldraw:horizontalAlign",{defaultValue:"middle",values:["start","middle","end","start-legacy","end-legacy","middle-legacy"]}),Ed=Jt.defineEnum("tldraw:verticalAlign",{defaultValue:"middle",values:["start","middle","end"]}),yr=Jt.defineEnum("tldraw:geo",{defaultValue:"rectangle",values:["cloud","rectangle","ellipse","triangle","diamond","pentagon","hexagon","octagon","star","rhombus","rhombus-2","oval","trapezoid","arrow-right","arrow-left","arrow-up","arrow-down","x-box","check-box","heart"]}),rP={geo:yr,dash:so,url:ws,w:jt,h:jt,growY:wd,scale:jt,labelColor:Vm,color:Un,fill:Ti,size:br,font:Ei,align:Td,verticalAlign:Ed,richText:Wc},Vs=$s("geo",{AddUrlProp:1,AddLabelColor:2,RemoveJustify:3,AddCheckBox:4,AddVerticalAlign:5,MigrateLegacyAlign:6,AddCloud:7,MakeUrlsValid:8,AddScale:9,AddRichText:10,AddRichTextAttrs:11}),iP={sequence:[{id:Vs.AddUrlProp,up:t=>{t.url=""},down:"retired"},{id:Vs.AddLabelColor,up:t=>{t.labelColor="black"},down:"retired"},{id:Vs.RemoveJustify,up:t=>{t.align==="justify"&&(t.align="start")},down:"retired"},{id:Vs.AddCheckBox,up:t=>{},down:"retired"},{id:Vs.AddVerticalAlign,up:t=>{t.verticalAlign="middle"},down:"retired"},{id:Vs.MigrateLegacyAlign,up:t=>{let e;switch(t.align){case"start":e="start-legacy";break;case"end":e="end-legacy";break;default:e="middle-legacy";break}t.align=e},down:"retired"},{id:Vs.AddCloud,up:t=>{},down:"retired"},{id:Vs.MakeUrlsValid,up:t=>{ws.isValid(t.url)||(t.url="")},down:t=>{}},{id:Vs.AddScale,up:t=>{t.scale=1},down:t=>{delete t.scale}},{id:Vs.AddRichText,up:t=>{t.richText=ln(t.text),delete t.text}},{id:Vs.AddRichTextAttrs,up:t=>{},down:t=>{t.richText&&"attrs"in t.richText&&delete t.richText.attrs}}]},oP={},aP={sequence:[]},cP={color:Un,size:br,segments:on(Z1),isComplete:Le,isPen:Le,scale:jt,scaleX:vd,scaleY:vd},Mf=$s("highlight",{AddScale:1,Base64:2,LegacyPointsConversion:3}),lP={sequence:[{id:Mf.AddScale,up:t=>{t.scale=1},down:t=>{delete t.scale}},{id:Mf.Base64,up:t=>{t.segments=t.segments.map(e=>{if(e.path!==void 0)return e;const{points:n,...s}=e,r=Array.isArray(n)?n:He._legacyDecodePoints(n);return{...s,path:He.encodePoints(r)}}),t.scaleX=t.scaleX??1,t.scaleY=t.scaleY??1},down:t=>{t.segments=t.segments.map(e=>{const{path:n,...s}=e;return{...s,points:He.decodePoints(n)}}),delete t.scaleX,delete t.scaleY}},{id:Mf.LegacyPointsConversion,up:t=>{t.segments=t.segments.map(e=>{if(e.path!==void 0)return e;const{points:n,...s}=e,r=Array.isArray(n)?n:He._legacyDecodePoints(n);return{...s,path:He.encodePoints(r)}})},down:t=>{}}]},xO=Ne({topLeft:na,bottomRight:na,isCircle:Le.optional()}),dP={w:jt,h:jt,playing:Le,url:ws,assetId:ou.nullable(),crop:xO.nullable(),flipX:Le,flipY:Le,altText:De},Ma=$s("image",{AddUrlProp:1,AddCropProp:2,MakeUrlsValid:3,AddFlipProps:4,AddAltText:5}),uP={sequence:[{id:Ma.AddUrlProp,up:t=>{t.url=""},down:"retired"},{id:Ma.AddCropProp,up:t=>{t.crop=null},down:t=>{delete t.crop}},{id:Ma.MakeUrlsValid,up:t=>{ws.isValid(t.url)||(t.url="")},down:t=>{}},{id:Ma.AddFlipProps,up:t=>{t.flipX=!1,t.flipY=!1},down:t=>{delete t.flipX,delete t.flipY}},{id:Ma.AddAltText,up:t=>{t.altText=""},down:t=>{delete t.altText}}]},Ig=Jt.defineEnum("tldraw:spline",{defaultValue:"line",values:["cubic","line"]}),bO=Ne({id:De,index:qm,x:Te,y:Te}),hP={color:Un,dash:so,size:br,spline:Ig,points:Pd(De,bO),scale:jt},ja=$s("line",{AddSnapHandles:1,RemoveExtraHandleProps:2,HandlesToPoints:3,PointIndexIds:4,AddScale:5}),pP={sequence:[{id:ja.AddSnapHandles,up:t=>{for(const e of Object.values(t.handles))e.canSnap=!0},down:"retired"},{id:ja.RemoveExtraHandleProps,up:t=>{t.handles=P0(Object.values(t.handles).map(e=>[e.index,{x:e.x,y:e.y}]))},down:t=>{const e=Object.entries(t.handles).map(([n,s])=>({index:n,...s})).sort(Yt);t.handles=Object.fromEntries(e.map((n,s)=>{const r=s===0?"start":s===e.length-1?"end":`handle:${n.index}`;return[r,{id:r,type:"vertex",canBind:!1,canSnap:!0,index:n.index,x:n.x,y:n.y}]}))}},{id:ja.HandlesToPoints,up:t=>{const e=Object.entries(t.handles).map(([n,{x:s,y:r}])=>({x:s,y:r,index:n})).sort(Yt);t.points=e.map(({x:n,y:s})=>({x:n,y:s})),delete t.handles},down:t=>{const e=bc(t.points.length);t.handles=Object.fromEntries(t.points.map((n,s)=>[e[s],{x:n.x,y:n.y}])),delete t.points}},{id:ja.PointIndexIds,up:t=>{const e=bc(t.points.length);t.points=Object.fromEntries(t.points.map((n,s)=>{const r=e[s];return[r,{id:r,index:r,x:n.x,y:n.y}]}))},down:t=>{const e=Object.values(t.points).sort(Yt);t.points=e.map(({x:n,y:s})=>({x:n,y:s}))}},{id:ja.AddScale,up:t=>{t.scale=1},down:t=>{delete t.scale}}]},fP={color:Un,labelColor:Vm,size:br,font:Ei,fontSizeAdjustment:wd,align:Td,verticalAlign:Ed,growY:wd,url:ws,richText:Wc,scale:jt},lr=$s("note",{AddUrlProp:1,RemoveJustify:2,MigrateLegacyAlign:3,AddVerticalAlign:4,MakeUrlsValid:5,AddFontSizeAdjustment:6,AddScale:7,AddLabelColor:8,AddRichText:9,AddRichTextAttrs:10}),gP={sequence:[{id:lr.AddUrlProp,up:t=>{t.url=""},down:"retired"},{id:lr.RemoveJustify,up:t=>{t.align==="justify"&&(t.align="start")},down:"retired"},{id:lr.MigrateLegacyAlign,up:t=>{switch(t.align){case"start":t.align="start-legacy";return;case"end":t.align="end-legacy";return;default:t.align="middle-legacy";return}},down:"retired"},{id:lr.AddVerticalAlign,up:t=>{t.verticalAlign="middle"},down:"retired"},{id:lr.MakeUrlsValid,up:t=>{ws.isValid(t.url)||(t.url="")},down:t=>{}},{id:lr.AddFontSizeAdjustment,up:t=>{t.fontSizeAdjustment=0},down:t=>{delete t.fontSizeAdjustment}},{id:lr.AddScale,up:t=>{t.scale=1},down:t=>{delete t.scale}},{id:lr.AddLabelColor,up:t=>{t.labelColor="black"},down:t=>{delete t.labelColor}},{id:lr.AddRichText,up:t=>{t.richText=ln(t.text),delete t.text}},{id:lr.AddRichTextAttrs,up:t=>{},down:t=>{t.richText&&"attrs"in t.richText&&delete t.richText.attrs}}]},_g=Jt.defineEnum("tldraw:textAlign",{defaultValue:"start",values:["start","middle","end"]}),mP={color:Un,size:br,font:Ei,textAlign:_g,w:jt,richText:Wc,scale:jt,autoSize:Le},Tl=$s("text",{RemoveJustify:1,AddTextAlign:2,AddRichText:3,AddRichTextAttrs:4}),yP={sequence:[{id:Tl.RemoveJustify,up:t=>{t.align==="justify"&&(t.align="start")},down:"retired"},{id:Tl.AddTextAlign,up:t=>{t.textAlign=t.align,delete t.align},down:t=>{t.align=t.textAlign,delete t.textAlign}},{id:Tl.AddRichText,up:t=>{t.richText=ln(t.text),delete t.text}},{id:Tl.AddRichTextAttrs,up:t=>{},down:t=>{t.richText&&"attrs"in t.richText&&delete t.richText.attrs}}]},SP={w:jt,h:jt,time:Te,playing:Le,autoplay:Le,url:ws,assetId:ou.nullable(),altText:De},El=$s("video",{AddUrlProp:1,MakeUrlsValid:2,AddAltText:3,AddAutoplay:4}),xP={sequence:[{id:El.AddUrlProp,up:t=>{t.url=""},down:"retired"},{id:El.MakeUrlsValid,up:t=>{ws.isValid(t.url)||(t.url="")},down:t=>{}},{id:El.AddAltText,up:t=>{t.altText=""},down:t=>{delete t.altText}},{id:El.AddAutoplay,up:t=>{t.autoplay=!0},down:t=>{delete t.autoplay}}]},Da=as("com.tldraw.store",{RemoveCodeAndIconShapeTypes:1,AddInstancePresenceType:2,RemoveTLUserAndPresenceAndAddPointer:3,RemoveUserDocument:4,FixIndexKeys:5}),wO=Go({sequenceId:"com.tldraw.store",retroactive:!1,sequence:[{id:Da.RemoveCodeAndIconShapeTypes,scope:"storage",up:t=>{for(const[e,n]of t.entries())n.typeName==="shape"&&"type"in n&&(n.type==="icon"||n.type==="code")&&t.delete(e)}},{id:Da.AddInstancePresenceType,scope:"storage",up(t){}},{id:Da.RemoveTLUserAndPresenceAndAddPointer,scope:"storage",up:t=>{for(const[e,n]of t.entries())n.typeName.match(/^(user|user_presence)$/)&&t.delete(e)}},{id:Da.RemoveUserDocument,scope:"storage",up:t=>{for(const[e,n]of t.entries())n.typeName.match("user_document")&&t.delete(e)}},{id:Da.FixIndexKeys,scope:"record",up:t=>{if(["shape","page"].includes(t.typeName)&&"index"in t){const e=t;if(e.index.endsWith("0")&&e.index!=="a0"&&(e.index=e.index.slice(0,-1)+iw(3)),t.typeName==="shape"&&e.type==="line"){const n=e;for(const[s,r]of zs(n.props.points))r.index.endsWith("0")&&r.index!=="a0"&&(r.index=r.index.slice(0,-1)+iw(3))}}},down:()=>{}}]}),rw="123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",vO=()=>rw.charAt(Math.floor(Math.random()*rw.length)),iw=t=>Array.from({length:t},vO).join(""),PO={arrow:{migrations:N1,props:$1},bookmark:{migrations:Y1,props:G1},draw:{migrations:Q1,props:J1},embed:{migrations:tP,props:eP},frame:{migrations:sP,props:nP},geo:{migrations:iP,props:rP},group:{migrations:aP,props:oP},highlight:{migrations:lP,props:cP},image:{migrations:uP,props:dP},line:{migrations:pP,props:hP},note:{migrations:gP,props:fP},text:{migrations:yP,props:mP},video:{migrations:xP,props:SP}},IO={arrow:{migrations:H1,props:U1}};function _O({shapes:t=PO,bindings:e=IO,migrations:n}={}){const s=new Map;for(const a of _t(t))for(const c of F1(a.props??{}).keys()){if(s.has(c.id)&&s.get(c.id)!==c)throw new Error(`Multiple StyleProp instances with the same id: ${c.id}`);s.set(c.id,c)}const r=yD(t),i=fD(e),o=RD(s);return Hm.create({asset:mo,binding:i,camera:mr,document:Zm,instance:o,instance_page_state:Qs,page:zn,instance_presence:WD,pointer:Xm,shape:r},{migrations:[wO,iO,CD,GD,FD,zD,OD,KD,UD,mD,JD,eO,nO,...Jb("shape",t),...Jb("binding",e),...n??[]],onValidationFailure:YD,createIntegrityChecker:XD})}const vc=[{locale:"id",label:"Bahasa Indonesia"},{locale:"ms",label:"Bahasa Melayu"},{locale:"ca",label:"Català"},{locale:"cs",label:"Čeština"},{locale:"da",label:"Danish"},{locale:"de",label:"Deutsch"},{locale:"en",label:"English"},{locale:"es",label:"Español"},{locale:"tl",label:"Filipino"},{locale:"fr",label:"Français"},{locale:"gl",label:"Galego"},{locale:"hr",label:"Hrvatski"},{locale:"it",label:"Italiano"},{locale:"hu",label:"Magyar"},{locale:"nl",label:"Nederlands"},{locale:"no",label:"Norwegian"},{locale:"pl",label:"Polski"},{locale:"pt-br",label:"Português - Brasil"},{locale:"pt-pt",label:"Português - Europeu"},{locale:"ro",label:"Română"},{locale:"sl",label:"Slovenščina"},{locale:"so",label:"Somali"},{locale:"fi",label:"Suomi"},{locale:"sv",label:"Svenska"},{locale:"vi",label:"Tiếng Việt"},{locale:"tr",label:"Türkçe"},{locale:"el",label:"Ελληνικά"},{locale:"ru",label:"Русский"},{locale:"uk",label:"Українська"},{locale:"he",label:"עברית"},{locale:"ur",label:"اردو"},{locale:"ar",label:"عربي"},{locale:"fa",label:"فارسی"},{locale:"ne",label:"नेपाली"},{locale:"mr",label:"मराठी"},{locale:"hi-in",label:"हिन्दी"},{locale:"bn",label:"বাংলা"},{locale:"pa",label:"ਪੰਜਾਬੀ"},{locale:"gu-in",label:"ગુજરાતી"},{locale:"ta",label:"தமிழ்"},{locale:"te",label:"తెలుగు"},{locale:"kn",label:"ಕನ್ನಡ"},{locale:"ml",label:"മലയാളം"},{locale:"th",label:"ภาษาไทย"},{locale:"km-kh",label:"ភាសាខ្មែរ"},{locale:"ko-kr",label:"한국어"},{locale:"ja",label:"日本語"},{locale:"zh-cn",label:"简体中文"},{locale:"zh-tw",label:"繁體中文 (台灣)"}];function CO(){const t=typeof window<"u"&&window.navigator?window.navigator.languages??["en"]:["en"];return TO(t)}function TO(t){for(const e of t){const n=EO(e);if(n)return n}return"en"}const ow={zh:"zh-cn",pt:"pt-br",ko:"ko-kr",hi:"hi-in"};function EO(t){const e=vc.find(r=>r.locale===t.toLowerCase());if(e)return e.locale;const[n,s]=t.split(/[-_]/).map(r=>r.toLowerCase());if(s){const r=vc.find(i=>i.locale===n);if(r)return r.locale}return n in ow?ow[n]:null}Di("@tldraw/tlschema","4.3.1","esm");function kO(){return h.jsx("div",{className:"tl-background"})}function qc(t,e,n,s,r,i){v.useLayoutEffect(()=>{const o=t.current;if(!o||e===void 0)return;let a=`translate(${e}px, ${n}px)`;s!==void 0&&(a+=` scale(${s})`),r!==void 0&&(a+=` rotate(${r}rad)`),i&&(a+=` translate(${i.x}px, ${i.y}px)`),o.style.transform=a})}const Pn={linear:t=>t,easeInQuad:t=>t*t,easeOutQuad:t=>t*(2-t),easeInOutQuad:t=>t<.5?2*t*t:-1+(4-2*t)*t,easeInCubic:t=>t*t*t,easeOutCubic:t=>--t*t*t+1,easeInOutCubic:t=>t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1,easeInQuart:t=>t*t*t*t,easeOutQuart:t=>1- --t*t*t*t,easeInOutQuart:t=>t<.5?8*t*t*t*t:1-8*--t*t*t*t,easeInQuint:t=>t*t*t*t*t,easeOutQuint:t=>1+--t*t*t*t*t,easeInOutQuint:t=>t<.5?16*t*t*t*t*t:1+16*--t*t*t*t*t,easeInSine:t=>1-Math.cos(t*Math.PI/2),easeOutSine:t=>Math.sin(t*Math.PI/2),easeInOutSine:t=>-(Math.cos(Math.PI*t)-1)/2,easeInExpo:t=>t<=0?0:Math.pow(2,10*t-10),easeOutExpo:t=>t>=1?1:1-Math.pow(2,-10*t),easeInOutExpo:t=>t<=0?0:t>=1?1:t<.5?Math.pow(2,20*t-10)/2:(2-Math.pow(2,-20*t+10))/2};class b{constructor(e=0,n=0,s=1){this.x=e,this.y=n,this.z=s}get pressure(){return this.z}set(e=this.x,n=this.y,s=this.z){return this.x=e,this.y=n,this.z=s,this}setTo({x:e=0,y:n=0,z:s=1}){return this.x=e,this.y=n,this.z=s,this}rot(e){if(e===0)return this;const{x:n,y:s}=this,r=Math.sin(e),i=Math.cos(e);return this.x=n*i-s*r,this.y=n*r+s*i,this}rotWith(e,n){if(n===0)return this;const s=this.x-e.x,r=this.y-e.y,i=Math.sin(n),o=Math.cos(n);return this.x=e.x+(s*o-r*i),this.y=e.y+(s*i+r*o),this}clone(){const{x:e,y:n,z:s}=this;return new b(e,n,s)}sub(e){return this.x-=e.x,this.y-=e.y,this}subXY(e,n){return this.x-=e,this.y-=n,this}subScalar(e){return this.x-=e,this.y-=e,this}add(e){return this.x+=e.x,this.y+=e.y,this}addXY(e,n){return this.x+=e,this.y+=n,this}addScalar(e){return this.x+=e,this.y+=e,this}clamp(e,n){return this.x=Math.max(this.x,e),this.y=Math.max(this.y,e),n!==void 0&&(this.x=Math.min(this.x,n),this.y=Math.min(this.y,n)),this}div(e){return this.x/=e,this.y/=e,this}divV(e){return this.x/=e.x,this.y/=e.y,this}mul(e){return this.x*=e,this.y*=e,this}mulV(e){return this.x*=e.x,this.y*=e.y,this}abs(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this}nudge(e,n){const s=b.Tan(e,this);return this.add(s.mul(n))}neg(){return this.x*=-1,this.y*=-1,this}cross(e){return this.x=this.y*e.z-this.z*e.y,this.y=this.z*e.x-this.x*e.z,this}dpr(e){return b.Dpr(this,e)}cpr(e){return b.Cpr(this,e)}len2(){return b.Len2(this)}len(){return b.Len(this)}pry(e){return b.Pry(this,e)}per(){const{x:e,y:n}=this;return this.x=n,this.y=-e,this}uni(){const e=this.len();return e===0?this:(this.x/=e,this.y/=e,this)}tan(e){return this.sub(e).uni()}dist(e){return b.Dist(this,e)}distanceToLineSegment(e,n){return b.DistanceToLineSegment(e,n,this)}slope(e){return b.Slope(this,e)}snapToGrid(e){return this.x=Math.round(this.x/e)*e,this.y=Math.round(this.y/e)*e,this}angle(e){return b.Angle(this,e)}toAngle(){return b.ToAngle(this)}lrp(e,n){return this.x=this.x+(e.x-this.x)*n,this.y=this.y+(e.y-this.y)*n,this}equals(e){return b.Equals(this,e)}equalsXY(e,n){return b.EqualsXY(this,e,n)}toFixed(){return this.x=Xr(this.x),this.y=Xr(this.y),this}toString(){return b.ToString(b.ToFixed(this))}toJson(){return b.ToJson(this)}toArray(){return b.ToArray(this)}static Add(e,n){return new b(e.x+n.x,e.y+n.y)}static AddXY(e,n,s){return new b(e.x+n,e.y+s)}static Sub(e,n){return new b(e.x-n.x,e.y-n.y)}static SubXY(e,n,s){return new b(e.x-n,e.y-s)}static AddScalar(e,n){return new b(e.x+n,e.y+n)}static SubScalar(e,n){return new b(e.x-n,e.y-n)}static Div(e,n){return new b(e.x/n,e.y/n)}static Mul(e,n){return new b(e.x*n,e.y*n)}static DivV(e,n){return new b(e.x/n.x,e.y/n.y)}static MulV(e,n){return new b(e.x*n.x,e.y*n.y)}static Neg(e){return new b(-e.x,-e.y)}static Per(e){return new b(e.y,-e.x)}static Abs(e){return new b(Math.abs(e.x),Math.abs(e.y))}static Dist(e,n){return((e.y-n.y)**2+(e.x-n.x)**2)**.5}static ManhattanDist(e,n){return Math.abs(e.x-n.x)+Math.abs(e.y-n.y)}static DistMin(e,n,s){return(e.x-n.x)*(e.x-n.x)+(e.y-n.y)*(e.y-n.y)<s**2}static Dist2(e,n){return(e.x-n.x)*(e.x-n.x)+(e.y-n.y)*(e.y-n.y)}static Dpr(e,n){return e.x*n.x+e.y*n.y}static Cross(e,n){return new b(e.y*n.z-e.z*n.y,e.z*n.x-e.x*n.z)}static Cpr(e,n){return e.x*n.y-n.x*e.y}static Len2(e){return e.x*e.x+e.y*e.y}static Len(e){return(e.x*e.x+e.y*e.y)**.5}static Pry(e,n){return b.Dpr(e,n)/b.Len(n)}static Uni(e){const n=b.Len(e);return new b(n===0?0:e.x/n,n===0?0:e.y/n)}static Tan(e,n){return b.Uni(b.Sub(e,n))}static Min(e,n){return new b(Math.min(e.x,n.x),Math.min(e.y,n.y))}static Max(e,n){return new b(Math.max(e.x,n.x),Math.max(e.y,n.y))}static From({x:e,y:n,z:s=1}){return new b(e,n,s)}static FromArray(e){return new b(e[0],e[1])}static Rot(e,n=0){const s=Math.sin(n),r=Math.cos(n);return new b(e.x*r-e.y*s,e.x*s+e.y*r)}static RotWith(e,n,s){const r=e.x-n.x,i=e.y-n.y,o=Math.sin(s),a=Math.cos(s);return new b(n.x+(r*a-i*o),n.y+(r*o+i*a))}static NearestPointOnLineThroughPoint(e,n,s){return b.Mul(n,b.Sub(s,e).pry(n)).add(e)}static NearestPointOnLineSegment(e,n,s,r=!0){if(b.Equals(e,s)||b.Equals(n,s))return b.From(s);const i=b.Tan(n,e),o=b.Add(e,b.Mul(i,b.Sub(s,e).pry(i)));if(r){if(o.x<Math.min(e.x,n.x))return b.Cast(e.x<n.x?e:n);if(o.x>Math.max(e.x,n.x))return b.Cast(e.x>n.x?e:n);if(o.y<Math.min(e.y,n.y))return b.Cast(e.y<n.y?e:n);if(o.y>Math.max(e.y,n.y))return b.Cast(e.y>n.y?e:n)}return o}static DistanceToLineThroughPoint(e,n,s){return b.Dist(s,b.NearestPointOnLineThroughPoint(e,n,s))}static DistanceToLineSegment(e,n,s,r=!0){return b.Dist(s,b.NearestPointOnLineSegment(e,n,s,r))}static Snap(e,n=1){return new b(Math.round(e.x/n)*n,Math.round(e.y/n)*n)}static Cast(e){return e instanceof b?e:b.From(e)}static Slope(e,n){return e.x===n.y?NaN:(e.y-n.y)/(e.x-n.x)}static IsNaN(e){return isNaN(e.x)||isNaN(e.y)}static Angle(e,n){return Math.atan2(n.y-e.y,n.x-e.x)}static AngleBetween(e,n){const s=e.x*n.x+e.y*n.y,r=Math.sqrt((Math.pow(e.x,2)+Math.pow(e.y,2))*(Math.pow(n.x,2)+Math.pow(n.y,2)));return(e.x*n.y-e.y*n.x<0?-1:1)*Math.acos(Ce(s/r,-1,1))}static Lrp(e,n,s){return b.Sub(n,e).mul(s).add(e)}static Med(e,n){return new b((e.x+n.x)/2,(e.y+n.y)/2)}static Equals(e,n){return Math.abs(e.x-n.x)<1e-4&&Math.abs(e.y-n.y)<1e-4}static EqualsXY(e,n,s){return e.x===n&&e.y===s}static Clockwise(e,n,s){return(s.x-e.x)*(n.y-e.y)-(n.x-e.x)*(s.y-e.y)<0}static Rescale(e,n){const s=b.Len(e);return new b(n*e.x/s,n*e.y/s)}static ScaleWithOrigin(e,n,s){return b.Sub(e,s).mul(n).add(s)}static ToFixed(e){return new b(Xr(e.x),Xr(e.y))}static ToInt(e){return new b(parseInt(e.x.toFixed(0)),parseInt(e.y.toFixed(0)),parseInt((e.z??0).toFixed(0)))}static ToCss(e){return`${e.x},${e.y}`}static Nudge(e,n,s){return b.Add(e,b.Tan(n,e).mul(s))}static ToString(e){return`${e.x}, ${e.y}`}static ToAngle(e){let n=Math.atan2(e.y,e.x);return n<0&&(n+=Math.PI*2),n}static FromAngle(e,n=1){return new b(Math.cos(e)*n,Math.sin(e)*n)}static ToArray(e){return[e.x,e.y,e.z]}static ToJson(e){const{x:n,y:s,z:r}=e;return{x:n,y:s,z:r}}static Average(e){const n=e.length,s=new b(0,0);if(n===0)return s;for(let r=0;r<n;r++)s.add(e[r]);return s.div(n)}static Clamp(e,n,s){return s===void 0?new b(Math.min(Math.max(e.x,n)),Math.min(Math.max(e.y,n))):new b(Math.min(Math.max(e.x,n),s),Math.min(Math.max(e.y,n),s))}static PointsBetween(e,n,s=6){const r=[];for(let i=0;i<s;i++){const o=Pn.easeInQuad(i/(s-1)),a=b.Lrp(e,n,o);a.z=Math.min(1,.5+Math.abs(.5-AO(o))*.65),r.push(a)}return r}static SnapToGrid(e,n=8){return new b(Math.round(e.x/n)*n,Math.round(e.y/n)*n)}}const AO=t=>t<.5?2*t*t:-1+(4-2*t)*t;function rn(t){return`${F(t.x)},${F(t.y)} `}function ns(t,e){return`${F((t.x+e.x)/2)},${F((t.y+e.y)/2)} `}const Ve=Math.PI,vt=Ve/2,at=Ve*2,MO=Math.sin;function Ce(t,e,n){return Math.max(e,typeof n<"u"?Math.min(t,n):t)}function kl(t,e=1e10){return t?Math.round(t*e)/e:0}function Dt(t,e,n=1e-6){return Math.abs(t-e)<=n}function Ii(t,e,n=1e-6){return t<e||Dt(t,e,n)}function jO(t,e){const n=Math.pow(t-e,2)/Math.pow(t+e,2);return Ve*(t+e)*(1+3*n/(10+Math.sqrt(4-3*n)))}function kd(t){return t=t%at,t<0?t=t+at:t===0&&(t=0),t}function Jm(t,e){return t=kd(t),e=kd(e),t>e&&(e+=at),e-t}function DO(t,e){return at-Jm(t,e)}function id(t,e){const n=(e-t)%at;return 2*n%at-n}function Cg(t){return(at+t)%at}function Ad(t,e){const n=at/e;let s=Math.floor((Cg(t)+n/2)/n)*n%at;return s<Ve&&(s+=at),s>Ve&&(s-=at),s}function bP(t,e){return t===e||Dt(t%(Math.PI/2)-e%(Math.PI/2),0)}function OO(t){return t*Ve/180}function LO(t){return t*180/Ve}function Qm(t,e,n){return new b(t.x,t.y).add(b.FromAngle(n,e))}function jf(t,e,n){const s=t/2,r=e/2,i=[];let o=1/0,a=-1/0,c=1/0,l=-1/0;for(let g=0;g<n;g++){const x=at/n,y=-vt+g*x,m=s+s*Math.cos(y),S=r+r*Math.sin(y);m<o&&(o=m),S<c&&(c=S),m>a&&(a=m),S>l&&(l=S),i.push(new b(m,S))}const u=a-o,d=l-c,p=t-u,f=e-d;if(p!==0||f!==0)for(let g=0;g<i.length;g++){const x=i[g];x.x=(x.x-o)/u*t,x.y=(x.y-c)/d*e}return i}function Oa(t,e,n,s){return t<s&&n<e}function Xs(t,e,n,s){const r=Math.max(t,n),i=Math.min(e,s);return r<=i?[r,i]:null}function aw(t,e,n){return(e.x-t.x)*(n.y-t.y)-(n.x-t.x)*(e.y-t.y)}function Bn(t,e){let n=0,s,r;for(let i=0;i<e.length;i++){if(s=e[i],s.x===t.x&&s.y===t.y||(r=e[(i+1)%e.length],b.Dist(t,s)+b.Dist(t,r)===b.Dist(s,r)))return!0;s.y<=t.y?r.y>t.y&&aw(s,r,t)>0&&(n+=1):r.y<=t.y&&aw(s,r,t)<0&&(n-=1)}return n!==0}function F(t){return Math.round(t*1e4)/1e4}function Xr(t){return Math.round(t*100)/100}const cw=t=>Math.abs(t)<Number.MAX_SAFE_INTEGER;function lw(t,e,n,s){let r;if(Math.abs(t)>Ve){r=id(e,s);const i=id(s,n);return Math.abs(r)<Math.abs(i)?r/t:(t-i)/t}else{r=id(e,s);const i=r/t;return Math.sign(r)!==Math.sign(t)?Math.abs(i)>.5?1:0:i}}function RO(t,e,n,s){const r=2*((e-t)%at)%at-(e-t)%at;return s?(at-Math.abs(r))*(n?1:-1):r}function wP(t,e,n){const s=-2*(t.x*(e.y-n.y)-t.y*(e.x-n.x)+e.x*n.y-n.x*e.y),r=((t.x*t.x+t.y*t.y)*(n.y-e.y)+(e.x*e.x+e.y*e.y)*(t.y-n.y)+(n.x*n.x+n.y*n.y)*(e.y-t.y))/s,i=((t.x*t.x+t.y*t.y)*(e.x-n.x)+(e.x*e.x+e.y*e.y)*(n.x-t.x)+(n.x*n.x+n.y*n.y)*(t.x-e.x))/s;return!Number.isFinite(r)||!Number.isFinite(i)?null:new b(r,i)}const Df=({brush:t,color:e,opacity:n,className:s})=>{const r=v.useRef(null);qc(r,t.x,t.y);const i=F(Math.max(1,t.w)),o=F(Math.max(1,t.h));return h.jsx("svg",{className:"tl-overlays__item",ref:r,"aria-hidden":"true",children:e?h.jsxs("g",{className:"tl-brush",opacity:n,children:[h.jsx("rect",{width:i,height:o,fill:e,opacity:.75}),h.jsx("rect",{width:i,height:o,fill:"none",stroke:e,opacity:.1})]}):h.jsx("rect",{className:`tl-brush tl-brush__default ${s}`,width:i,height:o})})};var Of={exports:{}};var dw;function FO(){return dw||(dw=1,(function(t){(function(){var e={}.hasOwnProperty;function n(){for(var i="",o=0;o<arguments.length;o++){var a=arguments[o];a&&(i=r(i,s(a)))}return i}function s(i){if(typeof i=="string"||typeof i=="number")return i;if(typeof i!="object")return"";if(Array.isArray(i))return n.apply(null,i);if(i.toString!==Object.prototype.toString&&!i.toString.toString().includes("[native code]"))return i.toString();var o="";for(var a in i)e.call(i,a)&&i[a]&&(o=r(o,a));return o}function r(i,o){return o?i?i+" "+o:i+o:i}t.exports?(n.default=n,t.exports=n):window.classNames=n})()})(Of)),Of.exports}var BO=FO();const de=lo(BO),qe={isSafari:!1,isIos:!1,isChromeForIos:!1,isFirefox:!1,isAndroid:!1,isDarwin:!1,hasCanvasSupport:!1};let vP=!1;typeof window<"u"&&("navigator"in window&&(qe.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),qe.isIos=!!navigator.userAgent.match(/iPad/i)||!!navigator.userAgent.match(/iPhone/i),qe.isChromeForIos=/crios.*safari/i.test(navigator.userAgent),qe.isFirefox=/firefox/i.test(navigator.userAgent),qe.isAndroid=/android/i.test(navigator.userAgent),qe.isDarwin=window.navigator.userAgent.toLowerCase().indexOf("mac")>-1),qe.hasCanvasSupport="Promise"in window&&"HTMLCanvasElement"in window,vP=qe.isFirefox&&!qe.isAndroid&&!qe.isIos);const uc=je("tlenvReactive",{isCoarsePointer:!1});if(typeof window<"u"&&!vP){const t=window.matchMedia&&window.matchMedia("(any-pointer: coarse)"),e=()=>uc.__unsafe__getWithoutCapture().isCoarsePointer;if(t){const n=()=>{const s=t.matches;s!==e()&&uc.update(r=>({...r,isCoarsePointer:s}))};n(),t.addEventListener("change",n)}window.addEventListener("pointerdown",n=>{const s=n.pointerType!=="mouse";s!==e()&&uc.update(r=>({...r,isCoarsePointer:s}))},{capture:!0})}const uw={isLocked:!1,wheelBehavior:"pan",panSpeed:1,zoomSpeed:1,zoomSteps:[.05,.1,.25,.5,1,2,4,8]},Lf={duration:0,easing:Pn.easeInOutCubic},PP={CAMERA_MOVE:-10},zO=["top","right","bottom","left"],hw=0,ey=2,Al=1,pw=5;var Rf={};const $O={},IP=xn("pointerCaptureTrackingObject",{defaults:{all:new Map},shouldStoreForSession:!1}),mt={logPreventDefaults:xn("logPreventDefaults",{defaults:{all:!1}}),logPointerCaptures:xn("logPointerCaptures",{defaults:{all:!1}}),logElementRemoves:xn("logElementRemoves",{defaults:{all:!1}}),debugSvg:xn("debugSvg",{defaults:{all:!1}}),showFps:xn("showFps",{defaults:{all:!1}}),measurePerformance:xn("measurePerformance",{defaults:{all:!1}}),throwToBlob:xn("throwToBlob",{defaults:{all:!1}}),reconnectOnPing:xn("reconnectOnPing",{defaults:{all:!1}}),debugCursors:xn("debugCursors",{defaults:{all:!1}}),forceSrgb:xn("forceSrgbColors",{defaults:{all:!1}}),debugGeometry:xn("debugGeometry",{defaults:{all:!1}}),hideShapes:xn("hideShapes",{defaults:{all:!1}}),editOnType:xn("editOnType",{defaults:{all:!1}}),a11y:xn("a11y",{defaults:{all:!1}}),debugElbowArrows:xn("debugElbowArrows",{defaults:{all:!1}})};if(typeof Element<"u"){const t=Element.prototype.removeChild;is("element removal logging",()=>{mt.logElementRemoves.get()?Element.prototype.removeChild=function(e){return console.warn("[tldraw] removing child:",e),t.call(this,e)}:Element.prototype.removeChild=t})}function xn(t,{defaults:e,shouldStoreForSession:n=!0}){return NO({name:t,defaults:e,shouldStoreForSession:n})}function NO(t){const e=HO(t),n=t.shouldStoreForSession?UO(t.name):null,s=je(`debug:${t.name}`,n??e);return typeof window<"u"&&(t.shouldStoreForSession&&is(`debug:${t.name}`,()=>{const r=s.get();r===e?j0(`tldraw_debug:${t.name}`):ym(`tldraw_debug:${t.name}`,JSON.stringify(r))}),Object.defineProperty(window,`tldraw${t.name.replace(/^[a-z]/,r=>r.toUpperCase())}`,{get(){return s.get()},set(r){s.set(r)},configurable:!0})),Object.assign(s,t,{reset:()=>s.set(e)})}function UO(t){try{return JSON.parse(M0(`tldraw_debug:${t}`)??"null")}catch{return null}}function Ff(t){try{return t()}catch{return null}}function HO(t){switch(Ff(()=>Rf.TLDRAW_ENV)??Ff(()=>Rf.VERCEL_PUBLIC_TLDRAW_ENV)??Ff(()=>Rf.NEXT_PUBLIC_TLDRAW_ENV)??"production"){case"production":return t.defaults.production??t.defaults.all;case"preview":case"staging":return t.defaults.staging??t.defaults.all;default:return t.defaults.development??t.defaults.all}}function Md(t){if(t.nodeType===Node.ELEMENT_NODE)return t;if(t.parentElement)return Md(t.parentElement);throw Error("Could not find a parent element of an HTML type!")}function Pe(t){t.preventDefault(),mt.logPreventDefaults.get()&&console.warn("preventDefault called on event:",t)}function Gc(t,e){if(t.setPointerCapture(e.pointerId),mt.logPointerCaptures.get()){const n=IP.get();n.set(t,(n.get(t)??0)+1),console.warn("setPointerCapture called on element:",t,e)}}function Yc(t,e){if(t.hasPointerCapture(e.pointerId)&&(t.releasePointerCapture(e.pointerId),mt.logPointerCaptures.get())){const n=IP.get();n.get(t)===1?n.delete(t):n.has(t)?n.set(t,n.get(t)-1):console.warn("Release without capture"),console.warn("releasePointerCapture called on element:",t,e)}}const bn=(t,e,n)=>{t&&t.style.setProperty(e,n)};function _P(t=!1){const{activeElement:e}=document,n=t?["input","textarea"]:["input","select","button","textarea"];return!!(e&&(e.isContentEditable||n.indexOf(e.tagName.toLowerCase())>-1||e.classList.contains("tlui-slider__thumb")))}const At=t=>qe.isDarwin?t.metaKey:t.ctrlKey||t.metaKey;function cn(t,e){return t.markEventAsHandled(e),{point:{x:e.clientX,y:e.clientY,z:e.pressure},shiftKey:e.shiftKey,altKey:e.altKey,ctrlKey:e.metaKey||e.ctrlKey,metaKey:e.metaKey,accelKey:At(e),pointerId:e.pointerId,button:e.button,isPen:e.pointerType==="pen"}}function ty(t,e){return au(`${t}_${e}`)}function yo(t){return au(`${v.useId()}${t??""}`)}function tr(t){const e=Gt(v.useContext(CP));return au(`${e}_${t}`)}function au(t){return t.replace(/:/g,"_")}const CP=v.createContext(null);function KO({children:t}){const e=yo();return h.jsx(CP.Provider,{value:e,children:t})}const ny=v.createContext(null);function z(){const t=Ye.useContext(ny);if(!t)throw new Error("useEditor must be used inside of the <Tldraw /> or <TldrawEditor /> components");return t}function Tt(){return Ye.useContext(ny)}function sy({editor:t,children:e}){return h.jsx(ny.Provider,{value:t,children:h.jsx(KO,{children:e})})}function cu(){const t=z(),e=t.getContainer().ownerDocument,n=$("current tool",()=>t.getCurrentTool(),[t]),s=v.useMemo(function(){function i(g){if(!t.wasEventAlreadyHandled(g)){if(g.button===ey){t.dispatch({type:"pointer",target:"canvas",name:"right_click",...cn(t,g)});return}g.button!==0&&g.button!==1&&g.button!==5||(Gc(g.currentTarget,g),t.dispatch({type:"pointer",target:"canvas",name:"pointer_down",...cn(t,g)}))}}function o(g){t.wasEventAlreadyHandled(g)||g.button!==0&&g.button!==1&&g.button!==2&&g.button!==5||(Yc(g.currentTarget,g),t.dispatch({type:"pointer",target:"canvas",name:"pointer_up",...cn(t,g)}))}function a(g){if(t.wasEventAlreadyHandled(g)||t.getInstanceState().isPenMode&&g.pointerType!=="pen")return;const x=g.pointerType==="mouse"||g.pointerType==="pen";t.updateInstanceState({isHoveringCanvas:x?!0:null})}function c(g){if(t.wasEventAlreadyHandled(g)||t.getInstanceState().isPenMode&&g.pointerType!=="pen")return;const x=g.pointerType==="mouse"||g.pointerType==="pen";t.updateInstanceState({isHoveringCanvas:x?!1:null})}function l(g){t.wasEventAlreadyHandled(g)||(t.markEventAsHandled(g),Pe(g))}function u(g){if(t.wasEventAlreadyHandled(g)||(t.markEventAsHandled(g),!(g.target instanceof HTMLElement)))return;const x=t.getEditingShape()?.id;!(x&&g.target.closest(`[data-shape-id="${x}"]`))&&g.target.tagName!=="A"&&g.target.tagName!=="TEXTAREA"&&!g.target.isContentEditable&&Pe(g)}function d(g){t.wasEventAlreadyHandled(g)||Pe(g)}async function p(g){if(t.wasEventAlreadyHandled(g))return;if(Pe(g),g.stopPropagation(),g.dataTransfer?.files?.length){const y=Array.from(g.dataTransfer.files);await t.putExternalContent({type:"files",files:y,point:t.screenToPage({x:g.clientX,y:g.clientY})});return}const x=g.dataTransfer.getData("url");if(x){await t.putExternalContent({type:"url",url:x,point:t.screenToPage({x:g.clientX,y:g.clientY})});return}}function f(g){t.wasEventAlreadyHandled(g)||g.stopPropagation()}return{onPointerDown:i,onPointerUp:o,onPointerEnter:a,onPointerLeave:c,onDragOver:d,onDrop:p,onTouchStart:l,onTouchEnd:u,onClick:f}},[t]);return v.useEffect(()=>{let r,i;function o(a){if(t.wasEventAlreadyHandled(a)||(t.markEventAsHandled(a),a.clientX===r&&a.clientY===i))return;r=a.clientX,i=a.clientY;const c=!qe.isIos&&n.useCoalescedEvents&&a.getCoalescedEvents?a.getCoalescedEvents():[a];for(const l of c)t.dispatch({type:"pointer",target:"canvas",name:"pointer_move",...cn(t,l)})}return e.body.addEventListener("pointermove",o),()=>{e.body.removeEventListener("pointermove",o)}},[t,n,e]),s}function WO(){const t=z();Qd("coarse pointer change",()=>{const e=uc.get().isCoarsePointer,n=Yi(()=>t.getInstanceState().isCoarsePointer);e!==n&&t.updateInstanceState({isCoarsePointer:e})},[t])}const TP=v.createContext(null);function EP({container:t,children:e}){return h.jsx(TP.Provider,{value:t,children:e})}function Lt(){return Gt(v.useContext(TP),"useContainer used outside of <Tldraw />")}function qO(){const t=z(),e=Lt(),n=$("isEditing",()=>t.getEditingShapeId(),[t]),s=$("isFocused",()=>t.getIsFocused(),[t]);v.useEffect(()=>{if(!e)return;function r(i){if(i.isSpecialRedispatchedEvent)return;Pe(i),i.stopPropagation();const o=e.querySelector(".tl-canvas");if(!o)return;const a=new DragEvent(i.type,i);a.isSpecialRedispatchedEvent=!0,o.dispatchEvent(a)}return e.addEventListener("dragover",r),e.addEventListener("drop",r),()=>{e.removeEventListener("dragover",r),e.removeEventListener("drop",r)}},[e]),v.useEffect(()=>{if(typeof window>"u"||!("matchMedia"in window))return;let r=null;const i=()=>{r?.();const o=`(resolution: ${window.devicePixelRatio}dppx)`,a=matchMedia(o),c=l=>{l.type==="change"&&i()};a.addEventListener?a.addEventListener("change",i):a.addListener&&a.addListener(c),r=()=>{a.removeEventListener?a.removeEventListener("change",i):a.removeListener&&a.removeListener(c)},t.updateInstanceState({devicePixelRatio:window.devicePixelRatio})};return i(),()=>{r?.()}},[t]),v.useEffect(()=>{if(!s)return;const r=c=>{if(c.altKey&&(t.isIn("zoom")||!t.getPath().endsWith(".idle"))&&!La(t)&&Pe(c),t.wasEventAlreadyHandled(c))return;t.markEventAsHandled(c);const l=!!t.getSelectedShapeIds().length;switch(c.key){case"=":case"-":case"0":{if(c.metaKey||c.ctrlKey){Pe(c);return}break}case"Tab":{if(La(t))return;l&&!n&&Pe(c);break}case"ArrowLeft":case"ArrowRight":case"ArrowUp":case"ArrowDown":{if(La(t))return;l&&(c.metaKey||c.ctrlKey)&&Pe(c);break}case",":return;case"Escape":{if((t.getEditingShape()||t.getSelectedShapeIds().length>0)&&Pe(c),t.menus.getOpenMenus().length>0)return;t.inputs.keys.has("Escape")||(t.inputs.keys.add("Escape"),t.cancel(),e.focus());return}default:if(La(t))return}const u={type:"keyboard",name:c.repeat?"key_repeat":"key_down",key:c.key,code:c.code,shiftKey:c.shiftKey,altKey:c.altKey,ctrlKey:c.metaKey||c.ctrlKey,metaKey:c.metaKey,accelKey:At(c)};t.dispatch(u)},i=c=>{if(t.wasEventAlreadyHandled(c)||(t.markEventAsHandled(c),La(t))||c.key===",")return;const l={type:"keyboard",name:"key_up",key:c.key,code:c.code,shiftKey:c.shiftKey,altKey:c.altKey,ctrlKey:c.metaKey||c.ctrlKey,metaKey:c.metaKey,accelKey:At(c)};t.dispatch(l)};function o(c){if(e.contains(c.target)){const l=c.touches[0].pageX,u=c.touches[0].radiusX||0;(l-u<10||l+u>t.getViewportScreenBounds().width-10)&&(c.target?.tagName==="BUTTON"&&c.target?.click(),Pe(c))}}const a=c=>{e.contains(c.target)&&(c.ctrlKey||c.metaKey)&&Pe(c)};return e.addEventListener("touchstart",o,{passive:!1}),e.addEventListener("wheel",a,{passive:!1}),document.addEventListener("gesturestart",Pe),document.addEventListener("gesturechange",Pe),document.addEventListener("gestureend",Pe),e.addEventListener("keydown",r),e.addEventListener("keyup",i),()=>{e.removeEventListener("touchstart",o),e.removeEventListener("wheel",a),document.removeEventListener("gesturestart",Pe),document.removeEventListener("gesturechange",Pe),document.removeEventListener("gestureend",Pe),e.removeEventListener("keydown",r),e.removeEventListener("keyup",i)}},[t,e,s,n])}function La(t){return t.menus.hasOpenMenus()||_P()}function GO({className:t,zoom:e,point:n,color:s,viewport:r,opacity:i=1}){const o=v.useRef(null);qc(o,Ce(n.x,r.minX+5/e,r.maxX-5/e),Ce(n.y,r.minY+5/e,r.maxY-5/e),1/e,b.Angle(r.center,n));const a=tr("cursor_hint");return h.jsxs("svg",{ref:o,className:de("tl-overlays__item",t),"aria-hidden":"true",children:[h.jsx("use",{href:`#${a}`,color:s,strokeWidth:3,stroke:"var(--tl-color-background)"}),h.jsx("use",{href:`#${a}`,color:s,opacity:i})]})}const fw=v.memo(function({className:e,zoom:n,point:s,color:r,name:i,chatMessage:o}){const a=v.useRef(null);qc(a,s?.x,s?.y,1/n);const c=tr("cursor");return s?h.jsxs("div",{ref:a,className:de("tl-overlays__item",e),children:[h.jsx("svg",{className:"tl-cursor","aria-hidden":"true",children:h.jsx("use",{href:`#${c}`,color:r})}),o?h.jsxs(h.Fragment,{children:[i&&h.jsx("div",{className:"tl-nametag-title",style:{color:r},children:i}),h.jsx("div",{className:"tl-nametag-chat",style:{backgroundColor:r},children:o})]}):i&&h.jsx("div",{className:"tl-nametag",style:{backgroundColor:r},children:i})]}):null}),Vc={openWindow(t,e,n=!1){return window.open(t,e,n?"noopener":"noopener noreferrer")},refreshPage(){window.location.reload()},async hardReset(){return await window.__tldraw__hardReset?.()}};function kP(){Vc.hardReset()}function YO(){Vc.refreshPage()}const VO={error:null};class ry extends v.Component{static getDerivedStateFromError(e){return{error:e}}state=VO;componentDidCatch(e){this.props.onError?.(e)}render(){const{error:e}=this.state;if(e!==null){const{fallback:n}=this.props;return h.jsx(n,{error:e})}return this.props.children}}function Pc({children:t,fallback:e,...n}){return e===null?t:h.jsx(ry,{fallback:e,...n,children:t})}const XO="https://github.com/tldraw/tldraw/issues/new",AP=({error:t,editor:e})=>{const n=v.useRef(null),[s,r]=v.useState(!1),[i,o]=v.useState(!1),[a,c]=v.useState(!1);let l=null;try{l=nt().Canvas??null}catch{}const u=t instanceof Error?t.message:String(t),d=t instanceof Error?t.stack:null,p=$("isDarkMode",()=>{try{if(e)return e.user.getIsDarkMode()}catch{}return null},[e]),[f,g]=v.useState(null);v.useLayoutEffect(()=>{p!==null&&g(p);let w=n.current?.parentElement,P=!1;for(;w;){if(w.classList.contains("tl-theme__dark")||w.classList.contains("tl-theme__light")){P=!0;break}w=w.parentElement}if(P){g(null);return}typeof window<"u"&&window.matchMedia&&g(window.matchMedia("(prefers-color-scheme: dark)").matches)},[p]),v.useEffect(()=>{if(i){const w=e?.timers.setTimeout(()=>{o(!1)},2e3);return()=>clearTimeout(w)}},[i,e]);const x=()=>{const w=document.createElement("textarea");w.value=d??u,document.body.appendChild(w),w.select(),document.execCommand("copy"),w.remove(),o(!0)},y=()=>{YO()},m=async()=>{kP()},S=new URL(XO);return S.searchParams.set("title",u),S.searchParams.set("labels","bug"),S.searchParams.set("body",`Hey, I ran into an error while using tldraw:

\`\`\`js
${d??u}
\`\`\`

My browser: ${navigator.userAgent}`),h.jsxs("div",{ref:n,className:de("tl-container tl-error-boundary",f===null?"":f?"tl-theme__dark":"tl-theme__light"),children:[h.jsx("div",{className:"tl-error-boundary__overlay"}),e&&h.jsx(ry,{onError:yc,fallback:()=>null,children:h.jsx(sy,{editor:e,children:h.jsx("div",{className:"tl-overlay tl-error-boundary__canvas",children:l?h.jsx(l,{}):null})})}),h.jsx("div",{className:de("tl-modal","tl-error-boundary__content",{"tl-error-boundary__content__expanded":s&&!a}),children:a?h.jsxs(h.Fragment,{children:[h.jsx("h2",{children:"Are you sure?"}),h.jsx("p",{children:"Resetting your data will delete your drawing and cannot be undone."}),h.jsxs("div",{className:"tl-error-boundary__content__actions",children:[h.jsx("button",{className:"tlui-button",onClick:()=>c(!1),children:"Cancel"}),h.jsx("button",{className:"tlui-button tl-error-boundary__reset",onClick:m,children:"Reset data"})]})]}):h.jsxs(h.Fragment,{children:[h.jsx("h2",{children:"Something went wrong"}),h.jsx("p",{children:"Please refresh your browser."}),h.jsx("p",{children:"If the issue continues after refreshing, you may need to reset the tldraw data stored on your device."}),h.jsxs("p",{children:[h.jsx("strong",{children:"Note:"})," Resetting will erase your current project and any unsaved work."]}),!1,s&&h.jsxs(h.Fragment,{children:["Message:",h.jsx("h4",{children:h.jsx("code",{children:u})}),"Stack trace:",h.jsxs("div",{className:"tl-error-boundary__content__error",children:[h.jsx("pre",{children:h.jsx("code",{children:d??u})}),h.jsx("button",{className:"tlui-button",onClick:x,children:i?"Copied!":"Copy"})]})]}),h.jsxs("div",{className:"tl-error-boundary__content__actions",children:[h.jsx("button",{className:"tlui-button",onClick:()=>r(!s),children:s?"Hide details":"Show details"}),h.jsxs("div",{className:"tl-error-boundary__content__actions__group",children:[h.jsx("button",{className:"tlui-button tl-error-boundary__reset",onClick:()=>c(!0),children:"Reset data"}),h.jsx("button",{className:"tlui-button tl-error-boundary__refresh",onClick:y,children:"Refresh Page"})]})]})]})})]})};function ZO({x:t,y:e,z:n,size:s}){const r=yo("grid"),i=z(),{gridSteps:o}=i.options;return h.jsxs("svg",{className:"tl-grid",version:"1.1",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[h.jsx("defs",{children:o.map(({min:a,mid:c,step:l},u)=>{const d=l*s*n,p=.5+t*n,f=.5+e*n,g=p>0?p%d:d+p%d,x=f>0?f%d:d+f%d,y=n<c?sr(n,[a,c],[0,1]):1;return h.jsx("pattern",{id:ty(r,`${l}`),width:d,height:d,patternUnits:"userSpaceOnUse",children:h.jsx("circle",{className:"tl-grid-dot",cx:g,cy:x,r:1,opacity:y})},u)})}),o.map(({step:a},c)=>h.jsx("rect",{width:"100%",height:"100%",fill:`url(#${r}_${a})`},c))]})}function JO({handle:t,isCoarse:e,className:n,zoom:s}){const r=z(),i=(e?r.options.coarseHandleRadius:r.options.handleRadius)/s;if(t.type==="clone"){const a=3/s,c=`M0,${-a} A${a},${a} 0 0,1 0,${a}`,l=zO.indexOf(t.id);return h.jsxs("g",{className:de(`tl-handle tl-handle__${t.type}`,n),children:[h.jsx("circle",{className:"tl-handle__bg",r:i}),h.jsx("path",{className:"tl-handle__fg",d:c,transform:`rotate(${-90+90*l})`})]})}const o=(t.type==="create"&&e?3:4)/Math.max(s,.25);return h.jsxs("g",{className:de(`tl-handle tl-handle__${t.type}`,n),children:[h.jsx("circle",{className:"tl-handle__bg",r:i}),h.jsx("circle",{className:"tl-handle__fg",r:o})]})}const QO=({children:t})=>h.jsx("svg",{className:"tl-user-handles tl-overlays__item","aria-hidden":"true",children:t}),iy="4.3.1",gw={major:"2025-09-18T14:39:22.803Z",minor:"2026-01-21T11:56:39.106Z"};function MP(t,e){const n=v.useRef(t);return e(t,n.current)?n.current:(n.current=t,t)}const eL=(t,e)=>(t??=null,e??=null,t===e?!0:!t||!e?!1:ud(t,e));function vi(t){return MP(t,eL)}const tL=(t,e)=>(t??=null,e??=null,t===e?!0:!t||!e?!1:I0(t,e));function ma(t){return MP(t,tL)}const jP="TLDRAW_USER_DATA_v3",DP=Ne({id:De,name:De.nullable().optional(),color:De.nullable().optional(),locale:De.nullable().optional(),animationSpeed:Te.nullable().optional(),areKeyboardShortcutsEnabled:Le.nullable().optional(),edgeScrollSpeed:Te.nullable().optional(),colorScheme:to("light","dark","system").optional(),isSnapMode:Le.nullable().optional(),isWrapMode:Le.nullable().optional(),isDynamicSizeMode:Le.nullable().optional(),isPasteAtCursorMode:Le.nullable().optional(),enhancedA11yMode:Le.nullable().optional(),inputMode:to("trackpad","mouse").nullable().optional()}),fs={AddAnimationSpeed:1,AddIsSnapMode:2,MakeFieldsNullable:3,AddEdgeScrollSpeed:4,AddExcalidrawSelectMode:5,AddDynamicSizeMode:6,AllowSystemColorScheme:7,AddPasteAtCursor:8,AddKeyboardShortcuts:9,AddShowUiLabels:10,AddPointerPeripheral:11,RenameShowUiLabelsToEnhancedA11yMode:12},oy=Math.max(...Object.values(fs));function nL(t){t.version<fs.AddAnimationSpeed&&(t.user.animationSpeed=1),t.version<fs.AddIsSnapMode&&(t.user.isSnapMode=!1),t.version<fs.MakeFieldsNullable,t.version<fs.AddEdgeScrollSpeed&&(t.user.edgeScrollSpeed=1),t.version<fs.AddExcalidrawSelectMode&&(t.user.isWrapMode=!1),t.version<fs.AllowSystemColorScheme&&(t.user.isDarkMode===!0?t.user.colorScheme="dark":t.user.isDarkMode===!1&&(t.user.colorScheme="light"),delete t.user.isDarkMode),t.version<fs.AddDynamicSizeMode&&(t.user.isDynamicSizeMode=!1),t.version<fs.AddPasteAtCursor&&(t.user.isPasteAtCursorMode=!1),t.version<fs.AddKeyboardShortcuts&&(t.user.areKeyboardShortcutsEnabled=!0),t.version<fs.AddShowUiLabels&&(t.user.showUiLabels=!1),t.version<fs.RenameShowUiLabelsToEnhancedA11yMode&&(t.user.enhancedA11yMode=t.user.showUiLabels,delete t.user.showUiLabels),t.version<fs.AddPointerPeripheral&&(t.user.inputMode=null),t.version=oy}const Tg=["#FF802B","#EC5E41","#F2555A","#F04F88","#E34BA9","#BD54C6","#9D5BD2","#7B66DC","#02B1CC","#11B3A3","#39B178","#55B467"];function OP(){return Tg[Math.floor(Math.random()*Tg.length)]}function sL(){return typeof window<"u"&&window.matchMedia?window.matchMedia?.("(prefers-reduced-motion: reduce)")?.matches??!1:!1}const Jn=Object.freeze({name:"",locale:CO(),color:OP(),edgeScrollSpeed:1,animationSpeed:sL()?0:1,areKeyboardShortcutsEnabled:!0,isSnapMode:!1,isWrapMode:!1,isDynamicSizeMode:!1,isPasteAtCursorMode:!1,enhancedA11yMode:!1,colorScheme:"light",inputMode:null});function Bf(){return{id:Ge(),color:OP()}}function LP(t){if(t===null||typeof t!="object"||!("version"in t)||!("user"in t)||typeof t.version!="number")return Bf();const e=wt(t);nL(e);try{return DP.validate(e.user)}catch{return Bf()}}function rL(){const t=JSON.parse(gm(jP)||"null")??null;return LP(t)}const lu=je("globalUserData",null);function iL(){mm(jP,JSON.stringify({version:oy,user:lu.get()}))}function RP(t){DP.validate(t),lu.set(t),iL(),oL()}const FP=typeof BroadcastChannel<"u"?new BroadcastChannel("tldraw-user-sync"):null;FP?.addEventListener("message",t=>{const e=t.data;e?.type===zP&&e?.origin!==BP()&&lu.set(LP(e.data))});let zf=null;function BP(){return zf===null&&(zf=Ge()),zf}const zP="tldraw-user-preferences-change";function oL(){FP?.postMessage({type:zP,origin:BP(),data:{user:$P(),version:oy}})}function $P(){let t=lu.get();return t||(t=rL(),RP(t)),t}const aL=K("defaultLocalStorageUserPrefs",()=>$P());function NP(t={}){return{userPreferences:t.userPreferences??aL,setUserPreferences:t.setUserPreferences??RP}}var $f={exports:{}},mw;function cL(){return mw||(mw=1,(function(t){var e=Object.prototype.hasOwnProperty,n="~";function s(){}Object.create&&(s.prototype=Object.create(null),new s().__proto__||(n=!1));function r(c,l,u){this.fn=c,this.context=l,this.once=u||!1}function i(c,l,u,d,p){if(typeof u!="function")throw new TypeError("The listener must be a function");var f=new r(u,d||c,p),g=n?n+l:l;return c._events[g]?c._events[g].fn?c._events[g]=[c._events[g],f]:c._events[g].push(f):(c._events[g]=f,c._eventsCount++),c}function o(c,l){--c._eventsCount===0?c._events=new s:delete c._events[l]}function a(){this._events=new s,this._eventsCount=0}a.prototype.eventNames=function(){var l=[],u,d;if(this._eventsCount===0)return l;for(d in u=this._events)e.call(u,d)&&l.push(n?d.slice(1):d);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(u)):l},a.prototype.listeners=function(l){var u=n?n+l:l,d=this._events[u];if(!d)return[];if(d.fn)return[d.fn];for(var p=0,f=d.length,g=new Array(f);p<f;p++)g[p]=d[p].fn;return g},a.prototype.listenerCount=function(l){var u=n?n+l:l,d=this._events[u];return d?d.fn?1:d.length:0},a.prototype.emit=function(l,u,d,p,f,g){var x=n?n+l:l;if(!this._events[x])return!1;var y=this._events[x],m=arguments.length,S,w;if(y.fn){switch(y.once&&this.removeListener(l,y.fn,void 0,!0),m){case 1:return y.fn.call(y.context),!0;case 2:return y.fn.call(y.context,u),!0;case 3:return y.fn.call(y.context,u,d),!0;case 4:return y.fn.call(y.context,u,d,p),!0;case 5:return y.fn.call(y.context,u,d,p,f),!0;case 6:return y.fn.call(y.context,u,d,p,f,g),!0}for(w=1,S=new Array(m-1);w<m;w++)S[w-1]=arguments[w];y.fn.apply(y.context,S)}else{var P=y.length,_;for(w=0;w<P;w++)switch(y[w].once&&this.removeListener(l,y[w].fn,void 0,!0),m){case 1:y[w].fn.call(y[w].context);break;case 2:y[w].fn.call(y[w].context,u);break;case 3:y[w].fn.call(y[w].context,u,d);break;case 4:y[w].fn.call(y[w].context,u,d,p);break;default:if(!S)for(_=1,S=new Array(m-1);_<m;_++)S[_-1]=arguments[_];y[w].fn.apply(y[w].context,S)}}return!0},a.prototype.on=function(l,u,d){return i(this,l,u,d,!1)},a.prototype.once=function(l,u,d){return i(this,l,u,d,!0)},a.prototype.removeListener=function(l,u,d,p){var f=n?n+l:l;if(!this._events[f])return this;if(!u)return o(this,f),this;var g=this._events[f];if(g.fn)g.fn===u&&(!p||g.once)&&(!d||g.context===d)&&o(this,f);else{for(var x=0,y=[],m=g.length;x<m;x++)(g[x].fn!==u||p&&!g[x].once||d&&g[x].context!==d)&&y.push(g[x]);y.length?this._events[f]=y.length===1?y[0]:y:o(this,f)}return this},a.prototype.removeAllListeners=function(l){var u;return l?(u=n?n+l:l,this._events[u]&&o(this,u)):(this._events=new s,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=n,a.EventEmitter=a,t.exports=a})($f)),$f.exports}var lL=cL();const dL=lo(lL),Vo="TLDRAW_TAB_ID_v2",ro=globalThis.window;function uL(){return ro?["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(ro.navigator.platform)||qe.isDarwin&&"ontouchend"in document:!1}const jd=ro?ro[Vo]??M0(Vo)??"TLDRAW_INSTANCE_STATE_V1_"+Ge():"<error>";ro&&(ro[Vo]=jd,uL()?ym(Vo,jd):j0(Vo));ro?.addEventListener("beforeunload",()=>{ym(Vo,jd)});const UP={Initial:0},du=Math.max(...Object.values(UP));function hL(t){t.version<UP.Initial,t.version=du}const HP=Ne({version:Te,currentPageId:wc.optional(),isFocusMode:Le.optional(),exportBackground:Le.optional(),isDebugMode:Le.optional(),isToolLocked:Le.optional(),isGridMode:Le.optional(),pageStates:on(Ne({pageId:wc,camera:Ne({x:Te,y:Te,z:Te}).optional(),selectedShapeIds:on(Ds).optional(),focusedGroupId:Ds.nullable().optional()})).optional()});function pL(t){if(!t||typeof t!="object")return console.warn("Invalid instance state"),null;if(!("version"in t)||typeof t.version!="number")return console.warn("No version in instance state"),null;t.version!==du&&(t=wt(t),hL(t));try{return HP.validate(t)}catch(e){return console.warn(e),null}}function ay(t){const e=t.query.ids("page");return K("sessionStateSnapshot",()=>{const n=t.get(Fn);if(!n)return null;const s=[...e.get()];return{version:du,currentPageId:n.currentPageId,exportBackground:n.exportBackground,isFocusMode:n.isFocusMode,isDebugMode:n.isDebugMode,isToolLocked:n.isToolLocked,isGridMode:n.isGridMode,pageStates:s.map(r=>{const i=t.get(Qs.createId(r)),o=t.get(mr.createId(r));return{pageId:r,camera:{x:o?.x??0,y:o?.y??0,z:o?.z??1},selectedShapeIds:i?.selectedShapeIds??[],focusedGroupId:i?.focusedGroupId??null}})}},{isEqual:xr})}function Eg(t,e,n){const s=pL(e);if(!s)return;const r=q1(t.get(Fn)),i=n?.forceOverwrite?s:r,o=n?.forceOverwrite?r:s,a=t.schema.types.instance.create({id:Fn,...r,currentPageId:s.currentPageId,isDebugMode:i?.isDebugMode??o?.isDebugMode,isFocusMode:i?.isFocusMode??o?.isFocusMode,isToolLocked:i?.isToolLocked??o?.isToolLocked,isGridMode:i?.isGridMode??o?.isGridMode,exportBackground:i?.exportBackground??o?.exportBackground});t.atomic(()=>{for(const c of s.pageStates??[]){if(!t.has(c.pageId))continue;const l=mr.createId(c.pageId),u=Qs.createId(c.pageId),d=t.get(l),p=t.get(u);t.put([mr.create({id:l,x:c.camera?.x??d?.x,y:c.camera?.y??d?.y,z:c.camera?.z??d?.z}),Qs.create({id:u,pageId:c.pageId,selectedShapeIds:c.selectedShapeIds??p?.selectedShapeIds,focusedGroupId:c.focusedGroupId??p?.focusedGroupId})])}t.put([a]),t.ensureStoreIsUsable()})}function fL(t){const e=[];for(const r of Object.values(t))r.typeName?.match(/^(instance.*|pointer|camera)$/)&&e.push(r);const n=e.filter(r=>r.typeName==="instance"&&r.id!==Fn)[0];if(!n)return null;const s={version:du,currentPageId:n.currentPageId,exportBackground:!!n.exportBackground,isFocusMode:!!n.isFocusMode,isDebugMode:!!n.isDebugMode,isToolLocked:!!n.isToolLocked,isGridMode:!1,pageStates:e.filter(r=>r.typeName==="instance_page_state"&&r.instanceId===n.id).map(r=>{const i=t[r.cameraId]??{x:0,y:0,z:1};return{pageId:r.pageId,camera:{x:i.x,y:i.y,z:i.z},selectedShapeIds:r.selectedShapeIds,focusedGroupId:r.focusedGroupId}})};try{return HP.validate(s),s}catch{return null}}function KP(t,e,n){let s={};if("store"in e){const o=t.schema.migrateStoreSnapshot(e);if(o.type!=="success")throw new Error("Failed to migrate store snapshot: "+o.reason);s.document={schema:t.schema.serialize(),store:cc(o.value,(a,{typeName:c})=>t.scopedTypes.document.has(c))}}else s=e;const r=q1(t.get(Fn)),i=WP.get(t,ay).get();t.atomic(()=>{s.document&&t.loadStoreSnapshot(s.document),r&&t.update(Fn,o=>({...o,...r})),i&&Eg(t,i),s.session&&Eg(t,s.session,{forceOverwrite:n?.forceOverwriteSessionState})})}const WP=new dn;function gL(t){const n=WP.get(t,ay).get();if(!n)throw new Error("Session state is not ready yet");return{document:t.getStoreSnapshot(),session:n}}function qP(t){const e=[],n=new Set;for(const s of t){if(n.has(s.type))throw new Error(`Binding type "${s.type}" is defined more than once`);e.push(s),n.add(s.type)}return e}function ki({children:t,className:e="",...n}){return h.jsx("svg",{...n,className:de("tl-svg-container",e),"aria-hidden":"true",children:t})}class X{constructor(e=0,n=0,s=0,r=0){this.x=e,this.y=n,this.w=s,this.h=r}x=0;y=0;w=0;h=0;get point(){return new b(this.x,this.y)}set point(e){this.x=e.x,this.y=e.y}get minX(){return this.x}set minX(e){this.x=e}get left(){return this.x}get midX(){return this.x+this.w/2}get maxX(){return this.x+this.w}get right(){return this.x+this.w}get minY(){return this.y}set minY(e){this.y=e}get top(){return this.y}get midY(){return this.y+this.h/2}get maxY(){return this.y+this.h}get bottom(){return this.y+this.h}get width(){return this.w}set width(e){this.w=e}get height(){return this.h}set height(e){this.h=e}get aspectRatio(){return this.width/this.height}get center(){return new b(this.x+this.w/2,this.y+this.h/2)}set center(e){this.x=e.x-this.w/2,this.y=e.y-this.h/2}get corners(){return[new b(this.x,this.y),new b(this.x+this.w,this.y),new b(this.x+this.w,this.y+this.h),new b(this.x,this.y+this.h)]}get cornersAndCenter(){return[new b(this.x,this.y),new b(this.x+this.w,this.y),new b(this.x+this.w,this.y+this.h),new b(this.x,this.y+this.h),new b(this.x+this.w/2,this.y+this.h/2)]}get sides(){const{corners:e}=this;return[[e[0],e[1]],[e[1],e[2]],[e[2],e[3]],[e[3],e[0]]]}get size(){return new b(this.w,this.h)}isValid(){return Number.isFinite(this.x)&&Number.isFinite(this.y)&&Number.isFinite(this.w)&&Number.isFinite(this.h)}toFixed(){return this.x=kl(this.x),this.y=kl(this.y),this.w=kl(this.w),this.h=kl(this.h),this}setTo(e){return this.x=e.x,this.y=e.y,this.w=e.w,this.h=e.h,this}set(e=0,n=0,s=0,r=0){return this.x=e,this.y=n,this.w=s,this.h=r,this}expand(e){const n=Math.min(this.x,e.x),s=Math.min(this.y,e.y),r=Math.max(this.x+this.w,e.x+e.w),i=Math.max(this.y+this.h,e.y+e.h);return this.x=n,this.y=s,this.w=r-n,this.h=i-s,this}expandBy(e){return this.x-=e,this.y-=e,this.w+=e*2,this.h+=e*2,this}scale(e){return this.x/=e,this.y/=e,this.w/=e,this.h/=e,this}clone(){const{x:e,y:n,w:s,h:r}=this;return new X(e,n,s,r)}translate(e){return this.x+=e.x,this.y+=e.y,this}snapToGrid(e){const n=Math.round(this.x/e)*e,s=Math.round(this.y/e)*e,r=Math.round((this.x+this.w)/e)*e,i=Math.round((this.y+this.h)/e)*e;this.minX=n,this.minY=s,this.width=Math.max(1,r-n),this.height=Math.max(1,i-s)}collides(e){return X.Collides(this,e)}contains(e){return X.Contains(this,e)}includes(e){return X.Includes(this,e)}containsPoint(e,n=0){return X.ContainsPoint(this,e,n)}getHandlePoint(e){switch(e){case"top_left":return new b(this.x,this.y);case"top_right":return new b(this.x+this.w,this.y);case"bottom_left":return new b(this.x,this.y+this.h);case"bottom_right":return new b(this.x+this.w,this.y+this.h);case"top":return new b(this.x+this.w/2,this.y);case"right":return new b(this.x+this.w,this.y+this.h/2);case"bottom":return new b(this.x+this.w/2,this.y+this.h);case"left":return new b(this.x,this.y+this.h/2)}}toJson(){return{x:this.x,y:this.y,w:this.w,h:this.h}}resize(e,n,s){const{minX:r,minY:i,maxX:o,maxY:a}=this;let{minX:c,minY:l,maxX:u,maxY:d}=this;switch(e){case"left":case"top_left":case"bottom_left":{c+=n;break}case"right":case"top_right":case"bottom_right":{u+=n;break}}switch(e){case"top":case"top_left":case"top_right":{l+=s;break}case"bottom":case"bottom_left":case"bottom_right":{d+=s;break}}const p=(u-c)/(o-r),f=(d-l)/(a-i),g=p<0,x=f<0;if(g){const y=u;u=c,c=y}if(x){const y=d;d=l,l=y}this.minX=c,this.minY=l,this.width=Math.abs(u-c),this.height=Math.abs(d-l)}union(e){const n=Math.min(this.x,e.x),s=Math.min(this.y,e.y),r=Math.max(this.x+this.w,e.x+e.w),i=Math.max(this.y+this.h,e.y+e.h);return this.x=n,this.y=s,this.width=r-n,this.height=i-s,this}static From(e){return new X(e.x,e.y,e.w,e.h)}static FromCenter(e,n){return new X(e.x-n.x/2,e.y-n.y/2,n.x,n.y)}static FromPoints(e){if(e.length===0)return new X;let n=1/0,s=1/0,r=-1/0,i=-1/0,o;for(let a=0,c=e.length;a<c;a++)o=e[a],n=Math.min(o.x,n),s=Math.min(o.y,s),r=Math.max(o.x,r),i=Math.max(o.y,i);return new X(n,s,r-n,i-s)}static Expand(e,n){const s=Math.min(n.minX,e.minX),r=Math.min(n.minY,e.minY),i=Math.max(n.maxX,e.maxX),o=Math.max(n.maxY,e.maxY);return new X(s,r,i-s,o-r)}static ExpandBy(e,n){return new X(e.minX-n,e.minY-n,e.width+n*2,e.height+n*2)}static Collides(e,n){return!(e.maxX<n.minX||e.minX>n.maxX||e.maxY<n.minY||e.minY>n.maxY)}static Contains(e,n){return e.minX<n.minX&&e.minY<n.minY&&e.maxY>n.maxY&&e.maxX>n.maxX}static ContainsApproximately(e,n,s){return Ii(e.minX,n.minX,s)&&Ii(e.minY,n.minY,s)&&Ii(n.maxX,e.maxX,s)&&Ii(n.maxY,e.maxY,s)}static Includes(e,n){return X.Collides(e,n)||X.Contains(e,n)}static ContainsPoint(e,n,s=0){return!(n.x<e.minX-s||n.y<e.minY-s||n.x>e.maxX+s||n.y>e.maxY+s)}static Common(e){let n=1/0,s=1/0,r=-1/0,i=-1/0;for(let o=0;o<e.length;o++){const a=e[o];n=Math.min(n,a.minX),s=Math.min(s,a.minY),r=Math.max(r,a.maxX),i=Math.max(i,a.maxY)}return new X(n,s,r-n,i-s)}static Sides(e,n=0){const{corners:s}=e;return[[s[0],s[1]],[s[1],s[2]],[s[2],s[3]],[s[3],s[0]]]}static Resize(e,n,s,r,i=!1){const{minX:o,minY:a,maxX:c,maxY:l}=e;let{minX:u,minY:d,maxX:p,maxY:f}=e;switch(n){case"left":case"top_left":case"bottom_left":{u+=s;break}case"right":case"top_right":case"bottom_right":{p+=s;break}}switch(n){case"top":case"top_left":case"top_right":{d+=r;break}case"bottom":case"bottom_left":case"bottom_right":{f+=r;break}}const g=(p-u)/(c-o),x=(f-d)/(l-a),y=g<0,m=x<0;if(i){const w=(c-o)/(l-a),P=Math.abs(p-u),_=Math.abs(f-d),I=P*(x<0?1:-1)*(1/w),C=_*(g<0?1:-1)*w,E=w<P/_;switch(n){case"top_left":{E?d=f+I:u=p+C;break}case"top_right":{E?d=f+I:p=u-C;break}case"bottom_right":{E?f=d-I:p=u-C;break}case"bottom_left":{E?f=d-I:u=p+C;break}case"bottom":case"top":{const O=(u+p)/2,k=_*w;u=O-k/2,p=O+k/2;break}case"left":case"right":{const O=(d+f)/2,k=P/w;d=O-k/2,f=O+k/2;break}}}if(y){const w=p;p=u,u=w}if(m){const w=f;f=d,d=w}const S=new X(u,d,Math.abs(p-u),Math.abs(f-d));return{box:S,scaleX:+(S.width/e.width*(g>0?1:-1)).toFixed(5),scaleY:+(S.height/e.height*(x>0?1:-1)).toFixed(5)}}equals(e){return X.Equals(this,e)}static Equals(e,n){return n.x===e.x&&n.y===e.y&&n.w===e.w&&n.h===e.h}zeroFix(){return this.w=Math.max(1,this.w),this.h=Math.max(1,this.h),this}static ZeroFix(e){return new X(e.x,e.y,Math.max(1,e.w),Math.max(1,e.h))}}function mL(t){switch(t){case"top":return"bottom";case"bottom":return"top";case"top_left":return"bottom_left";case"top_right":return"bottom_right";case"bottom_left":return"top_left";case"bottom_right":return"top_right";default:return t}}function yL(t){switch(t){case"left":return"right";case"right":return"left";case"top_left":return"top_right";case"top_right":return"top_left";case"bottom_left":return"bottom_right";case"bottom_right":return"bottom_left";default:return t}}function SL(t){return t==="top_left"||t==="top_right"||t==="bottom_right"||t==="bottom_left"}class q{constructor(e,n,s,r,i,o){this.a=e,this.b=n,this.c=s,this.d=r,this.e=i,this.f=o}a=1;b=0;c=0;d=1;e=0;f=0;equals(e){return this===e||this.a===e.a&&this.b===e.b&&this.c===e.c&&this.d===e.d&&this.e===e.e&&this.f===e.f}identity(){return this.a=1,this.b=0,this.c=0,this.d=1,this.e=0,this.f=0,this}multiply(e){const n=e,{a:s,b:r,c:i,d:o,e:a,f:c}=this;return this.a=s*n.a+i*n.b,this.c=s*n.c+i*n.d,this.e=s*n.e+i*n.f+a,this.b=r*n.a+o*n.b,this.d=r*n.c+o*n.d,this.f=r*n.e+o*n.f+c,this}rotate(e,n,s){return e===0?this:n===void 0?this.multiply(q.Rotate(e)):this.translate(n,s).multiply(q.Rotate(e)).translate(-n,-s)}translate(e,n){return this.multiply(q.Translate(e,n))}scale(e,n){return this.multiply(q.Scale(e,n))}invert(){const{a:e,b:n,c:s,d:r,e:i,f:o}=this,a=e*r-n*s;return this.a=r/a,this.b=n/-a,this.c=s/-a,this.d=e/a,this.e=(r*i-s*o)/-a,this.f=(n*i-e*o)/a,this}applyToPoint(e){return q.applyToPoint(this,e)}applyToPoints(e){return q.applyToPoints(this,e)}rotation(){return q.Rotation(this)}point(){return q.Point(this)}decomposed(){return q.Decompose(this)}toCssString(){return q.toCssString(this)}setTo(e){return Object.assign(this,e),this}decompose(){return q.Decompose(this)}clone(){return new q(this.a,this.b,this.c,this.d,this.e,this.f)}static Identity(){return new q(1,0,0,1,0,0)}static Translate(e,n){return new q(1,0,0,1,e,n)}static Rotate(e,n,s){if(e===0)return q.Identity();const r=Math.cos(e),i=Math.sin(e),o=new q(r,i,-i,r,0,0);return n===void 0?o:q.Compose(q.Translate(n,s),o,q.Translate(-n,-s))}static Scale(e,n,s,r){const i=new q(e,0,0,n,0,0);return s===void 0?i:q.Translate(s,r).multiply(i).translate(-s,-r)}static Multiply(e,n){return{a:e.a*n.a+e.c*n.b,c:e.a*n.c+e.c*n.d,e:e.a*n.e+e.c*n.f+e.e,b:e.b*n.a+e.d*n.b,d:e.b*n.c+e.d*n.d,f:e.b*n.e+e.d*n.f+e.f}}static Inverse(e){const n=e.a*e.d-e.b*e.c;return{a:e.d/n,b:e.b/-n,c:e.c/-n,d:e.a/n,e:(e.d*e.e-e.c*e.f)/-n,f:(e.b*e.e-e.a*e.f)/n}}static Absolute(e){const n=e.a*e.d-e.b*e.c;return{a:e.d/n,b:e.b/-n,c:e.c/-n,d:e.a/n,e:(e.d*e.e-e.c*e.f)/n,f:(e.b*e.e-e.a*e.f)/-n}}static Compose(...e){const n=q.Identity();for(let s=0,r=e.length;s<r;s++)n.multiply(e[s]);return n}static Point(e){return new b(e.e,e.f)}static Rotation(e){let n;if(e.a!==0||e.c!==0){const s=(e.a*e.a+e.c*e.c)**.5;n=Math.acos(e.a/s)*(e.c>0?-1:1)}else if(e.b!==0||e.d!==0){const s=(e.b*e.b+e.d*e.d)**.5;n=vt+Math.acos(e.b/s)*(e.d>0?-1:1)}else n=0;return Cg(n)}static Decompose(e){let n,s,r;if(e.a!==0||e.c!==0){const i=(e.a*e.a+e.c*e.c)**.5;n=i,s=(e.a*e.d-e.b*e.c)/i,r=Math.acos(e.a/i)*(e.c>0?-1:1)}else if(e.b!==0||e.d!==0){const i=(e.b*e.b+e.d*e.d)**.5;n=(e.a*e.d-e.b*e.c)/i,s=i,r=vt+Math.acos(e.b/i)*(e.d>0?-1:1)}else n=0,s=0,r=0;return{x:e.e,y:e.f,scaleX:n,scaleY:s,rotation:Cg(r)}}static Smooth(e,n=1e10){return e.a=Math.round(e.a*n)/n,e.b=Math.round(e.b*n)/n,e.c=Math.round(e.c*n)/n,e.d=Math.round(e.d*n)/n,e.e=Math.round(e.e*n)/n,e.f=Math.round(e.f*n)/n,e}static toCssString(e){return`matrix(${F(e.a)}, ${F(e.b)}, ${F(e.c)}, ${F(e.d)}, ${F(e.e)}, ${F(e.f)})`}static applyToPoint(e,n){return new b(e.a*n.x+e.c*n.y+e.e,e.b*n.x+e.d*n.y+e.f,n.z)}static applyToXY(e,n,s){return[e.a*n+e.c*s+e.e,e.b*n+e.d*s+e.f]}static applyToPoints(e,n){return n.map(s=>new b(e.a*s.x+e.c*s.y+e.e,e.b*s.x+e.d*s.y+e.f,s.z))}static applyToBounds(e,n){return new X(e.e+n.minX,e.f+n.minY,n.width,n.height)}static From(e){return new q(e.a,e.b,e.c,e.d,e.e,e.f)}static Cast(e){return e instanceof q?e:q.From(e)}}function uu(t,e,n,s,r=1e-10){const i=t.x-n.x,o=t.y-n.y,a=s.x-n.x,c=s.y-n.y,l=e.x-t.x,u=e.y-t.y,d=a*o-c*i,p=l*o-u*i,f=c*l-a*u;if(Dt(d,0,r)||Dt(p,0,r)||Dt(f,0,r))return null;if(f!==0){const g=d/f,x=p/f;if(Ii(0,g,r)&&Ii(g,1,r)&&Ii(0,x,r)&&Ii(x,1,r))return b.AddXY(t,g*l,g*u)}return null}function Xc(t,e,n,s){const r=(e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y),i=2*((e.x-t.x)*(t.x-n.x)+(e.y-t.y)*(t.y-n.y)),o=n.x*n.x+n.y*n.y+t.x*t.x+t.y*t.y-2*(n.x*t.x+n.y*t.y)-s*s,a=i*i-4*r*o;if(a<0||a===0)return null;const c=Math.sqrt(a),l=(-i+c)/(2*r),u=(-i-c)/(2*r);if((l<0||l>1)&&(u<0||u>1))return null;const d=[];return 0<=l&&l<=1&&d.push(b.Lrp(t,e,l)),0<=u&&u<=1&&d.push(b.Lrp(t,e,u)),d.length===0?null:d}function xL(t,e,n){const s=[];let r;for(let i=0,o=n.length-1;i<o;i++)r=uu(t,e,n[i],n[i+1]),r&&s.push(r);return s.length===0?null:s}function GP(t,e,n){const s=[];let r;for(let i=1,o=n.length;i<o+1;i++)r=uu(t,e,n[i-1],n[i%n.length]),r&&s.push(r);return s.length===0?null:s}function bL(t,e,n,s){let r=n.x-t.x,i=n.y-t.y;const o=Math.sqrt(r*r+i*i),a=(o*o-s*s+e*e)/(2*o),c=Math.sqrt(e*e-a*a);return r/=o,i/=o,[new b(t.x+r*a-i*c,t.y+i*a+r*c),new b(t.x+r*a+i*c,t.y+i*a-r*c)]}function wL(t,e,n){const s=[];let r,i,o;for(let a=0,c=n.length;a<c;a++)r=n[a],i=n[(a+1)%n.length],o=Xc(r,i,t,e),o&&s.push(...o);return s.length===0?null:s}function vL(t,e,n){const s=[];let r,i,o;for(let a=1,c=n.length;a<c;a++)r=n[a-1],i=n[a],o=Xc(r,i,t,e),o&&s.push(...o);return s.length===0?null:s}function Ml(t,e,n){return(n.y-t.y)*(e.x-t.x)>(e.y-t.y)*(n.x-t.x)}function cy(t,e,n,s){return Ml(t,n,s)!==Ml(e,n,s)&&Ml(t,e,n)!==Ml(t,e,s)}function Dd(t,e){const n=new Map;let s,r,i,o;for(let a=0,c=t.length;a<c;a++)if(s=t[a],Bn(s,e)){const l=od(s);n.has(l)||n.set(l,s)}for(let a=0,c=e.length;a<c;a++)if(s=e[a],Bn(s,t)){const l=od(s);n.has(l)||n.set(l,s)}for(let a=0,c=t.length;a<c;a++){s=t[a],r=t[(a+1)%t.length];for(let l=0,u=e.length;l<u;l++){i=e[l],o=e[(l+1)%e.length];const d=uu(s,r,i,o);if(d!==null){const p=od(d);n.has(p)||n.set(p,d)}}}return n.size===0?null:PL([...n.values()])}function yw(t,e,n,s){const r=new Map;for(let i=0,o=n?t.length:t.length-1;i<o;i++){const a=t[i],c=t[(i+1)%t.length];for(let l=0,u=s?e.length:e.length-1;l<u;l++){const d=e[l],p=e[(l+1)%e.length],f=uu(a,c,d,p);if(f!==null){const g=od(f);r.has(g)||r.set(g,f)}}}return[...r.values()]}function od(t){return`${t.x},${t.y}`}function PL(t){const e=b.Average(t);return t.sort((n,s)=>b.Angle(e,n)-b.Angle(e,s))}function YP(t,e){let n,s,r,i;for(let o=0,a=t.length;o<a;o++){n=t[o],s=t[(o+1)%a];for(let c=0,l=e.length;c<l;c++)if(r=e[c],i=e[(c+1)%l],cy(n,s,r,i))return!0}return!1}function IL(t,e){let n,s,r,i;for(let o=0,a=t.length;o<a;o++){n=t[o],s=t[(o+1)%a];for(let c=1,l=e.length;c<l;c++)if(r=e[c-1],i=e[c],cy(n,s,r,i))return!0}return!1}const Sr={EXCLUDE_NON_STANDARD:{includeLabels:!1,includeInternal:!1},EXCLUDE_LABELS:{includeLabels:!1,includeInternal:!0}};class Bi{isFilled=!1;isClosed=!0;isLabel=!1;isEmptyLabel=!1;isInternal=!1;excludeFromShapeBounds=!1;debugColor;ignore;constructor(e){const{isLabel:n=!1,isEmptyLabel:s=!1,isInternal:r=!1,excludeFromShapeBounds:i=!1}=e;this.isFilled=e.isFilled,this.isClosed=e.isClosed,this.debugColor=e.debugColor,this.ignore=e.ignore,this.isLabel=n,this.isEmptyLabel=s,this.isInternal=r,this.excludeFromShapeBounds=i}isExcludedByFilter(e){return e?!!(this.isLabel&&!e.includeLabels||this.isInternal&&!e.includeInternal):!1}hitTestPoint(e,n=0,s=!1,r){return this.isClosed&&(this.isFilled||s)&&Bn(e,this.vertices)?!0:b.Dist2(e,this.nearestPoint(e))<=n*n}distanceToPoint(e,n=!1,s){return b.Dist(e,this.nearestPoint(e,s))*(this.isClosed&&(this.isFilled||n)&&Bn(e,this.vertices)?-1:1)}distanceToLineSegment(e,n,s){if(b.Equals(e,n))return this.distanceToPoint(e,!1,s);const{vertices:r}=this;if(r.length===0)throw Error("nearest point not found");if(r.length===1)return b.Dist(e,r[0]);let i,o=1/0,a,c,l;const u=this.isClosed?r.length:r.length-1;for(let d=0;d<r.length;d++){if(c=r[d],d<u){const p=r[(d+1)%r.length];if(cy(e,n,c,p))return 0}l=b.NearestPointOnLineSegment(e,n,c,!0),a=b.Dist2(c,l),a<o&&(o=a,i=l)}if(!i)throw Error("nearest point not found");return o=Math.sqrt(o),this.isClosed&&this.isFilled&&Bn(i,this.vertices)?-o:o}hitTestLineSegment(e,n,s=0,r){return this.distanceToLineSegment(e,n,r)<=s}intersectLineSegment(e,n,s){return(this.isClosed?GP(e,n,this.vertices):xL(e,n,this.vertices))??[]}intersectCircle(e,n,s){return(this.isClosed?wL(e,n,this.vertices):vL(e,n,this.vertices))??[]}intersectPolygon(e,n){return yw(e,this.vertices,!0,this.isClosed)}intersectPolyline(e,n){return yw(e,this.vertices,!1,this.isClosed)}interpolateAlongEdge(e,n){const{vertices:s}=this;if(s.length===0)return new b(0,0);if(s.length===1||e<=0)return s[0];const r=e*this.length;let i=0;for(let o=0;o<(this.isClosed?s.length:s.length-1);o++){const a=s[o],c=s[(o+1)%s.length],l=b.Dist(a,c),u=i+l;if(u>=r)return b.Lrp(a,c,xc(i,u,r));i=u}return this.isClosed?s[0]:s[s.length-1]}uninterpolateAlongEdge(e,n){const{vertices:s,length:r}=this;let i=null,o=1/0,a=0;if(s.length===0||s.length===1)return 0;for(let l=0;l<(this.isClosed?s.length:s.length-1);l++){const u=s[l],d=s[(l+1)%s.length],p=b.NearestPointOnLineSegment(u,d,e,!0),f=b.Dist(p,e);f<o&&(o=f,i={start:u,end:d,nearestPoint:p,distanceToStart:a}),a+=b.Dist(u,d)}return le(i),(i.distanceToStart+b.Dist(i.start,i.nearestPoint))/r}isPointInBounds(e,n=0){const{bounds:s}=this;return!(e.x<s.minX-n||e.y<s.minY-n||e.x>s.maxX+n||e.y>s.maxY+n)}overlapsPolygon(e){const n=e.map(c=>b.From(c)),{vertices:s,center:r,isFilled:i,isEmptyLabel:o,isClosed:a}=this;if(o)return!1;if(s.some(c=>Bn(c,n)))return!0;if(a){if(i&&(Bn(r,n)||n.every(c=>Bn(c,s)))||YP(n,s))return!0}else if(IL(n,s))return!0;return!1}transform(e,n){return new ly(this,e,n)}_vertices;get vertices(){return this._vertices||(this._vertices=this.getVertices(Sr.EXCLUDE_LABELS)),this._vertices}getBoundsVertices(){return this.excludeFromShapeBounds?[]:this.vertices}_boundsVertices;get boundsVertices(){return this._boundsVertices||(this._boundsVertices=this.getBoundsVertices()),this._boundsVertices}getBounds(){return X.FromPoints(this.boundsVertices)}_bounds;get bounds(){return this._bounds||(this._bounds=this.getBounds()),this._bounds}get center(){return this.bounds.center}_area;get area(){return this._area||(this._area=this.getArea()),this._area}getArea(){if(!this.isClosed)return 0;const{vertices:e}=this;let n=0;for(let s=0,r=e.length;s<r;s++){const i=e[s],o=e[(s+1)%r];n+=i.x*o.y-o.x*i.y}return n/2}toSimpleSvgPath(){let e="";const{vertices:n}=this,s=n.length;if(s===0)return e;e+=`M${n[0].x},${n[0].y}`;for(let r=1;r<s;r++)e+=`L${n[r].x},${n[r].y}`;return this.isClosed&&(e+="Z"),e}_length;get length(){return this._length?this._length:(this._length=this.getLength(Sr.EXCLUDE_LABELS),this._length)}getLength(e){const n=this.getVertices(e??Sr.EXCLUDE_LABELS);if(n.length===0)return 0;let s=n[0],r=0;for(let i=1;i<n.length;i++){const o=n[i];r+=b.Dist(s,o),s=o}return this.isClosed&&(r+=b.Dist(n[n.length-1],n[0])),r}}class ly extends Bi{constructor(e,n,s){super(e),this.geometry=e,this.matrix=n,this.inverse=q.Inverse(n),this.decomposed=q.Decompose(n),s&&(s.isLabel!=null&&(this.isLabel=s.isLabel),s.isInternal!=null&&(this.isInternal=s.isInternal),s.debugColor!=null&&(this.debugColor=s.debugColor),s.ignore!=null&&(this.ignore=s.ignore)),le(Dt(this.decomposed.scaleX,this.decomposed.scaleY),"non-uniform scaling is not yet supported")}inverse;decomposed;getVertices(e){return this.geometry.getVertices(e).map(n=>q.applyToPoint(this.matrix,n))}getBoundsVertices(){return this.geometry.getBoundsVertices().map(e=>q.applyToPoint(this.matrix,e))}nearestPoint(e,n){return q.applyToPoint(this.matrix,this.geometry.nearestPoint(q.applyToPoint(this.inverse,e),n))}hitTestPoint(e,n=0,s,r){return this.geometry.hitTestPoint(q.applyToPoint(this.inverse,e),n/this.decomposed.scaleX,s,r)}distanceToPoint(e,n=!1,s){return this.geometry.distanceToPoint(q.applyToPoint(this.inverse,e),n,s)*this.decomposed.scaleX}distanceToLineSegment(e,n,s){return this.geometry.distanceToLineSegment(q.applyToPoint(this.inverse,e),q.applyToPoint(this.inverse,n),s)*this.decomposed.scaleX}hitTestLineSegment(e,n,s=0,r){return this.geometry.hitTestLineSegment(q.applyToPoint(this.inverse,e),q.applyToPoint(this.inverse,n),s/this.decomposed.scaleX,r)}intersectLineSegment(e,n,s){return q.applyToPoints(this.matrix,this.geometry.intersectLineSegment(q.applyToPoint(this.inverse,e),q.applyToPoint(this.inverse,n),s))}intersectCircle(e,n,s){return q.applyToPoints(this.matrix,this.geometry.intersectCircle(q.applyToPoint(this.inverse,e),n/this.decomposed.scaleX,s))}intersectPolygon(e,n){return q.applyToPoints(this.matrix,this.geometry.intersectPolygon(q.applyToPoints(this.inverse,e),n))}intersectPolyline(e,n){return q.applyToPoints(this.matrix,this.geometry.intersectPolyline(q.applyToPoints(this.inverse,e),n))}transform(e,n){return new ly(this.geometry,q.Multiply(e,this.matrix),{isLabel:n?.isLabel??this.isLabel,isInternal:n?.isInternal??this.isInternal,debugColor:n?.debugColor??this.debugColor,ignore:n?.ignore??this.ignore})}getSvgPathData(){throw new Error("Cannot get SVG path data for transformed geometry.")}}class os extends Bi{children=[];ignoredChildren=[];constructor(e){super({...e,isClosed:!0,isFilled:!1});const n=s=>{for(const r of s)r instanceof os?n(r.children):r.ignore?this.ignoredChildren.push(r):this.children.push(r)};if(n(e.children),this.children.length===0)throw Error("Group2d must have at least one child")}getVertices(e){return this.isExcludedByFilter(e)?[]:this.children.filter(n=>!n.isExcludedByFilter(e)).flatMap(n=>n.getVertices(e))}nearestPoint(e,n){let s=1/0,r;const{children:i}=this;if(i.length===0)throw Error("no children");let o,a;for(const c of i)c.isExcludedByFilter(n)||(o=c.nearestPoint(e,n),a=b.Dist2(o,e),a<s&&(s=a,r=o));if(!r)throw Error("nearest point not found");return r}distanceToPoint(e,n=!1,s){let r=1/0;for(const i of this.children){if(i.isExcludedByFilter(s))continue;const o=i.distanceToPoint(e,n,s);o<r&&(r=o)}return r}hitTestPoint(e,n,s,r=Sr.EXCLUDE_LABELS){return!!this.children.filter(i=>!i.isExcludedByFilter(r)).find(i=>i.hitTestPoint(e,n,s))}hitTestLineSegment(e,n,s,r=Sr.EXCLUDE_LABELS){return!!this.children.filter(i=>!i.isExcludedByFilter(r)).find(i=>i.hitTestLineSegment(e,n,s))}intersectLineSegment(e,n,s){return this.children.flatMap(r=>r.isExcludedByFilter(s)?Ct:r.intersectLineSegment(e,n,s))}intersectCircle(e,n,s){return this.children.flatMap(r=>r.isExcludedByFilter(s)?Ct:r.intersectCircle(e,n,s))}getBoundsVertices(){return this.excludeFromShapeBounds?[]:this.children.flatMap(e=>e.getBoundsVertices())}intersectPolygon(e,n){return this.children.flatMap(s=>s.isExcludedByFilter(n)?Ct:s.intersectPolygon(e,n))}intersectPolyline(e,n){return this.children.flatMap(s=>s.isExcludedByFilter(n)?Ct:s.intersectPolyline(e,n))}interpolateAlongEdge(e,n){const s=this.getLength(n),r=e*s;let i=0;for(const o of this.children){if(o.isExcludedByFilter(n))continue;const a=o.length,c=i+a;if(c>=r)return o.interpolateAlongEdge(xc(i,c,r),n);i=c}return this.children[this.children.length-1].interpolateAlongEdge(1,n)}uninterpolateAlongEdge(e,n){const s=this.getLength(n);let r=null,i=1/0,o=0;for(const l of this.children){if(l.isExcludedByFilter(n))continue;const u=l.getLength(n),d=o+u,p=l.distanceToPoint(e,!1,n);p<i&&(i=p,r={startLength:o,endLength:d,child:l}),o=d}le(r);const a=r.child.uninterpolateAlongEdge(e,n);return ke(r.startLength,r.endLength,a)/s}transform(e){return new os({children:this.children.map(n=>n.transform(e)),isLabel:this.isLabel,debugColor:this.debugColor,ignore:this.ignore})}getArea(){return this.children[0].area}toSimpleSvgPath(){let e="";for(const s of this.children)e+=s.toSimpleSvgPath();const n=X.FromPoints(this.boundsVertices).corners;for(let s=0,r=n.length;s<r;s++){const i=n[s],o=n[(s-1+r)%r],a=i.dist(o),c=n[(s+1)%r],l=i.dist(c),u=i.clone().lrp(o,4/a),d=i,p=i.clone().lrp(c,4/l);e+=`M${u.x},${u.y} L${d.x},${d.y} L${p.x},${p.y} `}return e}getLength(e){let n=0;for(const s of this.children)s.isExcludedByFilter(e)||(n+=s.length);return n}getSvgPathData(){return this.children.map((e,n)=>e.isLabel?"":e.getSvgPathData(n===0)).join(" ")}overlapsPolygon(e){return this.children.some(n=>n.overlapsPolygon(e))}}class sa extends Bi{_start;_end;_d;_u;_ul;constructor(e){super({...e,isClosed:!1,isFilled:!1});const{start:n,end:s}=e;this._start=n,this._end=s,this._d=n.clone().sub(s),this._u=this._d.clone().uni(),this._ul=this._u.len()}getLength(){return this._d.len()}getVertices(){return[this._start,this._end]}nearestPoint(e){const{_start:n,_end:s,_d:r,_u:i,_ul:o}=this;if(r.len()===0||o===0)return n;const a=b.Sub(e,n).dpr(i)/o,c=n.x+i.x*a;if(c<Math.min(n.x,s.x))return n.x<s.x?n:s;if(c>Math.max(n.x,s.x))return n.x>s.x?n:s;const l=n.y+i.y*a;return l<Math.min(n.y,s.y)?n.y<s.y?n:s:l>Math.max(n.y,s.y)?n.y>s.y?n:s:new b(c,l)}getSvgPathData(e=!0){const{_start:n,_end:s}=this;return`${e?`M${n.toFixed()}`:""} L${s.toFixed()}`}}class Zc extends Bi{_points;_segments;constructor(e){super({isClosed:!1,isFilled:!1,...e});const{points:n}=e;if(this._points=n,n.length<2)throw new Error("Polyline2d: points must be an array of at least 2 points")}get segments(){if(!this._segments){this._segments=[];const{vertices:e}=this;for(let n=0,s=e.length-1;n<s;n++){const r=e[n],i=e[n+1];this._segments.push(new sa({start:r,end:i}))}this.isClosed&&this._segments.push(new sa({start:e[e.length-1],end:e[0]}))}return this._segments}getLength(){return this.segments.reduce((e,n)=>e+n.length,0)}getVertices(){return this._points}nearestPoint(e){const{segments:n}=this;let s=this._points[0],r=1/0,i,o;for(let a=0;a<n.length;a++)i=n[a].nearestPoint(e),o=b.Dist2(i,e),o<r&&(s=i,r=o);if(!s)throw Error("nearest point not found");return s}hitTestLineSegment(e,n,s=0){const{segments:r}=this;for(let i=0,o=r.length;i<o;i++)if(r[i].hitTestLineSegment(e,n,s))return!0;return!1}getSvgPathData(){const{vertices:e}=this;return e.length<2?"":e.reduce((n,s,r)=>r===0?`M ${s.x} ${s.y}`:`${n} L ${s.x} ${s.y}`,"")}}class Ic extends Zc{constructor(e){if(super({...e}),this.isClosed=!0,e.points.length<3)throw new Error("Polygon2d: points must be an array of at least 3 points")}}class rr extends Ic{_x;_y;_w;_h;constructor(e){const{x:n=0,y:s=0,width:r,height:i}=e;super({...e,points:[new b(n,s),new b(n+r,s),new b(n+r,s+i),new b(n,s+i)]}),this._x=n,this._y=s,this._w=r,this._h=i}getBounds(){return new X(this._x,this._y,this._w,this._h)}getSvgPathData(){const{_x:e,_y:n,_w:s,_h:r}=this;return this.negativeZeroFix(),`M${e},${n} h${s} v${r} h${-s}z`}negativeZeroFix(){this._x=jl(this._x),this._y=jl(this._y),this._w=jl(this._w),this._h=jl(this._h)}}function jl(t){return Object.is(t,-0)?0:t}class zi{constructor(e){this.editor=e}static configure(e){return class extends this{options={...this.options,...e}}}options={};static props;static migrations;static type;getFontFaces(e){return Ct}canSnap(e){return!0}canTabTo(e){return!0}canScroll(e){return!1}canBind(e){return!0}canEdit(e,n){return!1}canResize(e){return!0}canResizeChildren(e){return!0}canEditInReadonly(e){return!1}canEditWhileLocked(e){return!1}canCrop(e){return!1}canBeLaidOut(e,n){return!0}canCull(e){return!0}providesBackgroundForChildren(e){return!1}hideResizeHandles(e){return!1}hideRotateHandle(e){return!1}hideSelectionBoundsBg(e){return!1}hideSelectionBoundsFg(e){return!1}isAspectRatioLocked(e){return!1}isExportBoundsContainer(e){return!1}canReceiveNewChildrenOfType(e,n){return!1}expandSelectionOutlinePx(e){return 0}getCanvasSvgDefs(){return[]}getBoundsSnapGeometry(e){return{}}getHandleSnapGeometry(e){return{}}getText(e){}getAriaDescriptor(e){}}function VP(t,e,n={}){const{closed:s=!1,snap:r=1,start:i="outset",end:o="outset",lengthRatio:a=2,style:c="dashed",forceSolid:l=!1}=n;let u=0,d=0,p=1,f=0,g=0;if(l)return{strokeDasharray:"none",strokeDashoffset:"none"};switch(c){case"dashed":{p=1,u=Math.min(e*a,t/4);break}case"dotted":{p=100,u=e/p;break}default:return{strokeDasharray:"none",strokeDashoffset:"none"}}return s||(i==="outset"?(t+=u/2,g+=u/2):i==="skip"&&(t-=u,g-=u),o==="outset"?t+=u/2:o==="skip"&&(t-=u)),d=Math.floor(t/u/(2*p)),d-=d%r,d<3&&c==="dashed"?t/e<4?(u=t,d=1,f=0):(u=t*(1/3),f=t*(1/3)):(u=t/d/(2*p),s?(g=u/2,f=(t-d*u)/d):f=(t-d*u)/Math.max(1,d-1)),{strokeDasharray:[u,f].join(" "),strokeDashoffset:g.toString()}}function Sw({bounds:t,className:e}){const n=z(),s=$("zoom level",()=>n.getEfficientZoomLevel(),[n]);return h.jsx("g",{className:e,pointerEvents:"none",strokeLinecap:"round",strokeLinejoin:"round",children:t.sides.map((r,i)=>{const{strokeDasharray:o,strokeDashoffset:a}=VP(r[0].dist(r[1]),1/s,{style:"dashed",lengthRatio:4});return h.jsx("line",{x1:r[0].x,y1:r[0].y,x2:r[1].x,y2:r[1].y,strokeDasharray:o,strokeDashoffset:a},i)})})}class _L extends zi{static type="group";static props=oP;static migrations=aP;hideSelectionBoundsFg(){return!0}canBind(){return!1}canResize(){return!0}canResizeChildren(){return!0}getDefaultProps(){return{}}getGeometry(e){const n=this.editor.getSortedChildIdsForParent(e.id);return n.length===0?new rr({width:1,height:1,isFilled:!1}):new os({children:n.map(s=>{const r=this.editor.getShape(s);return this.editor.getShapeGeometry(s).transform(this.editor.getShapeLocalTransform(r),{isLabel:!1})})})}component(e){const n=this.editor.getErasingShapeIds().includes(e.id),{hintingShapeIds:s}=this.editor.getCurrentPageState(),r=s.length>0&&s.some(a=>a!==e.id&&this.editor.isShapeOfType(this.editor.getShape(a),"group")),i=this.editor.getCurrentPageState().focusedGroupId!==e.id;if(!n&&(i||r))return null;const o=this.editor.getShapeGeometry(e).bounds;return h.jsx(ki,{children:h.jsx(Sw,{className:"tl-group",bounds:o})})}indicator(e){const n=this.editor.getShapeGeometry(e).bounds;return h.jsx(Sw,{className:"",bounds:n})}onChildrenChange(e){const n=this.editor.getSortedChildIdsForParent(e.id);if(n.length===0){this.editor.getCurrentPageState().focusedGroupId===e.id&&this.editor.popFocusedGroupId(),this.editor.deleteShapes([e.id]);return}else if(n.length===1){this.editor.getCurrentPageState().focusedGroupId===e.id&&this.editor.popFocusedGroupId(),this.editor.reparentShapes(n,e.parentId),this.editor.deleteShapes([e.id]);return}}}const XP=[_L],CL=new Set(XP.map(t=>t.type));function ZP(t){const e=[...XP],n=new Set;for(const s of t){if(CL.has(s.type))throw new Error(`Shape type "${s.type}" is a core shapes type and cannot be overridden`);if(n.has(s.type))throw new Error(`Shape type "${s.type}" is defined more than once`);e.push(s),n.add(s.type)}return e}function JP(t,e){const n=new Map;return async function(r){const i=n.get(r);if(i)return i;const o=(async()=>{try{const a=await Qr(r,e);return le(a.ok),await t(a)}catch(a){return console.error(a),null}})();return n.set(r,o),o}}const hu=JP(async t=>await vn.blobToDataUrl(await t.blob())),TL=/@import\s+(?:"([^"]+)"|'([^']+)'|url\s*\(\s*(?:"([^"]+)"|'([^']+)'|([^'")]+))\s*\))([^;]+);/gi,EL=/@font-face\s*{([^}]+)}/gi,QP=/url\s*\(\s*(?:"([^"]+)"|'([^']+)'|([^'")]+))\s*\)/gi,kL=/(?:^|;)\s*font-family\s*:\s*(?:([^'"][^;\n]+)|"([^"]+)"|'([^']+)')\s*(?:;|$)/gi;function AL(t){return Array.from(t.matchAll(TL),e=>({url:e[1]||e[2]||e[3]||e[4]||e[5],extras:e[6]}))}function eI(t,e){return Array.from(t.matchAll(EL),n=>{const s=n[1],r=Array.from(s.matchAll(QP),o=>{const a=o[1]||o[2]||o[3];return{original:a,resolved:Ee(a,e)?.href??null}}),i=new Set(Array.from(s.matchAll(kL),o=>(o[1]||o[2]||o[3]).toLowerCase()));return{fontFace:s,urls:r,fontFamilies:i}})}function ML(t){const e=/\s*(?:([^'"][^;\n\s,]+)|"([^"]+)"|'([^']+)')\s*/gi,n=/\s*,\s*/gi,s=new Set;for(;;){const r=e.exec(t);if(!r)break;const i=r[1]||r[2]||r[3];if(s.add(i.toLowerCase()),n.lastIndex=e.lastIndex,!n.exec(t))break;e.lastIndex=n.lastIndex}return s}function tI(t){return!(t.startsWith("-")||t.startsWith("animation")||t.startsWith("transition")||t==="cursor"||t==="pointer-events"||t==="user-select"||t==="touch-action")}function jL(t,e){return{imports:AL(t),fontFaces:eI(t,e)}}function DL(t){return Array.from(t.matchAll(QP),e=>({original:e[0],url:e[1]||e[2]||e[3]})).filter(e=>!e.url.startsWith("#"))}var OL=Object.create,nI=Object.defineProperty,LL=Object.getOwnPropertyDescriptor,RL=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),sI=t=>{throw TypeError(t)},rI=(t,e,n)=>e in t?nI(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,FL=t=>[,,,OL(null)],iI=["class","method","getter","setter","accessor","field","value","get","set"],oI=t=>t!==void 0&&typeof t!="function"?sI("Function expected"):t,BL=(t,e,n,s,r)=>({kind:iI[t],name:e,metadata:s,addInitializer:i=>n._?sI("Already initialized"):r.push(oI(i||null))}),zL=(t,e)=>rI(e,RL("metadata"),t[3]),$L=(t,e,n,s)=>{for(var r=0,i=t[e>>1],o=i&&i.length;r<o;r++)i[r].call(n);return s},NL=(t,e,n,s,r,i)=>{for(var o,a,c,l,u=e&7,d=!1,p=!1,f=2,g=iI[u+5],x=t[f]||(t[f]=[]),y=(r=r.prototype,LL(r,n)),m=s.length-1;m>=0;m--)c=BL(u,n,a={},t[3],x),c.static=d,c.private=p,l=c.access={has:S=>n in S},l.get=S=>S[n],o=(0,s[m])(y[g],c),a._=1,oI(o)&&(y[g]=o);return y&&nI(r,n,y),r},Dl=(t,e,n)=>rI(t,typeof e!="symbol"?e+"":e,n),aI,pu;const cI="tldraw-svg-export";aI=[rs];class dy{constructor(){$L(pu,5,this),Dl(this,"fontFacesPromise",null),Dl(this,"foundFontNames",new Set),Dl(this,"fontFacesToEmbed",new Set),Dl(this,"pendingPromises",[])}startFindingCurrentDocumentFontFaces(){le(!this.fontFacesPromise,"FontEmbedder already started"),this.fontFacesPromise=UL()}onFontFamilyValue(e){le(this.fontFacesPromise,"FontEmbedder not started");const n=ML(e);for(const s of n){if(this.foundFontNames.has(s))return;this.foundFontNames.add(s),this.pendingPromises.push(this.fontFacesPromise.then(r=>{const i=r.filter(o=>o.fontFamilies.has(s));for(const o of i)if(!this.fontFacesToEmbed.has(o)){this.fontFacesToEmbed.add(o);for(const a of o.urls)!a.resolved||a.embedded||(a.embedded=hu(a.resolved))}}))}}async createCss(){await Promise.all(this.pendingPromises);let e="";for(const n of this.fontFacesToEmbed){let s=`@font-face {${n.fontFace}}`;for(const r of n.urls){if(!r.embedded)continue;const i=await r.embedded;i&&(s=s.replace(r.original,i))}e+=s}return e}}pu=FL();NL(pu,1,"onFontFamilyValue",aI,dy);zL(pu,dy);async function UL(){const t=[],e=Array.from(document.styleSheets).filter(n=>!n.ownerNode?.closest(`.${cI}`));for(const n of e){let s;try{s=n.cssRules}catch{}if(s){for(const r of n.cssRules)if(r instanceof CSSFontFaceRule)t.push(eI(r.cssText,n.href??document.baseURI));else if(r instanceof CSSImportRule){const i=new URL(r.href,r.parentStyleSheet?.href??document.baseURI);t.push(kg(i.href))}}else n.href&&t.push(kg(n.href))}return ve(await Promise.all(t)).flat()}const kg=JP(async t=>{const e=jL(await t.text(),t.url),n=await Promise.all(e.imports.map(({url:s})=>kg(new URL(s,t.url).href)));return[...e.fontFaces,...ve(n).flat()]}),ps=(t,e,{currentColor:n})=>t==="currentColor"||t===n,Be=(t,e,{parentStyles:n})=>n[e]===t,bt=t=>(e,n,{getStyle:s})=>{const r=s(`border-${t}-width`),i=s(`border-${t}-style`);return r==="0px"||i==="none"},lI={"border-block-end-color":ps,"border-block-start-color":ps,"border-bottom-color":ps,"border-inline-end-color":ps,"border-inline-start-color":ps,"border-left-color":ps,"border-right-color":ps,"border-top-color":ps,"caret-color":ps,"column-rule-color":ps,"outline-color":ps,"text-decoration":(t,e,{currentColor:n})=>t==="none solid currentColor"||t==="none solid "+n,"text-decoration-color":ps,"text-emphasis-color":ps,"border-collapse":Be,"border-spacing":Be,"caption-side":Be,cursor:Be,direction:Be,"empty-cells":Be,"font-family":Be,"font-size":Be,"font-style":Be,"font-variant":Be,"font-weight":Be,"font-size-adjust":Be,"font-stretch":Be,font:Be,"letter-spacing":Be,"line-height":Be,"list-style-image":Be,"list-style-position":Be,"list-style-type":Be,"list-style":Be,orphans:Be,"overflow-wrap":Be,quotes:Be,"stroke-linecap":Be,"stroke-linejoin":Be,"tab-size":Be,"text-align":Be,"text-align-last":Be,"text-indent":Be,"text-justify":Be,"text-shadow":Be,"text-transform":Be,visibility:Be,"white-space":Be,"white-space-collapse":Be,widows:Be,"word-break":Be,"word-spacing":Be,"word-wrap":Be,"border-top":bt("top"),"border-right":bt("right"),"border-bottom":bt("bottom"),"border-left":bt("left"),"border-block-end":bt("block-end"),"border-block-start":bt("block-start"),"border-inline-end":bt("inline-end"),"border-inline-start":bt("inline-start"),"border-top-style":bt("top"),"border-right-style":bt("right"),"border-bottom-style":bt("bottom"),"border-left-style":bt("left"),"border-block-end-style":bt("block-end"),"border-block-start-style":bt("block-start"),"border-inline-end-style":bt("inline-end"),"border-inline-start-style":bt("inline-start"),"border-top-width":bt("top"),"border-right-width":bt("right"),"border-bottom-width":bt("bottom"),"border-left-width":bt("left"),"border-block-end-width":bt("block-end"),"border-block-start-width":bt("block-start"),"border-inline-end-width":bt("inline-end")};function dI(t){if(t.shadowRoot)return t.shadowRoot.childNodes;if(qL(t)){const e=t.assignedNodes();if(e?.length)return e}return t.childNodes}function*Ag(t){for(const e of dI(t))HL(e)&&(yield e)}function fu(t){return t.ownerDocument?.defaultView??globalThis}function HL(t){return t instanceof fu(t).Element}function KL(t){return t instanceof fu(t).ShadowRoot}function WL(t){return"getRootNode"in t&&KL(t.getRootNode())}function qL(t){return WL(t)&&t instanceof fu(t).HTMLSlotElement}function GL(t){return t.style}function uy(t,e){return fu(t).getComputedStyle(t,e)}const ra={};class YL{constructor(e){this.root=e}styles=new Map;fonts=new dy;readRootElementStyles(e){this.readElementStyles(e,{shouldRespectDefaults:!1,shouldSkipInheritedParentStyles:!1});const n=Array.from(Ag(e));for(;n.length;){const s=n.pop();n.push(...Ag(s)),this.readElementStyles(s,{shouldRespectDefaults:!0,shouldSkipInheritedParentStyles:!0})}}readElementStyles(e,{shouldRespectDefaults:n=!0,shouldSkipInheritedParentStyles:s=!0}){const r=n?JL(e.tagName.toLowerCase()):ra,i=Object.assign({},ra);if(s){let a=e.parentElement;for(;a;){const c=this.styles.get(a)?.self;for(const l in c)i[l]||(i[l]=c[l]);a=a.parentElement}}const o={self:VL(e,{defaultStyles:r,parentStyles:i}),before:xw(e,"::before"),after:xw(e,"::after")};this.styles.set(e,o)}fetchResources(){const e=[];for(const n of this.styles.values())for(const s of _t(n))if(s)for(const[r,i]of Object.entries(s)){if(!i)continue;r==="font-family"&&this.fonts.onFontFamilyValue(i);const o=DL(i);o.length!==0&&e.push(...o.map(async({url:a,original:c})=>{const l=await hu(a)??"data:";s[r]=i.replace(c,`url("${l}")`)}))}return Promise.all(e)}unwrapCustomElements(){const e=new Set,n=(s,r)=>{if(e.has(s))return;e.add(s);const i=s.shadowRoot;if(i){const o=document.createElement("div");this.styles.set(o,this.styles.get(s)),o.setAttribute("data-tl-custom-element",s.tagName),(r??s.parentElement).appendChild(o);for(const a of i.childNodes)a instanceof Element?n(a,o):o.appendChild(a.cloneNode(!0));s.remove()}else if(r){if(s.tagName.toLowerCase()==="style")return;const o=s.cloneNode(!1);this.styles.set(o,this.styles.get(s)),r.appendChild(o);for(const a of dI(s))a instanceof Element?n(a,o):o.appendChild(a.cloneNode(!0))}};for(const s of this.styles.keys())n(s,null)}embedStyles(){let e="";for(const[n,s]of this.styles){if(s.after||s.before){const i=`pseudo-${Ge()}`;n.classList.add(i),s.before&&(e+=`.${i}::before {${bw(s.before)}}
`),s.after&&(e+=`.${i}::after {${bw(s.after)}}
`)}const r=GL(n);for(const[i,o]of Object.entries(s.self))o&&r.setProperty(i,o);r.fontKerning==="auto"&&(r.fontKerning="normal")}return e}async getFontFaceCss(){return await this.fonts.createCss()}dispose(){ZL()}}function VL(t,{defaultStyles:e,parentStyles:n}){return t.computedStyleMap?uI(t.computedStyleMap(),{defaultStyles:e,parentStyles:n}):hy(uy(t),{defaultStyles:e,parentStyles:n})}function xw(t,e){const n=uy(t,e),s=n.getPropertyValue("content");if(!(s===""||s==="none"))return hy(n,{defaultStyles:ra,parentStyles:ra})}function uI(t,{defaultStyles:e,parentStyles:n}){const s={},i={currentColor:t.get("color")?.toString()||"",parentStyles:n,defaultStyles:e,getStyle:o=>t.get(o)?.toString()??""};for(const o of t.keys()){if(!tI(o))continue;const a=t.get(o).toString();if(e[o]===a)continue;const c=Nt(lI,o);c&&c(a,o,i)||(s[o]=a)}return s}function hy(t,{defaultStyles:e,parentStyles:n}){const s={},i={currentColor:t.color,parentStyles:n,defaultStyles:e,getStyle:o=>t.getPropertyValue(o)};for(const o in t){if(!tI(o))continue;const a=t.getPropertyValue(o);if(e[o]===a)continue;const c=Nt(lI,o);c&&c(a,o,i)||(s[o]=a)}return s}function bw(t){let e="";for(const[n,s]of Object.entries(t))e+=`${n}: ${s};`;return e}let Xo;const ww={};function XL(){if(!Xo){const t=document.createElement("iframe");t.style.display="none",document.body.appendChild(t);const e=Gt(t.contentDocument,"frame must have a document"),n=document.createElementNS("http://www.w3.org/2000/svg","svg"),s=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");n.appendChild(s),e.body.appendChild(n),Xo={iframe:t,foreignObject:s,document:e}}return Xo}function ZL(){Xo&&(document.body.removeChild(Xo.iframe),Xo=void 0)}const vw={defaultStyles:ra,parentStyles:ra};function JL(t){let e=ww[t];if(!e){const{foreignObject:n,document:s}=XL(),r=s.createElement(t);n.appendChild(r),e=r.computedStyleMap?uI(r.computedStyleMap(),vw):hy(uy(r),vw),n.removeChild(r),ww[t]=e}return e}function QL(t,e){Array.from(t.attributes).forEach(s=>{e.setAttribute(s.name,s.value)})}function Pw(t,e){return t.replaceWith(e),e}async function hc(t,e){const n=document.createElement("img");e&&QL(e,n),n.setAttribute("src",t??"data:"),n.setAttribute("decoding","sync"),n.setAttribute("loading","eager");try{await n.decode()}catch{}return n}async function eR(t){try{const e=t.toDataURL();return await hc(e,t)}catch{return await hc(null,t)}}async function tR(t){try{const e=await ms.getVideoFrameAsDataUrl(t);return hc(e,t)}catch(e){console.error("Could not get video frame",e)}if(t.poster){const e=await hu(t.poster);return hc(e,t)}return hc(null,t)}async function hI(t){if(t instanceof HTMLCanvasElement)return Pw(t,await eR(t));if(t instanceof HTMLVideoElement)return Pw(t,await tR(t));if(t instanceof HTMLImageElement){const e=t.currentSrc||t.src,n=await hu(e);t.setAttribute("src",n??"data:"),t.setAttribute("decoding","sync"),t.setAttribute("loading","eager");try{await t.decode()}catch{}return t}else t instanceof HTMLInputElement?t.setAttribute("value",t.value):t instanceof HTMLTextAreaElement&&(t.textContent=t.value);await Promise.all(Array.from(Ag(t),e=>hI(e)))}const Mg=(t,e)=>t.props===e.props&&t.meta===e.meta,pI=v.memo(function({id:e,shape:n,util:s,index:r,backgroundIndex:i,opacity:o}){const a=z(),{ShapeErrorFallback:c,ShapeWrapper:l}=nt(),u=v.useRef(null),d=v.useRef(null);v.useEffect(()=>is("load fonts",()=>{const g=a.fonts.getShapeFontFaces(e);a.fonts.requestFonts(g)}),[a,e]);const p=v.useRef({transform:"",clipPath:"none",width:0,height:0,x:0,y:0,isCulled:!1});Qi("set shape stuff",()=>{const g=a.getShape(e);if(!g)return;const x=p.current,y=a.getShapeClipPath(e)??"none";y!==x.clipPath&&(bn(u.current,"clip-path",y),bn(d.current,"clip-path",y),x.clipPath=y);const m=a.getShapePageTransform(e),S=q.toCssString(m),w=a.getShapeGeometry(g).bounds;S!==x.transform&&(bn(u.current,"transform",S),bn(d.current,"transform",S),x.transform=S);const P=Math.max(w.width,1),_=Math.max(w.height,1);(P!==x.width||_!==x.height)&&(bn(u.current,"width",P+"px"),bn(u.current,"height",_+"px"),bn(d.current,"width",P+"px"),bn(d.current,"height",_+"px"),x.width=P,x.height=_)},[a]),v.useLayoutEffect(()=>{const g=u.current,x=d.current;bn(g,"opacity",o),bn(x,"opacity",o),bn(g,"z-index",r),bn(x,"z-index",i)},[o,r,i]),Qi("set display",()=>{if(!a.getShape(e))return;const y=a.getCulledShapes().has(e);y!==p.current.isCulled&&(bn(u.current,"display",y?"none":"block"),bn(d.current,"display",y?"none":"block"),p.current.isCulled=y)},[a]);const f=v.useCallback(g=>a.annotateError(g,{origin:"shape",willCrashApp:!1}),[a]);return!n||!l?null:h.jsxs(h.Fragment,{children:[s.backgroundComponent&&h.jsx(l,{ref:d,shape:n,isBackground:!0,children:h.jsx(Pc,{fallback:c,onError:f,children:h.jsx(gI,{shape:n,util:s})})}),h.jsx(l,{ref:u,shape:n,isBackground:!1,children:h.jsx(Pc,{fallback:c,onError:f,children:h.jsx(fI,{shape:n,util:s})})})]})}),fI=v.memo(function({shape:e,util:n}){return Jd("InnerShape:"+e.type,()=>n.component(n.editor.store.unsafeGetWithoutCapture(e.id)),[n,e.id])},(t,e)=>Mg(t.shape,e.shape)&&t.util===e.util),gI=v.memo(function({shape:e,util:n}){return Jd("InnerShape:"+e.type,()=>n.backgroundComponent?.(n.editor.store.unsafeGetWithoutCapture(e.id)),[n,e.id])},(t,e)=>t.shape.props===e.shape.props&&t.shape.meta===e.shape.meta&&t.util===e.util);function fr(t){const e=v.useRef(void 0);return v.useLayoutEffect(()=>{e.current=t}),v.useDebugValue(t),v.useCallback((...n)=>{const s=e.current;return le(s,"fn does not exist"),s(...n)},[])}const py=v.createContext(null);function nR({context:t,editor:e,children:n}){const s=e.options.exportProvider;return h.jsx(sy,{editor:e,children:h.jsx(EP,{container:e.getContainer(),children:h.jsx(py.Provider,{value:t,children:h.jsx(s,{children:n})})})})}function Jc(){return v.useContext(py)}function sR(){const t=v.useContext(py),[e]=v.useState(hm);return v.useEffect(()=>(t?.waitUntil(e),()=>{e.resolve()}),[e,t]),fr(()=>{e.resolve()})}var rR=Object.create,mI=Object.defineProperty,iR=Object.getOwnPropertyDescriptor,oR=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),yI=t=>{throw TypeError(t)},SI=(t,e,n)=>e in t?mI(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,aR=t=>[,,,rR(null)],xI=["class","method","getter","setter","accessor","field","value","get","set"],bI=t=>t!==void 0&&typeof t!="function"?yI("Function expected"):t,cR=(t,e,n,s,r)=>({kind:xI[t],name:e,metadata:s,addInitializer:i=>n._?yI("Already initialized"):r.push(bI(i||null))}),lR=(t,e)=>SI(e,oR("metadata"),t[3]),dR=(t,e,n,s)=>{for(var r=0,i=t[e>>1],o=i&&i.length;r<o;r++)i[r].call(n);return s},uR=(t,e,n,s,r,i)=>{for(var o,a,c,l,u=e&7,d=!1,p=!1,f=2,g=xI[u+5],x=t[f]||(t[f]=[]),y=(r=r.prototype,iR(r,n)),m=s.length-1;m>=0;m--)c=cR(u,n,a={},t[3],x),c.static=d,c.private=p,l=c.access={has:S=>n in S},l.get=S=>S[n],o=(0,s[m])(y[g],c),a._=1,bI(o)&&(y[g]=o);return y&&mI(r,n,y),r},Iw=(t,e,n)=>SI(t,typeof e!="symbol"?e+"":e,n),wI,gu;wI=[rs];class fy{constructor(e){this.maxDelayTimeMs=e,dR(gu,5,this),Iw(this,"isResolved",!1),Iw(this,"promisesToWaitFor",[])}waitUntil(e){if(this.isResolved)throw new Error("Cannot `waitUntil` - the export has already been resolved. Make sure to call `waitUntil` as soon as possible during an export - ie within the first react effect after rendering.");this.promisesToWaitFor.push(e.catch(n=>console.error("Error while waiting for export:",n)))}async resolvePromises(){let e=null;for(;this.promisesToWaitFor.length!==e;)e=this.promisesToWaitFor.length,await Promise.allSettled(this.promisesToWaitFor),await pg(0)}async resolve(){const e=pg(this.maxDelayTimeMs).then(()=>"timeout"),n=this.resolvePromises().then(()=>"resolved");await Promise.race([e,n])==="timeout"&&console.warn("[tldraw] Export delay timed out after ${this.maxDelayTimeMs}ms"),this.isResolved=!0}}gu=aR();uR(gu,1,"waitUntil",wI,fy);lR(gu,fy);function hR(t,e,n={}){if(!window.document)throw Error("No document");const{scale:s=1,background:r=t.getInstanceState().exportBackground,padding:i=t.options.defaultSvgPadding,preserveAspectRatio:o}=n,a=n.darkMode??t.user.getIsDarkMode(),c=t.getShapeAndDescendantIds(e),l=t.getUnorderedRenderingShapes(!1).filter(({id:m})=>c.has(m)),u=e.length===1&&t.isShapeOfType(t.getShape(e[0]),"frame")?e[0]:null;let d=null;if(n.bounds?d=n.bounds.clone().expandBy(i):d=pR(t,l,i,u),!d)return;const p=d.width*s,f=d.height*s;try{document.body.focus?.()}catch{}const g=new fy(t.options.maxExportDelayMs),x=hm();return g.waitUntil(x),{jsx:h.jsx(fR,{editor:t,preserveAspectRatio:o,scale:s,pixelRatio:n.pixelRatio??null,bbox:d,background:r,singleFrameShapeId:u,isDarkMode:a,renderingShapes:l,onMount:x.resolve,waitUntil:g.waitUntil}),width:p,height:f,exportDelay:g}}function pR(t,e,n,s){let r=!1,i=null;for(const{id:o}of e){const a=t.getShapeMaskedPageBounds(o);if(!a)continue;const c=t.getShape(o),l=t.getShapeUtil(c).isExportBoundsContainer(c);i?l&&X.ContainsApproximately(a,i)?(r=!0,i=a.clone()):(r&&!X.ContainsApproximately(i,a)&&(r=!1),i.union(a)):(r=l,i=a.clone())}return i?(!s&&!r&&i.expandBy(n),i):null}function fR({editor:t,preserveAspectRatio:e,scale:n,pixelRatio:s,bbox:r,background:i,singleFrameShapeId:o,isDarkMode:a,renderingShapes:c,onMount:l,waitUntil:u}){const d=yo(),p=Fi({isDarkMode:a}),f=Hc("export state",{defsById:{},shapeElements:null}),{defsById:g,shapeElements:x}=$(f),y=fr(P=>{f.update(_=>{if(Ut(_.defsById,P.key))return _;const I=Promise.resolve(P.getElement());return u(I.then(C=>{f.update(E=>({...E,defsById:{...E.defsById,[P.key]:{pending:!1,element:C}}}))})),{..._,defsById:{..._.defsById,[P.key]:{pending:!0,element:I}}}})}),m=v.useMemo(()=>({isDarkMode:a,waitUntil:u,addExportDef:y,scale:n,pixelRatio:s,async resolveAssetUrl(P,_){const I=t.getAsset(P);return!I||I.type!=="image"&&I.type!=="video"?null:await t.resolveAssetUrl(P,{screenScale:n*(_/I.props.w),shouldResolveToOriginal:s===null,dpr:s??void 0})}}),[a,u,y,n,s,t]),S=v.useRef(!1);v.useLayoutEffect(()=>{if(S.current)throw new Error("SvgExport should only render once - do not use with react strict mode");S.current=!0,(async()=>{const P={},_=c.map(async({id:C,opacity:E,index:O,backgroundIndex:k})=>{if(C===o)return[];const T=t.getShape(C);if(t.isShapeOfType(T,"group"))return[];const D=[],R=t.getShapeUtil(T);if(R.toSvg||R.toBackgroundSvg){const[M,L]=await Promise.all([R.toSvg?.(T,m),R.toBackgroundSvg?.(T,m)]),U=t.getShapePageTransform(T);let V=U.toCssString(),J=1;"scale"in T.props&&T.props.scale!==1&&(J=T.props.scale,V=`${V} scale(${T.props.scale}, ${T.props.scale})`);const Z=t.getShapeMask(T.id),Q=Z?q.From(q.Inverse(U)).applyToPoints(Z):null,Y=ty(d,T.id);Q&&(P[Y]={pending:!1,element:h.jsx("clipPath",{id:Y,children:h.jsx("path",{d:`M${Q.map(({x:Ie,y:be})=>`${Ie/J},${be/J}`).join("L")}Z`})})}),M&&D.push({zIndex:O,element:h.jsx("g",{transform:V,opacity:E,clipPath:Z?`url(#${Y})`:void 0,children:M},`fg_${T.id}`)}),L&&D.push({zIndex:k,element:h.jsx("g",{transform:V,opacity:E,clipPath:Z?`url(#${Y})`:void 0,children:L},`bg_${T.id}`)})}else D.push({zIndex:O,element:h.jsx(_w,{shape:T,util:R,component:fI,className:"tl-shape",bbox:r,opacity:E},`fg_${T.id}`)}),R.backgroundComponent&&D.push({zIndex:k,element:h.jsx(_w,{shape:T,util:R,component:gI,className:"tl-shape tl-shape-background",bbox:r,opacity:E},`bg_${T.id}`)});return D}),I=(await Promise.all(_)).flat();nm.flushSync(()=>{f.update(C=>({...C,shapeElements:I.sort((E,O)=>E.zIndex-O.zIndex).map(({element:E})=>E),defsById:{...C.defsById,...P}}))})})()},[r,t,m,d,c,o,f]),v.useEffect(()=>{const P=new Set;for(const{id:_}of c)for(const I of t.fonts.getShapeFontFaces(_))P.add(I);for(const _ of P)y({key:Ge(),getElement:async()=>{const I=await t.fonts.toEmbeddedCssDeclaration(_);return h.jsx("style",{nonce:t.options.nonce,children:I})}})},[t,c,y]),v.useEffect(()=>{x!==null&&l()},[l,x]);let w=i?p.background:"transparent";if(o&&i)if(t.getShapeUtil("frame")?.options.showColors){const _=t.getShape(o);w=Ue(p,_.props.color,"frameFill")}else w=p.solid;return h.jsx(nR,{editor:t,context:m,children:h.jsxs("svg",{preserveAspectRatio:e,direction:"ltr",width:r.width*n,height:r.height*n,viewBox:`${r.minX} ${r.minY} ${r.width} ${r.height}`,strokeLinecap:"round",strokeLinejoin:"round",style:{backgroundColor:w},"data-color-mode":a?"dark":"light",className:`tl-container tl-theme__force-sRGB ${a?"tl-theme__dark":"tl-theme__light"}`,children:[h.jsx("defs",{children:Object.entries(g).map(([P,_])=>_.pending?null:h.jsx(v.Fragment,{children:_.element},P))}),x]})})}function _w({shape:t,util:e,className:n,component:s,bbox:r,opacity:i}){const o=z(),a=q.Translate(-r.minX,-r.minY).multiply(o.getShapePageTransform(t.id)),c=o.getShapeGeometry(t.id).bounds,l=Math.max(c.width,1),u=Math.max(c.height,1);return h.jsx(ry,{fallback:()=>null,children:h.jsx("foreignObject",{x:r.minX,y:r.minY,width:r.w,height:r.h,className:"tl-shape-foreign-object tl-export-embed-styles",children:h.jsx("div",{className:n,"data-shape-type":t.type,style:{clipPath:o.getShapeClipPath(t.id),transform:a.toCssString(),width:l,height:u,opacity:i},children:h.jsx(s,{shape:t,util:e})})})})}let gR=1;async function mR(t,e,n={}){const s=hR(t,e,n);if(!s)return;const r=t.getContainer(),i=document.createElement("div");i.className=cI,i.inert=!0,i.tabIndex=-1,Object.assign(i.style,{position:"absolute",top:"0px",left:"0px",width:s.width+"px",height:s.height+"px",pointerEvents:"none",opacity:0}),r.appendChild(i);const o=gk.createRoot(i,{identifierPrefix:`export_${gR++}_`});try{await Promise.resolve(),nm.flushSync(()=>{o.render(s.jsx)}),await s.exportDelay.resolve();const a=i.firstElementChild;return le(a instanceof SVGSVGElement,"Expected an SVG element"),await yR(a),{svg:a,width:s.width,height:s.height}}finally{setTimeout(()=>{o.unmount(),r.removeChild(i)},0)}}async function yR(t){const e=[...t.querySelectorAll("foreignObject.tl-export-embed-styles > *")];if(!e.length)return;const n=new YL(t);try{n.fonts.startFindingCurrentDocumentFontFaces(),await Promise.all(e.map(i=>hI(i)));for(const i of e)n.readRootElementStyles(i);await n.fetchResources();const s=await n.getFontFaceCss();n.unwrapCustomElements();const r=n.embedStyles();if(s||r){const i=document.createElementNS("http://www.w3.org/2000/svg","style");i.textContent=`${s}
${r}`,t.prepend(i)}}finally{n.dispose()}}let Nf=null;function SR(){return Nf||(Nf={maxWidth:Uf("width"),maxHeight:Uf("height"),maxArea:Uf("area")}),Nf}const Cw=8192,xR=4096*4096,bR={area:[16384,14188,11402,11180,10836,8192,4096],height:[8388607,65535,32767,16384,8192,4096],width:[4194303,65535,32767,16384,8192,4096]};function Uf(t){const e=document.createElement("canvas");e.width=1,e.height=1;const n=e.getContext("2d");for(const s of bR[t]){const r=t==="height"?1:s,i=t==="width"?1:s,o=document.createElement("canvas");o.width=r,o.height=i,o.getContext("2d").fillRect(r-1,i-1,1,1),n.drawImage(o,r-1,i-1,1,1,0,0,1,1);const c=n.getImageData(0,0,1,1).data[3]!==0;if(o.width=0,o.height=0,c)return e.width=0,e.height=0,t==="area"?s*s:s}throw e.width=0,e.height=0,Error("Failed to determine maximum canvas dimension")}function wR(t,e){if(t<=Cw&&e<=Cw&&t*e<=xR)return[t,e];const{maxWidth:n,maxHeight:s,maxArea:r}=SR(),i=t/e;if(t>n&&(t=n,e=t/i),e>s&&(e=s,t=e*i),t*e>r){const o=Math.sqrt(r/(t*e));t*=o,e*=o}return[t,e]}async function vR(t,e){const{type:n,width:s,height:r,quality:i=1,pixelRatio:o=2}=e;let[a,c]=wR(s*o,r*o);a=Math.floor(a),c=Math.floor(c);const l=a/s,u=await vn.blobToDataUrl(new Blob([t],{type:"image/svg+xml"})),d=await new Promise(f=>{const g=Sc();g.crossOrigin="anonymous",g.onload=async()=>{qe.isSafari&&await pg(250);const x=document.createElement("canvas"),y=x.getContext("2d");x.width=a,x.height=c,y.imageSmoothingEnabled=!0,y.imageSmoothingQuality="high",y.drawImage(g,0,0,a,c),URL.revokeObjectURL(u),f(x)},g.onerror=()=>{f(null)},g.src=u});if(!d)return null;const p=await new Promise(f=>d.toBlob(g=>{(!g||mt.throwToBlob.get())&&f(null),f(g)},"image/"+n,i));if(!p)return null;if(n==="png"){const f=new DataView(await p.arrayBuffer());return gr.setPhysChunk(f,l,{type:"image/"+n})}else return p}const Ln={menus:je("open menus",[]),getOpenMenus(t){return t?this.menus.get().filter(e=>e.endsWith("-"+t)):this.menus.get()},addOpenMenu(t,e=""){const n=e?`${t}-${e}`:t,s=new Set(this.menus.get());s.has(n)||(s.add(n),this.menus.set([...s]))},deleteOpenMenu(t,e=""){const n=e?`${t}-${e}`:t,s=new Set(this.menus.get());s.has(n)&&(s.delete(n),this.menus.set([...s]))},clearOpenMenus(t){this.menus.set(t?this.menus.get().filter(e=>!e.endsWith("-"+t)):[])},_hiddenMenus:[],hideOpenMenus(t){if(this._hiddenMenus=[...this.getOpenMenus(t)],this._hiddenMenus.length!==0)for(const e of this._hiddenMenus)this.deleteOpenMenu(e,t)},showOpenMenus(t){if(this._hiddenMenus.length!==0){for(const e of this._hiddenMenus)this.addOpenMenu(e,t);this._hiddenMenus=[]}},isMenuOpen(t,e){return this.getOpenMenus(e).includes(`${t}-${e}`)},hasOpenMenus(t){return this.getOpenMenus(t).length>0},hasAnyOpenMenus(){return this.getOpenMenus().length>0},forContext(t){return{getOpenMenus:()=>this.getOpenMenus(t),addOpenMenu:e=>this.addOpenMenu(e,t),deleteOpenMenu:e=>this.deleteOpenMenu(e,t),clearOpenMenus:()=>this.clearOpenMenus(t),isMenuOpen:e=>this.isMenuOpen(e,t),hasOpenMenus:()=>this.hasOpenMenus(t),hasAnyOpenMenus:()=>this.hasAnyOpenMenus()}}},Od=new ZA,PR={maxShapesPerPage:4e3,maxFilesAtOnce:100,maxPages:40,animationMediumMs:320,followChaseViewportSnap:2,doubleClickDurationMs:450,multiClickDurationMs:200,coarseDragDistanceSquared:36,dragDistanceSquared:16,uiDragDistanceSquared:16,uiCoarseDragDistanceSquared:625,defaultSvgPadding:32,cameraSlideFriction:.09,gridSteps:[{min:-1,mid:.15,step:64},{min:.05,mid:.375,step:16},{min:.15,mid:1,step:4},{min:.7,mid:2.5,step:1}],collaboratorInactiveTimeoutMs:6e4,collaboratorIdleTimeoutMs:3e3,collaboratorCheckIntervalMs:1200,cameraMovingTimeoutMs:64,hitTestMargin:8,edgeScrollDelay:200,edgeScrollEaseDuration:200,edgeScrollSpeed:25,edgeScrollDistance:8,coarsePointerWidth:12,coarseHandleRadius:20,handleRadius:12,longPressDurationMs:500,textShadowLod:.35,adjacentShapeMargin:10,flattenImageBoundsExpand:64,flattenImageBoundsPadding:16,laserDelayMs:1200,maxExportDelayMs:5e3,tooltipDelayMs:700,temporaryAssetPreviewLifetimeMs:18e4,actionShortcutsLocation:"swap",createTextOnCanvasDoubleClick:!0,exportProvider:v.Fragment,enableToolbarKeyboardShortcuts:!0,maxFontsToLoadBeforeRender:1/0,nonce:void 0,debouncedZoom:!0,debouncedZoomThreshold:500,spacebarPanning:!0,zoomToFitPadding:128,snapThreshold:8};function Tw(t,e){if(!e)return!1;switch(t.type){case"mixed":return e.type==="mixed";case"shared":return e.type==="shared"&&t.value===e.value;default:throw Ke(t)}}class IR{map;constructor(e){this.map=new Map(e)}get(e){return this.map.get(e)}getAsKnownValue(e){const n=this.get(e);if(n&&n.type!=="mixed")return n.value}get size(){return this.map.size}equals(e){if(this.size!==e.size)return!1;const n=new Set;for(const[s,r]of this){if(!Tw(r,e.get(s)))return!1;n.add(s)}for(const[s,r]of e)if(!n.has(s)&&!Tw(r,this.get(s)))return!1;return!0}keys(){return this.map.keys()}values(){return this.map.values()}entries(){return this.map.entries()}[Symbol.iterator](){return this.map[Symbol.iterator]()}}class jg extends IR{set(e,n){this.map.set(e,n)}applyValue(e,n){const s=this.get(e);if(!s){this.set(e,{type:"shared",value:n});return}switch(s.type){case"mixed":return;case"shared":s.value!==n&&this.set(e,{type:"mixed"});return;default:Ke(s,"type")}}}function _R(t,e,n){return Qr(t).then(function(s){return s.arrayBuffer()}).then(function(s){return new File([s],e,{type:n})})}const CR="https://cdn.tldraw.com";function Bt(){return`${CR}/${iy}`}function TR(t){switch(t.type){case"shapes":return`s${t.shapeIds.map(n=>Hf(n.slice(6))).join(".")}`;case"page":return"p"+Hf(zn.parseId(t.pageId));case"viewport":{const{bounds:e,pageId:n}=t;let s=`v${Math.round(e.x)}.${Math.round(e.y)}.${Math.round(e.w)}.${Math.round(e.h)}`;return n&&(s+="."+Hf(zn.parseId(n))),s}default:Ke(t)}}function ER(t){switch(t[0]){case"s":return{type:"shapes",shapeIds:t.slice(1).split(".").filter(Boolean).map(s=>tt(decodeURIComponent(s)))};case"p":return{type:"page",pageId:zn.createId(decodeURIComponent(t.slice(1)))};case"v":{const[n,s,r,i,o]=t.slice(1).split(".");return{type:"viewport",bounds:new X(Number(n),Number(s),Number(r),Number(i)),pageId:o?zn.createId(decodeURIComponent(o)):void 0}}default:throw Error("Invalid deep link string")}}function Hf(t){return encodeURIComponent(t).replace(/\./g,"%2E")}function kR(t,e){let n=t;const s=new Set(e);for(;s.has(n);)n=/^.*(\d+)$/.exec(n)?.[1]?n.replace(/(\d+)(?=\D?)$/,r=>(+r+1).toString()):`${n} 1`;return n}function Ol(t,e,n,s){if(n.length===0)return[];const r=new Map;for(const o of ve(n.map(a=>t.getShape(a)))){const{parentId:a}=o;r.has(a)||r.set(a,{children:ve(t.getSortedChildIdsForParent(a).map(c=>t.getShape(c))),moving:new Set}),r.get(a).moving.add(o)}const i=[];switch(e){case"toBack":{r.forEach(({moving:o,children:a})=>AR(o,a,i));break}case"toFront":{r.forEach(({moving:o,children:a})=>MR(o,a,i));break}case"forward":{r.forEach(({moving:o,children:a})=>jR(t,o,a,i,s));break}case"backward":{r.forEach(({moving:o,children:a})=>DR(t,o,a,i,s));break}}return i}function AR(t,e,n){const s=e.length;if(t.size===s)return;let r,i;for(let o=0;o<s;o++){const a=e[o];if(t.has(a))r=a.index,t.delete(a);else{i=a.index;break}}if(t.size!==0){const o=Ji(r,i,t.size);n.push(...Array.from(t.values()).sort(Yt).map((a,c)=>({...a,index:o[c]})))}}function MR(t,e,n){const s=e.length;if(t.size===s)return;let r,i;for(let o=s-1;o>-1;o--){const a=e[o];if(t.has(a))i=a.index,t.delete(a);else{r=a.index;break}}if(t.size!==0){const o=Ji(r,i,t.size);n.push(...Array.from(t.values()).sort(Yt).map((a,c)=>({...a,index:o[c]})))}}function vI(t,e){const n=ve(Array.from(e).map(r=>{const i=t.getShapePageBounds(r);return i?{shape:r,bounds:i}:null}));return r=>{const i=t.getShapePageBounds(r);return i?n.some(o=>o.bounds.includes(i)):!1}}function jR(t,e,n,s,r){const i=vI(t,e),o=n.length;if(e.size===o)return;let a={name:"skipping"};for(let c=0;c<o;c++){const l=e.has(n[c]);switch(a.name){case"skipping":{if(!l)continue;a={name:"selecting",selectIndex:c};break}case"selecting":{if(l||!r?.considerAllShapes&&!i(n[c]))continue;const{selectIndex:u}=a;Ji(n[c].index,n[c+1]?.index,c-u).forEach((d,p)=>{const f=n[u+p];e.has(f)&&s.push({...f,index:d})}),a={name:"skipping"};break}}}}function DR(t,e,n,s,r){const i=vI(t,e),o=n.length;if(e.size===o)return;let a={name:"skipping"};for(let c=o-1;c>-1;c--){const l=e.has(n[c]);switch(a.name){case"skipping":{if(!l)continue;a={name:"selecting",selectIndex:c};break}case"selecting":{if(l||!r?.considerAllShapes&&!i(n[c]))continue;Ji(n[c-1]?.index,n[c].index,a.selectIndex-c).forEach((u,d)=>{const p=n[c+d+1];e.has(p)&&s.push({...p,index:u})}),a={name:"skipping"};break}}}}function PI({editor:t,ids:e}){const n=ve(e.map(o=>t.getShape(o))),s=t.getShapesSharedRotation(e),r=t.getShapesRotatedPageBounds(e);if(!r)return null;const i=r.center.clone().rotWith(r.point,s);return{initialPageCenter:i,initialCursorAngle:i.angle(t.inputs.getOriginPagePoint()),initialShapesRotation:s,shapeSnapshots:n.map(o=>({shape:o,initialPagePoint:t.getShapePageTransform(o.id).point()}))}}function ad({delta:t,editor:e,snapshot:n,stage:s,centerOverride:r}){const{initialPageCenter:i,shapeSnapshots:o}=n;e.updateShapes(o.map(({shape:c,initialPagePoint:l})=>{const u=On(c.parentId)?e.getShapePageTransform(c.parentId):q.Identity(),d=b.RotWith(l,r??i,t),p=q.applyToPoint(q.Inverse(u),d),f=kd(c.rotation+t);return{id:c.id,type:c.type,x:p.x,y:p.y,rotation:f}}));const a=[];o.forEach(({shape:c})=>{const l=e.getShape(c.id);if(!l)return;const u=e.getShapeUtil(c);if(s==="start"||s==="one-off"){const p=u.onRotateStart?.(c);p&&a.push(p)}const d=u.onRotate?.(c,l);if(d&&a.push(d),s==="end"||s==="one-off"){const p=u.onRotateEnd?.(c,l);p&&a.push(p)}}),a.length>0&&e.updateShapes(a)}function Ew(t){const e=t.get(),n=new Map;for(const s of e){const{fromId:r,toId:i}=s,o=n.get(r);o?o.push(s):n.set(r,[s]);const a=n.get(i);a?a.push(s):n.set(i,[s])}return n}const OR=t=>{const{store:e}=t,n=e.query.filterHistory("binding"),s=e.query.records("binding");return K("arrowBindingsIndex",(r,i)=>{if(Xi(r))return Ew(s);const o=r,a=n.getDiffSince(i);if(a===Ss)return Ew(s);let c;function l(p){c??=new Map(o);const g=c.get(p.fromId)?.filter(m=>m.id!==p.id);g?.length?c.set(p.fromId,g):c.delete(p.fromId);const y=c.get(p.toId)?.filter(m=>m.id!==p.id);y?.length?c.set(p.toId,y):c.delete(p.toId)}function u(p){c??=new Map(o);let f=c.get(p);return f?f===o.get(p)&&(f=f.slice(0),c.set(p,f)):(f=[],c.set(p,f)),f}function d(p){u(p.fromId).push(p),u(p.toId).push(p)}for(const p of a){for(const f of _t(p.added))d(f);for(const[f,g]of _t(p.updated))l(f),d(g);for(const f of _t(p.removed))l(f)}return c??o})};function LR(t){return K("notVisibleShapes",function(n){const s=t.getCurrentPageShapeIds(),r=new Set,i=t.getViewportPageBounds(),o=i.minX,a=i.minY,c=i.maxX,l=i.maxY;for(const u of s){const d=t.getShapePageBounds(u);if(d!==void 0&&d.maxX>=o&&d.minX<=c&&d.maxY>=a&&d.minY<=l)continue;const p=t.getShape(u);!p||!t.getShapeUtil(p.type).canCull(p)||r.add(u)}if(Xi(n)||n.size!==r.size)return r;for(const u of n)if(!r.has(u))return r;return n})}function kw(t,e){const n={},s=t.get();return Array.from(s,i=>e.get(i)).sort(Yt).forEach(i=>{n[i.parentId]??=[],n[i.parentId].push(i.id)}),n}const RR=t=>{const e=t.query.ids("shape"),n=t.query.filterHistory("shape");return K("parentsToChildrenWithIndexes",(s,r)=>{if(Xi(s))return kw(e,t);const i=n.getDiffSince(r);if(i===Ss)return kw(e,t);if(i.length===0)return s;let o=null;const a=u=>{o||(o={...s}),o[u]?o[u]===s[u]&&(o[u]=[...o[u]]):o[u]=[]},c=new Set;let l;for(let u=0,d=i.length;u<d;u++){l=i[u];for(const p of Object.values(l.added))zo(p)&&(a(p.parentId),o[p.parentId].push(p.id),c.add(o[p.parentId]));for(const[p,f]of Object.values(l.updated))if(zo(f)&&zo(p)){if(p.parentId!==f.parentId)a(p.parentId),a(f.parentId),o[p.parentId].splice(o[p.parentId].indexOf(f.id),1),o[f.parentId].push(f.id),c.add(o[f.parentId]);else if(p.index!==f.index){a(f.parentId);const g=o[f.parentId].indexOf(f.id);o[f.parentId][g]=f.id,c.add(o[f.parentId])}}for(const p of Object.values(l.removed))zo(p)&&(a(p.parentId),o[p.parentId].splice(o[p.parentId].indexOf(p.id),1))}for(const u of c){let d=0;for(let p=0;p<u.length;p++)t.get(u[p])&&(u[d++]=u[p]);u.length=d,u.sort((p,f)=>{const g=t.get(p),x=t.get(f);return Yt(g,x)})}return o??s})},Kf=(t,e,n)=>{for(;!nn(n.parentId);){const s=t.get(n.parentId);if(!s)return!1;n=s}return n.parentId===e},FR=(t,e)=>{const n=t.query.ids("shape");let s=null;function r(){const i=e();return s=i,new Set([...n.get()].filter(o=>Kf(t,i,t.get(o))))}return K("_shapeIdsInCurrentPage",(i,o)=>{if(Xi(i))return r();const a=e();if(a!==s)return r();const c=t.history.getDiffSince(o);if(c===Ss)return r();const l=new sd(i);for(const d of c){for(const p of Object.values(d.added))zo(p)&&Kf(t,a,p)&&l.add(p.id);for(const[p,f]of Object.values(d.updated))zo(f)&&(Kf(t,a,f)?l.add(f.id):l.remove(f.id));for(const p of Object.keys(d.removed))On(p)&&l.remove(p)}const u=l.get();return u?Ga(u.value,u.diff):i})};var BR=Object.create,II=Object.defineProperty,zR=Object.getOwnPropertyDescriptor,$R=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),_I=t=>{throw TypeError(t)},CI=(t,e,n)=>e in t?II(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,NR=t=>[,,,BR(null)],TI=["class","method","getter","setter","accessor","field","value","get","set"],EI=t=>t!==void 0&&typeof t!="function"?_I("Function expected"):t,UR=(t,e,n,s,r)=>({kind:TI[t],name:e,metadata:s,addInitializer:i=>n._?_I("Already initialized"):r.push(EI(i||null))}),HR=(t,e)=>CI(e,$R("metadata"),t[3]),KR=(t,e,n,s)=>{for(var r=0,i=t[e>>1],o=i&&i.length;r<o;r++)i[r].call(n);return s},kI=(t,e,n,s,r,i)=>{for(var o,a,c,l,u=e&7,d=!1,p=!1,f=2,g=TI[u+5],x=t[f]||(t[f]=[]),y=(r=r.prototype,zR(r,n)),m=s.length-1;m>=0;m--)c=UR(u,n,a={},t[3],x),c.static=d,c.private=p,l=c.access={has:S=>n in S},l.get=S=>S[n],o=(0,s[m])(y[g],c),a._=1,EI(o)&&(y[g]=o);return y&&II(r,n,y),r},Io=(t,e,n)=>CI(t,typeof e!="symbol"?e+"":e,n),AI,MI,Qc;const WR=40;MI=[rs],AI=[rs];class mu{constructor(e){this.editor=e,KR(Qc,5,this),Io(this,"_clickId",""),Io(this,"_clickTimeout"),Io(this,"_clickScreenPoint"),Io(this,"_previousScreenPoint"),Io(this,"_clickState","idle"),Io(this,"lastPointerInfo",{})}_getClickTimeout(e,n=Ge()){this._clickId=n,clearTimeout(this._clickTimeout),this._clickTimeout=this.editor.timers.setTimeout(()=>{if(this._clickState===e&&this._clickId===n){switch(this._clickState){case"pendingTriple":{this.editor.dispatch({...this.lastPointerInfo,type:"click",name:"double_click",phase:"settle"});break}case"pendingQuadruple":{this.editor.dispatch({...this.lastPointerInfo,type:"click",name:"triple_click",phase:"settle"});break}case"pendingOverflow":{this.editor.dispatch({...this.lastPointerInfo,type:"click",name:"quadruple_click",phase:"settle"});break}}this._clickState="idle"}},e==="idle"||e==="pendingDouble"?this.editor.options.doubleClickDurationMs:this.editor.options.multiClickDurationMs)}get clickState(){return this._clickState}handlePointerEvent(e){switch(e.name){case"pointer_down":{if(!this._clickState)return e;switch(this._clickScreenPoint=b.From(e.point),this._previousScreenPoint&&b.Dist2(this._previousScreenPoint,this._clickScreenPoint)>WR**2&&(this._clickState="idle"),this._previousScreenPoint=this._clickScreenPoint,this.lastPointerInfo=e,this._clickState){case"pendingDouble":return this._clickState="pendingTriple",this._clickTimeout=this._getClickTimeout(this._clickState),{...e,type:"click",name:"double_click",phase:"down"};case"pendingTriple":return this._clickState="pendingQuadruple",this._clickTimeout=this._getClickTimeout(this._clickState),{...e,type:"click",name:"triple_click",phase:"down"};case"pendingQuadruple":return this._clickState="pendingOverflow",this._clickTimeout=this._getClickTimeout(this._clickState),{...e,type:"click",name:"quadruple_click",phase:"down"};case"idle":{this._clickState="pendingDouble";break}case"pendingOverflow":{this._clickState="overflow";break}}return this._clickTimeout=this._getClickTimeout(this._clickState),e}case"pointer_up":{if(!this._clickState)return e;switch(this._clickScreenPoint=b.From(e.point),this._clickState){case"pendingTriple":return{...this.lastPointerInfo,type:"click",name:"double_click",phase:"up"};case"pendingQuadruple":return{...this.lastPointerInfo,type:"click",name:"triple_click",phase:"up"};case"pendingOverflow":return{...this.lastPointerInfo,type:"click",name:"quadruple_click",phase:"up"}}return e}case"pointer_move":return this._clickState!=="idle"&&this._clickScreenPoint&&b.Dist2(this._clickScreenPoint,this.editor.inputs.getCurrentScreenPoint())>(this.editor.getInstanceState().isCoarsePointer?this.editor.options.coarseDragDistanceSquared:this.editor.options.dragDistanceSquared)&&this.cancelDoubleClickTimeout(),e}return e}cancelDoubleClickTimeout(){this._clickTimeout=clearTimeout(this._clickTimeout),this._clickState="idle"}}Qc=NR();kI(Qc,1,"_getClickTimeout",MI,mu);kI(Qc,1,"cancelDoubleClickTimeout",AI,mu);HR(Qc,mu);class qR{constructor(e){this.editor=e}_isEdgeScrolling=!1;_edgeScrollDuration=-1;getIsEdgeScrolling(){return this._isEdgeScrolling}updateEdgeScrolling(e){const{editor:n}=this,s=this.getEdgeScroll();if(s.x===0&&s.y===0)this._isEdgeScrolling&&(this._isEdgeScrolling=!1,this._edgeScrollDuration=0);else if(this._isEdgeScrolling||(this._isEdgeScrolling=!0,this._edgeScrollDuration=0),this._edgeScrollDuration+=e,this._edgeScrollDuration>n.options.edgeScrollDelay){const r=n.options.edgeScrollEaseDuration>0?Pn.easeInCubic(Math.min(1,this._edgeScrollDuration/(n.options.edgeScrollDelay+n.options.edgeScrollEaseDuration))):1;this.moveCameraWhenCloseToEdge({x:s.x*r,y:s.y*r})}}getEdgeProximityFactors(e,n,s,r,i){const{editor:o}=this,a=o.options.edgeScrollDistance,c=s?o.options.coarsePointerWidth:0,l=e-c,u=e+c,d=r?0:a,p=i?n:n-a;return l<d?Math.min(1,(d-l)/a):u>p?-Math.min(1,(u-p)/a):0}getEdgeScroll(){const{editor:e}=this,{x:n,y:s}=e.inputs.getCurrentScreenPoint(),r=e.getViewportScreenBounds(),{isCoarsePointer:i,insets:[o,a,c,l]}=e.getInstanceState(),u=this.getEdgeProximityFactors(n,r.w,i,l,a),d=this.getEdgeProximityFactors(s,r.h,i,o,c);return{x:u,y:d}}moveCameraWhenCloseToEdge(e){const{editor:n}=this;if(!n.inputs.getIsDragging()||n.inputs.getIsPanning()||n.getCameraOptions().isLocked||e.x===0&&e.y===0)return;const s=n.getViewportScreenBounds(),r=s.w<1e3?.612:1,i=s.h<1e3?.612:1,o=n.getZoomLevel(),a=n.user.getEdgeScrollSpeed()*n.options.edgeScrollSpeed,c=a*e.x*r/o,l=a*e.y*i/o,{x:u,y:d,z:p}=n.getCamera();n.setCamera(new b(u+c,d+l,p))}}class GR{constructor(e,n){this.editor=e,this.disposeSideEffectListener=e.sideEffects.registerAfterChangeHandler("instance",(r,i)=>{r.isFocused!==i.isFocused&&this.updateContainerClass()});const s=e.getInstanceState().isFocused;n!==s&&e.updateInstanceState({isFocused:!!n}),this.updateContainerClass(),document.body.addEventListener("keydown",this.handleKeyDown.bind(this)),document.body.addEventListener("mousedown",this.handleMouseDown.bind(this))}disposeSideEffectListener;updateContainerClass(){const e=this.editor.getContainer();this.editor.getInstanceState().isFocused?e.classList.add("tl-container__focused"):e.classList.remove("tl-container__focused"),e.classList.add("tl-container__no-focus-ring")}handleKeyDown(e){const n=this.editor.getContainer(),s=document.activeElement;this.editor.isIn("select.editing_shape")&&!s?.closest(".tlui-contextual-toolbar")||s===n&&this.editor.getSelectedShapeIds().length>0||["Tab","ArrowUp","ArrowDown"].includes(e.key)&&n.classList.remove("tl-container__no-focus-ring")}handleMouseDown(){this.editor.getContainer().classList.add("tl-container__no-focus-ring")}focus(){this.editor.getContainer().focus()}blur(){this.editor.complete(),this.editor.getContainer().blur()}dispose(){document.body.removeEventListener("keydown",this.handleKeyDown.bind(this)),document.body.removeEventListener("mousedown",this.handleMouseDown.bind(this)),this.disposeSideEffectListener?.()}}class YR{constructor(e,n){this.editor=e,this.assetUrls=n,this.shapeFontFacesCache=e.store.createComputedCache("shape font faces",s=>this.editor.getShapeUtil(s).getFontFaces(s),{areResultsEqual:ud,areRecordsEqual:(s,r)=>s.props===r.props&&s.meta===r.meta}),this.shapeFontLoadStateCache=e.store.createCache(s=>{const r=K("font faces",()=>this.getShapeFontFaces(s));return K("font load state",()=>r.get().map(o=>this.getFontState(o)),{isEqual:ud})})}shapeFontFacesCache;shapeFontLoadStateCache;getShapeFontFaces(e){const n=typeof e=="string"?e:e.id;return this.shapeFontFacesCache.get(n)??Ct}trackFontsForShape(e){const n=typeof e=="string"?e:e.id;this.shapeFontLoadStateCache.get(n)}async loadRequiredFontsForCurrentPage(e=1/0){const n=new Set;for(const r of this.editor.getCurrentPageShapeIds())for(const i of this.getShapeFontFaces(this.editor.getShape(r)))n.add(i);if(n.size>e)return;const s=Array.from(n,r=>this.ensureFontIsLoaded(r));await Promise.all(s)}fontStates=new md("font states");getFontState(e){return this.fontStates.get(e)??null}ensureFontIsLoaded(e){const n=this.getFontState(e);if(n)return n.loadingPromise;const s=this.findOrCreateFontFace(e),r={state:"loading",instance:s,loadingPromise:s.load().then(()=>{document.fonts.add(s),this.fontStates.update(e,i=>({...i,state:"ready"}))}).catch(i=>{console.error(i),this.fontStates.update(e,o=>({...o,state:"error"}))})};return this.fontStates.set(e,r),r.loadingPromise}fontsToLoad=new Set;requestFonts(e){this.fontsToLoad.size||queueMicrotask(()=>{if(this.editor.isDisposed)return;const n=this.fontsToLoad;this.fontsToLoad=new Set,xs(()=>{for(const s of n)this.ensureFontIsLoaded(s)})});for(const n of e)this.fontsToLoad.add(n)}findOrCreateFontFace(e){for(const r of document.fonts)if(r.family===e.family&&zs(Aw).every(([i,o])=>r[i]===(e[i]??o)))return r;const n=this.assetUrls?.[e.src.url]??e.src.url,s=new FontFace(e.family,`url(${JSON.stringify(n)})`,{...Oi(Aw,r=>e[r]),display:"swap"});return document.fonts.add(s),s}async toEmbeddedCssDeclaration(e){const n=this.assetUrls?.[e.src.url]??e.src.url,s=await vn.urlToDataUrl(n),r=ve([`url("${s}")`,e.src.format?`format(${e.src.format})`:null,e.src.tech?`tech(${e.src.tech})`:null]).join(" ");return ve(["@font-face {",`  font-family: "${e.family}";`,e.ascentOverride?`  ascent-override: ${e.ascentOverride};`:null,e.descentOverride?`  descent-override: ${e.descentOverride};`:null,e.stretch?`  font-stretch: ${e.stretch};`:null,e.style?`  font-style: ${e.style};`:null,e.weight?`  font-weight: ${e.weight};`:null,e.featureSettings?`  font-feature-settings: ${e.featureSettings};`:null,e.lineGapOverride?`  line-gap-override: ${e.lineGapOverride};`:null,e.unicodeRange?`  unicode-range: ${e.unicodeRange};`:null,`  src: ${r};`,"}"]).join(`
`)}}const Aw={style:"normal",weight:"normal",stretch:"normal",unicodeRange:"U+0-10FFFF",featureSettings:"normal",ascentOverride:"normal",descentOverride:"normal",lineGapOverride:"normal"};class VR{store;dispose;state="recording";pendingDiff=new ZR;stacks=je("HistoryManager.stacks",{undos:Ra(),redos:Ra()},{isEqual:(e,n)=>e.undos===n.undos&&e.redos===n.redos});annotateError;constructor(e){this.store=e.store,this.annotateError=e.annotateError??yc,this.dispose=this.store.addHistoryInterceptor((n,s)=>{if(s==="user")switch(this.state){case"recording":this.pendingDiff.apply(n.changes),this.stacks.update(({undos:r})=>({undos:r,redos:Ra()}));break;case"recordingPreserveRedoStack":this.pendingDiff.apply(n.changes);break;case"paused":break;default:Ke(this.state)}})}flushPendingDiff(){if(this.pendingDiff.isEmpty())return;const e=this.pendingDiff.clear();this.stacks.update(({undos:n,redos:s})=>({undos:n.push({type:"diff",diff:e}),redos:s}))}getNumUndos(){return this.stacks.get().undos.length+(this.pendingDiff.isEmpty()?0:1)}getNumRedos(){return this.stacks.get().redos.length}_isInBatch=!1;batch(e,n){const s=this.state;s!=="paused"&&n?.history&&(this.state=XR[n.history]);try{if(this._isInBatch)return xs(e),this;this._isInBatch=!0;try{xs(e)}catch(r){throw this.annotateError(r),r}finally{this._isInBatch=!1}return this}finally{this.state=s}}_undo({pushToRedoStack:e,toMark:n=void 0}){const s=this.state;this.state="paused";try{let{undos:r,redos:i}=this.stacks.get();const o=this.pendingDiff.clear(),a=A1(o),c=yg(o);e&&!a&&(i=i.push({type:"diff",diff:o}));let l=!1;if(a)for(;r.head?.type==="stop";){const u=r.head;if(r=r.tail,e&&(i=i.push(u)),u.id===n){l=!0;break}}if(!l)e:for(;r.head;){const u=r.head;switch(r=r.tail,e&&(i=i.push(u)),u.type){case"diff":lc(c,[yg(u.diff)]);break;case"stop":if(!n)break e;if(u.id===n){l=!0;break e}break;default:Ke(u)}}if(!l&&n)return this;this.store.applyDiff(c,{ignoreEphemeralKeys:!0}),this.store.ensureStoreIsUsable(),this.stacks.set({undos:r,redos:i})}finally{this.state=s}return this}undo(){return this._undo({pushToRedoStack:!0}),this}redo(){const e=this.state;this.state="paused";try{this.flushPendingDiff();let{undos:n,redos:s}=this.stacks.get();if(s.length===0)return this;for(;s.head?.type==="stop";)n=n.push(s.head),s=s.tail;const r=xd();for(;s.head;){const i=s.head;if(n=n.push(i),s=s.tail,i.type==="diff")lc(r,[i.diff]);else break}this.store.applyDiff(r,{ignoreEphemeralKeys:!0}),this.store.ensureStoreIsUsable(),this.stacks.set({undos:n,redos:s})}finally{this.state=e}return this}bail(){return this._undo({pushToRedoStack:!1}),this}bailToMark(e){return e&&this._undo({pushToRedoStack:!1,toMark:e}),this}squashToMark(e){let n=this.stacks.get().undos;const s=[];for(;n.head&&!(n.head.type==="stop"&&n.head.id===e);)n.head.type==="diff"&&s.push(n.head.diff),n=n.tail;if(!n.head||n.head?.id!==e)return console.error("Could not find mark to squash to: ",e),this;if(s.length===0)return this;const r=xd();return lc(r,s.reverse()),this.stacks.update(({redos:i})=>({undos:n.push({type:"diff",diff:r}),redos:i})),this}_mark(e){xs(()=>{this.flushPendingDiff(),this.stacks.update(({undos:n,redos:s})=>({undos:n.push({type:"stop",id:e}),redos:s}))})}clear(){this.stacks.set({undos:Ra(),redos:Ra()}),this.pendingDiff.clear()}getMarkIdMatching(e){let n=this.stacks.get().undos;for(;n.head;){if(n.head.type==="stop"&&n.head.id.includes(e))return n.head.id;n=n.tail}return null}debug(){const{undos:e,redos:n}=this.stacks.get();return{undos:Mw(e),redos:Mw(n),pendingDiff:this.pendingDiff.debug(),state:this.state}}}const XR={record:"recording","record-preserveRedoStack":"recordingPreserveRedoStack",ignore:"paused"};class ZR{diff=xd();isEmptyAtom=je("PendingDiff.isEmpty",!0);clear(){const e=this.diff;return this.diff=xd(),this.isEmptyAtom.set(!0),e}isEmpty(){return this.isEmptyAtom.get()}apply(e){lc(this.diff,[e]),this.isEmptyAtom.set(A1(this.diff))}debug(){return{diff:this.diff,isEmpty:this.isEmpty()}}}function Ra(){return QR}class JR{length=0;head=null;tail=this;push(e){return new gy(e,this)}}const QR=new JR;class gy{constructor(e,n){this.head=e,this.tail=n,this.length=n.length+1}length;push(e){return new gy(e,this)}}function Mw(t){if(!t.length)return Ct;const e=[];for(;t.length;)e.push(t.head),t=t.tail;return e}var e3=Object.create,jI=Object.defineProperty,t3=Object.getOwnPropertyDescriptor,n3=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),DI=t=>{throw TypeError(t)},OI=(t,e,n)=>e in t?jI(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,s3=t=>[,,,e3(null)],LI=["class","method","getter","setter","accessor","field","value","get","set"],RI=t=>t!==void 0&&typeof t!="function"?DI("Function expected"):t,r3=(t,e,n,s,r)=>({kind:LI[t],name:e,metadata:s,addInitializer:i=>n._?DI("Already initialized"):r.push(RI(i||null))}),i3=(t,e)=>OI(e,n3("metadata"),t[3]),o3=(t,e,n,s)=>{for(var r=0,i=t[e>>1],o=i&&i.length;r<o;r++)i[r].call(n);return s},a3=(t,e,n,s,r,i)=>{for(var o,a,c,l,u=e&7,d=!1,p=!1,f=2,g=LI[u+5],x=t[f]||(t[f]=[]),y=(r=r.prototype,t3(r,n)),m=s.length-1;m>=0;m--)c=r3(u,n,a={},t[3],x),c.static=d,c.private=p,l=c.access={has:S=>n in S},l.get=S=>S[n],o=(0,s[m])(y[g],c),a._=1,RI(o)&&(y[g]=o);return y&&jI(r,n,y),r},Et=(t,e,n)=>OI(t,typeof e!="symbol"?e+"":e,n),FI,yu;FI=[K];class my{constructor(e){this.editor=e,o3(yu,5,this),Et(this,"_originPagePoint",je("originPagePoint",new b)),Et(this,"_originScreenPoint",je("originScreenPoint",new b)),Et(this,"_previousPagePoint",je("previousPagePoint",new b)),Et(this,"_previousScreenPoint",je("previousScreenPoint",new b)),Et(this,"_currentPagePoint",je("currentPagePoint",new b)),Et(this,"_currentScreenPoint",je("currentScreenPoint",new b)),Et(this,"_pointerVelocity",je("pointerVelocity",new b)),Et(this,"keys",new Yb("keys")),Et(this,"buttons",new Yb("buttons")),Et(this,"_isPen",je("isPen",!1)),Et(this,"_shiftKey",je("shiftKey",!1)),Et(this,"_metaKey",je("metaKey",!1)),Et(this,"_ctrlKey",je("ctrlKey",!1)),Et(this,"_altKey",je("altKey",!1)),Et(this,"_isDragging",je("isDragging",!1)),Et(this,"_isPointing",je("isPointing",!1)),Et(this,"_isPinching",je("isPinching",!1)),Et(this,"_isEditing",je("isEditing",!1)),Et(this,"_isPanning",je("isPanning",!1)),Et(this,"_isSpacebarPanning",je("isSpacebarPanning",!1)),Et(this,"_velocityPrevPoint",new b)}getOriginPagePoint(){return this._originPagePoint.get()}get originPagePoint(){return this.getOriginPagePoint()}getOriginScreenPoint(){return this._originScreenPoint.get()}get originScreenPoint(){return this.getOriginScreenPoint()}getPreviousPagePoint(){return this._previousPagePoint.get()}get previousPagePoint(){return this.getPreviousPagePoint()}getPreviousScreenPoint(){return this._previousScreenPoint.get()}get previousScreenPoint(){return this.getPreviousScreenPoint()}getCurrentPagePoint(){return this._currentPagePoint.get()}get currentPagePoint(){return this.getCurrentPagePoint()}getCurrentScreenPoint(){return this._currentScreenPoint.get()}get currentScreenPoint(){return this.getCurrentScreenPoint()}getPointerVelocity(){return this._pointerVelocity.get()}get pointerVelocity(){return this.getPointerVelocity()}setPointerVelocity(e){this._pointerVelocity.set(e)}getIsPen(){return this._isPen.get()}get isPen(){return this.getIsPen()}set isPen(e){this.setIsPen(e)}setIsPen(e){this._isPen.set(e)}getShiftKey(){return this._shiftKey.get()}get shiftKey(){return this.getShiftKey()}set shiftKey(e){this.setShiftKey(e)}setShiftKey(e){this._shiftKey.set(e)}getMetaKey(){return this._metaKey.get()}get metaKey(){return this.getMetaKey()}set metaKey(e){this.setMetaKey(e)}setMetaKey(e){this._metaKey.set(e)}getCtrlKey(){return this._ctrlKey.get()}get ctrlKey(){return this.getCtrlKey()}set ctrlKey(e){this.setCtrlKey(e)}setCtrlKey(e){this._ctrlKey.set(e)}getAltKey(){return this._altKey.get()}get altKey(){return this.getAltKey()}set altKey(e){this.setAltKey(e)}setAltKey(e){this._altKey.set(e)}getAccelKey(){return At({metaKey:this.getMetaKey(),ctrlKey:this.getCtrlKey()})}get accelKey(){return this.getAccelKey()}getIsDragging(){return this._isDragging.get()}get isDragging(){return this.getIsDragging()}set isDragging(e){this.setIsDragging(e)}setIsDragging(e){this._isDragging.set(e)}getIsPointing(){return this._isPointing.get()}get isPointing(){return this.getIsPointing()}set isPointing(e){this.setIsPointing(e)}setIsPointing(e){this._isPointing.set(e)}getIsPinching(){return this._isPinching.get()}get isPinching(){return this.getIsPinching()}set isPinching(e){this.setIsPinching(e)}setIsPinching(e){this._isPinching.set(e)}getIsEditing(){return this._isEditing.get()}get isEditing(){return this.getIsEditing()}set isEditing(e){this.setIsEditing(e)}setIsEditing(e){this._isEditing.set(e)}getIsPanning(){return this._isPanning.get()}get isPanning(){return this.getIsPanning()}set isPanning(e){this.setIsPanning(e)}setIsPanning(e){this._isPanning.set(e)}getIsSpacebarPanning(){return this._isSpacebarPanning.get()}get isSpacebarPanning(){return this.getIsSpacebarPanning()}set isSpacebarPanning(e){this.setIsSpacebarPanning(e)}setIsSpacebarPanning(e){this._isSpacebarPanning.set(e)}_getHasCollaborators(){return this.editor.getCollaborators().length>0}updatePointerVelocity(e){const n=this.getCurrentScreenPoint(),s=this.getPointerVelocity();if(e===0)return;const r=b.Sub(n,this._velocityPrevPoint);this._velocityPrevPoint=n.clone();const i=r.len(),o=i?r.div(i):new b(0,0),a=s.clone().lrp(o.mul(i/e),.5);Math.abs(a.x)<.01&&(a.x=0),Math.abs(a.y)<.01&&(a.y=0),s.equals(a)||this._pointerVelocity.set(a)}updateFromEvent(e){const n=this._currentScreenPoint.__unsafe__getWithoutCapture(),s=this._currentPagePoint.__unsafe__getWithoutCapture(),r=this._isPinching.__unsafe__getWithoutCapture(),{screenBounds:i}=this.editor.store.unsafeGetWithoutCapture(Fn),{x:o,y:a,z:c}=Yi(()=>this.editor.getCamera()),l=e.point.x-i.x,u=e.point.y-i.y,d=e.point.z??.5;this._previousScreenPoint.set(n),this._previousPagePoint.set(s),this._currentScreenPoint.set(new b(l,u));const p=l/c-o,f=u/c-a;isFinite(p)&&isFinite(f)&&this._currentPagePoint.set(new b(p,f,d)),this._isPen.set(e.type==="pointer"&&e.isPen),(e.name==="pointer_down"||r)&&(this._pointerVelocity.set(new b),this._originScreenPoint.set(this._currentScreenPoint.__unsafe__getWithoutCapture()),this._originPagePoint.set(this._currentPagePoint.__unsafe__getWithoutCapture())),this._getHasCollaborators()&&this.editor.run(()=>{const g=this._currentPagePoint.__unsafe__getWithoutCapture();this.editor.store.put([{id:Cd,typeName:"pointer",x:g.x,y:g.y,lastActivityTimestamp:e.type==="pointer"&&e.pointerId===PP.CAMERA_MOVE?this.editor.store.unsafeGetWithoutCapture(Cd)?.lastActivityTimestamp??Date.now():Date.now(),meta:{}}])},{history:"ignore"})}toJson(){return{originPagePoint:this._originPagePoint.get().toJson(),originScreenPoint:this._originScreenPoint.get().toJson(),previousPagePoint:this._previousPagePoint.get().toJson(),previousScreenPoint:this._previousScreenPoint.get().toJson(),currentPagePoint:this._currentPagePoint.get().toJson(),currentScreenPoint:this._currentScreenPoint.get().toJson(),pointerVelocity:this._pointerVelocity.get().toJson(),shiftKey:this._shiftKey.get(),metaKey:this._metaKey.get(),ctrlKey:this._ctrlKey.get(),altKey:this._altKey.get(),isPen:this._isPen.get(),isDragging:this._isDragging.get(),isPointing:this._isPointing.get(),isPinching:this._isPinching.get(),isEditing:this._isEditing.get(),isPanning:this._isPanning.get(),isSpacebarPanning:this._isSpacebarPanning.get(),keys:Array.from(this.keys.keys()),buttons:Array.from(this.buttons.keys())}}}yu=s3();a3(yu,1,"_getHasCollaborators",FI,my);i3(yu,my);class c3{constructor(e){this.editor=e}scribbleItems=new Map;state="paused";addScribble(e,n=Ge()){const s={id:n,scribble:{id:n,size:20,color:"accent",opacity:.8,delay:0,points:[],shrink:.1,taper:!0,...e,state:"starting"},timeoutMs:0,delayRemaining:e.delay??0,prev:null,next:null};return this.scribbleItems.set(n,s),s}reset(){this.editor.updateInstanceState({scribbles:[]}),this.scribbleItems.clear()}stop(e){const n=this.scribbleItems.get(e);if(!n)throw Error(`Scribble with id ${e} not found`);return n.delayRemaining=Math.min(n.delayRemaining,200),n.scribble.state="stopping",n}addPoint(e,n,s,r=.5){const i=this.scribbleItems.get(e);if(!i)throw Error(`Scribble with id ${e} not found`);const{prev:o}=i,a={x:n,y:s,z:r};return(!o||b.Dist(o,a)>=1)&&(i.next=a),i}tick(e){this.scribbleItems.size!==0&&this.editor.run(()=>{this.scribbleItems.forEach(n=>{if(n.scribble.state==="starting"){const{next:c,prev:l}=n;c&&c!==l&&(n.prev=c,n.scribble.points.push(c)),n.scribble.points.length>8&&(n.scribble.state="active");return}n.delayRemaining>0&&(n.delayRemaining=Math.max(0,n.delayRemaining-e)),n.timeoutMs+=e,n.timeoutMs>=16&&(n.timeoutMs=0);const{delayRemaining:s,timeoutMs:r,prev:i,next:o,scribble:a}=n;switch(a.state){case"active":{o&&o!==i?(n.prev=o,a.points.push(o),s===0&&a.points.length>8&&a.points.shift()):r===0&&(a.points.length>1?a.points.shift():n.delayRemaining=a.delay);break}case"stopping":{if(n.delayRemaining===0&&r===0){if(a.points.length===1){this.scribbleItems.delete(n.id);return}a.shrink&&(a.size=Math.max(1,a.size*(1-a.shrink))),a.points.shift()}break}}}),this.editor.updateInstanceState({scribbles:Array.from(this.scribbleItems.values()).map(({scribble:n})=>({...n,points:[...n.points]})).slice(-5)})})}}var l3=Object.create,BI=Object.defineProperty,d3=Object.getOwnPropertyDescriptor,u3=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),zI=t=>{throw TypeError(t)},$I=(t,e,n)=>e in t?BI(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,h3=t=>[,,,l3(null)],NI=["class","method","getter","setter","accessor","field","value","get","set"],UI=t=>t!==void 0&&typeof t!="function"?zI("Function expected"):t,p3=(t,e,n,s,r)=>({kind:NI[t],name:e,metadata:s,addInitializer:i=>n._?zI("Already initialized"):r.push(UI(i||null))}),f3=(t,e)=>$I(e,u3("metadata"),t[3]),g3=(t,e,n,s)=>{for(var r=0,i=t[e>>1],o=i&&i.length;r<o;r++)i[r].call(n);return s},Su=(t,e,n,s,r,i)=>{for(var o,a,c,l,u=e&7,d=!1,p=!1,f=2,g=NI[u+5],x=t[f]||(t[f]=[]),y=(r=r.prototype,d3(r,n)),m=s.length-1;m>=0;m--)c=p3(u,n,a={},t[3],x),c.static=d,c.private=p,l=c.access={has:S=>n in S},l.get=S=>S[n],o=(0,s[m])(y[g],c),a._=1,UI(o)&&(y[g]=o);return y&&BI(r,n,y),r},m3=(t,e,n)=>$I(t,e+"",n),HI,KI,WI,qI,So;const xe=t=>Math.round(t*10**8)/10**8;function Yr(t,e,n,s,r){const i=t.filter(a=>(s==="forward"?a.startNode.id===e:a.endNode.id===e)&&xe(a.length)===xe(n)&&Xs(a.breadthIntersection[0],a.breadthIntersection[1],r[0],r[1]));if(i.length===0)return[];const o=new Set;return i.forEach(a=>{const c=s==="forward"?a.endNode.id:a.startNode.id;if(!o.has(c)){o.add(c);const l=Yr(t,c,n,s,Xs(a.breadthIntersection[0],a.breadthIntersection[1],r[0],r[1]));i.push(...l)}}),i}function y3(t){t.sort((e,n)=>n.gaps.length-e.gaps.length);for(let e=t.length-1;e>0;e--){const n=t[e];for(let s=e-1;s>=0;s--){const r=t[s];if(r.direction===n.direction&&n.gaps.every(i=>r.gaps.some(o=>xe(i.startEdge[0].x)===xe(o.startEdge[0].x)&&xe(i.startEdge[0].y)===xe(o.startEdge[0].y)&&xe(i.startEdge[1].x)===xe(o.startEdge[1].x)&&xe(i.startEdge[1].y)===xe(o.startEdge[1].y))&&r.gaps.some(o=>xe(i.endEdge[0].x)===xe(o.endEdge[0].x)&&xe(i.endEdge[0].y)===xe(o.endEdge[0].y)&&xe(i.endEdge[1].x)===xe(o.endEdge[1].x)&&xe(i.endEdge[1].y)===xe(o.endEdge[1].y)))){t.splice(e,1);break}}}}qI=[K],WI=[K],KI=[K],HI=[K];class ya{constructor(e){this.manager=e,g3(So,5,this),m3(this,"editor"),this.editor=e.editor}getSnapPointsCache(){const{editor:e}=this;return e.store.createComputedCache("snapPoints",n=>{const s=e.getShapePageTransform(n.id);if(!s)return;const i=e.getShapeUtil(n).getBoundsSnapGeometry(n).points??e.getShapeGeometry(n).bounds.cornersAndCenter;if(!(!s||!i))return i.map((o,a)=>{const{x:c,y:l}=q.applyToPoint(s,o);return{x:c,y:l,id:`${n.id}:${a}`}})})}getSnapPoints(e){return this.getSnapPointsCache().get(e)??[]}getSnappablePoints(){const e=this.getSnapPointsCache(),n=this.manager.getSnappableShapes(),s=[];for(const r of n){const i=e.get(r);i&&s.push(...i)}return s}getSnappableGapNodes(){return Array.from(this.manager.getSnappableShapes(),e=>({id:e,pageBounds:Gt(this.editor.getShapePageBounds(e))}))}getVisibleGaps(){const e=[],n=[];let s,r;const i=this.getSnappableGapNodes().sort((a,c)=>a.pageBounds.minX-c.pageBounds.minX);for(let a=0;a<i.length;a++){s=i[a];for(let c=a+1;c<i.length;c++)r=i[c],s.pageBounds.maxX<r.pageBounds.minX&&Oa(s.pageBounds.minY,s.pageBounds.maxY,r.pageBounds.minY,r.pageBounds.maxY)&&e.push({startNode:s,endNode:r,startEdge:[new b(s.pageBounds.maxX,s.pageBounds.minY),new b(s.pageBounds.maxX,s.pageBounds.maxY)],endEdge:[new b(r.pageBounds.minX,r.pageBounds.minY),new b(r.pageBounds.minX,r.pageBounds.maxY)],length:r.pageBounds.minX-s.pageBounds.maxX,breadthIntersection:Xs(s.pageBounds.minY,s.pageBounds.maxY,r.pageBounds.minY,r.pageBounds.maxY)})}const o=i.sort((a,c)=>a.pageBounds.minY-c.pageBounds.minY);for(let a=0;a<o.length;a++){s=o[a];for(let c=a+1;c<o.length;c++)r=o[c],s.pageBounds.maxY<r.pageBounds.minY&&Oa(s.pageBounds.minX,s.pageBounds.maxX,r.pageBounds.minX,r.pageBounds.maxX)&&n.push({startNode:s,endNode:r,startEdge:[new b(s.pageBounds.minX,s.pageBounds.maxY),new b(s.pageBounds.maxX,s.pageBounds.maxY)],endEdge:[new b(r.pageBounds.minX,r.pageBounds.minY),new b(r.pageBounds.maxX,r.pageBounds.minY)],length:r.pageBounds.minY-s.pageBounds.maxY,breadthIntersection:Xs(s.pageBounds.minX,s.pageBounds.maxX,r.pageBounds.minX,r.pageBounds.maxX)})}return{horizontal:e,vertical:n}}snapTranslateShapes({lockedAxis:e,initialSelectionPageBounds:n,initialSelectionSnapPoints:s,dragDelta:r}){const i=this.manager.getSnapThreshold(),o=this.getSnappablePoints(),a=n.clone().translate(r),c=s.map(({x:y,y:m},S)=>({id:"selection:"+S,x:y+r.x,y:m+r.y})),l=o,u=[],d=[],p=new b(i,i);this.collectPointSnaps({minOffset:p,nearestSnapsX:u,nearestSnapsY:d,otherNodeSnapPoints:l,selectionSnapPoints:c}),this.collectGapSnaps({selectionPageBounds:a,nearestSnapsX:u,nearestSnapsY:d,minOffset:p});const f=new b(e==="x"?0:u[0]?.nudge??0,e==="y"?0:d[0]?.nudge??0);p.x=0,p.y=0,u.length=0,d.length=0,c.forEach(y=>{y.x+=f.x,y.y+=f.y}),a.translate(f),this.collectPointSnaps({minOffset:p,nearestSnapsX:u,nearestSnapsY:d,otherNodeSnapPoints:l,selectionSnapPoints:c}),this.collectGapSnaps({selectionPageBounds:a,nearestSnapsX:u,nearestSnapsY:d,minOffset:p});const g=this.getPointSnapLines({nearestSnapsX:u,nearestSnapsY:d}),x=this.getGapSnapLines({selectionPageBounds:a,nearestSnapsX:u,nearestSnapsY:d});return this.manager.setIndicators([...x,...g]),{nudge:f}}snapResizeShapes({initialSelectionPageBounds:e,dragDelta:n,handle:s,isAspectRatioLocked:r,isResizingFromCenter:i}){const o=this.manager.getSnapThreshold(),{box:a,scaleX:c,scaleY:l}=X.Resize(e,s,i?n.x*2:n.x,i?n.y*2:n.y,r);let u=s;c<0&&(u=yL(u)),l<0&&(u=mL(u)),i&&(a.center=e.center);const d=u==="top"||u==="bottom",p=u==="left"||u==="right",f=jw(u,a),g=this.getSnappablePoints(),x=[],y=[],m=new b(o,o);this.collectPointSnaps({minOffset:m,nearestSnapsX:x,nearestSnapsY:y,otherNodeSnapPoints:g,selectionSnapPoints:f});const S=new b(d?0:x[0]?.nudge??0,p?0:y[0]?.nudge??0);if(r&&SL(u)&&S.len()!==0){const C=x.length&&y.length?Math.abs(S.x)<Math.abs(S.y)?"x":"y":x.length?"x":"y",E=e.aspectRatio;C==="x"?(y.length=0,S.y=S.x/E,(u==="bottom_left"||u==="top_right")&&(S.y=-S.y)):(x.length=0,S.x=S.y*E,(u==="bottom_left"||u==="top_right")&&(S.x=-S.x))}const w=b.Add(n,S),{box:P}=X.Resize(e,s,i?w.x*2:w.x,i?w.y*2:w.y,r);i&&(P.center=e.center);const _=jw("any",P);x.length=0,y.length=0,m.x=0,m.y=0,this.collectPointSnaps({minOffset:m,nearestSnapsX:x,nearestSnapsY:y,otherNodeSnapPoints:g,selectionSnapPoints:_});const I=this.getPointSnapLines({nearestSnapsX:x,nearestSnapsY:y});return this.manager.setIndicators([...I]),{nudge:S}}collectPointSnaps({selectionSnapPoints:e,otherNodeSnapPoints:n,minOffset:s,nearestSnapsX:r,nearestSnapsY:i}){for(const o of e)for(const a of n){const c=b.Sub(o,a),l=Math.abs(c.x),u=Math.abs(c.y);xe(l)<=xe(s.x)&&(xe(l)<xe(s.x)&&(r.length=0),r.push({type:"points",points:{thisPoint:o,otherPoint:a},nudge:a.x-o.x}),s.x=l),xe(u)<=xe(s.y)&&(xe(u)<xe(s.y)&&(i.length=0),i.push({type:"points",points:{thisPoint:o,otherPoint:a},nudge:a.y-o.y}),s.y=u)}}collectGapSnaps({selectionPageBounds:e,minOffset:n,nearestSnapsX:s,nearestSnapsY:r}){const{horizontal:i,vertical:o}=this.getVisibleGaps();for(const a of i){if(!Oa(a.breadthIntersection[0],a.breadthIntersection[1],e.minY,e.maxY))continue;const l=a.startEdge[0].x+a.length/2-e.center.x;if(a.length>e.width&&xe(Math.abs(l))<=xe(n.x)){xe(Math.abs(l))<xe(n.x)&&(s.length=0),n.x=Math.abs(l);const m={type:"gap_center",gap:a,nudge:l},S=s.find(({type:P})=>P==="gap_center"),w=S&&Xs(a.breadthIntersection[0],a.breadthIntersection[1],S.gap.breadthIntersection[0],S.gap.breadthIntersection[1]);S&&S.gap.length>a.length&&w?s[s.indexOf(S)]=m:(!S||!w)&&s.push(m)}const d=a.startNode.pageBounds.minX-a.length,p=e.maxX,f=d-p;xe(Math.abs(f))<=xe(n.x)&&(xe(Math.abs(f))<xe(n.x)&&(s.length=0),n.x=Math.abs(f),s.push({type:"gap_duplicate",gap:a,protrusionDirection:"left",nudge:f}));const g=a.endNode.pageBounds.maxX+a.length,x=e.minX,y=g-x;xe(Math.abs(y))<=xe(n.x)&&(xe(Math.abs(y))<xe(n.x)&&(s.length=0),n.x=Math.abs(y),s.push({type:"gap_duplicate",gap:a,protrusionDirection:"right",nudge:y}))}for(const a of o){if(!Oa(a.breadthIntersection[0],a.breadthIntersection[1],e.minX,e.maxX))continue;const l=a.startEdge[0].y+a.length/2-e.center.y;if(a.length>e.height&&xe(Math.abs(l))<=xe(n.y)){xe(Math.abs(l))<xe(n.y)&&(r.length=0),n.y=Math.abs(l);const m={type:"gap_center",gap:a,nudge:l},S=r.find(({type:P})=>P==="gap_center"),w=S&&Oa(S.gap.breadthIntersection[0],S.gap.breadthIntersection[1],a.breadthIntersection[0],a.breadthIntersection[1]);S&&S.gap.length>a.length&&w?r[r.indexOf(S)]=m:(!S||!w)&&r.push(m);continue}const d=a.startNode.pageBounds.minY-a.length,p=e.maxY,f=d-p;xe(Math.abs(f))<=xe(n.y)&&(xe(Math.abs(f))<xe(n.y)&&(r.length=0),n.y=Math.abs(f),r.push({type:"gap_duplicate",gap:a,protrusionDirection:"top",nudge:f}));const g=a.endNode.pageBounds.maxY+a.length,x=e.minY,y=g-x;xe(Math.abs(y))<=xe(n.y)&&(xe(Math.abs(y))<xe(n.y)&&(r.length=0),n.y=Math.abs(y),r.push({type:"gap_duplicate",gap:a,protrusionDirection:"bottom",nudge:y}))}}getPointSnapLines({nearestSnapsX:e,nearestSnapsY:n}){const s={},r={};if(e.length>0){for(const i of e)if(i.type==="points"){const o=xe(i.points.otherPoint.x);s[o]||(s[o]=[]),s[o].push(i.points)}}if(n.length>0){for(const i of n)if(i.type==="points"){const o=xe(i.points.otherPoint.y);r[o]||(r[o]=[]),r[o].push(i.points)}}return Object.values(s).concat(Object.values(r)).map(i=>({id:Ge(),type:"points",points:um(i.map(o=>b.From(o.otherPoint)).concat(i.map(o=>b.From(o.thisPoint))),(o,a)=>o.equals(a))}))}getGapSnapLines({selectionPageBounds:e,nearestSnapsX:n,nearestSnapsY:s}){const{vertical:r,horizontal:i}=this.getVisibleGaps(),o={top:e.sides[0],right:e.sides[1],bottom:[e.corners[3],e.corners[2]],left:[e.corners[0],e.corners[3]]},a=[];if(n.length>0)for(const c of n){if(c.type==="points")continue;const{gap:{breadthIntersection:l,startEdge:u,startNode:d,endNode:p,length:f,endEdge:g}}=c;switch(c.type){case"gap_center":{const x=(f-e.width)/2,y=Xs(l[0],l[1],e.minY,e.maxY);a.push({type:"gaps",direction:"horizontal",id:Ge(),gaps:[...Yr(i,d.id,x,"backward",y),{startEdge:u,endEdge:o.left},{startEdge:o.right,endEdge:g},...Yr(i,p.id,x,"forward",y)]});break}case"gap_duplicate":{const x=Xs(l[0],l[1],e.minY,e.maxY);a.push({type:"gaps",direction:"horizontal",id:Ge(),gaps:c.protrusionDirection==="left"?[{startEdge:o.right,endEdge:u.map(y=>y.clone().addXY(-d.pageBounds.width,0))},{startEdge:u,endEdge:g},...Yr(i,p.id,f,"forward",x)]:[...Yr(i,d.id,f,"backward",x),{startEdge:u,endEdge:g},{startEdge:g.map(y=>y.clone().addXY(c.gap.endNode.pageBounds.width,0)),endEdge:o.left}]});break}}}if(s.length>0)for(const c of s){if(c.type==="points")continue;const{gap:{breadthIntersection:l,startEdge:u,startNode:d,endNode:p,length:f,endEdge:g}}=c;switch(c.type){case"gap_center":{const x=(f-e.height)/2,y=Xs(l[0],l[1],e.minX,e.maxX);a.push({type:"gaps",direction:"vertical",id:Ge(),gaps:[...Yr(r,d.id,x,"backward",y),{startEdge:u,endEdge:o.top},{startEdge:o.bottom,endEdge:g},...Yr(r,c.gap.endNode.id,x,"forward",y)]});break}case"gap_duplicate":{const x=Xs(l[0],l[1],e.minX,e.maxX);a.push({type:"gaps",direction:"vertical",id:Ge(),gaps:c.protrusionDirection==="top"?[{startEdge:o.bottom,endEdge:u.map(y=>y.clone().addXY(0,-d.pageBounds.height))},{startEdge:u,endEdge:g},...Yr(r,p.id,f,"forward",x)]:[...Yr(r,d.id,f,"backward",x),{startEdge:u,endEdge:g},{startEdge:g.map(y=>y.clone().addXY(0,p.pageBounds.height)),endEdge:o.top}]})}break}}return y3(a),a}}So=h3();Su(So,1,"getSnapPointsCache",qI,ya);Su(So,1,"getSnappablePoints",WI,ya);Su(So,1,"getSnappableGapNodes",KI,ya);Su(So,1,"getVisibleGaps",HI,ya);f3(So,ya);function jw(t,e){const{minX:n,maxX:s,minY:r,maxY:i}=e,o=[];switch(t){case"top":case"left":case"top_left":case"any":o.push({id:"top_left",handle:"top_left",x:n,y:r})}switch(t){case"top":case"right":case"top_right":case"any":o.push({id:"top_right",handle:"top_right",x:s,y:r})}switch(t){case"bottom":case"right":case"bottom_right":case"any":o.push({id:"bottom_right",handle:"bottom_right",x:s,y:i})}switch(t){case"bottom":case"left":case"bottom_left":case"any":o.push({id:"bottom_left",handle:"bottom_left",x:n,y:i})}return o}var S3=Object.create,GI=Object.defineProperty,x3=Object.getOwnPropertyDescriptor,b3=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),YI=t=>{throw TypeError(t)},VI=(t,e,n)=>e in t?GI(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,w3=t=>[,,,S3(null)],XI=["class","method","getter","setter","accessor","field","value","get","set"],ZI=t=>t!==void 0&&typeof t!="function"?YI("Function expected"):t,v3=(t,e,n,s,r)=>({kind:XI[t],name:e,metadata:s,addInitializer:i=>n._?YI("Already initialized"):r.push(ZI(i||null))}),P3=(t,e)=>VI(e,b3("metadata"),t[3]),I3=(t,e,n,s)=>{for(var r=0,i=t[e>>1],o=i&&i.length;r<o;r++)i[r].call(n);return s},_3=(t,e,n,s,r,i)=>{for(var o,a,c,l,u=e&7,d=!1,p=!1,f=2,g=XI[u+5],x=t[f]||(t[f]=[]),y=(r=r.prototype,x3(r,n)),m=s.length-1;m>=0;m--)c=v3(u,n,a={},t[3],x),c.static=d,c.private=p,l=c.access={has:S=>n in S},l.get=S=>S[n],o=(0,s[m])(y[g],c),a._=1,ZI(o)&&(y[g]=o);return y&&GI(r,n,y),r},C3=(t,e,n)=>VI(t,e+"",n),JI,xu;const T3=()=>null,E3=()=>[];JI=[K];class yy{constructor(e){this.manager=e,I3(xu,5,this),C3(this,"editor"),this.editor=e.editor}getSnapGeometryCache(){const{editor:e}=this;return e.store.createComputedCache("handle snap geometry",n=>{const s=e.getShapeUtil(n).getHandleSnapGeometry(n),r=s.getSelfSnapOutline?s.getSelfSnapOutline.bind(s):T3,i=s.getSelfSnapPoints?s.getSelfSnapPoints.bind(s):E3;return{outline:s.outline===void 0?e.getShapeGeometry(n):s.outline,points:s.points??[],getSelfSnapOutline:r,getSelfSnapPoints:i}})}*iterateSnapPointsInPageSpace(e,n){const s=this.getSnapGeometryCache().get(e)?.getSelfSnapPoints(n);if(s&&s.length){const r=Gt(this.editor.getShapePageTransform(e));for(const i of s)yield r.applyToPoint(i)}for(const r of this.manager.getSnappableShapes()){if(r===e)continue;const i=this.getSnapGeometryCache().get(r)?.points;if(!i||!i.length)continue;const o=Gt(this.editor.getShapePageTransform(r));for(const a of i)yield o.applyToPoint(a)}}*iterateSnapOutlines(e,n){const s=this.getSnapGeometryCache().get(e)?.getSelfSnapOutline(n);s&&(yield{shapeId:e,outline:s});for(const r of this.manager.getSnappableShapes()){if(r===e)continue;const i=this.getSnapGeometryCache().get(r)?.outline;i&&(yield{shapeId:r,outline:i})}}getHandleSnapPosition({currentShapeId:e,handle:n,handleInPageSpace:s}){const r=this.manager.getSnapThreshold();let i=r,o=null;for(const l of this.iterateSnapPointsInPageSpace(e,n))b.DistMin(s,l,i)&&(i=b.Dist(s,l),o=l);if(o)return o;let a=r,c=null;for(const{shapeId:l,outline:u}of this.iterateSnapOutlines(e,n)){const d=Gt(this.editor.getShapePageTransform(l)),p=this.editor.getPointInShapeSpace(l,s),f=u.nearestPoint(p),g=d.applyToPoint(f);b.DistMin(s,g,a)&&(a=b.Dist(s,g),c=g)}return c||null}getHandleSnapData({handle:e,currentShapeId:n}){const s=this.manager.getSnapThreshold(),i=Gt(this.editor.getShapePageTransform(n)).applyToPoint(e);let o=null,a=null,c=s,l=s;for(const f of this.iterateSnapPointsInPageSpace(n,e)){const g=Math.abs(i.x-f.x),x=Math.abs(i.y-f.y);g<c&&(c=g,o=f),x<l&&(l=x,a=f)}if(!o&&!a)return null;const u=new b(o?o.x-i.x:0,a?a.y-i.y:0),d=b.Add(i,u),p=[];if(o){const f=new b(o.x,d.y);p.push({id:Ge(),type:"points",points:[o,f]})}if(a){const f=new b(d.x,a.y);p.push({id:Ge(),type:"points",points:[a,f]})}return{snaps:p,nudge:u}}snapHandle({currentShapeId:e,handle:n}){const r=Gt(this.editor.getShapePageTransform(e)).applyToPoint(n),i=n.canSnap?"point":n.snapType;if(i==="point"){const o=this.getHandleSnapPosition({currentShapeId:e,handle:n,handleInPageSpace:r});return o?(this.manager.setIndicators([{id:Ge(),type:"points",points:[o]}]),{nudge:b.Sub(o,r)}):null}if(i==="align"){const o=this.getHandleSnapData({handle:n,currentShapeId:e});return o?(this.manager.setIndicators(o.snaps),{nudge:o.nudge}):null}return null}}xu=w3();_3(xu,1,"getSnapGeometryCache",JI,yy);P3(xu,yy);var k3=Object.create,QI=Object.defineProperty,A3=Object.getOwnPropertyDescriptor,M3=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),e_=t=>{throw TypeError(t)},t_=(t,e,n)=>e in t?QI(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,j3=t=>[,,,k3(null)],n_=["class","method","getter","setter","accessor","field","value","get","set"],s_=t=>t!==void 0&&typeof t!="function"?e_("Function expected"):t,D3=(t,e,n,s,r)=>({kind:n_[t],name:e,metadata:s,addInitializer:i=>n._?e_("Already initialized"):r.push(s_(i||null))}),O3=(t,e)=>t_(e,M3("metadata"),t[3]),L3=(t,e,n,s)=>{for(var r=0,i=t[e>>1],o=i&&i.length;r<o;r++)i[r].call(n);return s},Sy=(t,e,n,s,r,i)=>{for(var o,a,c,l,u=e&7,d=!1,p=!1,f=2,g=n_[u+5],x=t[f]||(t[f]=[]),y=(r=r.prototype,A3(r,n)),m=s.length-1;m>=0;m--)c=D3(u,n,a={},t[3],x),c.static=d,c.private=p,l=c.access={has:S=>n in S},l.get=S=>S[n],o=(0,s[m])(y[g],c),a._=1,s_(o)&&(y[g]=o);return y&&QI(r,n,y),r},Wf=(t,e,n)=>t_(t,typeof e!="symbol"?e+"":e,n),r_,i_,o_,Sa;o_=[K],i_=[K],r_=[K];class el{constructor(e){this.editor=e,L3(Sa,5,this),Wf(this,"shapeBounds"),Wf(this,"handles"),Wf(this,"_snapIndicators",je("snapLines",void 0)),this.shapeBounds=new ya(this),this.handles=new yy(this)}getIndicators(){return this._snapIndicators.get()??Ct}clearIndicators(){this.getIndicators().length&&this._snapIndicators.set(void 0)}setIndicators(e){this._snapIndicators.set(e)}getSnapThreshold(){return this.editor.options.snapThreshold/this.editor.getZoomLevel()}getSnappableShapes(){const{editor:e}=this,n=e.getViewportPageBounds(),s=e.getSelectedShapeIds(),r=new Set,i=o=>{if(On(o)){const c=e.getShape(o);c&&e.isShapeOfType(c,"frame")&&r.add(o)}const a=e.getSortedChildIdsForParent(o);for(const c of a){if(s.includes(c))continue;const l=e.getShape(c);if(!l||!e.getShapeUtil(l).canSnap(l))continue;const d=e.getShapePageBounds(c);if(d&&n.includes(d)){if(e.isShapeOfType(l,"group")){i(c);continue}r.add(c)}}};return i(this.getCurrentCommonAncestor()??e.getCurrentPageId()),r}getCurrentCommonAncestor(){return this.editor.findCommonAncestor(this.editor.getSelectedShapes())}}Sa=j3();Sy(Sa,1,"getSnapThreshold",o_,el);Sy(Sa,1,"getSnappableShapes",i_,el);Sy(Sa,1,"getCurrentCommonAncestor",r_,el);O3(Sa,el);const R3=/\r?\n|\r/g;function Dw(t){return t.replace(R3,`
`).split(`
`).map(e=>e||" ").join(`
`)}const F3={start:"left","start-legacy":"left",middle:"center","middle-legacy":"center",end:"right","end-legacy":"right"},B3=/\s/,Ow=Object.freeze({"overflow-wrap":"break-word","word-break":"auto",width:null,height:null,"max-width":null,"min-width":null});class z3{constructor(e){this.editor=e;const n=document.createElement("div");n.classList.add("tl-text"),n.classList.add("tl-text-measure"),n.setAttribute("dir","auto"),n.tabIndex=-1,this.editor.getContainer().appendChild(n),this.elm=n;for(const s of ac(Ow))n.style.setProperty(s,Ow[s])}elm;setElementStyles(e){const n={};for(const s of ac(e))if(typeof e[s]=="string"){const r=this.elm.style.getPropertyValue(s);if(r===e[s])continue;n[s]=r,this.elm.style.setProperty(s,e[s])}return()=>{for(const s of ac(n))this.elm.style.setProperty(s,n[s])}}dispose(){return this.elm.remove()}measureText(e,n){const s=document.createElement("div");return s.textContent=Dw(e),this.measureHtml(s.innerHTML,n)}measureHtml(e,n){const{elm:s}=this,r={"font-family":n.fontFamily,"font-style":n.fontStyle,"font-weight":n.fontWeight,"font-size":n.fontSize+"px","line-height":n.lineHeight.toString(),padding:n.padding,"max-width":n.maxWidth?n.maxWidth+"px":void 0,"min-width":n.minWidth?n.minWidth+"px":void 0,"overflow-wrap":n.disableOverflowWrapBreaking?"normal":void 0,...n.otherStyles},i=this.setElementStyles(r);try{s.innerHTML=e;const o=n.measureScrollWidth?s.scrollWidth:0,a=s.getBoundingClientRect();return{x:0,y:0,w:a.width,h:a.height,scrollWidth:o}}finally{i()}}measureElementTextNodeSpans(e,{shouldTruncateToFirstLine:n=!1}={}){const s=[],r=e.getBoundingClientRect(),i=-r.left,o=-r.top,a=new Range,c=e.childNodes[0];let l=0,u=null,d=null,p=0,f=0,g=!1;for(const x of e.childNodes)if(x.nodeType===Node.TEXT_NODE)for(const y of x.textContent??""){a.setStart(c,l),a.setEnd(c,l+y.length);const m=a.getClientRects(),S=m[m.length-1],w=S.top+o,P=S.left+i,_=S.right+i,I=P<f,C=B3.test(y);if(C!==d||w!==p||!u){if(u){if(n&&w!==p){g=!0;break}s.push(u)}u={box:{x:P,y:w,w:S.width,h:S.height},text:y},f=P}else I&&(u.box.x=P),u.box.w=I?u.box.w+S.width:_-u.box.x,u.text+=y;y===`
`&&(f=0),d=C,p=w,l+=y.length}return u&&s.push(u),{spans:s,didTruncate:g}}measureTextSpans(e,n){if(e==="")return[];const{elm:s}=this,r=n.overflow==="truncate-ellipsis"||n.overflow==="truncate-clip",i=Math.ceil(n.width-n.padding*2),o={"font-family":n.fontFamily,"font-style":n.fontStyle,"font-weight":n.fontWeight,"font-size":n.fontSize+"px","line-height":n.lineHeight.toString(),width:`${i}px`,height:"min-content","text-align":F3[n.textAlign],"overflow-wrap":r?"anywhere":void 0,"word-break":r?"break-all":void 0,...n.otherStyles},a=this.setElementStyles(o);try{const c=Dw(e);s.textContent=c;const{spans:l,didTruncate:u}=this.measureElementTextNodeSpans(s,{shouldTruncateToFirstLine:r});if(n.overflow==="truncate-ellipsis"&&u){s.textContent="…";const d=Math.ceil(this.measureElementTextNodeSpans(s).spans[0].box.w);s.style.setProperty("width",`${i-d}px`),s.textContent=c;const p=this.measureElementTextNodeSpans(s,{shouldTruncateToFirstLine:!0}).spans,f=p[p.length-1];return p.push({text:"…",box:{x:Math.min(f.box.x+f.box.w,n.width-n.padding-d),y:f.box.y,w:d,h:f.box.h}}),p}return l}finally{a()}}}var $3=Object.create,a_=Object.defineProperty,N3=Object.getOwnPropertyDescriptor,U3=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),c_=t=>{throw TypeError(t)},l_=(t,e,n)=>e in t?a_(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,H3=t=>[,,,$3(null)],d_=["class","method","getter","setter","accessor","field","value","get","set"],u_=t=>t!==void 0&&typeof t!="function"?c_("Function expected"):t,K3=(t,e,n,s,r)=>({kind:d_[t],name:e,metadata:s,addInitializer:i=>n._?c_("Already initialized"):r.push(u_(i||null))}),W3=(t,e)=>l_(e,U3("metadata"),t[3]),q3=(t,e,n,s)=>{for(var r=0,i=t[e>>1],o=i&&i.length;r<o;r++)i[r].call(n);return s},h_=(t,e,n,s,r,i)=>{for(var o,a,c,l,u=e&7,d=!1,p=!1,f=2,g=d_[u+5],x=t[f]||(t[f]=[]),y=(r=r.prototype,N3(r,n)),m=s.length-1;m>=0;m--)c=K3(u,n,a={},t[3],x),c.static=d,c.private=p,l=c.access={has:S=>n in S},l.get=S=>S[n],o=(0,s[m])(y[g],c),a._=1,u_(o)&&(y[g]=o);return y&&a_(r,n,y),r},qf=(t,e,n)=>l_(t,typeof e!="symbol"?e+"":e,n),p_,f_,tl;const Lw=Sm;f_=[rs],p_=[rs];class bu{constructor(e){this.editor=e,q3(tl,5,this),qf(this,"cancelRaf"),qf(this,"isPaused",!0),qf(this,"now",0),this.editor.disposables.add(this.dispose),this.start()}start(){this.isPaused=!1,this.cancelRaf?.(),this.cancelRaf=Lw(this.tick),this.now=Date.now()}tick(){if(this.isPaused)return;const e=Date.now(),n=e-this.now;this.now=e,this.editor.inputs.updatePointerVelocity(n),this.editor.emit("frame",n),this.editor.emit("tick",n),this.cancelRaf=Lw(this.tick)}dispose(){this.isPaused=!0,this.cancelRaf?.()}}tl=H3();h_(tl,1,"tick",f_,bu);h_(tl,1,"dispose",p_,bu);W3(tl,bu);var G3=Object.create,g_=Object.defineProperty,Y3=Object.getOwnPropertyDescriptor,V3=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),m_=t=>{throw TypeError(t)},y_=(t,e,n)=>e in t?g_(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,X3=t=>[,,,G3(null)],S_=["class","method","getter","setter","accessor","field","value","get","set"],x_=t=>t!==void 0&&typeof t!="function"?m_("Function expected"):t,Z3=(t,e,n,s,r)=>({kind:S_[t],name:e,metadata:s,addInitializer:i=>n._?m_("Already initialized"):r.push(x_(i||null))}),J3=(t,e)=>y_(e,V3("metadata"),t[3]),Q3=(t,e,n,s)=>{for(var r=0,i=t[e>>1],o=i&&i.length;r<o;r++)i[r].call(n);return s},Gn=(t,e,n,s,r,i)=>{for(var o,a,c,l,u=e&7,d=!1,p=!1,f=2,g=S_[u+5],x=t[f]||(t[f]=[]),y=(r=r.prototype,Y3(r,n)),m=s.length-1;m>=0;m--)c=Z3(u,n,a={},t[3],x),c.static=d,c.private=p,l=c.access={has:S=>n in S},l.get=S=>S[n],o=(0,s[m])(y[g],c),a._=1,x_(o)&&(y[g]=o);return y&&g_(r,n,y),r},Rw=(t,e,n)=>y_(t,typeof e!="symbol"?e+"":e,n),b_,w_,v_,P_,I_,__,C_,T_,E_,k_,A_,M_,j_,D_,O_,Qt;O_=[K],D_=[K],j_=[K],M_=[K],A_=[K],k_=[K],E_=[K],T_=[K],C_=[K],__=[K],I_=[K],P_=[K],v_=[K],w_=[K],b_=[K];class un{constructor(e,n){if(this.user=e,this.inferDarkMode=n,Q3(Qt,5,this),Rw(this,"systemColorScheme",je("systemColorScheme","light")),Rw(this,"disposables",new Set),typeof window>"u"||!window.matchMedia)return;const s=window.matchMedia("(prefers-color-scheme: dark)");s?.matches&&this.systemColorScheme.set("dark");const r=i=>{i.matches?this.systemColorScheme.set("dark"):this.systemColorScheme.set("light")};s?.addEventListener("change",r),this.disposables.add(()=>s?.removeEventListener("change",r))}dispose(){this.disposables.forEach(e=>e())}updateUserPreferences(e){this.user.setUserPreferences({...this.user.userPreferences.get(),...e})}getUserPreferences(){return{id:this.getId(),name:this.getName(),locale:this.getLocale(),color:this.getColor(),animationSpeed:this.getAnimationSpeed(),areKeyboardShortcutsEnabled:this.getAreKeyboardShortcutsEnabled(),isSnapMode:this.getIsSnapMode(),colorScheme:this.user.userPreferences.get().colorScheme,isDarkMode:this.getIsDarkMode(),isWrapMode:this.getIsWrapMode(),isDynamicResizeMode:this.getIsDynamicResizeMode(),enhancedA11yMode:this.getEnhancedA11yMode(),inputMode:this.getInputMode()}}getIsDarkMode(){switch(this.user.userPreferences.get().colorScheme){case"dark":return!0;case"light":return!1;case"system":return this.systemColorScheme.get()==="dark";default:return this.inferDarkMode?this.systemColorScheme.get()==="dark":!1}}getEdgeScrollSpeed(){return this.user.userPreferences.get().edgeScrollSpeed??Jn.edgeScrollSpeed}getAnimationSpeed(){return this.user.userPreferences.get().animationSpeed??Jn.animationSpeed}getAreKeyboardShortcutsEnabled(){return this.user.userPreferences.get().areKeyboardShortcutsEnabled??Jn.areKeyboardShortcutsEnabled}getId(){return this.user.userPreferences.get().id}getName(){return this.user.userPreferences.get().name?.trim()??Jn.name}getLocale(){return this.user.userPreferences.get().locale??Jn.locale}getColor(){return this.user.userPreferences.get().color??Jn.color}getIsSnapMode(){return this.user.userPreferences.get().isSnapMode??Jn.isSnapMode}getIsWrapMode(){return this.user.userPreferences.get().isWrapMode??Jn.isWrapMode}getIsDynamicResizeMode(){return this.user.userPreferences.get().isDynamicSizeMode??Jn.isDynamicSizeMode}getIsPasteAtCursorMode(){return this.user.userPreferences.get().isPasteAtCursorMode??Jn.isPasteAtCursorMode}getEnhancedA11yMode(){return this.user.userPreferences.get().enhancedA11yMode??Jn.enhancedA11yMode}getInputMode(){return this.user.userPreferences.get().inputMode??Jn.inputMode}}Qt=X3();Gn(Qt,1,"getUserPreferences",O_,un);Gn(Qt,1,"getIsDarkMode",D_,un);Gn(Qt,1,"getEdgeScrollSpeed",j_,un);Gn(Qt,1,"getAnimationSpeed",M_,un);Gn(Qt,1,"getAreKeyboardShortcutsEnabled",A_,un);Gn(Qt,1,"getId",k_,un);Gn(Qt,1,"getName",E_,un);Gn(Qt,1,"getLocale",T_,un);Gn(Qt,1,"getColor",C_,un);Gn(Qt,1,"getIsSnapMode",__,un);Gn(Qt,1,"getIsWrapMode",I_,un);Gn(Qt,1,"getIsDynamicResizeMode",P_,un);Gn(Qt,1,"getIsPasteAtCursorMode",v_,un);Gn(Qt,1,"getEnhancedA11yMode",w_,un);Gn(Qt,1,"getInputMode",b_,un);J3(Qt,un);const eF={wheel:"onWheel",pointer_down:"onPointerDown",pointer_move:"onPointerMove",long_press:"onLongPress",pointer_up:"onPointerUp",right_click:"onRightClick",middle_click:"onMiddleClick",key_down:"onKeyDown",key_up:"onKeyUp",key_repeat:"onKeyRepeat",cancel:"onCancel",complete:"onComplete",interrupt:"onInterrupt",double_click:"onDoubleClick",triple_click:"onTripleClick",quadruple_click:"onQuadrupleClick",tick:"onTick"},tF=["brushing","cropping","dragging","dragging_handle","drawing","erasing","lasering","resizing","rotating","scribble_brushing","translating"];class fe{constructor(e,n){this.editor=e;const{id:s,children:r,initial:i,isLockable:o,useCoalescedEvents:a}=this.constructor;this.id=s,this._isActive=je("toolIsActive"+this.id,!1),this._current=je("toolState"+this.id,void 0),this._path=K("toolPath"+this.id,()=>{const c=this.getCurrent();return this.id+(c?`.${c.getPath()}`:"")}),this.parent=n??{},n?r&&i?(this.type="branch",this.initial=i,this.children=Object.fromEntries(r().map(c=>[c.id,new c(this.editor,this)])),this._current.set(this.children[this.initial])):this.type="leaf":(this.type="root",r&&i&&(this.initial=i,this.children=Object.fromEntries(r().map(c=>[c.id,new c(this.editor,this)])),this._current.set(this.children[this.initial]))),this.isLockable=o,this.useCoalescedEvents=a,this.performanceTracker=new _0}performanceTracker;static id;static initial;static children;static isLockable=!0;static useCoalescedEvents=!1;id;type;shapeType;initial;children;isLockable;useCoalescedEvents;parent;getPath(){return this._path.get()}_path;getCurrent(){return this._current.get()}_current;getIsActive(){return this._isActive.get()}_isActive;transition(e,n={}){const s=e.split(".");let r=this;for(let i=0;i<s.length;i++){const o=s[i],a=r.getCurrent(),c=r.children?.[o];if(!c)throw Error(`${r.id} - no child state exists with the id ${o}.`);if(a?.id!==c.id&&(a?.exit(n,o),r._current.set(c),c.enter(n,a?.id||"initial"),!c.getIsActive()))break;r=c}return this}handleEvent(e){const n=eF[e.name],s=this._current.__unsafe__getWithoutCapture();this[n]?.(e),this._isActive.__unsafe__getWithoutCapture()&&s&&s===this._current.__unsafe__getWithoutCapture()&&s.handleEvent(e)}enter(e,n){if(mt.measurePerformance.get()&&tF.includes(this.id)&&this.performanceTracker.start(this.id),this._isActive.set(!0),this.onEnter?.(e,n),this.children&&this.initial&&this.getIsActive()){const s=this.children[this.initial];this._current.set(s),s.enter(e,n)}}exit(e,n){mt.measurePerformance.get()&&this.performanceTracker.isStarted()&&this.performanceTracker.stop(),this._isActive.set(!1),this.onExit?.(e,n),this.getIsActive()||this.getCurrent()?.exit(e,n)}_currentToolIdMask=je("curent tool id mask",void 0);getCurrentToolIdMask(){return this._currentToolIdMask.get()}setCurrentToolIdMask(e){this._currentToolIdMask.set(e)}addChild(e){if(this.type==="leaf")throw new Error("StateNode.addChild: cannot add child to a leaf node");this.children||(this.children={});const n=new e(this.editor,this);if(this.children[n.id])throw new Error(`StateNode.addChild: a child with id '${n.id}' already exists`);return this.children[n.id]=n,this}}class nF extends fe{static id="root";static initial="";static children(){return[]}onKeyDown(e){switch(e.code){case"KeyZ":{if(!(e.shiftKey||e.ctrlKey)){const n=this.getCurrent();n&&n.getCurrent()?.id==="idle"&&this.children.zoom&&this.editor.setCurrentTool("zoom",{...e,onInteractionEnd:n.id})}break}}}}var sF=Object.create,L_=Object.defineProperty,rF=Object.getOwnPropertyDescriptor,R_=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),F_=t=>{throw TypeError(t)},B_=(t,e,n)=>e in t?L_(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,iF=t=>[,,,sF(t?.[R_("metadata")]??null)],z_=["class","method","getter","setter","accessor","field","value","get","set"],$_=t=>t!==void 0&&typeof t!="function"?F_("Function expected"):t,oF=(t,e,n,s,r)=>({kind:z_[t],name:e,metadata:s,addInitializer:i=>n._?F_("Already initialized"):r.push($_(i||null))}),aF=(t,e)=>B_(e,R_("metadata"),t[3]),cF=(t,e,n,s)=>{for(var r=0,i=t[e>>1],o=i&&i.length;r<o;r++)i[r].call(n);return s},oe=(t,e,n,s,r,i)=>{for(var o,a,c,l,u=e&7,d=!1,p=!1,f=2,g=z_[u+5],x=t[f]||(t[f]=[]),y=(r=r.prototype,rF(r,n)),m=s.length-1;m>=0;m--)c=oF(u,n,a={},t[3],x),c.static=d,c.private=p,l=c.access={has:S=>n in S},l.get=S=>S[n],o=(0,s[m])(y[g],c),a._=1,$_(o)&&(y[g]=o);return y&&L_(r,n,y),r},pe=(t,e,n)=>B_(t,typeof e!="symbol"?e+"":e,n),N_,U_,H_,K_,W_,q_,G_,Y_,V_,X_,Z_,J_,Q_,eC,tC,nC,sC,rC,iC,oC,aC,cC,lC,dC,uC,hC,pC,fC,gC,mC,yC,SC,xC,bC,wC,vC,PC,IC,_C,CC,TC,EC,kC,AC,MC,jC,DC,OC,LC,RC,FC,BC,zC,$C,NC,UC,HC,KC,WC,qC,GC,YC,VC,XC,ZC,JC,QC,eT,tT,nT,sT,rT,iT,oT,Dg,ie;class re extends(Dg=dL,oT=[K],iT=[K],rT=[K],sT=[K],nT=[K],tT=[K],eT=[K],QC=[K],JC=[K],ZC=[K],XC=[K],VC=[K],YC=[K],GC=[K],qC=[K],WC=[K],KC=[K],HC=[K],UC=[K],NC=[K],$C=[K],zC=[K],BC=[K],FC=[K],RC=[K],LC=[K],OC=[K],DC=[K],jC=[K],MC=[K],AC=[K],kC=[K],EC=[K],TC=[K],CC=[K],_C=[K],IC=[K],PC=[K],vC=[K],wC=[K],bC=[K],xC=[K],SC=[K],yC=[K],mC=[K],gC=[K],fC=[K],pC=[K],hC=[K],uC=[K],dC=[K],lC=[K],cC=[K],aC=[K],oC=[K],iC=[K],rC=[K],sC=[K],nC=[K],tC=[K],eC=[K],Q_=[K],J_=[K],Z_=[K],X_=[K],V_=[K],Y_=[K({isEqual:(e,n)=>e.equals(n)})],G_=[K],q_=[K],W_=[K],K_=[rs],H_=[rs],U_=[rs],N_=[rs],Dg){constructor({store:e,user:n,shapeUtils:s,bindingUtils:r,tools:i,getContainer:o,cameraOptions:a,textOptions:c,initialState:l,autoFocus:u,inferDarkMode:d,options:p,getShapeVisibility:f,fontAssetUrls:g}){super(),cF(ie,5,this),pe(this,"id",Ge()),pe(this,"_getShapeVisibility"),pe(this,"options"),pe(this,"contextId",Ge()),pe(this,"store"),pe(this,"root"),pe(this,"disposables",new Set),pe(this,"isDisposed",!1),pe(this,"_tickManager"),pe(this,"inputs"),pe(this,"snaps"),pe(this,"timers",Od.forContext(this.contextId)),pe(this,"user"),pe(this,"textMeasure"),pe(this,"fonts"),pe(this,"scribbles"),pe(this,"sideEffects"),pe(this,"edgeScrollManager"),pe(this,"focusManager"),pe(this,"getContainer"),pe(this,"shapeUtils"),pe(this,"styleProps"),pe(this,"bindingUtils"),pe(this,"history"),pe(this,"_shouldIgnoreShapeLock",!1),pe(this,"_crashingError",null),pe(this,"_isChangingStyleTimeout",-1),pe(this,"menus",Ln.forContext(this.contextId)),pe(this,"_currentRichTextEditor",je("rich text editor",null)),pe(this,"_textOptions"),pe(this,"_debouncedZoomLevel",je("debounced zoom level",1)),pe(this,"_cameraOptions",je("camera options",uw)),pe(this,"_viewportAnimation",null),pe(this,"_willSetInitialBounds",!0),pe(this,"_isLockedOnFollowingUser",je("isLockedOnFollowingUser",!1)),pe(this,"_cameraState",je("camera state","idle")),pe(this,"_cameraStateTimeoutRemaining",0),pe(this,"_currentPageShapeIds"),pe(this,"_shapeGeometryCaches",{}),pe(this,"_notVisibleShapes",LR(this)),pe(this,"_parentIdsToChildIds"),pe(this,"animatingShapes",new Map),pe(this,"externalAssetContentHandlers",{file:null,url:null}),pe(this,"temporaryAssetPreview",new Map),pe(this,"externalContentHandlers",{text:null,files:null,"file-replace":null,embed:null,"svg-text":null,url:null,tldraw:null,excalidraw:null}),pe(this,"_clickManager",new mu(this)),pe(this,"_prevCursor","default"),pe(this,"_shiftKeyTimeout",-1),pe(this,"_altKeyTimeout",-1),pe(this,"_ctrlKeyTimeout",-1),pe(this,"_metaKeyTimeout",-1),pe(this,"_restoreToolId","select"),pe(this,"_didPinch",!1),pe(this,"_selectedShapeIdsAtPointerDown",[]),pe(this,"_longPressTimeout",-1),pe(this,"capturedPointerId",null),pe(this,"performanceTracker"),pe(this,"performanceTrackerTimeout",-1),pe(this,"handledEvents",new WeakSet),pe(this,"_pendingEventsForNextTick",[]),this._getShapeVisibility=f,this.options={...PR,...p},this.store=e,this.history=new VR({store:e,annotateError:T=>{this.annotateError(T,{origin:"history.batch",willCrashApp:!0}),this.crash(T)}}),this.snaps=new el(this),this.disposables.add(this.timers.dispose),this._cameraOptions.set({...uw,...a}),this._textOptions=je("text options",c??null),this.user=new un(n??NP(),d??!1),this.disposables.add(()=>this.user.dispose()),this.getContainer=o,this.textMeasure=new z3(this),this.disposables.add(()=>this.textMeasure.dispose()),this.fonts=new YR(this,g),this._tickManager=new bu(this),this.inputs=new my(this);class x extends nF{static initial=l??""}this.root=new x(this),this.root.children={},this.markEventAsHandled=this.markEventAsHandled.bind(this);const y=ZP(s),m={},S={},w=new Map;for(const T of y){const D=new T(this);m[T.type]=D;const R=F1(T.props??{});S[T.type]=R;for(const M of R.keys())if(!w.has(M.id))w.set(M.id,M);else if(w.get(M.id)!==M)throw Error(`Multiple style props with id "${M.id}" in use. Style prop IDs must be unique.`)}this.shapeUtils=m,this.styleProps=S;const P=qP(r),_={};for(const T of P){const D=new T(this);_[T.type]=D}this.bindingUtils=_;for(const T of[...i]){if(Ut(this.root.children,T.id))throw Error(`Can't override tool with id "${T.id}"`);this.root.children[T.id]=new T(this,this.root)}this.scribbles=new c3(this);const I=(T,D)=>{let R=null;const M=T.selectedShapeIds.filter(V=>!D.has(V));M.length!==T.selectedShapeIds.length&&(R||(R={...T}),R.selectedShapeIds=M);const L=T.erasingShapeIds.filter(V=>!D.has(V));L.length!==T.erasingShapeIds.length&&(R||(R={...T}),R.erasingShapeIds=L),T.hoveredShapeId&&D.has(T.hoveredShapeId)&&(R||(R={...T}),R.hoveredShapeId=null),T.editingShapeId&&D.has(T.editingShapeId)&&(R||(R={...T}),R.editingShapeId=null);const U=T.hintingShapeIds.filter(V=>!D.has(V));return U.length!==T.hintingShapeIds.length&&(R||(R={...T}),R.hintingShapeIds=U),T.focusedGroupId&&D.has(T.focusedGroupId)&&(R||(R={...T}),R.focusedGroupId=null),R};this.sideEffects=this.store.sideEffects;let C=new Map;const E=new Set,O=new Set;let k=new Set;if(this.disposables.add(this.sideEffects.registerOperationCompleteHandler(()=>{E.clear();for(const T of O){O.delete(T);const D=this.getShape(T);if(!D)continue;const M=this.getShapeUtil(D).onChildrenChange?.(D);M?.length&&this.updateShapes(M)}if(k.size){const T=k;k=new Set;for(const D of T)this.getBindingUtil(D).onOperationComplete?.()}if(C.size){const T=C;C=new Map;for(const D of T.values())this.getBindingUtil(D.binding).onAfterDelete?.(D)}this.emit("update")})),this.disposables.add(this.sideEffects.register({shape:{afterChange:(T,D)=>{for(const R of this.getBindingsInvolvingShape(D))k.add(R.type),R.fromId===D.id&&this.getBindingUtil(R).onAfterChangeFromShape?.({binding:R,shapeBefore:T,shapeAfter:D,reason:"self"}),R.toId===D.id&&this.getBindingUtil(R).onAfterChangeToShape?.({binding:R,shapeBefore:T,shapeAfter:D,reason:"self"});if(T.parentId!==D.parentId){const R=M=>{const L=this.getShape(M);if(L)for(const U of this.getBindingsInvolvingShape(L))k.add(U.type),U.fromId===L.id&&this.getBindingUtil(U).onAfterChangeFromShape?.({binding:U,shapeBefore:L,shapeAfter:L,reason:"ancestry"}),U.toId===L.id&&this.getBindingUtil(U).onAfterChangeToShape?.({binding:U,shapeBefore:L,shapeAfter:L,reason:"ancestry"})};R(D.id),this.visitDescendants(D.id,R)}if(T.parentId!==D.parentId&&nn(D.parentId)){const R=new Set([T.id]);this.visitDescendants(T.id,M=>{R.add(M)});for(const M of this.getPageStates()){if(M.pageId===D.parentId)continue;const L=I(M,R);L&&this.store.put([L])}}T.parentId&&On(T.parentId)&&O.add(T.parentId),D.parentId!==T.parentId&&On(D.parentId)&&O.add(D.parentId)},beforeDelete:T=>{if(E.has(T.id))return;T.parentId&&On(T.parentId)&&O.add(T.parentId),E.add(T.id);const D=[];for(const L of this.getBindingsInvolvingShape(T)){k.add(L.type),D.push(L.id);const U=this.getBindingUtil(L);L.fromId===T.id?(U.onBeforeIsolateToShape?.({binding:L,removedShape:T}),U.onBeforeDeleteFromShape?.({binding:L,shape:T})):(U.onBeforeIsolateFromShape?.({binding:L,removedShape:T}),U.onBeforeDeleteToShape?.({binding:L,shape:T}))}D.length&&this.deleteBindings(D);const R=new Set([T.id]),M=ve(this.getPageStates().map(L=>I(L,R)));M.length&&this.store.put(M)}},binding:{beforeCreate:T=>{const D=this.getBindingUtil(T).onBeforeCreate?.({binding:T});return D||T},afterCreate:T=>{k.add(T.type),this.getBindingUtil(T).onAfterCreate?.({binding:T})},beforeChange:(T,D)=>{const R=this.getBindingUtil(D).onBeforeChange?.({bindingBefore:T,bindingAfter:D});return R||D},afterChange:(T,D)=>{k.add(D.type),this.getBindingUtil(D).onAfterChange?.({bindingBefore:T,bindingAfter:D})},beforeDelete:T=>{this.getBindingUtil(T).onBeforeDelete?.({binding:T})},afterDelete:T=>{this.getBindingUtil(T).onAfterDelete?.({binding:T}),k.add(T.type)}},page:{afterCreate:T=>{const D=mr.createId(T.id),R=Qs.createId(T.id);this.store.has(D)||this.store.put([mr.create({id:D})]),this.store.has(R)||this.store.put([Qs.create({id:R,pageId:T.id})])},afterDelete:(T,D)=>{if(this.getInstanceState()?.currentPageId===T.id){const L=this.getPages().find(U=>U.id!==T.id)?.id;L?this.store.put([{...this.getInstanceState(),currentPageId:L}]):D==="user"&&this.store.ensureStoreIsUsable()}const R=mr.createId(T.id),M=Qs.createId(T.id);this.store.remove([R,M])}},instance:{afterChange:(T,D,R)=>{if(!this.store.has(D.currentPageId)){const M=this.store.has(T.currentPageId)?T.currentPageId:this.getPages()[0]?.id;M?this.store.update(D.id,L=>({...L,currentPageId:M})):R==="user"&&this.store.ensureStoreIsUsable()}}},instance_page_state:{afterChange:(T,D)=>{if(T?.selectedShapeIds!==D?.selectedShapeIds){const R=D.selectedShapeIds.filter(L=>{let U=this.getShape(L)?.parentId;for(;On(U);){if(D.selectedShapeIds.includes(U))return!1;U=this.getShape(U)?.parentId}return!0});let M=null;if(R.length>0){const L=this.findCommonAncestor(ve(R.map(U=>this.getShape(U))),U=>this.isShapeOfType(U,"group"));L&&(M=L)}else D?.focusedGroupId&&(M=D.focusedGroupId);(R.length!==D.selectedShapeIds.length||M!==D.focusedGroupId)&&this.store.put([{...D,selectedShapeIds:R,focusedGroupId:M??null}])}}}})),this._currentPageShapeIds=FR(this.store,()=>this.getCurrentPageId()),this._parentIdsToChildIds=RR(this.store),this.disposables.add(this.store.listen(T=>{this.emit("change",T)})),this.disposables.add(this.history.dispose),this.run(()=>{this.store.ensureStoreIsUsable(),this._updateCurrentPageState({editingShapeId:null,hoveredShapeId:null,erasingShapeIds:[]})},{history:"ignore"}),l&&this.root.children[l]===void 0)throw Error(`No state found for initialState "${l}".`);if(this.root.enter(void 0,"initial"),this.edgeScrollManager=new qR(this),this.focusManager=new GR(this,u),this.disposables.add(this.focusManager.dispose.bind(this.focusManager)),this.getInstanceState().followingUserId&&this.stopFollowingUser(),this.on("tick",this._flushEventsForTick),this.timers.requestAnimationFrame(()=>{this._tickManager.start()}),this.performanceTracker=new _0,this.store.props.collaboration?.mode){const T=this.store.props.collaboration.mode;this.disposables.add(is("update collaboration mode",()=>{this.store.put([{...this.getInstanceState(),isReadonly:T.get()==="readonly"}])}))}}getIsShapeHiddenCache(){return this._getShapeVisibility?this.store.createComputedCache("isShapeHidden",e=>{const n=this._getShapeVisibility(e,this);return(zn.isId(e.parentId)?!1:this.isShapeHidden(e.parentId))?n!=="visible":n==="hidden"}):null}isShapeHidden(e){return this._getShapeVisibility?!!this.getIsShapeHiddenCache().get(typeof e=="string"?e:e.id):!1}setTool(e,n){if(n??=this.root,Ut(n.children,e.id))throw Error(`Can't override tool with id "${e.id}"`);n.children[e.id]=new e(this,n)}removeTool(e,n){n??=this.root,Ut(n.children,e.id)&&delete n.children[e.id]}dispose(){this.disposables.forEach(e=>e()),this.disposables.clear(),this.store.dispose(),this.isDisposed=!0,this.emit("dispose")}getShapeUtil(e){const n=typeof e=="string"?e:e.type,s=Nt(this.shapeUtils,n);return le(s,`No shape util found for type "${n}"`),s}hasShapeUtil(e){const n=typeof e=="string"?e:e.type;return Ut(this.shapeUtils,n)}getBindingUtil(e){const n=typeof e=="string"?e:e.type,s=Nt(this.bindingUtils,n);return le(s,`No binding util found for type "${n}"`),s}undo(){return this._flushEventsForTick(0),this.complete(),this.history.undo(),this}canUndo(){return this.history.getNumUndos()>0}getCanUndo(){return this.canUndo()}redo(){return this._flushEventsForTick(0),this.complete(),this.history.redo(),this}canRedo(){return this.history.getNumRedos()>0}getCanRedo(){return this.canRedo()}clearHistory(){return this.history.clear(),this}markHistoryStoppingPoint(e){const n=`[${e??"stop"}]_${Ge()}`;return this.history._mark(n),n}getMarkIdMatching(e){return this.history.getMarkIdMatching(e)}squashToMark(e){return this.history.squashToMark(e),this}bail(){return this.history.bail(),this}bailToMark(e){return this.history.bailToMark(e),this}run(e,n){const s=this._shouldIgnoreShapeLock;this._shouldIgnoreShapeLock=n?.ignoreShapeLock??s;try{this.history.batch(e,n)}finally{this._shouldIgnoreShapeLock=s}return this}annotateError(e,{origin:n,willCrashApp:s,tags:r,extras:i}){const o=this.createErrorAnnotations(n,s);return pm(e,{tags:{...o.tags,...r},extras:{...o.extras,...i}}),s&&this.store.markAsPossiblyCorrupted(),this}createErrorAnnotations(e,n){try{const s=this.getEditingShapeId();return{tags:{origin:e,willCrashApp:n},extras:{activeStateNode:this.root.getPath(),selectedShapes:this.getSelectedShapes().map(r=>{const{props:i,...o}=r,{text:a,richText:c,...l}=i;return{...o,props:l}}),selectionCount:this.getSelectedShapes().length,editingShape:s?this.getShape(s):void 0,inputs:this.inputs.toJson(),pageState:this.getCurrentPageState(),instanceState:this.getInstanceState(),collaboratorCount:this.getCollaboratorsOnCurrentPage().length}}}catch{return{tags:{origin:e,willCrashApp:n},extras:{}}}}getCrashingError(){return this._crashingError}crash(e){return this._crashingError=e,this.store.markAsPossiblyCorrupted(),this.emit("crash",{error:e}),this}getPath(){return this.root.getPath().split("root.")[1]}isIn(e){const n=e.split(".").reverse();let s=this.root;for(;n.length>0;){const r=n.pop();if(!r)return!0;const i=s.getCurrent();if(i?.id===r){if(n.length===0)return!0;s=i;continue}else return!1}return!1}isInAny(...e){return e.some(n=>this.isIn(n))}setCurrentTool(e,n={}){return this.root.transition(e,n),this}getCurrentTool(){return this.root.getCurrent()}getCurrentToolId(){const e=this.getCurrentTool();return e?e.getCurrentToolIdMask()??e.id:""}getStateDescendant(e){const n=e.split(".").reverse();let s=this.root;for(;n.length>0;){const r=n.pop();if(!r)return s;const i=s.children?.[r];if(!i)return;s=i}return s}getDocumentSettings(){return this.store.get(Pg)}updateDocumentSettings(e){return this.run(()=>{this.store.put([{...this.getDocumentSettings(),...e}])},{history:"ignore"}),this}getInstanceState(){return this.store.get(Fn)}updateInstanceState(e,n){return this._updateInstanceState(e,{history:"ignore",...n}),e.isChangingStyle!==void 0&&(clearTimeout(this._isChangingStyleTimeout),e.isChangingStyle===!0&&(this._isChangingStyleTimeout=this.timers.setTimeout(()=>{this._updateInstanceState({isChangingStyle:!1},{history:"ignore"})},1e3))),this}_updateInstanceState(e,n){this.run(()=>{this.store.put([{...this.getInstanceState(),...e}])},n)}setCursor(e){return this.updateInstanceState({cursor:{...this.getInstanceState().cursor,...e}}),this}getPageStates(){return this._getPageStatesQuery().get()}_getPageStatesQuery(){return this.store.query.records("instance_page_state")}getCurrentPageState(){return this.store.get(this._getCurrentPageStateId())}_getCurrentPageStateId(){return Qs.createId(this.getCurrentPageId())}updateCurrentPageState(e){return this._updateCurrentPageState(e),this}_updateCurrentPageState(e){this.store.update(e.id??this.getCurrentPageState().id,n=>({...n,...e}))}getSelectedShapeIds(){return this.getCurrentPageState().selectedShapeIds}getSelectedShapes(){return ve(this.getSelectedShapeIds().map(e=>this.store.get(e)))}setSelectedShapes(e){return this.run(()=>{const n=e.map(i=>typeof i=="string"?i:i.id),{selectedShapeIds:s}=this.getCurrentPageState(),r=new Set(s);if(n.length===r.size&&n.every(i=>r.has(i)))return null;this.store.put([{...this.getCurrentPageState(),selectedShapeIds:n}])},{history:"record-preserveRedoStack"})}isAncestorSelected(e){const n=typeof e=="string"?e:e?.id??null,s=this.getShape(n);if(!s)return!1;const r=this.getSelectedShapeIds();return!!this.findShapeAncestor(s,i=>r.includes(i.id))}select(...e){const n=typeof e[0]=="string"?e:e.map(s=>s.id);return this.setSelectedShapes(n),this}deselect(...e){const n=typeof e[0]=="string"?e:e.map(r=>r.id),s=this.getSelectedShapeIds();return s.length>0&&n.length>0&&this.setSelectedShapes(s.filter(r=>!n.includes(r))),this}selectAll(){let e=null;const n=this.getSelectedShapeIds();if(n.length>0)for(const r of n){const i=this.getShape(r);if(i){if(e===null)e=i.parentId;else if(e!==i.parentId)return this}}e||(e=this.getCurrentPageId());const s=this.getSortedChildIdsForParent(e);return s.length<=0?this:(this.setSelectedShapes(this._getUnlockedShapeIds(s)),this)}selectAdjacentShape(e){const n=this.getSelectedShapeIds(),s=n[0]?this.getShape(n[0])?.parentId:null,r=s&&n.every(u=>this.getShape(u)?.parentId===s)&&!nn(s),i=r?this.getCurrentPageShapes().filter(u=>u.parentId===s):this.getCurrentPageShapes().filter(u=>nn(u.parentId)),o=r?this._getShapesInReadingOrder(i):this.getCurrentPageShapesInReadingOrder(),a=n.length===1?n[0]:o.find(u=>n.includes(u.id))?.id;let c;if(e==="next"||e==="prev"){const u=o.map(f=>f.id),p=((a?u.indexOf(a):-1)+(e==="next"?1:-1)+u.length)%u.length;c=u[p]}else{if(!a)return;c=this.getNearestAdjacentShape(i,a,e)}const l=this.getShape(c);l&&this._selectShapesAndZoom([l.id])}getCurrentPageShapesInReadingOrder(){const e=this.getCurrentPageShapes().filter(n=>nn(n.parentId));return this._getShapesInReadingOrder(e)}_getShapesInReadingOrder(e){const r=e.filter(a=>this.getShapeUtil(a).canTabTo(a));if(r.length<=1)return r;const i=r.map(a=>({shape:a,center:this.getShapePageBounds(a).center}));i.sort((a,c)=>a.center.y-c.center.y);const o=[];for(const a of i){let c=-1;for(let l=o.length-1;l>=0;l--){const u=o[l],d=u[u.length-1];if(Math.abs(a.center.y-d.center.y)<100){c=l;break}}c===-1?o.push([a]):o[c].push(a)}for(const a of o)a.sort((c,l)=>c.center.x-l.center.x);for(const a of o)if(!(a.length<=2))for(let c=0;c<a.length-2;c++){const l=a[c],u=a[c+1],d=a[c+2],p=b.Dist2(l.center,u.center);b.Dist2(l.center,d.center)<p*.9&&Math.abs(b.Angle(l.center,d.center)*(180/Math.PI))<=20&&([a[c+1],a[c+2]]=[a[c+2],a[c+1]])}return o.flat().map(a=>a.shape)}getNearestAdjacentShape(e,n,s){const r={right:0,left:180,down:90,up:270},i=this.getShape(n);if(!i)return n;const o=e.filter(d=>this.getShapeUtil(d).canTabTo(d)&&d.id!==n);if(!o.length)return n;const a=this.getShapePageBounds(i).center,l=o.map(d=>({shape:d,center:this.getShapePageBounds(d).center})).filter(({center:d})=>{const p=d.x>a.x,f=d.y>a.y,g=d.x-a.x,x=d.y-a.y,y=Math.abs(x)<Math.abs(g)*2,m=Math.abs(g)<Math.abs(x)*2;if(s==="left"||s==="right")return y&&(s==="right"?p:!p);if(s==="up"||s==="down")return m&&(s==="down"?f:!f)});return l.length===0?n:m0(l,({center:d})=>{const p=b.Dist2(a,d),f=["left","right"].includes(s)?"x":"y",g=Math.abs(d[f]-a[f]),x=["left","right"].includes(s)?"y":"x",y=Math.abs(d[x]-a[x]),m=Math.abs(b.Angle(a,d)*(180/Math.PI)),S=Math.abs(m-r[s]);return p*1+y*2+(p-g)*1.5+S*.5}).shape.id}selectParentShape(){const e=this.getOnlySelectedShape();if(!e)return;const n=this.getShape(e.parentId);n&&this._selectShapesAndZoom([n.id])}selectFirstChildShape(){const e=this.getSelectedShapes();if(!e.length)return;const n=e[0],s=this.getSortedChildIdsForParent(n.id).map(i=>this.getShape(i)).filter(i=>i),r=this._getShapesInReadingOrder(s);r.length!==0&&this._selectShapesAndZoom([r[0].id])}_selectShapesAndZoom(e){this.setSelectedShapes(e),this.zoomToSelectionIfOffscreen(256,{animation:{duration:this.options.animationMediumMs},inset:0})}selectNone(){return this.getSelectedShapeIds().length>0&&this.setSelectedShapes([]),this}getOnlySelectedShapeId(){return this.getOnlySelectedShape()?.id??null}getOnlySelectedShape(){const e=this.getSelectedShapes();return e.length===1?e[0]:null}getShapesPageBounds(e){const n=ve(e.map(s=>this.getShapePageBounds(s)));return n.length===0?null:X.Common(n)}getSelectionPageBounds(){return this.getShapesPageBounds(this.getSelectedShapeIds())}getSelectionScreenBounds(){const e=this.getSelectionPageBounds();if(!e)return;const{x:n,y:s}=this.pageToScreen(e.point),r=this.getZoomLevel();return new X(n,s,e.width*r,e.height*r)}getShapesSharedRotation(e){let n=!1,s=0;for(let r=0,i=e.length;r<i;r++){const o=this.getShapePageTransform(e[r]);if(o)if(n){if(o.rotation()!==s)return 0}else n=!0,s=o.rotation()}return s}getSelectionRotation(){return this.getShapesSharedRotation(this.getSelectedShapeIds())}getShapesRotatedPageBounds(e){if(e.length===0)return;const n=this.getShapesSharedRotation(e);if(n===0)return this.getShapesPageBounds(e)??void 0;if(e.length===1){const r=this.getShapeGeometry(e[0]).bounds.clone(),i=this.getShapePageTransform(e[0]);return r.point=i.applyToPoint(r.point),r}const s=X.FromPoints(e.flatMap(r=>{const i=this.getShapePageTransform(r);return i?i.applyToPoints(this.getShapeGeometry(r).bounds.corners):[]}).map(r=>r.rot(-n)));return s.point=s.point.rot(n),s}getSelectionRotatedPageBounds(){return this.getShapesRotatedPageBounds(this.getSelectedShapeIds())}getSelectionRotatedScreenBounds(){const e=this.getSelectionRotatedPageBounds();if(!e)return;const{x:n,y:s}=this.pageToScreen(e.point),r=this.getZoomLevel();return new X(n,s,e.width*r,e.height*r)}getFocusedGroupId(){return this.getCurrentPageState().focusedGroupId??this.getCurrentPageId()}getFocusedGroup(){const e=this.getFocusedGroupId();return e?this.getShape(e):void 0}setFocusedGroup(e){const n=typeof e=="string"?e:e?.id??null;if(n!==null){const s=this.getShape(n);if(!s)throw Error(`Editor.setFocusedGroup: Shape with id ${n} does not exist`);if(!this.isShapeOfType(s,"group"))throw Error(`Editor.setFocusedGroup: Cannot set focused group to shape of type ${s.type}`)}return n===this.getFocusedGroupId()?this:this.run(()=>{this.store.update(this.getCurrentPageState().id,s=>({...s,focusedGroupId:n}))},{history:"record-preserveRedoStack"})}popFocusedGroupId(){const e=this.getFocusedGroup();if(e){const n=this.findShapeAncestor(e,s=>this.isShapeOfType(s,"group"));this.setFocusedGroup(n?.id??null),this.select(e.id)}else this.setFocusedGroup(null),this.selectNone();return this}getEditingShapeId(){return this.getCurrentPageState().editingShapeId}getEditingShape(){const e=this.getEditingShapeId();return e?this.getShape(e):void 0}canEditShape(e,n){const s=typeof e=="string"?e:e?.id??null;if(!s||s===this.getEditingShapeId())return!1;const r=this.getShape(s);if(!r)return!1;const i=this.getShapeUtil(r),o=n??{type:"unknown"};return!(!i.canEdit(r,o)||this.getIsReadonly()&&!i.canEditInReadonly(r)||this.isShapeOrAncestorLocked(r)&&!i.canEditWhileLocked(r))}setEditingShape(e){const n=typeof e=="string"?e:e?.id??null;return n?this.canEditShape(n)?(this.run(()=>{const s=this.getEditingShapeId();if(s){const i=this.getShape(s);i&&this.getShapeUtil(i).onEditEnd?.(i)}this._updateCurrentPageState({editingShapeId:null}),this._currentRichTextEditor.set(null),this.select(n),this._updateCurrentPageState({editingShapeId:n});const r=this.getShape(n);this.getShapeUtil(r).onEditStart?.(r)},{history:"ignore"}),this):this:(this.run(()=>{const s=this.getEditingShapeId();if(s){const r=this.getShape(s);r&&this.getShapeUtil(r).onEditEnd?.(r)}this._updateCurrentPageState({editingShapeId:null}),this._currentRichTextEditor.set(null)},{history:"ignore"}),this)}getRichTextEditor(){return this._currentRichTextEditor.get()}setRichTextEditor(e){return this._currentRichTextEditor.set(e),this}getHoveredShapeId(){return this.getCurrentPageState().hoveredShapeId}getHoveredShape(){const e=this.getHoveredShapeId();return e?this.getShape(e):void 0}setHoveredShape(e){const n=typeof e=="string"?e:e?.id??null;return n===this.getHoveredShapeId()?this:(this.run(()=>{this.updateCurrentPageState({hoveredShapeId:n})},{history:"ignore"}),this)}getHintingShapeIds(){return this.getCurrentPageState().hintingShapeIds}getHintingShape(){const e=this.getHintingShapeIds();return ve(e.map(n=>this.getShape(n)))}setHintingShapes(e){const n=typeof e[0]=="string"?e:e.map(s=>s.id);return this.run(()=>{this._updateCurrentPageState({hintingShapeIds:um(n)})},{history:"ignore"}),this}getErasingShapeIds(){return this.getCurrentPageState().erasingShapeIds}getErasingShapes(){const e=this.getErasingShapeIds();return ve(e.map(n=>this.getShape(n)))}setErasingShapes(e){const n=typeof e[0]=="string"?e:e.map(r=>r.id);n.sort();const s=this.getErasingShapeIds();return this.run(()=>{if(n.length===s.length){for(let r=0;r<n.length;r++)if(n[r]!==s[r]){this._updateCurrentPageState({erasingShapeIds:n});break}}else this._updateCurrentPageState({erasingShapeIds:n})},{history:"ignore"}),this}getCroppingShapeId(){return this.getCurrentPageState().croppingShapeId}canCropShape(e){if(!e)return!1;const n=typeof e=="string"?e:e?.id??null;if(!n)return!1;const s=this.getShape(n);return!(!s||!this.getShapeUtil(s).canCrop(s)||this.isShapeOrAncestorLocked(s))}setCroppingShape(e){const n=typeof e=="string"?e:e?.id??null;return n!==this.getCroppingShapeId()&&this.run(()=>{n?this.canCropShape(n)&&this.updateCurrentPageState({croppingShapeId:n}):this.updateCurrentPageState({croppingShapeId:null})},{history:"ignore"}),this}getTextOptions(){return Gt(this._textOptions.get(),"Cannot use text without setting textOptions")}_unsafe_getCameraId(){return mr.createId(this.getCurrentPageId())}getCamera(){const e=this.store.get(this._unsafe_getCameraId());if(this._isLockedOnFollowingUser.get()){const n=this.getCameraForFollowing();if(n)return{...e,...n}}return e}_getFollowingPresence(e){const n=[this.user.getId()],s=this.getCollaborators();let r=null;for(;e&&!n.includes(e);)r=s.find(i=>i.userId===e)??null,e=r?.followingUserId??null,r&&n.push(r.userId);return r}getViewportPageBoundsForFollowing(){const e=this._getFollowingPresence(this.getInstanceState().followingUserId);if(!e?.camera||!e?.screenBounds)return null;const{w:n,h:s}=e.screenBounds,{x:r,y:i,z:o}=e.camera,a=new X(-r,-i,n/o,s/o),c=this.getViewportScreenBounds().clone(),l=c.width/c.height;return c.width=a.width,c.height=c.width/l,c.height<a.height&&(c.height=a.height,c.width=c.height*l),c.center=a.center,c}getCameraForFollowing(){const e=this.getViewportPageBoundsForFollowing();return e?{x:-e.x,y:-e.y,z:this.getViewportScreenBounds().w/e.width}:null}getZoomLevel(){return this.getCamera().z}getDebouncedZoomLevel(){return this.options.debouncedZoom?this.getCameraState()==="idle"?this.getZoomLevel():this._debouncedZoomLevel.get():this.getZoomLevel()}_getAboveDebouncedZoomThreshold(){return this.getCurrentPageShapeIds().size>this.options.debouncedZoomThreshold}getEfficientZoomLevel(){return this._getAboveDebouncedZoomThreshold()?this.getDebouncedZoomLevel():this.getZoomLevel()}getInitialZoom(){const e=this.getCameraOptions();if(!e.constraints||e.constraints.initialZoom==="default")return 1;const{zx:n,zy:s}=Bw(this,e);switch(e.constraints.initialZoom){case"fit-min":return Math.max(n,s);case"fit-max":return Math.min(n,s);case"fit-x":return n;case"fit-y":return s;case"fit-min-100":return Math.min(1,Math.max(n,s));case"fit-max-100":return Math.min(1,Math.min(n,s));case"fit-x-100":return Math.min(1,n);case"fit-y-100":return Math.min(1,s);default:throw Ke(e.constraints.initialZoom)}}getBaseZoom(){const e=this.getCameraOptions();if(!e.constraints||e.constraints.baseZoom==="default")return 1;const{zx:n,zy:s}=Bw(this,e);switch(e.constraints.baseZoom){case"fit-min":return Math.max(n,s);case"fit-max":return Math.min(n,s);case"fit-x":return n;case"fit-y":return s;case"fit-min-100":return Math.min(1,Math.max(n,s));case"fit-max-100":return Math.min(1,Math.min(n,s));case"fit-x-100":return Math.min(1,n);case"fit-y-100":return Math.min(1,s);default:throw Ke(e.constraints.baseZoom)}}getCameraOptions(){return this._cameraOptions.get()}setCameraOptions(e){const n=wt({...this._cameraOptions.__unsafe__getWithoutCapture(),...e});return n.zoomSteps?.length<1&&(n.zoomSteps=[1]),this._cameraOptions.set(n),this.setCamera(this.getCamera()),this}getConstrainedCamera(e,n){const s=this.getCamera();let{x:r,y:i,z:o=s.z}=e;if(!n?.force){const a=this.getCameraOptions(),c=a.zoomSteps[0],l=Fs(a.zoomSteps),u=this.getViewportScreenBounds();if(a.constraints){const{constraints:d}=a,p=Math.min(d.padding.y,u.w/2),f=Math.min(d.padding.x,u.h/2),g=X.From(a.constraints.bounds),x=(u.w-f*2)/g.w,y=(u.h-p*2)/g.h,m=this.getBaseZoom(),S=l*m,w=c*m;if(n?.reset&&(o=this.getInitialZoom()),o<w||o>S){const{x:D,y:R,z:M}=s,L=-D+u.w/M/2,U=-R+u.h/M/2;o=Ce(o,w,S);const V=-D+u.w/o/2,J=-R+u.h/o/2;r=D+V-L,i=R+J-U}const P=f/o-g.x,_=p/o-g.y,I=(u.w-f*2)/o-g.w,C=(u.h-p*2)/o-g.h,E=P+I*d.origin.x,O=_+C*d.origin.y,k=typeof d.behavior=="string"?d.behavior:d.behavior.x,T=typeof d.behavior=="string"?d.behavior:d.behavior.y;if(n?.reset)r=E,i=O;else{switch(k){case"fixed":{r=E;break}case"contain":{o<x?r=E:r=Ce(r,P+I,P);break}case"inside":{o<x?r=Ce(r,P,(u.w-f)/o-g.w):r=Ce(r,P+I,P);break}case"outside":{r=Ce(r,f/o-g.w,(u.w-f)/o);break}case"free":break;default:throw Ke(k)}switch(T){case"fixed":{i=O;break}case"contain":{o<y?i=O:i=Ce(i,_+C,_);break}case"inside":{o<y?i=Ce(i,_,(u.h-p)/o-g.h):i=Ce(i,_+C,_);break}case"outside":{i=Ce(i,p/o-g.h,(u.h-p)/o);break}case"free":break;default:throw Ke(T)}}}else if(o>l||o<c){const{x:d,y:p,z:f}=s;o=Ce(o,c,l),r=d+(-d+u.w/o/2)-(-d+u.w/f/2),i=p+(-p+u.h/o/2)-(-p+u.h/f/2)}}return{x:r,y:i,z:o}}_setCamera(e,n){const s=this.getCamera(),{x:r,y:i,z:o}=this.getConstrainedCamera(e,n);return s.x===r&&s.y===i&&s.z===o?this:(xs(()=>{const a={...s,x:r,y:i,z:o};this.run(()=>{this.store.put([a])},{history:"ignore"});const c=this.inputs.getCurrentScreenPoint(),l=this.inputs.getCurrentPagePoint();(c.x/o-r!==l.x||c.y/o-i!==l.y)&&this.updatePointer({immediate:n?.immediate,pointerId:PP.CAMERA_MOVE}),this._tickCameraState()}),this)}setCamera(e,n){const{isLocked:s}=this._cameraOptions.__unsafe__getWithoutCapture();if(s&&!n?.force)return this;this.stopCameraAnimation(),this.getInstanceState().followingUserId&&this.stopFollowingUser();const r=b.Cast(e);Number.isFinite(r.x)||(r.x=0),Number.isFinite(r.y)||(r.y=0),(r.z===void 0||!Number.isFinite(r.z))&&(e.z=this.getZoomLevel());const i=this.getConstrainedCamera(r,n);if(n?.animation){const{width:o,height:a}=this.getViewportScreenBounds();this._animateToViewport(new X(-i.x,-i.y,o/i.z,a/i.z),n)}else this._setCamera(i,{...n,force:!0});return this}centerOnPoint(e,n){const{isLocked:s}=this.getCameraOptions();if(s&&!n?.force)return this;const{width:r,height:i}=this.getViewportPageBounds();return this.setCamera(new b(-(e.x-r/2),-(e.y-i/2),this.getCamera().z),n),this}zoomToFit(e){const n=[...this.getCurrentPageShapeIds()];if(n.length<=0)return this;const s=X.Common(ve(n.map(r=>this.getShapePageBounds(r))));return this.zoomToBounds(s,e),this}resetZoom(e=this.getViewportScreenCenter(),n){const{isLocked:s,constraints:r}=this.getCameraOptions();if(s&&!n?.force)return this;const i=this.getCamera(),{x:o,y:a,z:c}=i,{x:l,y:u}=e;let d=1;if(r){const p=this.getInitialZoom();c!==p&&(d=p)}return this.setCamera(new b(o+(l/d-l)-(l/c-l),a+(u/d-u)-(u/c-u),d),n),this}zoomIn(e=this.getViewportScreenCenter(),n){const{isLocked:s}=this.getCameraOptions();if(s&&!n?.force)return this;const{x:r,y:i,z:o}=this.getCamera(),{zoomSteps:a}=this.getCameraOptions();if(a!==null&&a.length>1){const c=this.getBaseZoom();let l=Fs(a)*c;for(let u=1;u<a.length;u++){const d=a[u-1]*c,p=a[u]*c;if(!(p-o<=(p-d)/2)){l=p;break}}this.setCamera(new b(r+(e.x/l-e.x)-(e.x/o-e.x),i+(e.y/l-e.y)-(e.y/o-e.y),l),n)}return this}zoomOut(e=this.getViewportScreenCenter(),n){const{isLocked:s}=this.getCameraOptions();if(s&&!n?.force)return this;const{zoomSteps:r}=this.getCameraOptions();if(r!==null&&r.length>1){const i=this.getBaseZoom(),{x:o,y:a,z:c}=this.getCamera();let l=r[0]*i;for(let u=r.length-1;u>0;u--){const d=r[u-1]*i,p=r[u]*i;if(!(p-c>=(p-d)/2)){l=d;break}}this.setCamera(new b(o+(e.x/l-e.x)-(e.x/c-e.x),a+(e.y/l-e.y)-(e.y/c-e.y),l),n)}return this}zoomToSelection(e){const{isLocked:n}=this.getCameraOptions();if(n&&!e?.force)return this;const s=this.getSelectionPageBounds();if(s){const r=this.getZoomLevel();Math.abs(r-1)<.01?this.zoomToBounds(s,e):this.zoomToBounds(s,{targetZoom:1,...e})}return this}zoomToSelectionIfOffscreen(e=16,n){const s=this.getSelectionPageBounds(),r=this.getViewportPageBounds();if(s&&!r.contains(s)){const i=s.clone().expandBy(e/this.getZoomLevel()).expand(r),o=r.clone().translate({x:(i.center.x-r.center.x)*2,y:(i.center.y-r.center.y)*2});this.zoomToBounds(o,n)}}zoomToBounds(e,n){const s=this._cameraOptions.__unsafe__getWithoutCapture();if(s.isLocked&&!n?.force)return this;const r=this.getViewportScreenBounds(),i=n?.inset??Math.min(this.options.zoomToFitPadding,r.width*.28),o=this.getBaseZoom(),a=s.zoomSteps[0],c=Fs(s.zoomSteps);let l=Ce(Math.min((r.width-i)/e.w,(r.height-i)/e.h),a*o,c*o);return n?.targetZoom!==void 0&&(l=Math.min(n.targetZoom,l)),this.setCamera(new b(-e.x+(r.width-e.w*l)/2/l,-e.y+(r.height-e.h*l)/2/l,l),n),this}stopCameraAnimation(){return this.emit("stop-camera-animation"),this}_animateViewport(e){if(!this._viewportAnimation)return;this._viewportAnimation.elapsed+=e;const{elapsed:n,easing:s,duration:r,start:i,end:o}=this._viewportAnimation;if(n>r){this.off("tick",this._animateViewport),this._viewportAnimation=null,this._setCamera(new b(-o.x,-o.y,this.getViewportScreenBounds().width/o.width));return}const a=r-n,c=s(1-a/r),l=i.minX+(o.minX-i.minX)*c,u=i.minY+(o.minY-i.minY)*c,d=i.maxX+(o.maxX-i.maxX)*c;this._setCamera(new b(-l,-u,this.getViewportScreenBounds().width/(d-l)),{force:!0})}_animateToViewport(e,n={animation:Lf}){const{animation:s,...r}=n;if(!s)return;const{duration:i=0,easing:o=Pn.easeInOutCubic}=s,a=this.user.getAnimationSpeed(),c=this.getViewportPageBounds();return this.stopCameraAnimation(),this.getInstanceState().followingUserId&&this.stopFollowingUser(),i===0||a===0?this._setCamera(new b(-e.x,-e.y,this.getViewportScreenBounds().width/e.width),{...r}):(this._viewportAnimation={elapsed:0,duration:i/a,easing:o,start:c.clone(),end:e.clone()},this.once("stop-camera-animation",()=>{this.off("tick",this._animateViewport),this._viewportAnimation=null}),this.on("tick",this._animateViewport),this)}slideCamera(e={}){const{isLocked:n}=this.getCameraOptions();if(n&&!e?.force)return this;if(this.user.getAnimationSpeed()===0)return this;this.stopCameraAnimation();const{speed:r,friction:i=this.options.cameraSlideFriction,direction:o,speedThreshold:a=.01}=e;let c=Math.min(r,1);const l=()=>{this.off("tick",u),this.off("stop-camera-animation",l)};this.once("stop-camera-animation",l);const u=d=>{const{x:p,y:f,z:g}=this.getCamera(),x=b.Mul(o,c*d/g);c*=1-i,c<a?l():this._setCamera(new b(p+x.x,f+x.y,g))};return this.on("tick",u),this}zoomToUser(e,n={animation:{duration:500}}){const s=this.getCollaborators().find(i=>i.userId===e);if(!s)return this;const r=s.cursor;return r?(this.run(()=>{this.getInstanceState().followingUserId!==null&&this.stopFollowingUser();const i=s.currentPageId===this.getCurrentPageId();i||this.setCurrentPage(s.currentPageId),n&&n.animation&&!i&&(n.animation=void 0),this.centerOnPoint(r,n);const{highlightedUserIds:o}=this.getInstanceState();this.updateInstanceState({highlightedUserIds:[...o,e]}),this.timers.setTimeout(()=>{const a=[...this.getInstanceState().highlightedUserIds],c=a.indexOf(e);c<0||(a.splice(c,1),this.updateInstanceState({highlightedUserIds:a}))},this.options.collaboratorIdleTimeoutMs)}),this):this}updateViewportScreenBounds(e,n=!1){if(e instanceof X)e.width=Math.max(e.width,1),e.height=Math.max(e.height,1);else{const a=e.getBoundingClientRect();e=new X(a.left||a.x,a.top||a.y,Math.max(a.width,1),Math.max(a.height,1))}const s=[e.minY!==0,!Dt(document.body.scrollWidth,e.maxX,1),!Dt(document.body.scrollHeight,e.maxY,1),e.minX!==0],{_willSetInitialBounds:r}=this;this._willSetInitialBounds=!1;const{screenBounds:i,insets:o}=this.getInstanceState();if(e.equals(i)&&s.every((a,c)=>a===o[c]))return this;if(r)this.updateInstanceState({screenBounds:e.toJson(),insets:s}),this.emit("resize",e.toJson()),this.setCamera(this.getCamera());else if(n&&!this.getInstanceState().followingUserId){const a=this.getViewportPageBounds().center;this.updateInstanceState({screenBounds:e.toJson(),insets:s}),this.emit("resize",e.toJson()),this.centerOnPoint(a)}else this.updateInstanceState({screenBounds:e.toJson(),insets:s}),this.emit("resize",e.toJson()),this._setCamera(b.From({...this.getCamera()}));return this}getViewportScreenBounds(){const{x:e,y:n,w:s,h:r}=this.getInstanceState().screenBounds;return new X(e,n,s,r)}getViewportScreenCenter(){const e=this.getViewportScreenBounds();return new b(e.w/2,e.h/2)}getViewportPageBounds(){const{w:e,h:n}=this.getViewportScreenBounds(),{x:s,y:r,z:i}=this.getCamera();return new X(-s,-r,e/i,n/i)}screenToPage(e){const{screenBounds:n}=this.store.unsafeGetWithoutCapture(Fn),{x:s,y:r,z:i=1}=this.getCamera();return new b((e.x-n.x)/i-s,(e.y-n.y)/i-r,e.z??.5)}pageToScreen(e){const{screenBounds:n}=this.store.unsafeGetWithoutCapture(Fn),{x:s,y:r,z:i=1}=this.getCamera();return new b((e.x+s)*i+n.x,(e.y+r)*i+n.y,e.z??.5)}pageToViewport(e){const{x:n,y:s,z:r=1}=this.getCamera();return new b((e.x+n)*r,(e.y+s)*r,e.z??.5)}_getCollaboratorsQuery(){return this.store.query.records("instance_presence",()=>({userId:{neq:this.user.getId()}}))}getCollaborators(){const e=this._getCollaboratorsQuery().get();return e.length?[...new Set(e.map(s=>s.userId))].sort().map(s=>IA(e.filter(i=>i.userId===s),i=>i.lastActivityTimestamp??0)):Ct}getCollaboratorsOnCurrentPage(){const e=this.getCurrentPageId();return this.getCollaborators().filter(n=>n.currentPageId===e)}startFollowingUser(e){if(this.stopFollowingUser(),this.user.getId()||console.warn("You should set the userId for the current instance before following a user"),!this._getFollowingPresence(e))return this;const r=K("latestLeaderPresence",()=>this._getFollowingPresence(e));return xs(()=>{this.updateInstanceState({followingUserId:e},{history:"ignore"});const i=is("update current page",()=>{const c=r.get();if(!c){this.stopFollowingUser();return}c.currentPageId!==this.getCurrentPageId()&&this.getPage(c.currentPageId)&&this.run(()=>{this.store.put([{...this.getInstanceState(),currentPageId:c.currentPageId}]),this._isLockedOnFollowingUser.set(!0)},{history:"ignore"})}),o=()=>{i(),this._isLockedOnFollowingUser.set(!1),this.off("frame",a),this.off("stop-following",o)},a=()=>{if(!r.get()){this.stopFollowingUser();return}if(this._isLockedOnFollowingUser.get())return;const l=this.user.getAnimationSpeed();if(l===0){this._isLockedOnFollowingUser.set(!0);return}const u=this.getViewportPageBoundsForFollowing();if(!u){this.stopFollowingUser();return}const d=this.getViewportPageBounds(),p=Math.abs(u.minX-d.minX)+Math.abs(u.maxX-d.maxX),f=Math.abs(u.minY-d.minY)+Math.abs(u.maxY-d.maxY);if(p<this.options.followChaseViewportSnap&&f<this.options.followChaseViewportSnap){this._isLockedOnFollowingUser.set(!0);return}const g=Ce(l*.5,.1,.8),x=new X(ke(d.minX,u.minX,g),ke(d.minY,u.minY,g),ke(d.width,u.width,g),ke(d.height,u.height,g)),y=new b(-x.x,-x.y,this.getViewportScreenBounds().width/x.width);this.stopCameraAnimation(),this._setCamera(y)};this.once("stop-following",o),this.addListener("frame",a),a()}),this}stopFollowingUser(){return this.run(()=>{this.store.put([this.getCamera()]),this._isLockedOnFollowingUser.set(!1),this.updateInstanceState({followingUserId:null}),this.emit("stop-following")},{history:"ignore"}),this}getUnorderedRenderingShapes(e){const n=[];let s=this.options.maxShapesPerPage*2,r=this.options.maxShapesPerPage;const i=this.getErasingShapeIds(),o=(c,l,u)=>{const d=this.getShape(c);if(!d)return;if(this.isShapeHidden(d)){const y=u||i.includes(c);for(const m of this.getSortedChildIdsForParent(c))o(m,l,y);return}l*=d.opacity;let p=!1;const f=this.getShapeUtil(d);e&&(p=!u&&i.includes(c),p&&(l*=.32)),n.push({id:c,shape:d,util:f,index:s,backgroundIndex:r,opacity:l}),s+=1,r+=1;const g=this.getSortedChildIdsForParent(c);if(!g.length)return;let x=null;f.providesBackgroundForChildren(d)&&(x=r,r=s,s+=this.options.maxShapesPerPage);for(const y of g)o(y,l,u||p);x!==null&&(r=x)},a=e?[this.getCurrentPage()]:this.getPages();for(const c of a)for(const l of this.getSortedChildIdsForParent(c.id))o(l,1,!1);return n}_decayCameraStateTimeout(e){this._cameraStateTimeoutRemaining-=e,!(this._cameraStateTimeoutRemaining>0)&&(this.off("tick",this._decayCameraStateTimeout),this._cameraState.set("idle"))}_tickCameraState(){this._cameraStateTimeoutRemaining=this.options.cameraMovingTimeoutMs,this._cameraState.__unsafe__getWithoutCapture()==="idle"&&(this._cameraState.set("moving"),this._debouncedZoomLevel.set(Yi(()=>this.getCamera().z)),this.on("tick",this._decayCameraStateTimeout))}getCameraState(){return this._cameraState.get()}getRenderingShapes(){return this.getUnorderedRenderingShapes(!0).sort(GA)}_getAllPagesQuery(){return this.store.query.records("page")}getPages(){return Array.from(this._getAllPagesQuery().get()).sort(Yt)}getCurrentPage(){return this.getPage(this.getCurrentPageId())}getCurrentPageId(){return this.getInstanceState().currentPageId}getPage(e){return this.store.get(typeof e=="string"?e:e.id)}getCurrentPageShapeIds(){return this._currentPageShapeIds.get()}getCurrentPageShapeIdsSorted(){return Array.from(this.getCurrentPageShapeIds()).sort()}getPageShapeIds(e){const n=typeof e=="string"?e:e.id,s=this.store.query.exec("shape",{parentId:{eq:n}});return this.getShapeAndDescendantIds(s.map(r=>r.id))}setCurrentPage(e){const n=typeof e=="string"?e:e.id;return this.store.has(n)?(this.stopFollowingUser(),this.complete(),this.run(()=>{this.store.put([{...this.getInstanceState(),currentPageId:n}]),this.setCamera(this.getCamera())},{history:"record-preserveRedoStack"})):(console.error("Tried to set the current page id to a page that doesn't exist."),this)}updatePage(e){return this.getIsReadonly()?this:this.getPage(e.id)?this.run(()=>this.store.update(e.id,s=>({...s,...e}))):this}createPage(e){return this.run(()=>{if(this.getIsReadonly()||this.getPages().length>=this.options.maxPages)return;const n=this.getPages(),s=kR(e.name??"Page 1",n.map(o=>o.name));let r=e.index;(!r||n.some(o=>o.index===r))&&(r=Ls(n[n.length-1].index));const i=zn.create({meta:{},...e,name:s,index:r});this.store.put([i])}),this}deletePage(e){const n=typeof e=="string"?e:e.id;return this.run(()=>{if(this.getIsReadonly())return;const s=this.getPages();if(s.length===1)return;const r=this.getPage(n);if(!r)return;if(n===this.getCurrentPageId()){const o=s.findIndex(c=>c.id===n),a=s[o-1]??s[o+1];this.setCurrentPage(a.id)}const i=this.getSortedChildIdsForParent(r.id);this.deleteShapes(i),this.store.remove([r.id])},{ignoreShapeLock:!0}),this}duplicatePage(e,n=zn.createId()){if(this.getPages().length>=this.options.maxPages)return this;const s=typeof e=="string"?e:e.id,r=this.getPage(s);if(!r)return this;const i={...this.getCamera()},o=this.getContentFromCurrentPage(this.getSortedChildIdsForParent(r.id));return this.run(()=>{const a=this.getPages(),c=Qo(r.index,a[a.indexOf(r)+1]?.index);if(this.createPage({name:r.name+" Copy",id:n,index:c}),this.setCurrentPage(n),this.setCamera(i),o)return this.putContentOntoCurrentPage(o)}),this}renamePage(e,n){const s=typeof e=="string"?e:e.id;return this.getIsReadonly()?this:(this.updatePage({id:s,name:n}),this)}_getAllAssetsQuery(){return this.store.query.records("asset")}getAssets(){return this._getAllAssetsQuery().get()}createAssets(e){return this.getIsReadonly()?this:e.length<=0?this:(this.run(()=>this.store.put(e),{history:"ignore"}),this)}updateAssets(e){return this.getIsReadonly()?this:e.length<=0?this:(this.run(()=>{this.store.put(e.map(n=>({...this.store.get(n.id),...n})))},{history:"ignore"}),this)}deleteAssets(e){if(this.getIsReadonly())return this;const n=typeof e[0]=="string"?e:e.map(s=>s.id);return n.length<=0?this:(this.run(()=>{this.store.props.assets.remove?.(n),this.store.remove(n)},{history:"ignore"}),this)}getAsset(e){return this.store.get(typeof e=="string"?e:e.id)}async resolveAssetUrl(e,n){if(!e)return null;const s=this.getAsset(e);if(!s)return null;const{screenScale:r=1,shouldResolveToOriginal:i=!1,dpr:o=this.getInstanceState().devicePixelRatio}=n,c=(u=>Math.pow(2,Math.ceil(Math.log2(u))))(r),l="connection"in navigator?navigator.connection.effectiveType:null;return await this.store.props.assets.resolve(s,{screenScale:r||1,steppedScreenScale:c,dpr:o,networkEffectiveType:l,shouldResolveToOriginal:i})}async uploadAsset(e,n,s){return await this.store.props.assets.upload(e,n,s)}getShapeGeometry(e,n){const s=n?.context??"none";return this._shapeGeometryCaches[s]||(this._shapeGeometryCaches[s]=this.store.createComputedCache("bounds",r=>(this.fonts.trackFontsForShape(r),this.getShapeUtil(r).getGeometry(r,n)),{areRecordsEqual:Mg})),this._shapeGeometryCaches[s].get(typeof e=="string"?e:e.id)}_getShapeHandlesCache(){return this.store.createComputedCache("handles",e=>this.getShapeUtil(e).getHandles?.(e),{areRecordsEqual:Mg})}getShapeHandles(e){return this._getShapeHandlesCache().get(typeof e=="string"?e:e.id)}getShapeLocalTransform(e){const n=typeof e=="string"?e:e.id,s=this.getShape(n);if(!s)throw Error("Editor.getTransform: shape not found");return q.Identity().translate(s.x,s.y).rotate(s.rotation)}_getShapePageTransformCache(){return this.store.createComputedCache("pageTransformCache",e=>{if(nn(e.parentId))return this.getShapeLocalTransform(e);const n=this._getShapePageTransformCache().get(e.parentId)??q.Identity();return q.Compose(n,this.getShapeLocalTransform(e))})}getShapeParentTransform(e){const n=typeof e=="string"?e:e.id,s=this.getShape(n);return!s||nn(s.parentId)?q.Identity():this._getShapePageTransformCache().get(s.parentId)??q.Identity()}getShapePageTransform(e){const n=typeof e=="string"?e:e.id;return this._getShapePageTransformCache().get(n)??q.Identity()}_getShapePageBoundsCache(){return this.store.createComputedCache("pageBoundsCache",e=>{const n=this.getShapePageTransform(e);if(n)return X.FromPoints(n.applyToPoints(this.getShapeGeometry(e).boundsVertices))})}getShapePageBounds(e){return this._getShapePageBoundsCache().get(typeof e=="string"?e:e.id)}_getShapeClipPathCache(){return this.store.createComputedCache("clipPathCache",e=>{const n=this._getShapeMaskCache().get(e.id);if(!n)return;if(n.length===0)return"polygon(0px 0px, 0px 0px, 0px 0px)";const s=this._getShapePageTransformCache().get(e.id);return s?`polygon(${q.applyToPoints(q.Inverse(s),n).map(i=>`${i.x}px ${i.y}px`).join(",")})`:void 0})}getShapeClipPath(e){return this._getShapeClipPathCache().get(typeof e=="string"?e:e.id)}_getShapeMaskCache(){return this.store.createComputedCache("pageMaskCache",e=>{if(nn(e.parentId))return;const n=[];for(const r of this.getShapeAncestors(e.id)){const i=this.getShapeUtil(r),o=i.getClipPath?.(r);if(!o||i.shouldClipChild?.(e)===!1)continue;const a=this.getShapePageTransform(r.id);n.push(a.applyToPoints(o))}return n.length===0?void 0:n.reduce((r,i)=>{const o=Dd(r,i);return o?o.map(b.Cast):[]})})}getShapeMask(e){return this._getShapeMaskCache().get(typeof e=="string"?e:e.id)}getShapeMaskedPageBounds(e){return typeof e!="string"&&(e=e.id),this._getShapeMaskedPageBoundsCache().get(e)}_getShapeMaskedPageBoundsCache(){return this.store.createComputedCache("shapeMaskedPageBoundsCache",e=>{const n=this._getShapePageBoundsCache().get(e.id);if(!n)return;const s=this._getShapeMaskCache().get(e.id);if(s){if(s.length===0)return;const{corners:r}=n;if(r.every((o,a)=>o&&b.Equals(o,s[a])))return n.clone();const i=Dd(s,r);return i?X.FromPoints(i):void 0}return n})}getShapeAncestors(e,n=[]){const s=typeof e=="string"?e:e.id,r=this.getShape(s);if(!r)return n;const i=r.parentId;if(nn(i))return n.reverse(),n;const o=this.store.get(i);return o?(n.push(o),this.getShapeAncestors(o,n)):n}findShapeAncestor(e,n){const s=typeof e=="string"?e:e.id,r=this.getShape(s);if(!r)return;const i=r.parentId;if(nn(i))return;const o=this.getShape(i);if(o)return n(o)?o:this.findShapeAncestor(o,n)}hasAncestor(e,n){const s=typeof e=="string"?e:e?.id,r=s&&this.getShape(s);return r?r.parentId===n?!0:this.hasAncestor(this.getShapeParent(r),n):!1}findCommonAncestor(e,n){if(e.length===0)return;const s=typeof e[0]=="string"?e:e.map(c=>c.id),r=ve(s.map(c=>this.getShape(c)));if(r.length===1){const c=r[0].parentId;return nn(c)?void 0:n?this.findShapeAncestor(r[0],n)?.id:c}const[i,...o]=r;let a=this.getShapeParent(i);for(;a;){if(n&&!n(a)){a=this.getShapeParent(a);continue}if(o.every(c=>this.hasAncestor(c,a.id)))return a.id;a=this.getShapeParent(a)}}isShapeOrAncestorLocked(e){const n=e&&this.getShape(e);return n===void 0?!1:n.isLocked?!0:this.isShapeOrAncestorLocked(this.getShapeParent(n))}getNotVisibleShapes(){return this._notVisibleShapes.get()}getCulledShapes(){const e=this.getNotVisibleShapes(),n=this.getSelectedShapeIds(),s=this.getEditingShapeId(),r=new Set(e);return s&&r.delete(s),n.forEach(i=>{r.delete(i)}),r}getCurrentPageBounds(){let e;return this.getCurrentPageShapeIdsSorted().forEach(n=>{const s=this.getShapeMaskedPageBounds(n);s&&(e?e=e.expand(s):e=s.clone())}),e}getSelectedShapeAtPoint(e){const n=this.getSelectedShapeIds();return this.getCurrentPageShapesSorted().filter(s=>s.type!=="group"&&n.includes(s.id)).reverse().find(s=>this.isPointInShape(s,e,{hitInside:!0,margin:0}))}getShapeAtPoint(e,n={}){const s=this.getZoomLevel(),r=this.getViewportPageBounds(),{filter:i,margin:o=0,hitLocked:a=!1,hitLabels:c=!1,hitInside:l=!1,hitFrameInside:u=!1}=n,[d,p]=Array.isArray(o)?o:[o,o];let f=1/0,g=null,x=1/0,y=null;const m=(n.renderingOnly?this.getCurrentPageRenderingShapesSorted():this.getCurrentPageShapesSorted()).filter(S=>{if(S.isLocked&&!a||this.isShapeHidden(S)||this.isShapeOfType(S,"group"))return!1;const w=this.getShapeMask(S);return!(w&&!Bn(e,w)||i&&!i(S))});for(let S=m.length-1;S>=0;S--){const w=m[S],P=this.getShapeGeometry(w),_=P instanceof os,I=this.getPointInShapeSpace(w,e);if(this.isShapeOfType(w,"frame")||(this.isShapeOfType(w,"note")||this.isShapeOfType(w,"arrow")||this.isShapeOfType(w,"geo")&&w.props.fill==="none")&&this.getShapeUtil(w).getText(w)?.trim()){for(const E of P.children)if(E.isLabel&&E.isPointInBounds(I))return w}if(this.isShapeOfType(w,"frame")){const E=P.distanceToPoint(I,u);if(u?E>0&&E<=p||E<=0&&E>-d:E>0&&E<=p)return y||w;if(P.hitTestPoint(I,0,!0))return y||g||(u?w:void 0);continue}let C;if(_){let E=1/0;for(const O of P.children){if(O.isLabel&&!c)continue;const k=O.distanceToPoint(I,l);k<E&&(E=k)}C=E}else p===0&&(P.bounds.w<1||P.bounds.h<1)||P.bounds.containsPoint(I,p)?C=P.distanceToPoint(I,l):C=1/0;if(P.isClosed){if(C<=p||l&&C<=0&&C>-d){if(P.isFilled||_&&P.children[0].isFilled)return y||w;if(this.getShapePageBounds(w).contains(r))continue;if(l?C>0&&C<=p||C<=0&&C>-d:Math.abs(C)<=Math.max(d,p))Math.abs(C)<x&&(x=Math.abs(C),y=w);else if(!y){const{area:E}=P;E<f&&(f=E,g=w)}}}else if(C<this.options.hitTestMargin/s)return w}return y||g||void 0}getShapesAtPoint(e,n={}){return this.getCurrentPageShapesSorted().filter(s=>!this.isShapeHidden(s)&&this.isPointInShape(s,e,n)).reverse()}isPointInShape(e,n,s={}){const{hitInside:r=!1,margin:i=0}=s,o=typeof e=="string"?e:e.id,a=this.getShapeMask(o);return a&&!Bn(n,a)?!1:this.getShapeGeometry(o).hitTestPoint(this.getPointInShapeSpace(e,n),i,r)}getPointInShapeSpace(e,n){const s=typeof e=="string"?e:e.id;return this._getShapePageTransformCache().get(s).clone().invert().applyToPoint(n)}getPointInParentSpace(e,n){const s=typeof e=="string"?e:e.id,r=this.getShape(s);if(!r)return new b(0,0);if(nn(r.parentId))return b.From(n);const i=this.getShapePageTransform(r.parentId);return i?i.clone().invert().applyToPoint(n):b.From(n)}getCurrentPageShapes(){return Array.from(this.getCurrentPageShapeIds(),e=>this.store.get(e))}getCurrentPageShapesSorted(){const e=[],n=this.getSortedChildIdsForParent(this.getCurrentPageId());for(let s=0,r=n.length;s<r;s++)aT(this,n[s],e);return e}getCurrentPageRenderingShapesSorted(){const e=this.getCulledShapes();return this.getCurrentPageShapesSorted().filter(({id:n})=>!e.has(n)&&!this.isShapeHidden(n))}isShapeOfType(e,n){const s=typeof e=="string"?this.getShape(e):e;return s?s.type===n:!1}getShape(e){const n=typeof e=="string"?e:e.id;if(On(n))return this.store.get(n)}getShapeParent(e){const n=typeof e=="string"?e:e?.id;if(!n)return;const s=this.getShape(n);if(!(s===void 0||!On(s.parentId)))return this.getShape(s.parentId)}getShapeNearestSibling(e,n){return n?n.parentId===e.parentId?n:this.findShapeAncestor(n,r=>r.parentId===e.parentId):void 0}isShapeInPage(e,n=this.getCurrentPageId()){const s=typeof e=="string"?e:e.id,r=this.getShape(s);if(!r)return!1;let i=!1;if(r.parentId===n)i=!0;else{let o=this.getShape(r.parentId);e:for(;o;){if(o.parentId===n){i=!0;break e}o=this.getShape(o.parentId)}}return i}getAncestorPageId(e){const n=typeof e=="string"?e:e?.id,s=n&&this.getShape(n);if(s)return nn(s.parentId)?s.parentId:this.getAncestorPageId(this.getShape(s.parentId))}reparentShapes(e,n,s){const r=typeof e[0]=="string"?e:e.map(p=>p.id);if(r.length===0)return this;const i=[],o=nn(n)?q.Identity():this.getShapePageTransform(n),a=o.rotation();let c=[];const l=ve(this.getSortedChildIdsForParent(n).map(p=>this.getShape(p)));if(s){const p=l.find(f=>f.index===s);if(p){const f=l[l.indexOf(p)+1];f?c=Ji(s,f.index,r.length):c=vh(s,r.length)}else{const f=l.sort(Yt).find(g=>g.index>s);f?c=Ji(s,f.index,r.length):c=vh(s,r.length)}}else{const p=l.length&&l[l.length-1];c=p?vh(p.index,r.length):bc(r.length)}const u=o.clone().invert(),d=ve(r.map(p=>this.getShape(p))).sort(Yt);return this.run(()=>{for(let p=0;p<d.length;p++){const f=d[p],g=this.getShapePageTransform(f);if(!g)continue;const x=g.point();if(!x)continue;const y=u.applyToPoint(x),m=g.rotation()-a;if(f.id===n)throw Error("Attempted to reparent a shape to itself!");i.push({id:f.id,type:f.type,parentId:n,x:y.x,y:y.y,rotation:m,index:c[p]})}this.updateShapes(i)},{ignoreShapeLock:!0}),this}getHighestIndexForParent(e){const n=typeof e=="string"?e:e.id,s=this._parentIdsToChildIds.get()[n];if(!s||s.length===0)return Ls(fm);const r=this.getShape(s[s.length-1]);return Ls(r.index)}getSortedChildIdsForParent(e){const n=typeof e=="string"?e:e.id,s=this._parentIdsToChildIds.get()[n];return s||Ct}visitDescendants(e,n){const s=this.getSortedChildIdsForParent(e);for(const r of s)n(r)!==!1&&this.visitDescendants(r,n);return this}getShapeAndDescendantIds(e){const n=new Set;for(const s of e.map(r=>this.getShape(r)).sort(Yt))n.add(s.id),this.visitDescendants(s,r=>{n.add(r)});return n}getDraggingOverShape(e,n){const s=ve(n.map(i=>this.getShape(i))).filter(i=>!i.isLocked&&!this.isShapeHidden(i)),r=this.getShapesAtPoint(e,{hitInside:!0,margin:0}).filter(i=>!n.includes(i)&&!i.isLocked&&!this.isShapeHidden(i)&&!s.includes(i));for(const i of r){const o=this.getShapeUtil(i);if(o.onDragShapesOver||o.onDragShapesIn||o.onDragShapesOut||o.onDropShapesOver)return i}}getOutermostSelectableShape(e,n){const s=typeof e=="string"?e:e.id,r=this.getShape(s);let i=r,o=r;const a=this.getFocusedGroup();for(;o;){if(this.isShapeOfType(o,"group")&&a?.id!==o.id&&!this.hasAncestor(a,o.id)&&(n?.(o)??!0))i=o;else if(a?.id===o.id)break;o=this.getShapeParent(o)}return i}_getBindingsIndexCache(){const e=OR(this);return this.store.createComputedCache("bindingsIndex",n=>e.get().get(n.id),{areRecordsEqual:()=>!0})}getBinding(e){return this.store.get(e)}getBindingsFromShape(e,n){const s=typeof e=="string"?e:e.id;return this.getBindingsInvolvingShape(s).filter(r=>r.fromId===s&&r.type===n)}getBindingsToShape(e,n){const s=typeof e=="string"?e:e.id;return this.getBindingsInvolvingShape(s).filter(r=>r.toId===s&&r.type===n)}getBindingsInvolvingShape(e,n){const s=typeof e=="string"?e:e.id,r=this._getBindingsIndexCache().get(s)??Ct;return n?r.filter(i=>i.type===n):r}createBindings(e){const n=[];for(const s of e){const r=this.getShape(s.fromId),i=this.getShape(s.toId);if(!r||!i||!this.canBindShapes({fromShape:r,toShape:i,binding:s}))continue;const a=this.getBindingUtil(s.type).getDefaultProps(),c=this.store.schema.types.binding.create({...s,id:s.id??Zi(),props:{...a,...s.props}});n.push(c)}return this.store.put(n),this}createBinding(e){return this.createBindings([e])}updateBindings(e){const n=[];for(const s of e){if(!s)continue;const r=this.getBinding(s.id);if(!r)continue;const i=dr(r,s);if(i===r)continue;const o=this.getShape(i.fromId),a=this.getShape(i.toId);!o||!a||this.canBindShapes({fromShape:o,toShape:a,binding:i})&&n.push(i)}return this.store.put(n),this}updateBinding(e){return this.updateBindings([e])}deleteBindings(e,{isolateShapes:n=!1}={}){const s=e.map(r=>typeof r=="string"?r:r.id);return n?this.store.atomic(()=>{for(const r of s){const i=this.getBinding(r);if(!i)continue;const o=this.getBindingUtil(i);o.onBeforeIsolateFromShape?.({binding:i,removedShape:this.getShape(i.toId)}),o.onBeforeIsolateToShape?.({binding:i,removedShape:this.getShape(i.fromId)}),this.store.remove([r])}}):this.store.remove(s),this}deleteBinding(e,n){return this.deleteBindings([e],n)}canBindShapes({fromShape:e,toShape:n,binding:s}){const r=typeof e=="string"?e:e.type,i=typeof n=="string"?n:n.type,o=typeof s=="string"?s:s.type,a={fromShapeType:r,toShapeType:i,bindingType:o};return r===i?this.getShapeUtil(r).canBind(a):this.getShapeUtil(r).canBind(a)&&this.getShapeUtil(i).canBind(a)}rotateShapesBy(e,n,s){const r=typeof e[0]=="string"?e:e.map(o=>o.id);if(r.length<=0)return this;const i=PI({editor:this,ids:r});return i?(ad({delta:n,snapshot:i,editor:this,stage:"one-off",centerOverride:s?.center}),this):this}getChangesToTranslateShape(e,n){let s=e;const r=this.getShapeUtil(e),i=r.onTranslateStart?.(s);i&&(s=dr(s,i)),s=dr(s,{id:e.id,type:e.type,x:n.x,y:n.y});const o=r.onTranslate?.(e,s);o&&(s=dr(s,o));const a=r.onTranslateEnd?.(e,s);return a&&(s=dr(s,a)),s}nudgeShapes(e,n){const s=typeof e[0]=="string"?e:e.map(i=>i.id);if(s.length<=0)return this;const r=[];for(const i of s){const o=this.getShape(i),a=b.From(n),c=this.getShapeParentTransform(o);c&&a.rot(-c.rotation()),r.push(this.getChangesToTranslateShape(o,a.add(o)))}return this.updateShapes(r),this}duplicateShapes(e,n){return this.run(()=>{const s=typeof e[0]=="string"?e:e.map(p=>p.id),r=this._shouldIgnoreShapeLock?s:this._getUnlockedShapeIds(s);if(r.length<=0)return this;const i=new Set(r),o=this.getShapeAndDescendantIds(r),a=[...o].reverse(),c=new Map;for(const p of o)c.set(p,tt());const{shapesToCreateWithOriginals:l,bindingsToCreate:u}=Fw(this,o,p=>{const f=[];for(const x of p){const y=this.getBinding(x);if(!y)continue;const m=Zi();f.push({...y,id:m,fromId:Gt(c.get(y.fromId)),toId:Gt(c.get(y.toId))})}const g=[];for(const x of a){const y=Gt(c.get(x)),m=this.getShape(x);if(!m)continue;let S=0,w=0;if(n&&i.has(x)){const P=this.getShapeParentTransform(m),_=new b(n.x,n.y).rot(-P.rotation());S=_.x,w=_.y}g.push({shape:{...m,id:y,x:m.x+S,y:m.y+w,index:"a1",parentId:c.get(m.parentId)??m.parentId},originalShape:m})}return{shapesToCreateWithOriginals:g,bindingsToCreate:f}});l.forEach(({shape:p,originalShape:f})=>{const g=f.parentId,x=this.getSortedChildIdsForParent(g),y=x.indexOf(f.id),m=x[y+1],S=m?this.getShape(m):void 0,w=Qo(f.index,S?.index);p.index=w});const d=l.map(({shape:p})=>p);if(!this.canCreateShapes(d)){Ll(this);return}if(this.createShapes(d),this.createBindings(u),this.setSelectedShapes(ve(r.map(p=>{const f=c.get(p);return!f||!this.getShape(f)?null:f}))),n!==void 0){const p=this.getSelectionPageBounds(),f=this.getViewportPageBounds();p&&!f.contains(p)&&this.centerOnPoint(p.center,{animation:{duration:this.options.animationMediumMs}})}}),this}moveShapesToPage(e,n){const s=typeof e[0]=="string"?e:e.map(a=>a.id);if(s.length===0)return this;if(this.getIsReadonly())return this;const r=this.getCurrentPageId();if(n===r)return this;if(!this.store.has(n))return this;const i=this.getContentFromCurrentPage(s);if(!i)return this;if(this.getPageShapeIds(n).size+i.shapes.length>this.options.maxShapesPerPage)return Ll(this,n),this;const o=this.getCamera().z;return this.run(()=>{this.deleteShapes(s),this.setCurrentPage(n),this.setFocusedGroup(null),this.selectNone(),this.putContentOntoCurrentPage(i,{select:!0,preserveIds:!0,preservePosition:!0}),this.setCamera({...this.getCamera(),z:o}),this.centerOnPoint(this.getSelectionRotatedPageBounds().center)}),this}toggleLock(e){const n=typeof e[0]=="string"?e:e.map(o=>o.id);if(this.getIsReadonly()||n.length===0)return this;let s=!0,r=!0;const i=[];for(const o of n){const a=this.getShape(o);a&&(i.push(a),a.isLocked?r=!1:s=!1)}return this.run(()=>{r?(this.updateShapes(i.map(o=>({id:o.id,type:o.type,isLocked:!0}))),this.setSelectedShapes([])):s?this.updateShapes(i.map(o=>({id:o.id,type:o.type,isLocked:!1}))):this.updateShapes(i.map(o=>({id:o.id,type:o.type,isLocked:!0})))}),this}sendToBack(e){const n=typeof e[0]=="string"?e:e.map(r=>r.id),s=Ol(this,"toBack",n,{considerAllShapes:!0});return s&&this.updateShapes(s),this}sendBackward(e,n={}){const s=typeof e[0]=="string"?e:e.map(i=>i.id),r=Ol(this,"backward",s,n);return r&&this.updateShapes(r),this}bringForward(e,n={}){const s=typeof e[0]=="string"?e:e.map(i=>i.id),r=Ol(this,"forward",s,n);return r&&this.updateShapes(r),this}bringToFront(e){const n=typeof e[0]=="string"?e:e.map(r=>r.id),s=Ol(this,"toFront",n);return s&&this.updateShapes(s),this}collectShapesViaArrowBindings(e){const{initialShapes:n,resultShapes:s,resultBounds:r,bindings:i,visited:o}=e;for(const a of i)for(const c of[a.fromId,a.toId])if(!o.has(c)){const l=n.find(u=>u.id===c);if(l&&!o.has(l.id)){o.add(l.id);const u=this.getShapePageBounds(l);if(!u)continue;s.push(l),r.push(u),this.collectShapesViaArrowBindings({...e,bindings:this.getBindingsInvolvingShape(l,"arrow")})}}}flipShapes(e,n){if(this.getIsReadonly())return this;const s=typeof e[0]=="string"?e:e.map(c=>c.id),r=ve(s.map(c=>this.getShape(c)));for(const c of r)if(this.isShapeOfType(c,"group")){const l=ve(this.getSortedChildIdsForParent(c.id).map(u=>this.getShape(u)));r.push(...l)}const i=[],o=[];for(const c of r){const l=this.getShapeUtil(c);if(!l.canBeLaidOut(c,{type:"flip",shapes:r}))continue;const u=this.getShapePageBounds(c),d=this.getShapeGeometry(c).bounds,p=this.getShapePageTransform(c.id);u&&d&&p&&(i.push({shape:c,localBounds:d,pageTransform:p,isAspectRatioLocked:l.isAspectRatioLocked(c)}),o.push(u))}if(!i.length)return this;const a=X.Common(o).center;return this.run(()=>{for(const{shape:c,localBounds:l,pageTransform:u,isAspectRatioLocked:d}of i)this.resizeShape(c.id,{x:n==="horizontal"?-1:1,y:n==="vertical"?-1:1},{initialBounds:l,initialPageTransform:u,initialShape:c,isAspectRatioLocked:d,mode:"scale_shape",scaleOrigin:a,scaleAxisRotation:0})}),this}stackShapes(e,n,s){const r=s??this.options.adjacentShapeMargin,i=typeof e[0]=="string"?e:e.map(m=>m.id);if(this.getIsReadonly())return this;const o=ve(i.map(m=>this.getShape(m))),a=[],c=new Set;for(const m of o){if(c.has(m.id))continue;c.add(m.id);const S=this.getShapePageBounds(m);if(!S||!this.getShapeUtil(m).canBeLaidOut?.(m,{type:"stack",shapes:o}))continue;const w=[m],P=[S];this.collectShapesViaArrowBindings({bindings:this.getBindingsToShape(m.id,"arrow"),initialShapes:o,resultShapes:w,resultBounds:P,visited:c});const _=X.Common(P);_&&a.push({shapes:w,pageBounds:_})}const l=a.length;if(r===0&&l<3||l<2)return this;let u,d,p,f;n==="horizontal"?(u="x",d="minX",p="maxX",f="width"):(u="y",d="minY",p="maxY",f="height");let g=0;if(r===0){const m={};a.sort((w,P)=>w.pageBounds[d]-P.pageBounds[d]);for(let w=0;w<l-1;w++){const P=a[w],I=a[w+1].pageBounds[d]-P.pageBounds[p];m[I]||(m[I]=0),m[I]++}let S=1;for(const[w,P]of Object.entries(m))P>S&&(S=P,g=parseFloat(w));if(S===1){let w=0;for(const[P,_]of Object.entries(m))g+=parseFloat(P)*_,w+=_;g/=w}}else g=r;const x=[];let y=a[0].pageBounds[p];for(let m=1;m<a.length;m++){const{shapes:S,pageBounds:w}=a[m],P=new b;P[u]=y+g-w[u];for(const _ of S){const I=P.clone(),C=this.getShapeParent(_);if(C){const E=this.getShapePageTransform(C);E&&I.rot(-E.rotation())}I.add(_),x.push(this.getChangesToTranslateShape(_,I))}y+=w[f]+g}return this.updateShapes(x),this}packShapes(e,n){if(this.getIsReadonly())return this;const s=n??this.options.adjacentShapeMargin,r=typeof e[0]=="string"?e:e.map(_=>_.id),i=ve(r.map(_=>this.getShape(_))),o=[],a=[],c=new Set;for(const _ of i){if(c.has(_.id))continue;c.add(_.id);const I=this.getShapePageBounds(_);if(!I||!this.getShapeUtil(_).canBeLaidOut?.(_,{type:"pack",shapes:i}))continue;const C=[_],E=[I];this.collectShapesViaArrowBindings({bindings:this.getBindingsToShape(_.id,"arrow"),initialShapes:i,resultShapes:C,resultBounds:E,visited:c});const O=X.Common(E);O&&(o.push({shapes:C,pageBounds:O,nextPageBounds:O.clone()}),a.push(O))}if(o.length<2)return this;let l=0;for(const{pageBounds:_}of o)l+=_.width*_.height;const u=X.Common(a),d=u.width;o.sort((_,I)=>_.pageBounds.width-I.pageBounds.width).sort((_,I)=>_.pageBounds.height-I.pageBounds.height);const p=Math.max(Math.ceil(Math.sqrt(l/.95)),d),f=[new X(u.x,u.y,p,1/0)];let g=0,x=0,y,m;for(const{nextPageBounds:_}of o)for(let I=f.length-1;I>=0;I--)if(y=f[I],!(_.width>y.width||_.height>y.height)){_.x=y.x,_.y=y.y,x=Math.max(x,_.maxY),g=Math.max(g,_.maxX),_.width===y.width&&_.height===y.height?(m=f.pop(),I<f.length&&(f[I]=m)):_.height===y.height?(y.x+=_.width+s,y.width-=_.width+s):_.width===y.width?(y.y+=_.height+s,y.height-=_.height+s):(f.push(new X(y.x+(_.width+s),y.y,y.width-(_.width+s),_.height)),y.y+=_.height+s,y.height-=_.height+s);break}const S=X.Common(o.map(_=>_.nextPageBounds)),w=b.Sub(u.center,S.center),P=[];for(const{shapes:_,pageBounds:I,nextPageBounds:C}of o){const E=b.Sub(C.point,I.point).add(w);for(const O of _){const k=E.clone();if(this.getShapeParent(O)){const D=this.getShapeParentTransform(O);D&&k.rot(-D.rotation())}k.add(O),P.push(this.getChangesToTranslateShape(O,k))}}return P.length&&this.updateShapes(P),this}alignShapes(e,n){if(this.getIsReadonly())return this;const s=typeof e[0]=="string"?e:e.map(u=>u.id),r=ve(s.map(u=>this.getShape(u))),i=[],o=[],a=new Set;for(const u of r){if(a.has(u.id))continue;a.add(u.id);const d=this.getShapePageBounds(u);if(!d||!this.getShapeUtil(u).canBeLaidOut?.(u,{type:"align",shapes:r}))continue;const p=[u],f=[d];this.collectShapesViaArrowBindings({bindings:this.getBindingsToShape(u.id,"arrow"),initialShapes:r,resultShapes:p,resultBounds:f,visited:a});const g=X.Common(f);g&&(i.push({shapes:p,pageBounds:g}),o.push(g))}if(i.length<2)return this;const c=X.Common(o),l=[];return i.forEach(({shapes:u,pageBounds:d})=>{const p=new b;switch(n){case"top":{p.y=c.minY-d.minY;break}case"center-vertical":{p.y=c.midY-d.minY-d.height/2;break}case"bottom":{p.y=c.maxY-d.minY-d.height;break}case"left":{p.x=c.minX-d.minX;break}case"center-horizontal":{p.x=c.midX-d.minX-d.width/2;break}case"right":{p.x=c.maxX-d.minX-d.width;break}}for(const f of u){const g=p.clone(),x=this.getShapeParent(f);if(x){const y=this.getShapePageTransform(x);y&&g.rot(-y.rotation())}g.add(f),l.push(this.getChangesToTranslateShape(f,g))}}),this.updateShapes(l),this}distributeShapes(e,n){if(this.getIsReadonly())return this;const s=typeof e[0]=="string"?e:e.map(w=>w.id),r=ve(s.map(w=>this.getShape(w))),i=[],o=new Set;for(const w of r){if(o.has(w.id))continue;o.add(w.id);const P=this.getShapePageBounds(w);if(!P||!this.getShapeUtil(w).canBeLaidOut?.(w,{type:"distribute",shapes:r}))continue;const _=[w],I=[P];this.collectShapesViaArrowBindings({bindings:this.getBindingsToShape(w.id,"arrow"),initialShapes:r,resultShapes:_,resultBounds:I,visited:o});const C=X.Common(I);C&&i.push({shapes:_,pageBounds:C})}if(i.length<3)return this;let a,c,l,u;n==="horizontal"?(a="x",c="minX",l="maxX",u="width"):(a="y",c="minY",l="maxY",u="height");const d=[],p=i.sort((w,P)=>w.pageBounds[c]-P.pageBounds[c])[0],f=i.sort((w,P)=>P.pageBounds[l]-w.pageBounds[l])[0];if(p===f){const w=new Set(p.shapes.map(P=>P.id));return this.distributeShapes(s.filter(P=>!w.has(P)),n)}const g=i.filter(w=>w!==p&&w!==f).sort((w,P)=>w.pageBounds[c]===P.pageBounds[c]?w.shapes[0].id<P.shapes[0].id?-1:1:w.pageBounds[c]-P.pageBounds[c]),x=p.pageBounds[l],y=f.pageBounds[c]-x,m=g.reduce((w,P)=>w+P.pageBounds[u],0),S=(y-m)/(g.length+1);for(let w=x+S,P=0;P<g.length;P++){const{shapes:_,pageBounds:I}=g[P],C=new b;C[a]=w-I[a],w+I[u]>f.pageBounds[l]-1&&(C[a]=f.pageBounds[l]-I[l]-1);for(const E of _){const O=C.clone(),k=this.getShapeParent(E);if(k){const T=this.getShapePageTransform(k);T&&O.rot(-T.rotation())}O.add(E),d.push(this.getChangesToTranslateShape(E,O))}w+=I[u]+S}return this.updateShapes(d),this}stretchShapes(e,n){const s=typeof e[0]=="string"?e:e.map(p=>p.id);if(this.getIsReadonly())return this;const r=ve(s.map(p=>this.getShape(p))).filter(p=>this.getShapePageTransform(p)?.rotation()%(Ve/2)===0),i=[],o=[],a=new Set;for(const p of r){if(a.has(p.id))continue;a.add(p.id);const f=this.getShapePageBounds(p);if(!f)continue;const g=[p],x=[f];if(!this.getShapeUtil(p).canBeLaidOut?.(p,{type:"stretch"}))continue;this.collectShapesViaArrowBindings({bindings:this.getBindingsToShape(p.id,"arrow"),initialShapes:r,resultShapes:g,resultBounds:x,visited:a});const y=X.Common(x);y&&(i.push({shapes:g,pageBounds:y}),o.push(y))}if(i.length<2)return this;const c=X.Common(o);let l,u,d;return n==="horizontal"?(l="x",u="minX",d="width"):(l="y",u="minY",d="height"),this.run(()=>{i.forEach(({shapes:p,pageBounds:f})=>{const g=new b;g[l]=c[u]-f[u];const x=f.center.clone();x[l]=c[u];const y=new b(1,1);y[l]=c[d]/f[d];for(const m of p){const S=g.clone(),w=this.getShapeParentTransform(m);w&&g.rot(-w.rotation()),S.add(m);const P=this.getChangesToTranslateShape(m,S);this.updateShape(P),this.resizeShape(m.id,y,{initialBounds:this.getShapeGeometry(m).bounds,scaleOrigin:x,isAspectRatioLocked:this.getShapeUtil(m).isAspectRatioLocked(m),scaleAxisRotation:0})}})}),this}resizeShape(e,n,s={}){const r=typeof e=="string"?e:e.id;if(this.getIsReadonly())return this;Number.isFinite(n.x)||(n=new b(1,n.y)),Number.isFinite(n.y)||(n=new b(n.x,1));const i=s.initialShape??this.getShape(r);if(!i)return this;const o=s.scaleOrigin??this.getShapePageBounds(r)?.center;if(!o)return this;const a=s.initialPageTransform?q.Cast(s.initialPageTransform):this.getShapePageTransform(r);if(!a)return this;const c=a.rotation();if(c==null)return this;const l=s.scaleAxisRotation??c,u=s.initialBounds??this.getShapeGeometry(r).bounds;if(!u)return this;const d=s.isAspectRatioLocked??this.getShapeUtil(i).isAspectRatioLocked(i);if(!bP(c,l))return this._resizeUnalignedShape(r,n,{...s,initialBounds:u,scaleOrigin:o,scaleAxisRotation:l,initialPageTransform:a,isAspectRatioLocked:d,initialShape:i});const p=this.getShapeUtil(i);d&&(Math.abs(n.x)>Math.abs(n.y)?n=new b(n.x,Math.sign(n.y)*Math.abs(n.x)):n=new b(Math.sign(n.x)*Math.abs(n.y),n.y));let f=!1;if(p.onResize&&p.canResize(i)){const g=this._scalePagePoint(q.applyToPoint(a,new b(0,0)),o,n,l),x=this.getPointInParentSpace(i.id,g),y=new b(n.x,n.y),m=Dt((c-l)%Math.PI,0);y.x=m?n.x:n.y,y.y=m?n.y:n.x;const S=q.applyToPoint(a,new b),{x:w,y:P}=this.getPointInParentSpace(i.id,S);let _=i;s.skipStartAndEndCallbacks||(_=dr(i,p.onResizeStart?.(i)??void 0));const I=p.onResize({...i,x:w,y:P},{newPoint:x,handle:s.dragHandle??"bottom_right",mode:s.mode??"scale_shape",scaleX:y.x,scaleY:y.y,initialBounds:u,initialShape:i});I&&(f=!0),_=dr(_,{id:r,type:i.type,x:x.x,y:x.y,...I}),s.skipStartAndEndCallbacks||(_=dr(_,p.onResizeEnd?.(i,_)??void 0)),this.updateShapes([_])}if(!f){const g=q.applyToPoint(a,u.center),x=this._scalePagePoint(g,o,n,l),y=this.getPointInParentSpace(i.id,g),m=this.getPointInParentSpace(i.id,x),S=b.Sub(m,y);this.updateShapes([{id:r,type:i.type,x:i.x+S.x,y:i.y+S.y}])}return this}_scalePagePoint(e,n,s,r){const i=b.RotWith(e,n,-r).sub(n),o=b.MulV(i,s);return b.Add(o,n).rotWith(n,r)}_resizeUnalignedShape(e,n,s){const{type:r}=s.initialShape,i=new b(n.x,n.y);if(Math.abs(n.x)>Math.abs(n.y)?i.x=Math.sign(n.x)*Math.abs(n.y):i.y=Math.sign(n.y)*Math.abs(n.x),this.resizeShape(e,i,{initialShape:s.initialShape,initialBounds:s.initialBounds,isAspectRatioLocked:s.isAspectRatioLocked}),Math.sign(n.x)*Math.sign(n.y)<0){const y=this.getShapeParentTransform(e).rotation(),m=-s.initialShape.rotation-2*y;this.updateShapes([{id:e,type:r,rotation:m}])}const o=q.applyToPoint(s.initialPageTransform,s.initialBounds.center),a=this._scalePagePoint(o,s.scaleOrigin,n,s.scaleAxisRotation),c=this.getShapePageTransform(e),l=this.getShapeGeometry(e).bounds,u=q.applyToPoint(c,l.center),d=c.point();if(!u||!d)return this;const p=b.Sub(a,u),f=b.Add(d,p),{x:g,y:x}=this.getPointInParentSpace(e,f);return this.updateShapes([{id:e,type:r,x:g,y:x}]),this}getInitialMetaForShape(e){return{}}canCreateShape(e){return this.canCreateShapes([e])}canCreateShapes(e){return e.length+this.getCurrentPageShapeIds().size<=this.options.maxShapesPerPage}createShape(e){return this.createShapes([e]),this}createShapes(e){if(!Array.isArray(e))throw Error("Editor.createShapes: must provide an array of shapes or shape partials");if(this.getIsReadonly())return this;if(e.length<=0)return this;const n=this.getCurrentPageShapeIds();if(e.length+n.size>this.options.maxShapesPerPage)return Ll(this),this;const r=this.getFocusedGroupId();return this.run(()=>{const i=this.getCurrentPageShapesSorted(),o=e.map(u=>{if(u.id||(u={id:tt(),...u}),!u.parentId||!(this.store.has(u.parentId)||e.some(d=>d.id===u.parentId))){let d=this.getFocusedGroupId();if(u.x!==void 0&&u.y!==void 0)for(let g=i.length-1;g>=0;g--){const x=i[g];if(this.getShapeUtil(x).canReceiveNewChildrenOfType(x,u.type)&&!this.isShapeHidden(x)&&this.isPointInShape(x,{x:u.x??0,y:u.y??0},{margin:0,hitInside:!0})){d=x.id;break}}const f=u.parentId;if(d===u.id&&(d=r),d!==f&&(u={...u},u.parentId=d,On(d))){const g=this.getPointInShapeSpace(this.getShape(d),{x:u.x??0,y:u.y??0});u.x=g.x,u.y=g.y,u.rotation=-this.getShapePageTransform(d).rotation()+(u.rotation??0)}}return u}),a=new Map,c=[],{opacityForNextShape:l}=this.getInstanceState();for(const u of o){const d=this.getShapeUtil(u);let p=u.index;if(!p){const y=u.parentId??r;a.has(y)||a.set(y,this.getHighestIndexForParent(y)),p=a.get(y),a.set(y,Ls(p))}const f=d.getDefaultProps();for(const[y,m]of this.styleProps[u.type])f[m]=this.getStyleForNextShape(y);let g=this.store.schema.types.shape.create({...u,index:p,opacity:u.opacity??l,parentId:u.parentId??r,props:"props"in u?{...f,...u.props}:f});if(g.index===void 0)throw Error("no index!");const x=this.getShapeUtil(g).onBeforeCreate?.(g);x&&(g=x),c.push(g)}c.forEach(u=>{u.meta={...this.getInitialMetaForShape(u),...u.meta}}),this.emit("created-shapes",c),this.emit("edit"),this.store.put(c)}),this}animateShape(e,n={animation:Lf}){return this.animateShapes([e],n)}animateShapes(e,n={animation:Lf}){if(!n.animation)return this;const{duration:s=500,easing:r=Pn.linear}=n.animation,i=Ge();let o=s,a;const c=[];let l,u;for(let p=0,f=e.length;p<f;p++){if(l=e[p],!l)continue;const g=this.getShape(l.id);g&&(u={start:wt(g),end:dr(wt(g),l)},c.push(u),this.animatingShapes.set(g.id,i))}const d=p=>{if(o-=p,o<0){const{animatingShapes:y}=this,m=e.filter(S=>S&&y.get(S.id)===i);m.length&&this.updateShapes(m),this.off("tick",d);return}a=r(1-o/s);const{animatingShapes:f}=this,g=[];let x;for(let y=0,m=c.length;y<m;y++){const{start:S,end:w}=c[y];x=f.get(S.id),x===i&&g.push({...w,x:S.x+(w.x-S.x)*a,y:S.y+(w.y-S.y)*a,opacity:S.opacity+(w.opacity-S.opacity)*a,rotation:S.rotation+(w.rotation-S.rotation)*a,props:this.getShapeUtil(w).getInterpolatedProps?.(S,w,a)??w.props})}this._updateShapes(g)};return this.on("tick",d),this}groupShapes(e,n={}){const{groupId:s=tt(),select:r=!0}=n;if(!Array.isArray(e))throw Error("Editor.groupShapes: must provide an array of shapes or shape ids");if(this.getIsReadonly())return this;const i=typeof e[0]=="string"?e:e.map(x=>x.id);if(i.length<=1)return this;const o=ve((this._shouldIgnoreShapeLock?i:this._getUnlockedShapeIds(i)).map(x=>this.getShape(x))),a=o.sort(Yt).map(x=>x.id),c=ve(o.map(x=>this.getShapePageBounds(x))),l=X.Common(c);if(!l.isValid())throw Error("Editor.groupShapes: group bounds are invalid (NaN).");const{x:u,y:d}=l.point,p=this.findCommonAncestor(o)??this.getCurrentPageId();if(this.getCurrentToolId()!=="select")return this;this.isIn("select.idle")||this.cancel();const f=o.filter(x=>x.parentId===p).sort(Yt),g=f[f.length-1]?.index;return this.run(()=>{this.createShapes([{id:s,type:"group",parentId:p,index:g,x:u,y:d,opacity:1,props:{}}]),this.reparentShapes(a,s),r&&this.select(s)}),this}ungroupShapes(e,n={}){if(this.getIsReadonly())return this;const{select:s=!0}=n,r=typeof e[0]=="string"?e:e.map(c=>c.id),i=ve((this._shouldIgnoreShapeLock?r:this._getUnlockedShapeIds(r)).map(c=>this.getShape(c)));if(i.length===0)return this;if(this.getCurrentToolId()!=="select")return this;this.isIn("select.idle")||this.cancel();const o=new Set,a=[];return i.forEach(c=>{this.isShapeOfType(c,"group")?a.push(c):o.add(c.id)}),a.length===0?this:(this.run(()=>{let c;for(let l=0,u=a.length;l<u;l++){c=a[l];const d=this.getSortedChildIdsForParent(c.id);for(let p=0,f=d.length;p<f;p++)o.add(d[p]);this.reparentShapes(d,c.parentId,c.index)}this.deleteShapes(a.map(l=>l.id)),s&&this.select(...o)}),this)}updateShape(e){return this.updateShapes([e]),this}updateShapes(e){const n=Array(e.length);for(let s=0,r=e.length;s<r;s++){const i=e[s];if(!i)continue;const o=this.getShape(i.id);if(o){if(!this._shouldIgnoreShapeLock){if(o.isLocked){if(!(Object.hasOwn(i,"isLocked")&&!i.isLocked))continue}else if(this.isShapeOrAncestorLocked(o))continue}this.animatingShapes.delete(i.id),n.push(i)}}return this._updateShapes(n),this}_updateShapes(e){this.getIsReadonly()||this.run(()=>{const n=[];let s,r;for(let i=0,o=e.length;i<o;i++){const a=e[i];a&&(s=this.getShape(a.id),s&&(r=dr(s,a),r!==s&&(r=this.getShapeUtil(s).onBeforeUpdate?.(s,r)??r,n.push(r))))}this.emit("edited-shapes",n),this.emit("edit"),this.store.put(n)})}_getUnlockedShapeIds(e){return e.filter(n=>!this.getShape(n)?.isLocked)}deleteShapes(e){if(this.getIsReadonly())return this;if(!Array.isArray(e))throw Error("Editor.deleteShapes: must provide an array of shapes or shapeIds");const n=typeof e[0]=="string"?e:e.map(i=>i.id),s=this._shouldIgnoreShapeLock?n:this._getUnlockedShapeIds(n);if(s.length===0)return this;const r=new Set(s);for(const i of s)this.visitDescendants(i,o=>{r.add(o)});return this.emit("deleted-shapes",[...r]),this.emit("edit"),this.run(()=>this.store.remove([...r]))}deleteShape(e){return this.deleteShapes([typeof e=="string"?e:e.id]),this}_extractSharedStyles(e,n){if(this.isShapeOfType(e,"group")){const s=this._parentIdsToChildIds.get()[e.id];if(!s)return;for(let r=0,i=s.length;r<i;r++)this._extractSharedStyles(this.getShape(s[r]),n)}else for(const[s,r]of this.styleProps[e.type])n.applyValue(s,Nt(e.props,r))}_getSelectionSharedStyles(){const e=this.getSelectedShapes(),n=new jg;for(const s of e)this._extractSharedStyles(s,n);return n}getStyleForNextShape(e){const n=this.getInstanceState().stylesForNextShape[e.id];return n===void 0?e.defaultValue:n}getShapeStyleIfExists(e,n){const s=this.styleProps[e.type].get(n);if(s!==void 0)return Nt(e.props,s)}getSharedStyles(){if(this.isIn("select")&&this.getSelectedShapeIds().length>0)return this._getSelectionSharedStyles();const e=this.root.getCurrent(),n=new jg;if(!e)return n;if(e.shapeType)if(e.shapeType==="frame"&&!this.getShapeUtil("frame").options.showColors)for(const s of this.styleProps[e.shapeType].keys())s.id!=="tldraw:color"&&n.applyValue(s,this.getStyleForNextShape(s));else for(const s of this.styleProps[e.shapeType].keys())n.applyValue(s,this.getStyleForNextShape(s));return n}getSharedOpacity(){if(this.isIn("select")&&this.getSelectedShapeIds().length>0){const e=[],n=r=>{const i=this.getShape(r);if(i)if(this.isShapeOfType(i,"group"))for(const o of this.getSortedChildIdsForParent(i.id))n(o);else e.push(i)};for(const r of this.getSelectedShapeIds())n(r);let s=null;for(const r of e)if(s===null)s=r.opacity;else if(s!==r.opacity)return{type:"mixed"};if(s!==null)return{type:"shared",value:s}}return{type:"shared",value:this.getInstanceState().opacityForNextShape}}setOpacityForNextShapes(e,n){return this.updateInstanceState({opacityForNextShape:e},n),this}setOpacityForSelectedShapes(e){const n=this.getSelectedShapes();if(n.length>0){const s=[],r=i=>{if(this.isShapeOfType(i,"group")){const o=this.getSortedChildIdsForParent(i);for(const a of o)r(this.getShape(a))}else s.push(i)};for(const i of n)r(i);this.updateShapes(s.map(i=>({id:i.id,type:i.type,opacity:e})))}return this}setStyleForNextShapes(e,n,s){const r=this.getInstanceState().stylesForNextShape;return this.updateInstanceState({stylesForNextShape:{...r,[e.id]:n}},s),this}setStyleForSelectedShapes(e,n){const s=this.getSelectedShapes();if(s.length>0){const r=[],i=o=>{if(this.isShapeOfType(o,"group")){const a=this.getSortedChildIdsForParent(o.id);for(const c of a)i(this.getShape(c))}else{const a=this.getShapeUtil(o),c=this.styleProps[o.type].get(e);if(c){const l={id:o.id,type:o.type,props:{[c]:n}};r.push({util:a,originalShape:o,updatePartial:l})}}};for(const o of s)i(o);this.updateShapes(r.map(({updatePartial:o})=>o))}return this}registerExternalAssetHandler(e,n){return this.externalAssetContentHandlers[e]=n,this}createTemporaryAssetPreview(e,n){if(this.temporaryAssetPreview.has(e))return this.temporaryAssetPreview.get(e);const s=URL.createObjectURL(n);return this.temporaryAssetPreview.set(e,s),setTimeout(()=>{this.temporaryAssetPreview.delete(e),URL.revokeObjectURL(s)},this.options.temporaryAssetPreviewLifetimeMs),s}getTemporaryAssetPreview(e){return this.temporaryAssetPreview.get(e)}async getAssetForExternalContent(e){return await this.externalAssetContentHandlers[e.type]?.(e)}hasExternalAssetHandler(e){return!!this.externalAssetContentHandlers[e]}registerExternalContentHandler(e,n){return this.externalContentHandlers[e]=n,this}async putExternalContent(e,n={}){if(!(!n.force&&this.getIsReadonly()))return this.externalContentHandlers[e.type]?.(e)}async replaceExternalContent(e,n={}){if(!(!n.force&&this.getIsReadonly()))return this.externalContentHandlers[e.type]?.(e)}getContentFromCurrentPage(e){const n=typeof e[0]=="string"?e:e.map(r=>r.id);if(!n||n.length===0)return;const s=this.getShapeAndDescendantIds(n);return Fw(this,s,r=>{const i=[];for(const u of r){const d=this.getBinding(u);d&&i.push(d)}const o=[],a=[];for(const u of s){const d=this.getShape(u);if(!d)continue;if(!s.has(d.parentId)){const f=this.getShapePageTransform(d.id),g=f.point();a.push({...d,x:g.x,y:g.y,rotation:f.rotation(),parentId:this.getCurrentPageId()}),o.push(d.id)}else a.push(d)}const c=[],l=new Set;for(const u of a){if(!("assetId"in u.props))continue;const d=u.props.assetId;if(!d||l.has(d))continue;l.add(d);const p=this.getAsset(d);p&&c.push(p)}return{schema:this.store.schema.serialize(),shapes:a,rootShapeIds:o,bindings:i,assets:c}})}async resolveAssetsInContent(e){if(!e)return;const n=[];return await Promise.allSettled(e.assets.map(async s=>{if((s.type==="image"||s.type==="video")&&!s.props.src?.startsWith("data:image")&&!s.props.src?.startsWith("data:video")&&!s.props.src?.startsWith("http")){const r=wt(s),i=await this.store.props.assets.resolve(s,{screenScale:1,steppedScreenScale:1,dpr:1,networkEffectiveType:null,shouldResolveToOriginal:!0});r.props.src=await vn.blobToDataUrl(await Qr(i).then(o=>o.blob())),n.push(r)}else n.push(s)})),e.assets=n,e}putContentOntoCurrentPage(e,n={}){if(this.getIsReadonly())return this;if(!e.schema)throw Error(`Could not put content:
content is missing a schema.`);const{select:s=!1,preserveIds:r=!1,preservePosition:i=!1}=n;let{point:o=void 0}=n;const a=this.getCurrentPageId(),{rootShapeIds:c}=e,l=[],u=[],d=[],p={store:{...Object.fromEntries(e.assets.map(k=>[k.id,k])),...Object.fromEntries(e.shapes.map(k=>[k.id,k])),...Object.fromEntries(e.bindings?.map(k=>[k.id,k])??[])},schema:e.schema},f=this.store.schema.migrateStoreSnapshot(p);if(f.type==="error")throw Error("Could not put content: could not migrate content");for(const k of Object.values(f.value))switch(k.typeName){case"asset":{l.push(k);break}case"shape":{u.push(k);break}case"binding":{d.push(k);break}}const g=new Map(r?u.map(k=>[k.id,k.id]):u.map(k=>[k.id,tt()])),x=new Map(r?d.map(k=>[k.id,k.id]):d.map(k=>[k.id,Zi()]));let y=this.getCurrentPageId(),m=1/0,S=[];for(const k of this.getSelectedShapes()){if(m===0)break;const T=this.isShapeOfType(k,"frame"),D=this.getShapeAncestors(k);T&&D.push(k);const R=T?D.length+1:D.length;if(R<m)m=R,S=D,y=T?k.id:k.parentId;else if(R===m){if(S.length!==D.length)throw Error(`Ancestors: ${S.length} !== ${D.length}`);if(S.length===0){y=a;break}else{y=a;for(let M=0;M<S.length&&D[M]===S[M];M++)y=D[M].id}}}if(o){const k=new Map(u.map(D=>[D.id,D])),T=ve(c.map(D=>k.get(D)));if(T.length>0){const D=this.getShapeAtPoint(o,{hitInside:!0,hitFrameInside:!0,hitLocked:!0,filter:R=>{const M=this.getShapeUtil(R);return M.canReceiveNewChildrenOfType?T.every(L=>M.canReceiveNewChildrenOfType(R,L.type)):!1}});y=D?D.id:a}}let w=!1;if(!nn(y)){const k=this.getShape(y);if(k){if(!this.getViewportPageBounds().includes(this.getShapePageBounds(k)))y=a;else if(c.length===1){const T=u.find(D=>D.id===c[0]);this.isShapeOfType(k,"frame")&&this.isShapeOfType(T,"frame")&&T.props.w===k?.props.w&&T.props.h===k?.props.h&&(w=!0)}}else y=a}w||(w=g.has(y)),w&&(y=this.getShape(y).parentId);let P=this.getHighestIndexForParent(y);const _=[],I=u.map(k=>{const T=g.get(k.id),D={...k,id:T};return c.includes(k.id)&&(D.parentId=a,_.push(D)),g.has(D.parentId)?D.parentId=g.get(k.parentId):(c.push(D.id),D.index=P,P=Ls(P)),D});if(I.length+this.getCurrentPageShapeIds().size>this.options.maxShapesPerPage)return Ll(this),this;const C=d.map(k=>({...k,id:Gt(x.get(k.id)),fromId:Gt(g.get(k.fromId)),toId:Gt(g.get(k.toId))})),E=[],O=[];for(const k of l)this.store.has(k.id)||((k.type==="image"&&k.props.src?.startsWith("data:image")||k.type==="video"&&k.props.src?.startsWith("data:video"))&&(O.push(wt(k)),k.props.src=null),E.push(k));return Promise.allSettled(O.map(async k=>{const T=await _R(k.props.src,k.props.name,k.props.mimeType??"image/png"),D=await this.getAssetForExternalContent({type:"file",file:T,assetId:k.id});if(!D){this.deleteAssets([k.id]);return}this.updateAssets([{...D,id:k.id}])})),this.run(()=>{E.length>0&&this.createAssets(E),this.createShapes(I),this.createBindings(C),s&&this.select(..._.map(M=>M.id)),y!==a&&this.reparentShapes(_.map(M=>M.id),y);const k=I.map(M=>this.getShape(M.id)),T=X.Common(k.map(M=>this.getShapePageBounds(M)));if(o===void 0)if(nn(y)){const M=this.getViewportPageBounds();i||M.includes(X.From(T))?o=T.center:o=M.center}else{const M=this.getShape(y);o=q.applyToPoint(this.getShapePageTransform(M),this.getShapeGeometry(M).bounds.center)}if(_.length===1){const M=_[0];if(this.isShapeOfType(M,"frame"))for(;this.getShapesAtPoint(o).some(L=>this.isShapeOfType(L,"frame")&&L.props.w===M.props.w&&L.props.h===M.props.h);)o.x+=T.w+16}const D=X.Common(ve(_.map(({id:M})=>this.getShapePageBounds(M)))).center,R=b.Sub(o,D);this.updateShapes(_.map(({id:M})=>{const L=this.getShape(M),U=this.getShapeParentTransform(M).decompose().rotation,V=b.Rot(R,-U);return{id:L.id,type:L.type,x:L.x+V.x,y:L.y+V.y}}))}),this}async getSvgElement(e,n={}){const s=e.length===0?this.getCurrentPageShapeIdsSorted():typeof e[0]=="string"?e:e.map(r=>r.id);if(s.length!==0)return mR(this,s,n)}async getSvgString(e,n={}){const s=await this.getSvgElement(e,n);return s?{svg:new XMLSerializer().serializeToString(s.svg),width:s.width,height:s.height}:void 0}async toImage(e,n={}){const s={format:"png",scale:1,pixelRatio:n.format==="svg"?void 0:2,...n},r=await this.getSvgString(e,s);if(!r)throw new Error("Could not create SVG");switch(s.format){case"svg":return{blob:new Blob([r.svg],{type:"image/svg+xml"}),width:r.width,height:r.height};case"jpeg":case"png":case"webp":{const i=await vR(r.svg,{type:s.format,quality:s.quality,pixelRatio:s.pixelRatio,width:r.width,height:r.height});if(!i)throw new Error("Could not construct image.");return{blob:i,width:r.width,height:r.height}}default:Ke(s.format)}}async toImageDataUrl(e,n={}){const{blob:s,width:r,height:i}=await this.toImage(e,n);return{url:await vn.blobToDataUrl(s),width:r,height:i}}cancel(){return this.dispatch({type:"misc",name:"cancel"}),this}interrupt(){return this.dispatch({type:"misc",name:"interrupt"}),this}complete(){return this.dispatch({type:"misc",name:"complete"}),this}updatePointer(e){const n={type:"pointer",target:"canvas",name:"pointer_move",point:e?.point??b.Add(this.inputs.getCurrentScreenPoint(),this.store.unsafeGetWithoutCapture(Fn).screenBounds),pointerId:e?.pointerId??0,button:e?.button??0,isPen:e?.isPen??this.inputs.getIsPen(),shiftKey:e?.shiftKey??this.inputs.getShiftKey(),altKey:e?.altKey??this.inputs.getAltKey(),ctrlKey:e?.ctrlKey??this.inputs.getCtrlKey(),metaKey:e?.metaKey??this.inputs.getMetaKey(),accelKey:!1};return n.accelKey=e?.accelKey??this.inputs.getAccelKey(),e?.immediate?this._flushEventForTick(n):this.dispatch(n),this}focus({focusContainer:e=!0}={}){return this.getIsFocused()?this:(e&&this.focusManager.focus(),this.updateInstanceState({isFocused:!0}),this)}blur({blurContainer:e=!0}={}){return this.getIsFocused()?(e?this.focusManager.blur():this.complete(),this.updateInstanceState({isFocused:!1}),this):this}getIsFocused(){return this.getInstanceState().isFocused}getIsReadonly(){return this.getInstanceState().isReadonly}getSnapshot(){return gL(this.store)}loadSnapshot(e,n){return KP(this.store,e,n),this}_zoomToFitPageContentAt100Percent(){const e=this.getCurrentPageBounds();e&&this.zoomToBounds(e,{immediate:!0,targetZoom:this.getBaseZoom()})}_navigateToDeepLink(e){this.run(()=>{switch(e.type){case"page":{const n=this.getPage(e.pageId);n&&this.setCurrentPage(n),this._zoomToFitPageContentAt100Percent();return}case"shapes":{const n=ve(e.shapeIds.map(o=>this.getShape(o))),s={};for(const o of n){const a=this.getAncestorPageId(o);a&&(s[a]??=[],s[a].push(o))}const[r,i]=Object.entries(s).sort(([o,a],[c,l])=>l.length-a.length)[0]??["",[]];if(!r||!i.length)this._zoomToFitPageContentAt100Percent();else{this.setCurrentPage(r);const o=X.Common(i.map(a=>this.getShapePageBounds(a)));this.zoomToBounds(o,{immediate:!0,targetZoom:this.getBaseZoom()})}return}case"viewport":{if(e.pageId){if(!this.getPage(e.pageId)){this._zoomToFitPageContentAt100Percent();return}this.setCurrentPage(e.pageId)}this.zoomToBounds(e.bounds,{immediate:!0,inset:0});return}default:Ke(e)}})}navigateToDeepLink(e){if(e&&"type"in e)return this._navigateToDeepLink(e),this;const s=new URL(e?.url??window.location.href).searchParams.get(e?.param??"d");if(!s)return this._zoomToFitPageContentAt100Percent(),this;try{this._navigateToDeepLink(ER(s))}catch(r){console.warn(r),this._zoomToFitPageContentAt100Percent()}return this}createDeepLink(e){const n=new URL(e?.url??window.location.href);return n.searchParams.set(e?.param??"d",TR(e?.to??{type:"viewport",pageId:this.options.maxPages===1?void 0:this.getCurrentPageId(),bounds:this.getViewportPageBounds()})),n}registerDeepLinkListener(e){if(e?.getUrl&&!e?.onChange)throw Error("[tldraw:urlStateSync] If you specify getUrl, you must also specify the onChange callback.");const n=K("url with state",()=>{const o=e?.getUrl?.(this)??window.location.href;return this.createDeepLink({param:e?.param,url:o,to:e?.getTarget?.(this)}).toString()}),s=e?.onChange??(()=>{const o=this.createDeepLink({param:e?.param,to:e?.getTarget?.(this)});window.history.replaceState({},document.title,o.toString())}),r=Gd(o=>o(),e?.debounceMs??500),i=is("update url on state change",()=>s(new URL(n.get()),this),{scheduleEffect:r});return()=>{i(),r.cancel()}}cancelDoubleClick(){this._clickManager.cancelDoubleClickTimeout()}_setShiftKeyTimeout(){this.inputs.setShiftKey(!1),this.dispatch({type:"keyboard",name:"key_up",key:"Shift",shiftKey:this.inputs.getShiftKey(),ctrlKey:this.inputs.getCtrlKey(),altKey:this.inputs.getAltKey(),metaKey:this.inputs.getMetaKey(),accelKey:this.inputs.getAccelKey(),code:"ShiftLeft"})}_setAltKeyTimeout(){this.inputs.setAltKey(!1),this.dispatch({type:"keyboard",name:"key_up",key:"Alt",shiftKey:this.inputs.getShiftKey(),ctrlKey:this.inputs.getCtrlKey(),altKey:this.inputs.getAltKey(),metaKey:this.inputs.getMetaKey(),accelKey:this.inputs.getAccelKey(),code:"AltLeft"})}_setCtrlKeyTimeout(){this.inputs.setCtrlKey(!1),this.dispatch({type:"keyboard",name:"key_up",key:"Ctrl",shiftKey:this.inputs.getShiftKey(),ctrlKey:this.inputs.getCtrlKey(),altKey:this.inputs.getAltKey(),metaKey:this.inputs.getMetaKey(),accelKey:this.inputs.getAccelKey(),code:"ControlLeft"})}_setMetaKeyTimeout(){this.inputs.setMetaKey(!1),this.dispatch({type:"keyboard",name:"key_up",key:"Meta",shiftKey:this.inputs.getShiftKey(),ctrlKey:this.inputs.getCtrlKey(),altKey:this.inputs.getAltKey(),metaKey:this.inputs.getMetaKey(),accelKey:this.inputs.getAccelKey(),code:"MetaLeft"})}markEventAsHandled(e){const n="nativeEvent"in e?e.nativeEvent:e;this.handledEvents.add(n)}wasEventAlreadyHandled(e){const n="nativeEvent"in e?e.nativeEvent:e;return this.handledEvents.has(n)}dispatch(e){return this._pendingEventsForNextTick.push(e),e.type==="pointer"&&e.name==="pointer_move"||e.type==="wheel"||e.type==="pinch"||this._flushEventsForTick(0),this}_flushEventsForTick(e){this.run(()=>{if(this._pendingEventsForNextTick.length>0){const n=[...this._pendingEventsForNextTick];this._pendingEventsForNextTick.length=0;for(const s of n)this._flushEventForTick(s)}e>0&&this.root.handleEvent({type:"misc",name:"tick",elapsed:e}),this.scribbles.tick(e)})}_flushEventForTick(e){if(this.getCrashingError())return this;this.emit("before-event",e);const{inputs:n}=this,{type:s}=e;if(e.type==="misc"){(e.name==="cancel"||e.name==="complete")&&(this.inputs.setIsDragging(!1),this.inputs.getIsPanning()&&(this.inputs.setIsPanning(!1),this.inputs.setIsSpacebarPanning(!1),this.setCursor({type:this._prevCursor,rotation:0}))),this.root.handleEvent(e),this.emit("event",e);return}e.shiftKey?(clearTimeout(this._shiftKeyTimeout),this._shiftKeyTimeout=-1,n.setShiftKey(!0)):!e.shiftKey&&n.getShiftKey()&&this._shiftKeyTimeout===-1&&(this._shiftKeyTimeout=this.timers.setTimeout(this._setShiftKeyTimeout,150)),e.altKey?(clearTimeout(this._altKeyTimeout),this._altKeyTimeout=-1,n.setAltKey(!0)):!e.altKey&&n.getAltKey()&&this._altKeyTimeout===-1&&(this._altKeyTimeout=this.timers.setTimeout(this._setAltKeyTimeout,150)),e.ctrlKey?(clearTimeout(this._ctrlKeyTimeout),this._ctrlKeyTimeout=-1,n.setCtrlKey(!0)):!e.ctrlKey&&n.getCtrlKey()&&this._ctrlKeyTimeout===-1&&(this._ctrlKeyTimeout=this.timers.setTimeout(this._setCtrlKeyTimeout,150)),e.metaKey?(clearTimeout(this._metaKeyTimeout),this._metaKeyTimeout=-1,n.setMetaKey(!0)):!e.metaKey&&n.getMetaKey()&&this._metaKeyTimeout===-1&&(this._metaKeyTimeout=this.timers.setTimeout(this._setMetaKeyTimeout,150)),n.getIsPointing()||n.setIsDragging(!1);const r=this.store.unsafeGetWithoutCapture(Fn),i=this.store.get(this._getCurrentPageStateId()),o=this._cameraOptions.__unsafe__getWithoutCapture();switch(s){case"pinch":{if(o.isLocked)return;switch(clearTimeout(this._longPressTimeout),this.inputs.updateFromEvent(e),e.name){case"pinch_start":{if(n.getIsPinching())return;n.getIsEditing()||(this._selectedShapeIdsAtPointerDown.length||(this._selectedShapeIdsAtPointerDown=[...i.selectedShapeIds]),this._didPinch=!0,n.setIsPinching(!0),this.interrupt()),this.emit("event",e);return}case"pinch":{if(!n.getIsPinching())return;const{point:{z:a=1},delta:{x:c,y:l}}=e,{x:u,y:d}=b.SubXY(e.point,r.screenBounds.x,r.screenBounds.y);this.stopCameraAnimation(),r.followingUserId&&this.stopFollowingUser();const{x:p,y:f,z:g}=Yi(()=>this.getCamera()),{panSpeed:x}=o;this._setCamera(new b(p+c*x/g-u/g+u/a,f+l*x/g-d/g+d/a,a),{immediate:!0}),this.emit("event",e);return}case"pinch_end":{if(!n.getIsPinching())return this;n.setIsPinching(!1);const{_selectedShapeIdsAtPointerDown:a}=this;this.setSelectedShapes(this._selectedShapeIdsAtPointerDown),this._selectedShapeIdsAtPointerDown=[],this._didPinch&&(this._didPinch=!1,a.length>0&&this.once("tick",()=>{this._didPinch||this.setSelectedShapes(a)})),this.emit("event",e);return}}}case"wheel":{if(o.isLocked)return;this.inputs.updateFromEvent(e);const{panSpeed:a,zoomSpeed:c}=o;let l=o.wheelBehavior;const u=this.user.getUserPreferences().inputMode;if(u!==null&&(l=u==="trackpad"?"pan":"zoom"),l!=="none"){this.stopCameraAnimation(),r.followingUserId&&this.stopFollowingUser();const{x:d,y:p,z:f}=Yi(()=>this.getCamera()),{x:g,y:x,z:y=0}=e.delta;let m=l;switch(e.ctrlKey&&(m=l==="pan"?"zoom":"pan"),m){case"zoom":{const{x:S,y:w}=this.inputs.getCurrentScreenPoint();let P=y;l==="zoom"&&(Math.abs(x)>10?P=10*Math.sign(x)/100:P=x/100);const _=f+(P??0)*c*f;this._setCamera(new b(d+S/_-S/f,p+w/_-w/f,_),{immediate:!0}),this.maybeTrackPerformance("Zooming"),this.root.handleEvent(e),this.emit("event",e);return}case"pan":{this._setCamera(new b(d+g*a/f,p+x*a/f,f),{immediate:!0}),this.maybeTrackPerformance("Panning"),this.root.handleEvent(e),this.emit("event",e);return}}}break}case"pointer":{if(n.getIsPinching())return;this.inputs.updateFromEvent(e);const{isPen:a}=e,{isPenMode:c}=r;switch(e.name){case"pointer_down":{if(c&&!a)return;if(this.inputs.getIsPanning()||(this._longPressTimeout=this.timers.setTimeout(()=>{const l=this.getViewportScreenBounds();this.dispatch({...e,point:this.inputs.getOriginScreenPoint().clone().addXY(l.x,l.y),name:"long_press"})},this.options.longPressDurationMs)),this._selectedShapeIdsAtPointerDown=this.getSelectedShapeIds(),e.button===hw&&(this.capturedPointerId=e.pointerId),n.buttons.add(e.button),n.setIsPointing(!0),n.setIsDragging(!1),!c&&a&&this.updateInstanceState({isPenMode:!0}),e.button===pw?(this._restoreToolId=this.getCurrentToolId(),this.complete(),this.setCurrentTool("eraser")):e.button===Al&&(this.inputs.getIsPanning()||(this._prevCursor=this.getInstanceState().cursor.type),this.inputs.setIsPanning(!0),clearTimeout(this._longPressTimeout)),this.inputs.getIsPanning())return this.stopCameraAnimation(),this.setCursor({type:"grabbing",rotation:0}),this;break}case"pointer_move":{if(!a&&c)return;const{x:l,y:u,z:d}=Yi(()=>this.getCamera());if(this.inputs.getIsPanning()&&this.inputs.getIsPointing()){const p=this.inputs.getCurrentScreenPoint(),f=this.inputs.getPreviousScreenPoint(),g=b.Sub(p,f);this.setCamera(new b(l+g.x/d,u+g.y/d,d),{immediate:!0}),this.maybeTrackPerformance("Panning");return}n.getIsPointing()&&!n.getIsDragging()&&b.Dist2(n.getOriginPagePoint(),n.getCurrentPagePoint())*this.getZoomLevel()>(r.isCoarsePointer?this.options.coarseDragDistanceSquared:this.options.dragDistanceSquared)/d&&(n.setIsDragging(!0),clearTimeout(this._longPressTimeout));break}case"pointer_up":{if(n.setIsDragging(!1),n.setIsPointing(!1),clearTimeout(this._longPressTimeout),n.buttons.delete(e.button),r.isPenMode&&!a)return;if(this.capturedPointerId===e.pointerId&&(this.capturedPointerId=null,e.button=0),n.getIsPanning()){n.keys.has("Space")||(n.setIsPanning(!1),n.setIsSpacebarPanning(!1));const l=this.inputs.getPointerVelocity(),u=Math.min(2,l.len());switch(e.button){case hw:{this.setCursor({type:"grab",rotation:0});break}case Al:this.inputs.keys.has(" ")?this.setCursor({type:"grab",rotation:0}):this.setCursor({type:this._prevCursor,rotation:0})}u>0&&this.slideCamera({speed:u,direction:l})}else e.button===pw&&(this.complete(),this.setCurrentTool(this._restoreToolId));break}}break}case"keyboard":{switch(e.key==="ShiftRight"&&(e.key="ShiftLeft"),e.key==="AltRight"&&(e.key="AltLeft"),e.code==="ControlRight"&&(e.code="ControlLeft"),e.code==="MetaRight"&&(e.code="MetaLeft"),e.name){case"key_down":{if(n.keys.add(e.code),this.options.spacebarPanning&&(e.code==="Space"&&!e.ctrlKey&&(this.inputs.getIsPanning()||(this._prevCursor=r.cursor.type),this.inputs.setIsPanning(!0),this.inputs.setIsSpacebarPanning(!0),clearTimeout(this._longPressTimeout),this.setCursor({type:this.inputs.getIsPointing()?"grabbing":"grab",rotation:0})),this.inputs.getIsSpacebarPanning())){let a;switch(e.code){case"ArrowUp":{a=new b(0,-1);break}case"ArrowRight":{a=new b(1,0);break}case"ArrowDown":{a=new b(0,1);break}case"ArrowLeft":{a=new b(-1,0);break}}if(a){const c=this.getViewportPageBounds(),l=c.clone().translate(a.mulV({x:c.w,y:c.h}));this._animateToViewport(l,{animation:{duration:320}})}}break}case"key_up":{n.keys.delete(e.code),this.options.spacebarPanning&&e.code==="Space"&&(this.inputs.buttons.has(Al)||(this.inputs.setIsPanning(!1),this.inputs.setIsSpacebarPanning(!1),this.setCursor({type:this._prevCursor,rotation:0})));break}}break}}if(e.type==="pointer"){e.button===Al?e.name="middle_click":e.button===ey&&(e.name="right_click");const{isPenMode:a}=this.store.unsafeGetWithoutCapture(Fn);if(e.isPen===a){const c=this._clickManager.handlePointerEvent(e);if(e.name!==c.name){this.root.handleEvent(e),this.emit("event",e),this.root.handleEvent(c),this.emit("event",c);return}}}return this.root.handleEvent(e),this.emit("event",e),e.type==="pointer"&&e.name==="pointer_down"&&this.menus.clearOpenMenus(),this}maybeTrackPerformance(e){mt.measurePerformance.get()&&(this.performanceTracker.isStarted()?clearTimeout(this.performanceTrackerTimeout):this.performanceTracker.start(e),this.performanceTrackerTimeout=this.timers.setTimeout(()=>{this.performanceTracker.stop()},50))}}ie=iF(Dg);oe(ie,1,"getIsShapeHiddenCache",oT,re);oe(ie,1,"canUndo",iT,re);oe(ie,1,"canRedo",rT,re);oe(ie,1,"getPath",sT,re);oe(ie,1,"getCurrentTool",nT,re);oe(ie,1,"getCurrentToolId",tT,re);oe(ie,1,"getDocumentSettings",eT,re);oe(ie,1,"getInstanceState",QC,re);oe(ie,1,"getPageStates",JC,re);oe(ie,1,"_getPageStatesQuery",ZC,re);oe(ie,1,"getCurrentPageState",XC,re);oe(ie,1,"_getCurrentPageStateId",VC,re);oe(ie,1,"getSelectedShapeIds",YC,re);oe(ie,1,"getSelectedShapes",GC,re);oe(ie,1,"getCurrentPageShapesInReadingOrder",qC,re);oe(ie,1,"getOnlySelectedShapeId",WC,re);oe(ie,1,"getOnlySelectedShape",KC,re);oe(ie,1,"getSelectionPageBounds",HC,re);oe(ie,1,"getSelectionRotation",UC,re);oe(ie,1,"getSelectionRotatedPageBounds",NC,re);oe(ie,1,"getSelectionRotatedScreenBounds",$C,re);oe(ie,1,"getFocusedGroupId",zC,re);oe(ie,1,"getFocusedGroup",BC,re);oe(ie,1,"getEditingShapeId",FC,re);oe(ie,1,"getEditingShape",RC,re);oe(ie,1,"getRichTextEditor",LC,re);oe(ie,1,"getHoveredShapeId",OC,re);oe(ie,1,"getHoveredShape",DC,re);oe(ie,1,"getHintingShapeIds",jC,re);oe(ie,1,"getHintingShape",MC,re);oe(ie,1,"getErasingShapeIds",AC,re);oe(ie,1,"getErasingShapes",kC,re);oe(ie,1,"_unsafe_getCameraId",EC,re);oe(ie,1,"getCamera",TC,re);oe(ie,1,"getViewportPageBoundsForFollowing",CC,re);oe(ie,1,"getCameraForFollowing",_C,re);oe(ie,1,"getZoomLevel",IC,re);oe(ie,1,"getDebouncedZoomLevel",PC,re);oe(ie,1,"_getAboveDebouncedZoomThreshold",vC,re);oe(ie,1,"getEfficientZoomLevel",wC,re);oe(ie,1,"getViewportScreenBounds",bC,re);oe(ie,1,"getViewportScreenCenter",xC,re);oe(ie,1,"getViewportPageBounds",SC,re);oe(ie,1,"_getCollaboratorsQuery",yC,re);oe(ie,1,"getCollaborators",mC,re);oe(ie,1,"getCollaboratorsOnCurrentPage",gC,re);oe(ie,1,"getRenderingShapes",fC,re);oe(ie,1,"_getAllPagesQuery",pC,re);oe(ie,1,"getPages",hC,re);oe(ie,1,"getCurrentPageId",uC,re);oe(ie,1,"getCurrentPageShapeIdsSorted",dC,re);oe(ie,1,"_getAllAssetsQuery",lC,re);oe(ie,1,"_getShapeHandlesCache",cC,re);oe(ie,1,"_getShapePageTransformCache",aC,re);oe(ie,1,"_getShapePageBoundsCache",oC,re);oe(ie,1,"_getShapeClipPathCache",iC,re);oe(ie,1,"_getShapeMaskCache",rC,re);oe(ie,1,"_getShapeMaskedPageBoundsCache",sC,re);oe(ie,1,"getNotVisibleShapes",nC,re);oe(ie,1,"getCulledShapes",tC,re);oe(ie,1,"getCurrentPageBounds",eC,re);oe(ie,1,"getCurrentPageShapes",Q_,re);oe(ie,1,"getCurrentPageShapesSorted",J_,re);oe(ie,1,"getCurrentPageRenderingShapesSorted",Z_,re);oe(ie,1,"_getBindingsIndexCache",X_,re);oe(ie,1,"_getSelectionSharedStyles",V_,re);oe(ie,1,"getSharedStyles",Y_,re);oe(ie,1,"getSharedOpacity",G_,re);oe(ie,1,"getIsFocused",q_,re);oe(ie,1,"getIsReadonly",W_,re);oe(ie,1,"_setShiftKeyTimeout",K_,re);oe(ie,1,"_setAltKeyTimeout",H_,re);oe(ie,1,"_setCtrlKeyTimeout",U_,re);oe(ie,1,"_setMetaKeyTimeout",N_,re);aF(ie,re);function Ll(t,e=t.getCurrentPageId()){const n=t.getPage(e).name;t.emit("max-shapes",{name:n,pageId:e,count:t.options.maxShapesPerPage})}function dr(t,e){if(!e)return t;let n=null;const s=Object.entries(e);for(let r=0,i=s.length;r<i;r++){const[o,a]=s[r];if(a!==void 0&&!(o==="id"||o==="type"||o==="typeName")&&a!==t[o]){if(n||(n={...t}),o==="props"||o==="meta"){n[o]={...t[o]};for(const[c,l]of Object.entries(a))n[o][c]=l;continue}n[o]=a}}return n||t}function aT(t,e,n){const s=t.getShape(e);if(!s)return;n.push(s);const r=t.getSortedChildIdsForParent(e);for(let i=0,o=r.length;i<o;i++)aT(t,r[i],n)}function Fw(t,e,n){let s;if(t.run(()=>{const r=t.store.extractingChanges(()=>{const i=new Set,o=new Set;for(const a of e)if(t.getShape(a))for(const l of t.getBindingsInvolvingShape(a)){const u=e.has(l.fromId),d=e.has(l.toId);if(u&&d){i.add(l.id);continue}(!u||!d)&&o.add(l.id)}t.deleteBindings([...o],{isolateShapes:!0});try{s=Bs.ok(n(i))}catch(a){s=Bs.err(a)}});t.store.applyDiff(yg(r),{runCallbacks:!1})},{history:"ignore"}),s.ok)return s.value;throw s.error}function Bw(t,e){if(!e.constraints)throw Error("Should have constraints here");const{padding:{x:n,y:s}}=e.constraints,r=t.getViewportScreenBounds(),i=X.From(e.constraints.bounds),o=(r.w-n*2)/i.w,a=(r.h-s*2)/i.h;return{zx:o,zy:a}}function wu(){const t=z(),e=Jc();return $("isDarkMode",()=>e?.isDarkMode??t.user.getIsDarkMode(),[e,t])}const zw="<path d='m19.7432 17.0869-4.072 4.068 2.829 2.828-8.473-.013-.013-8.47 2.841 2.842 4.075-4.068 1.414-1.415-2.844-2.842h8.486v8.484l-2.83-2.827z' fill='%23fff'/><path d='m18.6826 16.7334-4.427 4.424 1.828 1.828-5.056-.016-.014-5.054 1.842 1.841 4.428-4.422 2.474-2.475-1.844-1.843h5.073v5.071l-1.83-1.828z' fill='%23000'/>",$w="<path d='m9 17.9907v.005l5.997 5.996.001-3.999h1.999 2.02v4l5.98-6.001-5.98-5.999.001 4.019-2.021.002h-2l.001-4.022zm1.411.003 3.587-3.588-.001 2.587h3.5 2.521v-2.585l3.565 3.586-3.564 3.585-.001-2.585h-2.521l-3.499-.001-.001 2.586z' fill='%23fff'/><path d='m17.4971 18.9932h2.521v2.586l3.565-3.586-3.565-3.585v2.605h-2.521-3.5v-2.607l-3.586 3.587 3.586 3.586v-2.587z' fill='%23000'/>",Rl='<path d="M22.4789 9.45728L25.9935 12.9942L22.4789 16.5283V14.1032C18.126 14.1502 14.6071 17.6737 14.5675 22.0283H17.05L13.513 25.543L9.97889 22.0283H12.5674C12.6071 16.5691 17.0214 12.1503 22.4789 12.1031L22.4789 9.45728Z" fill="black"/><path fill-rule="evenodd" clip-rule="evenodd" d="M21.4789 7.03223L27.4035 12.9945L21.4789 18.9521V15.1868C18.4798 15.6549 16.1113 18.0273 15.649 21.0284H19.475L13.5128 26.953L7.55519 21.0284H11.6189C12.1243 15.8155 16.2679 11.6677 21.4789 11.1559L21.4789 7.03223ZM22.4789 12.1031C17.0214 12.1503 12.6071 16.5691 12.5674 22.0284H9.97889L13.513 25.543L17.05 22.0284H14.5675C14.5705 21.6896 14.5947 21.3558 14.6386 21.0284C15.1157 17.4741 17.9266 14.6592 21.4789 14.1761C21.8063 14.1316 22.1401 14.1069 22.4789 14.1032V16.5284L25.9935 12.9942L22.4789 9.45729L22.4789 12.1031Z" fill="white"/>';function fi(t,e,n,s,r,i=16,o=16){const a=(-n-e)*(Ve/180),c=Math.sin(a),l=Math.cos(a),u=1*l-1*c,d=1*c+1*l;return`url("data:image/svg+xml,<svg height='32' width='32' viewBox='0 0 32 32' xmlns='http://www.w3.org/2000/svg' style='color: ${r};'><defs><filter id='shadow' y='-40%' x='-40%' width='180px' height='180%' color-interpolation-filters='sRGB'><feDropShadow dx='${u}' dy='${d}' stdDeviation='1.2' flood-opacity='.5'/></filter></defs><g fill='none' transform='rotate(${e+n} 16 16)${s?" scale(-1,-1) translate(0, -32)":""}' filter='url(%23shadow)'>`+t.replaceAll('"',"'")+`</g></svg>") ${i} ${o}, pointer`}const lF=["default","pointer","cross","move","grab","grabbing","text","zoom-in","zoom-out"],dF={none:()=>"none","ew-resize":(t,e,n)=>fi($w,t,0,e,n),"ns-resize":(t,e,n)=>fi($w,t,90,e,n),"nesw-resize":(t,e,n)=>fi(zw,t,0,e,n),"nwse-resize":(t,e,n)=>fi(zw,t,90,e,n),"nwse-rotate":(t,e,n)=>fi(Rl,t,0,e,n),"nesw-rotate":(t,e,n)=>fi(Rl,t,90,e,n),"senw-rotate":(t,e,n)=>fi(Rl,t,180,e,n),"swne-rotate":(t,e,n)=>fi(Rl,t,270,e,n)};function gs(t,e=0,n="black"){return dF[t](LO(e),!1,n)}function uF(){const t=z(),e=Lt(),n=wu();Qi("useCursor",()=>{const{type:s,rotation:r}=t.getInstanceState().cursor;if(lF.includes(s)){e.style.setProperty("--tl-cursor",`var(--tl-cursor-${s})`);return}e.style.setProperty("--tl-cursor",gs(s,r,n?"white":"black"))},[t,e,n])}function hF(){const t=z(),e=Lt(),n=wu(),s=$(mt.forceSrgb);Ye.useEffect(()=>{n?(e.setAttribute("data-color-mode","dark"),e.classList.remove("tl-theme__light"),e.classList.add("tl-theme__dark")):(e.setAttribute("data-color-mode","light"),e.classList.remove("tl-theme__dark"),e.classList.add("tl-theme__light")),s?e.classList.add("tl-theme__force-sRGB"):e.classList.remove("tl-theme__force-sRGB")},[t,e,s,n])}function pF(){const[t,e]=v.useState(0);v.useEffect(()=>e(n=>n+1),[])}const fF=t=>t.props.src,gF={upload:async(t,e)=>({src:await vn.blobToDataUrl(e)})};function mF(t){return"schema"in t&&t.schema?t.schema:_O({shapes:"shapeUtils"in t&&t.shapeUtils?Nw(ZP(t.shapeUtils)):void 0,bindings:"bindingUtils"in t&&t.bindingUtils?Nw(qP(t.bindingUtils)):void 0,migrations:"migrations"in t?t.migrations:void 0})}function Ld({initialData:t,defaultName:e="",id:n,assets:s=gF,onMount:r,collaboration:i,...o}={}){const a=mF(o),c=new Um({id:n,schema:a,initialData:t,props:{defaultName:e,assets:{upload:s.upload,resolve:s.resolve??fF,remove:s.remove??(()=>Promise.resolve())},onMount:l=>{le(l instanceof re),r?.(l)},collaboration:i}});if(o.snapshot){if(t)throw new Error("Cannot provide both initialData and snapshot");KP(c,o.snapshot,{forceOverwriteSessionState:!0})}return c}function Nw(t){return Object.fromEntries(t.map(e=>[e.type,{props:e.props,migrations:e.migrations}]))}const yF=(t,e)=>e.some(n=>t instanceof n);let Uw,Hw;function SF(){return Uw||(Uw=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function xF(){return Hw||(Hw=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const cT=new WeakMap,Og=new WeakMap,lT=new WeakMap,Gf=new WeakMap,xy=new WeakMap;function bF(t){const e=new Promise((n,s)=>{const r=()=>{t.removeEventListener("success",i),t.removeEventListener("error",o)},i=()=>{n(Jr(t.result)),r()},o=()=>{s(t.error),r()};t.addEventListener("success",i),t.addEventListener("error",o)});return e.then(n=>{n instanceof IDBCursor&&cT.set(n,t)}).catch(()=>{}),xy.set(e,t),e}function wF(t){if(Og.has(t))return;const e=new Promise((n,s)=>{const r=()=>{t.removeEventListener("complete",i),t.removeEventListener("error",o),t.removeEventListener("abort",o)},i=()=>{n(),r()},o=()=>{s(t.error||new DOMException("AbortError","AbortError")),r()};t.addEventListener("complete",i),t.addEventListener("error",o),t.addEventListener("abort",o)});Og.set(t,e)}let Lg={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return Og.get(t);if(e==="objectStoreNames")return t.objectStoreNames||lT.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return Jr(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function vF(t){Lg=t(Lg)}function PF(t){return t===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...n){const s=t.call(Yf(this),e,...n);return lT.set(s,e.sort?e.sort():[e]),Jr(s)}:xF().includes(t)?function(...e){return t.apply(Yf(this),e),Jr(cT.get(this))}:function(...e){return Jr(t.apply(Yf(this),e))}}function IF(t){return typeof t=="function"?PF(t):(t instanceof IDBTransaction&&wF(t),yF(t,SF())?new Proxy(t,Lg):t)}function Jr(t){if(t instanceof IDBRequest)return bF(t);if(Gf.has(t))return Gf.get(t);const e=IF(t);return e!==t&&(Gf.set(t,e),xy.set(e,t)),e}const Yf=t=>xy.get(t);function dT(t,e,{blocked:n,upgrade:s,blocking:r,terminated:i}={}){const o=indexedDB.open(t,e),a=Jr(o);return s&&o.addEventListener("upgradeneeded",c=>{s(Jr(o.result),c.oldVersion,c.newVersion,Jr(o.transaction),c)}),n&&o.addEventListener("blocked",c=>n(c.oldVersion,c.newVersion,c)),a.then(c=>{i&&c.addEventListener("close",()=>i()),r&&c.addEventListener("versionchange",l=>r(l.oldVersion,l.newVersion,l))}).catch(()=>{}),a}function uT(t,{blocked:e}={}){const n=indexedDB.deleteDatabase(t);return e&&n.addEventListener("blocked",s=>e(s.oldVersion,s)),Jr(n).then(()=>{})}const _F=["get","getKey","getAll","getAllKeys","count"],CF=["put","add","delete","clear"],Vf=new Map;function Kw(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(Vf.get(e))return Vf.get(e);const n=e.replace(/FromIndex$/,""),s=e!==n,r=CF.includes(n);if(!(n in(s?IDBIndex:IDBObjectStore).prototype)||!(r||_F.includes(n)))return;const i=async function(o,...a){const c=this.transaction(o,r?"readwrite":"readonly");let l=c.store;return s&&(l=l.index(a.shift())),(await Promise.all([l[n](...a),r&&c.done]))[0]};return Vf.set(e,i),i}vF(t=>({...t,get:(e,n,s)=>Kw(e,n)||t.get(e,n,s),has:(e,n)=>!!Kw(e,n)||t.has(e,n)}));const TF="TLDRAW_DOCUMENT_v2",EF="TLDRAW_ASSET_STORE_v1",hT="TLDRAW_DB_NAME_INDEX_v2",ze={Records:"records",Schema:"schema",SessionState:"session_state",Assets:"assets"};async function pT(t){const e=TF+t;return AF(e),await dT(e,4,{upgrade(n){n.objectStoreNames.contains(ze.Records)||n.createObjectStore(ze.Records),n.objectStoreNames.contains(ze.Schema)||n.createObjectStore(ze.Schema),n.objectStoreNames.contains(ze.SessionState)||n.createObjectStore(ze.SessionState),n.objectStoreNames.contains(ze.Assets)||n.createObjectStore(ze.Assets)}})}async function kF(t){const e=window.indexedDB.databases?(await window.indexedDB.databases()).map(p=>p.name):by(),n=EF+t;if(!e.find(p=>p===n))return;const r=await dT(n,1,{upgrade(p){p.objectStoreNames.contains("assets")||p.createObjectStore("assets")}});if(!r.objectStoreNames.contains("assets"))return;const i=r.transaction(["assets"],"readonly"),o=i.objectStore("assets"),a=await o.getAllKeys(),c=await Promise.all(a.map(async p=>[p,await o.get(p)]));await i.done;const l=await pT(t),u=l.transaction([ze.Assets],"readwrite"),d=u.objectStore(ze.Assets);for(const[p,f]of c)d.put(f,p);await u.done,r.close(),l.close(),await uT(n)}class _c{getDbPromise;isClosed=!1;pendingTransactionSet=new Set;static connectedInstances=new Set;constructor(e){_c.connectedInstances.add(this),this.getDbPromise=(async()=>(await kF(e),await pT(e)))()}getDb(){return this.getDbPromise}pending(){return Promise.allSettled([this.getDbPromise,...this.pendingTransactionSet]).then(yc)}async close(){this.isClosed||(this.isClosed=!0,await this.pending(),(await this.getDb()).close(),_c.connectedInstances.delete(this))}tx(e,n,s){const r=(async()=>{le(!this.isClosed,"db is closed");const o=(await this.getDb()).transaction(n,e),a=o.done.catch(c=>{if(!this.isClosed)throw c});try{return await s(o)}finally{this.isClosed?o.abort():await a}})();return this.pendingTransactionSet.add(r),r.finally(()=>this.pendingTransactionSet.delete(r)),r}async load({sessionId:e}={}){return await this.tx("readonly",[ze.Records,ze.Schema,ze.SessionState],async n=>{const s=n.objectStore(ze.Records),r=n.objectStore(ze.Schema),i=n.objectStore(ze.SessionState);let o=e?(await i.get(e))?.snapshot:null;return o||(o=(await i.getAll()).sort((l,u)=>l.updatedAt-u.updatedAt).pop()?.snapshot),{records:await s.getAll(),schema:await r.get(ze.Schema),sessionStateSnapshot:o}})}async storeChanges({schema:e,changes:n,sessionId:s,sessionStateSnapshot:r}){await this.tx("readwrite",[ze.Records,ze.Schema,ze.SessionState],async i=>{const o=i.objectStore(ze.Records),a=i.objectStore(ze.Schema),c=i.objectStore(ze.SessionState);for(const[l,u]of Object.entries(n.added))await o.put(u,l);for(const[l,u]of Object.values(n.updated))await o.put(u,u.id);for(const l of Object.keys(n.removed))await o.delete(l);a.put(e.serialize(),ze.Schema),r&&s?c.put({snapshot:r,updatedAt:Date.now(),id:s},s):(r||s)&&console.error("sessionStateSnapshot and instanceId must be provided together")})}async storeSnapshot({schema:e,snapshot:n,sessionId:s,sessionStateSnapshot:r}){await this.tx("readwrite",[ze.Records,ze.Schema,ze.SessionState],async i=>{const o=i.objectStore(ze.Records),a=i.objectStore(ze.Schema),c=i.objectStore(ze.SessionState);await o.clear();for(const[l,u]of Object.entries(n))await o.put(u,l);a.put(e.serialize(),ze.Schema),r&&s?c.put({snapshot:r,updatedAt:Date.now(),id:s},s):(r||s)&&console.error("sessionStateSnapshot and instanceId must be provided together")})}async pruneSessions(){await this.tx("readwrite",[ze.SessionState],async e=>{const n=e.objectStore(ze.SessionState),s=(await n.getAll()).sort((i,o)=>i.updatedAt-o.updatedAt);if(s.length<10){await e.done;return}const r=s.slice(0,s.length-10);for(const{id:i}of r)await n.delete(i)})}async getAsset(e){return await this.tx("readonly",[ze.Assets],async n=>await n.objectStore(ze.Assets).get(e))}async storeAsset(e,n){await this.tx("readwrite",[ze.Assets],async s=>{await s.objectStore(ze.Assets).put(n,e)})}async removeAssets(e){await this.tx("readwrite",[ze.Assets],async n=>{const s=n.objectStore(ze.Assets);for(const r of e)await s.delete(r)})}}function by(){const t=JSON.parse(gm(hT)||"[]")??[];return Array.isArray(t)?t:[]}function AF(t){const e=new Set(by());e.add(t),mm(hT,JSON.stringify([...e]))}function MF(){window.alert(`Oops! We could not save changes to your browser's storage. We now need to reload the page and try again.

Keep seeing this message?
• If you're using tldraw in a private or "incognito" window, try loading tldraw in a regular window or in a different browser.
• If your hard disk is full, try clearing up some space and then reload the page.`)}function jF(){window.alert(`Oops! We could not access your browser's storage—and the app won't work correctly without that. We now need to reload the page and try again.

Keep seeing this message?
• If you're using tldraw in a private or "incognito" window, try loading tldraw in a regular window or in a different browser.`)}const DF=350,OF=1e4,Ww=Symbol("UPDATE_INSTANCE_STATE"),LF=t=>t;class RF{onmessage;constructor(e){}postMessage(e){}close(){}}const FF=typeof BroadcastChannel>"u"?RF:BroadcastChannel;class BF{constructor(e,{persistenceKey:n,sessionId:s=jd,onLoad:r,onLoadError:i},o=new FF(`tldraw-tab-sync-${n}`)){this.store=e,this.channel=o,typeof window<"u"&&(window.tlsync=this),this.persistenceKey=n,this.sessionId=s,this.db=new _c(n),this.disposables.add(()=>this.db.close()),this.serializedSchema=this.store.schema.serialize(),this.$sessionStateSnapshot=ay(this.store),this.disposables.add(e.listen(({changes:a})=>{this.diffQueue.push(a),this.channel.postMessage(LF({type:"diff",storeId:this.store.id,changes:a,schema:this.serializedSchema})),this.schedulePersist()},{source:"user",scope:"document"})),this.disposables.add(e.listen(()=>{this.diffQueue.push(Ww),this.schedulePersist()},{scope:"session"})),this.connect(r,i),this.documentTypes=new Set(Object.values(this.store.schema.types).filter(a=>a.scope==="document").map(a=>a.typeName))}disposables=new Set;diffQueue=[];didDispose=!1;shouldDoFullDBWrite=!0;isReloading=!1;persistenceKey;sessionId;serializedSchema;isDebugging=!1;documentTypes;$sessionStateSnapshot;db;initTime=Date.now();debug(...e){this.isDebugging&&console.debug(...e)}async connect(e,n){this.debug("connecting");let s;try{s=await this.db.load({sessionId:this.sessionId})}catch(r){n(r),jF();return}if(this.debug("loaded data from store",s,"didDispose",this.didDispose),!this.didDispose)try{if(s){const r=Object.fromEntries(s.records.map(c=>[c.id,c])),i=s.sessionStateSnapshot??fL(r),o=this.store.schema.migrateStoreSnapshot({store:r,schema:s.schema??this.store.schema.serializeEarliestVersion()});if(o.type==="error"){console.error("failed to migrate store",o),n(new Error(`Failed to migrate store: ${o.reason}`));return}const a=Object.values(o.value).filter(c=>this.documentTypes.has(c.typeName));a.length>0&&this.store.mergeRemoteChanges(()=>{this.store.put(a,"initialize")}),i&&Eg(this.store,i,{forceOverwrite:!0})}this.channel.onmessage=({data:r})=>{this.debug("got message",r);const i=r,o=this.store.schema.getMigrationsSince(i.schema);if(o.ok){if(o.value.length>0){this.debug("telling them to reload"),this.channel.postMessage({type:"announce",schema:this.serializedSchema}),this.shouldDoFullDBWrite=!0,this.persistIfNeeded();return}}else{if(Date.now()-this.initTime<5e3){n(new Error("Schema mismatch, please close other tabs and reload the page"));return}this.debug("reloading"),this.isReloading=!0,window?.location?.reload?.();return}i.type==="diff"&&(this.debug("applying diff"),xs(()=>{this.store.mergeRemoteChanges(()=>{this.store.applyDiff(i.changes)})}))},this.channel.postMessage({type:"announce",schema:this.serializedSchema}),this.disposables.add(()=>{this.channel.close()}),e(this)}catch(r){if(this.debug("error loading data from store",r),this.didDispose)return;n(r);return}}close(){this.debug("closing"),this.didDispose=!0,this.disposables.forEach(e=>e())}isPersisting=!1;didLastWriteError=!1;scheduledPersistTimeout=null;schedulePersist(){this.debug("schedulePersist",this.scheduledPersistTimeout),!this.scheduledPersistTimeout&&(this.scheduledPersistTimeout=setTimeout(()=>{this.scheduledPersistTimeout=null,this.persistIfNeeded()},this.didLastWriteError?OF:DF))}persistIfNeeded(){this.debug("persistIfNeeded",{isPersisting:this.isPersisting,isReloading:this.isReloading,shouldDoFullDBWrite:this.shouldDoFullDBWrite,diffQueueLength:this.diffQueue.length,storeIsPossiblyCorrupt:this.store.isPossiblyCorrupted()}),this.scheduledPersistTimeout&&(clearTimeout(this.scheduledPersistTimeout),this.scheduledPersistTimeout=null),!this.isPersisting&&(this.isReloading||this.store.isPossiblyCorrupted()||(this.shouldDoFullDBWrite||this.diffQueue.length>0)&&this.doPersist())}async doPersist(){if(le(!this.isPersisting,"persist already in progress"),this.didDispose)return;this.isPersisting=!0,this.debug("doPersist start");const e=this.diffQueue;this.diffQueue=[];try{if(this.shouldDoFullDBWrite)this.shouldDoFullDBWrite=!1,await this.db.storeSnapshot({schema:this.store.schema,snapshot:this.store.serialize(),sessionId:this.sessionId,sessionStateSnapshot:this.$sessionStateSnapshot.get()});else{const n=Nm(e.filter(s=>s!==Ww));await this.db.storeChanges({changes:n,schema:this.store.schema,sessionId:this.sessionId,sessionStateSnapshot:this.$sessionStateSnapshot.get()})}this.didLastWriteError=!1}catch(n){this.shouldDoFullDBWrite=!0,this.didLastWriteError=!0,console.error("failed to store changes in indexed db",n),MF(),typeof window<"u"&&window.location.reload()}this.isPersisting=!1,this.debug("doPersist end"),this.schedulePersist()}}function fT(t){const e=v.useRef(t),[n,s]=v.useState(t);n!==e.current&&s(e.current);const r=v.useCallback(i=>{typeof i=="function"?e.current=i(e.current):e.current=i,s(e.current)},[]);return[n,r]}function zF(t){const[e,n]=fT({status:"loading"});return t=ma(t),v.useEffect(()=>{const{persistenceKey:s,sessionId:r,...i}=t;if(!s){n({status:"not-synced",store:Ld(i)});return}n({status:"loading"});const o=new dn,a={upload:async(d,p)=>(await u.db.storeAsset(d.id,p),{src:d.id}),resolve:async d=>d.props.src?d.props.src.startsWith("asset:")?await o.get(d,async()=>{const p=await u.db.getAsset(d.id);return p?URL.createObjectURL(p):null}):d.props.src:null,remove:async d=>{await u.db.removeAssets(d)},...i.assets},c=Ld({...i,assets:a});let l=!1;const u=new BF(c,{sessionId:r,persistenceKey:s,onLoad(){l||n({store:c,status:"synced-local"})},onLoadError(d){l||n({status:"error",error:d})}});return()=>{l=!0,u.close()}},[t,n]),e}function $F(){const t=z();v.useLayoutEffect(()=>is("stateAttribute",()=>{const e=t.getContainer(),n=t.getInstanceState();e.setAttribute("data-state",t.getPath()),e.setAttribute("data-coarse",String(n.isCoarsePointer))}),[t])}function NF(){const t=z(),e=Lt();v.useEffect(()=>{const n=i=>e.style.setProperty("--tl-zoom",i.toString()),s=Gd(n,100),r=new fo("useZoomCss",()=>n(t.getEfficientZoomLevel()));return r.attach(),r.execute(),()=>{r.detach(),s.cancel()}},[t,e])}function Rg(t){const e=new ArrayBuffer(t.length),n=new Uint8Array(e);for(let s=0,r=t.length;s<r;s++)n[s]=t.charCodeAt(s);return e}function UF(t){const e=atob(t),n=Rg(e);return crypto.subtle.importKey("spki",new Uint8Array(n),{name:"ECDSA",namedCurve:"P-256"},!0,["verify"])}const HF=30,hr={ANNUAL_LICENSE:1,PERPETUAL_LICENSE:2,INTERNAL_LICENSE:4,WITH_WATERMARK:8,EVALUATION_LICENSE:16,NATIVE_LICENSE:32},KF=Math.max(...Object.values(hr)),Xa={ID:0,HOSTS:1,FLAGS:2,EXPIRY_DATE:3},WF=Object.keys(Xa).length,_o="sales@tldraw.com",qF=`${Bt()}/watermarks/watermark-track.svg`;class vu{publicKey="MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEHJh0uUfxHtCGyerXmmatE368Hd9rI6LH9oPDQihnaCryRFWEVeOvf9U/SPbyxX74LFyJs5tYeAHq5Nc0Ax25LQ";isDevelopment;isTest;isCryptoAvailable;state=je("license state","pending");verbose=!0;constructor(e,n){this.isTest=!1,this.isDevelopment=this.getIsDevelopment(),this.publicKey=n||this.publicKey,this.isCryptoAvailable=!!crypto.subtle,this.getLicenseFromKey(e).then(s=>{const r=GF(s,i=>this.outputMessages(i),this.isDevelopment);this.maybeTrack(s,r),this.state.set(r)}).catch(s=>{console.error("License validation failed:",s),this.state.set("unlicensed")})}getIsDevelopment(){return!["https:","vscode-webview:"].includes(window.location.protocol)||window.location.hostname==="localhost"||!1}getTrackType(e,n){return n==="unlicensed-production"?"unlicensed":this.isDevelopment||!e.isLicenseParseable?null:e.isEvaluationLicense?"evaluation":n==="licensed-with-watermark"?"with_watermark":null}maybeTrack(e,n){const s=this.getTrackType(e,n);if(!s)return;const r=new URL(qF);if(r.searchParams.set("version",iy),r.searchParams.set("license_type",s),"license"in e){r.searchParams.set("license_id",e.license.id);const i=this.isFlagEnabled(e.license.flags,hr.EVALUATION_LICENSE)?"evaluation":this.isFlagEnabled(e.license.flags,hr.ANNUAL_LICENSE)?"annual":this.isFlagEnabled(e.license.flags,hr.PERPETUAL_LICENSE)?"perpetual":"unknown";r.searchParams.set("sku",i)}r.searchParams.set("url",window.location.href),r.searchParams.set("environment","production"),fetch(r.toString())}async extractLicenseKey(e){const[n,s]=e.split("."),[r,i]=n.split("/");if(!r.startsWith("tldraw-"))throw new Error(`Unsupported prefix '${r}'`);const o=await UF(this.publicKey);let a;try{a=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},o,new Uint8Array(Rg(atob(s))),new Uint8Array(Rg(atob(i))))}catch(l){throw console.error(l),new Error("Could not perform signature validation")}if(!a)throw new Error("Invalid signature");let c;try{c=JSON.parse(atob(i))}catch{throw new Error("Could not parse object")}return c.length>WF&&this.outputMessages(["License key contains some unknown properties.","You may want to update tldraw packages to a newer version to get access to new functionality."]),{id:c[Xa.ID],hosts:c[Xa.HOSTS],flags:c[Xa.FLAGS],expiryDate:c[Xa.EXPIRY_DATE]}}async getLicenseFromKey(e){if(!e)return this.isDevelopment||this.outputNoLicenseKeyProvided(),{isLicenseParseable:!1,reason:"no-key-provided"};if(this.isDevelopment&&!this.isCryptoAvailable)return this.verbose&&(console.log("tldraw: you seem to be in a development environment that does not support crypto. License not verified."),console.log("You should check that this works in production separately.")),{isLicenseParseable:!1,reason:"has-key-development-mode"};let n=e.replace(/[\u200B-\u200D\uFEFF]/g,"");n=n.replace(/\r?\n|\r/g,"");try{const s=await this.extractLicenseKey(n),r=new Date(s.expiryDate),i=this.isFlagEnabled(s.flags,hr.ANNUAL_LICENSE),o=this.isFlagEnabled(s.flags,hr.PERPETUAL_LICENSE),a=this.isFlagEnabled(s.flags,hr.EVALUATION_LICENSE),c=this.getDaysSinceExpiry(r),l={license:s,isLicenseParseable:!0,isDevelopment:this.isDevelopment,isDomainValid:this.isDomainValid(s),expiryDate:r,isAnnualLicense:i,isAnnualLicenseExpired:i&&this.isAnnualLicenseExpired(r),isPerpetualLicense:o,isPerpetualLicenseExpired:o&&this.isPerpetualLicenseExpired(r),isInternalLicense:this.isFlagEnabled(s.flags,hr.INTERNAL_LICENSE),isNativeLicense:this.isNativeLicense(s),isLicensedWithWatermark:this.isFlagEnabled(s.flags,hr.WITH_WATERMARK),isEvaluationLicense:a,isEvaluationLicenseExpired:a&&this.isEvaluationLicenseExpired(r),daysSinceExpiry:c};return this.outputLicenseInfoIfNeeded(l),l}catch(s){return this.outputInvalidLicenseKey(s.message),{isLicenseParseable:!1,reason:"invalid-license-key"}}}isDomainValid(e){const n=window.location.hostname.toLowerCase();return e.hosts.some(s=>{const r=s.toLowerCase().trim();if(r===n||`www.${r}`===n||r===`www.${n}`||s==="*")return!0;if(this.isNativeLicense(e))return new RegExp(r).test(window.location.href);if(s.includes("*")){const i=new RegExp(s.replace(/\*/g,".*?"));return i.test(n)||i.test(`www.${n}`)}if(window.location.protocol==="vscode-webview:"){const o=new URL(window.location.href).searchParams.get("extensionId");if(r===o)return!0}return!1})}isNativeLicense(e){return this.isFlagEnabled(e.flags,hr.NATIVE_LICENSE)}getExpirationDateWithoutGracePeriod(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate())}getExpirationDateWithGracePeriod(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate()+HF+1)}isAnnualLicenseExpired(e){const n=this.getExpirationDateWithGracePeriod(e);return new Date>=n}isPerpetualLicenseExpired(e){const n=this.getExpirationDateWithGracePeriod(e),s={major:new Date(gw.major),minor:new Date(gw.minor)};return s.major>=n||s.minor>=n}getDaysSinceExpiry(e){const n=new Date,s=this.getExpirationDateWithoutGracePeriod(e),r=n.getTime()-s.getTime(),i=Math.floor(r/(1e3*60*60*24));return Math.max(0,i)}isEvaluationLicenseExpired(e){const n=new Date,s=this.getExpirationDateWithoutGracePeriod(e);return n>=s}isFlagEnabled(e,n){return(e&n)===n}outputNoLicenseKeyProvided(){}outputInvalidLicenseKey(e){this.outputMessages(["Invalid tldraw license key",`Reason: ${e}`])}outputLicenseInfoIfNeeded(e){e.license.flags>=KF*2&&this.outputMessages(["Warning: This tldraw license contains some unknown flags.","This will still work, however, you may want to update tldraw packages to a newer version to get access to new functionality."],"warning")}outputMessages(e,n="error"){if(!this.isTest&&this.verbose){this.outputDelimiter();for(const s of e){const r=n==="warning"?"orange":"crimson",i=n==="warning"?"orange":"crimson";console.log(`%c${s}`,`color: ${r}; background: ${i}; padding: 2px; border-radius: 3px;`)}this.outputDelimiter()}}outputDelimiter(){console.log("%c-------------------------------------------------------------------","color: white; background: crimson; padding: 2px; border-radius: 3px;")}static className="tl-watermark_SEE-LICENSE"}function GF(t,e,n){if(!t.isLicenseParseable)return n?"unlicensed":(t.reason==="no-key-provided"?e(["No tldraw license key provided!","A license is required for production deployments.",`Please reach out to ${_o} to purchase a license.`]):e(["Invalid license key. tldraw requires a valid license for production use.",`Please reach out to ${_o} to purchase a license.`]),"unlicensed-production");if(!t.isDomainValid&&!t.isDevelopment)return e(["License key is not valid for this domain.","A license is required for production deployments.",`Please reach out to ${_o} to purchase a license.`]),"unlicensed-production";if(t.isEvaluationLicense)return t.isEvaluationLicenseExpired?(e(["Your tldraw evaluation license has expired!",`Please reach out to ${_o} to purchase a full license.`]),"expired"):"licensed";if(t.isPerpetualLicenseExpired||t.isAnnualLicenseExpired)return e(["Your tldraw license has been expired for more than 30 days!",`Please reach out to ${_o} to renew your license.`]),"expired";const s=t.daysSinceExpiry;return s>0&&!t.isEvaluationLicense?(e(["Your tldraw license has expired.",`License expired ${s} days ago.`,`Please reach out to ${_o} to renew your license.`]),"licensed"):t.isLicensedWithWatermark?"licensed-with-watermark":"licensed"}var Co={};const gT=v.createContext({}),YF=()=>v.useContext(gT);function qw(t){return t==="expired"||t==="unlicensed-production"}const VF=5e3;function XF({licenseKey:t=JF()??void 0,children:e}){const[n]=v.useState(()=>new vu(t)),s=$(n.state),[r,i]=v.useState(!0);return v.useEffect(()=>{if(qw(s)&&r){const o=setTimeout(()=>{i(!1)},VF);return()=>clearTimeout(o)}},[s,r]),qw(s)&&!r?h.jsx(ZF,{}):h.jsx(gT.Provider,{value:n,children:e})}function ZF(){return h.jsx("div",{"data-testid":"tl-license-expired",style:{display:"none"}})}let Fl;function JF(){return Fl!==void 0||(Fl=js(()=>Co.TLDRAW_LICENSE_KEY)||js(()=>Co.NEXT_PUBLIC_TLDRAW_LICENSE_KEY)||js(()=>Co.REACT_APP_TLDRAW_LICENSE_KEY)||js(()=>Co.GATSBY_TLDRAW_LICENSE_KEY)||js(()=>Co.VITE_TLDRAW_LICENSE_KEY)||js(()=>Co.PUBLIC_TLDRAW_LICENSE_KEY)||js(()=>{})||js(()=>{})||js(()=>{})||js(()=>{})||js(()=>{})||js(()=>{})||null),Fl}function js(t){try{return t()}catch{return}}function Ir(t){if(!t)throw Error("usePassThroughWheelEvents must be passed a ref");const e=Lt(),n=Tt();v.useEffect(()=>{function s(i){if(!n?.getInstanceState().isFocused||i.isSpecialRedispatchedEvent)return;const o=t.current;if(o&&o.scrollHeight>o.clientHeight)return;Pe(i);const a=e.querySelector(".tl-canvas");if(!a)return;const c=new WheelEvent("wheel",i);c.isSpecialRedispatchedEvent=!0,a.dispatchEvent(c)}const r=t.current;if(r)return r.addEventListener("wheel",s,{passive:!1}),()=>{r.removeEventListener("wheel",s)}},[e,n,t])}const QF='<svg xmlns="http://www.w3.org/2000/svg" width="3001" height="1000" fill="none"><path fill="#000" d="M590.656 300.449c0 49.706-40.294 90-90 90-49.705 0-90-40.294-90-90 0-49.705 40.295-90 90-90 49.706 0 90 40.295 90 90M569.431 719.011c-15.247 32.821-56.006 91.589-98.338 91.438-32.004-.115-38.642-30.904-17.414-50.856 17.381-16.337 28.246-48.075 31.995-72.719.415-2.728-1.556-5.197-4.272-5.679-39.666-7.04-70.746-40.877-70.746-83.417 0-48.23 38.983-87.329 87.07-87.329 39.936 0 70.172 22.237 83.369 52.397 18.839 43.055 7.117 115.733-11.664 156.165M2613.29 385.681V239.319c0-11.363 9.22-20.569 20.59-20.569h8.26c11.37 0 20.59 9.206 20.59 20.569v36.911c0 8.629 7 15.625 15.63 15.625h35.25c8.63 0 15.63-6.996 15.63-15.625v-36.911c0-11.363 9.22-20.569 20.59-20.569h8.17c11.37 0 20.59 9.206 20.59 20.569v146.362c0 11.363-9.22 20.569-20.59 20.569h-8.17c-11.37 0-20.59-9.206-20.59-20.569v-36.999c0-8.63-7-15.625-15.63-15.625h-35.25c-8.63 0-15.63 6.995-15.63 15.625v36.999c0 11.363-9.22 20.569-20.59 20.569h-8.26c-11.37 0-20.59-9.206-20.59-20.569M2391.97 239.319v146.362c0 11.348-9.16 20.569-20.49 20.569h-8.2c-11.33 0-20.49-9.221-20.49-20.569V239.319c0-11.348 9.16-20.569 20.49-20.569h8.2c11.33 0 20.49 9.221 20.49 20.569M2098.23 391.43l-42.69-146.361c-3.85-13.171 6.06-26.319 19.79-26.319h10.6c9.59 0 17.93 6.611 20.08 15.952l17.01 73.045c1.48 6.348 10.47 6.478 12.14.176l19.47-73.838c2.38-9.04 10.57-15.335 19.93-15.335h12.1c9.37 0 17.56 6.3 19.94 15.346l19.49 74.067c1.66 6.305 10.65 6.178 12.13-.171l17.09-73.294c2.15-9.339 10.49-15.948 20.08-15.948h10.53c13.72 0 23.63 13.141 19.79 26.31l-42.63 146.361c-2.56 8.789-10.63 14.829-19.79 14.829h-15.68c-9.12 0-17.16-5.98-19.76-14.709l-21.17-71.059c-1.77-5.948-10.19-5.957-11.97-.012l-21.33 71.071c-2.6 8.729-10.64 14.709-19.76 14.709h-15.59c-9.17 0-17.23-6.035-19.8-14.82M2443.23 218.75h118.59c11.38 0 20.62 9.195 20.62 20.557s-9.24 20.556-20.62 20.556h-24.79c-5.53 0-10 4.477-10 10v115.818c0 11.368-9.25 20.569-20.63 20.569h-7.65c-11.39 0-20.63-9.201-20.63-20.569V269.863c0-5.523-4.48-10-10-10h-24.89c-11.37 0-20.61-9.195-20.61-20.556s9.24-20.557 20.61-20.557M1174.15 218.75h24.64c8.35 0 15.88 5.042 19.04 12.764l34.61 83.942c2.13 5.161 9.44 5.155 11.56-.01l34.43-83.932a20.58 20.58 0 0 1 19.04-12.764h24.64c11.37 0 20.58 9.208 20.58 20.569v146.362c0 11.361-9.21 20.569-20.58 20.569h-7.09c-11.36 0-20.58-9.208-20.58-20.569l-.12-50.645c-.01-6.888-9.53-8.688-12.06-2.283l-23.46 59.332a20.57 20.57 0 0 1-19.14 13.009h-3.03a20.57 20.57 0 0 1-19.15-13.046l-23.47-59.68c-2.52-6.416-12.05-4.623-12.06 2.271l-.13 51.042c0 11.361-9.21 20.569-20.57 20.569h-7.1c-11.36 0-20.57-9.208-20.57-20.569V239.319c0-11.361 9.21-20.569 20.57-20.569"/><path fill="#000" fill-rule="evenodd" d="m1449.94 391.836 6.12-19.392a6.255 6.255 0 0 1 5.96-4.369l50.22-.061a6.24 6.24 0 0 1 5.96 4.348l6.23 19.486c2.71 8.581 10.71 14.402 19.74 14.402h9.34c14.13 0 24.15-13.791 19.61-27.151l-49.74-146.361c-2.85-8.37-10.74-13.988-19.61-13.988h-33.16c-8.87 0-16.77 5.618-19.61 13.988l-49.74 146.361c-4.54 13.36 5.48 27.151 19.61 27.151h9.32c9.04 0 17.04-5.827 19.75-14.414m31.1-98.858c1.85-5.807 10.08-5.796 11.91.016l8.83 27.916c1.28 4.028-1.73 8.134-5.96 8.134h-17.74c-4.23 0-7.24-4.119-5.95-8.151zM1681.81 406.25c18.91 0 35.39-3.686 49.36-11.168 13.97-7.544 24.73-18.394 32.24-32.489 7.56-14.105 11.29-30.866 11.29-50.182 0-19.256-3.73-35.957-11.29-50.004-7.57-14.094-18.35-24.912-32.32-32.397-13.91-7.545-30.4-11.26-49.37-11.26h-49.5c-11.38 0-20.63 9.201-20.63 20.569v146.362c0 11.368 9.25 20.569 20.63 20.569zm23.13-47.701c-6.62 3.215-14.85 4.886-24.79 4.886-10.49 0-19-8.507-19-19v-64.34c0-10.149 8.23-18.376 18.38-18.376 10.18 0 18.56 1.703 25.23 4.974 6.59 3.149 11.63 8.315 15.08 15.633 3.45 7.269 5.28 17.268 5.28 30.162 0 12.891-1.82 22.951-5.28 30.347-3.39 7.319-8.36 12.509-14.9 15.714" clip-rule="evenodd"/><path fill="#000" d="M1804.21 385.681V239.319c0-11.361 9.21-20.569 20.58-20.569h91.28c11.36 0 20.57 9.202 20.57 20.557s-9.21 20.556-20.57 20.556h-54.64a7.807 7.807 0 0 0-7.81 7.813v16.366a7.806 7.806 0 0 0 7.81 7.812h48.13c11.37 0 20.58 9.246 20.58 20.602s-9.21 20.601-20.58 20.601h-48.13a7.806 7.806 0 0 0-7.81 7.812v16.455a7.807 7.807 0 0 0 7.81 7.813h54.64c11.36 0 20.57 9.202 20.57 20.556s-9.21 20.557-20.57 20.557h-91.28c-11.37 0-20.58-9.208-20.58-20.569"/><path fill="#000" fill-rule="evenodd" d="M2875.5 68.75h-2750c-31.066 0-56.25 25.184-56.25 56.25v750c0 31.066 25.184 56.25 56.25 56.25h2750c31.07 0 56.25-25.184 56.25-56.25V125c0-31.066-25.18-56.25-56.25-56.25M125.5 0C56.464 0 .5 55.964.5 125v750c0 69.036 55.965 125 125 125h2750c69.04 0 125-55.964 125-125V125c0-69.036-55.96-125-125-125z" clip-rule="evenodd"/><path fill="#000" d="M2476.06 804.813c-10.54 0-19.82-6.947-22.81-17.068L2390.79 575.7c-4.49-15.248 6.92-30.534 22.8-30.534h27.75c11.1 0 20.72 7.686 23.18 18.52L2489 671.402c2.07 9.093 14.93 9.321 17.32.308l28.83-108.844c2.76-10.435 12.19-17.7 22.98-17.7h25.17c10.8 0 20.25 7.293 22.99 17.755l28.27 107.739c2.36 9.001 15.18 8.829 17.3-.232l25.01-106.888c2.51-10.763 12.1-18.374 23.14-18.374h27.87c15.88 0 27.29 15.286 22.8 30.534l-62.46 212.045a23.78 23.78 0 0 1-22.81 17.068h-32.12c-10.39 0-19.58-6.763-22.69-16.696l-32.08-102.694c-2.62-8.397-14.51-8.331-17.04.095l-30.74 102.346c-3.02 10.061-12.27 16.949-22.76 16.949zM1742.44 804.813h-75.81c-13.09 0-23.71-10.656-23.71-23.801V568.967c0-13.145 10.62-23.801 23.71-23.801h74.8c26.6 0 49.59 5.198 68.95 15.594 19.45 10.312 34.44 25.187 44.96 44.627 10.61 19.355 15.91 42.556 15.91 69.602q0 40.57-15.78 69.73c-10.53 19.355-25.43 34.231-44.71 44.627-19.28 10.311-42.05 15.467-68.32 15.467m-29.3-83.642c0 13.145 10.61 23.801 23.71 23.801h3.06c12.8 0 23.7-2.07 32.71-6.212 9.09-4.141 16-11.283 20.71-21.426q7.2-15.213 7.2-42.345 0-27.13-7.32-42.344c-4.8-10.143-11.87-17.285-21.22-21.426-9.26-4.142-20.63-6.212-34.1-6.212h-1.04c-13.1 0-23.71 10.656-23.71 23.801zM1460.86 804.813c-13.12 0-23.76-10.656-23.76-23.801V568.967c0-13.145 10.64-23.801 23.76-23.801h22.84c13.13 0 23.76 10.656 23.76 23.801v155.247c0 13.145 10.64 23.801 23.76 23.801h57.27c13.12 0 23.76 10.656 23.76 23.801v9.196c0 13.145-10.64 23.801-23.76 23.801zM1204.45 601.964c-13.13 0-23.77-10.656-23.77-23.801v-9.196c0-13.145 10.64-23.801 23.77-23.801h177.89c13.13 0 23.78 10.656 23.78 23.801v9.196c0 13.145-10.65 23.801-23.78 23.801h-39.38c-8.21 0-14.86 6.66-14.86 14.875v164.173c0 13.145-10.64 23.801-23.78 23.801h-21.85c-13.13 0-23.78-10.656-23.78-23.801V616.839c0-8.215-6.65-14.875-14.86-14.875z"/><path fill="#000" fill-rule="evenodd" d="M2223.05 787.891c-3.02 10.047-12.27 16.922-22.74 16.922h-25.43c-16.19 0-27.64-15.862-22.57-31.261l69.88-212.045c3.21-9.753 12.31-16.341 22.56-16.341h61.84c10.25 0 19.35 6.588 22.56 16.341l69.87 212.045c5.08 15.399-6.37 31.261-22.56 31.261h-25.43c-10.48 0-19.72-6.875-22.74-16.922l-6.7-22.2a14.84 14.84 0 0 0-14.21-10.576h-63.42c-6.55 0-12.32 4.296-14.22 10.576zm76.13-96.945-14.13-48.436c-2.46-8.451-14.36-8.602-17.04-.217l-15.46 48.436c-1.84 5.759 2.45 11.645 8.48 11.645h29.6c5.94 0 10.22-5.715 8.55-11.428" clip-rule="evenodd"/><path fill="#000" d="M1939.6 804.813c-13.13 0-23.77-10.656-23.77-23.801V568.967c0-13.145 10.64-23.801 23.77-23.801h88.13c19.24 0 36.08 3.508 50.51 10.523s25.65 17.115 33.67 30.3q12.03 19.779 12.03 47.416c0 18.595-4.14 34.273-12.41 47.036-7.64 11.913-18.18 21.101-31.63 27.564-16.98 8.159-36 11.104-54.7 11.104h-43.07c-76.56 0 4.08-135.84 4.08-84.706v7.996c0 12.117 9.81 21.941 21.91 21.941 8.12 0 16.3-.345 24.04-3.043 5.91-2.113 10.43-5.451 13.55-10.015 3.2-4.565 4.81-10.523 4.81-17.877 0-7.437-1.61-13.481-4.81-18.129-3.12-4.733-7.64-8.199-13.55-10.396-7.05-2.766-14.67-3.423-22.18-3.423-13.13 0-23.77 10.656-23.77 23.801v47.71c0 11.825 11.14 16.003 19.91 20.752 12.31 6.671 7.58 25.389-6.42 25.389-7.45 0-13.49 6.048-13.49 13.508v48.395c0 13.145-10.63 23.801-23.76 23.801zm134.89-106.758 5.41 9.95 33.51 61.622c8.62 15.86-2.84 35.186-20.87 35.186h-22.27c-8.74 0-16.77-4.798-20.92-12.496l-35.05-65.04a15.52 15.52 0 0 0-13.66-8.168c-42.24 0 40.62-82.154 73.85-21.054M931.652 0h68.748v1000h-68.748z"/></svg>',e5='<svg xmlns="http://www.w3.org/2000/svg" width="400" height="1601" fill="none"><path fill="#000" d="M72 1319.8c0-10.73 7.071-20.18 17.372-23.22l215.823-63.62c15.519-4.57 31.078 7.05 31.078 23.22v28.26c0 11.31-7.824 21.1-18.85 23.61l-109.636 24.94c-9.254 2.1-9.487 15.2-.313 17.63l110.784 29.37a24.21 24.21 0 0 1 18.015 23.4v25.64c0 11-7.423 20.62-18.071 23.41l-109.659 28.79c-9.162 2.41-8.986 15.47.236 17.63l108.792 25.46c10.955 2.56 18.702 12.33 18.702 23.57v28.39c0 16.17-15.559 27.79-31.078 23.22l-215.823-63.62c-10.3-3.04-17.372-12.49-17.372-23.22v-32.72c0-10.59 6.883-19.95 16.994-23.11l104.523-32.67c8.547-2.67 8.479-14.79-.096-17.36l-104.17-31.3C79.01 1372.42 72 1363 72 1352.31zM72 572.638V495.43c0-13.336 10.846-24.147 24.225-24.147h215.823c13.379 0 24.225 10.811 24.225 24.147v76.179q0 40.645-15.872 70.228-15.743 29.712-45.422 45.79-29.55 16.206-70.843 16.206-41.292 0-70.971-16.078-29.55-16.077-45.422-45.532Q72 612.767 72 572.638m85.132-29.84c-13.379 0-24.225 10.81-24.225 24.146v3.122q0 19.55 6.323 33.313 6.323 13.89 21.807 21.094 15.485 7.332 43.099 7.331t43.1-7.46q15.484-7.33 21.807-21.608 6.323-14.15 6.323-34.728v-1.064c0-13.336-10.846-24.146-24.225-24.146zM72 285.858c0-13.363 10.846-24.197 24.225-24.197h215.823c13.379 0 24.225 10.834 24.225 24.197v23.27c0 13.364-10.846 24.197-24.225 24.197H154.035c-13.379 0-24.225 10.834-24.225 24.197v58.328c0 13.364-10.846 24.197-24.225 24.197h-9.36C82.845 440.047 72 429.214 72 415.85zM278.463 24.72c0-13.374 10.846-24.216 24.225-24.216h9.36c13.379 0 24.225 10.842 24.225 24.216v181.174c0 13.374-10.846 24.216-24.225 24.216h-9.36c-13.379 0-24.225-10.842-24.225-24.216v-40.108c0-8.359-6.779-15.135-15.141-15.135H96.225c-13.38 0-24.225-10.842-24.225-24.216v-22.256c0-13.374 10.846-24.216 24.225-24.216h167.097c8.362 0 15.141-6.776 15.141-15.135z"/><path fill="#000" fill-rule="evenodd" d="M89.224 1062.13C78.997 1059.04 72 1049.63 72 1038.96v-25.9c0-16.486 16.145-28.147 31.818-22.979l215.823 71.169a24.19 24.19 0 0 1 16.632 22.98v62.97c0 10.45-6.706 19.71-16.632 22.98l-215.823 71.17C88.145 1246.51 72 1234.86 72 1218.37v-25.9c0-10.67 6.997-20.08 17.224-23.17l22.595-6.81a15.13 15.13 0 0 0 10.765-14.48v-64.59a15.13 15.13 0 0 0-10.765-14.48zm98.672 77.53 49.299-14.39c8.601-2.51 8.755-14.62.22-17.35l-49.299-15.75c-5.861-1.88-11.852 2.49-11.852 8.64v30.14c0 6.05 5.817 10.41 11.632 8.71" clip-rule="evenodd"/><path fill="#000" d="M72 773.439c0-13.367 10.846-24.203 24.225-24.203h215.823c13.379 0 24.225 10.836 24.225 24.203v89.762q0 29.395-10.711 51.439-10.71 22.046-30.84 34.293t-48.261 12.248q-28.388 0-47.873-12.635-18.187-11.672-28.056-32.218c-8.303-17.289-11.301-36.661-11.301-55.705v-43.867c0-77.976 138.26 4.16 86.215 4.16h-8.138c-12.334 0-22.332 9.989-22.332 22.311 0 8.269.351 16.6 3.097 24.487q3.225 9.024 10.194 13.794 6.968 4.899 18.194 4.899 11.356 0 18.453-4.899 7.226-4.77 10.581-13.794c2.815-7.188 3.484-14.944 3.484-22.596 0-13.366-10.846-24.202-24.225-24.202h-48.56c-12.036 0-16.288 11.345-21.122 20.272-6.79 12.539-25.841 7.72-25.841-6.536 0-7.586-6.156-13.736-13.749-13.736H96.225C82.845 820.916 72 810.08 72 796.714zm108.66 137.378-10.128 5.511-62.72 34.131C91.67 959.243 72 947.569 72 929.205V906.52a24.2 24.2 0 0 1 12.719-21.299l66.199-35.696a15.82 15.82 0 0 0 8.313-13.921c0-43.012 83.618 41.371 21.429 75.213"/></svg>';function t5(t){return $("watermarkState",()=>t.state.get(),[t])}const n5=`data:image/svg+xml;utf8,${encodeURIComponent(QF)}`,s5=`data:image/svg+xml;utf8,${encodeURIComponent(e5)}`,r5=v.memo(function(){const e=YF(),n=z(),s=$("is mobile",()=>n.getViewportScreenBounds().width<700,[n]),r=t5(e);return["licensed-with-watermark","unlicensed"].includes(r)?h.jsxs(h.Fragment,{children:[h.jsx(a5,{}),h.jsx(o5,{src:s?s5:n5,isUnlicensed:r==="unlicensed"})]}):null}),i5=v.memo(function({isDebugMode:e,isMobile:n}){const s=z(),r=cu(),i=v.useRef(null);Ir(i);const o="https://tldraw.dev/pricing?utm_source=sdk&utm_medium=organic&utm_campaign=watermark";return h.jsx("div",{ref:i,className:vu.className,"data-debug":e,"data-mobile":n,"data-unlicensed":!0,"data-testid":"tl-watermark-unlicensed",draggable:!1,...r,children:h.jsx("button",{draggable:!1,role:"button",onPointerDown:a=>{s.markEventAsHandled(a),Pe(a)},title:"The tldraw SDK requires a license key to work in production. You can get a free 100-day trial license at tldraw.dev/pricing.",onClick:()=>{Vc.openWindow(o,"_blank",!0)},children:"Get a license for production"})})}),o5=v.memo(function({src:e,isUnlicensed:n}){const s=z(),r=$("debug mode",()=>s.getInstanceState().isDebugMode,[s]),i=$("is mobile",()=>s.getViewportScreenBounds().width<700,[s]),o=cu(),a=v.useRef(null);Ir(a);const c=`url('${e}') center 100% / 100% no-repeat`,l="https://tldraw.dev/?utm_source=sdk&utm_medium=organic&utm_campaign=watermark";return n?h.jsx(i5,{isDebugMode:r,isMobile:i}):h.jsx("div",{ref:a,className:vu.className,"data-debug":r,"data-mobile":i,"data-testid":"tl-watermark-licensed",draggable:!1,...o,children:h.jsx("button",{draggable:!1,role:"button",onPointerDown:u=>{s.markEventAsHandled(u),Pe(u)},title:"Build infinite canvas applications with the tldraw SDK. Learn more at https://tldraw.dev.",onClick:()=>{Vc.openWindow(l,"_blank")},style:{mask:c,WebkitMask:c}})})}),a5=v.memo(function(){const e=z(),n=vu.className,s=`
/* ------------------- SEE LICENSE -------------------
The tldraw watermark is part of tldraw's license. It is shown for unlicensed
or "licensed-with-watermark" users. By using this library, you agree to
preserve the watermark's behavior, keeping it visible, unobscured, and
available to user-interaction.

To remove the watermark, please purchase a license at tldraw.dev.
*/

.${n} {
	position: absolute;
	bottom: max(var(--tl-space-2), env(safe-area-inset-bottom));
	right: max(var(--tl-space-2), env(safe-area-inset-right));
	width: 96px;
	height: 32px;
	display: flex;
	align-items: center;
	justify-content: center;
	z-index: var(--tl-layer-watermark) !important;
	background-color: color-mix(in srgb, var(--tl-color-background) 62%, transparent);
	opacity: 1;
	border-radius: 5px;
	pointer-events: all;
	padding: 2px;
	box-sizing: content-box;
}

.${n} > button {
	position: absolute;
	width: 96px;
	height: 32px;
	pointer-events: all;
	cursor: inherit;
	color: var(--tl-color-text);
	opacity: .38;
	border: 0;
	padding: 0;
	background-color: currentColor;
}

.${n}[data-debug='true'] {
	bottom: max(46px, env(safe-area-inset-bottom));
}

.${n}[data-mobile='true'] {
	border-radius: 4px 0px 0px 4px;
	right: max(-2px, calc(env(safe-area-inset-right) - 2px));
	width: 8px;
	height: 48px;
}

.${n}[data-mobile='true'] > button {
	width: 8px;
	height: 32px;
}

.${n}[data-unlicensed='true'] > button {
	font-size: 100px;
	position: absolute;
	pointer-events: all;
	cursor: pointer;
	color: var(--tl-color-text);
	opacity: 0.8;
	border: 0;
	padding: 0;
	background-color: transparent;
	font-size: 11px;
	font-weight: 600;
	text-align: center;
}

.${n}[data-mobile='true'][data-unlicensed='true'] > button {
	display: none;
}

@media (hover: hover) {
	.${n} > button {
		pointer-events: none;
	}

	.${n}:hover {
		background-color: var(--tl-color-background);
		transition: background-color 0.2s ease-in-out;
		transition-delay: 0.32s;
	}

	.${n}:hover > button {
		animation: ${n}_delayed_link 0.2s forwards ease-in-out;
		animation-delay: 0.32s;
	}

	.${n} > button:focus-visible {
		opacity: 1;
	}
}

@keyframes ${n}_delayed_link {
	0% {
		cursor: inherit;
		opacity: .38;
		pointer-events: none;
	}
	100% {
		cursor: pointer;
		opacity: 1;
		pointer-events: all;
	}
}`;return h.jsx("style",{nonce:e.options.nonce,children:s})}),c5=[],l5=[],d5=[],u5="tl-container",h5=v.memo(function({store:e,components:n,className:s,user:r,options:i,...o}){const[a,c]=v.useState(null),l=v.useMemo(()=>r??NP(),[r]),u=n?.ErrorFallback===void 0?AP:n?.ErrorFallback,d={...o,shapeUtils:o.shapeUtils??c5,bindingUtils:o.bindingUtils??l5,tools:o.tools??d5,components:n,options:ma(i)};return h.jsx("div",{ref:c,"data-tldraw":iy,draggable:!1,className:de(`${u5} tl-theme__light`,s),tabIndex:-1,role:"application","aria-label":i?.branding??"tldraw",children:h.jsx(Pc,{fallback:u,onError:p=>pm(p,{tags:{origin:"react.tldraw-before-app"}}),children:a&&h.jsx(XF,{licenseKey:o.licenseKey,children:h.jsx(EP,{container:a,children:h.jsx(T5,{overrides:n,children:e?e instanceof Um?h.jsx(yT,{...d,store:e,user:l}):h.jsx(mT,{...d,store:e,user:l}):h.jsx(p5,{...d,store:e,user:l})})})})})})});function p5(t){const{defaultName:e,snapshot:n,initialData:s,shapeUtils:r,bindingUtils:i,persistenceKey:o,sessionId:a,user:c,assets:l,migrations:u}=t,d=zF({shapeUtils:r,bindingUtils:i,initialData:s,persistenceKey:o,sessionId:a,defaultName:e,snapshot:n,assets:l,migrations:u});return h.jsx(mT,{...t,store:d,user:c})}const mT=v.memo(function({store:e,user:n,...s}){const r=Lt();v.useLayoutEffect(()=>{n.userPreferences.get().colorScheme==="dark"&&(r.classList.remove("tl-theme__light"),r.classList.add("tl-theme__dark"))},[r,n]);const{LoadingScreen:i}=nt();switch(e.status){case"error":throw e.error;case"loading":return i?h.jsx(i,{}):null}return h.jsx(yT,{...s,store:e.store,user:n})}),Xf=()=>document.location.search.includes("tldraw_preserve_focus");function yT({onMount:t,children:e,store:n,tools:s,shapeUtils:r,bindingUtils:i,user:o,initialState:a,autoFocus:c=!0,inferDarkMode:l,cameraOptions:u,textOptions:d,options:p,licenseKey:f,deepLinks:g,getShapeVisibility:x,assetUrls:y}){const{ErrorFallback:m}=nt(),S=Lt(),[w,P]=fT(null),_=v.useRef(null),I=ma(g===!0?{}:g),C=v.useRef({autoFocus:c&&!Xf(),inferDarkMode:l,initialState:a,cameraOptions:u,deepLinks:I});v.useLayoutEffect(()=>{C.current={autoFocus:c&&!Xf(),inferDarkMode:l,initialState:a,cameraOptions:u,deepLinks:I}},[c,l,a,u,I]),v.useLayoutEffect(()=>{const{autoFocus:M,inferDarkMode:L,initialState:U,cameraOptions:V,deepLinks:J}=C.current,Z=new re({store:n,shapeUtils:r,bindingUtils:i,tools:s,getContainer:()=>S,user:o,initialState:U,autoFocus:M,inferDarkMode:L,cameraOptions:V,textOptions:d,options:p,licenseKey:f,getShapeVisibility:x,fontAssetUrls:y?.fonts});return Z.updateViewportScreenBounds(_.current??S),J&&(J?.getUrl?Z.navigateToDeepLink({...J,url:J.getUrl(Z)}):Z.navigateToDeepLink(J)),P(Z),()=>{Z.dispose()}},[i,S,p,r,n,s,o,P,f,x,d,y]),v.useLayoutEffect(()=>{if(w&&I)return w.registerDeepLinkListener(I)},[w,I]),v.useLayoutEffect(()=>{w&&u&&w.setCameraOptions(u)},[w,u]);const E=v.useSyncExternalStore(v.useCallback(M=>w?(w.on("crash",M),()=>w.off("crash",M)):()=>{},[w]),()=>w?.getCrashingError()??null);v.useEffect(function(){if(!w)return;function L(){w&&w.focus()}function U(){w&&w.blur()}if(c&&Xf())return w.getContainer().addEventListener("pointerdown",L),document.body.addEventListener("pointerdown",U),()=>{w.getContainer()?.removeEventListener("pointerdown",L),document.body.removeEventListener("pointerdown",U)}},[w,c]);const[O,k]=v.useState(null);let T=O;w!==T?.editor&&(T=null),v.useLayoutEffect(()=>{if(!w)return;if(w.options.maxFontsToLoadBeforeRender===0){k({editor:w,isLoaded:!0});return}let M=!1;return k({editor:w,isLoaded:!1}),w.fonts.loadRequiredFontsForCurrentPage(w.options.maxFontsToLoadBeforeRender).finally(()=>{M||k({editor:w,isLoaded:!0})}),()=>{M=!0}},[w]);const{Canvas:D,LoadingScreen:R}=nt();return!w||!T?.isLoaded?h.jsxs(h.Fragment,{children:[R&&h.jsx(R,{}),h.jsx("div",{className:"tl-canvas",ref:_})]}):h.jsx(Pc,{fallback:m,onError:M=>w.annotateError(M,{origin:"react.tldraw",willCrashApp:!0}),children:E?h.jsx(g5,{crashingError:E}):h.jsx(sy,{editor:w,children:h.jsxs(f5,{onMount:t,children:[e??(D?h.jsx(D,{},w.contextId):null),h.jsx(r5,{})]})})})}function f5({children:t,onMount:e}){return NF(),uF(),hF(),pF(),$F(),xT(n=>{const s=n.store.props.onMount(n),r=e?.(n);return()=>{s?.(),r?.()}}),t}function g5({crashingError:t}){throw t}function ST({children:t}){return h.jsx("div",{className:"tl-loading","aria-busy":"true",tabIndex:0,children:t})}function xT(t){const e=z(),n=fr(s=>{let r;return s.run(()=>{r=t?.(s),s.emit("mount")},{history:"ignore"}),window.tldrawReady=!0,r});Ye.useLayoutEffect(()=>{if(e)return n?.(e)},[e,n])}const m5=()=>{const{Spinner:t}=nt();return h.jsx(ST,{children:t?h.jsx(t,{}):null})};function bT(t,e=!0){const n=t.length;if(n<2)return"";let s=t[0],r=t[1];if(n===2)return`M${rn(s)}L${rn(r)}`;let i="";for(let o=2,a=n-1;o<a;o++)s=t[o],r=t[o+1],i+=ns(s,r);return e?`M${ns(t[0],t[1])}Q${rn(t[1])}${ns(t[1],t[2])}T${i}${ns(t[n-1],t[0])}${ns(t[0],t[1])}Z`:`M${rn(t[0])}Q${rn(t[1])}${ns(t[1],t[2])}${t.length>3?"T":""}${i}L${rn(t[n-1])}`}function Gw({scribble:t,zoom:e,color:n,opacity:s,className:r}){return t.points.length?h.jsx("svg",{className:r&&de("tl-overlays__item",r),children:h.jsx("path",{className:"tl-scribble",d:bT(t.points,!1),stroke:n??`var(--tl-color-${t.color})`,fill:"none",strokeWidth:8/e,opacity:s??t.opacity})}):null}function y5({bounds:t,rotation:e}){const n=z(),s=v.useRef(null),r=$("only selected shape",()=>n.getOnlySelectedShape(),[n]),i=r?n.getShapeUtil(r).expandSelectionOutlinePx(r):0;return qc(s,t?.x,t?.y,1,e,{x:-i,y:-i}),t=i instanceof X?t.clone().expand(i).zeroFix():t.clone().expandBy(i).zeroFix(),h.jsx("svg",{ref:s,className:"tl-overlays__item tl-selection__fg","data-testid":"selection-foreground",children:h.jsx("rect",{className:de("tl-selection__fg__outline"),width:F(t.width),height:F(t.height)})})}const S5=()=>h.jsx("div",{className:"tl-shape-error-boundary"}),x5=v.memo(({shape:t,util:e})=>Jd("Indicator: "+t.type,()=>e.indicator(e.editor.store.unsafeGetWithoutCapture(t.id))),(t,e)=>t.shape.props===e.shape.props&&t.shape.meta===e.shape.meta),b5=v.memo(({editor:t,id:e})=>{const n=$("shape for indicator",()=>t.store.get(e),[t,e]),{ShapeIndicatorErrorFallback:s}=nt();return!n||n.isLocked?null:h.jsx(Pc,{fallback:s,onError:r=>t.annotateError(r,{origin:"react.shapeIndicator",willCrashApp:!1}),children:h.jsx(x5,{shape:n,util:t.getShapeUtil(n)},n.id)})}),Yw=v.memo(function({shapeId:e,className:n,color:s,hidden:r,opacity:i}){const o=z(),a=v.useRef(null);return Qi("indicator transform",()=>{if(r)return;const c=a.current;if(!c)return;const l=o.getShapePageTransform(e);l&&c.style.setProperty("transform",l.toCssString())},[o,e,r]),v.useLayoutEffect(()=>{const c=a.current;c&&c.style.setProperty("display",r?"none":"block")},[r]),h.jsx("svg",{ref:a,className:de("tl-overlays__item",n),"aria-hidden":"true",children:h.jsx("g",{className:"tl-shape-indicator",stroke:s??"var(--tl-color-selected)",opacity:i,children:h.jsx(b5,{editor:o,id:e})})})}),w5=()=>h.jsx("circle",{cx:4,cy:4,r:8,strokeWidth:"1",stroke:"red"}),wT=v.memo(function({hideAll:e,showAll:n}){const s=z();if(e&&n)throw Error("You cannot set both hideAll and showAll props to true, cmon now");const r=v.useRef(new Set),i=$("should display selected ids",()=>{const c=r.current,l=new Set,u=s.getInstanceState(),d=u.isChangingStyle,p=s.isInAny("select.idle","select.editing_shape"),f=s.isInAny("select.brushing","select.scribble_brushing","select.pointing_shape","select.pointing_selection","select.pointing_handle");if(d||!(p||f))return r.current=l,l;for(const g of s.getSelectedShapeIds())l.add(g);if(p&&u.isHoveringCanvas&&!u.isCoarsePointer){const g=s.getHoveredShapeId();g&&l.add(g)}if(c.size!==l.size)return r.current=l,l;for(const g of l)if(!c.has(g))return r.current=l,l;return c},[s]),o=$("rendering shapes",()=>s.getRenderingShapes(),[s]),{ShapeIndicator:a}=nt();return a?o.map(({id:c})=>h.jsx(a,{shapeId:c,hidden:!n&&(e||!i.has(c))},c+"_indicator")):null}),v5=v.forwardRef(function({children:e,shape:n,isBackground:s,...r},i){const o="fill"in n.props&&n.props.fill!=="none";return h.jsx("div",{ref:i,"data-shape-type":n.type,"data-shape-is-filled":s?void 0:o,"data-shape-id":n.id,draggable:!1,...r,className:de("tl-shape",s&&"tl-shape-background",r.className),children:e})});function P5({points:t,zoom:e}){const n=2.5/e,s=t.reduce((p,f)=>Math.min(p,f.x),1/0),r=t.reduce((p,f)=>Math.max(p,f.x),-1/0),i=t.reduce((p,f)=>Math.min(p,f.y),1/0),o=t.reduce((p,f)=>Math.max(p,f.y),-1/0),a=t.some(p=>p.x===s&&p.y===i);let c,l,u,d;return a?(c=s,l=i,u=r,d=o):(c=s,l=o,u=r,d=i),h.jsxs("g",{className:"tl-snap-indicator",stroke:"lime",children:[h.jsx("line",{x1:c,y1:l,x2:u,y2:d}),t.map((p,f)=>h.jsx("g",{transform:`translate(${p.x},${p.y})`,children:h.jsx("path",{className:"tl-snap-point",d:`M ${-n},${-n} L ${n},${n} M ${-n},${n} L ${n},${-n}`})},f))]})}function I5({gaps:t,direction:e,zoom:n}){const s=3.5/n;let r=[-1/0,1/0],i=null;const o=e==="horizontal";for(const c of t){if(i=Xs(r[0],r[1],o?c.startEdge[0].y:c.startEdge[0].x,o?c.startEdge[1].y:c.startEdge[1].x),i)r=i;else continue;if(i=Xs(r[0],r[1],o?c.endEdge[0].y:c.endEdge[0].x,o?c.endEdge[1].y:c.endEdge[1].x),i)r=i;else continue}if(r===null)return null;const a=(r[0]+r[1])/2;return h.jsx("g",{className:"tl-snap-indicator",stroke:"cyan",children:t.map(({startEdge:c,endEdge:l},u)=>h.jsx(v.Fragment,{children:o?h.jsxs(h.Fragment,{children:[h.jsx("line",{x1:c[0].x,y1:a-2*s,x2:c[1].x,y2:a+2*s}),h.jsx("line",{x1:l[0].x,y1:a-2*s,x2:l[1].x,y2:a+2*s}),h.jsx("line",{x1:c[0].x,y1:a,x2:l[0].x,y2:a}),h.jsx("line",{x1:(c[0].x+l[0].x)/2,y1:a-s,x2:(c[0].x+l[0].x)/2,y2:a+s})]}):h.jsxs(h.Fragment,{children:[h.jsx("line",{x1:a-2*s,y1:c[0].y,x2:a+2*s,y2:c[1].y}),h.jsx("line",{x1:a-2*s,y1:l[0].y,x2:a+2*s,y2:l[1].y}),h.jsx("line",{x1:a,y1:c[0].y,x2:a,y2:l[0].y}),h.jsx("line",{x1:a-s,y1:(c[0].y+l[0].y)/2,x2:a+s,y2:(c[0].y+l[0].y)/2})]})},u))})}function _5({className:t,line:e,zoom:n}){return h.jsx("svg",{className:de("tl-overlays__item",t),"aria-hidden":"true",children:e.type==="points"?h.jsx(P5,{...e,zoom:n}):e.type==="gaps"?h.jsx(I5,{...e,zoom:n}):null})}function vT(t){return h.jsx("svg",{width:16,height:16,viewBox:"0 0 16 16","aria-hidden":"false",...t,className:de("tl-spinner",t.className),children:h.jsxs("g",{strokeWidth:2,fill:"none",fillRule:"evenodd",children:[h.jsx("circle",{strokeOpacity:.25,cx:8,cy:8,r:7,stroke:"currentColor"}),h.jsx("path",{strokeLinecap:"round",d:"M15 8c0-4.5-4.5-7-7-7",stroke:"currentColor"})]})})}const C5=()=>null,PT=v.createContext(null);function T5({overrides:t={},children:e}){const n=ma(t),s=v.useMemo(()=>({Background:kO,Brush:Df,Canvas:H5,CollaboratorBrush:Df,CollaboratorCursor:fw,CollaboratorHint:GO,CollaboratorScribble:Gw,CollaboratorShapeIndicator:Yw,Cursor:fw,Grid:ZO,Handle:JO,Handles:QO,InFrontOfTheCanvas:null,LoadingScreen:m5,OnTheCanvas:null,Overlays:null,Scribble:Gw,SelectionBackground:null,SelectionForeground:y5,ShapeIndicator:Yw,ShapeIndicators:wT,ShapeWrapper:v5,SnapIndicator:_5,Spinner:vT,SvgDefs:C5,ZoomBrush:Df,ErrorFallback:AP,ShapeErrorFallback:S5,ShapeIndicatorErrorFallback:w5,...n}),[n]);return h.jsx(PT.Provider,{value:s,children:e})}function nt(){const t=v.useContext(PT);if(!t)throw new Error("useEditorComponents must be used inside of <EditorComponentsProvider />");return t}const E5=["textarea","input"];function k5(t){const e=z();v.useEffect(()=>{const n=t.current;if(!n)return;const s=r=>{if(r instanceof PointerEvent&&r.pointerType==="pen"){e.markEventAsHandled(r);const{target:i}=r;if(E5.includes(i.tagName?.toLocaleLowerCase())||i.isContentEditable||e.isIn("select.editing_shape"))return;Pe(r)}};return n.addEventListener("touchstart",s),n.addEventListener("touchend",s),()=>{n.removeEventListener("touchstart",s),n.removeEventListener("touchend",s)}},[e,t])}const Vw=10,A5=/Mac|iPod|iPhone|iPad/.test(typeof window>"u"?"node":window.navigator.platform);function IT(t){let{deltaY:e,deltaX:n}=t,s=0;return t.ctrlKey||t.altKey||t.metaKey?s=(Math.abs(e)>Vw?Vw*Math.sign(e):e)/100:t.shiftKey&&!A5&&(n=e,e=0),{x:-n,y:-e,z:-s}}const M5=mk([yk,Sk]);let To;const j5=t=>To===void 0?(To=t,!1):t-To>120&&t-To<160?(To=t,!0):(To=t,!1);function D5(t){const e=z(),n=v.useMemo(()=>{let s="not sure";const r=({event:g})=>{if(!e.getInstanceState().isFocused||(s="not sure",j5(Date.now())))return;const x=e.getEditingShapeId();if(x){const S=e.getShape(x);if(S&&e.getShapeUtil(S).canScroll(S)&&e.getShapePageBounds(x)?.containsPoint(e.inputs.getCurrentPagePoint()))return}Pe(g),g.stopPropagation();const y=IT(g);if(y.x===0&&y.y===0)return;const m={type:"wheel",name:"wheel",delta:y,point:new b(g.clientX,g.clientY),shiftKey:g.shiftKey,altKey:g.altKey,ctrlKey:g.metaKey||g.ctrlKey,metaKey:g.metaKey,accelKey:At(g)};e.dispatch(m)};let i=1,o=1,a=0;const c=new b,l=new b,u=g=>{const x=t.current;s="not sure";const{event:y,origin:m,da:S}=g;y instanceof WheelEvent||(y.target===x||x?.contains(y.target))&&(l.x=m[0],l.y=m[1],c.x=m[0],c.y=m[1],i=S[0],o=e.getZoomLevel(),e.dispatch({type:"pinch",name:"pinch_start",point:{x:m[0],y:m[1],z:e.getZoomLevel()},delta:{x:0,y:0},shiftKey:y.shiftKey,altKey:y.altKey,ctrlKey:y.metaKey||y.ctrlKey,metaKey:y.metaKey,accelKey:At(y)}))},d=g=>{if(g&&(s="zooming"),s==="zooming")return;const x=Math.abs(a-i),y=b.Dist(c,l);switch(s){case"not sure":{x>24?s="zooming":y>16&&(s="panning");break}case"panning":{x>64&&(s="zooming");break}}};return{onWheel:r,onPinchStart:u,onPinchEnd:g=>{const x=t.current,{event:y,origin:m,offset:S}=g;if(y instanceof WheelEvent||!(y.target===x||x?.contains(y.target)))return;const w=S[0]**e.getCameraOptions().zoomSpeed;s="not sure",e.timers.requestAnimationFrame(()=>{e.dispatch({type:"pinch",name:"pinch_end",point:{x:m[0],y:m[1],z:w},delta:{x:m[0],y:m[1]},shiftKey:y.shiftKey,altKey:y.altKey,ctrlKey:y.metaKey||y.ctrlKey,metaKey:y.metaKey,accelKey:At(y)})})},onPinch:g=>{const x=t.current,{event:y,origin:m,offset:S,da:w}=g;if(y instanceof WheelEvent||!(y.target===x||x?.contains(y.target)))return;const P=g.type==="gesturechange"||g.type==="gestureend";a=w[0];const _=m[0]-l.x,I=m[1]-l.y;switch(l.x=m[0],l.y=m[1],d(P),s){case"zooming":{const C=S[0]**e.getCameraOptions().zoomSpeed;e.dispatch({type:"pinch",name:"pinch",point:{x:m[0],y:m[1],z:C},delta:{x:_,y:I},shiftKey:y.shiftKey,altKey:y.altKey,ctrlKey:y.metaKey||y.ctrlKey,metaKey:y.metaKey,accelKey:At(y)});break}case"panning":{e.dispatch({type:"pinch",name:"pinch",point:{x:m[0],y:m[1],z:o},delta:{x:_,y:I},shiftKey:y.shiftKey,altKey:y.altKey,ctrlKey:y.metaKey||y.ctrlKey,metaKey:y.metaKey,accelKey:At(y)});break}}}}},[e,t]);M5(n,{target:t,eventOptions:{passive:!1},pinch:{from:()=>{const{zoomSpeed:s}=e.getCameraOptions();return[e.getZoomLevel()**(1/s),0]},scaleBounds:()=>{const s=e.getBaseZoom(),{zoomSteps:r,zoomSpeed:i}=e.getCameraOptions(),o=r[0]*s;return{max:(r[r.length-1]*s)**(1/i),min:o**(1/i)}}}})}function Zf(t,e,n){const s=t.getShape(e),r=t.getShapeHandles(s);return{shape:s,handle:r.find(i=>i.id===n)}}function O5(t,e){const n=z();return v.useMemo(()=>{const s=c=>{if(n.wasEventAlreadyHandled(c))return;const l=Md(c.currentTarget);Gc(l,c);const{shape:u,handle:d}=Zf(n,t,e);d&&n.dispatch({type:"pointer",target:"handle",handle:d,shape:u,name:"pointer_down",...cn(n,c)})};let r,i;return{onPointerDown:s,onPointerMove:c=>{if(n.wasEventAlreadyHandled(c)||c.clientX===r&&c.clientY===i)return;r=c.clientX,i=c.clientY;const{shape:l,handle:u}=Zf(n,t,e);u&&n.dispatch({type:"pointer",target:"handle",handle:u,shape:l,name:"pointer_move",...cn(n,c)})},onPointerUp:c=>{if(n.wasEventAlreadyHandled(c))return;const l=Md(c.currentTarget);Yc(l,c);const{shape:u,handle:d}=Zf(n,t,e);d&&n.dispatch({type:"pointer",target:"handle",handle:d,shape:u,name:"pointer_up",...cn(n,c)})}}},[n,t,e])}function L5(t){const e=z();v.useLayoutEffect(()=>{const n=g0(()=>{t.current&&e.updateViewportScreenBounds(t.current)},200,{trailing:!0}),s=e.timers.setInterval(n,1e3);window.addEventListener("resize",n);const r=new ResizeObserver(a=>{a[0].contentRect&&n()}),i=t.current;let o=null;return i&&(r.observe(i),o=R5(i),o.addEventListener("scroll",n)),()=>{clearInterval(s),window.removeEventListener("resize",n),r.disconnect(),o?.removeEventListener("scroll",n),n.cancel()}},[e,t])}const R5=t=>{let e=t.parentElement;for(;e;){if(e===document.body)return document;const{overflowY:n}=window.getComputedStyle(e);if(e.scrollHeight>e.clientHeight&&(n==="auto"||n==="scroll"||n==="overlay"))return e;e=e.parentElement}return document},F5=Ot(function({showStroke:e=!0,showVertices:n=!0,showClosestPointOnOutline:s=!0}){const r=z(),i=r.getZoomLevel(),o=r.getRenderingShapes(),a=r.inputs.getCurrentPagePoint();return h.jsx("svg",{style:{position:"absolute",pointerEvents:"none",zIndex:999999999,top:0,left:0,overflow:"visible"},children:o.map(c=>{const l=r.getShape(c.id);if(l.type==="group")return null;const u=r.getShapeGeometry(l),d=r.getShapePageTransform(l),p=r.getPointInShapeSpace(l,a),f=u.nearestPoint(p),g=u.distanceToPoint(p,!0),x=Math.abs(g)*i,y=g<0,{vertices:m}=u;return h.jsxs("g",{transform:d.toCssString(),strokeLinecap:"round",strokeLinejoin:"round",children:[e&&h.jsx("g",{stroke:u.debugColor??"red",opacity:"1",strokeWidth:2/i,fill:"none",children:h.jsx(_T,{geometry:u})}),n&&m.map((S,w)=>h.jsx("circle",{cx:S.x,cy:S.y,r:2/i,fill:`hsl(${sr(w,[0,m.length-1],[120,200])}, 100%, 50%)`,stroke:"black",strokeWidth:1/i},`v${w}`)),s&&x<150&&h.jsx("line",{x1:f.x,y1:f.y,x2:p.x,y2:p.y,opacity:1-x/150,stroke:y?"goldenrod":"dodgerblue",strokeWidth:2/i})]},c.id+"_outline")})})});function _T({geometry:t}){return t instanceof os?h.jsx("g",{stroke:t.debugColor,children:[...t.children,...t.ignoredChildren].map((e,n)=>h.jsx(_T,{geometry:e},n))}):h.jsx("path",{d:t.toSimpleSvgPath(),stroke:t.debugColor})}function CT(t){return PA(t)}function TT(){const t=z(),e=Pj("userIds",()=>CT(t.getCollaborators().map(n=>n.userId)).sort(),{isEqual:(n,s)=>n.join(",")===s.join?.(",")},[t]);return $(e)}function Pu(t){const e=z();return $(`latestPresence:${t}`,()=>e.getCollaborators().find(s=>s.userId===t),[e,t])??null}const B5=Ot(function(){return TT().map(n=>h.jsx(z5,{collaboratorId:n},n))}),z5=Ot(function({collaboratorId:e}){const n=z(),s=Pu(e),r=N5(n,s);if(!(s&&s.currentPageId===n.getCurrentPageId()))return null;switch(r){case"inactive":{const{followingUserId:i,highlightedUserIds:o}=n.getInstanceState();if(!(i===s.userId||o.includes(s.userId)))return null;break}case"idle":{const{highlightedUserIds:i}=n.getInstanceState();if(s.followingUserId===n.user.getId()&&!(s.chatMessage||i.includes(s.userId)))return null;break}}return h.jsx($5,{latestPresence:s})}),$5=Ot(function({latestPresence:e}){const n=z(),{CollaboratorBrush:s,CollaboratorScribble:r,CollaboratorCursor:i,CollaboratorHint:o,CollaboratorShapeIndicator:a}=nt(),c=n.getZoomLevel(),l=n.getViewportPageBounds(),{userId:u,chatMessage:d,brush:p,scribbles:f,selectedShapeIds:g,userName:x,cursor:y,color:m}=e;if(!y)return null;const S=!(y.x<l.minX-12/c||y.y<l.minY-16/c||y.x>l.maxX-12/c||y.y>l.maxY-16/c);return h.jsxs(h.Fragment,{children:[p&&s?h.jsx(s,{className:"tl-collaborator__brush",userId:u,brush:p,color:m,opacity:.1},u+"_brush"):null,S&&i?h.jsx(i,{className:"tl-collaborator__cursor",userId:u,point:y,color:m,zoom:c,name:x!=="New User"?x:null,chatMessage:d??""},u+"_cursor"):o?h.jsx(o,{className:"tl-collaborator__cursor-hint",userId:u,point:y,color:m,zoom:c,viewport:l},u+"_cursor_hint"):null,r&&f.length?h.jsx(h.Fragment,{children:f.map(w=>h.jsx(r,{className:"tl-collaborator__scribble",userId:u,scribble:w,color:m,zoom:c,opacity:w.color==="laser"?.5:.1},u+"_scribble_"+w.id))}):null,a&&g.filter(w=>!n.isShapeHidden(w)).map(w=>h.jsx(a,{className:"tl-collaborator__shape-indicator",userId:u,shapeId:w,color:m,opacity:.5},u+"_"+w))]})});function Xw(t,e){return e>t.options.collaboratorInactiveTimeoutMs?"inactive":e>t.options.collaboratorIdleTimeoutMs?"idle":"active"}function N5(t,e){const n=v.useRef(e?.lastActivityTimestamp??-1),[s,r]=v.useState(()=>Xw(t,Date.now()-n.current));return v.useEffect(()=>{const i=t.timers.setInterval(()=>{r(Xw(t,Date.now()-n.current))},t.options.collaboratorCheckIntervalMs);return()=>clearInterval(i)},[t]),e&&(n.current=e.lastActivityTimestamp??1/0),s}function U5(){const t=z(),e=$("is menu open",()=>t.menus.hasAnyOpenMenus(),[t]),[n,s]=v.useState(!1),r=e||n,i=cu(),o=v.useRef({isDown:!1,isDragging:!1,start:new b}),a=v.useCallback(d=>{d.button===0&&(s(!0),o.current={isDown:!0,isDragging:!1,start:new b(d.clientX,d.clientY)},c.current=!1),t.menus.clearOpenMenus()},[t]),c=v.useRef(!1),l=v.useCallback(d=>{if(!o.current.isDown)return;const{x:p,y:f}=o.current.start;c.current||b.Dist2(o.current.start,new b(d.clientX,d.clientY))>t.options.dragDistanceSquared&&(c.current=!0,o.current={...o.current,isDown:!0,isDragging:!0},i.onPointerDown?.({...d,clientX:p,clientY:f,button:0})),c.current&&t.dispatch({type:"pointer",target:"canvas",name:"pointer_move",...cn(t,d)})},[i,t]),u=v.useCallback(d=>{i.onPointerUp?.(d),s(!1),o.current={isDown:!1,isDragging:!1,start:new b(d.clientX,d.clientY)},c.current=!1},[i]);return r&&h.jsx("div",{className:"tlui-menu-click-capture","data-testid":"menu-click-capture.content",...i,onPointerDown:a,onPointerMove:l,onPointerUp:u})}function H5({className:t}){const e=z(),{SelectionBackground:n,Background:s,SvgDefs:r,ShapeIndicators:i}=nt(),o=v.useRef(null),a=v.useRef(null),c=v.useRef(null),l=Lt();L5(o),qO(),WO(),D5(o),k5(o);const u=v.useRef({lodDisableTextOutline:!1,allowTextOutline:!0});Qi("position layers",function(){const{x:w,y:P,z:_}=e.getCamera();if(u.current.allowTextOutline&&qe.isSafari&&(l.style.setProperty("--tl-text-outline","none"),u.current.allowTextOutline=!1),u.current.allowTextOutline&&_<e.options.textShadowLod!==u.current.lodDisableTextOutline){const E=_<e.options.textShadowLod;l.style.setProperty("--tl-text-outline",E?"none":"var(--tl-text-outline-reference)"),u.current.lodDisableTextOutline=E}const I=_>=1?sr(_,[1,8],[.125,.5],!0):sr(_,[.1,1],[-2,.125],!0),C=`scale(${F(_)}) translate(${F(w+I)}px,${F(P+I)}px)`;bn(a.current,"transform",C),bn(c.current,"transform",C)},[e,l]);const d=cu(),p=$("shapeSvgDefs",()=>{const S=new Map;for(const w of _t(e.shapeUtils)){if(!w)return;const P=w.getCanvasSvgDefs();for(const{key:_,component:I}of P)S.has(_)||S.set(_,h.jsx(I,{},_))}return[...S.values()]},[e]),f=$("debug_shapes",()=>mt.hideShapes.get(),[mt]),g=$("debug_svg",()=>mt.debugSvg.get(),[mt]),x=$("debug_geometry",()=>mt.debugGeometry.get(),[mt]),y=$("isEditingAnything",()=>e.getEditingShapeId()!==null,[e]),m=$("isSelectingAnything",()=>!!e.getSelectedShapeIds().length,[e]);return h.jsxs(h.Fragment,{children:[h.jsxs("div",{ref:o,draggable:!1,"data-iseditinganything":y,"data-isselectinganything":m,className:de("tl-canvas",t),"data-testid":"canvas",...d,children:[h.jsx("svg",{className:"tl-svg-context","aria-hidden":"true",children:h.jsxs("defs",{children:[p,h.jsx(r4,{}),h.jsx(i4,{}),r&&h.jsx(r,{})]})}),s&&h.jsx("div",{className:"tl-background__wrapper",children:h.jsx(s,{})}),h.jsx(W5,{}),h.jsxs("div",{ref:a,className:"tl-html-layer tl-shapes",draggable:!1,children:[h.jsx(l4,{}),n&&h.jsx(c4,{}),f?null:g?h.jsx(e4,{}):h.jsx(n4,{})]}),h.jsx("div",{className:"tl-overlays",children:h.jsxs("div",{ref:c,className:"tl-html-layer",children:[x?h.jsx(F5,{}):null,h.jsx(G5,{}),h.jsx(q5,{}),h.jsx(Y5,{}),i&&h.jsx(i,{}),h.jsx(s4,{}),h.jsx(V5,{}),h.jsx(a4,{}),h.jsx(X5,{}),h.jsx(Q5,{}),h.jsx(B5,{})]})}),h.jsx(d4,{})]}),h.jsx("div",{className:"tl-canvas__in-front",onPointerDown:e.markEventAsHandled,onPointerUp:e.markEventAsHandled,onTouchStart:e.markEventAsHandled,onTouchEnd:e.markEventAsHandled,children:h.jsx(K5,{})}),h.jsx(U5,{})]})}function K5(){const{InFrontOfTheCanvas:t}=nt();return t?h.jsx(t,{}):null}function W5(){const t=z(),e=$("gridSize",()=>t.getDocumentSettings().gridSize,[t]),{x:n,y:s,z:r}=$("camera",()=>t.getCamera(),[t]),i=$("isGridMode",()=>t.getInstanceState().isGridMode,[t]),{Grid:o}=nt();return o&&i?h.jsx(o,{x:n,y:s,z:r,size:e}):null}function q5(){const t=z(),e=$("scribbles",()=>t.getInstanceState().scribbles,[t]),n=$("zoomLevel",()=>t.getEfficientZoomLevel(),[t]),{Scribble:s}=nt();return s&&e.length?e.map(r=>h.jsx(s,{className:"tl-user-scribble",scribble:r,zoom:n},r.id)):null}function G5(){const t=z(),e=$("brush",()=>t.getInstanceState().brush,[t]),{Brush:n}=nt();return n&&e?h.jsx(n,{className:"tl-user-brush",brush:e}):null}function Y5(){const t=z(),e=$("zoomBrush",()=>t.getInstanceState().zoomBrush,[t]),{ZoomBrush:n}=nt();return n&&e?h.jsx(n,{className:"tl-user-brush tl-zoom-brush",brush:e}):null}function V5(){const t=z(),e=$("snapLines",()=>t.snaps.getIndicators(),[t]),n=$("zoomLevel",()=>t.getEfficientZoomLevel(),[t]),{SnapIndicator:s}=nt();return s&&e.length>0?e.map(r=>h.jsx(s,{className:"tl-user-snapline",line:r,zoom:n},r.id)):null}function X5(){const t=z(),e=$("handles shapeIdWithHandles",()=>{const{isReadonly:n,isChangingStyle:s}=t.getInstanceState();if(n||s)return!1;const r=t.getOnlySelectedShape();return!r||!t.getShapeHandles(r)?!1:r.id},[t]);return e?h.jsx(Z5,{shapeId:e}):null}function Z5({shapeId:t}){const e=z(),{Handles:n}=nt(),s=$("zoomLevel",()=>e.getEfficientZoomLevel(),[e]),r=$("coarse pointer",()=>e.getInstanceState().isCoarsePointer,[e]),i=$("handles transform",()=>e.getShapePageTransform(t),[e,t]),o=$("handles",()=>{const c=e.getShapeHandles(t);if(!c)return null;const l=(r?e.options.coarseHandleRadius:e.options.handleRadius)/s*2;return c.filter(u=>u.type!=="virtual"||!c.some(d=>d!==u&&d.type==="vertex"&&b.Dist(u,d)<l)).sort(u=>u.type==="vertex"?1:-1)},[e,s,r,t]),a=$("isHidden",()=>e.isShapeHidden(t),[e,t]);return!n||!o||!i||a?null:h.jsx(n,{children:h.jsx("g",{transform:q.toCssString(i),children:o.map(c=>h.jsx(J5,{shapeId:t,handle:c,zoom:s,isCoarse:r},c.id))})})}function J5({shapeId:t,handle:e,zoom:n,isCoarse:s}){const r=O5(t,e.id),{Handle:i}=nt();return i?h.jsx("g",{role:"button","aria-label":e.label||"handle",transform:`translate(${e.x}, ${e.y})`,...r,children:h.jsx(i,{shapeId:t,handle:e,zoom:n,isCoarse:s})}):null}function Q5(){const{Overlays:t}=nt();return t?h.jsx("div",{className:"tl-custom-overlays tl-overlays__item",children:h.jsx(t,{})}):null}function e4(){const t=z();return $("rendering shapes",()=>t.getRenderingShapes(),[t]).map(n=>h.jsxs(v.Fragment,{children:[h.jsx(pI,{...n}),h.jsx(o4,{id:n.id,mode:"iframe"})]},n.id+"_fragment"))}function t4(){const t=z(),e=v.useRef(new Set);return Qi("reflow for culled shapes",()=>{const n=t.getCulledShapes();if(e.current.size===n.size&&[...n].every(r=>e.current.has(r)))return;e.current=n;const s=document.getElementsByClassName("tl-canvas");s.length!==0&&s[0].offsetHeight},[t]),null}function n4(){const t=z(),e=$("rendering shapes",()=>t.getRenderingShapes(),[t]);return h.jsxs(h.Fragment,{children:[e.map(n=>h.jsx(pI,{...n},n.id+"_shape")),qe.isSafari&&h.jsx(t4,{})]})}function s4(){const t=z(),{ShapeIndicator:e}=nt(),n=$("hinting shape ids",()=>um(t.getHintingShapeIds()),[t]);return!n.length||!e?null:n.map(s=>h.jsx(e,{className:"tl-user-indicator__hint",shapeId:s},s+"_hinting"))}function r4(){return h.jsxs("g",{id:tr("cursor"),children:[h.jsxs("g",{fill:"rgba(0,0,0,.2)",transform:"translate(-11,-11)",children:[h.jsx("path",{d:"m12 24.4219v-16.015l11.591 11.619h-6.781l-.411.124z"}),h.jsx("path",{d:"m21.0845 25.0962-3.605 1.535-4.682-11.089 3.686-1.553z"})]}),h.jsxs("g",{fill:"white",transform:"translate(-12,-12)",children:[h.jsx("path",{d:"m12 24.4219v-16.015l11.591 11.619h-6.781l-.411.124z"}),h.jsx("path",{d:"m21.0845 25.0962-3.605 1.535-4.682-11.089 3.686-1.553z"})]}),h.jsxs("g",{fill:"currentColor",transform:"translate(-12,-12)",children:[h.jsx("path",{d:"m19.751 24.4155-1.844.774-3.1-7.374 1.841-.775z"}),h.jsx("path",{d:"m13 10.814v11.188l2.969-2.866.428-.139h4.768z"})]})]})}function i4(){const t=tr("cursor_hint");return h.jsx("path",{id:t,fill:"currentColor",d:"M -2,-5 2,0 -2,5 Z"})}function o4({id:t,mode:e}){const n=z(),[s,r]=v.useState(null),i=$("is in root",()=>n.getShape(t)?.parentId===n.getCurrentPageId(),[n,t]);return v.useEffect(()=>{if(!i)return;let o=null;const a=is("shape to svg",async()=>{const c=Math.random();o=c;const u=n.isShapeOfType(t,"frame")?0:10;let d=n.getShapePageBounds(t);if(!d)return;d=d.clone().expandBy(u);const p=await n.getSvgString([t],{padding:u});if(o!==c||!p)return;const f=`data:image/svg+xml;utf8,${encodeURIComponent(p.svg)}`;r({src:f,bounds:d})});return()=>{o=null,a()}},[n,t,i]),!i||!s?null:e==="iframe"?h.jsx("iframe",{src:s.src,width:s.bounds.width,height:s.bounds.height,referrerPolicy:"no-referrer",style:{position:"absolute",top:0,left:0,border:"none",transform:`translate(${s.bounds.x}px, ${s.bounds.maxY+12}px)`,outline:"1px solid black",maxWidth:"none"}}):h.jsx("img",{src:s.src,width:s.bounds.width,height:s.bounds.height,referrerPolicy:"no-referrer",style:{position:"absolute",top:0,left:0,transform:`translate(${s.bounds.x}px, ${s.bounds.maxY+12}px)`,outline:"1px solid black",maxWidth:"none"}})}function a4(){const t=z(),e=$("selection rotation",function(){return t.getSelectionRotation()},[t]),n=$("selection bounds",()=>t.getSelectionRotatedPageBounds(),[t]),{SelectionForeground:s}=nt();return!n||!s?null:h.jsx(s,{bounds:n,rotation:e})}function c4(){const t=z(),e=$("selection rotation",()=>t.getSelectionRotation(),[t]),n=$("selection bounds",()=>t.getSelectionRotatedPageBounds(),[t]),{SelectionBackground:s}=nt();return!n||!s?null:h.jsx(s,{bounds:n,rotation:e})}function l4(){const{OnTheCanvas:t}=nt();return t?h.jsx(t,{}):null}function d4(){const t=z(),e=$("camera state",()=>t.getCameraState(),[t]);return h.jsx("div",{className:de("tl-hit-test-blocker",{"tl-hit-test-blocker__hidden":e==="idle"})})}function Ci({children:t,className:e="",...n}){return h.jsx("div",{...n,className:de("tl-html-container",e),children:t})}class u4{constructor(e){this.editor=e}static props;static migrations;static type}function Iu(t,e,n={}){const{newPoint:s,handle:r,scaleX:i,scaleY:o}=e,{minWidth:a=1,maxWidth:c=1/0,minHeight:l=1,maxHeight:u=1/0}=n;let d=t.props.w*i,p=t.props.h*o;const f=new b(0,0);if(d>0){if(d<a){switch(r){case"top_left":case"left":case"bottom_left":{f.x=d-a;break}case"top":case"bottom":{f.x=(d-a)/2;break}default:f.x=0}d=a}}else if(f.x=d,d=-d,d<a){switch(r){case"top_left":case"left":case"bottom_left":{f.x=-d;break}default:f.x=-a}d=a}if(p>0){if(p<l){switch(r){case"top_left":case"top":case"top_right":{f.y=p-l;break}case"right":case"left":{f.y=(p-l)/2;break}default:f.y=0}p=l}}else if(f.y=p,p=-p,p<l){switch(r){case"top_left":case"top":case"top_right":{f.y=-p;break}default:f.y=-l}p=l}const{x:g,y:x}=f.rot(t.rotation).add(s);return{...t,x:g,y:x,props:{w:Math.min(c,d),h:Math.min(u,p)}}}class xa extends zi{getGeometry(e){return new rr({width:e.props.w,height:e.props.h,isFilled:!0})}onResize(e,n){return Iu(e,n)}getHandleSnapGeometry(e){return{points:this.getGeometry(e).bounds.cornersAndCenter}}getInterpolatedProps(e,n,s){return{...n.props,w:ke(e.props.w,n.props.w,s),h:ke(e.props.h,n.props.h,s)}}}function ET(t,{initialBounds:e,scaleX:n,scaleY:s,newPoint:r,handle:i}){let o;switch(i){case"bottom_left":case"bottom_right":case"top_left":case"top_right":{o=Math.max(.01,Math.max(Math.abs(n),Math.abs(s)));break}case"left":case"right":{o=Math.max(.01,Math.abs(n));break}case"bottom":case"top":{o=Math.max(.01,Math.abs(s));break}default:throw Ke(i)}const a=new b(0,0);n<0&&(a.x=-(e.width*o)),s<0&&(a.y=-(e.height*o));const{x:c,y:l}=b.Add(r,a.rot(t.rotation));return{x:c,y:l,props:{scale:o*t.props.scale}}}let h4=class extends fe{static id="idle";onPointerDown(e){this.parent.transition("pointing",e)}onEnter(){this.editor.setCursor({type:"cross",rotation:0})}onCancel(){this.editor.setCurrentTool("select")}},p4=class extends fe{static id="pointing";onPointerMove(e){const{editor:n}=this;if(n.inputs.getIsDragging()){const s=n.inputs.getOriginPagePoint(),r=this.parent.shapeType,i=tt(),o=n.markHistoryStoppingPoint(`creating_box:${i}`),a=vs(s,n);if(this.editor.createShapes([{id:i,type:r,x:a.x,y:a.y,props:{w:1,h:1}}]),!n.getShape(i)){this.cancel();return}n.select(i);const l=this.parent;this.editor.setCurrentTool("select.resizing",{...e,target:"selection",handle:"bottom_right",isCreating:!0,creatingMarkId:o,creationCursorOffset:{x:1,y:1},onInteractionEnd:this.parent.id,onCreate:l.onCreate?u=>l.onCreate?.(u):void 0})}}onPointerUp(){this.complete()}onCancel(){this.cancel()}onComplete(){this.complete()}onInterrupt(){this.cancel()}complete(){const e=this.editor.inputs.getOriginPagePoint(),n=this.parent.shapeType,s=tt();this.editor.markHistoryStoppingPoint(`creating_box:${s}`),this.editor.createShapes([{id:s,type:n,x:e.x,y:e.y}]);const r=this.editor.getShape(s);if(!r){this.cancel();return}let{w:i,h:o}=r.props;const a=new b(i/2,o/2),c=this.editor.getShapeParentTransform(r);c&&a.rot(-c.rotation());let l=1;this.editor.user.getIsDynamicResizeMode()&&(l=1/this.editor.getZoomLevel(),i*=l,o*=l,a.mul(l));const u=wt(r),d=vs(new b(r.x-a.x,r.y-a.y),this.editor);u.x=d.x,u.y=d.y,u.props.w=i,u.props.h=o,"scale"in r.props&&(u.props.scale=l),this.editor.updateShape(u),this.editor.setSelectedShapes([s]),this.editor.getInstanceState().isToolLocked?this.parent.transition("idle"):this.editor.setCurrentTool("select.idle")}cancel(){this.parent.transition("idle")}};function vs(t,e){const n=e.getInstanceState().isGridMode,s=e.getDocumentSettings().gridSize;return n?t.clone().snapToGrid(s):t.clone()}class f4 extends fe{static id="box";static initial="idle";static children(){return[h4,p4]}}function g4(t,e,n){const s=v.useRef(!1),r=v.useCallback(o=>{s.current=o,o?Ln.addOpenMenu(t):Ln.deleteOpenMenu(t),e?.(o)},[t,e]),i=$("is menu open",()=>Ln.getOpenMenus().includes(t),[t]);return v.useEffect(()=>(s.current&&(n?.("open-menu"),Ln.addOpenMenu(t)),()=>{s.current&&(Ln.deleteOpenMenu(t),Ln.getOpenMenus().forEach(o=>{o.startsWith(t)&&(n?.("close-menu"),Ln.deleteOpenMenu(o))}),s.current=!1)}),[t,n]),[i,r]}function nl(t){const e=z();return $("isEditing",()=>e.getEditingShapeId()===t,[e,t])}function m4(t){if(!t)throw Error("usePassThroughWheelEvents must be passed a ref");const e=Lt(),n=Tt();v.useEffect(()=>{function s(i){if(!n?.getInstanceState().isFocused||i.isSpecialRedispatchedEvent)return;Pe(i);const o=e.querySelector(".tl-canvas");if(!o)return;const a=new PointerEvent(i.type,i);a.isSpecialRedispatchedEvent=!0,o.dispatchEvent(a)}const r=t.current;if(r)return r.addEventListener("mouseover",s,{passive:!1}),()=>{r.removeEventListener("mouseover",s)}},[e,n,t])}function pr(t){const e=z();return v.useMemo(function(){const r=l=>{if(e.wasEventAlreadyHandled(l))return;if(l.button===ey){e.dispatch({type:"pointer",target:"selection",handle:t,name:"right_click",...cn(e,l)});return}if(l.button!==0)return;const u=Md(l.currentTarget);function d(){u.removeEventListener("pointerup",d),Yc(u,l)}Gc(u,l),u.addEventListener("pointerup",d),e.dispatch({name:"pointer_down",type:"pointer",target:"selection",handle:t,...cn(e,l)}),e.markEventAsHandled(l)};let i,o;function a(l){e.wasEventAlreadyHandled(l)||l.button===0&&(l.clientX===i&&l.clientY===o||(i=l.clientX,o=l.clientY,e.dispatch({name:"pointer_move",type:"pointer",target:"selection",handle:t,...cn(e,l)})))}return{onPointerDown:r,onPointerMove:a,onPointerUp:l=>{e.wasEventAlreadyHandled(l)||l.button===0&&e.dispatch({name:"pointer_up",type:"pointer",target:"selection",handle:t,...cn(e,l)})}}},[e,t])}function y4(t){const[e,n]=v.useState(()=>({store:Ld(t),opts:t}));if(!I0(e.opts,t)){const s={store:Ld(t),opts:t};return n(s),s.store}return e.store}const S4=20,x4=8;function _u(t,e=S4){return Math.max(x4,Math.ceil(t/e))}class kT extends Bi{_center;_radius;_start;_end;_largeArcFlag;_sweepFlag;_measure;_angleStart;_angleEnd;constructor(e){super({...e,isFilled:!1,isClosed:!1});const{center:n,sweepFlag:s,largeArcFlag:r,start:i,end:o}=e;if(i.equals(o))throw Error("Arc must have different start and end points.");this._angleStart=b.Angle(n,i),this._angleEnd=b.Angle(n,o),this._radius=b.Dist(n,i),this._measure=RO(this._angleStart,this._angleEnd,s,r),this._start=i,this._end=o,this._sweepFlag=s,this._largeArcFlag=r,this._center=n}nearestPoint(e){const{_center:n,_measure:s,_radius:r,_angleEnd:i,_angleStart:o,_start:a,_end:c}=this,l=lw(s,o,i,n.angle(e));if(l<=0)return a;if(l>=1)return c;const u=b.Sub(e,n).uni().mul(r).add(n);let d,p=1/0,f;for(const g of[a,c,u])f=b.Dist2(e,g),f<p&&(d=g,p=f);if(!d)throw Error("nearest point not found");return d}hitTestLineSegment(e,n){const{_center:s,_radius:r,_measure:i,_angleStart:o,_angleEnd:a}=this,c=Xc(e,n,s,r);return c===null?!1:c.some(l=>{const u=lw(i,o,a,s.angle(l));return u>=0&&u<=1})}getVertices(){const{_center:e,_measure:n,length:s,_radius:r,_angleStart:i}=this,o=[];for(let a=0,c=_u(Math.abs(s));a<c+1;a++){const l=a/c*n,u=i+l;o.push(Qm(e,r,u))}return o}getSvgPathData(e=!0){const{_start:n,_end:s,_radius:r,_largeArcFlag:i,_sweepFlag:o}=this;return`${e?`M${n.toFixed()}`:""} A${r} ${r} 0 ${i} ${o} ${s.toFixed()}`}getLength(){return Math.abs(this._measure*this._radius)}}class Rd extends Bi{constructor(e){super({isClosed:!0,...e}),this.config=e;const{x:n=0,y:s=0,radius:r}=e;this._x=n,this._y=s,this._center=new b(r+n,r+s),this._radius=r}_center;_radius;_x;_y;getBounds(){return new X(this._x,this._y,this._radius*2,this._radius*2)}getVertices(){const{_center:e,_radius:n}=this,s=at*n,r=[];for(let i=0,o=_u(s);i<o;i++){const a=i/o*at;r.push(Qm(e,n,a))}return r}nearestPoint(e){const{_center:n,_radius:s}=this;return n.equals(e)?b.AddXY(n,s,0):b.Sub(e,n).uni().mul(s).add(n)}hitTestLineSegment(e,n,s=0){const{_center:r,_radius:i}=this;return Xc(e,n,r,i+s)!==null}getSvgPathData(){const{_center:e,_radius:n}=this;return`M${e.x+n},${e.y} a${n},${n} 0 1,0 ${n*2},0a${n},${n} 0 1,0 -${n*2},0`}}class wy extends Zc{_a;_b;_c;_d;_resolution;constructor(e){const{start:n,cp1:s,cp2:r,end:i}=e;super({...e,points:[n,i]}),this._a=n,this._b=s,this._c=r,this._d=i,this._resolution=e.resolution??10}getVertices(){const e=[],{_a:n,_b:s,_c:r,_d:i}=this;for(let o=0,a=this._resolution;o<=a;o++){const c=o/a;e.push(new b((1-c)*(1-c)*(1-c)*n.x+3*((1-c)*(1-c))*c*s.x+3*(1-c)*(c*c)*r.x+c*c*c*i.x,(1-c)*(1-c)*(1-c)*n.y+3*((1-c)*(1-c))*c*s.y+3*(1-c)*(c*c)*r.y+c*c*c*i.y))}return e}nearestPoint(e){let n,s=1/0,r,i;for(const o of this.segments)i=o.nearestPoint(e),r=b.Dist2(i,e),r<s&&(n=i,s=r);if(!n)throw Error("nearest point not found");return n}getSvgPathData(e=!0){const{_a:n,_b:s,_c:r,_d:i}=this;return`${e?`M ${n.toFixed()} `:""} C${s.toFixed()} ${r.toFixed()} ${i.toFixed()}`}static GetAtT(e,n){const{_a:s,_b:r,_c:i,_d:o}=e;return new b((1-n)*(1-n)*(1-n)*s.x+3*((1-n)*(1-n))*n*r.x+3*(1-n)*(n*n)*i.x+n*n*n*o.x,(1-n)*(1-n)*(1-n)*s.y+3*((1-n)*(1-n))*n*r.y+3*(1-n)*(n*n)*i.y+n*n*n*o.y)}getLength(e,n=32){let s,r=this._a,i=0;for(let o=1;o<=n;o++)s=wy.GetAtT(this,o/n),i+=b.Dist(r,s),r=s;return i}}class b4 extends Bi{constructor(e){super({...e,isClosed:!0}),this.config=e;const{width:n,height:s}=e;this._w=n,this._h=s}_w;_h;_edges;get edges(){if(!this._edges){const{vertices:e}=this;this._edges=[];for(let n=0,s=e.length;n<s;n++){const r=e[n],i=e[(n+1)%s];this._edges.push(new sa({start:r,end:i}))}}return this._edges}getVertices(){const e=Math.max(1,this._w),n=Math.max(1,this._h),s=e/2,r=n/2,i=Math.pow(s-r,2)/Math.pow(s+r,2),o=Ve*(s+r)*(1+3*i/(10+Math.sqrt(4-3*i))),a=_u(o),c=at/a,l=Math.cos(c),u=Math.sin(c);let d=0,p=1,f=0,g=1;const x=Array(a);for(let y=0;y<a;y++)x[y]=new b(Ce(s+s*p,0,e),Ce(r+r*d,0,n)),f=u*p+l*d,g=l*p-u*d,d=f,p=g;return x}nearestPoint(e){let n,s=1/0,r,i;for(const o of this.edges)i=o.nearestPoint(e),r=b.Dist2(i,e),r<s&&(n=i,s=r);if(!n)throw Error("nearest point not found");return n}hitTestLineSegment(e,n){return this.edges.some(s=>s.hitTestLineSegment(e,n))}getBounds(){return new X(0,0,this._w,this._h)}getLength(){const{_w:e,_h:n}=this,s=e/2,r=n/2,i=Math.max(0,s),o=Math.max(0,r);return jO(i,o)}getSvgPathData(e=!1){const{_w:n,_h:s}=this,r=n/2,i=s/2,o=Math.max(0,r),a=Math.max(0,i);return`${e?`M${r-o},${i}`:""} a${o},${a},0,1,1,${o*2},0a${o},${a},0,1,1,-${o*2},0`}}function Qe(t,e,n){const s=new Set;for(const a of e){const c=t.getShape(a);if(!c)continue;s.add(c);const l=t.getShape(c.parentId);l&&s.add(l)}const r=new Map;for(const a of s){const c=t.getSortedChildIdsForParent(a);if(n?.filter&&!n.filter(a))r.set(a,c);else{const l=w4(t,a.id,c);l.length<c.length&&r.set(a,c.filter(u=>!l.includes(u)))}}const i=t.getCurrentPageShapesSorted().map(a=>a.id),o={};for(const[a,c]of r){const l=ve(c.map(p=>t.getShape(p))),{reparenting:u,remainingShapesToReparent:d}=v4(t,l,(p,f)=>n?.filter&&!n.filter(f)?!1:f.id!==a.id&&i.indexOf(f.id)<i.indexOf(p.id));if(u.forEach((p,f)=>{p.length!==0&&(o[f]||(o[f]={parentId:f,shapeIds:[]}),o[f].shapeIds.push(...p.map(g=>g.id)))}),d.size>0){const p=t.findShapeAncestor(a,f=>t.isShapeOfType(f,"group"))?.id??t.getCurrentPageId();d.forEach(f=>{if(!o[p]){let g;const x=t.getSortedChildIdsForParent(p),y=x.indexOf(a.id);if(y>-1){const m=x[y+1],S=m?t.getShape(m).index:Ls(a.index);g=Qo(a.index,S)}o[p]={parentId:p,shapeIds:[],index:g}}o[p].shapeIds.push(f.id)})}}t.run(()=>{Object.values(o).forEach(({parentId:a,shapeIds:c,index:l})=>{c.length!==0&&(c.sort((u,d)=>i.indexOf(u)<i.indexOf(d)?-1:1),t.reparentShapes(c,a,l))})})}function w4(t,e,n){if(n.length===0)return Ct;const s=t.getShapePageBounds(e);if(!s)return Ct;const r=t.getShapeGeometry(e),o=t.getShapePageTransform(e).applyToPoints(r.vertices),a=t.getShape(e);if(!a)return Ct;const c=t.getShapePageTransform(e),l=t.getShapeUtil(a.type).getClipPath?.(a),u=l?c.applyToPoints(l):void 0,d=u?Dd(u,o):o;return d?n.filter(p=>{const f=t.getShapePageBounds(p);if(!f||!s.includes(f))return!1;const g=t.getShapePageTransform(p).clone().invert().applyToPoints(d);return t.getShapeGeometry(p).overlapsPolygon(g)}):Ct}function v4(t,e,n){const s=new Set(e),r=new Set;for(const l of e){const u=t.getShapeParent(l);u&&t.isShapeOfType(u,"group")&&(r.has(u)||r.add(u))}for(const l of r){const u=ve(t.getSortedChildIdsForParent(l).map(d=>t.getShape(d)));for(const d of u)s.delete(d);s.add(l)}const i=new Map,o=new Map,a=new Set(s),c=t.getCurrentPageShapesSorted().filter(l=>t.getShapeUtil(l).canReceiveNewChildrenOfType?.(l,l.type)&&!a.has(l));e:for(let l=c.length-1;l>=0;l--){const u=c[l],d=t.findShapeAncestor(u,S=>t.isShapeOfType(S,"group"))?.id,p=t.getShapeGeometry(u),f=t.getShapePageTransform(u),g=t.getShapeMask(u),x=f.applyToPoints(p.vertices),y=g?Dd(g,x):x;if(!y)continue e;const m=[];t:for(const S of a){if(u.id===S.id||n&&!n(S,u)||(i.has(S.id)||i.set(S.id,t.findShapeAncestor(S,_=>t.isShapeOfType(_,"group"))?.id),i.get(S.id)!==d)||t.findShapeAncestor(u,_=>S.id===_.id))continue t;const P=t.getShapePageTransform(S).clone().invert().applyToPoints(y);if(t.getShapeGeometry(S).overlapsPolygon(P)){if(!t.getShapeUtil(u).canReceiveNewChildrenOfType?.(u,S.type))continue t;S.parentId!==u.id&&m.push(S),a.delete(S);continue t}}m.length&&o.set(u.id,m)}return{reparenting:o,remainingShapesToReparent:a}}const P4=new dn;function I4(t){return P4.get(t,()=>nA(t.extensions??[]))}function Cu(t,e,n){const{tipTapConfig:s,addFontsFromNode:r}=t.getTextOptions();le(s,"textOptions.tipTapConfig must be set to use rich text"),le(r,"textOptions.addFontsFromNode must be set to use rich text");const i=I4(s),o=tA.fromJSON(i,e),a=new Set;function c(u){a.add(u)}function l(u,d){d=r(u,d,c);for(const p of u.children)l(p,d)}return l(o,n),Array.from(a)}async function _4({shouldReload:t=!0}={}){VA();for(const e of _c.connectedInstances)await e.close();await Promise.all(by().map(e=>uT(e))),YA(),t&&window.location.reload()}typeof window<"u"&&(window.__tldraw__hardReset=_4);function vy(t,e="_blank",n){return Vc.openWindow(t,e,n)}Di("@tldraw/editor","4.3.1","esm");const C4=t=>t*.65+MO(t*Ve/2)*.35,T4=t=>({size:t,thinning:.5,streamline:sr(t,[9,16],[.64,.74],!0),smoothing:.62,easing:Pn.easeOutSine,simulatePressure:!0}),E4=t=>({size:1+t*1.2,thinning:.62,streamline:.62,smoothing:.62,simulatePressure:!1,easing:C4}),Zw=t=>({size:t,thinning:0,streamline:sr(t,[9,16],[.64,.74],!0),smoothing:.62,simulatePressure:!1,easing:Pn.linear}),k4=t=>({size:t,thinning:0,streamline:.62,smoothing:.62,simulatePressure:!1,easing:Pn.linear});function Py({strokeWidth:t,showAsComplete:e}){return{size:1+t,thinning:0,streamline:.5,smoothing:.5,simulatePressure:!1,easing:Pn.easeOutSine,last:e}}function Fg(t,e,n,s){const r=t.isComplete||n;return s?t.isPen?{...k4(e),last:r}:{...Zw(e),last:r}:t.dash==="draw"?t.isPen?{...E4(e),last:r}:{...T4(e),last:r}:{...Zw(e),last:r}}function A4(t,e,n,s=[]){const r=He.decodePoints(t.path);if(e!==1||n!==1)for(const i of r)i.x*=e,i.y*=n;if(t.type==="free"||r.length<2)s.push(...r.map(b.From));else{const i=Math.max(4,Math.floor(b.Dist(r[0],r[1])/16));s.push(...b.PointsBetween(r[0],r[1],i))}return s}function ia(t,e=1,n=1){const s=[];for(const r of t)A4(r,e,n,s);return s}function M4(t,e,n){return{draw:"none",solid:"none",dotted:`${n} ${e*2}`,dashed:`${e*2} ${e*2}`}[t.props.dash]}class We{static lineThroughPoints(e,n){const s=new We;s.moveTo(e[0].x,e[0].y,{...n,offset:n?.endOffsets??n?.offset});for(let r=1;r<e.length;r++){const i=r===e.length-1;s.lineTo(e[r].x,e[r].y,i?{offset:n?.endOffsets}:void 0)}return s}static cubicSplineThroughPoints(e,n){const s=new We,r=e.length,i=r-2,o=1.25;s.moveTo(e[0].x,e[0].y,{...n,offset:n?.endOffsets??n?.offset});for(let a=0;a<r-1;a++){const c=a===0?e[0]:e[a-1],l=e[a],u=e[a+1],d=a===i?u:e[a+2];let p,f,g,x;a===0?(p=c.x,f=c.y):(p=l.x+(u.x-c.x)/6*o,f=l.y+(u.y-c.y)/6*o);let y;a===i?(g=u.x,x=u.y,y={offset:n?.endOffsets}):(g=u.x-(d.x-l.x)/6*o,x=u.y-(d.y-l.y)/6*o),s.cubicBezierTo(u.x,u.y,p,f,g,x,y)}return s}constructor(){}commands=[];lastMoveTo=null;assertHasMoveTo(){return le(this.lastMoveTo,"Start an SVGPathBuilder with `.moveTo()`"),this.lastMoveTo}moveTo(e,n,s){return this.lastMoveTo={type:"move",x:e,y:n,closeIdx:null,isClose:!1,opts:s},this.commands.push(this.lastMoveTo),this}lineTo(e,n,s){return this.assertHasMoveTo(),this.commands.push({type:"line",x:e,y:n,isClose:!1,opts:s}),this}circularArcTo(e,n,s,r,i,o){return this.arcTo(e,e,n,s,0,r,i,o)}arcTo(e,n,s,r,i,o,a,c){this.assertHasMoveTo();const l=this.commands[this.commands.length-1].x,u=this.commands[this.commands.length-1].y;if(l===o&&u===a)return this;if(e===0||n===0)return this.lineTo(o,a,c);const d=i,p=Math.sin(d),f=Math.cos(d);let g=Math.abs(e),x=Math.abs(n);const y=(l-o)/2,m=(u-a)/2,S=f*y+p*m,w=-p*y+f*m,P=S*S/(g*g)+w*w/(x*x);if(P>1){const ge=Math.sqrt(P);g*=ge,x*=ge}const _=s!==r?1:-1,I=g*g*x*x-g*g*w*w-x*x*S*S,C=g*g*w*w+x*x*S*S;let E=I/C;E=E<0?0:E;const O=_*Math.sqrt(E),k=O*(g*w/x),T=O*(-(x*S)/g),D=f*k-p*T+(l+o)/2,R=p*k+f*T+(u+a)/2,M=(S-k)/g,L=(w-T)/x,U=(-S-k)/g,V=(-w-T)/x,J=Math.atan2(L,M);let Z=Math.atan2(V,U);!r&&Z>J?Z-=2*Math.PI:r&&Z<J&&(Z+=2*Math.PI);const Q=Z-J,Y=Math.max(g,x)*Math.abs(Q),Ie=Math.min(4,Math.ceil(Math.abs(Q)/(Math.PI/2))),be=Math.ceil(_u(Y)/Ie),me=Q/Ie,ne=ge=>({x:D+g*Math.cos(ge)*f-x*Math.sin(ge)*p,y:R+g*Math.cos(ge)*p+x*Math.sin(ge)*f}),Me=ge=>({x:-g*Math.sin(ge)*f-x*Math.cos(ge)*p,y:-g*Math.sin(ge)*p+x*Math.cos(ge)*f});for(let ge=0;ge<Ie;ge++){const ce=J+ge*me,_e=J+(ge+1)*me,ye=_e-ce,ht=ne(ce),st=ne(_e),Ze=Me(ce),rt=Me(_e),it=4/3*Math.tan(ye/4),en=ht.x+it*Ze.x,Vn=ht.y+it*Ze.y,cs=st.x-it*rt.x,ls=st.y-it*rt.y,kn=ge===0?c:{...c,mergeWithPrevious:!0};this.cubicBezierToWithResolution(st.x,st.y,en,Vn,cs,ls,kn,be)}return this}cubicBezierTo(e,n,s,r,i,o,a){return this.cubicBezierToWithResolution(e,n,s,r,i,o,a)}cubicBezierToWithResolution(e,n,s,r,i,o,a,c){return this.assertHasMoveTo(),this.commands.push({type:"cubic",x:e,y:n,cp1:{x:s,y:r},cp2:{x:i,y:o},isClose:!1,opts:a,resolution:c}),this}close(){const e=this.assertHasMoveTo(),n=this.commands[this.commands.length-1];return Dt(e.x,n.x)&&Dt(e.y,n.y)?n.isClose=!0:this.commands.push({type:"line",x:e.x,y:e.y,isClose:!0}),e.closeIdx=this.commands.length-1,this.lastMoveTo=null,this}toD(e={}){const{startIdx:n=0,endIdx:s=this.commands.length,onlyFilled:r=!1}=e,i=[];let o=!1,a=!1,c=!1;const l=u=>{if(a||u===0)return;a=!0;const d=this.commands[u-1];i.push("M",F(d.x),F(d.y))};for(let u=n;u<s;u++){const d=this.commands[u];switch(d.type){case"move":{const p=d.opts?.geometry===!1?!1:d.opts?.geometry?.isFilled??!1;r&&!p?o=!0:(o=!1,a=!0,c=!0,i.push("M",F(d.x),F(d.y)));break}case"line":if(o)break;l(u),d.isClose&&c?i.push("Z"):i.push("L",F(d.x),F(d.y));break;case"cubic":if(o)break;l(u),i.push("C",F(d.cp1.x),F(d.cp1.y),F(d.cp2.x),F(d.cp2.y),F(d.x),F(d.y));break;default:Ke(d,"type")}}return i.join(" ")}toSvg(e){if(e.forceSolid)return this.toSolidSvg(e);switch(e.style){case"solid":return this.toSolidSvg(e);case"dashed":case"dotted":return this.toDashedSvg(e);case"draw":return this.toDrawSvg(e);default:Ke(e,"style")}}toGeometry(){const e=[];let n=null;for(let s=0;s<this.commands.length;s++){const r=this.commands[s];r.type==="move"&&(n&&n.opts?.geometry!==!1&&e.push(new Bg(this,n.startIdx,s,{...n.opts?.geometry,isFilled:n.opts?.geometry?.isFilled??!1,isClosed:n.moveCommand.closeIdx!==null})),n={startIdx:s,moveCommand:r,opts:r.opts,isClosed:!1}),r.isClose&&(le(n,"No current move command"),n.isClosed=!0)}return n&&n.opts?.geometry!==!1&&e.push(new Bg(this,n.startIdx,this.commands.length,{...n.opts?.geometry,isFilled:n.opts?.geometry?.isFilled??!1,isClosed:n.moveCommand.closeIdx!==null})),le(e.length>0),e.length===1?e[0]:new os({children:e})}toSolidSvg(e){const{strokeWidth:n,props:s}=e;return h.jsx("path",{strokeWidth:n,d:this.toD({onlyFilled:e.onlyFilled}),...s})}toDashedSvg(e){const{style:n,strokeWidth:s,snap:r,lengthRatio:i,props:{markerStart:o,markerEnd:a,...c}={}}=e,l=[];let u=!1,d=!1,p,f=null;const g=()=>{if(!f)return;const{startIdx:x,endIdx:y,isFirst:m,isLast:S,length:w,lineOpts:P,pathIsClosed:_}=f;if(f=null,x===y&&this.commands[x].type==="move")return;const I=P?.dashStart??e.start,C=P?.dashEnd??e.end,{strokeDasharray:E,strokeDashoffset:O}=VP(w,s,{style:n,snap:r,lengthRatio:i,start:m?I??(_?"outset":"none"):"outset",end:S?C??(_?"outset":"none"):"outset"}),k=this.toD({startIdx:x,endIdx:y+1});l.push(h.jsx("path",{d:k,strokeDasharray:E,strokeDashoffset:O,markerStart:m?o:void 0,markerEnd:S?a:void 0},l.length))};for(let x=0;x<this.commands.length;x++){const y=this.commands[x],m=this.commands[x-1];if(y.type==="move"){u=y.closeIdx!==null;const _=y.opts?.geometry===!1?!1:y.opts?.geometry?.isFilled??!1;e.onlyFilled&&!_?d=!0:(d=!1,p=y.opts);continue}if(d)continue;const S=this.calculateSegmentLength(m,y),w=m.type==="move",P=y.isClose||x===this.commands.length-1||this.commands[x+1]?.type==="move";f&&y.opts?.mergeWithPrevious?(f.length+=S,f.endIdx=x,f.isLast=P):(g(),f={startIdx:x,endIdx:x,isFirst:w,isLast:P,length:S,lineOpts:p,pathIsClosed:u})}return g(),h.jsx("g",{strokeWidth:s,...c,children:l})}toDrawSvg(e){return h.jsx("path",{strokeWidth:e.strokeWidth,d:this.toDrawD(e),...e.props})}toDrawD(e){const{strokeWidth:n,randomSeed:s,offset:r=n/3,roundness:i=n*2,passes:o=2,onlyFilled:a=!1}=e,c=[],l=this.getCommandInfo(),u=[];let d=null;for(let p=0;p<this.commands.length;p++){const f=this.commands[p],g=f.opts?.offset??r,x=f.opts?.roundness??i;f.type==="move"&&(d=p);const y=f.isClose?Gt(d)+1:!this.commands[p+1]||this.commands[p+1].type==="move"?void 0:p+1,m=y!==void 0&&this.commands[y]&&this.commands[y]?.type!=="move"?l[y]:void 0,S=Jw[f.type],w=y!==void 0?Jw[this.commands[y].type]:!1,P=l[p],_=P?.tangentEnd,I=m?.tangentStart,C=S&&w&&_&&I&&b.Len2(_)>.01&&b.Len2(I)>.01?sr(Math.abs(b.AngleBetween(_,I)),[Math.PI/2,Math.PI],[x,0],!0):0,O=Math.min(P?.length??1/0,m?.length??1/0)-C*2,k=Ce(g,0,O/4),T=Math.min(C,(P?.length??1/0)/4),D=Math.min(C,(m?.length??1/0)/4),R={command:f,offsetAmount:k,roundnessBefore:T,roundnessAfter:D,tangentToPrev:l[p]?.tangentEnd,tangentToNext:m?.tangentStart,moveDidClose:!1};if(u.push(R),f.isClose&&d!==null){const M=u[d];M.moveDidClose=!0,M.roundnessAfter=D}else f.type==="move"&&(d=p)}for(let p=0;p<o;p++){const f=uo(s+p);let g={x:0,y:0},x=!1;for(const{command:y,offsetAmount:m,roundnessBefore:S,roundnessAfter:w,tangentToNext:P,tangentToPrev:_}of u){const I=y.isClose?g:{x:f()*m,y:f()*m};if(y.type==="move"){g=I;const k=y.opts?.geometry===!1?!1:y.opts?.geometry?.isFilled??!1;a&&!k?x=!0:x=!1}if(x)continue;const C=b.Add(y,I),E=P&&w>0?b.Mul(P,-w).add(C):C,O=_&&S>0?b.Mul(_,S).add(C):C;if(E===C||O===C)switch(y.type){case"move":c.push("M",F(E.x),F(E.y));break;case"line":c.push("L",F(E.x),F(E.y));break;case"cubic":{const k=b.Add(y.cp1,I),T=b.Add(y.cp2,I);c.push("C",F(k.x),F(k.y),F(T.x),F(T.y),F(E.x),F(E.y));break}default:Ke(y,"type")}else switch(y.type){case"move":c.push("M",F(E.x),F(E.y));break;case"line":c.push("L",F(O.x),F(O.y),"Q",F(C.x),F(C.y),F(E.x),F(E.y));break;case"cubic":{const k=b.Add(y.cp1,I),T=b.Add(y.cp2,I);c.push("C",F(k.x),F(k.y),F(T.x),F(T.y),F(C.x),F(C.y));break}default:Ke(y,"type")}}}return c.join(" ")}calculateSegmentLength(e,n){switch(n.type){case"move":return 0;case"line":return b.Dist(e,n);case"cubic":return Za.length(e.x,e.y,n.cp1.x,n.cp1.y,n.cp2.x,n.cp2.y,n.x,n.y);default:Ke(n,"type")}}getCommands(){return this.commands}getCommandInfo(){const e=[];for(let n=1;n<this.commands.length;n++){const s=this.commands[n-1],r=this.commands[n];if(r._info){e[n]=r._info;continue}if(r.type==="move")continue;let i,o;switch(r.type){case"line":i=o=b.Sub(s,r).uni();break;case"cubic":{i=b.Sub(r.cp1,s).uni(),o=b.Sub(r.cp2,r).uni();break}default:Ke(r,"type")}r._info={tangentStart:i,tangentEnd:o,length:this.calculateSegmentLength(s,r)},e[n]=r._info}return e}}const Jw={line:!0,move:!0,cubic:!1};class Bg extends Bi{constructor(e,n,s,r){super(r),this.path=e,this.startIdx=n,this.endIdx=s}_segments=null;getSegments(){if(this._segments)return this._segments;this._segments=[];let e=this.path.commands[this.startIdx];le(e.type==="move");for(let n=this.startIdx+1;n<this.endIdx;n++){const s=this.path.commands[n];switch(le(s.type!=="move"),s.type){case"line":this._segments.push(new sa({start:b.From(e),end:b.From(s)}));break;case"cubic":{this._segments.push(new wy({start:b.From(e),cp1:b.From(s.cp1),cp2:b.From(s.cp2),end:b.From(s),resolution:s.resolution}));break}default:Ke(s,"type")}e=s}return this._segments}getVertices(e){const n=this.getSegments().flatMap(s=>s.getVertices(e)).filter((s,r,i)=>{const o=i[r-1];return o?!b.Equals(o,s):!0});if(this.isClosed){const s=n[n.length-1],r=n[0];b.Equals(s,r)||n.push(r)}return n}nearestPoint(e,n){let s=null,r=1/0;for(const i of this.getSegments()){const o=i.nearestPoint(e),a=b.Dist2(e,o);a<r&&(r=a,s=o)}return le(s,"No nearest point found"),s}hitTestLineSegment(e,n,s=0,r){return super.hitTestLineSegment(e,n,s,r)}getSvgPathData(){return this.path.toD({startIdx:this.startIdx,endIdx:this.endIdx})}}const Za={base3(t,e,n,s,r){const i=-3*e+9*n-9*s+3*r,o=t*i+6*e-12*n+6*s;return t*o-3*e+3*n},length(t,e,n,s,r,i,o,a,c=1){c=c>1?1:c<0?0:c;const l=c/2,u=12;let d=0;d=0;for(let p=0;p<u;p++){const f=l*Za.Tvalues[p]+l,g=Za.base3(f,t,n,r,o),x=Za.base3(f,e,s,i,a),y=g*g+x*x;d+=Za.Cvalues[p]*Math.sqrt(y)}return l*d},Tvalues:[-.1252,.1252,-.3678,.3678,-.5873,.5873,-.7699,.7699,-.9041,.9041,-.9816,.9816],Cvalues:[.2491,.2491,.2335,.2335,.2032,.2032,.1601,.1601,.1069,.1069,.0472,.0472]};function AT(){const t=Tt(),e=$("animationSpeed",()=>t?.user.getAnimationSpeed(),[t]),[n,s]=v.useState(!1);return v.useEffect(()=>{if(e!==void 0){s(e===0);return}if(typeof window>"u"||!("matchMedia"in window))return;const r=window.matchMedia("(prefers-reduced-motion: reduce)"),i=()=>{s(r.matches)};return i(),r.addEventListener("change",i),()=>r.removeEventListener("change",i)},[e]),n}function MT(t){return"richText"in t.props&&Wc.isValid(t.props.richText)}function Hn(t,e,n={}){const s=typeof e=="string"?t.getShape(e):e;if(s&&t.canEditShape(s)){if(!MT(s))throw new Error("Shape does not have rich text");t.setEditingShape(s),t.setCurrentTool("select.editing_shape",{...n.info,target:"shape",shape:s}),n.selectAll&&t.emit("select-all-text",{shapeId:s.id})}}const zg=v.createContext(null);function j4({children:t}){const e=Hc("a11y",{msg:"",priority:"assertive"}),n=v.useContext(zg),s=v.useMemo(()=>({currentMsg:e,announce(r){r&&e.set(r)}}),[e]);return n?h.jsx(h.Fragment,{children:t}):h.jsx(zg.Provider,{value:s,children:t})}function Tu(){const t=v.useContext(zg);if(!t)throw new Error("useA11y must be used within a A11yContext.Provider");return t}const jT=v.createContext(null);function DT({assetUrls:t,children:e}){return v.useEffect(()=>{for(const n of Object.values(t.icons)){if(!n)continue;const s=Sc();s.crossOrigin="anonymous",s.src=n,s.decode()}for(const n of Object.values(t.embedIcons)){if(!n)continue;const s=Sc();s.crossOrigin="anonymous",s.src=n,s.decode()}},[t]),h.jsx(jT.Provider,{value:t,children:e})}function Iy(){const t=v.useContext(jT);if(!t)throw new Error("useAssetUrls must be used within an AssetUrlsProvider");return t}const $g={"action.toggle-auto-pan":"Auto (trackpad)","action.toggle-auto-zoom":"Auto (mouse)","action.toggle-auto-none":"Auto","action.toggle-mouse":"Mouse","action.toggle-trackpad":"Trackpad","action.convert-to-bookmark":"Convert to bookmark","action.convert-to-embed":"Convert to embed","action.open-embed-link":"Open link","action.align-bottom":"Align bottom","action.align-center-horizontal":"Align horizontally","action.align-center-vertical":"Align vertically","action.align-center-horizontal.short":"Align H","action.align-center-vertical.short":"Align V","action.align-left":"Align left","action.align-right":"Align right","action.align-top":"Align top","action.back-to-content":"Back to content","action.bring-forward":"Bring forward","action.bring-to-front":"Bring to front","action.copy-as-png.short":"PNG","action.copy-as-png":"Copy as PNG","action.copy-as-svg.short":"SVG","action.copy-as-svg":"Copy as SVG","action.copy":"Copy","action.cut":"Cut","action.delete":"Delete","action.unlock-all":"Unlock all","action.distribute-horizontal":"Distribute horizontally","action.distribute-vertical":"Distribute vertically","action.distribute-horizontal.short":"Distribute H","action.distribute-vertical.short":"Distribute V","action.download-original":"Download original","action.duplicate":"Duplicate","action.edit-link":"Edit link","action.exit-pen-mode":"Exit pen mode","action.export-as-png.short":"PNG","action.export-as-png":"Export as PNG","action.export-as-svg.short":"SVG","action.export-as-svg":"Export as SVG","action.export-all-as-png.short":"PNG","action.export-all-as-png":"Export as PNG","action.export-all-as-svg.short":"SVG","action.export-all-as-svg":"Export as SVG","action.fit-frame-to-content":"Fit to content","action.flip-horizontal":"Flip horizontally","action.flip-vertical":"Flip vertically","action.flip-horizontal.short":"Flip H","action.flip-vertical.short":"Flip V","action.fork-project":"Fork this project","action.fork-project-on-tldraw":"Fork project on tldraw","action.group":"Group","action.insert-embed":"Insert embed","action.insert-media":"Upload media","action.leave-shared-project":"Leave shared project","action.new-project":"New project","action.new-shared-project":"New shared project","action.open-cursor-chat":"Cursor chat","action.open-kbd-shortcuts":"Open keyboard shortcuts","action.open-file":"Open file","action.pack":"Pack","action.paste":"Paste","action.paste-error-title":"Pasting failed","action.paste-error-description":"Could not paste due to missing clipboard permissions. Please enable the permissions and try again.","action.print":"Print","action.redo":"Redo","action.remove-frame":"Remove frame","action.rename":"Rename","action.rotate-ccw":"Rotate counterclockwise","action.rotate-cw":"Rotate clockwise","action.save-copy":"Save a copy","action.select-all":"Select all","action.select-none":"Select none","action.send-backward":"Send backward","action.send-to-back":"Send to back","action.share-project":"Share this project","action.stack-horizontal":"Stack horizontally","action.stack-vertical":"Stack vertically","action.stack-horizontal.short":"Stack H","action.stack-vertical.short":"Stack V","action.stop-following":"Stop following","action.stretch-horizontal":"Stretch horizontally","action.stretch-vertical":"Stretch vertically","action.stretch-horizontal.short":"Stretch H","action.stretch-vertical.short":"Stretch V","action.toggle-auto-size":"Toggle auto size","action.toggle-dark-mode.menu":"Dark mode","action.toggle-dark-mode":"Toggle dark mode","action.toggle-paste-at-cursor.menu":"Paste at cursor","action.toggle-paste-at-cursor":"Toggle paste at cursor","action.toggle-wrap-mode.menu":"Select on wrap","action.toggle-wrap-mode":"Toggle select on wrap","action.toggle-reduce-motion.menu":"Reduce motion","action.toggle-reduce-motion":"Toggle reduce motion","action.toggle-keyboard-shortcuts.menu":"Enable keyboard shortcuts","action.toggle-keyboard-shortcuts":"Toggle keyboard shortcuts","action.enhanced-a11y-mode.menu":"Enhanced accessibility mode","action.enhanced-a11y-mode":"Toggle enhanced accessibility mode","action.toggle-edge-scrolling.menu":"Edge scrolling","action.toggle-edge-scrolling":"Toggle edge scrolling","action.toggle-debug-mode.menu":"Debug mode","action.toggle-debug-mode":"Toggle debug mode","action.toggle-focus-mode.menu":"Focus mode","action.toggle-focus-mode":"Toggle focus mode","action.toggle-dynamic-size-mode.menu":"Dynamic size","action.toggle-dynamic-size-mode":"Toggle dynamic size","action.toggle-grid.menu":"Show grid","action.toggle-grid":"Toggle grid","action.toggle-lock":"Toggle locked","action.flatten-to-image":"Flatten","action.toggle-snap-mode.menu":"Always snap","action.toggle-snap-mode":"Toggle always snap","action.toggle-tool-lock.menu":"Tool lock","action.toggle-tool-lock":"Toggle tool lock","action.toggle-transparent.context-menu":"Transparent","action.toggle-transparent.menu":"Transparent","action.toggle-transparent":"Toggle transparent background","action.undo":"Undo","action.ungroup":"Ungroup","action.zoom-in":"Zoom in","action.zoom-out":"Zoom out","action.zoom-to-100":"Zoom to 100%","action.zoom-to-fit":"Zoom to fit","action.zoom-to-selection":"Zoom to selection","assets.files.size-too-big":"File size is too big","assets.files.maximum-size":"Maximum file size is {size}","assets.files.type-not-allowed":"File type is not allowed","assets.files.upload-failed":"Upload failed","assets.files.amount-too-many":"Too many files","assets.url.failed":"Couldn’t load URL preview","theme.dark":"Dark","theme.light":"Light","theme.system":"System","color-style.white":"White","color-style.black":"Black","color-style.blue":"Blue","color-style.green":"Green","color-style.grey":"Grey","color-style.light-blue":"Light blue","color-style.light-green":"Light green","color-style.light-red":"Light red","color-style.light-violet":"Light violet","color-style.orange":"Orange","color-style.red":"Red","color-style.violet":"Violet","color-style.yellow":"Yellow","fill-style.none":"None","document.default-name":"Untitled","fill-style.semi":"Semi","fill-style.solid":"Solid","fill-style.pattern":"Pattern","fill-style.fill":"Fill","fill-style.lined-fill":"Lined fill","dash-style.dashed":"Dashed","dash-style.dotted":"Dotted","dash-style.draw":"Draw","dash-style.solid":"Solid","size-style.s":"Small","size-style.m":"Medium","size-style.l":"Large","size-style.xl":"Extra large","opacity-style.0.1":"10%","opacity-style.0.25":"25%","opacity-style.0.5":"50%","opacity-style.0.75":"75%","opacity-style.1":"100%","font-style.draw":"Draw","font-style.sans":"Sans","font-style.serif":"Serif","font-style.mono":"Mono","align-style.start":"Start","align-style.middle":"Middle","align-style.end":"End","align-style.justify":"Justify","verticalAlign-style.start":"Top","verticalAlign-style.middle":"Middle","verticalAlign-style.end":"Bottom","geo-style.arrow-down":"Arrow down","geo-style.arrow-left":"Arrow left","geo-style.arrow-right":"Arrow right","geo-style.arrow-up":"Arrow up","geo-style.cloud":"Cloud","geo-style.diamond":"Diamond","geo-style.ellipse":"Ellipse","geo-style.heart":"Heart","geo-style.hexagon":"Hexagon","geo-style.octagon":"Octagon","geo-style.oval":"Oval","geo-style.pentagon":"Pentagon","geo-style.rectangle":"Rectangle","geo-style.rhombus":"Rhombus","geo-style.rhombus-2":"Rhombus left","geo-style.star":"Star","geo-style.trapezoid":"Trapezoid","geo-style.triangle":"Triangle","geo-style.x-box":"X box","geo-style.check-box":"Check box","arrowheadStart-style.none":"None","arrowheadStart-style.arrow":"Arrow","arrowheadStart-style.bar":"Bar","arrowheadStart-style.diamond":"Diamond","arrowheadStart-style.dot":"Dot","arrowheadStart-style.inverted":"Inverted","arrowheadStart-style.pipe":"Pipe","arrowheadStart-style.square":"Square","arrowheadStart-style.triangle":"Triangle","arrowheadEnd-style.none":"None","arrowheadEnd-style.arrow":"Arrow","arrowheadEnd-style.bar":"Bar","arrowheadEnd-style.diamond":"Diamond","arrowheadEnd-style.dot":"Dot","arrowheadEnd-style.inverted":"Inverted","arrowheadEnd-style.pipe":"Pipe","arrowheadEnd-style.square":"Square","arrowheadEnd-style.triangle":"Triangle","spline-style.line":"Line","spline-style.cubic":"Cubic","arrow-kind-style.arc":"Arc","arrow-kind-style.elbow":"Elbow","tool.select":"Select","tool.hand":"Hand","tool.draw":"Draw","tool.eraser":"Eraser","tool.arrow-down":"Arrow down","tool.arrow-left":"Arrow left","tool.arrow-right":"Arrow right","tool.arrow-up":"Arrow up","tool.arrow":"Arrow","tool.cloud":"Cloud","tool.diamond":"Diamond","tool.ellipse":"Ellipse","tool.heart":"Heart","tool.hexagon":"Hexagon","tool.highlight":"Highlight","tool.line":"Line","tool.octagon":"Octagon","tool.oval":"Oval","tool.pentagon":"Pentagon","tool.rectangle":"Rectangle","tool.rhombus":"Rhombus","tool.star":"Star","tool.trapezoid":"Trapezoid","tool.triangle":"Triangle","tool.x-box":"X box","tool.check-box":"Check box","tool.media":"Media","tool.frame":"Frame","tool.note":"Note","tool.laser":"Laser","tool.embed":"Embed","tool.text":"Text","tool.pointer-down":"Pointer down","tool.image-zoom":"Zoom","tool.replace-media":"Replace media","tool.flip-horz":"Flip horizontally","tool.flip-vert":"Flip vertically","tool.rotate-cw":"Rotate","tool.aspect-ratio":"Aspect ratio","tool.aspect-ratio.original":"Original","tool.aspect-ratio.square":"Square (1:1)","tool.aspect-ratio.circle":"Circle (1:1)","tool.aspect-ratio.landscape":"Landscape (4:3)","tool.aspect-ratio.portrait":"Portrait (3:4)","tool.aspect-ratio.wide":"Wide (16:9)","tool.image-toolbar-title":"Image tools","tool.image-crop":"Crop image","tool.image-crop-confirm":"Confirm","tool.media-alt-text":"Alternative text","tool.media-alt-text-desc":"Give a description…","tool.media-alt-text-confirm":"Confirm","tool.rich-text-bold":"Bold","tool.rich-text-italic":"Italic","tool.rich-text-code":"Code","tool.rich-text-highlight":"Highlight","tool.rich-text-strikethrough":"Strikethrough","tool.rich-text-link":"Link","tool.rich-text-link-visit":"Visit link","tool.rich-text-link-remove":"Remove link","tool.rich-text-header":"Header","tool.rich-text-bulletList":"Bulleted list","tool.rich-text-toolbar-title":"Text formatting","tool.rich-text-orderedList":"Ordered list","tool.bookmark":"Bookmark","a11y.status":"Status","a11y.skip-to-main-content":"Move focus to canvas","a11y.shape-index":"{num} of {total}","a11y.shape-image":"Image","a11y.shape-video":"Video","a11y.multiple-shapes":"{num} shapes selected","a11y.select-shape":"Select next shape","a11y.select-shape-direction":"Select shape in direction","a11y.enter-leave-container":"Enter/leave container","a11y.repeat-shape":"Repeat shape","a11y.move-shape":"Move shape","a11y.move-shape-faster":"Move shape faster","a11y.rotate-shape-cw":"Rotate shape clockwise","a11y.rotate-shape-ccw":"Rotate shape counterclockwise","a11y.rotate-shape-cw-fine":"Rotate shape clockwise (fine)","a11y.rotate-shape-ccw-fine":"Rotate shape counterclockwise (fine)","a11y.enlarge-shape":"Enlarge shape","a11y.shrink-shape":"Shrink shape","a11y.pan-camera":"Pan camera","a11y.adjust-shape-styles":"Adjust shape styles","a11y.open-context-menu":"Open context menu","a11y.open-keyboard-shortcuts":"Open keyboard shortcuts","menu.title":"Menu","menu.theme":"Theme","menu.accessibility":"Accessibility","menu.copy-as":"Copy as","menu.edit":"Edit","menu.export-as":"Export as","menu.file":"File","menu.language":"Language","menu.preferences":"Preferences","menu.view":"View","menu.input-mode":"Input mode","context-menu.title":"Context menu","context-menu.edit":"Edit","context-menu.arrange":"Arrange","context-menu.copy-as":"Copy as","context-menu.export-as":"Export as","context-menu.export-all-as":"Export","context-menu.move-to-page":"Move to page","context-menu.reorder":"Reorder","page-menu.title":"Pages","page-menu.create-new-page":"Create new page","page-menu.max-page-count-reached":"Max pages reached","page-menu.new-page-initial-name":"Page 1","page-menu.edit-start":"Edit","page-menu.edit-done":"Done","page-menu.go-to-page":"Go to page","page-menu.submenu.rename":"Rename","page-menu.submenu.duplicate-page":"Duplicate","page-menu.submenu.title":"Menu","page-menu.submenu.move-down":"Move down","page-menu.submenu.move-up":"Move up","page-menu.submenu.delete":"Delete","share-menu.title":"Share","share-menu.save-note":"Download this project to your computer as a .tldr file.","share-menu.fork-note":"Create a new shared project based on this snapshot.","share-menu.share-project":"Share this project","share-menu.copy-link":"Copy editor link","share-menu.create-snapshot-link":"Copy snapshot link","share-menu.snapshot-link-note":"Capture and share this project as a read-only snapshot link.","share-menu.copy-readonly-link":"Copy viewer link","share-menu.offline-note":"Create a new shared project based on your current project.","share-menu.copy-link-note":"Anyone with the link will be able to view and edit this project.","share-menu.copy-readonly-link-note":"Anyone with the link will be able to access this project.","share-menu.project-too-large":"Sorry, this project can’t be shared because it’s too large. We’re working on it!","share-menu.upload-failed":"Sorry, we couldn’t upload your project at the moment. Please try again or let us know if the problem persists.","share-menu.creating-project":"Creating the new project…","share-menu.copied":"Copied link","document-name-menu.copy-link":"Copy link","status.offline":"Offline","people-menu.title":"People","people-menu.change-name":"Change name","people-menu.avatar-color":"Avatar color","people-menu.change-color":"Change color","people-menu.follow":"Following","people-menu.following":"Following","people-menu.leading":"Following you","people-menu.user":"(You)","people-menu.invite":"Invite others","people-menu.anonymous-user":"New user","help-menu.import-tldr-file":"Import file…","help-menu.title":"Help and resources","help-menu.about":"About tldraw","help-menu.discord":"Discord","help-menu.github":"GitHub","help-menu.keyboard-shortcuts":"Keyboard shortcuts","help-menu.twitter":"Twitter","help-menu.terms":"Terms of service","help-menu.privacy":"Privacy policy","actions-menu.title":"Actions","edit-link-dialog.title":"Edit link","edit-link-dialog.invalid-url":"A link must be a valid URL.","edit-link-dialog.detail":"Links will open in a new tab.","edit-link-dialog.url":"URL","edit-link-dialog.clear":"Clear","edit-link-dialog.save":"Continue","edit-link-dialog.cancel":"Cancel","edit-link-dialog.external-link":"External link","embed-dialog.title":"Insert embed","embed-dialog.back":"Back","embed-dialog.create":"Create","embed-dialog.cancel":"Cancel","embed-dialog.url":"URL","embed-dialog.instruction":"Paste in the site’s URL to create the embed.","embed-dialog.invalid-url":"We could not create an embed from that URL.","shortcuts-dialog.title":"Keyboard shortcuts","shortcuts-dialog.edit":"Edit","shortcuts-dialog.file":"File","shortcuts-dialog.preferences":"Preferences","shortcuts-dialog.tools":"Tools","shortcuts-dialog.transform":"Transform","shortcuts-dialog.view":"View","shortcuts-dialog.collaboration":"Collaboration","shortcuts-dialog.a11y":"Accessibility","shortcuts-dialog.text-formatting":"Text formatting","style-panel.title":"Styles","style-panel.align":"Align","style-panel.label-align":"Label align","style-panel.vertical-align":"Vertical align","style-panel.position":"Position","style-panel.arrowheads":"Arrows","style-panel.arrowhead-start":"Start","style-panel.arrowhead-end":"End","style-panel.arrow-kind":"Line","style-panel.color":"Color","style-panel.dash":"Dash","style-panel.fill":"Fill","style-panel.font":"Font","style-panel.geo":"Shape","style-panel.mixed":"Mixed","style-panel.opacity":"Opacity","style-panel.size":"Size","style-panel.spline":"Spline","style-panel.selected":"selected","tool-panel.title":"Tools","tool-panel.more":"More","navigation-zone.title":"Navigation","navigation-zone.minimap":"Minimap","navigation-zone.toggle-minimap":"Toggle minimap","navigation-zone.zoom":"Zoom","focus-mode.toggle-focus-mode":"Toggle focus mode","toast.close":"Close","toast.success":"Success","toast.error":"Error","toast.info":"Info","toast.warning":"Warning","file-system.file-open-error.title":"Could not open file","file-system.file-open-error.not-a-tldraw-file":"The file you tried to open doesn’t look like a tldraw file.","file-system.file-open-error.file-format-version-too-new":"The file you tried to open is from a newer version of tldraw. Please reload the page and try again.","file-system.file-open-error.generic-corrupted-file":"The file you tried to open is corrupted.","file-system.confirm-open.title":"Overwrite current project?","file-system.confirm-open.description":"Opening a file will replace your current project and any unsaved changes will be lost. Are you sure you want to continue?","file-system.confirm-open.cancel":"Cancel","file-system.confirm-open.open":"Open file","file-system.confirm-open.dont-show-again":"Don’t ask again","file-system.confirm-clear.title":"Clear current project?","file-system.confirm-clear.description":"Creating a new project will clear your current project and any unsaved changes will be lost. Are you sure you want to continue?","file-system.confirm-clear.cancel":"Cancel","file-system.confirm-clear.continue":"Continue","file-system.confirm-clear.dont-show-again":"Don’t ask again","file-system.shared-document-file-open-error.title":"Could not open file","file-system.shared-document-file-open-error.description":"Opening files from shared projects is not supported.","sharing.confirm-leave.title":"Leave current project?","sharing.confirm-leave.description":"Are you sure you want to leave this shared project? You can return to it by navigating to its URL.","sharing.confirm-leave.cancel":"Cancel","sharing.confirm-leave.leave":"Leave","sharing.confirm-leave.dont-show-again":"Don’t ask again","toast.error.export-fail.title":"Failed export","toast.error.export-fail.desc":"Failed to export image","toast.error.copy-fail.title":"Failed copy","toast.error.copy-fail.desc":"Failed to copy image","context.pages.new-page":"New page","vscode.file-open.desc":"We’ve updated this document to work with the current version of tldraw. If you’d like to keep the original version (which will work on old.tldraw.com), click below to create a backup.","vscode.file-open.open":"Continue","vscode.file-open.backup":"Backup","vscode.file-open.backup-saved":"Backup saved","vscode.file-open.backup-failed":"Backup failed: this is not a .tldr file.","vscode.file-open.dont-show-again":"Don’t ask again","cursor-chat.type-to-chat":"Type to chat…","app.loading":"Loading tldraw…","handle.resize-top":"Resize top","handle.resize-bottom":"Resize bottom","handle.resize-left":"Resize left","handle.resize-right":"Resize right","handle.resize-top-left":"Resize top left","handle.resize-top-right":"Resize top right","handle.resize-bottom-left":"Resize bottom left","handle.resize-bottom-right":"Resize bottom right","handle.rotate.top_left_rotate":"Rotate top left","handle.rotate.top_right_rotate":"Rotate top right","handle.rotate.bottom_left_rotate":"Rotate bottom left","handle.rotate.bottom_right_rotate":"Rotate bottom right","handle.rotate.mobile_rotate":"Rotate","handle.crop.top":"Crop top","handle.crop.bottom":"Crop bottom","handle.crop.left":"Crop left","handle.crop.right":"Crop right","handle.crop.top-left":"Crop top left","handle.crop.top-right":"Crop top right","handle.crop.bottom-left":"Crop bottom left","handle.crop.bottom-right":"Crop bottom right","ui.close":"Close","ui.checked":"Checked","ui.unchecked":"Unchecked"},D4=new Set(["ar","fa","he","ur","ku"]),Eo={locale:"en",label:"English",messages:$g,dir:"ltr"};async function O4(t,e){if(!(await Qr(e.translations.en)).ok)return console.warn("No main translations found."),Eo;if(t==="en")return Eo;const s=vc.find(o=>o.locale===t);if(!s)return console.warn(`No translation found for locale ${t}`),Eo;const i=await(await Qr(e.translations[s.locale])).json();if(!i)return console.warn(`No messages found for locale ${t}`),Eo;for(const o in Eo.messages)i[o];return{locale:t,label:s.label,dir:D4.has(s.locale)?"rtl":"ltr",messages:{...Eo.messages,...i}}}const _y=v.createContext(null);function L4(){const t=v.useContext(_y);if(!t)throw new Error("useCurrentTranslation must be used inside of <TldrawUiContextProvider />");return t}function OT({overrides:t,locale:e,children:n}){const s=Iy(),[r,i]=v.useState(()=>t&&t.en?{locale:"en",label:"English",dir:"ltr",messages:{...$g,...t.en}}:{locale:"en",label:"English",dir:"ltr",messages:$g});return v.useEffect(()=>{let o=!1;async function a(){const c=await O4(e,s);c&&!o&&(t&&t[e]?i({...c,messages:{...c.messages,...t[e]}}):i(c))}return a(),()=>{o=!0}},[s,e,t]),h.jsx(_y.Provider,{value:r,children:n})}function ae(){const t=L4();return v.useCallback(function(n){return t.messages[n]??n},[t])}const R4={normal:"tlui-button__normal",primary:"tlui-button__primary",danger:"tlui-button__danger",low:"tlui-button__low",icon:"tlui-button__icon",tool:"tlui-button__tool",menu:"tlui-button__menu",help:"tlui-button__help"},Re=v.forwardRef(function({children:e,type:n,htmlButtonType:s,isActive:r,...i},o){return h.jsx("button",{ref:o,type:s||"button",draggable:!1,"data-isactive":r,...i,className:de("tlui-button",R4[n],i.className),children:e})});function F4(){const t=z(),e=ae(),n=v.useRef(null),s=v.useCallback(r=>{t.markEventAsHandled(r),n.current?.blur();const i=t.getCurrentPageShapesInReadingOrder();i.length&&(t.setSelectedShapes([i[0].id]),t.zoomToSelectionIfOffscreen(256,{animation:{duration:t.options.animationMediumMs},inset:0}),t.timers.setTimeout(()=>t.getContainer().focus(),100))},[t]);return h.jsx(Re,{ref:n,type:"low",tabIndex:0,className:"tl-skip-to-main-content",onClick:s,children:e("a11y.skip-to-main-content")})}const B4=v.memo(function(){const e=Tu(),n=ae(),s=$("a11y-msg",()=>e.currentMsg.get(),[]);return $4(s.msg),z4(),s.msg&&h.jsx("div",{"aria-label":n("a11y.status"),"aria-live":s.priority||"assertive",role:"status","aria-hidden":"false",style:{position:"absolute",top:"-10000px",left:"-10000px"},children:s.msg})});function LT(t){const{editor:e,selectedShapeIds:n,msg:s}=t;let r="";const i=n.length;if(i>1)r=s("a11y.multiple-shapes").replace("{num}",i.toString());else if(i===1){const o=n[0],a=e.getShape(o);if(!a)return"";const c=e.getShapeUtil(a.type),l=["image","video"].includes(a.type);let u="";a.type==="geo"?u=s(`geo-style.${a.props.geo}`):l?u=s(`a11y.shape-${a.type}`):u=s(`tool.${a.type}`);const d=e.getCurrentPageShapesInReadingOrder(),p=(d.findIndex(y=>y.id===o)+1).toString(),f=d.length.toString(),g=s("a11y.shape-index").replace("{num}",p).replace("{total}",f),x=c.getAriaDescriptor(a)||c.getText(a)||"";r=(x?`${x}, `:"")+`${u}. ${g}`}return r}const z4=()=>{const t=Tt(),e=Tu(),n=ae(),s=v.useRef([]);Qd("announce selection",()=>{if(!t)return;if(t.isIn("select.idle")){const i=t.getSelectedShapeIds();i!==s.current&&(s.current=i,Yi(()=>{const o=LT({editor:t,selectedShapeIds:i,msg:n});o&&e.announce({msg:o})}))}},[t,e,n])},$4=t=>{const e=Lt();v.useEffect(()=>{if(mt.a11y.get()){const n=r=>{console.debug(`%ca11y%c: ${r}`,"color: white; background: #40C057; padding: 2px;border-radius: 3px;","font-weight: normal")},s=r=>{const i=document.activeElement;if(r.key==="Tab"&&i&&i!==document.body&&!i.classList.contains("tl-container")){const o=i.getAttribute("aria-label")||i.getAttribute("title")||i.textContent;o&&n(o)}};return t&&n(t),document.addEventListener("keyup",s),()=>document.removeEventListener("keyup",s)}},[e,t])},Cc=300,Cy=320,Ng=46,N4=101;function RT(t,e){const n=e?t.getAsset(e):null;return n&&!n.props.image?n.props.title?N4:Ng:Cy}function Qw(t,e){return{...e,props:{...e.props,h:RT(t,e.props.assetId)}}}const U4=t=>{try{return new URL(t).hostname.replace(/^www\./,"")}catch{return t}};function H4(t,e){const{url:n}=e.props,s=mo.createId(S0(n));t.getAsset(s)?e.props.assetId!==s&&t.updateShapes([{id:e.id,type:e.type,props:{assetId:s}}]):(t.updateShapes([{id:e.id,type:e.type,props:{assetId:null}}]),K4(t,e))}const K4=Gd(async(t,e)=>{if(t.isDisposed)return;const{url:n}=e.props,s=await t.getAssetForExternalContent({type:"url",url:n});s&&t.run(()=>{t.createAssets([s]),t.updateShapes([{id:e.id,type:e.type,props:{assetId:s.id}}])})},500);async function FT(t,{url:e,center:n=t.getViewportPageBounds().center}){try{const s=await t.getAssetForExternalContent({type:"url",url:e}),r=tt(),i={id:r,type:"bookmark",x:n.x-Cc/2,y:n.y-Cy/2,rotation:0,opacity:1,props:{url:e,assetId:s?.id||null,w:Cc,h:RT(t,s?.id)}};t.run(()=>{s&&t.createAssets([s]),t.createShapes([i])});const o=t.getShape(r);return Bs.ok(o)}catch(s){return Bs.err(s instanceof Error?s.message:"Failed to create bookmark")}}function W4(t,e){const n=ve(e.map(r=>t.getShape(r)).filter(r=>r&&t.isShapeOfType(r,"frame")));if(!n.length)return;const s=[];t.run(()=>{n.map(r=>{const i=t.getSortedChildIdsForParent(r.id);i.length&&(Qe(t,i,{filter:o=>!n.find(a=>a.id===o.id)}),s.push(...i))}),t.setSelectedShapes(s),t.deleteShapes(e)})}const ev=50;function BT(t,e,n={padding:ev}){const s=X.FromPoints(t.flatMap(l=>{if(!l)return[];const u=e.getShapeGeometry(l.id);return e.getShapeLocalTransform(l)?.applyToPoints(u.vertices)??[]})),r=n.padding??ev,i=s.w+2*r,o=s.h+2*r,a=r-s.minX,c=r-s.minY;return{w:i,h:o,dx:a,dy:c}}function zT(t,e,n={}){const s=t.getShape(e);if(!s)return;const r=t.getSortedChildIdsForParent(s.id),i=ve(r.map(d=>t.getShape(d)));if(!i.length)return;const{w:o,h:a,dx:c,dy:l}=BT(i,t,n);if(c===0&&l===0&&s.props.w===o&&s.props.h===a)return;const u=new b(c,l).rot(s.rotation);t.run(()=>{const d=r.map(p=>{const f=t.getShape(p);return{id:f.id,type:f.type,x:f.x+c,y:f.y+l}});d.push({id:s.id,type:s.type,x:s.x-u.x,y:s.y-u.y,props:{w:o,h:a}}),t.updateShapes(d)})}function Mt({children:t}){return h.jsx("span",{className:"tlui-button__label",children:t})}const wr=v.memo(function({label:e,small:n,invertIcon:s,icon:r,color:i,className:o,...a}){return typeof r=="string"?h.jsx(q4,{label:e,small:n,invertIcon:s,icon:r,color:i,className:o,...a}):v.cloneElement(r,{...a,className:de({"tlui-icon__small":n},o,r.props.className),"aria-label":e,style:{color:i,transform:s?"scale(-1, 1)":void 0,...r.props.style}})});function q4({label:t,small:e,invertIcon:n,icon:s,color:r,className:i,...o}){const a=Iy(),c=a.icons[s]??a.icons["question-mark-circle"],l=v.useRef(null);return v.useLayoutEffect(()=>{c||console.error(`Icon not found: ${s}. Add it to the assetUrls.icons object.`),l?.current&&(l.current.style.webkitMask=`url(${c}) center 100% / 100% no-repeat`)},[l,c,s]),s==="none"?h.jsx("div",{className:de("tlui-icon tlui-icon__placeholder",{"tlui-icon__small":e},i),...o}):h.jsx("div",{...o,ref:l,"aria-label":t,role:"img",className:de("tlui-icon",{"tlui-icon__small":e},i),style:{color:r,mask:`url(${c}) center 100% / 100% no-repeat`,transform:n?"scale(-1, 1)":void 0}})}function Se({icon:t,small:e,invertIcon:n}){return h.jsx(wr,{"aria-hidden":"true",label:"",className:"tlui-button__icon",icon:t,small:e,invertIcon:n})}function Eu({className:t,children:e}){return h.jsx("div",{className:de("tlui-dialog__header",t),children:e})}function ku({className:t,children:e,style:n}){return h.jsx(xk,{dir:"ltr",className:de("tlui-dialog__header__title",t),style:n,children:e})}function Au(){const t=ae();return h.jsx("div",{className:"tlui-dialog__header__close",children:h.jsx(bk,{"data-testid":"dialog.close",dir:"ltr",asChild:!0,children:h.jsx(Re,{type:"icon","aria-label":t("ui.close"),onTouchEnd:e=>e.target.click(),children:h.jsx(Se,{small:!0,icon:"cross-2"})})})})}function Tc({className:t,children:e,style:n}){return h.jsx("div",{className:de("tlui-dialog__body",t),style:n,tabIndex:0,children:e})}function Ty({className:t,children:e}){return h.jsx("div",{className:de("tlui-dialog__footer",t),children:e})}const ba=v.forwardRef(function({className:e,label:n,icon:s,iconLeft:r,iconLabel:i,autoSelect:o=!1,autoFocus:a=!1,defaultValue:c,placeholder:l,onComplete:u,onValueChange:d,onCancel:p,onFocus:f,onBlur:g,shouldManuallyMaintainScrollPositionWhenFocused:x=!1,children:y,value:m,"data-testid":S,disabled:w,"aria-label":P},_){const I=Tt(),C=v.useRef(null);v.useImperativeHandle(_,()=>C.current);const E=ae(),O=v.useRef(c??""),k=v.useRef(c??""),T=v.useRef(!1),[D,R]=v.useState(!1),M=v.useCallback(Q=>{R(!0);const Y=Q.currentTarget;k.current=Y.value,I?I.timers.requestAnimationFrame(()=>{o&&Y.select()}):Od.requestAnimationFrame("anon",()=>{o&&Y.select()}),f?.()},[o,I,f]),L=v.useCallback(Q=>{const Y=Q.currentTarget.value;k.current=Y,d?.(Y)},[d]),U=v.useCallback(Q=>{switch(Q.key){case"Enter":{if(T.current)return;Q.currentTarget.blur(),Q.stopPropagation(),u?.(Q.currentTarget.value);break}case"Escape":{Q.currentTarget.value=O.current,p?.(Q.currentTarget.value),Q.currentTarget.blur(),Q.stopPropagation();break}}},[u,p]),V=v.useCallback(Q=>{R(!1);const Y=Q.currentTarget.value;g?.(Y)},[g]),J=v.useCallback(()=>T.current=!0,[]),Z=v.useCallback(()=>T.current=!1,[]);return v.useEffect(()=>{if(!qe.isIos)return;const Q=window.visualViewport;if(D&&x&&Q){const Y=()=>{C.current?.scrollIntoView({block:"center"})};return Q.addEventListener("resize",Y),Q.addEventListener("scroll",Y),I?I.timers.requestAnimationFrame(()=>{C.current?.scrollIntoView({block:"center"})}):Od.requestAnimationFrame("anon",()=>{C.current?.scrollIntoView({block:"center"})}),()=>{Q.removeEventListener("resize",Y),Q.removeEventListener("scroll",Y)}}},[D,I,x]),h.jsxs("div",{draggable:!1,className:"tlui-input__wrapper",children:[y,n&&h.jsx("label",{children:E(n)}),r&&h.jsx(wr,{label:i?E(i):"",icon:r,className:"tlui-icon-left",small:!0}),h.jsx("input",{ref:C,className:de("tlui-input",e),type:"text",defaultValue:c,onKeyDownCapture:U,onChange:L,onFocus:M,onBlur:V,onCompositionStart:J,onCompositionEnd:Z,autoFocus:a,"aria-label":P,placeholder:l,value:m,"data-testid":S,disabled:w}),s&&h.jsx(wr,{label:i?E(i):"",icon:s,small:!!n})]})});function tv(t){return ws.isValid(t)?{isValid:!0,hasProtocol:!0}:ws.isValid("https://"+t)?{isValid:!0,hasProtocol:!1}:{isValid:!1,hasProtocol:!1}}function $T(t){return!!(t&&"url"in t.props&&typeof t.props.url=="string")}function nv(t){if(!$T(t))throw new Error("Shape is not a valid ShapeWithUrl")}const G4=Ot(function({onClose:e}){const s=z().getOnlySelectedShape();return $T(s)?h.jsx(Y4,{onClose:e,selectedShape:s}):null}),Y4=Ot(function({onClose:e,selectedShape:n}){const s=z(),r=ae(),i=v.useRef(null);v.useEffect(()=>{s.timers.requestAnimationFrame(()=>i.current?.focus())},[s]);const o=v.useRef(n.props.url),[a,c]=v.useState(()=>{const g=tv(n.props.url),x=g.isValid===!0?g.hasProtocol?n.props.url:"https://"+n.props.url:"https://";return{actual:x,safe:x,valid:!0}}),l=v.useCallback(g=>{const x=g.replace(/https?:\/\/(https?:\/\/)/,(S,w)=>w),y=tv(x),m=y.isValid===!0?y.hasProtocol?x:"https://"+x:"https://";c({actual:x,safe:m,valid:y.isValid})},[]),u=v.useCallback(()=>{const g=s.getOnlySelectedShape();g&&(nv(g),s.updateShapes([{id:g.id,type:g.type,props:{url:""}}]),e())},[s,e]),d=v.useCallback(()=>{const g=s.getOnlySelectedShape();g&&(nv(g),g&&"url"in g.props&&g.props.url!==a.safe&&s.updateShapes([{id:g.id,type:g.type,props:{url:a.safe}}]),e())},[s,e,a]),p=v.useCallback(()=>{e()},[e]);if(!n)return e(),null;const f=o.current&&!a.valid;return h.jsxs(h.Fragment,{children:[h.jsxs(Eu,{children:[h.jsx(ku,{children:r("edit-link-dialog.title")}),h.jsx(Au,{})]}),h.jsx(Tc,{children:h.jsxs("div",{className:"tlui-edit-link-dialog",children:[h.jsx(ba,{ref:i,className:"tlui-edit-link-dialog__input",label:"edit-link-dialog.url",autoFocus:!0,autoSelect:!0,placeholder:"https://example.com",value:a.actual,onValueChange:l,onComplete:d,onCancel:p}),h.jsx("div",{children:a.valid?r("edit-link-dialog.detail"):r("edit-link-dialog.invalid-url")})]})}),h.jsxs(Ty,{className:"tlui-dialog__footer__actions",children:[h.jsx(Re,{type:"normal",onClick:p,onTouchEnd:p,children:h.jsx(Mt,{children:r("edit-link-dialog.cancel")})}),f?h.jsx(Re,{type:"danger",onTouchEnd:u,onClick:u,children:h.jsx(Mt,{children:r("edit-link-dialog.clear")})}):h.jsx(Re,{type:"primary",disabled:!a.valid,onTouchEnd:d,onClick:d,children:h.jsx(Mt,{children:r("edit-link-dialog.save")})})]})]})});var V4={};const sv=/(^\/[f|p|r|ro|s|v]\/[^/]+\/?$)/,Ey=[{type:"tldraw",title:"tldraw",hostnames:["beta.tldraw.com","tldraw.com","localhost:3000"],minWidth:300,minHeight:300,width:720,height:500,doesResize:!0,overridePermissions:{"allow-top-navigation":!0},toEmbedUrl:t=>{const e=Ee(t);if(e&&e.pathname.match(sv))return e.searchParams.append("embed","true"),t},fromEmbedUrl:t=>{const e=Ee(t);if(e&&e.pathname.match(sv))return e.searchParams.delete("embed"),t},embedOnPaste:!1},{type:"figma",title:"Figma",hostnames:["figma.com"],width:720,height:500,doesResize:!0,toEmbedUrl:t=>{if(t.match(/https:\/\/([\w\.-]+\.)?figma.com\/(file|proto|design)\/([0-9a-zA-Z]{22,128})(?:\/.*)?$/)&&!t.includes("figma.com/embed"))return`https://www.figma.com/embed?embed_host=share&url=${t}`},fromEmbedUrl:t=>{const e=Ee(t);if(e&&e.pathname.match(/^\/embed\/?$/)){const n=e.searchParams.get("url");if(n)return n}},embedOnPaste:!0},{type:"google_maps",title:"Google Maps",hostnames:["google.*"],width:720,height:500,doesResize:!0,overridePermissions:{"allow-presentation":!0},toEmbedUrl:t=>{if(t.includes("/maps/embed?"))return t;if(t.includes("/maps/")){const e=t.match(/@(.*?),(.*?),(.*?)(z|m)/);let n;if(e){const[,s,r,i,o]=e,a=o==="z"?"roadmap":"satellite",c=a==="roadmap"?i:-Math.log2(parseInt(i)/14772321)/.8;n=`https://${new URL(t).host.replace("www.","")}/maps/embed/v1/view?key=${V4.NEXT_PUBLIC_GC_API_KEY}&center=${s},${r}&zoom=${c}&maptype=${a}`}else n="";return n}},fromEmbedUrl:t=>{const e=Ee(t);if(!e)return;if(e.pathname.match(/^\/maps\/embed\/v1\/view\/?$/)&&e.searchParams.has("center")&&e.searchParams.get("zoom")){const s=e.searchParams.get("zoom")??"12",r=e.searchParams.get("maptype")??"roadmap",i=r==="roadmap"?s:14772321*Math.pow(2,parseInt(s)*-.8),[o,a]=e.searchParams.get("center").split(",");return`https://www.google.com/maps/@${o},${a},${i}${r==="roadmap"?"z":"m"}`}},embedOnPaste:!0},{type:"val_town",title:"Val Town",hostnames:["val.town"],minWidth:260,minHeight:100,width:720,height:500,doesResize:!0,toEmbedUrl:t=>{const e=Ee(t),n=e&&e.pathname.match(/\/v\/(.+)\/?/);if(n)return`https://www.val.town/embed/${n[1]}`},fromEmbedUrl:t=>{const e=Ee(t),n=e&&e.pathname.match(/\/embed\/(.+)\/?/);if(n)return`https://www.val.town/v/${n[1]}`},embedOnPaste:!0},{type:"codesandbox",title:"CodeSandbox",hostnames:["codesandbox.io"],minWidth:300,minHeight:300,width:720,height:500,doesResize:!0,toEmbedUrl:t=>{const e=Ee(t),n=e&&e.pathname.match(/\/s\/([^/]+)\/?/);if(n)return`https://codesandbox.io/embed/${n[1]}`},fromEmbedUrl:t=>{const e=Ee(t),n=e&&e.pathname.match(/\/embed\/([^/]+)\/?/);if(n)return`https://codesandbox.io/s/${n[1]}`},embedOnPaste:!0},{type:"codepen",title:"Codepen",hostnames:["codepen.io"],minWidth:300,minHeight:300,width:520,height:400,doesResize:!0,toEmbedUrl:t=>{const e=/https:\/\/codepen.io\/([^/]+)\/pen\/([^/]+)/,n=t.match(e);if(n){const[s,r,i]=n;return`https://codepen.io/${r}/embed/${i}`}},fromEmbedUrl:t=>{const e=/https:\/\/codepen.io\/([^/]+)\/embed\/([^/]+)/,n=t.match(e);if(n){const[s,r,i]=n;return`https://codepen.io/${r}/pen/${i}`}},embedOnPaste:!0},{type:"scratch",title:"Scratch",hostnames:["scratch.mit.edu"],width:520,height:400,doesResize:!1,embedOnPaste:!0,toEmbedUrl:t=>{const e=/https?:\/\/scratch.mit.edu\/projects\/([^/]+)/,n=t.match(e);if(n){const[s,r]=n;return`https://scratch.mit.edu/projects/embed/${r}`}},fromEmbedUrl:t=>{const e=/https:\/\/scratch.mit.edu\/projects\/embed\/([^/]+)/,n=t.match(e);if(n){const[s,r]=n;return`https://scratch.mit.edu/projects/${r}`}}},{type:"youtube",title:"YouTube",hostnames:["*.youtube.com","youtube.com","youtu.be"],width:800,height:450,doesResize:!0,overridePermissions:{"allow-presentation":!0,"allow-popups-to-escape-sandbox":!0},isAspectRatioLocked:!0,embedOnPaste:!0,toEmbedUrl:t=>{const e=Ee(t);if(!e)return;const n=e.hostname.replace(/^www./,"");if(n==="youtu.be"){const s=e.pathname.split("/").filter(Boolean)[0],r=new URLSearchParams(e.search),i=r.get("t");i&&(r.set("start",i),r.delete("t"));const o=r.toString()?"?"+r.toString():"";return`https://www.youtube.com/embed/${s}${o}`}else if((n==="youtube.com"||n==="m.youtube.com")&&e.pathname.match(/^\/watch/)){const s=e.searchParams.get("v"),r=new URLSearchParams(e.search);r.delete("v");const i=r.get("t");i&&(r.set("start",i),r.delete("t"));const o=r.toString()?"?"+r.toString():"";return`https://www.youtube.com/embed/${s}${o}`}},fromEmbedUrl:t=>{const e=Ee(t);if(!e)return;if(e.hostname.replace(/^www./,"")==="youtube.com"){const s=e.pathname.match(/^\/embed\/([^/]+)\/?/);if(s){const r=new URLSearchParams(e.search);r.set("v",s?.[1]??"");const i=r.get("start");return i&&(r.set("t",i),r.delete("start")),`https://www.youtube.com/watch?${r.toString()}`}}}},{type:"google_calendar",title:"Google Calendar",hostnames:["calendar.google.*"],width:720,height:500,minWidth:460,minHeight:360,doesResize:!0,instructionLink:"https://support.google.com/calendar/answer/41207?hl=en",overridePermissions:{"allow-popups-to-escape-sandbox":!0},embedOnPaste:!0,toEmbedUrl:t=>{const e=Ee(t),n=e?.searchParams.get("cid");if(e?.pathname.match(/\/calendar\/u\/0/)&&n){e.pathname="/calendar/embed";const s=Array.from(e.searchParams.keys());for(const r of s)e.searchParams.delete(r);return e.searchParams.set("src",n),e.href}},fromEmbedUrl:t=>{const e=Ee(t),n=e?.searchParams.get("src");if(e?.pathname.match(/\/calendar\/embed/)&&n){e.pathname="/calendar/u/0";const s=Array.from(e.searchParams.keys());for(const r of s)e.searchParams.delete(r);return e.searchParams.set("cid",n),e.href}}},{type:"google_slides",title:"Google Slides",hostnames:["docs.google.*"],width:720,height:500,minWidth:460,minHeight:360,doesResize:!0,overridePermissions:{"allow-popups-to-escape-sandbox":!0},embedOnPaste:!0,toEmbedUrl:t=>{const e=Ee(t);if(e?.pathname.match(/^\/presentation/)&&e?.pathname.match(/\/pub\/?$/)){e.pathname=e.pathname.replace(/\/pub$/,"/embed");const n=Array.from(e.searchParams.keys());for(const s of n)e.searchParams.delete(s);return e.href}},fromEmbedUrl:t=>{const e=Ee(t);if(e?.pathname.match(/^\/presentation/)&&e?.pathname.match(/\/embed\/?$/)){e.pathname=e.pathname.replace(/\/embed$/,"/pub");const n=Array.from(e.searchParams.keys());for(const s of n)e.searchParams.delete(s);return e.href}}},{type:"github_gist",title:"GitHub Gist",hostnames:["gist.github.com"],width:720,height:500,doesResize:!0,embedOnPaste:!0,toEmbedUrl:t=>{const e=Ee(t);if(e&&e.pathname.match(/\/([^/]+)\/([0-9a-f]+)$/))return t.split("/").pop()?t:void 0},fromEmbedUrl:t=>{const e=Ee(t);if(e&&e.pathname.match(/\/([^/]+)\/([0-9a-f]+)$/))return t.split("/").pop()?t:void 0}},{type:"replit",title:"Replit",hostnames:["replit.com"],width:720,height:500,doesResize:!0,embedOnPaste:!0,toEmbedUrl:t=>{const e=Ee(t);if(e&&e.pathname.match(/\/@([^/]+)\/([^/]+)/))return e.searchParams.append("embed","true"),e.href},fromEmbedUrl:t=>{const e=Ee(t);if(e&&e.pathname.match(/\/@([^/]+)\/([^/]+)/)&&e.searchParams.has("embed"))return e.searchParams.delete("embed"),e.href}},{type:"felt",title:"Felt",hostnames:["felt.com"],width:720,height:500,doesResize:!0,embedOnPaste:!0,toEmbedUrl:t=>{const e=Ee(t);if(e&&e.pathname.match(/^\/map\//))return e.origin+"/embed"+e.pathname},fromEmbedUrl:t=>{const e=Ee(t);if(e&&e.pathname.match(/^\/embed\/map\//))return e.pathname=e.pathname.replace(/^\/embed/,""),e.href}},{type:"spotify",title:"Spotify",hostnames:["open.spotify.com"],width:720,height:500,minHeight:500,overrideOutlineRadius:12,doesResize:!0,embedOnPaste:!0,toEmbedUrl:t=>{const e=Ee(t);if(e&&e.pathname.match(/^\/(artist|album)\//))return e.origin+"/embed"+e.pathname},fromEmbedUrl:t=>{const e=Ee(t);if(e&&e.pathname.match(/^\/embed\/(artist|album)\//))return e.origin+e.pathname.replace(/^\/embed/,"")}},{type:"vimeo",title:"Vimeo",hostnames:["vimeo.com","player.vimeo.com"],width:640,height:360,doesResize:!0,isAspectRatioLocked:!0,embedOnPaste:!0,toEmbedUrl:t=>{const e=Ee(t);if(e&&e.hostname==="vimeo.com"&&e.pathname.match(/^\/[0-9]+/))return"https://player.vimeo.com/video/"+e.pathname.split("/")[1]+"?title=0&byline=0"},fromEmbedUrl:t=>{const e=Ee(t);if(e&&e.hostname==="player.vimeo.com"){const n=e.pathname.match(/^\/video\/([^/]+)\/?$/);if(n)return"https://vimeo.com/"+n[1]}}},{type:"observable",title:"Observable",hostnames:["observablehq.com"],width:720,height:500,doesResize:!0,isAspectRatioLocked:!1,backgroundColor:"#fff",embedOnPaste:!0,toEmbedUrl:t=>{const e=Ee(t);if(e&&e.pathname.match(/^\/@([^/]+)\/([^/]+)\/?$/))return`${e.origin}/embed${e.pathname}?cell=*`;if(e&&e.pathname.match(/^\/d\/([^/]+)\/?$/)){const n=e.pathname.replace(/^\/d/,"");return`${e.origin}/embed${n}?cell=*`}},fromEmbedUrl:t=>{const e=Ee(t);if(e&&e.pathname.match(/^\/embed\/@([^/]+)\/([^/]+)\/?$/))return`${e.origin}${e.pathname.replace("/embed","")}#cell-*`;if(e&&e.pathname.match(/^\/embed\/([^/]+)\/?$/))return`${e.origin}${e.pathname.replace("/embed","/d")}#cell-*`}},{type:"desmos",title:"Desmos",hostnames:["desmos.com"],width:700,height:450,doesResize:!0,embedOnPaste:!0,toEmbedUrl:t=>{const e=Ee(t);if(e&&e.hostname==="www.desmos.com"&&e.pathname.match(/^\/calculator\/([^/]+)\/?$/)&&e.search===""&&e.hash==="")return`${t}?embed`},fromEmbedUrl:t=>{const e=Ee(t);if(e&&e.hostname==="www.desmos.com"&&e.pathname.match(/^\/calculator\/([^/]+)\/?$/)&&e.search==="?embed"&&e.hash==="")return t.replace("?embed","")}}],X4={"allow-downloads-without-user-activation":!1,"allow-downloads":!1,"allow-modals":!1,"allow-orientation-lock":!1,"allow-pointer-lock":!1,"allow-popups":!0,"allow-popups-to-escape-sandbox":!1,"allow-presentation":!1,"allow-storage-access-by-user-activation":!1,"allow-top-navigation":!1,"allow-top-navigation-by-user-activation":!1,"allow-scripts":!0,"allow-same-origin":!0,"allow-forms":!0},Z4=Ey.map(t=>t.type);function J4(t){return Z4.includes(t)}function Q4(t){return"icon"in t}function NT(){const t=Tt();if(t&&t.hasShapeUtil("embed"))return t.getShapeUtil("embed")}function ky(){const t=NT();return e=>t?t.getEmbedDefinition(e):void 0}function eB(){const t=NT();return t?t.getEmbedDefinitions():[]}const UT=Ot(function({onClose:e}){const n=z(),s=ae(),r=Iy(),[i,o]=v.useState(null),[a,c]=v.useState(""),[l,u]=v.useState(null),[d,p]=v.useState(!1),f=v.useRef(-1),g=eB(),x=ky();return h.jsxs(h.Fragment,{children:[h.jsxs(Eu,{children:[h.jsx(ku,{children:i?`${s("embed-dialog.title")} — ${i.title}`:s("embed-dialog.title")}),h.jsx(Au,{})]}),i?h.jsxs(h.Fragment,{children:[h.jsxs(Tc,{className:"tlui-embed-dialog__enter",children:[h.jsx(ba,{className:"tlui-embed-dialog__input",label:"embed-dialog.url",placeholder:"https://example.com",autoFocus:!0,onValueChange:y=>{c(y);const m=x(y);u(m&&m.definition.type===i.type?m:null),p(!1),clearTimeout(f.current),f.current=n.timers.setTimeout(()=>p(!m),320)}}),a===""?h.jsxs("div",{className:"tlui-embed-dialog__instruction",children:[h.jsx("span",{children:s("embed-dialog.instruction")})," ",i.instructionLink&&h.jsxs(h.Fragment,{children:[h.jsx("a",{target:"_blank",rel:"noopener noreferrer",href:i.instructionLink,className:"tlui-embed-dialog__instruction__link",children:"Learn more"}),"."]})]}):h.jsx("div",{className:"tlui-embed-dialog__warning",children:d?s("embed-dialog.invalid-url"):" "})]}),h.jsxs(Ty,{className:"tlui-dialog__footer__actions",children:[h.jsx(Re,{type:"normal",onClick:()=>{o(null),u(null),c("")},children:h.jsx(Mt,{children:s("embed-dialog.back")})}),h.jsx("div",{className:"tlui-embed__spacer"}),h.jsx(Re,{type:"normal",onClick:e,children:h.jsx(Mt,{children:s("embed-dialog.cancel")})}),h.jsx(Re,{type:"primary",disabled:!l,onClick:()=>{l&&(n.putExternalContent({type:"embed",url:a,point:n.getViewportPageBounds().center,embed:l.definition}),e())},children:h.jsx(Mt,{children:s("embed-dialog.create")})})]})]}):h.jsx(h.Fragment,{children:h.jsx(Tc,{className:"tlui-embed-dialog__list",children:g.map(y=>{const m=J4(y.type)?r.embedIcons[y.type]:Q4(y)?y.icon:void 0;return h.jsxs(Re,{type:"menu",onClick:()=>o(y),children:[h.jsx(Mt,{children:y.title}),m&&h.jsx("div",{className:"tlui-embed-dialog__item__image",style:{backgroundImage:`url(${m})`}})]},y.type)})})})]})}),cd=[0,389,436,476,580,640,840,1023];var yt=(t=>(t[t.ZERO=0]="ZERO",t[t.MOBILE_XXS=1]="MOBILE_XXS",t[t.MOBILE_XS=2]="MOBILE_XS",t[t.MOBILE_SM=3]="MOBILE_SM",t[t.MOBILE=4]="MOBILE",t[t.TABLET_SM=5]="TABLET_SM",t[t.TABLET=6]="TABLET",t[t.DESKTOP=7]="DESKTOP",t))(yt||{});const HT=Ye.createContext(null);function tB({forceMobile:t=!1,children:e}){const n=Tt(),s=$("breakpoint",()=>{const{width:r}=n?.getViewportScreenBounds()??{width:window.innerWidth},i=t?yt.MOBILE_SM:cd.length-1;for(let o=0;o<i;o++)if(r>cd[o]&&r<=cd[o+1])return o;return i},[n]);return h.jsx(HT.Provider,{value:s,children:e})}function hn(){const t=v.useContext(HT);if(t===null)throw new Error("useBreakpoint must be used inside of the <BreakpointProvider /> component");return t}const KT=v.createContext(null);function Mu(){const t=v.useContext(KT);if(!t)throw new Error("useTldrawUiMenuContext must be used within a TldrawUiMenuContextProvider");return t}function Kn({type:t,sourceId:e,children:n}){return h.jsx(KT.Provider,{value:{type:t,sourceId:e},children:n})}function ju(){return Tt()?.store.props.collaboration!==void 0}function nB(){const t=Tt();return $("sync status",()=>t?.store.props.collaboration?.status?t.store.props.collaboration.status.get():null,[t])}function _s(){const t=Tt();return $("isReadonlyMode",()=>!!t?.getIsReadonly(),[t])}const rv=qe.isDarwin?"⌘":"__CTRL__",sB=qe.isDarwin?"⌃":"__CTRL__",iv=qe.isDarwin?"⌥":"__ALT__";function WT(t){return t===","?[","]:t.split(",")[0].split(/(\[\[[^\]]+\]\])/g).map(e=>e.startsWith("[[")?e.replace(/[[\]]/g,""):e.replace(/cmd\+/g,rv).replace(/ctrl\+/g,sB).replace(/alt\+/g,iv).replace(/shift\+/g,"⇧").replace(/\$/g,rv).replace(/\?/g,iv).replace(/!/g,"⇧").match(/__CTRL__|__ALT__|./g)||[]).flat().map((e,n)=>{if(e[0]==="+")return[];let s;return e==="__CTRL__"?s="Ctrl":e==="__ALT__"?s="Alt":s=e[0].toUpperCase()+e.slice(1),qe.isDarwin||!n?s:["+",s]}).flat()}function Fd(t){return"— "+WT(t).join(" ")}function qT(t){const e=ae();return h.jsx(vT,{"aria-label":e("app.loading"),...t})}const GT=()=>{},YT=v.createContext(null);function rB({onEvent:t,children:e}){return h.jsx(YT.Provider,{value:t??GT,children:e})}function St(){return v.useContext(YT)??GT}function ii(t,e){const n=Tt(),s=v.useCallback(o=>{o&&n?.complete(),e?.(o)},[n,e]),r=St(),i=v.useCallback(o=>{r(o,{source:"unknown",id:t})},[t,r]);return g4(n?`${t}-${n.contextId}`:t,s,i)}function Du({id:t,children:e,modal:n=!1,debugOpen:s=!1}){const[r,i]=ii(t);return h.jsx(sm,{open:s||r,dir:"ltr",modal:n,onOpenChange:i,children:e})}function Ou({children:t,...e}){return h.jsx(rm,{dir:"ltr",asChild:!0,onTouchEnd:n=>Pe(n),...e,children:t})}function Lu({className:t,side:e="bottom",align:n="start",sideOffset:s=8,alignOffset:r=8,children:i}){const o=Lt();return h.jsx(qd,{container:o,children:h.jsx(im,{className:de("tlui-menu",t),side:e,sideOffset:s,align:n,alignOffset:r,collisionPadding:4,children:i})})}function iB({id:t,children:e}){const[n,s]=ii(t);return h.jsx(vk,{open:n,onOpenChange:s,children:e})}function oB({id:t,label:e,title:n,disabled:s}){return h.jsx(Pk,{dir:"ltr",asChild:!0,disabled:s,children:h.jsxs(Re,{"data-testid":t,type:"menu",className:"tlui-menu__submenu__trigger",disabled:s,title:n,children:[h.jsx(Mt,{children:e}),h.jsx(Se,{icon:"chevron-right",small:!0})]})})}function aB({id:t,alignOffset:e=-1,sideOffset:n=-6,size:s="small",children:r}){const i=Lt();return h.jsx(qd,{container:i,children:h.jsx(Ik,{"data-testid":t,className:"tlui-menu tlui-menu__submenu__content",alignOffset:e,sideOffset:n,collisionPadding:4,"data-size":s,children:r})})}function cB({className:t,children:e}){return h.jsx("div",{dir:"ltr",className:de("tlui-menu__group",t),children:e})}function lB({noClose:t,children:e}){return h.jsx(wk,{dir:"ltr",asChild:!0,onClick:t?Pe:void 0,children:e})}function dB({children:t,onSelect:e,...n}){const s=ae();return h.jsxs(l0,{dir:"ltr",className:"tlui-button tlui-button__menu tlui-button__checkbox",onSelect:r=>{e?.(r),Pe(r)},...n,children:[h.jsx("div",{className:"tlui-button__checkbox__indicator",children:h.jsx(_k,{dir:"ltr",children:h.jsx(wr,{label:s("ui.checked"),icon:"check",small:!0})})}),t]})}function pc({children:t,visibleOnMobileLayout:e=!1}){const n=hn();return!e&&n<yt.MOBILE?null:h.jsx("kbd",{className:"tlui-kbd",children:WT(t).map((s,r)=>h.jsx("span",{children:s},r))})}const VT=v.createContext({orientation:"horizontal",tooltipSide:"bottom"});function Ru({children:t,orientation:e,tooltipSide:n}){const s=sl(),r=n??(e===s.orientation?s.tooltipSide:e==="horizontal"?"bottom":"right");return h.jsx(VT.Provider,{value:{orientation:e,tooltipSide:r},children:t})}function sl(){return v.useContext(VT)}const xo=v.forwardRef(({asChild:t,className:e,tooltipSide:n,...s},r)=>{const i=t?om:"div";return h.jsx(Ru,{orientation:"horizontal",tooltipSide:n,children:h.jsx(i,{ref:r,className:de("tlui-row",e),...s})})}),Ay=v.forwardRef(({asChild:t,className:e,tooltipSide:n,...s},r)=>{const i=t?om:"div";return h.jsx(Ru,{orientation:"vertical",tooltipSide:n,children:h.jsx(i,{ref:r,className:de("tlui-column",e),...s})})}),Fu=v.forwardRef(({asChild:t,className:e,tooltipSide:n,...s},r)=>{const i=t?om:"div";return h.jsx(Ru,{orientation:"horizontal",tooltipSide:n,children:h.jsx(i,{ref:r,className:de("tlui-grid",e),...s})})}),uB=700;class $o{static instance=null;state=je("tooltip state",{name:"idle"});static getInstance(){return $o.instance||($o.instance=new $o),$o.instance}hideAllTooltips(){this.handleEvent({type:"hide_all"})}handleEvent(e){const n=this.state.get();switch(e.type){case"pointer_down":{n.name==="waiting_to_hide"&&clearTimeout(n.timeoutId),this.state.set({name:"pointer_down"});break}case"pointer_up":{n.name==="pointer_down"&&this.state.set({name:"idle"});break}case"show":{if(n.name==="pointer_down")return;n.name==="waiting_to_hide"&&clearTimeout(n.timeoutId),this.state.set({name:"showing",tooltip:e.tooltip});break}case"hide":{const{tooltipId:s,editor:r,instant:i}=e;if(n.name==="showing"&&n.tooltip.id===s)if(r&&!i){const o=r.timers.setTimeout(()=>{const a=this.state.get();a.name==="waiting_to_hide"&&a.tooltip.id===s&&this.state.set({name:"idle"})},300);this.state.set({name:"waiting_to_hide",tooltip:n.tooltip,timeoutId:o})}else this.state.set({name:"idle"});else n.name==="waiting_to_hide"&&n.tooltip.id===s&&i&&(clearTimeout(n.timeoutId),this.state.set({name:"idle"}));break}case"hide_all":{if(n.name==="waiting_to_hide"&&clearTimeout(n.timeoutId),n.name==="pointer_down")return;this.state.set({name:"idle"});break}}}getCurrentTooltipData(){const e=this.state.get();let n=null;return(e.name==="showing"||e.name==="waiting_to_hide")&&(n=e.tooltip),!n||uc.get().isCoarsePointer&&!n.showOnMobile?null:n}}const Zs=$o.getInstance();function My(){Zs.hideAllTooltips()}const XT=v.createContext(!1);function hB({children:t}){return h.jsx(Ck,{skipDelayDuration:700,children:h.jsxs(XT.Provider,{value:!0,children:[t,h.jsx(pB,{})]})})}function pB(){const[t,e]=v.useState(!1),n=v.useRef(null),s=v.useRef(!0),r=Tt(),i=$("current tooltip",()=>Zs.getCurrentTooltipData(),[]),o=$("camera state",()=>r?.getCameraState(),[r]);return v.useEffect(()=>{o==="moving"&&t&&i&&Zs.handleEvent({type:"hide",tooltipId:i.id,editor:r,instant:!0})},[o,t,i,r]),v.useEffect(()=>{function a(c){c.key==="Escape"&&i&&t&&(My(),c.stopPropagation())}return document.addEventListener("keydown",a,{capture:!0}),()=>{document.removeEventListener("keydown",a,{capture:!0})}},[i,t]),v.useEffect(()=>{function a(){Zs.handleEvent({type:"pointer_down"})}function c(){Zs.handleEvent({type:"pointer_up"})}return document.addEventListener("pointerdown",a,{capture:!0}),document.addEventListener("pointerup",c,{capture:!0}),document.addEventListener("pointercancel",c,{capture:!0}),()=>{document.removeEventListener("pointerdown",a,{capture:!0}),document.removeEventListener("pointerup",c,{capture:!0}),document.removeEventListener("pointercancel",c,{capture:!0}),Zs.handleEvent({type:"pointer_up"})}},[]),v.useEffect(()=>{let a=null;if(i&&n.current){const c=i.targetElement.getBoundingClientRect(),l=n.current;l.style.position="fixed",l.style.left=`${c.left}px`,l.style.top=`${c.top}px`,l.style.width=`${c.width}px`,l.style.height=`${c.height}px`,l.style.pointerEvents="none",l.style.zIndex="9999",s.current?a=setTimeout(()=>{e(!0),s.current=!1},i.delayDuration):e(!0)}else e(!1),s.current=!0;return()=>{a!==null&&clearTimeout(a)}},[i]),i?h.jsxs(d0,{open:t,delayDuration:0,children:[h.jsx(u0,{asChild:!0,children:h.jsx("div",{ref:n})}),h.jsxs(h0,{className:"tlui-tooltip",side:i.side,sideOffset:i.sideOffset,avoidCollisions:!0,collisionPadding:8,dir:"ltr",children:[i.content,h.jsx(p0,{className:"tlui-tooltip__arrow"})]})]}):null}const rl=v.forwardRef(({children:t,content:e,side:n,sideOffset:s=5,disabled:r=!1,showOnMobile:i=!1,delayDuration:o},a)=>{const c=Tt(),l=v.useRef(Ge()),u=v.useContext(XT),d=$("enhancedA11yMode",()=>c?.user.getEnhancedA11yMode(),[c]),p=sl(),f=n??p.tooltipSide;if(v.useEffect(()=>{const I=l.current;return()=>{u&&Zs.handleEvent({type:"hide",tooltipId:I,editor:c,instant:!0})}},[c,u]),r||!e)return h.jsx(h.Fragment,{children:t});let g;if(d?g=0:g=o??(c?.options.tooltipDelayMs||uB),!u||d)return h.jsxs(d0,{delayDuration:g,disableHoverableContent:!d,children:[h.jsx(u0,{asChild:!0,ref:a,children:t}),h.jsxs(h0,{className:"tlui-tooltip",side:f,sideOffset:s,avoidCollisions:!0,collisionPadding:8,dir:"ltr",children:[e,h.jsx(p0,{className:"tlui-tooltip__arrow"})]})]});const x=Ye.Children.only(t);le(Ye.isValidElement(x),"TldrawUiTooltip children must be a single element");const y=x,m=I=>{y.props.onMouseEnter?.(I),Zs.handleEvent({type:"show",tooltip:{id:l.current,content:e,targetElement:I.currentTarget,side:f,sideOffset:s,showOnMobile:i,delayDuration:g}})},S=I=>{y.props.onMouseLeave?.(I),Zs.handleEvent({type:"hide",tooltipId:l.current,editor:c,instant:!1})},w=I=>{y.props.onFocus?.(I),Zs.handleEvent({type:"show",tooltip:{id:l.current,content:e,targetElement:I.currentTarget,side:f,sideOffset:s,showOnMobile:i,delayDuration:g}})},P=I=>{y.props.onBlur?.(I),Zs.handleEvent({type:"hide",tooltipId:l.current,editor:c,instant:!1})};return Ye.cloneElement(y,{onMouseEnter:m,onMouseLeave:S,onFocus:w,onBlur:P})}),fB={horizontal:xo,vertical:Ay,grid:Fu},Wn=Ye.forwardRef(({children:t,className:e,label:n,orientation:s="horizontal",tooltipSide:r,...i},o)=>{const a=fB[s];return h.jsx(a,{asChild:!0,tooltipSide:r,children:h.jsx(Tk,{ref:o,...i,className:de("tlui-toolbar",e),"aria-label":n,orientation:s==="grid"?"horizontal":s,children:t})})}),ot=Ye.forwardRef(({asChild:t,children:e,type:n,isActive:s,tooltip:r,...i},o)=>{const a=h.jsx(Ek,{ref:o,asChild:t,draggable:!1,"data-isactive":s,...i,"aria-label":i.title,title:void 0,className:de("tlui-button",`tlui-button__${n}`,i.className),children:e}),c=r||i.title;return h.jsx(rl,{content:c,children:a})}),gB=({children:t,className:e,type:n,asChild:s,...r})=>h.jsx(kk,{asChild:s,type:n,...r,role:"radiogroup",className:de("tlui-toolbar-toggle-group",e),children:t}),mB=({children:t,className:e,type:n,value:s,tooltip:r,...i})=>{const o=h.jsx(Ak,{...i,title:void 0,className:de("tlui-button",`tlui-button__${n}`,"tlui-toolbar-toggle-group-item",e),value:s,children:t}),a=r||i.title;return h.jsx(rl,{content:a,children:o})};function $e({disabled:t=!1,spinner:e=!1,readonlyOk:n=!1,id:s,kbd:r,label:i,icon:o,iconLeft:a,onSelect:c,noClose:l,isSelected:u,onDragStart:d}){const{type:p,sourceId:f}=Mu(),g=ae(),[x,y]=v.useState(!1);if(_s()&&!n)return null;const S=jc(i,p),w=r?Fd(r):void 0,P=S?g(S):void 0,_=P&&w?`${P} ${w}`:P;switch(p){case"menu":return h.jsx(lB,{children:h.jsxs(Re,{type:"menu","data-testid":`${f}.${s}`,disabled:t,onClick:I=>{l&&Pe(I),x?y(!1):c(f)},children:[a&&h.jsx(Se,{icon:a,small:!0}),h.jsx(Mt,{children:P}),r&&h.jsx(pc,{children:r})]})});case"context-menu":return t?null:h.jsxs(Mk,{dir:"ltr",draggable:!1,className:"tlui-button tlui-button__menu","data-testid":`${f}.${s}`,onSelect:I=>{l&&Pe(I),x?y(!1):c(f)},children:[h.jsx("span",{className:"tlui-button__label",draggable:!1,children:P}),a&&h.jsx(Se,{icon:a,small:!0}),r&&h.jsx(pc,{children:r}),e&&h.jsx(qT,{})]});case"small-icons":case"icons":return h.jsx(ot,{"data-testid":`${f}.${s}`,type:"icon",title:_,disabled:t,onClick:()=>c(f),children:h.jsx(Se,{icon:o,small:!0})});case"keyboard-shortcuts":return r?h.jsxs("div",{className:"tlui-shortcuts-dialog__key-pair","data-testid":`${f}.${s}`,children:[h.jsx("div",{className:"tlui-shortcuts-dialog__key-pair__key",children:P}),h.jsx("div",{className:"tlui-shortcuts-dialog__key-pair__value",children:h.jsx(pc,{visibleOnMobileLayout:!0,children:r})})]}):(console.warn(`Menu item '${i}' isn't shown in the keyboard shortcuts dialog because it doesn't have a keyboard shortcut.`),null);case"helper-buttons":return h.jsxs(Re,{type:"low","data-testid":`${f}.${s}`,onClick:()=>c(f),children:[h.jsx(Se,{icon:o}),h.jsx(Mt,{children:P})]});case"toolbar":return d?h.jsx(ov,{id:s,icon:o,onSelect:c,onDragStart:d,labelStr:P,titleStr:_,disabled:t,isSelected:u}):h.jsx(ot,{"aria-label":P,"aria-pressed":u?"true":"false","data-testid":`tools.${s}`,"data-value":s,disabled:t,onClick:()=>c("toolbar"),onTouchStart:I=>{Pe(I),c("toolbar")},title:_,type:"tool",children:h.jsx(Se,{icon:o})});case"toolbar-overflow":return d?h.jsx(ov,{id:s,icon:o,onSelect:c,onDragStart:d,labelStr:P,titleStr:_,disabled:t,isSelected:u,overflow:!0}):h.jsx(ot,{"aria-label":P,"aria-pressed":u?"true":"false",isActive:u,"data-testid":`tools.more.${s}`,"data-value":s,disabled:t,onClick:()=>c("toolbar"),title:_,type:"icon",children:h.jsx(Se,{icon:o})});default:throw Ke(p)}}function yB(t,e){const n=z();return v.useMemo(()=>{let r={name:"idle"};function i(l){r={name:"pointing",screenSpaceStart:{x:l.clientX,y:l.clientY}},l.currentTarget.setPointerCapture(l.pointerId)}function o(l){if(!l.isSpecialRedispatchedEvent&&r.name==="pointing"&&b.Dist2(r.screenSpaceStart,{x:l.clientX,y:l.clientY})>(n.getInstanceState().isCoarsePointer?n.options.uiCoarseDragDistanceSquared:n.options.uiDragDistanceSquared)){const d=r.screenSpaceStart;r={name:"dragging",screenSpaceStart:d},n.run(()=>{n.setCurrentTool("select"),n.dispatch({type:"pointer",target:"canvas",name:"pointer_down",...cn(n,l),point:d}),n.selectNone(),t?.("toolbar",{type:"pointer",target:"canvas",name:"pointer_move",...cn(n,l),point:d}),My(),n.getContainer().focus()})}}function a(l){l.isSpecialRedispatchedEvent||(l.currentTarget.releasePointerCapture(l.pointerId),n.dispatch({type:"pointer",target:"canvas",name:"pointer_up",...cn(n,l)}))}function c(){if(r.name==="dragging"||r.name==="dragged")return r={name:"idle"},!0;r={name:"idle"},e?.("toolbar")}return{onPointerDown:i,onPointerMove:o,onPointerUp:a,onClick:c}},[t,n,e])}function ov({id:t,labelStr:e,titleStr:n,disabled:s,isSelected:r,icon:i,onSelect:o,onDragStart:a,overflow:c}){const l=yB(a,o);return c?h.jsx(ot,{"aria-label":e,"aria-pressed":r?"true":"false",isActive:r,className:"tlui-button-grid__button","data-testid":`tools.more.${t}`,"data-value":t,disabled:s,title:n,type:"icon",...l,children:h.jsx(Se,{icon:i})}):h.jsx(ot,{"aria-label":e,"aria-pressed":r?"true":"false","data-testid":`tools.${t}`,"data-value":t,disabled:s,onTouchStart:u=>{Pe(u),o("toolbar")},title:n,type:"tool",...l,children:h.jsx(Se,{icon:i})})}function W({actionId:t="",...e}){const s=Tr()[t];return s?h.jsx($e,{...s,...e}):null}function Ae({id:t,label:e,className:n,children:s}){const r=Mu(),{orientation:i}=sl(),o=ae(),a=jc(e,r.type),c=a?o(a):void 0;switch(r.type){case"menu":return h.jsx(cB,{className:n,"data-testid":`${r.sourceId}-group.${t}`,children:s});case"context-menu":return h.jsx("div",{dir:"ltr",className:de("tlui-menu__group",n),"data-testid":`${r.sourceId}-group.${t}`,children:s});case"keyboard-shortcuts":return h.jsxs("div",{className:"tlui-shortcuts-dialog__group","data-testid":`${r.sourceId}-group.${t}`,children:[h.jsx("h2",{className:"tlui-shortcuts-dialog__group__title",children:c}),h.jsx("div",{className:"tlui-shortcuts-dialog__group__content",children:s})]});case"toolbar":{const l=i==="horizontal"?xo:Ay;return h.jsx(l,{className:"tlui-main-toolbar__group","data-testid":`${r.sourceId}-group.${t}`,children:s})}case"toolbar-overflow":return h.jsx(Fu,{className:"tlui-main-toolbar__group","data-testid":`${r.sourceId}-group.${t}`,children:s});default:return s}}const Ug=v.createContext(null);function SB({context:t,children:e}){const n=v.useContext(Ug),s=St(),r=Hc("dialogs",[]),i=v.useMemo(()=>({dialogs:r,addDialog(o){const a=o.id??Ge();return r.update(c=>[...c.filter(l=>l.id!==o.id),{...o,id:a}]),s("open-menu",{source:"dialog",id:a}),Ln.addOpenMenu(a,t),a},removeDialog(o){const a=r.get().find(c=>c.id===o);return a&&(a.onClose?.(),s("close-menu",{source:"dialog",id:o}),Ln.deleteOpenMenu(o,t),r.update(c=>c.filter(l=>l!==a))),o},clearDialogs(){const o=r.get();o.length!==0&&(o.forEach(a=>{a.onClose?.(),s("close-menu",{source:"dialog",id:a.id}),Ln.deleteOpenMenu(a.id,t)}),r.set([]))}}),[s,r,t]);return n?h.jsx(h.Fragment,{children:e}):h.jsx(Ug.Provider,{value:i,children:e})}function il(){const t=v.useContext(Ug);if(!t)throw new Error("useDialogs must be used within a DialogsProvider");return t}const Hg=v.createContext(null);function xB({children:t}){const e=Hc("toasts",[]),n=v.useContext(Hg),s=v.useMemo(()=>({toasts:e,addToast(r){const i=r.id??Ge();return e.update(o=>[...o.filter(a=>a.id!==r.id),{...r,id:i}]),i},removeToast(r){return e.update(i=>i.filter(o=>o.id!==r)),r},clearToasts(){e.set([])}}),[e]);return n?h.jsx(h.Fragment,{children:t}):h.jsx(jk,{children:h.jsx(Hg.Provider,{value:s,children:t})})}function oi(){const t=v.useContext(Hg);if(!t)throw new Error("useToasts must be used within a ToastsProvider");return t}function av(t){return new Promise(e=>{const{allowMultiple:n=!0,mimeTypes:s=[]}=t||{},r=document.createElement("input");r.type="file",r.accept=s?.join(","),r.multiple=n,r.style.display="none";function i(){r.removeEventListener("change",o),r.removeEventListener("cancel",a),r.remove()}async function o(c){const l=c.target.files;if(!l||l.length===0){e([]),i();return}const u=Array.from(l);r.value="",e(u),i()}function a(){e([]),i()}document.body.appendChild(r),r.addEventListener("cancel",a),r.addEventListener("change",o),r?.click()})}var Jf={exports:{}},cv;function bB(){return cv||(cv=1,(function(t){var e=(function(){var n=String.fromCharCode,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",i={};function o(c,l){if(!i[c]){i[c]={};for(var u=0;u<c.length;u++)i[c][c.charAt(u)]=u}return i[c][l]}var a={compressToBase64:function(c){if(c==null)return"";var l=a._compress(c,6,function(u){return s.charAt(u)});switch(l.length%4){default:case 0:return l;case 1:return l+"===";case 2:return l+"==";case 3:return l+"="}},decompressFromBase64:function(c){return c==null?"":c==""?null:a._decompress(c.length,32,function(l){return o(s,c.charAt(l))})},compressToUTF16:function(c){return c==null?"":a._compress(c,15,function(l){return n(l+32)})+" "},decompressFromUTF16:function(c){return c==null?"":c==""?null:a._decompress(c.length,16384,function(l){return c.charCodeAt(l)-32})},compressToUint8Array:function(c){for(var l=a.compress(c),u=new Uint8Array(l.length*2),d=0,p=l.length;d<p;d++){var f=l.charCodeAt(d);u[d*2]=f>>>8,u[d*2+1]=f%256}return u},decompressFromUint8Array:function(c){if(c==null)return a.decompress(c);for(var l=new Array(c.length/2),u=0,d=l.length;u<d;u++)l[u]=c[u*2]*256+c[u*2+1];var p=[];return l.forEach(function(f){p.push(n(f))}),a.decompress(p.join(""))},compressToEncodedURIComponent:function(c){return c==null?"":a._compress(c,6,function(l){return r.charAt(l)})},decompressFromEncodedURIComponent:function(c){return c==null?"":c==""?null:(c=c.replace(/ /g,"+"),a._decompress(c.length,32,function(l){return o(r,c.charAt(l))}))},compress:function(c){return a._compress(c,16,function(l){return n(l)})},_compress:function(c,l,u){if(c==null)return"";var d,p,f={},g={},x="",y="",m="",S=2,w=3,P=2,_=[],I=0,C=0,E;for(E=0;E<c.length;E+=1)if(x=c.charAt(E),Object.prototype.hasOwnProperty.call(f,x)||(f[x]=w++,g[x]=!0),y=m+x,Object.prototype.hasOwnProperty.call(f,y))m=y;else{if(Object.prototype.hasOwnProperty.call(g,m)){if(m.charCodeAt(0)<256){for(d=0;d<P;d++)I=I<<1,C==l-1?(C=0,_.push(u(I)),I=0):C++;for(p=m.charCodeAt(0),d=0;d<8;d++)I=I<<1|p&1,C==l-1?(C=0,_.push(u(I)),I=0):C++,p=p>>1}else{for(p=1,d=0;d<P;d++)I=I<<1|p,C==l-1?(C=0,_.push(u(I)),I=0):C++,p=0;for(p=m.charCodeAt(0),d=0;d<16;d++)I=I<<1|p&1,C==l-1?(C=0,_.push(u(I)),I=0):C++,p=p>>1}S--,S==0&&(S=Math.pow(2,P),P++),delete g[m]}else for(p=f[m],d=0;d<P;d++)I=I<<1|p&1,C==l-1?(C=0,_.push(u(I)),I=0):C++,p=p>>1;S--,S==0&&(S=Math.pow(2,P),P++),f[y]=w++,m=String(x)}if(m!==""){if(Object.prototype.hasOwnProperty.call(g,m)){if(m.charCodeAt(0)<256){for(d=0;d<P;d++)I=I<<1,C==l-1?(C=0,_.push(u(I)),I=0):C++;for(p=m.charCodeAt(0),d=0;d<8;d++)I=I<<1|p&1,C==l-1?(C=0,_.push(u(I)),I=0):C++,p=p>>1}else{for(p=1,d=0;d<P;d++)I=I<<1|p,C==l-1?(C=0,_.push(u(I)),I=0):C++,p=0;for(p=m.charCodeAt(0),d=0;d<16;d++)I=I<<1|p&1,C==l-1?(C=0,_.push(u(I)),I=0):C++,p=p>>1}S--,S==0&&(S=Math.pow(2,P),P++),delete g[m]}else for(p=f[m],d=0;d<P;d++)I=I<<1|p&1,C==l-1?(C=0,_.push(u(I)),I=0):C++,p=p>>1;S--,S==0&&(S=Math.pow(2,P),P++)}for(p=2,d=0;d<P;d++)I=I<<1|p&1,C==l-1?(C=0,_.push(u(I)),I=0):C++,p=p>>1;for(;;)if(I=I<<1,C==l-1){_.push(u(I));break}else C++;return _.join("")},decompress:function(c){return c==null?"":c==""?null:a._decompress(c.length,32768,function(l){return c.charCodeAt(l)})},_decompress:function(c,l,u){var d=[],p=4,f=4,g=3,x="",y=[],m,S,w,P,_,I,C,E={val:u(0),position:l,index:1};for(m=0;m<3;m+=1)d[m]=m;for(w=0,_=Math.pow(2,2),I=1;I!=_;)P=E.val&E.position,E.position>>=1,E.position==0&&(E.position=l,E.val=u(E.index++)),w|=(P>0?1:0)*I,I<<=1;switch(w){case 0:for(w=0,_=Math.pow(2,8),I=1;I!=_;)P=E.val&E.position,E.position>>=1,E.position==0&&(E.position=l,E.val=u(E.index++)),w|=(P>0?1:0)*I,I<<=1;C=n(w);break;case 1:for(w=0,_=Math.pow(2,16),I=1;I!=_;)P=E.val&E.position,E.position>>=1,E.position==0&&(E.position=l,E.val=u(E.index++)),w|=(P>0?1:0)*I,I<<=1;C=n(w);break;case 2:return""}for(d[3]=C,S=C,y.push(C);;){if(E.index>c)return"";for(w=0,_=Math.pow(2,g),I=1;I!=_;)P=E.val&E.position,E.position>>=1,E.position==0&&(E.position=l,E.val=u(E.index++)),w|=(P>0?1:0)*I,I<<=1;switch(C=w){case 0:for(w=0,_=Math.pow(2,8),I=1;I!=_;)P=E.val&E.position,E.position>>=1,E.position==0&&(E.position=l,E.val=u(E.index++)),w|=(P>0?1:0)*I,I<<=1;d[f++]=n(w),C=f-1,p--;break;case 1:for(w=0,_=Math.pow(2,16),I=1;I!=_;)P=E.val&E.position,E.position>>=1,E.position==0&&(E.position=l,E.val=u(E.index++)),w|=(P>0?1:0)*I,I<<=1;d[f++]=n(w),C=f-1,p--;break;case 2:return y.join("")}if(p==0&&(p=Math.pow(2,g),g++),d[C])x=d[C];else if(C===f)x=S+S.charAt(0);else return null;y.push(x),d[f++]=S+x.charAt(0),p--,S=x,p==0&&(p=Math.pow(2,g),g++)}}};return a})();t!=null?t.exports=e:typeof angular<"u"&&angular!=null&&angular.module("LZString",[]).factory("LZString",function(){return e})})(Jf)),Jf.exports}var wB=bB();const Kg=lo(wB),jy="web image/vnd.tldraw+png",vB={png:jy},PB={[jy]:"image/png"};function IB(t){return Nt(vB,t)??null}function _B(t){return Nt(PB,t)??t}function CB(t){return typeof ClipboardItem<"u"&&"supports"in ClipboardItem&&ClipboardItem.supports(t)}function TB(t){const e=Object.entries(t);for(const[n,s]of e)s.catch(r=>console.error(r));return navigator.clipboard.write([new ClipboardItem(t)]).catch(n=>(console.error(n),Promise.all(e.map(async([s,r])=>[s,await r])).then(s=>{const r=P0(s);return navigator.clipboard.write([new ClipboardItem(r)])})))}async function EB(t,e,n,s){const r=e.map(i=>i instanceof File?i:new File([i],"tldrawFile",{type:i.type}));t.markHistoryStoppingPoint("paste"),await t.putExternalContent({type:"files",files:r,point:n,sources:s})}async function Wg(t,e,n,s){return t.markHistoryStoppingPoint("paste"),await t.putExternalContent({type:"url",point:n,url:e,sources:s})}const kB=[jy,"image/png","image/jpeg","image/webp","image/svg+xml"];function Qf(t){const e=document.implementation.createHTMLDocument("");return e.documentElement.innerHTML=t.trim(),e.body.textContent||e.body.innerText||""}const AB=t=>{try{const e=new URL(t);return e.protocol==="http:"||e.protocol==="https:"}catch{return!1}},MB=t=>{const e=t.split(/[\n\s]/);for(const n of e)try{const s=new URL(n);if(!(s.protocol==="http:"||s.protocol==="https:"))return}catch{return}return CT(e)},jB=t=>/^<svg/.test(t),DB=["input","select","textarea"];function eg(t){const{activeElement:e}=document;return t.menus.hasAnyOpenMenus()||e&&(e.isContentEditable||DB.indexOf(e.tagName.toLowerCase())>-1)}const Bl=(t,e,n,s)=>{const r=MB(e);if(r)for(const i of r)Wg(t,i,n);else AB(e)?Wg(t,e,n):jB(e)?(t.markHistoryStoppingPoint("paste"),t.putExternalContent({type:"svg-text",text:e,point:n,sources:s})):(t.markHistoryStoppingPoint("paste"),t.putExternalContent({type:"text",text:e,point:n,sources:s}))},OB=async(t,e,n)=>{if(t.getEditingShapeId()!==null)return;if(!e)throw Error("No clipboard data");const s=[];for(const r of Object.values(e.items))switch(r.kind){case"file":{s.push({type:"file",source:new Promise(i=>i(r.getAsFile()))});break}case"string":{r.type==="text/html"?s.push({type:"html",source:new Promise(i=>r.getAsString(i))}):r.type==="text/plain"?s.push({type:"text",source:new Promise(i=>r.getAsString(i))}):s.push({type:r.type,source:new Promise(i=>r.getAsString(i))});break}}JT(t,s,n)},ZT=async({editor:t,clipboardItems:e,point:n,fallbackFiles:s})=>{const r=[];for(const i of e){for(const o of kB)if(i.types.includes(o)){const a=i.getType(o).then(c=>vn.rewriteMimeType(c,_B(o)));r.push({type:"blob",source:a});break}i.types.includes("text/html")&&r.push({type:"html",source:(async()=>{const o=await i.getType("text/html");return await vn.blobToText(o)})()}),i.types.includes("text/uri-list")&&r.push({type:"url",source:(async()=>{const o=await i.getType("text/uri-list");return await vn.blobToText(o)})()}),i.types.includes("text/plain")&&r.push({type:"text",source:(async()=>{const o=await i.getType("text/plain");return await vn.blobToText(o)})()})}return s?.length&&r.length===1&&r[0].type==="text"?(r.pop(),r.push(...s.map(i=>({type:"file",source:Promise.resolve(i)})))):s?.length&&r.length===0&&r.push(...s.map(i=>({type:"file",source:Promise.resolve(i)}))),await JT(t,r,n)};async function JT(t,e,n){const s=e.filter(i=>(i.type==="file"||i.type==="blob")&&i.source!==null);if(s.length){if(s.length>t.options.maxFilesAtOnce)throw Error("Too many files");const i=ve(await Promise.all(s.map(o=>o.source)));return await EB(t,i,n)}const r=await Promise.all(e.filter(i=>i.type!=="file").map(i=>new Promise(o=>{const a=i;if(a.type==="file"){o({type:"error",data:null,reason:"unexpected file"});return}a.source.then(c=>{const l=c.match(/<div data-tldraw[^>]*>(.*)<\/div>/)?.[1];if(l)try{let u;try{u=JSON.parse(l)}catch{const d=Kg.decompressFromBase64(l);if(d===null){o({type:"error",data:null,reason:"found tldraw data comment but could not parse"});return}u=JSON.parse(d)}if(u.type!=="application/tldraw"){o({type:"error",data:u,reason:`found tldraw data comment but JSON was of a different type: ${u.type}`});return}if(u.version===3)try{const d=JSON.parse(Kg.decompressFromBase64(u.data.otherCompressed)||"{}"),p={assets:u.data.assets||[],...d};o({type:"tldraw",data:p});return}catch(d){o({type:"error",data:u,reason:`failed to decompress version 2 clipboard data: ${d}`});return}if(u.version===2)o({type:"tldraw",data:u.data});else{if(typeof u.data=="string"){o({type:"error",data:u,reason:"found tldraw json but data was a string instead of a TLClipboardModel object"});return}o({type:"tldraw",data:u.data});return}}catch{o({type:"error",data:l,reason:"found tldraw json but data was a string instead of a TLClipboardModel object"});return}else{if(a.type==="html"){o({type:"text",data:c,subtype:"html"});return}if(a.type==="url"){o({type:"text",data:c,subtype:"url"});return}try{const u=JSON.parse(c);if(u.type==="excalidraw/clipboard"){o({type:"excalidraw",data:u});return}else{o({type:"text",data:c,subtype:"json"});return}}catch{o({type:"text",data:c,subtype:"text"});return}}o({type:"error",data:c,reason:"unhandled case"})})})));for(const i of r)if(i.type==="tldraw"){t.markHistoryStoppingPoint("paste"),t.putExternalContent({type:"tldraw",content:i.data,point:n});return}for(const i of r)if(i.type==="excalidraw"){t.markHistoryStoppingPoint("paste"),t.putExternalContent({type:"excalidraw",content:i.data,point:n});return}for(const i of r){if(i.type==="text"&&i.subtype==="html"){const a=new DOMParser().parseFromString(i.data,"text/html").querySelector("body");if(a&&Array.from(a.children).filter(l=>l.nodeType===1).length===1&&a.firstElementChild&&a.firstElementChild.tagName==="A"&&a.firstElementChild.hasAttribute("href")&&a.firstElementChild.getAttribute("href")!==""){const l=a.firstElementChild.getAttribute("href");Bl(t,l,n,r);return}if(!r.some(l=>l.type==="text"&&l.subtype!=="html")&&i.data.trim()&&(Qf(i.data)??"")){Bl(t,Qf(i.data),n,r);return}if(r.some(l=>l.type==="text"&&l.subtype!=="html")){const l=Qf(i.data)??"";if(l){t.markHistoryStoppingPoint("paste"),t.putExternalContent({type:"text",text:l,html:i.data,point:n,sources:r});return}}}if(i.type==="text"&&i.subtype==="text"&&i.data.startsWith("<iframe ")){const a=new DOMParser().parseFromString(i.data,"text/html").querySelector("body");if(a&&Array.from(a.children).filter(l=>l.nodeType===1).length===1&&a.firstElementChild&&a.firstElementChild.tagName==="IFRAME"&&a.firstElementChild.hasAttribute("src")&&a.firstElementChild.getAttribute("src")!==""){const l=a.firstElementChild.getAttribute("src");Bl(t,l,n,r);return}}}for(const i of r)if(i.type==="text"&&i.subtype==="url"){Wg(t,i.data,n,r);return}for(const i of r)if(i.type==="text"&&i.subtype==="text"&&i.data.trim()){Bl(t,i.data,n,r);return}}const Bd=async t=>{const e=t.getContainer().ownerDocument?.defaultView?.navigator??globalThis.navigator,n=await t.resolveAssetsInContent(t.getContentFromCurrentPage(t.getSelectedShapeIds()));if(!n){e&&e.clipboard&&e.clipboard.writeText("");return}const{assets:s,...r}=n,i={type:"application/tldraw",kind:"content",version:3,data:{assets:s||[],otherCompressed:Kg.compressToBase64(JSON.stringify(r))}},o=JSON.stringify(i);if(!(typeof e>"u")){const a=n.shapes.map(c=>t.getShapeUtil(c).getText(c)).filter(JA);if(e.clipboard?.write){const c=new Blob([`<div data-tldraw>${o}</div>`],{type:"text/html"});let l=a.join(" ");l===""&&(l=" "),e.clipboard.write([new ClipboardItem({"text/html":c,"text/plain":new Blob([l],{type:"text/plain"})})])}else e.clipboard.writeText&&e.clipboard.writeText(`<div data-tldraw>${o}</div>`)}};function LB(){const t=Tt(),e=St(),n=v.useCallback(async function(o){le(t,"editor is required for copy"),t.getSelectedShapeIds().length!==0&&(await Bd(t),e("copy",{source:o}))},[t,e]),s=v.useCallback(async function(o){t&&t.getSelectedShapeIds().length!==0&&(await Bd(t),t.deleteShapes(t.getSelectedShapeIds()),e("cut",{source:o}))},[t,e]),r=v.useCallback(async function(o,a,c){t&&t.getEditingShapeId()===null&&(Array.isArray(o)&&o[0]instanceof ClipboardItem?(ZT({editor:t,clipboardItems:o,point:c}),e("paste",{source:"menu"})):navigator.clipboard.read().then(l=>{r(l,a,c)}))},[t,e]);return{copy:n,cut:s,paste:r}}function RB(){const t=z(),e=t.getContainer().ownerDocument,n=St(),s=$("editor.isFocused",()=>t.getInstanceState().isFocused,[t]);v.useEffect(()=>{if(!s)return;const r=async l=>{t.getSelectedShapeIds().length===0||t.getEditingShapeId()!==null||eg(t)||(Pe(l),await Bd(t),n("copy",{source:"kbd"}))};async function i(l){t.getSelectedShapeIds().length===0||t.getEditingShapeId()!==null||eg(t)||(Pe(l),await Bd(t),t.deleteShapes(t.getSelectedShapeIds()),n("cut",{source:"kbd"}))}let o=!1;const a=l=>{l.button===1&&(o=!0,t.timers.requestAnimationFrame(()=>{o=!1}))},c=l=>{if(o){t.markEventAsHandled(l);return}if(t.getEditingShapeId()!==null||eg(t))return;let u,d=!1;t.inputs.getShiftKey()&&(d=!0),t.user.getIsPasteAtCursorMode()&&(d=!d),d&&(u=t.inputs.getCurrentPagePoint());const p=()=>{l.clipboardData&&OB(t,l.clipboardData,u)};if(navigator.clipboard?.read){const f=Array.from(l.clipboardData?.files||[]);navigator.clipboard.read().then(g=>{Array.isArray(g)&&g[0]instanceof ClipboardItem&&ZT({editor:t,clipboardItems:g,point:u,fallbackFiles:f})},()=>{p()})}else p();Pe(l),n("paste",{source:"kbd"})};return e?.addEventListener("copy",r),e?.addEventListener("cut",i),e?.addEventListener("paste",c),e?.addEventListener("pointerup",a),()=>{e?.removeEventListener("copy",r),e?.removeEventListener("cut",i),e?.removeEventListener("paste",c),e?.removeEventListener("pointerup",a)}},[t,n,s,e])}const lv={jpeg:"image/jpeg",png:"image/png",webp:"image/webp",svg:"text/plain"};function FB(t,e,n={}){const s=e?.length?e:[...t.getCurrentPageShapeIds()],r=n.format??"png";return{blobPromise:t.toImage(s,n).then(i=>vn.rewriteMimeType(i.blob,lv[r])),mimeType:lv[r]}}function BB(t,e,n){if(!navigator.clipboard)return Promise.reject(new Error("Copy not supported"));if(navigator.clipboard.write){const{blobPromise:s,mimeType:r}=FB(t,e,n),i={[r]:s},o=IB(n.format);return o&&CB(o)&&(i[o]=s.then(a=>vn.rewriteMimeType(a,o))),TB(i)}switch(n.format){case"svg":return zB(async()=>{const s=await t.getSvgString(e,n);if(!s)throw new Error("Failed to copy");return s.svg});case"png":throw new Error("Copy not supported");default:Ke(n.format)}}async function zB(t){await navigator.clipboard?.writeText?.(await t())}function $B(){const t=Tt(),{addToast:e}=oi(),n=ae();return v.useCallback((s,r="svg")=>{le(t,"useCopyAs: editor is required"),BB(t,s,{format:r}).catch(()=>{e({id:"copy-fail",severity:"warning",title:n("toast.error.copy-fail.title"),description:n("toast.error.copy-fail.desc")})})},[t,e,n])}async function NB(t,e,n){let s=n.name;if(!s&&(s=`shapes at ${dv()}`,e.length===1)){const o=t.getShape(e[0]);t.isShapeOfType(o,"frame")?s=o.props.name||"frame":s=`${au(o.id)} at ${dv()}`}s+=`.${n.format}`;const{blob:r}=await t.toImage(e,n),i=new File([r],s,{type:r.type});UB(i)}function dv(){const t=new Date,e=String(t.getFullYear()).slice(2),n=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0"),r=String(t.getHours()).padStart(2,"0"),i=String(t.getMinutes()).padStart(2,"0"),o=String(t.getSeconds()).padStart(2,"0");return`${e}-${n}-${s} ${r}.${i}.${o}`}function UB(t){const e=document.createElement("a"),n=URL.createObjectURL(t);e.href=n,e.download=t.name,e.click(),URL.revokeObjectURL(n)}function HB(){const t=Tt(),{addToast:e}=oi(),n=ae();return v.useCallback((s,r={})=>{le(t,"useExportAs: editor is required");const{format:i="png",name:o,scale:a=1}=r;NB(t,s,{format:i,name:o,scale:a}).catch(c=>{console.error(c.message),e({id:"export-fail",title:n("toast.error.export-fail.title"),description:n("toast.error.export-fail.desc"),severity:"error"})})},[t,e,n])}function KB(){const t=Tt(),e=v.useRef(null),n=v.useRef(null);return v.useCallback(async function(){le(t,"usePrint: editor is required");const r=document.createElement("div"),i=document.createElement("style"),o=(m,S)=>{m&&(m.innerHTML=""),S&&document.head.contains(S)&&document.head.removeChild(S),m&&document.body.contains(m)&&document.body.removeChild(m)};o(e.current,n.current),e.current=r,n.current=i;const a=`tl-print-surface-${Ge()}`;r.className=a,i.innerHTML=`
			.${a} {
				display: none;
			}

			.${a} svg {
				max-width: 100%;
				height: 100%;
				display: block;
			}

			@media print {				  
				html, body {
					min-height: 100%;
					height: 100%;
					margin: 0;
				}

				body {
					position: relative;
				}

				body > * {
					display: none;
				}

				.tldraw__editor {
					display: none;
				}

				.${a} {
					display: block !important;
					background: white;
					min-height: 100%;
					height: 100%;
					max-width: 100%;
				}

				.${a}__item {
					padding: 10mm;
					display: flex;
					min-height: 100%;
					flex-direction: column;
					page-break-after: always;
					position: relative;
					overflow: hidden;
					height: 100%;
				}

				.${a}__item__main {
					flex: 1;
					display: flex;
					align-items: center;
					justify-content: center;
					max-height: 100%;
				}

				.${a}__item__header {
					display: none;
				}

				.${a}__item__footer {
					display: none;
					text-align: right;
				}

				.${a}__item__footer__hide {
					display: none;
				}

				
			}

		`;const c=()=>{document.head.appendChild(i),document.body.appendChild(r)},l=()=>{t.once("tick",()=>{o(r,i)})};window.addEventListener("beforeprint",c),window.addEventListener("afterprint",l);function u(m,S,w){try{r.innerHTML+=`<div class="${a}__item">
        <div class="${a}__item__header">
          ${m.replace(/</g,"&lt;").replace(/>/g,"&gt;")}
        </div>
        <div class="${a}__item__main">
          ${w}
        </div>
        <div class="${a}__item__footer ${a}__item__footer__${S?"":"hide"}">
          ${S??""}
        </div>
      </div>`}catch(P){console.error(P)}}function d(){qe.isChromeForIos?(c(),window.print()):qe.isSafari?(c(),document.execCommand("print",!1)):window.print()}const p=t.getSelectedShapeIds(),f=t.getCurrentPageId(),g=t.getPages(),y={scale:1,background:!1,darkMode:!1,preserveAspectRatio:"xMidYMid meet"};if(t.getSelectedShapeIds().length>0){const m=await t.getSvgString(p,y);if(m){const S=g.find(w=>w.id===f);u(`tldraw — ${S?.name}`,null,m.svg),d()}}else{const m=t.getCurrentPage(),S=await t.getSvgString(t.getSortedChildIdsForParent(m.id),y);S&&(u(`tldraw — ${m.name}`,null,S.svg),d())}window.removeEventListener("beforeprint",c),window.removeEventListener("afterprint",l)},[t])}const QT=v.createContext([]);function Dy(){const t=Tt(),{addToast:e,removeToast:n,clearToasts:s}=oi(),{addDialog:r,clearDialogs:i,removeDialog:o}=il(),a=ae(),c=KB(),{cut:l,copy:u,paste:d}=LB(),p=$B(),f=HB(),g=ky(),y=hn()<yt.TABLET_SM,m=vi(v.useContext(QT)),S=v.useCallback(async()=>{if(!t)return;const I=await av({allowMultiple:!0,mimeTypes:m});I.length&&(t.markHistoryStoppingPoint("insert media"),t.putExternalContent({type:"files",files:I,point:t.getViewportPageBounds().center}))},[t,m]),w=v.useCallback(async I=>{if(!t)return;const C=await av({allowMultiple:!1,mimeTypes:m?.filter(k=>I?k.startsWith("image/"):k.startsWith("video/"))});if(!C.length)return;const E=t.getOnlySelectedShape();if(!E||I&&E.type!=="image"||!I&&E.type!=="video")return;t.markHistoryStoppingPoint("replace media");const O=C[0];t.replaceExternalContent({type:"file-replace",file:O,shapeId:E.id,isImage:I})},[t,m]),P=v.useCallback(()=>w(!0),[w]),_=v.useCallback(()=>w(!1),[w]);return v.useMemo(()=>({addToast:e,removeToast:n,clearToasts:s,addDialog:r,removeDialog:o,clearDialogs:i,msg:a,isMobile:y,insertMedia:S,replaceImage:P,replaceVideo:_,printSelectionOrPages:c,cut:l,copy:u,paste:d,copyAs:p,exportAs:f,getEmbedDefinition:g}),[e,n,s,r,o,i,a,y,S,P,_,c,l,u,d,p,f,g])}function WB(t,e){const n={};for(const s of t)if(s.translations)for(const[r,i]of zs(s.translations)){let o=n[r];o||(o=n[r]={}),Object.assign(o,i)}return{actions:(s,r,i)=>{for(const o of t)o.actions&&(r=o.actions(s,r,i));return r},tools:(s,r,i)=>{for(const o of t)o.tools&&(r=o.tools(s,r,{...e,...i}));return r},translations:n}}function eE(t){return v.useMemo(()=>t,t)}function tE(t){const e=eE(t==null?[]:Array.isArray(t)?t:[t]);return v.useMemo(()=>{const n={};for(const s of e)if(s.translations)for(const[r,i]of zs(s.translations)){let o=n[r];o||(o=n[r]={}),Object.assign(o,i)}return n},[e])}function qB(t){const e=Dy(),n=eE(t==null?[]:Array.isArray(t)?t:[t]);return v.useMemo(()=>WB(n,e),[n,e])}const nE=v.createContext(null);function GB({overrides:t,children:e}){const n=Tt(),s=St(),r=Tu(),i=ae(),o=Dy(),a=v.useCallback((l,u,d)=>{r.announce({msg:i(u.label)}),s("select-tool",{source:l,id:d??u.id})},[r,i,s]),c=v.useMemo(()=>{if(!n)return{};const l=[{id:"select",label:"tool.select",icon:"tool-pointer",kbd:"v",readonlyOk:!0,onSelect(d){if(n.isIn("select")){const p=n.root.getCurrent();p.exit({},p.id),p.enter({},p.id)}n.setCurrentTool("select"),a(d,this)}},{id:"hand",label:"tool.hand",icon:"tool-hand",kbd:"h",readonlyOk:!0,onSelect(d){n.setCurrentTool("hand"),a(d,this)}},{id:"eraser",label:"tool.eraser",icon:"tool-eraser",kbd:"e",onSelect(d){n.setCurrentTool("eraser"),a(d,this)}},{id:"draw",label:"tool.draw",icon:"tool-pencil",kbd:"d,b,x",onSelect(d){n.setCurrentTool("draw"),a(d,this)}},...[...yr.values].map(d=>({id:d,label:`tool.${d}`,meta:{geo:d},kbd:d==="rectangle"?"r":d==="ellipse"?"o":void 0,icon:"geo-"+d,onSelect(p){n.run(()=>{n.setStyleForNextShapes(yr,d),n.setCurrentTool("geo"),a(p,this,`geo-${d}`)})},onDragStart(p,f){ko(n,f,{createShape:g=>n.createShape({id:g,type:"geo",props:{w:200,h:200,geo:d}})}),s("drag-tool",{source:p,id:"geo"})}})),{id:"arrow",label:"tool.arrow",icon:"tool-arrow",kbd:"a",onSelect(d){n.setCurrentTool("arrow"),a(d,this)},onDragStart(d,p){ko(n,p,{createShape:f=>n.createShape({id:f,type:"arrow",props:{start:{x:0,y:200},end:{x:200,y:0}}})}),s("drag-tool",{source:d,id:"arrow"})}},{id:"line",label:"tool.line",icon:"tool-line",kbd:"l",onSelect(d){n.setCurrentTool("line"),a(d,this)},onDragStart(d,p){ko(n,p,{createShape:f=>{const[g,x]=Ji(null,null,2);n.createShape({id:f,type:"line",props:{points:{[g]:{id:g,index:g,x:0,y:200},[x]:{id:x,index:x,x:200,y:0}}}})}}),s("drag-tool",{source:d,id:"line"})}},{id:"frame",label:"tool.frame",icon:"tool-frame",kbd:"f",onSelect(d){n.setCurrentTool("frame"),a(d,this)},onDragStart(d,p){ko(n,p,{createShape:f=>n.createShape({id:f,type:"frame"})}),s("drag-tool",{source:d,id:"frame"})}},{id:"text",label:"tool.text",icon:"tool-text",kbd:"t",onSelect(d){n.setCurrentTool("text"),a(d,this)},onDragStart(d,p){ko(n,p,{createShape:f=>n.createShape({id:f,type:"text",props:{richText:ln("Text")}}),onDragEnd:f=>{Hn(n,f,{selectAll:!0})}}),s("drag-tool",{source:d,id:"text"})}},{id:"asset",label:"tool.media",icon:"tool-media",kbd:"cmd+u,ctrl+u",onSelect(d){o.insertMedia(),a(d,this,"media")}},{id:"note",label:"tool.note",icon:"tool-note",kbd:"n",onSelect(d){n.setCurrentTool("note"),a(d,this)},onDragStart(d,p){ko(n,p,{createShape:f=>n.createShape({id:f,type:"note"}),onDragEnd:f=>{Hn(n,f,{selectAll:!0})}}),s("drag-tool",{source:d,id:"note"})}},{id:"laser",label:"tool.laser",readonlyOk:!0,icon:"tool-laser",kbd:"k",onSelect(d){n.setCurrentTool("laser"),a(d,this)}},{id:"embed",label:"tool.embed",icon:"dot",onSelect(d){o.addDialog({component:UT}),a(d,this)}},{id:"highlight",label:"tool.highlight",icon:"tool-highlight",kbd:"shift+d",onSelect(d){n.setCurrentTool("highlight"),a(d,this)}}];l.forEach(d=>d.onSelect=d.onSelect.bind(d));const u=Object.fromEntries(l.map(d=>[d.id,d]));return t?t(n,u,o):u},[t,n,o,a,s]);return h.jsx(nE.Provider,{value:c,children:e})}function Oy(){const t=v.useContext(nE);if(!t)throw new Error("useTools must be used within a ToolProvider");return t}function ko(t,e,n){const{x:s,y:r}=t.inputs.getCurrentPagePoint(),i=t.markHistoryStoppingPoint("drag shape tool");t.setCurrentTool("select.translating");const o=tt();n.createShape(o);const a=Gt(t.getShape(o),"Shape not found"),{w:c,h:l}=t.getShapePageBounds(o);t.updateShape({id:o,type:a.type,x:s-c/2,y:r-l/2}),t.select(o),t.setCurrentTool("select.translating",{...e,target:"shape",shape:t.getShape(o),isCreating:!0,creatingMarkId:i,onCreate(){t.setCurrentTool("select.idle"),t.select(o),n.onDragEnd?.(o)}}),t.getCurrentTool().setCurrentToolIdMask(a.type)}function Qn({toolId:t="",...e}){const s=Oy()[t];return s?h.jsx($e,{...s,...e}):null}function YB(){const t=ju();return h.jsxs(h.Fragment,{children:[h.jsxs(Ae,{label:"shortcuts-dialog.tools",id:"tools",children:[h.jsx(W,{actionId:"toggle-tool-lock"}),h.jsx(W,{actionId:"insert-media"}),h.jsx(Qn,{toolId:"select"}),h.jsx(Qn,{toolId:"draw"}),h.jsx(Qn,{toolId:"eraser"}),h.jsx(Qn,{toolId:"hand"}),h.jsx(Qn,{toolId:"rectangle"}),h.jsx(Qn,{toolId:"ellipse"}),h.jsx(Qn,{toolId:"arrow"}),h.jsx(Qn,{toolId:"line"}),h.jsx(Qn,{toolId:"text"}),h.jsx(Qn,{toolId:"frame"}),h.jsx(Qn,{toolId:"note"}),h.jsx(Qn,{toolId:"laser"}),h.jsx($e,{id:"pointer-down",label:"tool.pointer-down",kbd:",",onSelect:()=>{}})]}),h.jsxs(Ae,{label:"shortcuts-dialog.preferences",id:"preferences",children:[h.jsx(W,{actionId:"toggle-dark-mode"}),h.jsx(W,{actionId:"toggle-focus-mode"}),h.jsx(W,{actionId:"toggle-grid"})]}),h.jsxs(Ae,{label:"shortcuts-dialog.edit",id:"edit",children:[h.jsx(W,{actionId:"undo"}),h.jsx(W,{actionId:"redo"}),h.jsx(W,{actionId:"cut"}),h.jsx(W,{actionId:"copy"}),h.jsx(W,{actionId:"paste"}),h.jsx(W,{actionId:"select-all"}),h.jsx(W,{actionId:"delete"}),h.jsx(W,{actionId:"duplicate"})]}),h.jsxs(Ae,{label:"shortcuts-dialog.view",id:"view",children:[h.jsx(W,{actionId:"zoom-in"}),h.jsx(W,{actionId:"zoom-out"}),h.jsx(W,{actionId:"zoom-to-100"}),h.jsx(W,{actionId:"zoom-to-fit"}),h.jsx(W,{actionId:"zoom-to-selection"})]}),h.jsxs(Ae,{label:"shortcuts-dialog.transform",id:"transform",children:[h.jsx(W,{actionId:"bring-to-front"}),h.jsx(W,{actionId:"bring-forward"}),h.jsx(W,{actionId:"send-backward"}),h.jsx(W,{actionId:"send-to-back"}),h.jsx(W,{actionId:"group"}),h.jsx(W,{actionId:"ungroup"}),h.jsx(W,{actionId:"flip-horizontal"}),h.jsx(W,{actionId:"flip-vertical"}),h.jsx(W,{actionId:"align-top"}),h.jsx(W,{actionId:"align-center-vertical"}),h.jsx(W,{actionId:"align-bottom"}),h.jsx(W,{actionId:"align-left"}),h.jsx(W,{actionId:"align-center-horizontal"}),h.jsx(W,{actionId:"align-right"})]}),h.jsxs(Ae,{label:"shortcuts-dialog.text-formatting",id:"text",children:[h.jsx($e,{id:"text-bold",label:"tool.rich-text-bold",kbd:"cmd+b",onSelect:()=>{}}),h.jsx($e,{id:"text-italic",label:"tool.rich-text-italic",kbd:"cmd+i",onSelect:()=>{}}),h.jsx($e,{id:"text-code",label:"tool.rich-text-code",kbd:"cmd+e",onSelect:()=>{}}),h.jsx($e,{id:"text-highlight",label:"tool.rich-text-highlight",kbd:"cmd+shift+h",onSelect:()=>{}}),h.jsx($e,{id:"text-strikethrough",label:"tool.rich-text-strikethrough",kbd:"cmd+shift+s",onSelect:()=>{}}),h.jsx($e,{id:"text-link",label:"tool.rich-text-link",kbd:"cmd+shift+k",onSelect:()=>{}}),h.jsx($e,{id:"text-header",label:"tool.rich-text-header",kbd:"cmd+alt+[[1-6]]",onSelect:()=>{}}),h.jsx($e,{id:"text-orderedList",label:"tool.rich-text-orderedList",kbd:"cmd+shift+7",onSelect:()=>{}}),h.jsx($e,{id:"text-bulletedlist",label:"tool.rich-text-bulletList",kbd:"cmd+shift+8",onSelect:()=>{}})]}),h.jsxs(Ae,{label:"shortcuts-dialog.a11y",id:"a11y",children:[h.jsx($e,{id:"a11y-select-next-shape",label:"a11y.select-shape",kbd:"[[Tab]]",onSelect:()=>{}}),h.jsx($e,{id:"a11y-select-next-shape-direction",label:"a11y.select-shape-direction",kbd:"cmd+[[↑→↓←]]",onSelect:()=>{}}),h.jsx($e,{id:"a11y-select-next-shape-container",label:"a11y.enter-leave-container",kbd:"cmd+shift+[[↑↓]]",onSelect:()=>{}}),h.jsx($e,{id:"a11y-pan-camera",label:"a11y.pan-camera",kbd:"[[Space]]+[[↑→↓←]]",onSelect:()=>{}}),h.jsx($e,{id:"adjust-shape-styles",label:"a11y.adjust-shape-styles",kbd:"cmd+[[Enter]]",onSelect:()=>{}}),h.jsx($e,{id:"open-context-menu",label:"a11y.open-context-menu",kbd:"cmd+shift+[[Enter]]",onSelect:()=>{}}),h.jsx($e,{id:"a11y-move-shape",label:"a11y.move-shape",kbd:"[[↑→↓←]]",onSelect:()=>{}}),h.jsx($e,{id:"a11y-move-shape-faster",label:"a11y.move-shape-faster",kbd:"shift+[[↑→↓←]]",onSelect:()=>{}}),h.jsx($e,{id:"a11y-rotate-shape-cw",label:"a11y.rotate-shape-cw",kbd:"shift+﹥",onSelect:()=>{}}),h.jsx($e,{id:"a11y-rotate-shape-cw-fine",label:"a11y.rotate-shape-cw-fine",kbd:"shift+alt+﹥",onSelect:()=>{}}),h.jsx($e,{id:"a11y-rotate-shape-ccw",label:"a11y.rotate-shape-ccw",kbd:"shift+﹤",onSelect:()=>{}}),h.jsx($e,{id:"a11y-rotate-shape-ccw-fine",label:"a11y.rotate-shape-ccw-fine",kbd:"shift+alt+﹤",onSelect:()=>{}}),h.jsx(W,{actionId:"enlarge-shapes"}),h.jsx(W,{actionId:"shrink-shapes"}),h.jsx(W,{actionId:"a11y-repeat-shape-announce"}),h.jsx($e,{id:"a11y-open-keyboard-shortcuts",label:"a11y.open-keyboard-shortcuts",kbd:"cmd+alt+/",onSelect:()=>{}})]}),t&&h.jsx(Ae,{label:"shortcuts-dialog.collaboration",id:"collaboration",children:h.jsx(W,{actionId:"open-cursor-chat"})})]})}const sE=v.memo(function({children:e}){const n=ae(),s=hn(),r=e??h.jsx(YB,{});return h.jsxs(h.Fragment,{children:[h.jsxs(Eu,{className:"tlui-shortcuts-dialog__header",children:[h.jsx(ku,{children:n("shortcuts-dialog.title")}),h.jsx(Au,{})]}),h.jsx(Tc,{className:de("tlui-shortcuts-dialog__body",{"tlui-shortcuts-dialog__body__mobile":s<=yt.MOBILE_XS,"tlui-shortcuts-dialog__body__tablet":s<=yt.TABLET}),children:h.jsx(Kn,{type:"keyboard-shortcuts",sourceId:"kbd",children:r})}),h.jsx("div",{className:"tlui-dialog__scrim"})]})});async function VB(t,e,n){const s=ve(e.map(a=>{const c=t.getShape(a);if(!(!c||t.getShapeUtil(c.type).toSvg===void 0))return c}));if(s.length===0)return;if(s.length===1){const a=s[0];if(!a||t.isShapeOfType(a,"image"))return}const r=[];if(n!==void 0){const a=s.map(c=>({shape:c,bounds:t.getShapeMaskedPageBounds(c).clone().expandBy(n)}));for(let c=0;c<a.length;c++){const l=a[c];if(c===0){r[0]={shapes:[l.shape],bounds:l.bounds};continue}let u=!1;for(const d of r)if(d.bounds.includes(l.bounds)){d.shapes.push(l.shape),d.bounds.expand(l.bounds),u=!0;break}u||r.push({shapes:[l.shape],bounds:l.bounds})}}else{const a=X.Common(s.map(c=>t.getShapeMaskedPageBounds(c)));r.push({shapes:s,bounds:a})}const i=t.options.flattenImageBoundsPadding;for(const a of r){n!==void 0&&a.bounds.expandBy(-n);const c=await t.getSvgString(a.shapes,{padding:i,background:!1});if(!c?.svg)continue;const l=await t.getAssetForExternalContent({type:"file",file:new File([c.svg],"asset.svg",{type:"image/svg+xml"})});l&&(a.asset=l)}const o=[];return xs(()=>{for(const a of r){const{asset:c,bounds:l,shapes:u}=a;if(!c)continue;const d=t.findCommonAncestor(u)??t.getCurrentPageId();if(!d)continue;let p="a1";for(const m of u)if(m.parentId===d){m.index>p&&(p=m.index);break}let f,g,x;if(On(d)){const m=t.getShape(d);if(!m)continue;const S=t.getPointInShapeSpace(m,{x:l.x,y:l.y});x=t.getShapePageTransform(d).rotation(),S.sub(new b(i,i).rot(-x)),f=S.x,g=S.y}else f=l.x-i,g=l.y-i,x=0;t.deleteShapes(u),t.createAssets([{...c,id:c.id}]);const y=tt();t.createShape({id:y,type:"image",index:p,parentId:d,x:f,y:g,rotation:-x,props:{assetId:c.id,w:l.w+i*2,h:l.h+i*2}}),o.push(y)}}),o}function io({id:t,children:e,onOpenChange:n,open:s,className:r}){const[i,o]=ii(t,n);return h.jsx(am,{onOpenChange:o,open:s||i,children:h.jsx("div",{className:de("tlui-popover",r),children:e})})}function oo({children:t}){return h.jsx(cm,{asChild:!0,dir:"ltr",children:t})}function ao({side:t,children:e,align:n="center",sideOffset:s=8,alignOffset:r=0,disableEscapeKeyDown:i=!1,autoFocusFirstButton:o=!0}){const a=Lt(),c=Ye.useRef(null),l=Ye.useCallback(()=>{if(!o)return;const p=[...c.current?.querySelectorAll("button:not([disabled])")??[]].filter(f=>f.offsetWidth||f.offsetHeight)[0];p&&p.focus()},[o]);return h.jsx(lm,{container:a,children:h.jsx(dm,{className:"tlui-popover__content",side:t,sideOffset:s,align:n,alignOffset:r,dir:"ltr",ref:c,onOpenAutoFocus:l,onEscapeKeyDown:u=>i&&u.preventDefault(),children:e})})}function zd(t,e,n){const{arrowheadStart:s,arrowheadEnd:r}=e.props,i=Uo(t,e,n),o=i.start.clone(),a=i.end.clone(),c=b.Med(o,a);if(b.Equals(o,a))return{bindings:n,type:"straight",start:{handle:o,point:o,arrowhead:e.props.arrowheadStart},end:{handle:a,point:a,arrowhead:e.props.arrowheadEnd},middle:c,isValid:!1,length:0};const l=b.Sub(a,o).uni(),u=Nd(t,e,"start"),d=Nd(t,e,"end"),p=t.getShapePageTransform(e);uv(a,i.start,p,d),uv(o,i.end,p,u);let f=0,g=0,x=0,y=0,m=Ho*e.props.scale;const S=u&&d&&u.shape===d.shape,w=u&&d?Ly(t,u.shape.id,d.shape.id):"safe";w==="safe"&&u&&d&&!S&&!u.isExact&&!d.isExact&&(d.didIntersect&&!u.didIntersect?u.isClosed&&o.setTo(a.clone().add(l.clone().mul(Ho*e.props.scale))):d.didIntersect||d.isClosed&&a.setTo(o.clone().sub(l.clone().mul(Ho*e.props.scale))));const P=b.Sub(a,o),_=b.Len(P)?P.uni():b.From(P),I=!b.Equals(_,l);S||(w!=="start-contains-end"&&u&&s!=="none"&&!u.isExact&&(x=ys[e.props.size]/2+("size"in u.shape.props?ys[u.shape.props.size]/2:0),f=(kc+x)*e.props.scale,m+=x*e.props.scale),w!=="end-contains-start"&&d&&r!=="none"&&!d.isExact&&(y=ys[e.props.size]/2+("size"in d.shape.props?ys[d.shape.props.size]/2:0),g=(kc+y)*e.props.scale,m+=y*e.props.scale));const C=o.clone().add(_.clone().mul(f*(I?-1:1))),E=a.clone().sub(_.clone().mul(g*(I?-1:1)));b.DistMin(C,E,m)&&(f!==0&&g!==0?(f*=-1.5,g*=-1.5):f!==0?f*=-1:g!==0&&(g*=-1)),o.add(_.clone().mul(f*(I?-1:1))),a.sub(_.clone().mul(g*(I?-1:1))),I?(u&&d&&a.setTo(b.Add(o,_.clone().mul(-Ho*e.props.scale))),c.setTo(b.Med(i.start,i.end))):c.setTo(b.Med(o,a));const O=b.Dist(o,a);return{bindings:n,type:"straight",start:{handle:i.start,point:o,arrowhead:e.props.arrowheadStart},end:{handle:i.end,point:a,arrowhead:e.props.arrowheadEnd},middle:c,isValid:O>0,length:O}}function uv(t,e,n,s){if(s===void 0||s.isExact)return;const r=q.applyToPoint(n,e),i=q.applyToPoint(n,t),o=q.applyToPoint(q.Inverse(s.transform),r),a=q.applyToPoint(q.Inverse(s.transform),i),c=Array.from(s.geometry.intersectLineSegment(o,a,{includeLabels:!1,includeInternal:!1}));let l;if(c.length&&(l=c.sort((p,f)=>b.Dist2(p,o)-b.Dist2(f,o))[0]??(s.isClosed?void 0:a)),l===void 0&&(l=s.geometry.nearestPoint(a,{includeLabels:!1,includeInternal:!1}),!b.DistMin(l,a,1)))return;const u=q.applyToPoint(s.transform,l),d=q.applyToPoint(q.Inverse(n),u);t.setTo(d),s.didIntersect=!0}function XB(t,e,n){const{arrowheadEnd:s,arrowheadStart:r}=e.props,i=e.props.bend;if(Math.abs(i)>Math.abs(e.props.bend*(x6*e.props.scale)))return zd(t,e,n);const o=Uo(t,e,n),a=b.Med(o.start,o.end),c=b.Sub(o.end,o.start),l=b.Len(c)?c.uni():b.From(c),u=b.Add(a,l.per().mul(-i)),d=Nd(t,e,"start"),p=Nd(t,e,"end"),f=o.start.clone(),g=o.end.clone(),x=u.clone();if(b.Equals(f,g))return{bindings:n,type:"straight",start:{handle:f,point:f,arrowhead:e.props.arrowheadStart},end:{handle:g,point:g,arrowhead:e.props.arrowheadEnd},middle:x,isValid:!1,length:0};const y=e.props.bend<0,m=y?Jm:DO,S=hv(f,g,x),w=b.Angle(S.center,f),P=b.Angle(S.center,g),_=m(w,P);if(S.length===0||S.size===0||!cw(S.length)||!cw(S.size))return zd(t,e,n);const I=f.clone(),C=g.clone(),E=x.clone(),O=t.getShapePageTransform(e);let k=0,T=0,D=Ho*e.props.scale;if(d&&!d.isExact){const Q=q.applyToPoint(O,I),Y=q.applyToPoint(O,S.center),Ie=q.applyToPoint(O,C),be=q.Inverse(d.transform),me=q.applyToPoint(be,Q),ne=q.applyToPoint(be,Y),Me=q.applyToPoint(be,Ie),{isClosed:ge}=d;let ce,_e=Array.from(d.geometry.intersectCircle(ne,S.radius,{includeLabels:!1,includeInternal:!1}));if(_e.length){const ye=ne.angle(me),ht=ne.angle(Me),st=m(ye,ht);_e=_e.filter(rt=>m(ye,ne.angle(rt))<=st);const Ze=st*.25;_e.sort(ge?(rt,it)=>Math.abs(m(ye,ne.angle(rt))-Ze)<Math.abs(m(ye,ne.angle(it))-Ze)?-1:1:(rt,it)=>m(ye,ne.angle(rt))<m(ye,ne.angle(it))?-1:1),ce=_e[0]}if(!ce)if(ge){const ye=d.geometry.nearestPoint(me,{includeInternal:!1,includeLabels:!1});b.DistMin(ye,me,1)&&(ce=ye)}else ce=me;if(ce&&(I.setTo(t.getPointInShapeSpace(e,q.applyToPoint(d.transform,ce))),d.didIntersect=!0,r!=="none")){const ye=ys[e.props.size]/2+("size"in d.shape.props?ys[d.shape.props.size]/2:0);k=(kc+ye)*e.props.scale,D+=ye*e.props.scale}}if(p&&!p.isExact){const Q=q.applyToPoint(O,I),Y=q.applyToPoint(O,C),Ie=q.applyToPoint(O,S.center),be=q.Inverse(p.transform),me=q.applyToPoint(be,Q),ne=q.applyToPoint(be,Ie),Me=q.applyToPoint(be,Y),ge=p.isClosed;let ce,_e=Array.from(p.geometry.intersectCircle(ne,S.radius,{includeLabels:!1,includeInternal:!1}));if(_e.length){const ye=ne.angle(me),ht=ne.angle(Me),st=m(ye,ht),Ze=st*.75;_e=_e.filter(rt=>m(ye,ne.angle(rt))<=st),_e.sort(ge?(rt,it)=>Math.abs(m(ye,ne.angle(rt))-Ze)<Math.abs(m(ye,ne.angle(it))-Ze)?-1:1:(rt,it)=>m(ye,ne.angle(rt))<m(ye,ne.angle(it))?-1:1),ce=_e[0]}if(!ce)if(ge){const ye=p.geometry.nearestPoint(Me,{includeInternal:!1,includeLabels:!1});b.DistMin(ye,Me,1)&&(ce=ye)}else ce=Me;if(ce&&(C.setTo(t.getPointInShapeSpace(e,q.applyToPoint(p.transform,ce))),p.didIntersect=!0,s!=="none")){const ye=ys[e.props.size]/2+("size"in p.shape.props?ys[p.shape.props.size]/2:0);T=(kc+ye)*e.props.scale,D+=ye*e.props.scale}}let R=b.Angle(S.center,I),M=b.Angle(S.center,C),L=m(R,M),U=L*S.radius;const V=I.clone(),J=C.clone();if(k!==0&&V.setTo(S.center).add(b.FromAngle(R+L*(k/U*(y?1:-1))).mul(S.radius)),T!==0&&J.setTo(S.center).add(b.FromAngle(M+L*(T/U*(y?-1:1))).mul(S.radius)),b.DistMin(V,J,D)){k!==0&&T!==0?(k*=-1.5,T*=-1.5):k!==0?k*=-2:T!==0&&(T*=-2);const Q=.1-m(w,R)*S.radius,Y=.1-m(M,P)*S.radius;k=Math.max(k,Q),T=Math.max(T,Y)}if(k!==0&&I.setTo(S.center).add(b.FromAngle(R+L*(k/U*(y?1:-1))).mul(S.radius)),T!==0&&C.setTo(S.center).add(b.FromAngle(M+L*(T/U*(y?-1:1))).mul(S.radius)),d&&p&&!d.isExact&&!p.isExact){R=b.Angle(S.center,I),M=b.Angle(S.center,C),L=m(R,M),U=L*S.radius;const Q=Ly(t,d.shape.id,p.shape.id);Q==="double-bound"&&U<30?(I.setTo(f),C.setTo(g),E.setTo(x)):Q==="safe"&&(d&&!d.didIntersect&&I.setTo(f),(p&&!p.didIntersect||m(w,R)>m(w,M))&&C.setTo(S.center).add(b.FromAngle(R+L*(Math.min(.9,Ho*e.props.scale/U)*(y?1:-1))).mul(S.radius)))}ZB(S.center,S.radius,I,C,E,_,y),I.equals(C)&&(I.setTo(E.clone().addXY(1,1)),C.setTo(E.clone().subXY(1,1))),f.setTo(I),g.setTo(C),x.setTo(E);const Z=hv(f,g,x);return{bindings:n,type:"arc",start:{point:f,handle:o.start,arrowhead:e.props.arrowheadStart},end:{point:g,handle:o.end,arrowhead:e.props.arrowheadEnd},middle:x,handleArc:S,bodyArc:Z,isValid:Z.length!==0&&isFinite(Z.center.x)&&isFinite(Z.center.y)}}function hv(t,e,n){const s=wP(t,e,n)??b.Med(t,e),r=b.Dist(s,t),i=+b.Clockwise(t,n,e),o=((t.y-e.y)**2+(t.x-e.x)**2)**.5,a=((e.y-n.y)**2+(e.x-n.x)**2)**.5,c=((n.y-t.y)**2+(n.x-t.x)**2)**.5,l=Math.acos((a*a+c*c-o*o)/(2*a*c))*2,u=+(Ve>l),d=(at-l)*(i?1:-1),p=d*r;return{center:s,radius:r,size:d,length:p,largeArcFlag:u,sweepFlag:i}}function ZB(t,e,n,s,r,i,o){const a=b.Angle(t,n),c=b.Angle(t,s);let l=Jm(a,c);if(o||(l=at-l),r.setTo(t).add(b.FromAngle(a+l*(.5*(o?1:-1))).mul(e)),l>i){r.rotWith(t,Ve);const u=s.clone();s.setTo(n),n.setTo(u)}}const pv=["right","bottom","left","top"],JB={top:{x:0,y:-1},right:{x:1,y:0},bottom:{x:0,y:1},left:{x:-1,y:0}},QB={left:"x",right:"x",top:"y",bottom:"y"},Ao={top:"bottom",right:"left",bottom:"top",left:"right"},Ec={x:{v:(t,e)=>new b(t,e),loEdge:"left",hiEdge:"right",crossMid:"midY",gap:"gapX",midRange:"midXRange",self:"x",cross:"y",size:"width"},y:{v:(t,e)=>new b(e,t),loEdge:"top",hiEdge:"bottom",crossMid:"midX",gap:"gapY",midRange:"midYRange",self:"y",cross:"x",size:"height"}};function e6(t,e){const n={min:t.min-e,max:t.max+e};return n.min>n.max?null:n}function t6(t,e){return le(t.min<=t.max&&e.min<=e.max),t.min<=e.min&&e.max<=t.max?[{min:t.min,max:e.min},{min:e.max,max:t.max}]:e.max<=t.min||e.min>=t.max?[t]:e.min<=t.min&&t.max<=e.max?[]:$d(t.min,e)?[{min:e.max,max:t.max}]:$d(t.max,e)?[{min:t.min,max:e.min}]:[]}function tg(t,e){return{min:Math.min(t,e),max:Math.max(t,e)}}function $d(t,e){return t>=e.min&&t<=e.max}function fv(t){return t.max-t.min}function zl(t){if(!t)return;const e=t.cross.min;t.cross.min=-t.cross.max,t.cross.max=-e,t.crossTarget=-t.crossTarget}function $l(t){t&&(t.value=-t.value,t.expanded=t.expanded===null?null:-t.expanded)}const zt={Identity:{x:1,y:1,transpose:!1},Rotate90:{x:-1,y:1,transpose:!0},Rotate180:{x:-1,y:-1,transpose:!1},Rotate270:{x:1,y:-1,transpose:!0},FlipY:{x:1,y:-1,transpose:!1}};function n6(t){return t.transpose?{x:t.y,y:t.x,transpose:!0}:t}function s6(t,e){const n={...t};return e.transpose&&(_i(n,"x","y"),n.transpose=!n.transpose),e.x===-1&&(n.x=-n.x),e.y===-1&&(n.y=-n.y),n}function _i(t,e,n){const s=t[e];t[e]=t[n],t[n]=s}function gv(t,e){e.x=t.x*e.x,e.y=t.y*e.y,t.transpose&&_i(e,"x","y")}function Mo(t,e){t.x===-1&&(e.x=-(e.x+e.width)),t.y===-1&&(e.y=-(e.y+e.height)),t.transpose&&(_i(e,"x","y"),_i(e,"width","height"))}function mv(t,e){t.x===-1&&(_i(e,"left","right"),zl(e.top),zl(e.bottom),$l(e.left),$l(e.right)),t.y===-1&&(_i(e,"top","bottom"),zl(e.left),zl(e.right),$l(e.top),$l(e.bottom)),t.transpose&&(_i(e,"left","top"),_i(e,"right","bottom"))}class r6{options;A;B;common;gapX;gapY;midX;midY;bias;constructor(e){this.options=e.options,this.A=e.A,this.B=e.B,this.common=e.common,this.midX=e.midX,this.midY=e.midY,this.gapX=e.gapX,this.gapY=e.gapY,this.bias=new b(1,1)}transform=zt.Identity;inverse=zt.Identity;apply(e){if(this.transform=s6(e,this.transform),this.inverse=n6(this.transform),Mo(e,this.A.original),Mo(e,this.B.original),Mo(e,this.common.original),Mo(e,this.A.expanded),Mo(e,this.B.expanded),Mo(e,this.common.expanded),mv(e,this.A.edges),mv(e,this.B.edges),gv(e,this.bias),e.x===-1&&(this.gapX=-this.gapX,this.midX=this.midX===null?null:-this.midX),e.y===-1&&(this.gapY=-this.gapY,this.midY=this.midY===null?null:-this.midY),e.transpose){let n=this.midX;this.midX=this.midY,this.midY=n,n=this.gapX,this.gapX=this.gapY,this.gapY=n}}reset(){this.apply(this.inverse)}vec(e,n){const s=new b(e,n);return gv(this.inverse,s),s}}const jo=.01;class ss{constructor(e,n){this.info=e,this.name=n}points=[];add(e,n){return this.points.push(this.info.vec(e,n)),this}_midpointHandle=null;midpointHandle(e){le(this._midpointHandle===null,"midX/midY called multiple times");const n=b.Lrp(this.points[this.points.length-2],this.points[this.points.length-1],.5);return this._midpointHandle={axis:this.info.transform.transpose?e==="x"?"y":"x":e,point:n,segmentStart:this.points[this.points.length-2].clone(),segmentEnd:this.points[this.points.length-1].clone()},this}build(){const e=[];for(let n=0;n<this.points.length;n++){const s=this.points[n],r=e[e.length-1],i=e[e.length-2];if(!r||!i)e.push(s);else{const o=Math.abs(s.x-r.x),a=Math.abs(s.y-r.y),c=Math.abs(s.x-i.x),l=Math.abs(s.y-i.y);o<jo&&a<jo||(o<jo&&c<jo?r.y=s.y:a<jo&&l<jo?r.x=s.x:e.push(s))}}return{name:this.name,points:e,distance:i6(e),aEdgePicking:"manual",bEdgePicking:"manual",skipPointsWhenDrawing:new Set,midpointHandle:this._midpointHandle}}}function i6(t){let e=0;for(let n=0;n<t.length-1;n++){const s=t[n],r=t[n+1];e+=Math.abs(r.x-s.x)+Math.abs(r.y-s.y)}return e}function Nl(t){const e=t.A.edges.right,n=t.B.edges.left;if(!e||!n)return null;if(e.crossTarget>n.crossTarget&&t.apply(zt.FlipY),t.gapX>0&&t.midX!==null)return new ss(t,"to left 1").add(e.value,e.crossTarget).add(t.midX,e.crossTarget).add(t.midX,n.crossTarget).midpointHandle("x").add(n.value,n.crossTarget).build();if(e.expanded===null||n.expanded===null)return null;if(t.midY!==null)return new ss(t,"to left 2").add(e.value,e.crossTarget).add(e.expanded,e.crossTarget).add(e.expanded,t.midY).add(n.expanded,t.midY).midpointHandle("y").add(n.expanded,n.crossTarget).add(n.value,n.crossTarget).build();const s=Math.abs(e.value-t.common.expanded.right)+Math.abs(e.crossTarget-t.common.expanded.bottom)+Math.abs(t.common.expanded.right-n.expanded)+Math.abs(t.common.expanded.bottom-n.crossTarget)+t.options.expandElbowLegLength+6,r=t.options.expandElbowLegLength+Math.abs(e.crossTarget-t.common.expanded.top)+Math.abs(e.expanded-t.common.expanded.left)+Math.abs(t.common.expanded.top-n.crossTarget)+Math.abs(t.common.expanded.left-n.value)+6+t.bias.y,i=t.gapX<0&&t.midX!==null?t.options.expandElbowLegLength+Math.abs(e.crossTarget-t.A.expanded.bottom)+t.common.expanded.width+Math.abs(t.A.expanded.bottom-t.B.expanded.top)+Math.abs(t.B.expanded.top-n.crossTarget)+t.options.expandElbowLegLength+8:1/0;return s<r&&s<i?new ss(t,"to left 3").add(e.value,e.crossTarget).add(t.common.expanded.right,e.crossTarget).add(t.common.expanded.right,t.common.expanded.bottom).add(n.expanded,t.common.expanded.bottom).add(n.expanded,n.crossTarget).add(n.value,n.crossTarget).build():r<i?new ss(t,"to left 4").add(e.value,e.crossTarget).add(e.expanded,e.crossTarget).add(e.expanded,t.common.expanded.top).add(t.common.expanded.left,t.common.expanded.top).add(t.common.expanded.left,n.crossTarget).add(n.value,n.crossTarget).build():t.midX!==null?new ss(t,"to left 5").add(e.value,e.crossTarget).add(e.expanded,e.crossTarget).add(e.expanded,t.A.expanded.bottom).add(t.midX,t.A.expanded.bottom).add(t.midX,t.B.expanded.top).midpointHandle("y").add(n.expanded,t.B.expanded.top).add(n.expanded,n.crossTarget).add(n.value,n.crossTarget).build():null}function Ja(t){const e=t.A.edges.right,n=t.B.edges.top;if(!e||!n)return null;if(e.crossTarget<(n.expanded??n.value)&&n.crossTarget>(e.expanded??e.value)||t.A.isPoint&&t.B.expanded.containsPoint(t.A.original.center))return new ss(t,"to top 1").add(e.value,e.crossTarget).add(n.crossTarget,e.crossTarget).add(n.crossTarget,n.value).build();if(t.gapX>0&&t.midX!==null&&n.expanded!==null)return new ss(t,"to top 2").add(e.value,e.crossTarget).add(t.midX,e.crossTarget).add(t.midX,n.expanded).midpointHandle("x").add(n.crossTarget,n.expanded).add(n.crossTarget,n.value).build();if(t.gapY>0&&e.expanded!==null&&n.crossTarget<e.expanded&&t.midY!==null)return new ss(t,"to top 3").add(e.value,e.crossTarget).add(e.expanded,e.crossTarget).add(e.expanded,t.midY).add(n.crossTarget,t.midY).midpointHandle("y").add(n.crossTarget,n.value).build();const s=Math.abs(e.value-t.common.expanded.right)+Math.abs(e.crossTarget-t.common.expanded.top)+Math.abs(n.crossTarget-t.common.expanded.right)+Math.abs(n.value-t.common.expanded.top),r=e.expanded!==null&&t.midY!==null&&n.expanded!==null?Math.abs(e.value-e.expanded)+Math.abs(t.B.expanded.left-e.expanded)+Math.abs(t.B.expanded.left-n.crossTarget)+Math.abs(e.crossTarget-t.B.expanded.top)+Math.abs(n.value-n.expanded):1/0,i=e.expanded!==null&&t.midX!==null&&n.expanded!==null?Math.abs(e.value-t.common.expanded.right)+Math.abs(e.crossTarget-t.A.expanded.bottom)+Math.abs(e.expanded-n.crossTarget)+Math.abs(t.A.expanded.bottom-n.expanded)+Math.abs(n.expanded-n.value):1/0;return s<r&&s<i?new ss(t,"to top 4").add(e.value,e.crossTarget).add(t.common.expanded.right,e.crossTarget).add(t.common.expanded.right,t.common.expanded.top).add(n.crossTarget,t.common.expanded.top).add(n.crossTarget,n.value).build():n.expanded!==null&&e.expanded!==null&&t.midY!==null&&r<i?new ss(t,"to top 5").add(e.value,e.crossTarget).add(e.expanded,e.crossTarget).add(e.expanded,t.midY).add(t.B.expanded.left,t.midY).midpointHandle("y").add(t.B.expanded.left,n.expanded).add(n.crossTarget,n.expanded).add(n.crossTarget,n.value).build():n.expanded!==null&&e.expanded!==null&&t.midX!==null?new ss(t,"to top 6").add(e.value,e.crossTarget).add(e.expanded,e.crossTarget).add(e.expanded,t.A.expanded.bottom).add(t.midX,t.A.expanded.bottom).add(t.midX,n.expanded).midpointHandle("x").add(n.crossTarget,n.expanded).add(n.crossTarget,n.value).build():null}function Ul(t){return t.apply(zt.FlipY),Ja(t)}function Hl(t){const e=t.A.edges.right,n=t.B.edges.right;if(!e||!n)return null;if((t.gapX<=0||e.crossTarget>t.B.expanded.bottom||e.crossTarget<t.B.expanded.top)&&(n.value>t.A.original.left||n.crossTarget>t.A.expanded.bottom||n.crossTarget<t.A.expanded.top))return new ss(t,"to right 1").add(e.value,e.crossTarget).add(t.common.expanded.right,e.crossTarget).add(t.common.expanded.right,n.crossTarget).add(n.value,n.crossTarget).build();if(t.midX===null)return null;if(n.expanded!==null&&t.gapX>=0){const s=Math.abs(n.crossTarget-t.B.expanded.bottom)+Math.abs(e.crossTarget-t.B.expanded.bottom),r=Math.abs(n.crossTarget-t.B.expanded.top)+Math.abs(e.crossTarget-t.B.expanded.top),i=s<r?"bottom":"top";return new ss(t,`to right 2 via ${i}`).add(e.value,e.crossTarget).add(t.midX,e.crossTarget).add(t.midX,t.B.expanded[i]).midpointHandle("x").add(n.expanded,t.B.expanded[i]).add(n.expanded,n.crossTarget).add(n.value,n.crossTarget).build()}if(e.expanded!==null&&t.gapX<=0){const s=Math.abs(n.crossTarget-t.A.expanded.bottom)+Math.abs(e.crossTarget-t.A.expanded.bottom),r=Math.abs(n.crossTarget-t.A.expanded.top)+Math.abs(e.crossTarget-t.A.expanded.top),i=s<r?"bottom":"top";return new ss(t,`to right 3 via ${i}`).add(e.value,e.crossTarget).add(e.expanded,e.crossTarget).add(e.expanded,t.A.expanded[i]).add(t.midX,t.A.expanded[i]).add(t.midX,n.crossTarget).midpointHandle("x").add(n.value,n.crossTarget).build()}return null}const o6={top:{top:[zt.Rotate270,Hl],left:[zt.Rotate270,Ja],bottom:[zt.Rotate270,Nl],right:[zt.Rotate270,Ul]},right:{top:[zt.Identity,Ja],right:[zt.Identity,Hl],bottom:[zt.Identity,Ul],left:[zt.Identity,Nl]},bottom:{top:[zt.Rotate90,Nl],left:[zt.Rotate90,Ul],bottom:[zt.Rotate90,Hl],right:[zt.Rotate90,Ja]},left:{top:[zt.Rotate180,Ul],left:[zt.Rotate180,Hl],bottom:[zt.Rotate180,Ja],right:[zt.Rotate180,Nl]}};function $t(t,e,n){const[s,r]=o6[e][n];t.apply(s);const i=r(t);return t.reset(),i}function a6(t,e){let n=null;if(Math.abs(t.gapX)+1>Math.abs(t.gapY)&&t.midX!==null)t.gapX>0?n=$t(t,"right","left"):n=$t(t,"left","right");else{const o=t.A.edges.right,a=t.A.edges.left,c=t.B.edges.top,l=t.B.edges.bottom;t.A.isPoint&&t.B.isPoint?t.gapY>0?n=$t(t,"bottom","top"):n=$t(t,"top","bottom"):o&&c&&(o.expanded??o.value)<=c.crossTarget&&o.crossTarget<=(c.expanded??c.value)?n=$t(t,"right","top"):o&&l&&(o.expanded??o.value)<=l.crossTarget&&o.crossTarget>=(l.expanded??l.value)?n=$t(t,"right","bottom"):a&&c&&(a.expanded??a.value)>=c.crossTarget&&a.crossTarget<=(c.expanded??c.value)?n=$t(t,"left","top"):a&&l&&(a.expanded??a.value)>=l.crossTarget&&a.crossTarget>=(l.expanded??l.value)?n=$t(t,"left","bottom"):t.gapY>0&&t.midY!==null?n=$t(t,"bottom","top"):t.gapY<0&&t.midY!==null&&(n=$t(t,"top","bottom"))}if(n)return n.aEdgePicking=e,n.bEdgePicking=e,n;const s=pv.filter(o=>t.A.edges[o]),r=pv.filter(o=>t.B.edges[o]),i=s.flatMap(o=>r.map(a=>[o,a,e,e]));return No(t,i)}function c6(t,e){let n=null;const s=t.A.edges.right,r=t.A.edges.left,i=t.B.edges.top,o=t.B.edges.bottom;switch(e){case"right":t.gapX>0&&t.gapX>Math.abs(t.gapY)&&t.midX!==null?n=$t(t,"right","left"):s&&i&&(s.expanded??s.value)<=i.crossTarget&&s.crossTarget<=(i.expanded??i.value)?n=$t(t,"right","top"):s&&o&&(s.expanded??s.value)<=o.crossTarget&&s.crossTarget>=(o.expanded??o.value)&&(n=$t(t,"right","bottom"));break;case"left":t.gapX<0&&Math.abs(t.gapX)>Math.abs(t.gapY)&&t.midX!==null?n=$t(t,"left","right"):r&&i&&(r.expanded??r.value)>=i.crossTarget&&r.crossTarget<=(i.expanded??i.value)?n=$t(t,"left","top"):r&&o&&(r.expanded??r.value)>=o.crossTarget&&r.crossTarget>=(o.expanded??o.value)&&(n=$t(t,"left","bottom"));break;case"top":case"bottom":break;default:Ke(e)}if(n)return n.aEdgePicking="manual",n.bEdgePicking="auto",n;switch(e){case"top":return No(t,[["top","bottom","manual","auto"],["top","right","manual","auto"],["top","left","manual","auto"],["top","top","manual","auto"]]);case"bottom":return No(t,[["bottom","top","manual","auto"],["bottom","right","manual","auto"],["bottom","left","manual","auto"],["bottom","bottom","manual","auto"]]);case"left":return No(t,[["left","right","manual","auto"],["left","bottom","manual","auto"],["left","left","manual","auto"],["left","top","manual","auto"]]);case"right":return No(t,[["right","left","manual","auto"],["right","bottom","manual","auto"],["right","right","manual","auto"],["right","top","manual","auto"]])}}function l6(t,e,n){const s=$t(t,e,n);return s||(t.A.isPoint&&t.B.isPoint?No(t,[[Ao[e],Ao[n],"manual","manual"],[e,Ao[n],"manual","auto"],[Ao[e],n,"auto","manual"]]):t.A.isPoint?$t(t,Ao[e],n):t.B.isPoint?$t(t,e,Ao[n]):null)}function No(t,e){let n=null,s=1/0,r=1/0,i=0;for(const[o,a,c,l]of e){i+=1;const u=$t(t,o,a);u&&(u.aEdgePicking=c,u.bEdgePicking=l,u.points.length<s?(s=u.points.length,r=u.distance,n=u):u.points.length===s&&u.distance+i<r&&(r=u.distance,n=u))}return n}function rE(t,e,n){const s=t.getShapeUtil(e.type).options,r={elbowMidpoint:e.props.elbowMidPoint,expandElbowLegLength:s.expandElbowLegLength[e.props.size]*e.props.scale,minElbowLegLength:s.minElbowLegLength[e.props.size]*e.props.scale};let i=yv(t,e,n.start,e.props.start),o=yv(t,e,n.end,e.props.end);i=wv(i,o,r),o=wv(o,i,r);const a=!!(!i.side&&o.side);let{aTerminal:c,bTerminal:l}=a?{aTerminal:o,bTerminal:i}:{aTerminal:i,bTerminal:o},u={top:Sn(c,l,"top",r),right:Sn(c,l,"right",r),bottom:Sn(c,l,"bottom",r),left:Sn(c,l,"left",r)},d={top:Sn(l,c,"top",r),right:Sn(l,c,"right",r),bottom:Sn(l,c,"bottom",r),left:Sn(l,c,"left",r)};const p=Sv(u,c.side),f=Sv(d,l.side);let g=!1;(!p||!f)&&(g=!0,p||(l=Qa(l)),f||(c=Qa(c)),l.bounds.containsPoint(c.target,r.expandElbowLegLength)&&(l=Qa(l)),c.bounds.containsPoint(l.target,r.expandElbowLegLength)&&(c=Qa(c))),g&&(u={top:Sn(c,l,"top",r),right:Sn(c,l,"right",r),bottom:Sn(c,l,"bottom",r),left:Sn(c,l,"left",r)},d={top:Sn(l,c,"top",r),right:Sn(l,c,"right",r),bottom:Sn(l,c,"bottom",r),left:Sn(l,c,"left",r)});const x=c.isPoint?c.bounds:c.bounds.clone().expandBy(r.expandElbowLegLength),y=l.isPoint?l.bounds:l.bounds.clone().expandBy(r.expandElbowLegLength),m={original:X.Common([c.bounds,l.bounds]),expanded:X.Common([x,y])};let S=l.bounds.minX-c.bounds.maxX;S<0&&(S=c.bounds.minX-l.bounds.maxX,S<0&&(S=0),S=-S);let w=l.bounds.minY-c.bounds.maxY;w<0&&(w=c.bounds.minY-l.bounds.maxY,w<0&&(w=0),w=-w);const P=c.minEndSegmentLength*3,_=l.minEndSegmentLength*3,I=(c.isPoint?P:r.minElbowLegLength)+(l.isPoint?_:r.minElbowLegLength);let C=null;S>I?C={a:c.isPoint?c.bounds.maxX+P:x.maxX,b:l.isPoint?l.bounds.minX-_:y.minX}:S<-I&&(C={a:c.isPoint?c.bounds.minX-P:x.minX,b:l.isPoint?l.bounds.maxX+_:y.maxX});let E=null;w>I?E={a:c.isPoint?c.bounds.maxY+P:x.maxY,b:l.isPoint?l.bounds.minY-_:y.minY}:w<-I&&(E={a:c.isPoint?c.bounds.minY-P:x.minY,b:l.isPoint?l.bounds.maxY+_:y.maxY});const O=a?1-r.elbowMidpoint:r.elbowMidpoint,k=C?ke(C.a,C.b,O):null,T=E?ke(E.a,E.b,O):null,D={options:r,swapOrder:a,A:{isPoint:c.isPoint,target:c.target,isExact:c.isExact,arrowheadOffset:c.arrowheadOffset,minEndSegmentLength:c.minEndSegmentLength,original:c.bounds,expanded:x,edges:u,geometry:c.geometry},B:{isPoint:l.isPoint,target:l.target,isExact:l.isExact,arrowheadOffset:l.arrowheadOffset,minEndSegmentLength:l.minEndSegmentLength,original:l.bounds,expanded:y,edges:d,geometry:l.geometry},common:m,gapX:S,gapY:w,midX:k,midY:T},R=new r6(D),M=xv(c,l,D.A.edges),L=xv(l,c,D.B.edges);let U;return M&&L?U=l6(R,M,L):M&&!L&&(U=c6(R,M)),U||(U=a6(R,M||L?"fallback":"auto")),U&&(bv("first",D.A,D.B,U),bv("last",D.B,D.A,U),f6(U,c,l),a&&U.points.reverse()),{...D,route:U,midXRange:C?a?{lo:C.b,hi:C.a}:{lo:C.a,hi:C.b}:null,midYRange:E?a?{lo:E.b,hi:E.a}:{lo:E.a,hi:E.b}:null}}function d6(t,e){const n=t.swapOrder?t.B.target:t.A.target,s=t.swapOrder?t.A.target:t.B.target,r=b.ManhattanDist(e.points[0],e.points[1]),i=b.ManhattanDist(e.points[e.points.length-2],e.points[e.points.length-1]),o=b.ManhattanDist(n,e.points[1]),a=b.ManhattanDist(e.points[e.points.length-2],s),c=r-o,l=i-a,u=[n,...e.points,s];return{name:e.name,distance:e.distance+c+l,points:u.filter(d=>!e.skipPointsWhenDrawing.has(d)),aEdgePicking:e.aEdgePicking,bEdgePicking:e.bEdgePicking,skipPointsWhenDrawing:e.skipPointsWhenDrawing,midpointHandle:e.midpointHandle}}function u6(t){return Dt(t.x,.5)&&Dt(t.y,.5)?null:Math.abs(t.x-.5)>Math.abs(t.y-.5)-1e-4?t.x<.5?"left":"right":t.y<.5?"top":"bottom"}function yv(t,e,n,s){const r=ys[e.props.size]*e.props.scale/2,i=r*3;if(n){const o=t.getShape(n.toId),a=h6(t,e,n.toId,n.props);if(a&&o){let c=0;const l=n.props.terminal==="start"?"arrowheadStart":"arrowheadEnd";if(e.props[l]!=="none"){const p="scale"in o.props?o.props.scale:1,f="size"in o.props?(ys[o.props.size]??0)*p/2:0;c=r+f+kc*e.props.scale}let u=null;const d=a.target;return n.props.isPrecise&&(u=u6(b.RotWith(n.props.normalizedAnchor,{x:.5,y:.5},a.shapeToArrowTransform.rotation()))),{targetShapeId:n.toId,isPoint:!1,isExact:n.props.isExact,bounds:a.bounds,geometry:a.geometry,target:d,arrowheadOffset:c,minEndSegmentLength:i,side:u,snap:n.props.snap}}}return{targetShapeId:null,bounds:X.FromCenter(s,{x:0,y:0}),geometry:null,isExact:!1,isPoint:!0,target:b.From(s),arrowheadOffset:0,minEndSegmentLength:i,side:null,snap:"none"}}function h6(t,e,n,s){const r=s.terminal==="start"?e.props.arrowheadStart!=="none":e.props.arrowheadEnd!=="none",i=t.getShapeGeometry(n,r?void 0:{context:"@tldraw/arrow-without-arrowhead"});if(!i)return null;const o=t.getShapePageTransform(e.id),a=t.getShapePageTransform(n),c=o.clone().invert().multiply(a),l=i.transform(c),u={x:.5,y:.5},d=s.isPrecise?s.normalizedAnchor:u,p={x:ke(i.bounds.minX,i.bounds.maxX,d.x),y:ke(i.bounds.minY,i.bounds.maxY,d.y)},f={x:ke(i.bounds.minX,i.bounds.maxX,u.x),y:ke(i.bounds.minY,i.bounds.maxY,u.y)},g=q.applyToPoint(c,p),x=q.applyToPoint(c,f);return{bounds:l.bounds,geometry:l,target:g,center:x,shapeToArrowTransform:c}}const p6={top:{expand:-1,main:"minY",opposite:"maxY",crossMid:"midX",crossMin:"minX",crossMax:"maxX",bRangeExpand:"max",crossAxis:"x"},bottom:{expand:1,main:"maxY",opposite:"minY",crossMid:"midX",crossMin:"minX",crossMax:"maxX",bRangeExpand:"min",crossAxis:"x"},left:{expand:-1,main:"minX",opposite:"maxX",crossMid:"midY",crossMin:"minY",crossMax:"maxY",bRangeExpand:"max",crossAxis:"y"},right:{expand:1,main:"maxX",opposite:"minX",crossMid:"midY",crossMin:"minY",crossMax:"maxY",bRangeExpand:"min",crossAxis:"y"}};function Sn(t,e,n,s){const r=p6[n],i=t.targetShapeId===e.targetShapeId&&t.targetShapeId!==null&&(t.snap==="edge"||t.snap==="edge-point")&&(e.snap==="edge"||e.snap==="edge-point"),o=t.bounds[r.main],a=t.isPoint?null:o+r.expand*s.expandElbowLegLength,c=tg(t.bounds[r.crossMin],t.bounds[r.crossMax]);let l=c;if(!l)return null;le(c);const u=tg(e.bounds[r.main],e.bounds[r.opposite]);e.isPoint||(u[r.bRangeExpand]-=s.minElbowLegLength*2*r.expand);const d=e6(tg(e.bounds[r.crossMin],e.bounds[r.crossMax]),s.expandElbowLegLength);le(u&&d);let p=!1;if($d(o,u)&&!t.isPoint&&!e.isPoint&&!i){const g=t6(l,d);switch(g.length){case 0:return null;case 1:p=g[0]!==l,l=g[0];break;case 2:p=!0,l=fv(g[0])>fv(g[1])?g[0]:g[1];break;default:Ke(g)}}if(!$d(t.target[r.crossAxis],l))return null;const f=t.target[r.crossAxis];return{value:o,expanded:a,cross:l,crossTarget:f,isPartial:p}}function Sv(t,e){return e===null?!!(t.bottom||t.left||t.right||t.top):e==="x"?!!t.left||!!t.right:e==="y"?!!t.top||!!t.bottom:!!t[e]}function xv(t,e,n){switch(t.side){case null:return null;case"x":return t.bounds.center.x>e.bounds.center.x&&n?.left?"left":n?.right?"right":null;case"y":return t.bounds.center.y>e.bounds.center.y&&n?.top?"top":n?.bottom?"bottom":null;default:return t.side}}function Qa(t){if(t.isPoint)return t;let e=null,n=0;return(t.snap==="edge"||t.snap==="edge-point")&&(n=t.arrowheadOffset,(t.side==="x"||t.side==="left"||t.side==="right")&&(e="x"),(t.side==="y"||t.side==="top"||t.side==="bottom")&&(e="y")),{targetShapeId:t.targetShapeId,side:e,bounds:new X(t.target.x,t.target.y,0,0),geometry:t.geometry,target:t.target,arrowheadOffset:n,minEndSegmentLength:t.minEndSegmentLength,isExact:t.isExact,isPoint:!0,snap:t.snap}}function bv(t,e,n,s){if(!e.geometry)return;const r=t==="first"?s.points[0]:s.points[s.points.length-1],i=t==="first"?s.points[1]:s.points[s.points.length-2],o=e.geometry.isClosed?i:e.target,a=b.ManhattanDist(r,o);let c=null,l=1/0;if(e.isExact)c=e.target;else if(e.geometry){const u=e.geometry.intersectLineSegment(i,e.target,{includeLabels:!1,includeInternal:!1});e.geometry.hitTestPoint(e.target,Math.max(1,e.arrowheadOffset),!0,Sr.EXCLUDE_NON_STANDARD)&&u.push(e.target);for(const d of u){const p=b.ManhattanDist(o,d);p<l&&(l=p,c=d)}}if(c){let u=e.arrowheadOffset;const d=b.ManhattanDist(i,c),p=e.arrowheadOffset*2;if(d<p){const y=p-e.arrowheadOffset;u=d-y}u<e.minEndSegmentLength&&(e.geometry.bounds.containsPoint(n.target)?u=Math.max(0,u):u=-e.arrowheadOffset);let f=c,g=!1;if(!e.isExact&&u!==0){const y=b.Nudge(c,i,u);f=y,u<0&&!e.geometry.hitTestPoint(y,0,!0,Sr.EXCLUDE_NON_STANDARD)?f=c:(u<0&&(g=!0),f=y)}const x=b.ManhattanDist(i,f);if(s.distance+=x-a,r.x=f.x,r.y=f.y,g){const y=b.Lrp(i,r,.5);s.skipPointsWhenDrawing.add(y),s.points.splice(t==="first"?1:s.points.length-1,0,y)}}}function f6(t,e,n){if(t){if(t.points.length>=3){const s=t.points[0],r=t.points[1];if(b.ManhattanDist(s,r)<e.minEndSegmentLength&&(t.points.splice(1,1),t.points.length>=3)){const o=Dt(s.x,r.x)?"y":"x";t.points[1][o]=s[o]}}if(t.points.length>=3){const s=t.points[t.points.length-1],r=t.points[t.points.length-2];if(b.ManhattanDist(s,r)<n.minEndSegmentLength&&(t.points.splice(t.points.length-2,1),t.points.length>=3)){const o=Dt(s.x,r.x)?"y":"x";t.points[t.points.length-2][o]=s[o]}}}}function wv(t,e,n){if(!t.geometry||t.geometry.isClosed)return t;const s=t.geometry.uninterpolateAlongEdge(t.target,Sr.EXCLUDE_NON_STANDARD),r=t.geometry.interpolateAlongEdge(s-.01/t.geometry.length),o=t.geometry.interpolateAlongEdge(s+.01/t.geometry.length).sub(r).per().uni(),a=Math.abs(o.x)>Math.abs(o.y)?Ec.x:Ec.y;if(t.geometry.bounds.containsPoint(e.target,n.expandElbowLegLength))return t.side=a.self,Qa(t);const c=a.v(t.target[a.self]-t.bounds[a.size]*2,t.target[a.cross]),l=a.v(t.target[a.self]+t.bounds[a.size]*2,t.target[a.cross]);let u=null,d=0,p=null,f=0,g=a.self;for(const x of t.geometry.intersectLineSegment(c,l,Sr.EXCLUDE_NON_STANDARD))Math.abs(x[a.self]-t.target[a.self])<1||(x[a.self]<t.target[a.self]?b.ManhattanDist(x,t.target)>d&&(d=b.ManhattanDist(x,t.target),u=x):b.ManhattanDist(x,t.target)>f&&(f=b.ManhattanDist(x,t.target),p=x));return u&&p?d>f?g=a.hiEdge:g=a.loEdge:u&&!p?g=a.hiEdge:!u&&p&&(g=a.loEdge),t.side=g,t}const g6=8;function m6(t){return t.props.kind!=="arc"?!1:Math.abs(t.props.bend)<g6*t.props.scale}function Nd(t,e,n){const s=t.getBindingsFromShape(e,"arrow").find(c=>c.props.terminal===n);if(!s)return;const r=t.getShape(s.toId);if(!r)return;const i=t.getShapePageTransform(r),o=n==="start"?e.props.arrowheadStart!=="none":e.props.arrowheadEnd!=="none",a=t.getShapeGeometry(r,o?void 0:{context:"@tldraw/arrow-without-arrowhead"});return{shape:r,transform:i,isClosed:a.isClosed,isExact:s.props.isExact,didIntersect:!1,geometry:a}}function vv(t,e,n,s){const r=t.getShape(n.toId);if(r){const{point:i,size:o}=t.getShapeGeometry(r).bounds,a=b.Add(i,b.MulV(n.props.isPrecise||s?n.props.normalizedAnchor:{x:.5,y:.5},o)),c=q.applyToPoint(t.getShapePageTransform(r),a);return q.applyToPoint(q.Inverse(e),c)}else return new b(0,0)}const y6=su("arrow bindings",(t,e)=>{const n=t.getBindingsFromShape(e.id,"arrow");return{start:n.find(s=>s.props.terminal==="start"),end:n.find(s=>s.props.terminal==="end")}},{areRecordsEqual:(t,e)=>t.id===e.id,areResultsEqual:(t,e)=>t.start===e.start&&t.end===e.end});function Vt(t,e){return y6.get(t,e.id)}const S6=su("arrow info",(t,e)=>{const n=Vt(t,e);if(e.props.kind==="elbow"){const s=rE(t,e,n);if(!s?.route)return zd(t,e,n);const r=s.swapOrder?s.B:s.A,i=s.swapOrder?s.A:s.B;return{type:"elbow",bindings:n,start:{handle:r.target,point:s.route.points[0],arrowhead:e.props.arrowheadStart},end:{handle:i.target,point:s.route.points[s.route.points.length-1],arrowhead:e.props.arrowheadEnd},elbow:s,route:s.route,isValid:!0}}return m6(e)?zd(t,e,n):XB(t,e,n)},{areRecordsEqual:(t,e)=>t.props===e.props,areResultsEqual:zA});function Os(t,e){const n=typeof e=="string"?e:e.id;return S6.get(t,n)}function Uo(t,e,n){const s=t.getShapePageTransform(e),r=Ly(t,n.start?.toId,n.end?.toId),i=n.start?vv(t,s,n.start,r==="double-bound"||r==="start-contains-end"):b.From(e.props.start),o=n.end?vv(t,s,n.end,r==="double-bound"||r==="end-contains-start"):b.From(e.props.end);return{start:i,end:o}}function Fa(t,e,n,s){const r=typeof e=="string"?e:e.id,i=typeof n=="string"?n:n.id,o=t.getBindingsFromShape(r,"arrow").filter(c=>c.props.terminal===s.terminal);o.length>1&&t.deleteBindings(o.slice(1));const a=o[0];a?t.updateBinding({...a,toId:i,props:s}):t.createBinding({type:"arrow",fromId:r,toId:i,props:s})}function ec(t,e,n){const s=t.getBindingsFromShape(e,"arrow").filter(r=>r.props.terminal===n);t.deleteBindings(s)}const Ho=10,kc=10,x6=10,ys={s:2,m:3.5,l:5,xl:10};function Ly(t,e,n){if(!e||!n)return"safe";if(e===n)return"double-bound";const s=t.getShapePageBounds(e),r=t.getShapePageBounds(n);if(s&&r){if(s.contains(r))return"start-contains-end";if(r.contains(s))return"end-contains-start"}return"safe"}function b6(t){return t.getSelectedShapeIds().map(s=>t.getShape(s)).filter(s=>{if(!s)return!1;if(t.isShapeOfType(s,"arrow")){const r=Vt(t,s);if(r.start||r.end)return!1}return!0})}const iE=()=>{const t=z();return $("threeStackableItems",()=>b6(t).length>2,[t])},ai=()=>{const t=z();return $("isInSelectState",()=>t.isIn("select"),[t])},oE=()=>{const t=z();return $("allow group",()=>{const e=t.getSelectedShapes();if(e.length<2)return!1;for(const n of e)if(t.isShapeOfType(n,"arrow")){const s=Vt(t,n);if(s.start&&!e.some(r=>r.id===s.start.toId)||s.end&&!e.some(r=>r.id===s.end.toId))return!1}return!0},[t])},aE=()=>{const t=z();return $("allowUngroup",()=>t.getSelectedShapeIds().some(e=>t.getShape(e)?.type==="group"),[t])},w6=typeof window<"u"&&"navigator"in window&&!!navigator.clipboard&&!!navigator.clipboard.read;function cE(t,e){const n=z();return $("selectedShapes",()=>n.getSelectedShapes().length>=t,[n,t,e])}function Yn(t,e){const n=z();return $("selectedShapes",()=>{const s=n.getSelectedShapes().filter(r=>!n.isShapeOrAncestorLocked(r)).length;return t===void 0?s:s>=t},[n])}function v6(){const t=z();return $("showAutoSizeToggle",()=>{const e=t.getSelectedShapes();return e.length===1&&t.isShapeOfType(e[0],"text")&&e[0].props.autoSize===!1},[t])}function lE(){const t=z();return $("hasLinkShapeSelected",()=>{const e=t.getOnlySelectedShape();return!!(e&&e.type!=="embed"&&"url"in e.props&&!e.isLocked)},[t])}function P6(){const t=z();return $("onlyFlippableShape",()=>{const e=t.getOnlySelectedShape();return e&&(t.isShapeOfType(e,"group")||t.isShapeOfType(e,"image")||t.isShapeOfType(e,"arrow")||t.isShapeOfType(e,"line")||t.isShapeOfType(e,"draw"))},[t])}function dE(){const t=z();return $("useCanRedo",()=>t.getCanRedo(),[t])}function uE(){const t=z();return $("useCanUndo",()=>t.getCanUndo(),[t])}function I6(){return h.jsxs(h.Fragment,{children:[h.jsx(_6,{}),h.jsx(C6,{}),h.jsx(T6,{}),h.jsx(E6,{}),h.jsx(k6,{}),h.jsx(M6,{}),h.jsx(j6,{}),h.jsx(D6,{})]})}function _6(){const t=Yn(2),e=ai(),n=t&&e;return h.jsxs(h.Fragment,{children:[h.jsx(W,{actionId:"align-left",disabled:!n}),h.jsx(W,{actionId:"align-center-horizontal",disabled:!n}),h.jsx(W,{actionId:"align-right",disabled:!n}),h.jsx(W,{actionId:"stretch-horizontal",disabled:!n}),h.jsx(W,{actionId:"align-top",disabled:!n}),h.jsx(W,{actionId:"align-center-vertical",disabled:!n}),h.jsx(W,{actionId:"align-bottom",disabled:!n}),h.jsx(W,{actionId:"stretch-vertical",disabled:!n})]})}function C6(){const t=Yn(3),e=ai(),n=t&&e;return h.jsxs(h.Fragment,{children:[h.jsx(W,{actionId:"distribute-horizontal",disabled:!n}),h.jsx(W,{actionId:"distribute-vertical",disabled:!n})]})}function T6(){const t=iE(),e=ai(),n=t&&e;return h.jsxs(h.Fragment,{children:[h.jsx(W,{actionId:"stack-horizontal",disabled:!n}),h.jsx(W,{actionId:"stack-vertical",disabled:!n})]})}function E6(){const t=Yn(1),e=ai(),n=t&&e;return h.jsxs(h.Fragment,{children:[h.jsx(W,{actionId:"send-to-back",disabled:!n}),h.jsx(W,{actionId:"send-backward",disabled:!n}),h.jsx(W,{actionId:"bring-forward",disabled:!n}),h.jsx(W,{actionId:"bring-to-front",disabled:!n})]})}function k6(){return hn()<yt.TABLET_SM?h.jsx(Hy,{}):h.jsx(A6,{})}function A6(){const t=Yn(1),e=ai(),n=t&&e;return h.jsx(W,{actionId:"rotate-ccw",disabled:!n})}function M6(){const t=Yn(1),e=ai(),n=t&&e;return h.jsx(W,{actionId:"rotate-cw",disabled:!n})}function j6(){const t=lE(),e=ai(),n=t&&e;return h.jsx(W,{actionId:"edit-link",disabled:!n})}function D6(){const t=oE(),e=aE();return t?h.jsx(Pv,{}):e?h.jsx(O6,{}):h.jsx(Pv,{})}function Pv(){const t=Yn(2),e=ai(),n=t&&e;return h.jsx(W,{actionId:"group",disabled:!n})}function O6(){return h.jsx(W,{actionId:"ungroup"})}const L6=v.memo(function({children:e}){const n=ae(),s=hn(),r=_s(),{orientation:i}=sl(),o=v.useRef(null);Ir(o);const a=z(),c=$("should display quick actions when in readonly",()=>a.isInAny("hand","zoom"),[a]),l=e??h.jsx(I6,{});if(!(r&&!c))return h.jsxs(io,{id:"actions-menu",children:[h.jsx(oo,{children:h.jsx(ot,{type:"icon","data-testid":"actions-menu.button",title:n("actions-menu.title"),children:h.jsx(Se,{icon:i==="horizontal"?"dots-vertical":"dots-horizontal",small:!0})})}),h.jsx(ao,{side:i==="horizontal"?s>=yt.TABLET?"bottom":"top":"right",sideOffset:6,children:h.jsx(Wn,{ref:o,label:n("actions-menu.title"),className:"tlui-actions-menu","data-testid":"actions-menu.content",orientation:"grid",children:h.jsx(Kn,{type:"icons",sourceId:"actions-menu",children:l})})})]})});function R6(){const t=z(),e=ju(),n=$("isSelectToolActive",()=>t.getCurrentToolId()==="select",[t]),s=$("isSinglePageMode",()=>t.options.maxPages<=1,[t]);return n?h.jsxs(h.Fragment,{children:[e&&h.jsx(v9,{}),h.jsxs(Ae,{id:"modify",children:[h.jsx(r9,{}),h.jsx(i9,{}),h.jsx(c9,{}),!s&&h.jsx(l9,{})]}),h.jsx(n2,{}),h.jsx(s2,{}),h.jsx(Ae,{id:"select-all",children:h.jsx(r2,{})})]}):null}const F6=v.memo(function({children:e,disabled:n=!1}){const s=z(),r=ae(),{Canvas:i}=nt(),o=v.useCallback(p=>{p.key==="Escape"&&(p.stopPropagation(),s.getContainer().focus())},[s]);v.useEffect(()=>()=>{document.body.removeEventListener("keydown",o,{capture:!0})},[o]);const a=v.useCallback(p=>{if(p){if(document.body.addEventListener("keydown",o,{capture:!0}),s.getInstanceState().isCoarsePointer){const f=s.getSelectedShapes(),g=s.inputs.getCurrentPagePoint(),x=s.getShapesAtPoint(g);if(!s.getSelectedShapes().length||!x.some(y=>f.includes(y))){const y=x.filter(m=>s.isShapeOrAncestorLocked(m));y.length&&s.select(...y.map(m=>m.id))}}}else{const f=s.getOnlySelectedShape();f&&s.isShapeOrAncestorLocked(f)&&s.setSelectedShapes([]),s.timers.requestAnimationFrame(()=>{document.body.removeEventListener("keydown",o,{capture:!0})})}},[s,o]),c=Lt(),[l,u]=ii("context menu",a),d=e??h.jsx(R6,{});return h.jsxs(Dk,{dir:"ltr",onOpenChange:u,modal:!1,children:[h.jsx(Ok,{onContextMenu:void 0,dir:"ltr",disabled:n,children:i?h.jsx(i,{}):null}),l&&h.jsx(Lk,{container:c,children:h.jsx(Rk,{className:"tlui-menu tlui-scrollable","data-testid":"context-menu","aria-label":r("context-menu.title"),alignOffset:-4,collisionPadding:4,onContextMenu:Pe,children:h.jsx(Kn,{type:"context-menu",sourceId:"context-menu",children:d})})})]})}),B6=2e3,z6=5e3,$6=Ot(function(){const e=z(),{isChatting:n,chatMessage:s}=e.getInstanceState(),r=v.useRef(-1),[i,o]=v.useState("");return v.useEffect(()=>{if(!n&&s||n){const c=n?z6:B6;r.current=e.timers.setTimeout(()=>{e.updateInstanceState({chatMessage:"",isChatting:!1}),o(""),e.focus()},c)}return()=>{clearTimeout(r.current)}},[e,s,n]),n?h.jsx(U6,{value:i,setValue:o,chatMessage:s}):s.trim()?h.jsx(N6,{chatMessage:s}):null});function hE(t){const e=z();v.useLayoutEffect(()=>{if(!t.current)return;const{x:s,y:r}=e.inputs.getCurrentScreenPoint();t.current?.style.setProperty("transform",`translate(${s}px, ${r}px)`);function i(o){const{minX:a,minY:c}=e.getViewportScreenBounds();t.current?.style.setProperty("transform",`translate(${o.clientX-a}px, ${o.clientY-c}px)`)}return window.addEventListener("pointermove",i),()=>{window.removeEventListener("pointermove",i)}},[t,e])}const N6=({chatMessage:t})=>{const e=z(),n=v.useRef(null);return hE(n),h.jsx("div",{ref:n,className:"tl-cursor-chat tl-cursor-chat__bubble",style:{backgroundColor:e.user.getColor()},children:t})},U6=Ot(function({chatMessage:e,value:n,setValue:s}){const r=z(),i=ae(),o=v.useRef(null),a=e||i("cursor-chat.type-to-chat");hE(o),v.useLayoutEffect(()=>{const p=o.current;if(!p)return;const f=r.textMeasure.measureText(n||a,{fontFamily:"var(--font-body)",fontSize:12,fontWeight:"500",fontStyle:"normal",maxWidth:null,lineHeight:1,padding:"6px"});p.style.setProperty("width",f.w+"px")},[r,n,a]),v.useLayoutEffect(()=>{const p=r.timers.requestAnimationFrame(()=>{o.current?.focus()});return()=>{cancelAnimationFrame(p)}},[r]);const c=v.useCallback(()=>{r.updateInstanceState({isChatting:!1}),r.focus()},[r]),l=v.useCallback(p=>{const{value:f}=p.target;s(f.slice(0,64)),r.updateInstanceState({chatMessage:f})},[r,s]),u=v.useCallback(p=>{const f=o.current;if(!f)return;const{value:g}=f;switch(p.key){case"Enter":{if(Pe(p),p.stopPropagation(),!g){c();return}s("");break}case"Escape":{Pe(p),p.stopPropagation(),c();break}}},[c,s]),d=v.useCallback(p=>{p.stopPropagation()},[]);return h.jsx("input",{ref:o,className:"tl-cursor-chat",style:{backgroundColor:r.user.getColor()},onBlur:c,onChange:l,onKeyDown:u,onPaste:d,value:n,placeholder:a,spellCheck:!1})});function qg({checked:t}){const e=ae();return h.jsx(wr,{"data-checked":!!t,label:e(t?"ui.checked":"ui.unchecked"),icon:t?"check":"none",className:"tlui-button__icon",small:!0})}function ol({id:t,kbd:e,label:n,lang:s,readonlyOk:r,onSelect:i,toggle:o=!1,disabled:a=!1,checked:c=!1}){const{type:l,sourceId:u}=Mu(),d=_s(),p=ae();if(d&&!r)return null;const f=jc(n,l),g=f?p(f):void 0;switch(l){case"menu":return h.jsxs(l0,{dir:"ltr",lang:s,className:"tlui-button tlui-button__menu tlui-button__checkbox",title:g,onSelect:x=>{i?.(u),Pe(x)},disabled:a,checked:c,children:[h.jsx(wr,{small:!0,label:p(c?"ui.checked":"ui.unchecked"),icon:o?c?"toggle-on":"toggle-off":c?"check":"none"}),g&&h.jsx("span",{className:"tlui-button__label",draggable:!1,children:g}),e&&h.jsx(pc,{children:e})]});case"context-menu":return h.jsxs(Fk,{className:"tlui-button tlui-button__menu tlui-button__checkbox",dir:"ltr",lang:s,title:g,onSelect:x=>{i(u),Pe(x)},disabled:a,checked:c,children:[h.jsx(wr,{small:!0,label:p(c?"ui.checked":"ui.unchecked"),icon:o?c?"toggle-on":"toggle-off":c?"check":"none"}),g&&h.jsx("span",{className:"tlui-button__label",draggable:!1,children:g}),e&&h.jsx(pc,{children:e})]},t);default:return null}}function Tn({id:t,disabled:e=!1,label:n,size:s="small",children:r}){const{type:i,sourceId:o}=Mu(),a=Lt(),c=ae(),l=n?typeof n=="string"?n:n[i]??n.default:void 0,u=l?c(l):void 0;switch(i){case"menu":return h.jsxs(iB,{id:`${o}-sub.${t}`,children:[h.jsx(oB,{id:`${o}-sub.${t}-button`,disabled:e,label:u,title:u}),h.jsx(aB,{id:`${o}-sub.${t}-content`,size:s,children:r})]});case"context-menu":return e?null:h.jsxs(H6,{id:`${o}-sub.${t}`,children:[h.jsx(Bk,{dir:"ltr",disabled:e,asChild:!0,children:h.jsxs(Re,{"data-testid":`${o}-sub.${t}-button`,type:"menu",className:"tlui-menu__submenu__trigger",children:[h.jsx(Mt,{children:u}),h.jsx(Se,{icon:"chevron-right",small:!0})]})}),h.jsx(zk,{container:a,children:h.jsx($k,{"data-testid":`${o}-sub.${t}-content`,className:"tlui-menu tlui-menu__submenu__content",alignOffset:-1,sideOffset:-4,collisionPadding:4,"data-size":s,children:r})})]});default:return r}}function H6({id:t,children:e}){const[n,s]=ii(t);return h.jsx(Nk,{open:n,onOpenChange:s,children:e})}function K6({customDebugFlags:t,customFeatureFlags:e}){const n=z(),{addToast:s}=oi(),{addDialog:r}=il(),[i,o]=Ye.useState(!1);return h.jsxs(h.Fragment,{children:[h.jsxs(Ae,{id:"items",children:[h.jsx($e,{id:"hard-reset",onSelect:kP,label:"Hard reset"}),h.jsx($e,{id:"add-toast",onSelect:()=>{s({id:Ge(),title:"Something good happened",description:"Hey, attend to this thing over here. It might be important!",keepOpen:!0,severity:"success"}),s({id:Ge(),title:"Something happened",description:"Hey, attend to this thing over here. It might be important!",keepOpen:!0,severity:"info",actions:[{label:"Primary",type:"primary",onClick:()=>{}},{label:"Normal",type:"normal",onClick:()=>{}},{label:"Danger",type:"danger",onClick:()=>{}}]}),s({id:Ge(),title:"Something maybe bad happened",description:"Hey, attend to this thing over here. It might be important!",keepOpen:!0,severity:"warning",actions:[{label:"Primary",type:"primary",onClick:()=>{}},{label:"Normal",type:"normal",onClick:()=>{}},{label:"Danger",type:"danger",onClick:()=>{}}]}),s({id:Ge(),title:"Something bad happened",severity:"error",keepOpen:!0})},label:"Show toast"}),h.jsx($e,{id:"show-dialog",label:"Show dialog",onSelect:()=>{r({component:({onClose:a})=>h.jsx(G6,{displayDontShowAgain:!0,onCancel:()=>a(),onContinue:()=>a()}),onClose:()=>{}})}}),h.jsx($e,{id:"create-shapes",label:"Create 100 shapes",onSelect:()=>Y6(n,100)}),h.jsx($e,{id:"count-nodes",label:"Count shapes / nodes",onSelect:()=>{const a=n.getSelectedShapes(),c=a.length===0?n.getRenderingShapes():a;window.alert(`Shapes ${c.length}, DOM nodes:${document.querySelector(".tl-shapes").querySelectorAll("*")?.length}`)}}),(()=>{if(i)throw Error("oh no!");return null})(),h.jsx($e,{id:"throw-error",onSelect:()=>o(!0),label:"Throw error"})]}),h.jsxs(Ae,{id:"flags",children:[h.jsx(W6,{customDebugFlags:t}),h.jsx(q6,{customFeatureFlags:e})]})]})}function W6(t){const e=Object.values(t.customDebugFlags??mt);return e.length?h.jsx(Tn,{id:"debug flags",label:"Debug flags",children:h.jsx(Ae,{id:"debug flags",children:e.map(n=>h.jsx(pE,{flag:n},n.name))})}):null}function q6(t){const e=Object.values(t.customFeatureFlags??$O);return e.length?h.jsx(Tn,{id:"feature flags",label:"Feature flags",children:h.jsx(Ae,{id:"feature flags",children:e.map(n=>h.jsx(pE,{flag:n},n.name))})}):null}function G6({title:t="title",body:e="hello hello hello",cancel:n="Cancel",confirm:s="Continue",displayDontShowAgain:r=!1,maxWidth:i="350",onCancel:o,onContinue:a}){const[c,l]=Ye.useState(!1);return h.jsxs(h.Fragment,{children:[h.jsxs(Eu,{children:[h.jsx(ku,{children:t}),h.jsx(Au,{})]}),h.jsx(Tc,{style:{maxWidth:i},children:e}),h.jsxs(Ty,{className:"tlui-dialog__footer__actions",children:[r&&h.jsxs(Re,{type:"normal",onClick:()=>l(!c),style:{marginRight:"auto"},children:[h.jsx(qg,{checked:c}),h.jsx(Mt,{children:"Don’t show again"})]}),h.jsx(Re,{type:"normal",onClick:o,children:h.jsx(Mt,{children:n})}),h.jsx(Re,{type:"primary",onClick:async()=>a(),children:h.jsx(Mt,{children:s})})]})]})}const pE=Ot(function({flag:e,onChange:n}){const s=e.get();return h.jsx(ol,{id:e.name,title:e.name,label:e.name.replace(/([a-z0-9])([A-Z])/g,r=>`${r[0]} ${r[1].toLowerCase()}`).replace(/^[a-z]/,r=>r.toUpperCase()),checked:s,onSelect:()=>{e.set(!s),n?.(!s)}})});let Iv=0;function Y6(t,e){const n=t.options.adjacentShapeMargin,s=Array(e),r=Math.floor(Math.sqrt(e));for(let i=0;i<e;i++)Iv++,s[i]={id:tt("box"+Iv),type:"geo",x:i%r*(100+n),y:Math.floor(i/r)*(100+n)};t.run(()=>{t.createShapes(s).setSelectedShapes(s.map(i=>i.id))})}function V6({children:t}){const e=t??h.jsx(K6,{});return h.jsxs(Du,{id:"debug",children:[h.jsx(Ou,{children:h.jsx(Re,{type:"icon",title:"Debug menu",children:h.jsx(Se,{icon:"dots-horizontal"})})}),h.jsx(Lu,{side:"top",align:"end",alignOffset:0,children:h.jsx(Kn,{type:"menu",sourceId:"debug-panel",children:e})})]})}const X6=v.memo(function(){const{DebugMenu:e}=Cr(),n=v.useRef(null);return Ir(n),h.jsxs("footer",{ref:n,className:"tlui-debug-panel",children:[h.jsx(Z6,{}),h.jsx(J6,{}),e&&h.jsx(e,{})]})}),Z6=Ot(function(){const n=z().getPath();return h.jsx("div",{className:"tlui-debug-panel__current-state",children:`${n}`})});function J6(){const t=z(),e=$("show_fps",()=>mt.showFps.get(),[mt]),n=v.useRef(null);return v.useEffect(()=>{if(!e)return;const s=250;let r=0,i=-1,o=performance.now(),a=0,c=0,l=!1;function u(){if(c++,a=performance.now()-o,a>s){const d=Math.round(c*(s/a)*(1e3/s));d>r&&(r=d);const p=r*.75;(d<p&&!l||d>=p&&l)&&(l=!l),n.current.innerHTML=`FPS ${d.toString()}`,n.current.className="tlui-debug-panel__fps"+(l?" tlui-debug-panel__fps__slow":""),a-=s,c=0,o=performance.now()}i=t.timers.requestAnimationFrame(u)}return u(),()=>{cancelAnimationFrame(i)}},[e,t]),e?h.jsx("div",{ref:n}):null}function Q6(){const t=z(),e=$("follow",()=>t.getInstanceState().followingUserId,[t]);return e?h.jsx(ez,{userId:e}):null}function ez({userId:t}){const e=Pu(t);return e?h.jsx("div",{className:"tlui-following-indicator",style:{borderColor:e.color}}):null}const tz=v.memo(function(){const e=hn(),n=ae(),s=v.useRef(null);Ir(s);const{MainMenu:r,QuickActions:i,ActionsMenu:o,PageMenu:a}=Cr(),c=z(),l=$("isSinglePageMode",()=>c.options.maxPages<=1,[c]),u=c.options.actionShortcutsLocation==="menu"?!0:c.options.actionShortcutsLocation==="toolbar"?!1:e>=yt.TABLET;return!r&&!a&&!u?null:h.jsx("nav",{ref:s,className:"tlui-menu-zone",children:h.jsxs(xo,{children:[r&&h.jsx(r,{}),a&&!l&&h.jsx(a,{}),u?h.jsxs(Wn,{orientation:"horizontal",label:n("actions-menu.title"),children:[i&&h.jsx(i,{}),o&&h.jsx(o,{})]}):null]})})}),nz=({id:t,component:e,preventBackgroundClose:n})=>{const{removeDialog:s}=il(),r=v.useRef(!1),i=Lt(),o=v.useCallback(a=>{a||s(t)},[t,s]);return h.jsx(Uk,{onOpenChange:o,defaultOpen:!0,children:h.jsx(Hk,{container:i,children:h.jsx(Kk,{dir:"ltr",className:"tlui-dialog__overlay",onClick:a=>{r.current||!n&&a.target===a.currentTarget&&o(!1)},children:h.jsx(Wk,{dir:"ltr",className:"tlui-dialog__content","aria-describedby":void 0,onMouseDown:()=>r.current=!0,onMouseUp:()=>r.current=!1,onInteractOutside:a=>{r.current=!1,n&&a.preventDefault()},children:h.jsx(e,{onClose:()=>{r.current=!1,o(!1)}})})})})})},sz=v.memo(function(){const{dialogs:e}=il();return $("dialogs",()=>e.get(),[e]).map(s=>h.jsx(nz,{...s},s.id))});function rz(){const t=z(),e=Tr(),[n,s]=v.useState(!1),r=v.useRef(!1);return Qi("toggle showback to content",()=>{const i=r.current,o=t.getCurrentPageShapeIds();let a=!1;o.size&&(a=o.size===t.getNotVisibleShapes().size),i!==a&&(s(a),r.current=a)},[t]),n?h.jsx(W,{actionId:"back-to-content",onSelect:()=>{e["back-to-content"].onSelect("helper-buttons"),s(!1)}}):null}function iz(){const t=z();return $("is pen mode",()=>t.getInstanceState().isPenMode,[t])?h.jsx(W,{actionId:"exit-pen-mode"}):null}function oz(){const t=z(),e=Tr();return $("is following user",()=>!!t.getInstanceState().followingUserId,[t])?h.jsx($e,{...e["stop-following"]}):null}function az(){return h.jsxs(h.Fragment,{children:[h.jsx(iz,{}),h.jsx(rz,{}),h.jsx(oz,{})]})}function cz({children:t}){const e=t??h.jsx(az,{});return h.jsx("div",{className:"tlui-helper-buttons",children:h.jsx(Kn,{type:"helper-buttons",sourceId:"helper-buttons",children:e})})}const lz=[{colorScheme:"light",label:"theme.light"},{colorScheme:"dark",label:"theme.dark"},{colorScheme:"system",label:"theme.system"}];function dz(){const t=z(),e=St(),n=$("colorScheme",()=>t.user.getUserPreferences().colorScheme??(t.user.getIsDarkMode()?"dark":"light"),[t]);return h.jsx(Tn,{id:"help menu color-scheme",label:"menu.theme",children:h.jsx(Ae,{id:"theme",children:lz.map(({colorScheme:s,label:r})=>h.jsx(ol,{id:`color-scheme-${s}`,label:r,checked:s===n,readonlyOk:!0,onSelect:()=>{t.user.updateUserPreferences({colorScheme:s}),e("color-scheme",{source:"menu",value:s})}},s))})})}function fE(){const t=Tt(),e=St(),n=$("locale",()=>t?.user.getLocale(),[t]);return t?h.jsx(Tn,{id:"help menu language",label:"menu.language",children:h.jsx(Ae,{id:"languages",className:"tlui-language-menu",children:vc.map(({locale:s,label:r})=>h.jsx(ol,{id:`language-${s}`,lang:s,title:s,label:r,checked:s===n,readonlyOk:!0,onSelect:()=>{t.user.updateUserPreferences({locale:s}),e("change-language",{source:"menu",locale:s})}},s))})}):null}function uz(){return h.jsxs(h.Fragment,{children:[h.jsx(fE,{}),h.jsx(gE,{})]})}function gE(){const{KeyboardShortcutsDialog:t}=Cr(),{addDialog:e}=il(),n=v.useCallback(()=>{t&&e({component:t})},[e,t]);return t?h.jsx($e,{id:"keyboard-shortcuts-button",label:"help-menu.keyboard-shortcuts",readonlyOk:!0,onSelect:n}):null}const hz=["auto","trackpad","mouse"];function pz(){const t=z(),e=St(),n=$("inputMode",()=>t.user.getUserPreferences().inputMode,[t]),s=$("wheelBehavior",()=>t.getCameraOptions().wheelBehavior,[t]),r=o=>o==="auto"?n===null:n===o,i=(o,a)=>o==="auto"?`action.toggle-auto-${a}`:o==="trackpad"?"action.toggle-trackpad":"action.toggle-mouse";return h.jsx(Tn,{id:"help menu input-mode",label:"menu.input-mode",children:h.jsx(Ae,{id:"peripheral-mode",children:hz.map(o=>h.jsx(ol,{id:`peripheral-mode-${o}`,label:i(o,s),checked:r(o),readonlyOk:!0,onSelect:()=>{switch(e("input-mode",{source:"menu",value:o}),o){case"auto":t.user.updateUserPreferences({inputMode:null});break;case"trackpad":t.user.updateUserPreferences({inputMode:"trackpad"});break;case"mouse":t.user.updateUserPreferences({inputMode:"mouse"});break}}},o))})})}function fz(){return h.jsxs(h.Fragment,{children:[h.jsxs(Ae,{id:"basic",children:[h.jsx(mz,{}),h.jsx(bz,{}),h.jsx(gz,{}),h.jsx(wz,{})]}),h.jsx(vz,{})]})}function gz(){return h.jsxs(Tn,{id:"export-all-as",label:"context-menu.export-all-as",size:"small",children:[h.jsxs(Ae,{id:"export-all-as-group",children:[h.jsx(W,{actionId:"export-all-as-svg"}),h.jsx(W,{actionId:"export-all-as-png"})]}),h.jsx(Ae,{id:"export-all-as-bg",children:h.jsx(Uy,{})})]})}function mz(){return h.jsxs(Tn,{id:"edit",label:"menu.edit",children:[h.jsx(xz,{}),h.jsx(n2,{}),h.jsx(s2,{}),h.jsx(yz,{}),h.jsx(Sz,{}),h.jsx(Ae,{id:"select-all",children:h.jsx(r2,{})})]})}function yz(){return h.jsxs(Ae,{id:"misc",children:[h.jsx(VE,{}),h.jsx(XE,{}),h.jsx(GE,{}),h.jsx(qE,{}),h.jsx(ZE,{}),h.jsx(JE,{}),h.jsx(o2,{}),h.jsx(i2,{}),h.jsx(YE,{})]})}function Sz(){return h.jsxs(Ae,{id:"lock",children:[h.jsx(QE,{}),h.jsx(J8,{})]})}function xz(){const t=uE(),e=dE();return h.jsxs(Ae,{id:"undo-redo",children:[h.jsx(W,{actionId:"undo",disabled:!t}),h.jsx(W,{actionId:"redo",disabled:!e})]})}function bz(){return h.jsx(Tn,{id:"view",label:"menu.view",children:h.jsxs(Ae,{id:"view-actions",children:[h.jsx(W,{actionId:"zoom-in"}),h.jsx(W,{actionId:"zoom-out"}),h.jsx(Hy,{}),h.jsx(e2,{}),h.jsx(t2,{})]})})}function wz(){return h.jsxs(h.Fragment,{children:[h.jsx(W,{actionId:"insert-embed"}),h.jsx(W,{actionId:"insert-media"})]})}function vz(){return h.jsxs(Ae,{id:"preferences",children:[h.jsxs(Tn,{id:"preferences",label:"menu.preferences",children:[h.jsxs(Ae,{id:"preferences-actions",children:[h.jsx(d9,{}),h.jsx(u9,{}),h.jsx(h9,{}),h.jsx(p9,{}),h.jsx(f9,{}),h.jsx(g9,{}),h.jsx(b9,{}),h.jsx(w9,{}),h.jsx(x9,{})]}),h.jsxs(Ae,{id:"user-interface-submenus",children:[h.jsx(pz,{}),h.jsx(dz,{}),h.jsx(P9,{})]})]}),h.jsx(fE,{}),h.jsx(gE,{})]})}const Pz=v.memo(function({children:e}){const n=Lt(),[s,r]=ii("main menu"),i=ae(),o=e??h.jsx(fz,{});return h.jsxs(sm,{dir:"ltr",open:s,onOpenChange:r,modal:!1,children:[h.jsx(rm,{asChild:!0,dir:"ltr",children:h.jsx(Re,{type:"icon","data-testid":"main-menu.button",title:i("menu.title"),children:h.jsx(Se,{icon:"menu",small:!0})})}),h.jsx(qd,{container:n,children:h.jsx(im,{className:"tlui-menu",side:"bottom",align:"start",collisionPadding:4,alignOffset:0,sideOffset:6,children:h.jsx(Kn,{type:"menu",sourceId:"main-menu",children:o})})})]})}),ng={};function Ba(t){if(ng[t])return ng[t];const n=document.createElement("canvas").getContext("2d");n.fillStyle=t,n.fillRect(0,0,1,1);const[s,r,i,o]=n.getImageData(0,0,1,1).data,a=new Float32Array([s/255,r/255,i/255,o/255]);return ng[t]=a,a}const ld=10,mE=24*ld+12+48;function Oo(t,{center:e,radius:n,numArcSegments:s=20,startAngle:r=0,endAngle:i=at,offset:o=0}){const a=(i-r)/s;let c=o;for(let l=r;l<i;l+=a)t[c++]=e.x,t[c++]=e.y,t[c++]=e.x+Math.cos(l)*n,t[c++]=e.y+Math.sin(l)*n,t[c++]=e.x+Math.cos(l+a)*n,t[c++]=e.y+Math.sin(l+a)*n;return t}function Lo(t,e,n,s,r,i){t[e++]=n,t[e++]=s,t[e++]=n,t[e++]=s+i,t[e++]=n+r,t[e++]=s,t[e++]=n+r,t[e++]=s,t[e++]=n,t[e++]=s+i,t[e++]=n+r,t[e++]=s+i}function Iz(t,e,n){const s=ld;n=Math.min(n,Math.min(e.w,e.h)/2);const r=X.ExpandBy(e,-n);if(r.w<=0||r.h<=0)return Oo(t,{center:e.center,radius:n,numArcSegments:ld*4}),ld*4*6;let i=0;return Lo(t,i,r.minX,r.minY,r.w,r.h),i+=12,Lo(t,i,r.minX,e.minY,r.w,n),i+=12,Lo(t,i,r.maxX,r.minY,n,r.h),i+=12,Lo(t,i,r.minX,r.maxY,r.w,n),i+=12,Lo(t,i,e.minX,r.minY,n,r.h),i+=12,Oo(t,{numArcSegments:s,offset:i,center:r.point,radius:n,startAngle:Ve,endAngle:Ve*1.5}),i+=s*6,Oo(t,{numArcSegments:s,offset:i,center:b.Add(r.point,new b(r.w,0)),radius:n,startAngle:Ve*1.5,endAngle:at}),i+=s*6,Oo(t,{numArcSegments:s,offset:i,center:b.Add(r.point,r.size),radius:n,startAngle:0,endAngle:vt}),i+=s*6,Oo(t,{numArcSegments:s,offset:i,center:b.Add(r.point,new b(0,r.h)),radius:n,startAngle:vt,endAngle:Ve}),mE}function _z(t){if(!t)throw new Error("Canvas element not found");const e=t.getContext("webgl2",{premultipliedAlpha:!1});if(!e)throw new Error("Failed to get webgl2 context");const n=`#version 300 es
  precision mediump float;
  
  in vec2 shapeVertexPosition;

	uniform vec4 canvasPageBounds;

	// taken (with thanks) from
	// https://webglfundamentals.org/webgl/lessons/webgl-2d-matrices.html
  void main() {
		// convert the position from pixels to 0.0 to 1.0
		vec2 zeroToOne = (shapeVertexPosition - canvasPageBounds.xy) / canvasPageBounds.zw;
	
		// convert from 0->1 to 0->2
		vec2 zeroToTwo = zeroToOne * 2.0;
	
		// convert from 0->2 to -1->+1 (clipspace)
		vec2 clipSpace = zeroToTwo - 1.0;
	
		gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);
  }`,s=e.createShader(e.VERTEX_SHADER);if(!s)throw new Error("Failed to create vertex shader");if(e.shaderSource(s,n),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS))throw new Error("Failed to compile vertex shader");const r=`#version 300 es
  precision mediump float;
  
	uniform vec4 fillColor;
  out vec4 outputColor;

  void main() {
	outputColor = fillColor;
  }`,i=e.createShader(e.FRAGMENT_SHADER);if(!i)throw new Error("Failed to create fragment shader");if(e.shaderSource(i,r),e.compileShader(i),!e.getShaderParameter(i,e.COMPILE_STATUS))throw new Error("Failed to compile fragment shader");const o=e.createProgram();if(!o)throw new Error("Failed to create program");if(e.attachShader(o,s),e.attachShader(o,i),e.linkProgram(o),!e.getProgramParameter(o,e.LINK_STATUS))throw new Error("Failed to link program");e.useProgram(o);const a=e.getAttribLocation(o,"shapeVertexPosition");if(a<0)throw new Error("Failed to get shapeVertexPosition attribute location");e.enableVertexAttribArray(a);const c=e.getUniformLocation(o,"canvasPageBounds"),l=e.getUniformLocation(o,"fillColor");if(!e.createBuffer())throw new Error("Failed to create buffer");if(!e.createBuffer())throw new Error("Failed to create buffer");return{context:e,selectedShapes:Kl(e,1024),unselectedShapes:Kl(e,4096),viewport:Kl(e,mE),collaborators:Kl(e,1024),prepareTriangles(p,f){e.bindBuffer(e.ARRAY_BUFFER,p.buffer),e.bufferData(e.ARRAY_BUFFER,p.vertices,e.STATIC_DRAW,0,f),e.enableVertexAttribArray(a),e.vertexAttribPointer(a,2,e.FLOAT,!1,0,0)},drawTrianglesTransparently(p){e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.drawArrays(e.TRIANGLES,0,p/2),e.disable(e.BLEND)},drawTriangles(p){e.drawArrays(e.TRIANGLES,0,p/2)},setFillColor(p){e.uniform4fv(l,p)},setCanvasPageBounds(p){e.uniform4fv(c,p)}}}function Kl(t,e){const n=t.createBuffer();if(!n)throw new Error("Failed to create buffer");return{buffer:n,vertices:new Float32Array(e)}}function _v(t,e,n){let s=t.vertices.length;for(;s<e+n.length;)s*=2;if(s!=t.vertices.length){const r=new Float32Array(s);r.set(t.vertices),t.vertices=r}t.vertices.set(n,e)}var Cz=Object.create,yE=Object.defineProperty,Tz=Object.getOwnPropertyDescriptor,Ez=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),SE=t=>{throw TypeError(t)},xE=(t,e,n)=>e in t?yE(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,kz=t=>[,,,Cz(null)],bE=["class","method","getter","setter","accessor","field","value","get","set"],wE=t=>t!==void 0&&typeof t!="function"?SE("Function expected"):t,Az=(t,e,n,s,r)=>({kind:bE[t],name:e,metadata:s,addInitializer:i=>n._?SE("Already initialized"):r.push(wE(i||null))}),Mz=(t,e)=>xE(e,Ez("metadata"),t[3]),jz=(t,e,n,s)=>{for(var r=0,i=t[e>>1],o=i&&i.length;r<o;r++)i[r].call(n);return s},_r=(t,e,n,s,r,i)=>{for(var o,a,c,l,u=e&7,d=!1,p=!1,f=2,g=bE[u+5],x=t[f]||(t[f]=[]),y=(r=r.prototype,Tz(r,n)),m=s.length-1;m>=0;m--)c=Az(u,n,a={},t[3],x),c.static=d,c.private=p,l=c.access={has:S=>n in S},l.get=S=>S[n],o=(0,s[m])(y[g],c),a._=1,wE(o)&&(y[g]=o);return y&&yE(r,n,y),r},Wr=(t,e,n)=>xE(t,typeof e!="symbol"?e+"":e,n),vE,PE,IE,_E,CE,TE,EE,kE,AE,ME,Cs;ME=[rs],AE=[K],kE=[K],EE=[K],TE=[K],CE=[K],_E=[K],IE=[K],PE=[K],vE=[rs];class Ns{constructor(e,n,s){this.editor=e,this.elem=n,this.container=s,jz(Cs,5,this),Wr(this,"disposables",[]),Wr(this,"gl"),Wr(this,"shapeGeometryCache"),Wr(this,"colors"),Wr(this,"id",Ge()),Wr(this,"canvasBoundingClientRect",je("canvasBoundingClientRect",new X)),Wr(this,"originPagePoint",new b),Wr(this,"originPageCenter",new b),Wr(this,"isInViewport",!1),this.gl=_z(n),this.shapeGeometryCache=e.store.createComputedCache("webgl-geometry",r=>{const i=e.getShapeMaskedPageBounds(r.id);if(!i)return null;const o=new Float32Array(12);return Lo(o,0,i.x,i.y,i.w,i.h),o}),this.colors=this._getColors(),this.disposables.push(this._listenForCanvasResize(),is("minimap render",this.render))}close(){return this.disposables.forEach(e=>e())}_getColors(){const e=getComputedStyle(this.editor.getContainer());return{shapeFill:Ba(e.getPropertyValue("--tl-color-text-3").trim()),selectFill:Ba(e.getPropertyValue("--tl-color-selected").trim()),viewportFill:Ba(e.getPropertyValue("--tl-color-muted-1").trim()),background:Ba(e.getPropertyValue("--tl-color-low").trim())}}updateColors(){this.colors=this._getColors()}getDpr(){return this.editor.getInstanceState().devicePixelRatio}getContentPageBounds(){const e=this.editor.getViewportPageBounds(),n=this.editor.getCurrentPageBounds();return n?X.Expand(n,e):e}getContentScreenBounds(){const e=this.getContentPageBounds(),n=this.editor.pageToScreen(e.point),s=this.editor.pageToScreen(new b(e.maxX,e.maxY));return new X(n.x,n.y,s.x-n.x,s.y-n.y)}_getCanvasBoundingRect(){const{x:e,y:n,width:s,height:r}=this.elem.getBoundingClientRect();return new X(e,n,s,r)}getCanvasScreenBounds(){return this.canvasBoundingClientRect.get()}_listenForCanvasResize(){const e=new ResizeObserver(()=>{const n=this._getCanvasBoundingRect();this.canvasBoundingClientRect.set(n)});return e.observe(this.elem),e.observe(this.container),()=>e.disconnect()}getCanvasSize(){const e=this.canvasBoundingClientRect.get(),n=this.getDpr();return new b(e.width*n,e.height*n)}getCanvasClientPosition(){return this.canvasBoundingClientRect.get().point}getCanvasPageBounds(){const e=this.getCanvasScreenBounds(),n=this.getContentPageBounds(),s=e.width/e.height;let r=n.width,i=r/s;i<n.height&&(i=n.height,r=i*s);const o=new X(0,0,r,i);return o.center=n.center,o}getZoom(){return this.getCanvasPageBounds().width/this.getCanvasScreenBounds().width}getCanvasPageBoundsArray(){const{x:e,y:n,w:s,h:r}=this.getCanvasPageBounds();return new Float32Array([e,n,s,r])}getMinimapPagePoint(e,n){const s=this.getCanvasPageBounds(),r=this.getCanvasScreenBounds();let i=e-r.x,o=n-r.y;return i*=s.width/r.width,o*=s.height/r.height,i+=s.minX,o+=s.minY,new b(i,o,1)}minimapScreenPointToPagePoint(e,n,s=!1,r=!1){const{editor:i}=this,o=i.getViewportPageBounds();let{x:a,y:c}=this.getMinimapPagePoint(e,n);if(r){const l=this.editor.getCurrentPageBounds()??new X,u=l.minX-o.width/2,d=l.maxX+o.width/2,p=l.minY-o.height/2,f=l.maxY+o.height/2,g=Math.max(0,u+o.width-a),x=Math.max(0,-(d-o.width-a)),y=Math.max(0,p+o.height-c),m=Math.max(0,-(f-o.height-c));a+=(g-x)/2,c+=(y-m)/2,a=Ce(a,u,d),c=Ce(c,p,f)}if(s){const{originPagePoint:l}=this,u=Math.abs(a-l.x),d=Math.abs(c-l.y);u>d?c=l.y:a=l.x}return new b(a,c)}render(){const e=this.gl.context,n=this.getCanvasSize();this.gl.setCanvasPageBounds(this.getCanvasPageBoundsArray()),this.elem.width=n.x,this.elem.height=n.y,e.viewport(0,0,n.x,n.y),e.clearColor(this.colors.background[0],this.colors.background[1],this.colors.background[2],1),e.clear(e.COLOR_BUFFER_BIT);const s=new Set(this.editor.getSelectedShapeIds()),r=this.colors;let i=0,o=0;const a=this.editor.getCurrentPageShapeIdsSorted();for(let c=0,l=a.length;c<l;c++){const u=a[c],d=this.shapeGeometryCache.get(u);if(!d)continue;const p=d.length,f=this.editor.getShape(u);f&&this.editor.getShapeUtil(f.type).hideInMinimap?.(f)||(s.has(u)?(_v(this.gl.selectedShapes,i,d),i+=p):(_v(this.gl.unselectedShapes,o,d),o+=p))}this.drawShapes(this.gl.unselectedShapes,o,r.shapeFill),this.drawShapes(this.gl.selectedShapes,i,r.selectFill),this.drawViewport(),this.drawCollaborators()}drawShapes(e,n,s){this.gl.prepareTriangles(e,n),this.gl.setFillColor(s),this.gl.drawTriangles(n)}drawViewport(){const e=this.editor.getViewportPageBounds(),n=Iz(this.gl.viewport.vertices,e,4*this.getZoom());this.gl.prepareTriangles(this.gl.viewport,n),this.gl.setFillColor(this.colors.viewportFill),this.gl.drawTrianglesTransparently(n),qe.isSafari&&(this.gl.drawTrianglesTransparently(n),this.gl.drawTrianglesTransparently(n),this.gl.drawTrianglesTransparently(n))}drawCollaborators(){const e=this.editor.getCollaboratorsOnCurrentPage();if(!e.length)return;const n=20,s=n*6,r=s*e.length;this.gl.collaborators.vertices.length<r&&(this.gl.collaborators.vertices=new Float32Array(r));const i=this.gl.collaborators.vertices;let o=0;const a=this.getZoom();for(const{cursor:c}of e)c&&(Oo(i,{center:b.From(c),radius:3*a,offset:o,numArcSegments:n}),o+=s);this.gl.prepareTriangles(this.gl.collaborators,r),o=0;for(const{color:c}of e)this.gl.setFillColor(Ba(c)),this.gl.context.drawArrays(this.gl.context.TRIANGLES,o/2,s/2),o+=s}}Cs=kz();_r(Cs,1,"close",ME,Ns);_r(Cs,1,"getDpr",AE,Ns);_r(Cs,1,"getContentPageBounds",kE,Ns);_r(Cs,1,"getContentScreenBounds",EE,Ns);_r(Cs,1,"getCanvasSize",TE,Ns);_r(Cs,1,"getCanvasClientPosition",CE,Ns);_r(Cs,1,"getCanvasPageBounds",_E,Ns);_r(Cs,1,"getZoom",IE,Ns);_r(Cs,1,"getCanvasPageBoundsArray",PE,Ns);_r(Cs,1,"render",vE,Ns);Mz(Cs,Ns);function Dz(){const t=z(),e=Lt(),n=ae(),s=v.useRef(null),r=v.useRef(!1),i=v.useRef(void 0);v.useEffect(()=>{try{const d=new Ns(t,s.current,e);return i.current=d,i.current.close}catch(d){t.annotateError(d,{origin:"minimap",willCrashApp:!1}),t.timers.setTimeout(()=>{throw d})}},[t,e]);const o=v.useCallback(d=>{if(!t.getCurrentPageShapeIds().size||!i.current)return;const p=i.current.minimapScreenPointToPagePoint(d.clientX,d.clientY,!1,!1),f=i.current.minimapScreenPointToPagePoint(d.clientX,d.clientY,!1,!0);i.current.originPagePoint.setTo(f),i.current.originPageCenter.setTo(t.getViewportPageBounds().center),t.centerOnPoint(p,{animation:{duration:t.options.animationMediumMs}})},[t]),a=v.useCallback(d=>{if(!i.current)return;const p=d.currentTarget;if(Gc(p,d),!t.getCurrentPageShapeIds().size)return;r.current=!0,i.current.isInViewport=!1;const f=i.current.minimapScreenPointToPagePoint(d.clientX,d.clientY,!1,!1),g=t.getViewportPageBounds(),x=i.current.getContentPageBounds();if(new X(x.x-g.width/2,x.y-g.height/2,x.width+g.width,x.height+g.height).containsPoint(f)&&!g.containsPoint(f)){i.current.isInViewport=g.containsPoint(f);const S=b.Sub(g.center,g.point),w=b.Add(f,S);i.current.originPagePoint.setTo(w),i.current.originPageCenter.setTo(f),t.centerOnPoint(f,{animation:{duration:t.options.animationMediumMs}})}else{const S=i.current.minimapScreenPointToPagePoint(d.clientX,d.clientY,!1,!0);i.current.isInViewport=g.containsPoint(S),i.current.originPagePoint.setTo(S),i.current.originPageCenter.setTo(g.center)}function m(S){p&&Yc(p,S),r.current=!1,document.body.removeEventListener("pointerup",m)}document.body.addEventListener("pointerup",m)},[t]),c=v.useCallback(d=>{if(!i.current)return;const p=i.current.minimapScreenPointToPagePoint(d.clientX,d.clientY,d.shiftKey,!0);if(r.current){if(i.current.isInViewport){const y=i.current.originPagePoint.clone().sub(i.current.originPageCenter);t.centerOnPoint(b.Sub(p,y));return}t.centerOnPoint(p)}const f=i.current.getMinimapPagePoint(d.clientX,d.clientY),g=t.pageToScreen(f),x={type:"pointer",target:"canvas",name:"pointer_move",...cn(t,d),point:g,isPen:t.getInstanceState().isPenMode};t.dispatch(x)},[t]),l=v.useCallback(d=>{const p=IT(d);t.dispatch({type:"wheel",name:"wheel",delta:p,point:new b(d.clientX,d.clientY),shiftKey:d.shiftKey,altKey:d.altKey,ctrlKey:d.metaKey||d.ctrlKey,metaKey:d.metaKey,accelKey:At(d)})},[t]),u=wu();return v.useEffect(()=>{t.timers.setTimeout(()=>{i.current?.updateColors(),i.current?.render()})},[u,t]),h.jsx("div",{className:"tlui-minimap",children:h.jsx("canvas",{role:"img","aria-label":n("navigation-zone.minimap"),"data-testid":"minimap.canvas",ref:s,className:"tlui-minimap__canvas",onDoubleClick:o,onPointerMove:c,onPointerDown:a,onWheelCapture:l})})}function Oz(t,e){const[n,s]=Ye.useState(e);Ye.useLayoutEffect(()=>{const i=gm(t);if(i)try{s(JSON.parse(i))}catch{console.error(`Could not restore value ${t} from local storage.`)}},[t]);const r=Ye.useCallback(i=>{s(o=>{const a=typeof i=="function"?i(o):i;return mm(t,JSON.stringify(a)),a})},[t]);return[n,r]}const Lz=v.memo(function(){const e=Tr(),n=ae(),s=hn(),r=v.useRef(null);Ir(r);const[i,o]=Oz("minimap",!0),a=v.useCallback(()=>{o(u=>!u)},[o]),{ZoomMenu:c,Minimap:l}=Cr();return s<yt.MOBILE?null:h.jsxs("div",{ref:r,className:"tlui-navigation-panel",children:[h.jsx(Wn,{orientation:"horizontal",label:n("navigation-zone.title"),children:c&&s<yt.TABLET?h.jsx(c,{}):h.jsxs(h.Fragment,{children:[!i&&h.jsx(ot,{type:"icon","data-testid":"minimap.zoom-out",title:`${n(jc(e["zoom-out"].label))} ${Fd(e["zoom-out"].kbd)}`,onClick:()=>e["zoom-out"].onSelect("navigation-zone"),children:h.jsx(Se,{small:!0,icon:"minus"})}),c&&h.jsx(c,{},"zoom-menu"),!i&&h.jsx(ot,{type:"icon","data-testid":"minimap.zoom-in",title:`${n(jc(e["zoom-in"].label))} ${Fd(e["zoom-in"].kbd)}`,onClick:()=>e["zoom-in"].onSelect("navigation-zone"),children:h.jsx(Se,{small:!0,icon:"plus"})}),l&&h.jsx(ot,{type:"icon","data-testid":"minimap.toggle-button",title:n("navigation-zone.toggle-minimap"),onClick:a,children:h.jsx(Se,{small:!0,icon:i?"chevron-right":"chevron-left"})})]})}),l&&s>=yt.TABLET&&!i&&h.jsx(l,{})]})}),Rz=function({name:e,id:n,isCurrentPage:s,onCancel:r,onComplete:i}){const o=z(),a=St(),c=v.useRef(null),l=v.useRef(null),u=v.useCallback(()=>{l.current=o.markHistoryStoppingPoint("rename page")},[o]),d=v.useCallback(f=>{o.renamePage(n,f||"New Page"),a("rename-page",{source:"page-menu"})},[o,n,a]),p=v.useCallback(()=>{l.current&&o.bailToMark(l.current),r()},[o,r]);return h.jsx(ba,{className:"tlui-page-menu__item__input",ref:f=>{c.current=f},defaultValue:e,onValueChange:d,onComplete:i,onCancel:p,onFocus:u,shouldManuallyMaintainScrollPositionWhenFocused:!0,autoFocus:s,autoSelect:!0})},Gg=(t,e,n,s,r)=>{let i;const o=t.getPages(),a=n>s?o[s-1]:o[s],c=n>s?o[s]:o[s+1];a&&!c?i=Ls(a.index):!a&&c?i=qA(o[0].index):i=Qo(a.index,c.index),i!==o[n].index&&(t.markHistoryStoppingPoint("moving page"),t.updatePage({id:e,index:i}),r("move-page",{source:"page-menu"}))},Cv=Ot(function({index:e,listSize:n,item:s,onRename:r}){const i=z(),o=ae(),a=i.getPages(),c=St(),l=v.useCallback(()=>{i.markHistoryStoppingPoint("creating page");const f=zn.createId();i.duplicatePage(s.id,f),c("duplicate-page",{source:"page-menu"})},[i,s,c]),u=v.useCallback(()=>{Gg(i,s.id,e,e-1,c)},[i,s,e,c]),d=v.useCallback(()=>{Gg(i,s.id,e,e+1,c)},[i,s,e,c]),p=v.useCallback(()=>{i.markHistoryStoppingPoint("deleting page"),i.deletePage(s.id),c("delete-page",{source:"page-menu"})},[i,s,c]);return h.jsxs(Du,{id:`page item submenu ${e}`,children:[h.jsx(Ou,{children:h.jsx(Re,{type:"icon",title:o("page-menu.submenu.title"),children:h.jsx(Se,{icon:"dots-vertical",small:!0})})}),h.jsx(Lu,{alignOffset:0,side:"right",sideOffset:-4,children:h.jsxs(Kn,{type:"menu",sourceId:"page-menu",children:[h.jsxs(Ae,{id:"modify",children:[r&&h.jsx($e,{id:"rename",label:"page-menu.submenu.rename",onSelect:r}),h.jsx($e,{id:"duplicate",label:"page-menu.submenu.duplicate-page",onSelect:l,disabled:a.length>=i.options.maxPages}),e>0&&h.jsx($e,{id:"move-up",onSelect:u,label:"page-menu.submenu.move-up"}),e<n-1&&h.jsx($e,{id:"move-down",label:"page-menu.submenu.move-down",onSelect:d})]}),n>1&&h.jsx(Ae,{id:"delete",children:h.jsx($e,{id:"delete",onSelect:p,label:"page-menu.submenu.delete"})})]})})]})}),Fz=v.memo(function(){const e=z(),n=St(),s=ae(),r=hn(),i=v.useCallback(()=>m(!1),[]),[o,a]=ii("page-menu",i),c=36,l=v.useRef(null),u=$("pages",()=>e.getPages(),[e]),d=$("currentPage",()=>e.getCurrentPage(),[e]),p=$("currentPageId",()=>e.getCurrentPageId(),[e]),f=_s(),g=$("maxPageCountReached",()=>e.getPages().length>=e.options.maxPages,[e]),x=$("isCoarsePointer",()=>e.getInstanceState().isCoarsePointer,[e]),[y,m]=v.useState(!1);v.useEffect(function(){function L(){y||document.activeElement===document.body&&e.menus.clearOpenMenus()}return document.addEventListener("keydown",L,{passive:!0}),()=>{document.removeEventListener("keydown",L)}},[e,y]);const S=v.useCallback(()=>{f||m(M=>!M)},[f]),w=v.useRef({isPointing:!1,status:"idle",pointing:null,startY:0,startIndex:0,dragIndex:0}),[P,_]=v.useState(Object.fromEntries(u.map((M,L)=>[M.id,{y:L*c,offsetY:0,isSelected:!1}])));v.useLayoutEffect(()=>{_(Object.fromEntries(u.map((M,L)=>[M.id,{y:L*c,offsetY:0,isSelected:!1}])))},[c,u]),v.useEffect(()=>{o&&e.timers.requestAnimationFrame(()=>{const M=document.querySelector(`[data-pageid="${p}"]`);if(M){M.querySelector("button")?.focus();const L=l.current;if(!L)return;const U=M.offsetTop,V=L.scrollTop;U<V&&L.scrollTo({top:U});const J=U+c,Z=L.scrollTop+L.offsetHeight;J>Z&&L.scrollTo({top:J-L.offsetHeight})}})},[c,p,o,e]);const I=v.useCallback(M=>{const{clientY:L,currentTarget:U}=M,{dataset:{id:V,index:J}}=U;if(!V||!J)return;const Z=w.current;Gc(M.currentTarget,M),Z.status="pointing",Z.pointing={id:V,index:+J};const Y=P[V].y;Z.startY=L,Z.startIndex=Math.max(0,Math.min(Math.round(Y/c),u.length-1))},[c,u.length,P]),C=v.useCallback(M=>{const L=w.current;if(L.status==="pointing"){const{clientY:U}=M,V=U-L.startY;Math.abs(V)>5&&(L.status="dragging")}if(L.status==="dragging"){const{clientY:U}=M,V=U-L.startY,J=P[L.pointing.id],{startIndex:Z,pointing:Q}=L,Y=J.y+V,Ie=Math.max(0,Math.min(Math.round(Y/c),u.length-1)),be={...P};if(be[Q.id]={y:J.y,offsetY:V,isSelected:!0},Ie!==L.dragIndex){L.dragIndex=Ie;for(let me=0;me<u.length;me++){const ne=u[me];if(ne.id===L.pointing.id)continue;let{y:Me}=be[ne.id];Ie===Z?Me=me*c:Ie<Z?Ie<=me&&me<Z?Me=(me+1)*c:Me=me*c:Ie>Z&&(Ie>=me&&me>Z?Me=(me-1)*c:Me=me*c),Me!==be[ne.id].y&&(be[ne.id]={y:Me,offsetY:0,isSelected:!0})}}_(be)}},[c,u,P]),E=v.useCallback(M=>{const L=w.current;if(L.status==="dragging"){const{id:U,index:V}=L.pointing;Gg(e,U,V,L.dragIndex,n)}Yc(M.currentTarget,M),L.status="idle"},[e,n]),O=v.useCallback(M=>{const L=w.current;M.key==="Escape"&&(L.status==="dragging"&&_(Object.fromEntries(u.map((U,V)=>[U.id,{y:V*c,offsetY:0,isSelected:!1}]))),L.status="idle")},[c,u]),k=v.useCallback(()=>{f||(e.run(()=>{e.markHistoryStoppingPoint("creating page");const M=zn.createId();e.createPage({name:s("page-menu.new-page-initial-name"),id:M}),e.setCurrentPage(M),m(!0),e.timers.requestAnimationFrame(()=>{const L=document.querySelector(`[data-pageid="${M}"]`);L&&L.querySelector("button")?.focus()})}),n("new-page",{source:"page-menu"}))},[e,s,f,n]),T=v.useCallback(M=>{e.setCurrentPage(M),n("change-page",{source:"page-menu"})},[e,n]),D=v.useCallback((M,L)=>{e.renamePage(M,L),n("rename-page",{source:"page-menu"})},[e,n]),R=r<yt.TABLET_SM&&x;return h.jsxs(io,{id:"pages",onOpenChange:a,open:o,children:[h.jsx(oo,{"data-testid":"main.page-menu",children:h.jsxs(Re,{type:"menu",title:d.name,"data-testid":"page-menu.button",className:"tlui-page-menu__trigger",children:[h.jsx("div",{className:"tlui-page-menu__name",children:d.name}),h.jsx(Se,{icon:"chevron-down",small:!0})]})}),h.jsx(ao,{side:"bottom",align:"start",sideOffset:0,disableEscapeKeyDown:y,children:h.jsxs("div",{className:"tlui-page-menu__wrapper",children:[h.jsxs("div",{className:"tlui-page-menu__header",children:[h.jsx("div",{className:"tlui-page-menu__header__title",children:s("page-menu.title")}),!f&&h.jsxs(xo,{children:[h.jsx(Re,{type:"icon","data-testid":"page-menu.edit",title:s(y?"page-menu.edit-done":"page-menu.edit-start"),onClick:S,children:h.jsx(Se,{icon:y?"check":"edit"})}),h.jsx(Re,{type:"icon","data-testid":"page-menu.create",title:s(g?"page-menu.max-page-count-reached":"page-menu.create-new-page"),disabled:g,onClick:k,children:h.jsx(Se,{icon:"plus"})})]})]}),h.jsx("div",{"data-testid":"page-menu.list",className:"tlui-page-menu__list tlui-menu__group",style:{height:c*u.length+4},ref:l,children:u.map((M,L)=>{const U=P[M.id]??{offsetY:0};return y?h.jsxs("div",{"data-testid":"page-menu.item","data-pageid":M.id,className:"tlui-page_menu__item__sortable",style:{zIndex:M.id===d.id?888:L,transform:`translate(0px, ${U.y+U.offsetY}px)`},children:[h.jsx(Re,{type:"icon",tabIndex:-1,className:"tlui-page_menu__item__sortable__handle",onPointerDown:I,onPointerUp:E,onPointerMove:C,onKeyDown:O,"data-id":M.id,"data-index":L,children:h.jsx(Se,{icon:"drag-handle-dots"})}),R?h.jsxs(Re,{type:"normal",className:"tlui-page-menu__item__button",onClick:()=>{const V=window.prompt(s("action.rename"),M.name);V&&V!==M.name&&D(M.id,V)},onDoubleClick:S,children:[h.jsx(qg,{checked:M.id===d.id}),h.jsx(Mt,{children:M.name})]}):h.jsx("div",{className:"tlui-page_menu__item__sortable__title",style:{height:c},children:h.jsx(Rz,{id:M.id,name:M.name,isCurrentPage:M.id===d.id,onComplete:()=>{m(!1)},onCancel:()=>{m(!1)}})}),!f&&h.jsx("div",{className:"tlui-page_menu__item__submenu","data-isediting":y,children:h.jsx(Cv,{index:L,item:M,listSize:u.length})})]},M.id+"_editing"):h.jsxs("div",{"data-pageid":M.id,"data-testid":"page-menu.item",className:"tlui-page-menu__item",children:[h.jsxs(Re,{type:"normal",className:"tlui-page-menu__item__button",onClick:()=>T(M.id),onDoubleClick:S,title:s("page-menu.go-to-page"),onKeyDown:V=>{V.key==="Enter"&&M.id===d.id&&(S(),e.markEventAsHandled(V))},children:[h.jsx(qg,{checked:M.id===d.id}),h.jsx(Mt,{children:M.name})]}),!f&&h.jsx("div",{className:"tlui-page_menu__item__submenu",children:h.jsx(Cv,{index:L,item:M,listSize:u.length,onRename:()=>{if(R){const V=window.prompt(s("action.rename"),M.name);V&&V!==M.name&&D(M.id,V)}else m(!0),p!==M.id&&T(M.id)}})})]},M.id)})})]})})]})});function Bz(){const t=z(),e=_s(),n=$("should display quick actions",()=>t.isInAny("select","hand","zoom"),[t]);if(!(e&&!n))return h.jsxs(h.Fragment,{children:[h.jsx($z,{}),h.jsx(zz,{})]})}function zz(){const t=Yn(1),e=ai(),n=t&&e;return h.jsxs(h.Fragment,{children:[h.jsx(W,{actionId:"delete",disabled:!n}),h.jsx(W,{actionId:"duplicate",disabled:!n})]})}function $z(){const t=uE(),e=dE();return h.jsxs(h.Fragment,{children:[h.jsx(W,{actionId:"undo",disabled:!t}),h.jsx(W,{actionId:"redo",disabled:!e})]})}const Nz=v.memo(function({children:e}){const n=e??h.jsx(Bz,{});return h.jsx(Kn,{type:"small-icons",sourceId:"quick-actions",children:n})});function Uz(){const t=ae();return h.jsx(rl,{content:t("status.offline"),children:h.jsx("div",{className:"tlui-offline-indicator",children:h.jsx(wr,{icon:"status-offline",label:t("status.offline"),small:!0})})})}function Hz({userId:t}){const e=Pu(t);return e?h.jsx("div",{className:"tlui-people-menu__avatar",style:{backgroundColor:e.color},children:e.userName?.[0]??""},t):null}const Kz=Ot(function({userId:e}){const n=z(),s=ae(),r=St(),i=Pu(e),o=v.useCallback(()=>{n.getInstanceState().followingUserId===e?(n.stopFollowingUser(),r("stop-following",{source:"people-menu"})):(n.startFollowingUser(e),r("start-following",{source:"people-menu"}))},[n,e,r]),a=i?.followingUserId===n.user.getId(),c=n.getInstanceState().followingUserId===e;return i?h.jsxs(xo,{className:"tlui-people-menu__item","data-follow":c||a,children:[h.jsxs(Re,{type:"menu",className:"tlui-people-menu__item__button",onClick:()=>n.zoomToUser(e),onDoubleClick:o,children:[h.jsx(wr,{label:s("people-menu.avatar-color"),icon:"color",color:i.color}),h.jsx("div",{className:"tlui-people-menu__name",children:i.userName?.trim()||s("people-menu.anonymous-user")})]}),h.jsx(Re,{type:"icon",className:"tlui-people-menu__item__follow",title:s(a?"people-menu.leading":c?"people-menu.following":"people-menu.follow"),onClick:o,disabled:a,children:h.jsx(Se,{icon:a?"leading":c?"following":"follow"})})]}):null});function Wz({count:t}){return h.jsx("div",{className:"tlui-people-menu__avatar tlui-people-menu__more",children:Math.abs(t)})}const qz=Ot(function(){const e=z(),n=Lt(),s=ae(),r=St(),i=v.useRef(!1),[o,a]=v.useState(!1),c=v.useCallback(x=>{a(x)},[]),l=e.user.getColor(),u=v.useCallback(x=>{e.user.updateUserPreferences({color:x}),r("set-color",{source:"people-menu"})},[e,r]),{handleButtonClick:d,handleButtonPointerDown:p,handleButtonPointerEnter:f,handleButtonPointerUp:g}=Ye.useMemo(()=>{const x=()=>{i.current=!1,window.removeEventListener("pointerup",x)};return{handleButtonClick:P=>{const{id:_}=P.currentTarget.dataset;_&&l!==_&&u(_)},handleButtonPointerDown:P=>{const{id:_}=P.currentTarget.dataset;_&&(u(_),i.current=!0,window.addEventListener("pointerup",x))},handleButtonPointerEnter:P=>{if(!i.current)return;const{id:_}=P.currentTarget.dataset;_&&u(_)},handleButtonPointerUp:P=>{const{id:_}=P.currentTarget.dataset;_&&u(_)}}},[l,u]);return h.jsxs(am,{onOpenChange:c,open:o,children:[h.jsx(cm,{dir:"ltr",asChild:!0,children:h.jsx(Re,{type:"icon",className:"tlui-people-menu__user__color",style:{color:e.user.getColor()},title:s("people-menu.change-color"),children:h.jsx(Se,{icon:"color"})})}),h.jsx(lm,{container:n,children:h.jsx(dm,{dir:"ltr",className:"tlui-menu tlui-people-menu__user__color-picker",align:"start",side:"left",sideOffset:8,children:h.jsx(Fu,{children:Tg.map(x=>h.jsx(Re,{type:"icon","data-id":x,"data-testid":x,"aria-label":x,isActive:l===x,title:x,style:{color:x},onPointerEnter:f,onPointerDown:p,onPointerUp:g,onClick:d,children:h.jsx(Se,{icon:"color"})},x))})})})]})});function Gz(){const t=z(),e=St(),n=$("userName",()=>t.user.getName(),[]),s=ae(),r=v.useRef(n),i=v.useRef(n),[o,a]=v.useState(!1),c=v.useCallback(()=>{a(p=>!p)},[]),l=v.useCallback(p=>{i.current=p,t.user.updateUserPreferences({name:p})},[t]),u=v.useCallback(()=>{r.current!==i.current&&(e("change-user-name",{source:"people-menu"}),r.current=i.current)},[e]),d=v.useCallback(()=>{a(!1),t.user.updateUserPreferences({name:r.current}),t.menus.clearOpenMenus()},[t]);return h.jsxs("div",{className:"tlui-people-menu__user",children:[h.jsx(qz,{}),o?h.jsx(ba,{className:"tlui-people-menu__user__input",defaultValue:n,onValueChange:l,onComplete:c,onCancel:d,onBlur:u,shouldManuallyMaintainScrollPositionWhenFocused:!0,autoFocus:!0,autoSelect:!0}):h.jsxs(h.Fragment,{children:[h.jsx("div",{className:"tlui-people-menu__user__name",onDoubleClick:()=>{o||a(!0)},children:n||s("people-menu.anonymous-user")}),n?null:h.jsx("div",{className:"tlui-people-menu__user__label",children:s("people-menu.user")})]}),h.jsx(Re,{type:"icon",className:"tlui-people-menu__user__edit","data-testid":"people-menu.change-name",title:s("people-menu.change-name"),onClick:c,children:h.jsx(Se,{icon:o?"check":"edit"})})]})}function Yz({children:t}){const e=ae(),n=Lt(),s=z(),r=TT(),i=$("user",()=>s.user.getColor(),[s]),o=$("user",()=>s.user.getName(),[s]),[a,c]=ii("people menu"),u=hn()<=yt.MOBILE_XS?1:5;return nB()==="offline"?h.jsx(Uz,{}):r.length?h.jsxs(am,{onOpenChange:c,open:a,children:[h.jsx(cm,{dir:"ltr",asChild:!0,children:h.jsx("button",{className:"tlui-people-menu__avatars-button",title:e("people-menu.title"),children:h.jsxs("div",{className:"tlui-people-menu__avatars",children:[r.slice(-u).map(p=>h.jsx(Hz,{userId:p},p)),r.length>0&&h.jsx("div",{className:"tlui-people-menu__avatar",style:{backgroundColor:i},children:o?.[0]??""}),r.length>u&&h.jsx(Wz,{count:r.length-u})]})})}),h.jsx(lm,{container:n,children:h.jsx(dm,{dir:"ltr",className:"tlui-menu",side:"bottom",sideOffset:2,collisionPadding:4,children:h.jsxs("div",{className:"tlui-people-menu__wrapper",children:[h.jsx("div",{className:"tlui-people-menu__section",children:h.jsx(Gz,{})}),r.length>0&&h.jsx("div",{className:"tlui-people-menu__section",children:r.map(p=>h.jsx(Kz,{userId:p},p+"_presence"))}),t]})})})]}):null}function Vz(){return h.jsx("div",{className:"tlui-share-zone",draggable:!1,children:h.jsx(Yz,{})})}const Xz=Object.freeze([Un,so,Ti,br]);function jE(t=Xz){const e=z();return $("getRelevantStyles",()=>{const n=new jg(e.getSharedStyles()),s=!!e.root.getCurrent()?.shapeType,r=e.isIn("select")&&e.getSelectedShapeIds().length>0;if(n.size===0&&e.isIn("select")&&e.getSelectedShapeIds().length===0)for(const i of t)n.applyValue(i,e.getStyleForNextShape(i));return s||r||n.size>0?n:null},[e])}const Ps={color:[{value:"black",icon:"color"},{value:"grey",icon:"color"},{value:"light-violet",icon:"color"},{value:"violet",icon:"color"},{value:"blue",icon:"color"},{value:"light-blue",icon:"color"},{value:"yellow",icon:"color"},{value:"orange",icon:"color"},{value:"green",icon:"color"},{value:"light-green",icon:"color"},{value:"light-red",icon:"color"},{value:"red",icon:"color"}],fill:[{value:"none",icon:"fill-none"},{value:"semi",icon:"fill-semi"},{value:"solid",icon:"fill-solid"},{value:"pattern",icon:"fill-pattern"}],dash:[{value:"draw",icon:"dash-draw"},{value:"dashed",icon:"dash-dashed"},{value:"dotted",icon:"dash-dotted"},{value:"solid",icon:"dash-solid"}],size:[{value:"s",icon:"size-small"},{value:"m",icon:"size-medium"},{value:"l",icon:"size-large"},{value:"xl",icon:"size-extra-large"}],font:[{value:"draw",icon:"font-draw"},{value:"sans",icon:"font-sans"},{value:"serif",icon:"font-serif"},{value:"mono",icon:"font-mono"}],textAlign:[{value:"start",icon:"text-align-left"},{value:"middle",icon:"text-align-center"},{value:"end",icon:"text-align-right"}],horizontalAlign:[{value:"start",icon:"horizontal-align-start"},{value:"middle",icon:"horizontal-align-middle"},{value:"end",icon:"horizontal-align-end"}],verticalAlign:[{value:"start",icon:"vertical-align-start"},{value:"middle",icon:"vertical-align-middle"},{value:"end",icon:"vertical-align-end"}],geo:[{value:"rectangle",icon:"geo-rectangle"},{value:"ellipse",icon:"geo-ellipse"},{value:"triangle",icon:"geo-triangle"},{value:"diamond",icon:"geo-diamond"},{value:"star",icon:"geo-star"},{value:"pentagon",icon:"geo-pentagon"},{value:"hexagon",icon:"geo-hexagon"},{value:"octagon",icon:"geo-octagon"},{value:"rhombus",icon:"geo-rhombus"},{value:"rhombus-2",icon:"geo-rhombus-2"},{value:"oval",icon:"geo-oval"},{value:"trapezoid",icon:"geo-trapezoid"},{value:"arrow-left",icon:"geo-arrow-left"},{value:"arrow-up",icon:"geo-arrow-up"},{value:"arrow-down",icon:"geo-arrow-down"},{value:"arrow-right",icon:"geo-arrow-right"},{value:"cloud",icon:"geo-cloud"},{value:"x-box",icon:"geo-x-box"},{value:"check-box",icon:"geo-check-box"},{value:"heart",icon:"geo-heart"}],arrowKind:[{value:"arc",icon:"arrow-arc"},{value:"elbow",icon:"arrow-elbow"}],arrowheadStart:[{value:"none",icon:"arrowhead-none"},{value:"arrow",icon:"arrowhead-arrow"},{value:"triangle",icon:"arrowhead-triangle"},{value:"square",icon:"arrowhead-square"},{value:"dot",icon:"arrowhead-dot"},{value:"diamond",icon:"arrowhead-diamond"},{value:"inverted",icon:"arrowhead-triangle-inverted"},{value:"bar",icon:"arrowhead-bar"}],arrowheadEnd:[{value:"none",icon:"arrowhead-none"},{value:"arrow",icon:"arrowhead-arrow"},{value:"triangle",icon:"arrowhead-triangle"},{value:"square",icon:"arrowhead-square"},{value:"dot",icon:"arrowhead-dot"},{value:"diamond",icon:"arrowhead-diamond"},{value:"inverted",icon:"arrowhead-triangle-inverted"},{value:"bar",icon:"arrowhead-bar"}],spline:[{value:"line",icon:"spline-line"},{value:"cubic",icon:"spline-cubic"}]},DE=Ye.forwardRef(function({onHistoryMark:e,title:n,min:s,steps:r,value:i,label:o,onValueChange:a,["data-testid"]:c,ariaValueModifier:l=1},u){const d=ae(),[p,f]=v.useState(""),[g,x]=v.useState(-1);v.useEffect(()=>{x(0)},[]);const y=v.useCallback(w=>{a(w[0])},[a]),m=v.useCallback(()=>{My(),e?.("click slider")},[e]);v.useEffect(()=>{const w=Od.setTimeout("set title and label",()=>{f(n+" — "+d(o))},0);return()=>clearTimeout(w)},[o,d,n]);const S=v.useCallback(w=>{w.key==="Tab"&&w.stopPropagation()},[]);return h.jsx("div",{className:"tlui-slider__container",children:h.jsx(rl,{content:p,children:h.jsxs(qk,{"data-testid":c,className:"tlui-slider",dir:"ltr",min:s??0,max:r,step:1,value:i!==null?[i]:void 0,onPointerDown:m,onValueChange:y,onKeyDownCapture:S,onKeyUpCapture:S,children:[h.jsx(Gk,{className:"tlui-slider__track",dir:"ltr",children:i!==null&&h.jsx(Yk,{className:"tlui-slider__range",dir:"ltr"})}),i!==null&&h.jsx(Vk,{"aria-valuemin":(s??0)*l,"aria-valuenow":i*l,"aria-valuemax":r*l,"aria-label":p,className:"tlui-slider__thumb",dir:"ltr",ref:u,tabIndex:g})]})})})});function Us(){return Fi({isDarkMode:wu()})}const OE=v.createContext(null);function Zz({children:t,styles:e}){const n=z(),s=St(),r=v.useCallback(a=>n.markHistoryStoppingPoint(a),[n]),i=$("enhancedA11yMode",()=>n.user.getEnhancedA11yMode(),[n]),o=v.useCallback(function(a,c){n.run(()=>{n.isIn("select")&&n.setStyleForSelectedShapes(a,c),n.setStyleForNextShapes(a,c),n.updateInstanceState({isChangingStyle:!0})}),s("set-style",{source:"style-panel",id:a.id,value:c})},[n,s]);return h.jsx(OE.Provider,{value:{styles:e,enhancedA11yMode:i,onHistoryMark:r,onValueChange:o},children:t})}function En(){const t=v.useContext(OE);if(!t)throw new Error("useStylePanelContext must be used within a StylePanelContextProvider");return t}function Bu({children:t}){return h.jsx("h3",{className:"tlui-style-panel__subheading",children:t})}function Jz(t){const{enhancedA11yMode:e}=En();return h.jsxs(h.Fragment,{children:[e&&h.jsx(Bu,{children:t.title}),h.jsx(Wn,{label:t.title,children:h.jsx(Ry,{...t})})]})}function Qz(t){const e=En(),{uiType:n,items:s,title:r,style:i,value:o,onValueChange:a=e.onValueChange,onHistoryMark:c=e.onHistoryMark}=t,l=Us(),u=z(),d=ae(),p=hn(),f=v.useRef(!1),g=v.useRef(null),{handleButtonClick:x,handleButtonPointerDown:y,handleButtonPointerEnter:m,handleButtonPointerUp:S}=v.useMemo(()=>{const P=()=>{f.current=!1,window.removeEventListener("pointerup",P);const O=g.current;O&&(["TEXTAREA","INPUT"].includes(O.nodeName)||O.isContentEditable)?O.focus():p>=yt.TABLET_SM&&u.getContainer().focus(),g.current=null};return{handleButtonClick:O=>{const{id:k}=O.currentTarget.dataset;o.type==="shared"&&o.value===k||(c?.("point picker item"),a(i,k))},handleButtonPointerDown:O=>{const{id:k}=O.currentTarget.dataset;c?.("point picker item"),a(i,k),f.current=!0,g.current=document.activeElement,window.addEventListener("pointerup",P)},handleButtonPointerEnter:O=>{if(!f.current)return;const{id:k}=O.currentTarget.dataset;a(i,k)},handleButtonPointerUp:O=>{const{id:k}=O.currentTarget.dataset;o.type==="shared"&&o.value===k||a(i,k)}}},[u,p,o,c,a,i]),w=s.length>4?Fu:xo;return h.jsx(gB,{"data-testid":`style.${n}`,type:"single",value:o.type==="shared"?o.value:null,asChild:!0,children:h.jsx(w,{children:s.map(P=>{const _=o.type==="shared"&&o.value===P.value,I=r+" — "+d(`${n}-style.${P.value}`);return h.jsx(mB,{type:"icon","data-id":P.value,"data-testid":`style.${n}.${P.value}`,"aria-label":I+(_?` (${d("style-panel.selected")})`:""),tooltip:h.jsxs(h.Fragment,{children:[h.jsx("div",{children:I}),_?h.jsxs("div",{children:["(",d("style-panel.selected"),")"]}):null]}),value:P.value,"data-state":o.type==="shared"&&o.value===P.value?"on":"off","data-isactive":_,title:I,style:i===Un?{color:Ue(l,P.value,"solid")}:void 0,onPointerEnter:m,onPointerDown:y,onPointerUp:S,onClick:x,children:h.jsx(Se,{icon:P.icon})},P.value)})})})}const al=v.memo(Jz),Ry=v.memo(Qz);function e$(t){const e=ae();return h.jsxs("div",{className:"tlui-style-panel__double-select-picker",children:[h.jsx("div",{title:e(t.label),className:"tlui-style-panel__double-select-picker-label",children:e(t.label)}),h.jsx(Wn,{orientation:"horizontal",label:e(t.label),children:h.jsx(s$,{...t})})]})}function t$(t){const e=En(),{uiTypeA:n,uiTypeB:s,labelA:r,labelB:i,itemsA:o,itemsB:a,styleA:c,styleB:l,valueA:u,valueB:d,onValueChange:p=e.onValueChange}=t,f=z(),g=ae(),[x,y]=v.useState(!1),[m,S]=v.useState(!1),w=v.useMemo(()=>o.find(C=>u.type==="shared"&&u.value===C.value)?.icon??"mixed",[o,u]),P=v.useMemo(()=>a.find(C=>d.type==="shared"&&d.value===C.value)?.icon??"mixed",[a,d]);if(u===void 0&&d===void 0)return null;const _=`style panel ${n} A`,I=`style panel ${s} B`;return h.jsxs(h.Fragment,{children:[h.jsxs(io,{id:_,open:x,onOpenChange:y,children:[h.jsx(oo,{children:h.jsx(ot,{type:"icon","data-testid":`style.${n}`,title:g(r)+" — "+(u===null||u.type==="mixed"?g("style-panel.mixed"):g(`${n}-style.${u.value}`)),children:h.jsx(Se,{icon:w,small:!0,invertIcon:!0})})}),h.jsx(ao,{side:"left",align:"center",sideOffset:80,alignOffset:0,children:h.jsx(Wn,{orientation:"grid",label:g(r),children:h.jsx(Kn,{type:"icons",sourceId:"style-panel",children:o.map(C=>h.jsx(ot,{"data-testid":`style.${n}.${C.value}`,type:"icon",onClick:()=>{p(c,C.value),Ln.deleteOpenMenu(_,f.contextId),y(!1)},title:`${g(r)} — ${g(`${n}-style.${C.value}`)}`,children:h.jsx(Se,{icon:C.icon,invertIcon:!0})},C.value))})})})]}),h.jsxs(io,{id:I,open:m,onOpenChange:S,children:[h.jsx(oo,{children:h.jsx(ot,{type:"icon","data-testid":`style.${s}`,title:g(i)+" — "+(d===null||d.type==="mixed"?g("style-panel.mixed"):g(`${s}-style.${d.value}`)),children:h.jsx(Se,{icon:P,small:!0})})}),h.jsx(ao,{side:"left",align:"center",sideOffset:116,alignOffset:0,children:h.jsx(Wn,{orientation:"grid",label:g(i),children:h.jsx(Kn,{type:"icons",sourceId:"style-panel",children:a.map(C=>h.jsx(ot,{type:"icon",title:`${g(i)} — ${g(`${s}-style.${C.value}`)}`,"data-testid":`style.${s}.${C.value}`,onClick:()=>{p(l,C.value),Ln.deleteOpenMenu(I,f.contextId),S(!1)},children:h.jsx(Se,{icon:C.icon})},C.value))})})})]})]})}const n$=v.memo(e$),s$=v.memo(t$);function r$(t){const e=ae(),n=t.label?e(t.label):e(`style-panel.${t.stylePanelType}`);return h.jsx(Wn,{label:n,children:h.jsx(LE,{...t})})}function i$(t){const e=En(),{id:n,label:s,uiType:r,stylePanelType:i,style:o,items:a,type:c,value:l,onValueChange:u=e.onValueChange}=t,d=ae(),p=z(),[f,g]=v.useState(!1),x=v.useMemo(()=>a.find(P=>l.type==="shared"&&P.value===l.value)?.icon,[a,l]),y=d(`style-panel.${i}`),m=l.type==="mixed"?d("style-panel.mixed"):y+" — "+d(`${r}-style.${l.value}`),S=s?d(s):"",w=`style panel ${n}`;return h.jsxs(io,{id:w,open:f,onOpenChange:g,className:"tlui-style-panel__dropdown-picker",children:[h.jsx(oo,{children:h.jsxs(ot,{type:c,"data-testid":`style.${r}`,"data-direction":"left",title:m,children:[S&&h.jsx(Mt,{children:S}),h.jsx(Se,{icon:x??"mixed"})]})}),h.jsx(ao,{side:"left",align:"center",children:h.jsx(Wn,{orientation:a.length>4?"grid":"horizontal",label:S,children:h.jsx(Kn,{type:"icons",sourceId:"style-panel",children:a.map(P=>h.jsx(ot,{type:"icon","data-testid":`style.${r}.${P.value}`,title:y+" — "+d(`${r}-style.${P.value}`),isActive:x===P.icon,onClick:()=>{e.onHistoryMark("select style dropdown item"),u(o,P.value),Ln.deleteOpenMenu(w,p.contextId),g(!1)},children:h.jsx(Se,{icon:P.icon})},P.value))})})})]})}const Fy=v.memo(r$),LE=v.memo(i$);function o$(){return h.jsxs(h.Fragment,{children:[h.jsxs(Wl,{children:[h.jsx(a$,{}),h.jsx(c$,{})]}),h.jsxs(Wl,{children:[h.jsx(l$,{}),h.jsx(d$,{}),h.jsx(u$,{})]}),h.jsxs(Wl,{children:[h.jsx(h$,{}),h.jsx(p$,{}),h.jsx(f$,{})]}),h.jsxs(Wl,{children:[h.jsx(g$,{}),h.jsx(m$,{}),h.jsx(y$,{}),h.jsx(S$,{})]})]})}function Wl({children:t}){return h.jsx("div",{className:"tlui-style-panel__section",children:t})}function a$(){const{styles:t}=En(),e=ae(),n=t.get(Un);return n===void 0?null:h.jsx(al,{title:e("style-panel.color"),uiType:"color",style:Un,items:Ps.color,value:n})}const za=[.1,.25,.5,.75,1];function c$(){const t=z(),{onHistoryMark:e,enhancedA11yMode:n}=En(),s=$("opacity",()=>t.getSharedOpacity(),[t]),r=St(),i=ae(),o=Ye.useCallback(c=>{const l=za[c];t.run(()=>{t.isIn("select")&&t.setOpacityForSelectedShapes(l),t.setOpacityForNextShapes(l),t.updateInstanceState({isChangingStyle:!0})}),r("set-style",{source:"style-panel",id:"opacity",value:c})},[t,r]);if(s===void 0)return null;const a=s.type==="mixed"?-1:za.indexOf(m0(za,c=>Math.abs(c-s.value)));return h.jsxs(h.Fragment,{children:[n&&h.jsx(Bu,{children:i("style-panel.opacity")}),h.jsx(DE,{"data-testid":"style.opacity",value:a>=0?a:za.length-1,label:s.type==="mixed"?"style-panel.mixed":`opacity-style.${s.value}`,onValueChange:o,steps:za.length-1,title:i("style-panel.opacity"),onHistoryMark:e,ariaValueModifier:25})]})}function l$(){const{styles:t}=En(),e=ae(),n=t.get(Ti);return n===void 0?null:h.jsx(al,{title:e("style-panel.fill"),uiType:"fill",style:Ti,items:Ps.fill,value:n})}function d$(){const{styles:t}=En(),e=ae(),n=t.get(so);return n===void 0?null:h.jsx(al,{title:e("style-panel.dash"),uiType:"dash",style:so,items:Ps.dash,value:n})}function u$(){const t=z(),{styles:e,onValueChange:n}=En(),s=ae(),r=e.get(br);return r===void 0?null:h.jsx(al,{title:s("style-panel.size"),uiType:"size",style:br,items:Ps.size,value:r,onValueChange:(i,o)=>{n(i,o);const a=t.getSelectedShapeIds();a.length>0&&Qe(t,a)}})}function h$(){const{styles:t}=En(),e=ae(),n=t.get(Ei);return n===void 0?null:h.jsx(al,{title:e("style-panel.font"),uiType:"font",style:Ei,items:Ps.font,value:n})}function p$(){const{styles:t,enhancedA11yMode:e}=En(),n=ae(),s=t.get(_g);if(s===void 0)return null;const r=n("style-panel.align");return h.jsxs(h.Fragment,{children:[e&&h.jsx(Bu,{children:r}),h.jsxs(Wn,{orientation:"horizontal",label:r,children:[h.jsx(Ry,{title:r,uiType:"align",style:_g,items:Ps.textAlign,value:s}),h.jsx(ot,{type:"icon",title:n("style-panel.vertical-align"),"data-testid":"vertical-align",disabled:!0,children:h.jsx(Se,{icon:"vertical-align-middle"})})]})]})}function f$(){const{styles:t,enhancedA11yMode:e}=En(),n=ae(),s=t.get(Td),r=t.get(Ed);if(s===void 0)return null;const i=n("style-panel.label-align");return h.jsxs(h.Fragment,{children:[e&&h.jsx(Bu,{children:i}),h.jsxs(Wn,{orientation:"horizontal",label:i,children:[h.jsx(Ry,{title:i,uiType:"align",style:Td,items:Ps.horizontalAlign,value:s}),r===void 0?h.jsx(ot,{type:"icon",title:n("style-panel.vertical-align"),"data-testid":"vertical-align",disabled:!0,children:h.jsx(Se,{icon:"vertical-align-middle"})}):h.jsx(LE,{type:"icon",id:"geo-vertical-alignment",uiType:"verticalAlign",stylePanelType:"vertical-align",style:Ed,items:Ps.verticalAlign,value:r})]})]})}function g$(){const{styles:t}=En(),e=t.get(yr);return e===void 0?null:h.jsx(Fy,{label:"style-panel.geo",type:"menu",id:"geo",uiType:"geo",stylePanelType:"geo",style:yr,items:Ps.geo,value:e})}function m$(){const{styles:t}=En(),e=t.get(_d);return e===void 0?null:h.jsx(Fy,{id:"arrow-kind",type:"menu",label:"style-panel.arrow-kind",uiType:"arrow-kind",stylePanelType:"arrow-kind",style:_d,items:Ps.arrowKind,value:e})}function y$(){const{styles:t}=En(),e=t.get(vg),n=t.get(wg);return e===void 0||n===void 0?null:h.jsx(n$,{label:"style-panel.arrowheads",uiTypeA:"arrowheadStart",styleA:wg,itemsA:Ps.arrowheadStart,valueA:n,uiTypeB:"arrowheadEnd",styleB:vg,itemsB:Ps.arrowheadEnd,valueB:e,labelA:"style-panel.arrowhead-start",labelB:"style-panel.arrowhead-end"})}function S$(){const{styles:t}=En(),e=t.get(Ig);return e===void 0?null:h.jsx(Fy,{type:"menu",id:"spline",uiType:"spline",stylePanelType:"spline",label:"style-panel.spline",style:Ig,items:Ps.spline,value:e})}const x$=v.memo(function({isMobile:e,styles:n,children:s}){const r=z(),i=$("enhancedA11yMode",()=>r.user.getEnhancedA11yMode(),[r]),o=v.useRef(null);Ir(o);const a=v.useCallback(()=>{e||r.updateInstanceState({isChangingStyle:!1})},[r,e]),c=jE();return n===void 0&&(n=c),v.useEffect(()=>{function l(d){d.key==="Escape"&&o.current?.contains(document.activeElement)&&(d.stopPropagation(),r.getContainer().focus())}const u=o.current;return u?.addEventListener("keydown",l,{capture:!0}),()=>{u?.removeEventListener("keydown",l,{capture:!0})}},[r]),n&&h.jsx("div",{ref:o,"data-testid":"style.panel",className:de("tlui-style-panel",{"tlui-style-panel__wrapper":!e}),"data-ismobile":e,"data-enhanced-a11y-mode":i,onPointerLeave:a,children:h.jsx(Zz,{styles:n,children:s??h.jsx(o$,{})})})}),b$=4e3,w$={success:"check-circle",warning:"warning-triangle",error:"cross-circle",info:"info-circle"};function v$({toast:t}){const{removeToast:e}=oi(),n=ae(),s=a=>{a||e(t.id)},r=t.actions&&t.actions.length>0,i=t.icon||t.severity&&w$[t.severity],o=t.iconLabel||(t.severity?n(`toast.${t.severity}`):"");return h.jsxs(Zk,{onOpenChange:s,className:"tlui-toast__container",duration:t.keepOpen?1/0:b$,"data-severity":t.severity,children:[i&&h.jsx("div",{className:"tlui-toast__icon",children:h.jsx(wr,{label:o,icon:i})}),h.jsxs("div",{className:"tlui-toast__main","data-title":!!t.title,"data-description":!!t.description,"data-actions":!!t.actions,children:[h.jsxs("div",{className:"tlui-toast__content",children:[t.title&&h.jsx(Jk,{className:"tlui-toast__title",children:t.title}),t.description&&h.jsx(Qk,{className:"tlui-toast__description",children:t.description})]}),t.actions&&h.jsxs("div",{className:"tlui-toast__actions",children:[t.actions.map((a,c)=>h.jsx(eA,{altText:a.label,asChild:!0,onClick:a.onClick,children:h.jsx(Re,{type:a.type,children:h.jsx(Mt,{children:a.label})})},c)),h.jsx(nS,{asChild:!0,children:h.jsx(Re,{type:"normal",className:"tlui-toast__close",style:{marginLeft:"auto"},children:h.jsx(Mt,{children:t.closeLabel??n("toast.close")})})})]})]}),!r&&h.jsx(nS,{asChild:!0,children:h.jsx(Re,{type:"normal",className:"tlui-toast__close",children:h.jsx(Mt,{children:t.closeLabel??n("toast.close")})})})]})}const P$=v.memo(function(){const{toasts:e}=oi(),n=$("toasts",()=>e.get(),[]);return h.jsxs(h.Fragment,{children:[n.map(s=>h.jsx(v$,{toast:s},s.id)),h.jsx(Xk,{className:"tlui-toast__viewport"})]})}),I$=150,_$=16,C$=16,Tv=16**2,T$=8,gi=16,By=({children:t,className:e,isMousingDown:n,getSelectionBounds:s,changeOnlyWhenYChanges:r=!1,label:i})=>{const o=z(),a=v.useRef(null);Ir(a),m4(a);const{isVisible:c,isInteractive:l,hide:u,show:d,position:p,move:f}=A$(r),g=v.useRef(!1),[x,y]=v.useState(!1),m=Hc("content size update counter",0);v.useEffect(()=>{le(a.current);const w=new ResizeObserver(()=>{m.update(P=>P+1)});return w.observe(a.current),()=>w.disconnect()},[m]),v.useEffect(()=>{let w=m.get();return is("toolbar position",function(){const _=a.current;if(!_)return;const I=m.get();o.getCamera(),m.get();const C=E$(o,_,s);if(!C)g.current&&(g.current=!1,y(!1));else{if(o.getCameraState()==="moving"){const O=a.current;O&&O.style.setProperty("transform",`translate(${C.x}px, ${C.y}px)`)}else{const O=w!==I;f(C.x,C.y,O)}g.current||(g.current=!0,y(!0))}w=I})},[o,s,m,f]);const S=$("camera state",()=>o.getCameraState(),[o]);return v.useEffect(()=>{if(n||!x){u();return}d()},[x,S,n,d,u]),v.useLayoutEffect(()=>{const w=a.current;w&&(w.dataset.visible=`${c}`)},[c,p]),v.useLayoutEffect(()=>{const w=a.current;w&&w.style.setProperty("transform",`translate(${p.x}px, ${p.y}px)`)},[p]),v.useLayoutEffect(()=>{const w=a.current;w&&(w.dataset.interactive=`${l}`)},[l]),h.jsx("div",{ref:a,"data-interactive":!1,"data-visible":!1,"data-testid":"contextual-toolbar",className:de("tlui-contextual-toolbar",e),onPointerDown:o.markEventAsHandled,children:h.jsx(Wn,{orientation:"horizontal",className:"tlui-menu",label:i,tooltipSide:"top",children:t})})};function RE(t){return new X(t.x,t.y,t.width,t.height)}function E$(t,e,n){const s=n()?.clone();if(!s)return;const r=t.getViewportScreenBounds();if(s.x-=r.x,s.y-=r.y,s.midY<gi||s.midY>r.h-gi||s.midX<gi||s.midX>r.w-gi)return;const i=RE(e.getBoundingClientRect());if(!i.width||!i.height)return;const{scrollLeft:o,scrollTop:a}=t.getContainer();let c=s.midX-i.w/2,l=s.y-i.h-T$;return c=Ce(c,gi,r.w-i.w-gi),l=Ce(l,gi,r.h-i.h-gi),c+=o,l+=a,c=Math.round(c),l=Math.round(l),{x:c,y:l}}function k$(t,e,n){return n?b.Sub(e,t).y**2>=Tv:b.Len2(b.Sub(e,t))>=Tv}function A$(t){const e=z(),n=v.useRef({name:"hidden"}),[s,r]=v.useState(!1),[i,o]=v.useState(!1),[a,c]=v.useState({x:-1e3,y:-1e3}),l=v.useRef(new b(-1e3,-1e3)),u=v.useRef(new b(-1e3,-1e3)),d=v.useRef(-1),p=v.useRef(-1),f=v.useCallback((y,m,S=!1)=>{if(u.current.x=y,u.current.y=m,n.current.name==="hidden"||n.current.name==="showing")return;clearTimeout(p.current);const w=()=>{if(n.current.name==="shown"&&k$(u.current,l.current,t)){const{x:P,y:_}=u.current;l.current=new b(P,_),S?nm.flushSync(()=>c({x:P,y:_})):c({x:P,y:_})}};S?w():p.current=e.timers.setTimeout(w,I$)},[e,t]),g=v.useCallback((y=!1)=>{switch(n.current.name){case"showing":{clearTimeout(d.current),n.current={name:"hidden"};break}case"shown":{n.current={name:"hiding"},r(!1),y?(n.current={name:"hidden"},o(!1)):d.current=e.timers.setTimeout(()=>{n.current={name:"hidden"},o(!1)},_$);break}}},[e]),x=v.useCallback(()=>{switch(n.current.name){case"hidden":{n.current={name:"showing"},d.current=e.timers.setTimeout(()=>{const{x:y,y:m}=u.current;l.current=new b(y,m),c({x:y,y:m}),n.current={name:"shown"},o(!0),r(!0)},C$);break}case"hiding":{clearTimeout(d.current),n.current={name:"shown"},r(!0),f(u.current.x,u.current.y);break}}},[e,f]);return{isVisible:i,isInteractive:s,show:x,hide:g,move:f,position:a}}function FE({shapeId:t,onClose:e,source:n}){const s=z(),[r,i]=v.useState(()=>{const g=s.getShape(t);if(!g)return"";if(!("altText"in g.props))throw Error("Shape does not have altText property");return g.props.altText||""}),o=ae(),a=v.useRef(null),c=St(),l=s.getIsReadonly(),u=g=>i(g),d=()=>{c("set-alt-text",{source:n});const g=s.getShape(t);g&&(s.updateShapes([{id:g.id,type:g.type,props:{altText:r}}]),e())},p=()=>d(),f=v.useCallback(()=>e(),[e]);return v.useEffect(()=>{a.current?.select();function g(x){x.key==="Escape"&&(x.stopPropagation(),f())}return document.addEventListener("keydown",g,{capture:!0}),()=>{document.removeEventListener("keydown",g,{capture:!0})}},[f]),h.jsxs(h.Fragment,{children:[h.jsx(ba,{ref:a,className:"tlui-media__toolbar-alt-text-input","data-testid":"media-toolbar.alt-text-input",value:r,placeholder:o("tool.media-alt-text-desc"),"aria-label":o("tool.media-alt-text-desc"),onValueChange:u,onComplete:d,onCancel:f,disabled:l}),!l&&h.jsx(Re,{title:o("tool.media-alt-text-confirm"),"data-testid":"tool.media-alt-text-confirm",type:"icon",onPointerDown:Pe,onClick:p,children:h.jsx(Se,{small:!0,icon:"check"})})]})}const Ev=8;function er(){return{topLeft:{x:0,y:0},bottomRight:{x:1,y:1}}}const M$=["original","square","circle","landscape","portrait","wide"],Yg={original:0,square:1,circle:1,landscape:4/3,portrait:3/4,wide:16/9};function ir(t,e){if(!e)return{w:t.w,h:t.h};const n=t.w/(e.bottomRight.x-e.topLeft.x),s=t.h/(e.bottomRight.y-e.topLeft.y);return{w:n,h:s}}function zu(t){return{width:t.bottomRight.x-t.topLeft.x,height:t.bottomRight.y-t.topLeft.y}}function zy(t){const{width:e,height:n}=zu(t);return{x:t.topLeft.x+e/2,y:t.topLeft.y+n/2}}function $y(t,e,n,s,r){const i=Math.max(0,Math.min(1-n,t-n/2)),o=Math.max(0,Math.min(1-s,e-s/2));return{topLeft:{x:i,y:o},bottomRight:{x:i+n,y:o+s},isCircle:r}}function j$(t,e,n={}){const{handle:s,change:r,crop:i,aspectRatioLocked:o}=e,{w:a,h:c}=e.uncroppedSize,{minWidth:l=Ev,minHeight:u=Ev}=n;if(a<l||c<u||r.x===0&&r.y===0)return;const d=new X(i.topLeft.x*a,i.topLeft.y*c,(i.bottomRight.x-i.topLeft.x)*a,(i.bottomRight.y-i.topLeft.y)*c),p=d.aspectRatio,f=d.clone();if(s==="top_left"||s==="bottom_left"||s==="left")f.x=Ce(f.x+r.x,0,d.maxX-l),f.w=d.maxX-f.x;else if(s==="top_right"||s==="bottom_right"||s==="right"){const y=Ce(f.maxX+r.x,d.x+l,a);f.w=y-f.x}if(s==="top_left"||s==="top_right"||s==="top")f.y=Ce(f.y+r.y,0,d.maxY-u),f.h=d.maxY-f.y;else if(s==="bottom_left"||s==="bottom_right"||s==="bottom"){const y=Ce(f.maxY+r.y,d.y+u,c);f.h=y-f.y}if(o)switch(f.aspectRatio>p?f.h=f.w/p:f.w=f.h*p,s){case"top_left":{f.x=d.maxX-f.w,f.y=d.maxY-f.h,f.x<=0&&(f.x=0,f.w=d.maxX-f.x,f.h=f.w/p,f.y=d.maxY-f.h),f.y<=0&&(f.y=0,f.h=d.maxY-f.y,f.w=f.h*p,f.x=d.maxX-f.w);break}case"top_right":{f.x=d.x,f.y=d.maxY-f.h,f.maxX>=a&&(f.w=a-d.x,f.h=f.w/p,f.y=d.maxY-f.h),f.y<=0&&(f.y=0,f.h=d.maxY-f.y,f.w=f.h*p);break}case"bottom_left":{f.x=d.maxX-f.w,f.y=d.y,f.x<=0&&(f.x=0,f.w=d.maxX-f.x,f.h=f.w/p),f.maxY>=c&&(f.h=c-d.y,f.w=f.h*p,f.x=d.maxX-f.w);break}case"bottom_right":{f.x=d.x,f.y=d.y,f.maxX>=a&&(f.w=a-d.x,f.h=f.w/p),f.maxY>=c&&(f.h=c-d.y,f.w=f.h*p);break}case"top":{if(f.h=d.maxY-f.y,f.w=f.h*p,f.x-=(f.w-d.w)/2,f.x<=0){const m=d.midX;f.w=m*2,f.h=f.w/p,f.x=0}if(f.maxX>=a){const m=a-d.midX;f.w=m*2,f.h=f.w/p,f.x=a-f.w}f.y=d.maxY-f.h;break}case"right":{if(f.w=f.maxX-d.x,f.h=f.w/p,f.y-=(f.h-d.h)/2,f.y<=0){const m=d.midY;f.h=m*2,f.w=f.h*p,f.y=0}if(f.maxY>=c){const m=c-d.midY;f.h=m*2,f.w=f.h*p,f.y=c-f.h}break}case"bottom":{if(f.h=f.maxY-d.y,f.w=f.h*p,f.x-=(f.w-d.w)/2,f.x<=0){const m=d.midX;f.w=m*2,f.h=f.w/p,f.x=0}if(f.maxX>=a){const m=a-d.midX;f.w=m*2,f.h=f.w/p,f.x=a-f.w}break}case"left":{if(f.w=d.maxX-f.x,f.h=f.w/p,f.y-=(f.h-d.h)/2,f.y<=0){const m=d.midY;f.h=m*2,f.w=f.h*p,f.y=0}if(f.maxY>=c){const m=c-d.midY;f.h=m*2,f.w=f.h*p,f.y=c-f.h}f.x=d.maxX-f.w;break}}const g={topLeft:{x:f.x/a,y:f.y/c},bottomRight:{x:f.maxX/a,y:f.maxY/c},isCircle:i.isCircle};if(g.topLeft.x===i.topLeft.x&&g.topLeft.y===i.topLeft.y&&g.bottomRight.x===i.bottomRight.x&&g.bottomRight.y===i.bottomRight.y)return;const x=new b(f.x-i.topLeft.x*a,f.y-i.topLeft.y*c).rot(t.rotation).add(t);return{id:t.id,type:t.type,x:x.x,y:x.y,props:{...t.props,w:f.w,h:f.h,crop:g}}}function D$(t,e,n,s=!0,r=!1){const{w:i,h:o}=ir(t.props,t.props.crop??er()),a=t.props.crop||er(),c=t.x+t.props.w/2,l=t.y+t.props.h/2;let u,d;if(s){const{x,y}=zy(a);u=x,d=y}else u=.5,d=.5;const p=$y(u,d,e,n,r),f=e*i,g=n*o;return{crop:p,w:f,h:g,x:c-f/2,y:l-g/2}}const es=3;function O$(t,e,n){const s=e.props.crop||er(),{width:r,height:i}=zu(s),o=r/i,a=n?1/(1-n):es,c=1+t*(a-1);let l,u;o>1?(l=Math.min(1,1/c),u=l/o):(u=Math.min(1,1/c),l=u*o);const d=D$(e,l,u,!0,s.isCircle),p=Math.min(es,r/l);d.w*=p,d.h*=p;const f=e.x+e.props.w/2,g=e.y+e.props.h/2;return d.x=f-d.w/2,d.y=g-d.h/2,d}function L$(t,e,n){const s=er(),r=t.props.crop||s,i=t.props.w,o=t.props.h,a=e/n;let c=s,l=i,u=o;if(xr(t.props.crop,s))l=i,u=i*n/e;else{const{w:y,h:m}=ir(t.props,t.props.crop||er()),{width:S,height:w}=zu(r),P=S/w,_=y/m;let I,C;const E=zy(r);I=S;const O=a/_/P;C=I*O;const k=es/(es-1);if(O>k){const T=1/es;if(1/C<1/I){const D=C/T;C=C/D,I=I/D}else{const D=I/T;I=I/D,C=C/D}}I=Math.max(0,Math.min(1,I)),C=Math.max(0,Math.min(1,C)),c=$y(E.x,E.y,I,C,r.isCircle)}const p=t.x+i/2,f=t.y+o/2,g=p-l/2,x=f-u/2;return{crop:c,w:l,h:u,x:g,y:x}}function R$(t,e){if(t==="original"){const{w:T,h:D}=ir(e.props,e.props.crop??er()),R=e.x+e.props.w/2,M=e.y+e.props.h/2;return{crop:er(),w:T,h:D,x:R-T/2,y:M-D/2}}const n=Yg[t],s=t==="circle",{w:r,h:i}=ir(e.props,e.props.crop||er()),o=r/i,a=e.props.crop||er(),{width:c,height:l}=zu(a),u=zy(a),d=Math.min(1/c,1/l);let p,f;if(o===0||!Number.isFinite(o)||n===0)p=1,f=1;else{const T=c*r,D=l*i,R=Math.max(T,D),M=T>=D;let L,U;M?(L=R,U=L/n):(U=R,L=U*n),p=L/r,f=U/i,p>1&&(p=1,f=o/n),f>1&&(f=1,p=n/o),p=Math.max(0,Math.min(1,p)),f=Math.max(0,Math.min(1,f))}const g=Math.min(1/p,1/f);p*=g/d,f*=g/d,p=Math.max(0,Math.min(1,p)),f=Math.max(0,Math.min(1,f));const x=$y(u.x,u.y,p,f,s),y=x.bottomRight.x-x.topLeft.x,m=x.bottomRight.y-x.topLeft.y,S=y*r,w=m*i;let P=1;c>0?P=e.props.w/(c*r):l>0&&(P=e.props.h/(l*i));const _=S*P,I=w*P,C=e.x+e.props.w/2,E=e.y+e.props.h/2,O=C-_/2,k=E-I/2;return{crop:x,w:_,h:I,x:O,y:k}}const F$=Ot(function({imageShapeId:e,isManipulating:n,onEditAltTextStart:s,onManipulatingStart:r,onManipulatingEnd:i}){const o=z(),a=St(),c=ae(),l="image-toolbar",u=v.useRef(null),d=o.getIsReadonly(),p=$("crop",()=>o.getShape(e).props.crop,[o,e]),f=p?Math.min(1-(p.bottomRight.x-p.topLeft.x),1-(p.bottomRight.y-p.topLeft.y)):0,[g,x]=v.useState(p?Math.max(f,1-1/es):es),y=Tr();v.useEffect(()=>{x(p?Math.max(f,1-1/es):es)},[p,f,g]);const m=v.useCallback(T=>o.markHistoryStoppingPoint(T),[o]),S=v.useCallback((T,D)=>{const R=es/(es-1);return Math.pow(T/D,R)*D},[]),w=p&&g?sr(S(f,g),[0,g],[0,100],!0):0,P=v.useCallback(T=>{o.setCurrentTool("select.crop.idle");const D=T/100,R=1-1/es,M=Math.min(R,g??R),L=es/(es-1),U=Math.pow(D,1/L)*M,V=U>=1?1:U/(2*(1-U)),J=o.getShape(e);if(!J)return;const Z=O$(V,J,g);o.updateShape({id:J.id,type:J.type,x:Z.x,y:Z.y,props:{w:Z.w,h:Z.h,crop:Z.crop}}),a("set-style",{source:"image-toolbar",id:"zoom",value:T})},[o,a,e,g]),_=v.useCallback(()=>y["image-replace"].onSelect("image-toolbar"),[y]),I=v.useCallback(()=>y["download-original"].onSelect("image-toolbar"),[y]),C=T=>{const D=o.getShape(e);D&&o.run(()=>{o.setCurrentTool("select.crop.idle");const R=R$(T,D);o.markHistoryStoppingPoint("aspect ratio"),o.updateShape({id:e,type:"image",x:R.x,y:R.y,props:{crop:R.crop,w:R.w,h:R.h}}),Qe(o,[e])})},E=$("altText",()=>o.getShape(e).props.altText,[o,e]),O=$("shapeAspectRatio",()=>{const T=o.getShape(e);return T.props.w/T.props.h},[o,e]),k=!p||xr(p,er());return v.useEffect(()=>{n&&o.timers.setTimeout(()=>u.current?.focus(),0)},[o,n]),v.useEffect(()=>{function T(R){n&&(R.key==="Escape"?(o.cancel(),i()):R.key==="Enter"&&(o.complete(),i()))}const D=u.current;return D&&D.addEventListener("keydown",T),()=>{D&&D.removeEventListener("keydown",T)}},[o,n,i]),n?h.jsxs(h.Fragment,{children:[h.jsx(DE,{ref:u,value:w,label:"tool.image-zoom",onValueChange:P,onHistoryMark:m,min:0,steps:100,"data-testid":"tool.image-zoom",title:c("tool.image-zoom")}),h.jsxs(Du,{id:"image-toolbar-aspect-ratio",children:[h.jsx(Ou,{children:h.jsx(ot,{title:c("tool.aspect-ratio"),type:"icon","data-testid":"tool.image-aspect-ratio",children:h.jsx(Se,{icon:"corners"})})}),h.jsx(Lu,{side:"top",align:"center",children:M$.map(T=>{let D=!1;return k?T==="original"&&(D=!0):T==="circle"?D=!!p.isCircle:T==="square"?D=!p?.isCircle&&Dt(O,Yg[T],.1):T==="original"?D=!1:D=!k&&Dt(O,Yg[T],.01),h.jsx(dB,{onSelect:()=>C(T),checked:D,title:c(`tool.aspect-ratio.${T}`),children:h.jsx(Mt,{children:c(`tool.aspect-ratio.${T}`)})},T)})})]}),h.jsx(ot,{type:"icon",onClick:i,"data-testid":"tool.image-crop-confirm",style:{borderLeft:"1px solid var(--tl-color-divider)",marginLeft:"2px"},title:c("tool.image-crop-confirm"),children:h.jsx(Se,{small:!0,icon:"check"})})]}):h.jsxs(h.Fragment,{children:[!d&&h.jsx(ot,{type:"icon","data-testid":"tool.image-replace",onClick:_,title:c("tool.replace-media"),children:h.jsx(Se,{small:!0,icon:"tool-media"})}),!d&&h.jsx(ot,{type:"icon",title:c("tool.image-crop"),onClick:r,"data-testid":"tool.image-crop",children:h.jsx(Se,{small:!0,icon:"crop"})}),h.jsx(ot,{type:"icon",title:c("action.download-original"),onClick:I,"data-testid":"tool.image-download",children:h.jsx(Se,{small:!0,icon:"download"})}),(E||!d)&&h.jsx(ot,{type:"icon",title:c("tool.media-alt-text"),"data-testid":"tool.image-alt-text",onClick:()=>{a("alt-text-start",{source:l}),s()},children:h.jsx(Se,{small:!0,icon:"alt"})})]})});function B$({children:t}){const e=z(),n=$("imageShape",()=>{const i=e.getOnlySelectedShape();return!i||i.type!=="image"?null:i.id},[e]),s=$("showToolbar",()=>e.isInAny("select.idle","select.pointing_shape","select.crop"),[e]),r=$("locked",()=>n?e.getShape(n)?.isLocked:!1,[e,n]);return!n||!s||r?null:h.jsx(z$,{imageShapeId:n,children:t},n)}function z$({children:t,imageShapeId:e}){const n=z(),s=ae(),r=$("editor path",()=>n.isInAny("select.crop.cropping","select.crop.pointing_crop_handle","select.crop.translating_crop"),[n]),i=$("camera",()=>n.getCamera(),[n]),o=$("editor path",()=>n.isIn("select.crop."),[n]),a=v.useRef(void 0),c=v.useCallback(()=>{n.setCroppingShape(null),n.setCurrentTool("select.idle")},[n]),[l,u]=v.useState(!1),d=v.useCallback(()=>u(!0),[]),p=v.useCallback(()=>n.setCurrentTool("select.crop.idle"),[n]),f=v.useCallback(()=>u(!1),[]);v.useEffect(()=>{a.current=void 0},[i]);const g=v.useCallback(()=>{if(o&&a.current)return a.current;const x=n.getSelectionScreenBounds();if(!x)return;const y=new X(x.x,x.y,x.width,0);return a.current=y,y},[n,o]);return r?(a.current=void 0,null):h.jsx(By,{className:"tlui-image__toolbar",getSelectionBounds:g,label:s("tool.image-toolbar-title"),children:t||(l?h.jsx(FE,{shapeId:e,onClose:f,source:"image-toolbar"}):h.jsx(F$,{imageShapeId:e,isManipulating:o,onEditAltTextStart:d,onManipulatingStart:p,onManipulatingEnd:c}))})}function $$({textEditor:t,onEditLinkStart:e}){const n=St(),s=ae(),r="rich-text-menu",[i,o]=v.useState(0);return v.useEffect(function(){function l(){o(u=>u+1)}t.on("update",l),t.on("selectionUpdate",l)},[t]),v.useEffect(()=>{function c(l){e&&At(l)&&l.shiftKey&&l.key==="k"&&(l.preventDefault(),e())}return document.addEventListener("keydown",c),()=>{document.removeEventListener("keydown",c)}},[e]),v.useMemo(()=>{function c(l,u){t.view&&(n("rich-text",{operation:l,source:r}),t.chain().focus()[u]().run())}return[{name:"bold",onSelect(){c("bold","toggleBold")}},{name:"italic",onSelect(){c("bold","toggleItalic")}},{name:"code",onSelect(){c("bold","toggleCode")}},e?{name:"link",onSelect(){e()}}:void 0,{name:"bulletList",onSelect(){c("bulletList","toggleBulletList")}},{name:"highlight",onSelect(){c("bulletList","toggleHighlight")}}].filter(Boolean)},[t,n,e]).map(({name:c,attrs:l,onSelect:u})=>{const d=t.view?t.isActive(c,l):!1;return h.jsx(ot,{title:s(`tool.rich-text-${c}`),"data-testid":`rich-text.${c}`,type:"icon",isActive:d,onPointerDown:Pe,onClick:u,role:"option","aria-pressed":d,children:h.jsx(Se,{small:!0,icon:c})},c)})}function N$({textEditor:t,value:e,onClose:n}){const s=z(),[r,i]=v.useState(e),o=ae(),a=v.useRef(null),c=St(),l="rich-text-menu",u=r.startsWith("http")?r:`https://${r}`,d=y=>i(y),p=y=>{c("rich-text",{operation:"link-edit",source:l}),!y.startsWith("http://")&&!y.startsWith("https://")&&(y=`https://${y}`),t.chain().setLink({href:y}).run(),s.getInstanceState().isCoarsePointer?t.commands.blur():t.commands.focus(),n()},f=()=>{c("rich-text",{operation:"link-visit",source:l}),vy(u,"_blank"),n()},g=()=>{c("rich-text",{operation:"link-remove",source:l}),t.chain().unsetLink().focus().run(),n()},x=()=>n();return v.useEffect(()=>{a.current?.focus()},[r]),v.useEffect(()=>{i(e)},[e]),h.jsxs(h.Fragment,{children:[h.jsx(ba,{ref:a,"data-testid":"rich-text.link-input",className:"tlui-rich-text__toolbar-link-input",value:r,onValueChange:d,onComplete:p,onCancel:x,placeholder:"example.com","aria-label":"example.com"}),h.jsx(Re,{className:"tlui-rich-text__toolbar-link-visit",title:o("tool.rich-text-link-visit"),type:"icon",onPointerDown:Pe,onClick:f,disabled:!r,children:h.jsx(Se,{small:!0,icon:"external-link"})}),h.jsx(Re,{className:"tlui-rich-text__toolbar-link-remove",title:o("tool.rich-text-link-remove"),"data-testid":"rich-text.link-remove",type:"icon",onPointerDown:Pe,onClick:g,children:h.jsx(Se,{small:!0,icon:"trash"})})]})}const U$=Ot(function({children:e}){const n=z(),s=$("textEditor",()=>n.getRichTextEditor(),[n]);return n.getInstanceState().isCoarsePointer||!s?null:h.jsx(H$,{textEditor:s,children:e})});function H$({textEditor:t,children:e}){const{isEditingLink:n,onEditLinkStart:s,onEditLinkClose:r}=K$(t),[i,o]=v.useState(null),a=v.useRef(void 0),c=W$(t),l=ae(),u=v.useCallback(()=>{if(n)return a.current;const d=window.getSelection();if(!i||!d||d.rangeCount===0||d.isCollapsed)return;const p=[];for(let g=0;g<d.rangeCount;g++){const x=d.getRangeAt(g);p.push(RE(x.getBoundingClientRect()))}const f=X.Common(p);return a.current=f,f},[i,n]);return v.useEffect(()=>{const d=({editor:p})=>o(p.state.selection);return t.on("selectionUpdate",d),d({editor:t}),()=>{t.off("selectionUpdate",d)}},[t]),h.jsx(By,{className:"tlui-rich-text__toolbar",getSelectionBounds:u,isMousingDown:c,changeOnlyWhenYChanges:!0,label:l("tool.rich-text-toolbar-title"),children:e||(n?h.jsx(N$,{textEditor:t,value:t.isActive("link")?t.getAttributes("link").href:"",onClose:r}):h.jsx($$,{textEditor:t,onEditLinkStart:s}))})}function K$(t){const[e,n]=v.useState(!1);v.useEffect(()=>{if(!t){n(!1);return}const o=()=>{const a=t.isActive("link");n(a)};return t.view.dom.addEventListener("click",o),()=>{t.isInitialized&&t.view.dom.removeEventListener("click",o)}},[t,e]),v.useEffect(()=>{if(t&&t.isActive("link"))try{const{from:o,to:a}=sA(t.state.doc.resolve(t.state.selection.from),t.schema.marks.link);t.state.selection.empty&&t.commands.setTextSelection({from:o,to:a})}catch{}},[t,e]);const s=v.useCallback(()=>{n(!0)},[]),r=v.useCallback(()=>{n(!1)},[]),i=v.useCallback(()=>{if(n(!1),!t)return;const o=t.state.selection.from;t.commands.setTextSelection({from:o,to:o})},[t]);return{isEditingLink:e,onEditLinkStart:s,onEditLinkClose:i,onEditLinkCancel:r}}function W$(t){const[e,n]=v.useState(!1);return v.useEffect(()=>{if(!t)return;const s=Gd(({isPointing:c})=>{n(c)},16),r=()=>s({isPointing:!0}),i=()=>s({isPointing:!1}),o=["touchstart","pointerdown","mousedown"],a=["touchend","pointerup","mouseup"];return o.forEach(c=>{t.view.dom.addEventListener(c,r)}),a.forEach(c=>{document.body.addEventListener(c,i)}),()=>{o.forEach(c=>{t.isInitialized&&t.view.dom.removeEventListener(c,r)}),a.forEach(c=>{document.body.removeEventListener(c,i)})}},[t]),e}function q$(){const t=z(),e=ae(),{orientation:n}=sl(),r=jE()?.get(Un),i=Fi({isDarkMode:t.user.getIsDarkMode()}),o=r?.type==="shared"?Ue(i,r.value,"solid"):Ue(i,"black","solid"),a=$("disable style panel",()=>t.isInAny("hand","zoom","eraser","laser"),[t]),c=v.useCallback(u=>{u||t.updateInstanceState({isChangingStyle:!1})},[t]),{StylePanel:l}=Cr();return l?h.jsxs(io,{id:"mobile style menu",onOpenChange:c,children:[h.jsx(oo,{children:h.jsx(Re,{type:"tool","data-testid":"mobile-styles.button",style:{color:a?"var(--tl-color-muted-1)":o},title:e("style-panel.title"),disabled:a,children:h.jsx(Se,{icon:a?"blob":r?.type==="mixed"?"mixed":"blob"})})}),h.jsx(ao,{side:n==="horizontal"?"top":"right",align:"end",children:l&&h.jsx(l,{isMobile:!0})})]}):null}function G$(){return h.jsxs(h.Fragment,{children:[h.jsx(V$,{}),h.jsx(X$,{}),h.jsx(Z$,{}),h.jsx(J$,{}),h.jsx(Q$,{}),h.jsx(e8,{}),h.jsx(t8,{}),h.jsx(n8,{}),h.jsx(s8,{}),h.jsx(r8,{}),h.jsx(o8,{}),h.jsx(i8,{}),h.jsx(l8,{}),h.jsx(h8,{}),h.jsx(a8,{}),h.jsx(u8,{}),h.jsx(d8,{}),h.jsx(c8,{}),h.jsx(p8,{}),h.jsx(f8,{}),h.jsx(g8,{}),h.jsx(m8,{}),h.jsx(y8,{}),h.jsx(S8,{}),h.jsx(x8,{}),h.jsx(b8,{}),h.jsx(v8,{}),h.jsx(w8,{})]})}function Y$(t){const e=z(),n=t?.meta?.geo;return $("is tool selected",()=>{if(!t)return!1;const s=e.getCurrentToolId();return s==="geo"?n===e.getSharedStyles().getAsKnownValue(yr):s===t.id},[e,t?.id,n])}function ct({tool:t}){const e=Oy(),n=Y$(e[t]);return h.jsx(Qn,{toolId:t,isSelected:n})}function V$(){return h.jsx(ct,{tool:"select"})}function X$(){return h.jsx(ct,{tool:"hand"})}function Z$(){return h.jsx(ct,{tool:"draw"})}function J$(){return h.jsx(ct,{tool:"eraser"})}function Q$(){return h.jsx(ct,{tool:"arrow"})}function e8(){return h.jsx(ct,{tool:"text"})}function t8(){return h.jsx(ct,{tool:"note"})}function n8(){return h.jsx(Qn,{toolId:"asset"})}function s8(){return h.jsx(ct,{tool:"rectangle"})}function r8(){return h.jsx(ct,{tool:"ellipse"})}function i8(){return h.jsx(ct,{tool:"diamond"})}function o8(){return h.jsx(ct,{tool:"triangle"})}function a8(){return h.jsx(ct,{tool:"rhombus"})}function c8(){return h.jsx(ct,{tool:"heart"})}function l8(){return h.jsx(ct,{tool:"hexagon"})}function d8(){return h.jsx(ct,{tool:"cloud"})}function u8(){return h.jsx(ct,{tool:"star"})}function h8(){return h.jsx(ct,{tool:"oval"})}function p8(){return h.jsx(ct,{tool:"x-box"})}function f8(){return h.jsx(ct,{tool:"check-box"})}function g8(){return h.jsx(ct,{tool:"arrow-left"})}function m8(){return h.jsx(ct,{tool:"arrow-up"})}function y8(){return h.jsx(ct,{tool:"arrow-down"})}function S8(){return h.jsx(ct,{tool:"arrow-right"})}function x8(){return h.jsx(ct,{tool:"line"})}function b8(){return h.jsx(ct,{tool:"highlight"})}function w8(){return h.jsx(ct,{tool:"frame"})}function v8(){return h.jsx(ct,{tool:"laser"})}const sg=typeof navigator<"u"?navigator.userAgent.toLowerCase().indexOf("firefox")>0:!1;function rg(t,e,n,s){t.addEventListener?t.addEventListener(e,n,s):t.attachEvent&&t.attachEvent("on".concat(e),n)}function $a(t,e,n,s){t.removeEventListener?t.removeEventListener(e,n,s):t.detachEvent&&t.detachEvent("on".concat(e),n)}function BE(t,e){const n=e.slice(0,e.length-1);for(let s=0;s<n.length;s++)n[s]=t[n[s].toLowerCase()];return n}function zE(t){typeof t!="string"&&(t=""),t=t.replace(/\s/g,"");const e=t.split(",");let n=e.lastIndexOf("");for(;n>=0;)e[n-1]+=",",e.splice(n,1),n=e.lastIndexOf("");return e}function P8(t,e){const n=t.length>=e.length?t:e,s=t.length>=e.length?e:t;let r=!0;for(let i=0;i<n.length;i++)s.indexOf(n[i])===-1&&(r=!1);return r}const Ac={backspace:8,"⌫":8,tab:9,clear:12,enter:13,"↩":13,return:13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,arrowup:38,arrowdown:40,arrowleft:37,arrowright:39,del:46,delete:46,ins:45,insert:45,home:36,end:35,pageup:33,pagedown:34,capslock:20,num_0:96,num_1:97,num_2:98,num_3:99,num_4:100,num_5:101,num_6:102,num_7:103,num_8:104,num_9:105,num_multiply:106,num_add:107,num_enter:108,num_subtract:109,num_decimal:110,num_divide:111,"⇪":20,",":188,".":190,"/":191,"`":192,"-":sg?173:189,"=":sg?61:187,";":sg?59:186,"'":222,"{":219,"}":221,"[":219,"]":221,"\\":220},nr={"⇧":16,shift:16,"⌥":18,alt:18,option:18,"⌃":17,ctrl:17,control:17,"⌘":91,cmd:91,meta:91,command:91},tc={16:"shiftKey",18:"altKey",17:"ctrlKey",91:"metaKey",shiftKey:16,ctrlKey:17,altKey:18,metaKey:91},sn={16:!1,18:!1,17:!1,91:!1},Pt={};for(let t=1;t<20;t++)Ac["f".concat(t)]=111+t;let gt=[],fc=null,$E="all";const Vr=new Map,wa=t=>Ac[t.toLowerCase()]||nr[t.toLowerCase()]||t.toUpperCase().charCodeAt(0),I8=t=>Object.keys(Ac).find(e=>Ac[e]===t),_8=t=>Object.keys(nr).find(e=>nr[e]===t);function NE(t){$E=t||"all"}function Mc(){return $E||"all"}function C8(){return gt.slice(0)}function T8(){return gt.map(t=>I8(t)||_8(t)||String.fromCharCode(t))}function E8(){const t=[];return Object.keys(Pt).forEach(e=>{Pt[e].forEach(n=>{let{key:s,scope:r,mods:i,shortcut:o}=n;t.push({scope:r,shortcut:o,mods:i,keys:s.split("+").map(a=>wa(a))})})}),t}function k8(t){const e=t.target||t.srcElement,{tagName:n}=e;let s=!0;const r=n==="INPUT"&&!["checkbox","radio","range","button","file","reset","submit","color"].includes(e.type);return(e.isContentEditable||(r||n==="TEXTAREA"||n==="SELECT")&&!e.readOnly)&&(s=!1),s}function A8(t){return typeof t=="string"&&(t=wa(t)),gt.indexOf(t)!==-1}function M8(t,e){let n,s;t||(t=Mc());for(const r in Pt)if(Object.prototype.hasOwnProperty.call(Pt,r))for(n=Pt[r],s=0;s<n.length;)n[s].scope===t?n.splice(s,1).forEach(o=>{let{element:a}=o;return Ny(a)}):s++;Mc()===t&&NE(e||"all")}function j8(t){let e=t.keyCode||t.which||t.charCode;t.key&&t.key.toLowerCase()==="capslock"&&(e=wa(t.key));const n=gt.indexOf(e);if(n>=0&&gt.splice(n,1),t.key&&t.key.toLowerCase()==="meta"&&gt.splice(0,gt.length),(e===93||e===224)&&(e=91),e in sn){sn[e]=!1;for(const s in nr)nr[s]===e&&(Rs[s]=!1)}}function UE(t){if(typeof t>"u")Object.keys(Pt).forEach(r=>{Array.isArray(Pt[r])&&Pt[r].forEach(i=>ql(i)),delete Pt[r]}),Ny(null);else if(Array.isArray(t))t.forEach(r=>{r.key&&ql(r)});else if(typeof t=="object")t.key&&ql(t);else if(typeof t=="string"){for(var e=arguments.length,n=new Array(e>1?e-1:0),s=1;s<e;s++)n[s-1]=arguments[s];let[r,i]=n;typeof r=="function"&&(i=r,r=""),ql({key:t,scope:r,method:i,splitKey:"+"})}}const ql=t=>{let{key:e,scope:n,method:s,splitKey:r="+"}=t;zE(e).forEach(o=>{const a=o.split(r),c=a.length,l=a[c-1],u=l==="*"?"*":wa(l);if(!Pt[u])return;n||(n=Mc());const d=c>1?BE(nr,a):[],p=[];Pt[u]=Pt[u].filter(f=>{const x=(s?f.method===s:!0)&&f.scope===n&&P8(f.mods,d);return x&&p.push(f.element),!x}),p.forEach(f=>Ny(f))})};function kv(t,e,n,s){if(e.element!==s)return;let r;if(e.scope===n||e.scope==="all"){r=e.mods.length>0;for(const i in sn)Object.prototype.hasOwnProperty.call(sn,i)&&(!sn[i]&&e.mods.indexOf(+i)>-1||sn[i]&&e.mods.indexOf(+i)===-1)&&(r=!1);(e.mods.length===0&&!sn[16]&&!sn[18]&&!sn[17]&&!sn[91]||r||e.shortcut==="*")&&(e.keys=[],e.keys=e.keys.concat(gt),e.method(t,e)===!1&&(t.preventDefault?t.preventDefault():t.returnValue=!1,t.stopPropagation&&t.stopPropagation(),t.cancelBubble&&(t.cancelBubble=!0)))}}function Av(t,e){const n=Pt["*"];let s=t.keyCode||t.which||t.charCode;if(t.key&&t.key.toLowerCase()==="capslock"||!Rs.filter.call(this,t))return;if((s===93||s===224)&&(s=91),gt.indexOf(s)===-1&&s!==229&&gt.push(s),["metaKey","ctrlKey","altKey","shiftKey"].forEach(a=>{const c=tc[a];t[a]&&gt.indexOf(c)===-1?gt.push(c):!t[a]&&gt.indexOf(c)>-1?gt.splice(gt.indexOf(c),1):a==="metaKey"&&t[a]&&(gt=gt.filter(l=>l in tc||l===s))}),s in sn){sn[s]=!0;for(const a in nr)if(Object.prototype.hasOwnProperty.call(nr,a)){const c=tc[nr[a]];Rs[a]=t[c]}if(!n)return}for(const a in sn)Object.prototype.hasOwnProperty.call(sn,a)&&(sn[a]=t[tc[a]]);t.getModifierState&&!(t.altKey&&!t.ctrlKey)&&t.getModifierState("AltGraph")&&(gt.indexOf(17)===-1&&gt.push(17),gt.indexOf(18)===-1&&gt.push(18),sn[17]=!0,sn[18]=!0);const r=Mc();if(n)for(let a=0;a<n.length;a++)n[a].scope===r&&(t.type==="keydown"&&n[a].keydown||t.type==="keyup"&&n[a].keyup)&&kv(t,n[a],r,e);if(!(s in Pt))return;const i=Pt[s],o=i.length;for(let a=0;a<o;a++)if((t.type==="keydown"&&i[a].keydown||t.type==="keyup"&&i[a].keyup)&&i[a].key){const c=i[a],{splitKey:l}=c,u=c.key.split(l),d=[];for(let p=0;p<u.length;p++)d.push(wa(u[p]));d.sort().join("")===gt.sort().join("")&&kv(t,c,r,e)}}function Rs(t,e,n){gt=[];const s=zE(t);let r=[],i="all",o=document,a=0,c=!1,l=!0,u="+",d=!1,p=!1;for(n===void 0&&typeof e=="function"&&(n=e),Object.prototype.toString.call(e)==="[object Object]"&&(e.scope&&(i=e.scope),e.element&&(o=e.element),e.keyup&&(c=e.keyup),e.keydown!==void 0&&(l=e.keydown),e.capture!==void 0&&(d=e.capture),typeof e.splitKey=="string"&&(u=e.splitKey),e.single===!0&&(p=!0)),typeof e=="string"&&(i=e),p&&UE(t,i);a<s.length;a++)t=s[a].split(u),r=[],t.length>1&&(r=BE(nr,t)),t=t[t.length-1],t=t==="*"?"*":wa(t),t in Pt||(Pt[t]=[]),Pt[t].push({keyup:c,keydown:l,scope:i,mods:r,shortcut:s[a],method:n,key:s[a],splitKey:u,element:o});if(typeof o<"u"&&window){if(!Vr.has(o)){const f=function(){let x=arguments.length>0&&arguments[0]!==void 0?arguments[0]:window.event;return Av(x,o)},g=function(){let x=arguments.length>0&&arguments[0]!==void 0?arguments[0]:window.event;Av(x,o),j8(x)};Vr.set(o,{keydownListener:f,keyupListenr:g,capture:d}),rg(o,"keydown",f,d),rg(o,"keyup",g,d)}if(!fc){const f=()=>{gt=[]};fc={listener:f,capture:d},rg(window,"focus",f,d)}}}function D8(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"all";Object.keys(Pt).forEach(n=>{Pt[n].filter(r=>r.scope===e&&r.shortcut===t).forEach(r=>{r&&r.method&&r.method()})})}function Ny(t){const e=Object.values(Pt).flat();if(e.findIndex(s=>{let{element:r}=s;return r===t})<0){const{keydownListener:s,keyupListenr:r,capture:i}=Vr.get(t)||{};s&&r&&($a(t,"keyup",r,i),$a(t,"keydown",s,i),Vr.delete(t))}if((e.length<=0||Vr.size<=0)&&(Object.keys(Vr).forEach(r=>{const{keydownListener:i,keyupListenr:o,capture:a}=Vr.get(r)||{};i&&o&&($a(r,"keyup",o,a),$a(r,"keydown",i,a),Vr.delete(r))}),Vr.clear(),Object.keys(Pt).forEach(r=>delete Pt[r]),fc)){const{listener:r,capture:i}=fc;$a(window,"focus",r,i),fc=null}}const ig={getPressedKeyString:T8,setScope:NE,getScope:Mc,deleteScope:M8,getPressedKeyCodes:C8,getAllKeyCodes:E8,isPressed:A8,filter:k8,trigger:D8,unbind:UE,keyMap:Ac,modifier:nr,modifierMap:tc};for(const t in ig)Object.prototype.hasOwnProperty.call(ig,t)&&(Rs[t]=ig[t]);if(typeof window<"u"){const t=window.hotkeys;Rs.noConflict=e=>(e&&window.hotkeys===Rs&&(window.hotkeys=t),Rs),window.hotkeys=Rs}const Mv=["copy","cut","paste","asset"];function O8(){const t=z(),e=_s(),n=Tr(),s=Oy(),r=$("is focused",()=>t.getInstanceState().isFocused,[t]);v.useEffect(()=>{if(!r)return;const i=new Array,o=t.getContainer(),a=(l,u)=>{Rs(l,{element:o.ownerDocument.body},u),i.push(()=>{Rs.unbind(l,u)})},c=(l,u)=>{Rs(l,{element:o.ownerDocument.body,keyup:!0,keydown:!1},u),i.push(()=>{Rs.unbind(l,u)})};for(const l of Object.values(n))l.kbd&&(e&&!l.readonlyOk||Mv.includes(l.id)||a(jv(l.kbd),u=>{nc(t)&&!l.isRequiredA11yAction||(Pe(u),l.onSelect("kbd"))}));for(const l of Object.values(s))!l.kbd||!l.readonlyOk&&t.getIsReadonly()||Mv.includes(l.id)||a(jv(l.kbd),u=>{nc(t)||(Pe(u),l.onSelect("kbd"))});return a(",",l=>{if(nc(t)||t.inputs.keys.has("Comma"))return;Pe(l),t.focus(),t.inputs.keys.add("Comma");const{x:u,y:d,z:p}=t.inputs.getCurrentPagePoint(),f=t.pageToScreen({x:u,y:d}),g={type:"pointer",name:"pointer_down",point:{x:f.x,y:f.y,z:p},shiftKey:l.shiftKey,altKey:l.altKey,ctrlKey:l.metaKey||l.ctrlKey,metaKey:l.metaKey,accelKey:At(l),pointerId:0,button:0,isPen:t.getInstanceState().isPenMode,target:"canvas"};t.dispatch(g)}),c(",",l=>{if(nc(t)||!t.inputs.keys.has("Comma"))return;t.inputs.keys.delete("Comma");const{x:u,y:d,z:p}=t.inputs.getCurrentScreenPoint(),f={type:"pointer",name:"pointer_up",point:{x:u,y:d,z:p},shiftKey:l.shiftKey,altKey:l.altKey,ctrlKey:l.metaKey||l.ctrlKey,metaKey:l.metaKey,accelKey:At(l),pointerId:0,button:0,isPen:t.getInstanceState().isPenMode,target:"canvas"};t.dispatch(f)}),()=>{i.forEach(l=>l())}},[n,s,e,t,r])}function nc(t){return t.menus.hasAnyOpenMenus()||t.getEditingShapeId()!==null||t.getCrashingError()||!t.user.getAreKeyboardShortcutsEnabled()}function jv(t){return L8(t).map(e=>{let n="";const s=e.includes("!"),r=e.includes("?"),i=e.includes("$"),o=e.replace(/[!?$]/g,"");return s&&r&&i?n=`cmd+shift+alt+${o},ctrl+shift+alt+${o}`:s&&i?n=`cmd+shift+${o},ctrl+shift+${o}`:r&&i?n=`cmd+alt+${o},ctrl+alt+${o}`:r&&s?n=`shift+alt+${o}`:s?n=`shift+${o}`:r?n=`alt+${o}`:i?n=`cmd+${o},ctrl+${o}`:n=o,n}).join(",")}function L8(t){typeof t!="string"&&(t=""),t=t.replace(/\s/g,"");const e=t.split(",");let n=e.lastIndexOf("");for(;n>=0;)e[n-1]+=",",e.splice(n,1),n=e.lastIndexOf("");return e}const R8=v.createContext(!1),F8={1:0,2:1,3:2,4:3,5:4,6:5,7:6,8:7,9:8,0:9};function B8({children:t,orientation:e,sizingParentClassName:n,minItems:s,minSizePx:r,maxItems:i,maxSizePx:o}){const a=z(),c=yo(),l=hn(),u=ae(),d=v.useRef([]),[p,f]=v.useState(!1),g=v.useRef(null),[x,y]=v.useState(null),[m,S]=v.useState(null),[w,P]=v.useState(!1),_=fr(()=>{if(!g.current)return;const E=e==="horizontal"?"offsetWidth":"offsetHeight",O=T(g.current.children),k=x?T(x.children):null;function T(Y){const Ie=[];for(const be of Y)be.classList.contains("tlui-main-toolbar__group")?Ie.push({type:"group",items:T(be.children),element:be}):be.hasAttribute("data-radix-popper-content-wrapper")||Ie.push({type:"item",element:be});return Ie}const R=Dv(g.current,n)[E],M=Math.floor(sr(R,[r,o],[s,i],!0));let L=0,U=null,V=!1;const J=[];function Z(Y,Ie){Ie&&le(Y.length===Ie.length);let be=!1,me=!1;for(let ne=0;ne<Y.length;ne++){const Me=Y[ne],ge=Ie?.[ne];if(Me.type==="item"){const ce=Me.element.getAttribute("data-value")===m;let _e;m?_e=L<M||ce:_e=L<=M;const ye=L>=M;be||=_e,me||=ye,Gl(Me.element,"data-toolbar-visible",_e?"true":"false"),ge&&(le(ge.type==="item"),Gl(ge.element,"data-toolbar-visible",ye?"true":"false")),ye&&Me.element.getAttribute("aria-pressed")==="true"&&(U=Me.element.getAttribute("data-value")),_e&&Me.element.tagName==="BUTTON"&&J.push(Me.element),!ye&&ce&&(V=!0),L++}else{let ce,_e;ge?(le(ge.type==="group"),_e=ge,ce=Z(Me.items,_e.items)):ce=Z(Me.items,null),be||=ce.didShowAnyInMain,me||=ce.didShowAnyInOverflow,Gl(Me.element,"data-toolbar-visible",ce.didShowAnyInMain?"true":"false"),_e&&Gl(_e.element,"data-toolbar-visible",ce.didShowAnyInOverflow?"true":"false")}}return{didShowAnyInMain:be,didShowAnyInOverflow:me}}const{didShowAnyInOverflow:Q}=Z(O,k);P(Q),U?S(U):V&&S(null),d.current=J});v.useLayoutEffect(()=>{_()}),v.useLayoutEffect(()=>{if(!g.current)return;const E=new MutationObserver(_);E.observe(g.current,{childList:!0,subtree:!0,attributes:!0,characterData:!0});const O=Dv(g.current,n),k=new ResizeObserver(_);return k.observe(O),()=>{E.disconnect(),k.disconnect()}},[_,n]),v.useEffect(()=>{if(!a.options.enableToolbarKeyboardShortcuts)return;function E(O){if(nc(a)||_P(!0)||O.ctrlKey||O.metaKey||O.altKey||O.shiftKey)return;const k=F8[O.key];typeof k=="number"&&(Pe(O),d.current[k]?.click())}return document.addEventListener("keydown",E),()=>{document.removeEventListener("keydown",E)}},[a]);const I="toolbar overflow",C=e==="horizontal"?xo:Ay;return h.jsx(h.Fragment,{children:h.jsxs(Wn,{orientation:e,className:de("tlui-main-toolbar__tools",{"tlui-main-toolbar__tools__mobile":l<yt.TABLET_SM}),label:u("tool-panel.title"),children:[h.jsx(C,{id:`${c}_main`,ref:g,children:h.jsx(Kn,{type:"toolbar",sourceId:"toolbar",children:t})}),w&&h.jsx(R8.Provider,{value:!0,children:h.jsxs(io,{id:I,open:p,onOpenChange:f,children:[h.jsx(oo,{children:h.jsx(ot,{title:u("tool-panel.more"),type:"tool",className:"tlui-main-toolbar__overflow","data-testid":"tools.more-button",children:h.jsx(Se,{icon:e==="horizontal"?"chevron-up":"chevron-right"})})}),h.jsx(ao,{side:e==="horizontal"?"top":"right",align:e==="horizontal"?"center":"end",children:h.jsx(Wn,{orientation:"grid",className:"tlui-main-toolbar__overflow-content",ref:y,"data-testid":"tools.more-content",label:u("tool-panel.more"),id:`${c}_more`,onClick:()=>{Ln.deleteOpenMenu(I,a.contextId),f(!1)},children:h.jsx(Kn,{type:"toolbar-overflow",sourceId:"toolbar",children:t})})})]})})]})})}function Dv(t,e){let n=t;for(;n;){if(n.classList.contains(e))return n;n=n.parentElement}throw new Error("Could not find parent with class name "+e)}function Gl(t,e,n){t.getAttribute(e)!==n&&t.setAttribute(e,n)}function z8({activeToolId:t}){const e=z(),n=hn(),s=ae(),r=Tr(),i=$("is tool locked",()=>e.getInstanceState().isToolLocked,[e]),o=$("current tool",()=>e.getCurrentTool(),[e]);if(!t||!o.isLockable)return null;const a=r["toggle-tool-lock"],c=a?.kbd?`${s("action.toggle-tool-lock")} ${Fd(a.kbd)}`:s("action.toggle-tool-lock");return h.jsx(rl,{content:c,children:h.jsx(Re,{type:"normal","data-testid":"tool-lock",className:de("tlui-main-toolbar__lock-button",{"tlui-main-toolbar__lock-button__mobile":n<yt.TABLET_SM}),onClick:()=>e.updateInstanceState({isToolLocked:!i}),children:h.jsx(Se,{icon:i?"lock":"unlock",small:!0})})})}const $8=v.memo(function({children:e,orientation:n="horizontal",minItems:s=4,minSizePx:r=310,maxItems:i=8,maxSizePx:o=470}){const a=z(),c=ae(),l=hn(),u=_s(),d=$("current tool id",()=>a.getCurrentToolId(),[a]),p=v.useRef(null);Ir(p);const{ActionsMenu:f,QuickActions:g}=Cr(),x=a.options.actionShortcutsLocation==="menu"?!1:a.options.actionShortcutsLocation==="toolbar"?!0:l<yt.TABLET;return h.jsx(Ru,{orientation:n,tooltipSide:n==="horizontal"?"top":"right",children:h.jsx("div",{ref:p,className:de("tlui-main-toolbar",`tlui-main-toolbar--${n}`),children:h.jsxs("div",{className:"tlui-main-toolbar__inner",children:[h.jsxs("div",{className:"tlui-main-toolbar__left",children:[!u&&h.jsxs("div",{className:"tlui-main-toolbar__extras",children:[x&&h.jsxs(Wn,{orientation:n,className:"tlui-main-toolbar__extras__controls",label:c("actions-menu.title"),children:[g&&h.jsx(g,{}),f&&h.jsx(f,{})]}),h.jsx(z8,{activeToolId:d})]}),h.jsx(B8,{orientation:n,sizingParentClassName:"tlui-main-toolbar",minItems:s,maxItems:i,minSizePx:r,maxSizePx:o,children:e??h.jsx(G$,{})})]}),l<yt.TABLET_SM&&!u&&h.jsx("div",{className:"tlui-main-toolbar__tools tlui-main-toolbar__mobile-style-panel",children:h.jsx(q$,{})})]})})})}),N8=Ot(function({videoShapeId:e,onEditAltTextStart:n}){const s=z(),r=St(),i=ae(),o="video-toolbar",a=s.getIsReadonly(),c=Tr(),l=v.useCallback(()=>c["video-replace"].onSelect("video-toolbar"),[c]),u=v.useCallback(()=>c["download-original"].onSelect("video-toolbar"),[c]),d=$("altText",()=>s.getShape(e).props.altText,[s,e]);return h.jsxs(h.Fragment,{children:[!a&&h.jsx(Re,{type:"icon",title:i("tool.replace-media"),onClick:l,"data-testid":"tool.video-replace",children:h.jsx(Se,{small:!0,icon:"tool-media"})}),h.jsx(Re,{type:"icon",title:i("action.download-original"),onClick:u,"data-testid":"tool.video-download",children:h.jsx(Se,{small:!0,icon:"download"})}),(d||!a)&&h.jsx(ot,{type:"icon",isActive:!!d,title:i("tool.media-alt-text"),"data-testid":"tool.video-alt-text",onClick:()=>{r("alt-text-start",{source:o}),n()},children:h.jsx(Se,{small:!0,icon:"alt"})})]})}),U8=Ot(function({children:e}){const n=z(),s=$("videoShape",()=>{const o=n.getOnlySelectedShape();return!o||o.type!=="video"?null:o.id},[n]),r=n.isInAny("select.idle","select.pointing_shape"),i=$("locked",()=>s?n.getShape(s)?.isLocked:!1,[n,s]);return!s||!r||i?null:h.jsx(H8,{videoShapeId:s,children:e},s)});function H8({children:t,videoShapeId:e}){const n=z(),s=ae(),[r,i]=v.useState(!1),o=v.useCallback(()=>i(!0),[]),a=v.useCallback(()=>i(!1),[]),c=v.useCallback(()=>{const l=n.getSelectionScreenBounds();if(l)return new X(l.x,l.y,l.width,0)},[n]);return h.jsx(By,{className:"tlui-video__toolbar",getSelectionBounds:c,label:s("tool.video-toolbar-title"),children:t||(r?h.jsx(FE,{shapeId:e,onClose:a,source:"video-toolbar"}):h.jsx(N8,{videoShapeId:e,onEditAltTextStart:o}))})}function K8(){return h.jsxs(h.Fragment,{children:[h.jsx(W,{actionId:"zoom-in",noClose:!0}),h.jsx(W,{actionId:"zoom-out",noClose:!0}),h.jsx(Hy,{}),h.jsx(e2,{}),h.jsx(t2,{})]})}const W8=v.memo(function({children:e}){const n=Lt(),[s,r]=ii("zoom menu"),i=e??h.jsx(K8,{});return h.jsxs(sm,{dir:"ltr",open:s,onOpenChange:r,modal:!1,children:[h.jsx(q8,{}),h.jsx(qd,{container:n,children:h.jsx(im,{className:"tlui-menu",side:"top",align:"start",alignOffset:0,sideOffset:8,collisionPadding:4,children:h.jsx(Kn,{type:"menu",sourceId:"zoom-menu",children:i})})})]})}),q8=()=>{const t=z(),e=hn(),n=$("zoom",()=>t.getZoomLevel(),[t]),s=ae(),r=v.useCallback(()=>{t.resetZoom(t.getViewportScreenCenter(),{animation:{duration:t.options.animationMediumMs}})},[t]),i=`${Math.floor(n*100)}%`;return h.jsx(ot,{asChild:!0,type:"icon","aria-label":`${s("navigation-zone.zoom")} — ${i}`,title:`${s("navigation-zone.zoom")} — ${i}`,"data-testid":"minimap.zoom-menu-button",className:"tlui-zoom-menu__button",onDoubleClick:r,children:h.jsx(rm,{dir:"ltr",children:e<yt.MOBILE?null:h.jsx("span",{style:{flexGrow:0,textAlign:"center"},children:i})})})},HE=v.createContext(null);function G8({overrides:t={},children:e}){const n=ma(t),s=ju();return h.jsx(HE.Provider,{value:v.useMemo(()=>({ContextMenu:F6,ActionsMenu:L6,HelpMenu:null,ZoomMenu:W8,MainMenu:Pz,Minimap:Dz,StylePanel:x$,PageMenu:Fz,NavigationPanel:Lz,Toolbar:$8,RichTextToolbar:U$,ImageToolbar:B$,VideoToolbar:U8,KeyboardShortcutsDialog:sE,QuickActions:Nz,HelperButtons:cz,DebugPanel:X6,DebugMenu:V6,MenuPanel:tz,SharePanel:s?Vz:null,CursorChatBubble:s?$6:null,TopPanel:null,Dialogs:sz,Toasts:P$,A11y:B4,FollowingIndicator:Q6,...n}),[n,s]),children:e})}function Cr(){const t=v.useContext(HE);if(!t)throw new Error("useTldrawUiComponents must be used within a TldrawUiComponentsProvider");return t}const KE=v.createContext(null);function WE(t,e){return(e.isShapeOfType(t,"image")||e.isShapeOfType(t,"video"))&&!!t.props.assetId}function Y8(t){return Object.fromEntries(t.map(e=>[e.id,e]))}function Yl(t,e){if(t.getSelectedShapes().length===0)return t.getDocumentSettings().name||e}function V8({overrides:t,children:e}){const n=Tt(),s=ju(),r=Dy(),i=Cr(),o=St(),a=Tu(),c=ae(),l=r.msg("document.default-name"),u=v.useMemo(()=>{const d=n;if(!d)return{};function p(){return d.isIn("select")||(d.complete(),d.setCurrentTool("select")),!1}function f(){return d.isIn("select")&&d.getSelectedShapeIds().length>0}function g(m){if(!f()||p())return;d.markHistoryStoppingPoint("resize shapes");const S=d.getSelectedShapeIds();S.length!==0&&d.run(()=>{S.map(P=>d.getShape(P)).filter(Boolean).forEach(P=>{d.resizeShape(P.id,new b(m,m),{scaleOrigin:d.getSelectionPageBounds()?.center})})})}const x=[{id:"edit-link",label:"action.edit-link",icon:"link",onSelect(m){f()&&(p()||(o("edit-link",{source:m}),d.markHistoryStoppingPoint("edit-link"),r.addDialog({component:G4})))}},{id:"insert-embed",label:"action.insert-embed",kbd:"cmd+i,ctrl+i",onSelect(m){o("insert-embed",{source:m}),r.addDialog({component:UT})}},{id:"open-kbd-shortcuts",label:"action.open-kbd-shortcuts",kbd:"cmd+alt+/,ctrl+alt+/",onSelect(m){o("open-kbd-shortcuts",{source:m}),r.addDialog({component:i.KeyboardShortcutsDialog??sE})}},{id:"insert-media",label:"action.insert-media",kbd:"cmd+u,ctrl+u",onSelect(m){o("insert-media",{source:m}),r.insertMedia()}},{id:"undo",label:"action.undo",icon:"undo",kbd:"cmd+z,ctrl+z",onSelect(m){o("undo",{source:m}),d.undo()}},{id:"redo",label:"action.redo",icon:"redo",kbd:"cmd+shift+z,ctrl+shift+z",onSelect(m){o("redo",{source:m}),d.redo()}},{id:"export-as-svg",label:{default:"action.export-as-svg",menu:"action.export-as-svg.short","context-menu":"action.export-as-svg.short"},readonlyOk:!0,onSelect(m){let S=d.getSelectedShapeIds();S.length===0&&(S=Array.from(d.getCurrentPageShapeIds().values())),S.length!==0&&(o("export-as",{format:"svg",source:m}),r.exportAs(S,{format:"svg",name:Yl(d,l)}))}},{id:"export-as-png",label:{default:"action.export-as-png",menu:"action.export-as-png.short","context-menu":"action.export-as-png.short"},readonlyOk:!0,onSelect(m){let S=d.getSelectedShapeIds();S.length===0&&(S=Array.from(d.getCurrentPageShapeIds().values())),S.length!==0&&(o("export-as",{format:"png",source:m}),r.exportAs(S,{format:"png",name:Yl(d,l)}))}},{id:"export-all-as-svg",label:{default:"action.export-all-as-svg",menu:"action.export-all-as-svg.short","context-menu":"action.export-all-as-svg.short"},readonlyOk:!0,onSelect(m){let S=d.getSelectedShapeIds();S.length===0&&(S=Array.from(d.getCurrentPageShapeIds().values())),S.length!==0&&(o("export-all-as",{format:"svg",source:m}),r.exportAs(Array.from(d.getCurrentPageShapeIds()),{format:"svg",name:Yl(d,l)}))}},{id:"export-all-as-png",label:{default:"action.export-all-as-png",menu:"action.export-all-as-png.short","context-menu":"action.export-all-as-png.short"},readonlyOk:!0,onSelect(m){const S=Array.from(d.getCurrentPageShapeIds().values());S.length!==0&&(o("export-all-as",{format:"png",source:m}),r.exportAs(S,{format:"png",name:Yl(d,l)}))}},{id:"copy-as-svg",label:{default:"action.copy-as-svg",menu:"action.copy-as-svg.short","context-menu":"action.copy-as-svg.short"},kbd:"cmd+shift+c,ctrl+shift+c",readonlyOk:!0,onSelect(m){let S=d.getSelectedShapeIds();S.length===0&&(S=Array.from(d.getCurrentPageShapeIds().values())),S.length!==0&&(o("copy-as",{format:"svg",source:m}),r.copyAs(S,"svg"))}},{id:"copy-as-png",label:{default:"action.copy-as-png",menu:"action.copy-as-png.short","context-menu":"action.copy-as-png.short"},readonlyOk:!0,onSelect(m){let S=d.getSelectedShapeIds();S.length===0&&(S=Array.from(d.getCurrentPageShapeIds().values())),S.length!==0&&(o("copy-as",{format:"png",source:m}),r.copyAs(S,"png"))}},{id:"toggle-auto-size",label:"action.toggle-auto-size",onSelect(m){f()&&(p()||(o("toggle-auto-size",{source:m}),d.markHistoryStoppingPoint("toggling auto size"),d.run(()=>{const S=d.getSelectedShapes().filter(w=>d.isShapeOfType(w,"text")&&w.props.autoSize===!1);d.updateShapes(S.map(w=>({id:w.id,type:w.type,props:{...w.props,w:8,autoSize:!0}}))),Qe(d,S.map(w=>w.id))})))}},{id:"open-embed-link",label:"action.open-embed-link",readonlyOk:!0,onSelect(m){o("open-embed-link",{source:m});const S=d.getSelectedShapeIds(),w="No embed shapes selected";if(S.length!==1){console.error(w);return}const P=d.getShape(S[0]);if(!P||!d.isShapeOfType(P,"embed")){console.error(w);return}vy(P.props.url,"_blank")}},{id:"select-zoom-tool",readonlyOk:!0,kbd:"z",onSelect(m){if(d.root.getCurrent()?.id!=="zoom"&&(o("zoom-tool",{source:m}),!(d.inputs.getShiftKey()||d.inputs.getCtrlKey()))){const S=d.root.getCurrent();S&&S.getCurrent()?.id==="idle"&&d.setCurrentTool("zoom",{onInteractionEnd:S.id,maskAs:"zoom"})}}},{id:"convert-to-bookmark",label:"action.convert-to-bookmark",async onSelect(m){if(!f()||p())return;o("convert-to-bookmark",{source:m});const S=d.getSelectedShapes(),w=d.markHistoryStoppingPoint("convert shapes to bookmark"),P=[];for(const _ of S){if(!_||!d.isShapeOfType(_,"embed")||!_.props.url)continue;const I=d.getShapePageBounds(_)?.center;I&&(d.deleteShapes([_.id]),P.push(FT(d,{url:_.props.url,center:I}).then(C=>{if(!C.ok)throw new Error(C.error);return C})))}await Promise.all(P).catch(_=>{d.bailToMark(w),console.error(_)})}},{id:"convert-to-embed",label:"action.convert-to-embed",onSelect(m){f()&&(p()||(o("convert-to-embed",{source:m}),d.run(()=>{const S=d.getSelectedShapeIds(),w=ve(S.map(I=>d.getShape(I))),P=[],_=[];for(const I of w){if(!d.isShapeOfType(I,"bookmark"))continue;const{url:C}=I.props,E=r.getEmbedDefinition(C);if(!E||!E.definition)continue;const{width:O,height:k}=E.definition,T=new b(I.x,I.y);T.rot(-I.rotation),T.add(new b(I.props.w/2-O/2,I.props.h/2-k/2)),T.rot(I.rotation);const D={id:tt(),type:"embed",x:T.x,y:T.y,rotation:I.rotation,props:{url:C,w:O,h:k}};P.push(D),_.push(I.id)}d.markHistoryStoppingPoint("convert shapes to embed"),d.deleteShapes(_),d.createShapes(P)})))}},{id:"duplicate",kbd:"cmd+d,ctrl+d",label:"action.duplicate",icon:"duplicate",onSelect(m){if(!f()||p())return;o("duplicate-shapes",{source:m});const S=d.getInstanceState();let w,P;if(S.duplicateProps)w=S.duplicateProps.shapeIds,P=S.duplicateProps.offset;else{w=d.getSelectedShapeIds();const _=X.Common(ve(w.map(I=>d.getShapePageBounds(I))));P=d.getCameraOptions().isLocked?{x:d.options.adjacentShapeMargin,y:d.options.adjacentShapeMargin}:{x:_.width+d.options.adjacentShapeMargin,y:0}}d.markHistoryStoppingPoint("duplicate shapes"),d.duplicateShapes(w,P),S.duplicateProps&&d.updateInstanceState({duplicateProps:{...S.duplicateProps,shapeIds:d.getSelectedShapeIds()}})}},{id:"ungroup",label:"action.ungroup",kbd:"cmd+shift+g,ctrl+shift+g",icon:"ungroup",onSelect(m){f()&&(p()||(o("ungroup-shapes",{source:m}),d.markHistoryStoppingPoint("ungroup"),d.ungroupShapes(d.getSelectedShapeIds())))}},{id:"group",label:"action.group",kbd:"cmd+g,ctrl+g",icon:"group",onSelect(m){if(!f()||p())return;o("group-shapes",{source:m});const S=d.getOnlySelectedShape();S&&d.isShapeOfType(S,"group")?(d.markHistoryStoppingPoint("ungroup"),d.ungroupShapes(d.getSelectedShapeIds())):(d.markHistoryStoppingPoint("group"),d.groupShapes(d.getSelectedShapeIds()))}},{id:"remove-frame",label:"action.remove-frame",kbd:"cmd+shift+f,ctrl+shift+f",onSelect(m){if(!f())return;o("remove-frame",{source:m});const S=d.getSelectedShapes();S.length>0&&S.every(w=>d.isShapeOfType(w,"frame"))&&(d.markHistoryStoppingPoint("remove-frame"),W4(d,S.map(w=>w.id)))}},{id:"fit-frame-to-content",label:"action.fit-frame-to-content",onSelect(m){if(!f())return;o("fit-frame-to-content",{source:m});const S=d.getOnlySelectedShape();S&&d.isShapeOfType(S,"frame")&&(d.markHistoryStoppingPoint("fit-frame-to-content"),zT(d,S.id))}},{id:"align-left",label:"action.align-left",kbd:"alt+A",icon:"align-left",onSelect(m){f()&&(p()||(o("align-shapes",{operation:"left",source:m}),d.markHistoryStoppingPoint("align left"),d.run(()=>{const S=d.getSelectedShapeIds();d.alignShapes(S,"left"),Qe(d,S)})))}},{id:"align-center-horizontal",label:{default:"action.align-center-horizontal","context-menu":"action.align-center-horizontal.short"},kbd:"alt+H",icon:"align-center-horizontal",onSelect(m){f()&&(p()||(o("align-shapes",{operation:"center-horizontal",source:m}),d.markHistoryStoppingPoint("align center horizontal"),d.run(()=>{const S=d.getSelectedShapeIds();d.alignShapes(S,"center-horizontal"),Qe(d,S)})))}},{id:"align-right",label:"action.align-right",kbd:"alt+D",icon:"align-right",onSelect(m){f()&&(p()||(o("align-shapes",{operation:"right",source:m}),d.markHistoryStoppingPoint("align right"),d.run(()=>{const S=d.getSelectedShapeIds();d.alignShapes(S,"right"),Qe(d,S)})))}},{id:"align-center-vertical",label:{default:"action.align-center-vertical","context-menu":"action.align-center-vertical.short"},kbd:"alt+V",icon:"align-center-vertical",onSelect(m){f()&&(p()||(o("align-shapes",{operation:"center-vertical",source:m}),d.markHistoryStoppingPoint("align center vertical"),d.run(()=>{const S=d.getSelectedShapeIds();d.alignShapes(S,"center-vertical"),Qe(d,S)})))}},{id:"align-top",label:"action.align-top",icon:"align-top",kbd:"alt+W",onSelect(m){f()&&(p()||(o("align-shapes",{operation:"top",source:m}),d.markHistoryStoppingPoint("align top"),d.run(()=>{const S=d.getSelectedShapeIds();d.alignShapes(S,"top"),Qe(d,S)})))}},{id:"align-bottom",label:"action.align-bottom",icon:"align-bottom",kbd:"alt+S",onSelect(m){f()&&(p()||(o("align-shapes",{operation:"bottom",source:m}),d.markHistoryStoppingPoint("align bottom"),d.run(()=>{const S=d.getSelectedShapeIds();d.alignShapes(S,"bottom"),Qe(d,S)})))}},{id:"distribute-horizontal",label:{default:"action.distribute-horizontal","context-menu":"action.distribute-horizontal.short"},icon:"distribute-horizontal",kbd:"alt+shift+h",onSelect(m){f()&&(p()||(o("distribute-shapes",{operation:"horizontal",source:m}),d.markHistoryStoppingPoint("distribute horizontal"),d.run(()=>{const S=d.getSelectedShapeIds();d.distributeShapes(S,"horizontal"),Qe(d,S)})))}},{id:"distribute-vertical",label:{default:"action.distribute-vertical","context-menu":"action.distribute-vertical.short"},icon:"distribute-vertical",kbd:"alt+shift+V",onSelect(m){f()&&(p()||(o("distribute-shapes",{operation:"vertical",source:m}),d.markHistoryStoppingPoint("distribute vertical"),d.run(()=>{const S=d.getSelectedShapeIds();d.distributeShapes(S,"vertical"),Qe(d,S)})))}},{id:"stretch-horizontal",label:{default:"action.stretch-horizontal","context-menu":"action.stretch-horizontal.short"},icon:"stretch-horizontal",onSelect(m){f()&&(p()||(o("stretch-shapes",{operation:"horizontal",source:m}),d.markHistoryStoppingPoint("stretch horizontal"),d.run(()=>{const S=d.getSelectedShapeIds();d.stretchShapes(S,"horizontal"),Qe(d,S)})))}},{id:"stretch-vertical",label:{default:"action.stretch-vertical","context-menu":"action.stretch-vertical.short"},icon:"stretch-vertical",onSelect(m){f()&&(p()||(o("stretch-shapes",{operation:"vertical",source:m}),d.markHistoryStoppingPoint("stretch vertical"),d.run(()=>{const S=d.getSelectedShapeIds();d.stretchShapes(S,"vertical"),Qe(d,S)})))}},{id:"flip-horizontal",label:{default:"action.flip-horizontal","context-menu":"action.flip-horizontal.short"},kbd:"shift+h",onSelect(m){f()&&(p()||(o("flip-shapes",{operation:"horizontal",source:m}),d.markHistoryStoppingPoint("flip horizontal"),d.run(()=>{const S=d.getSelectedShapeIds();d.flipShapes(S,"horizontal"),Qe(d,S)})))}},{id:"flip-vertical",label:{default:"action.flip-vertical","context-menu":"action.flip-vertical.short"},kbd:"shift+v",onSelect(m){f()&&(p()||(o("flip-shapes",{operation:"vertical",source:m}),d.markHistoryStoppingPoint("flip vertical"),d.run(()=>{const S=d.getSelectedShapeIds();d.flipShapes(S,"vertical"),Qe(d,S)})))}},{id:"pack",label:"action.pack",icon:"pack",onSelect(m){f()&&(p()||(o("pack-shapes",{source:m}),d.markHistoryStoppingPoint("pack"),d.run(()=>{const S=d.getSelectedShapeIds();d.packShapes(S,d.options.adjacentShapeMargin),Qe(d,S)})))}},{id:"stack-vertical",label:{default:"action.stack-vertical","context-menu":"action.stack-vertical.short"},icon:"stack-vertical",onSelect(m){f()&&(p()||(o("stack-shapes",{operation:"vertical",source:m}),d.markHistoryStoppingPoint("stack-vertical"),d.run(()=>{const S=d.getSelectedShapeIds();d.stackShapes(S,"vertical",d.options.adjacentShapeMargin),Qe(d,S)})))}},{id:"stack-horizontal",label:{default:"action.stack-horizontal","context-menu":"action.stack-horizontal.short"},icon:"stack-horizontal",onSelect(m){f()&&(p()||(o("stack-shapes",{operation:"horizontal",source:m}),d.markHistoryStoppingPoint("stack-horizontal"),d.run(()=>{const S=d.getSelectedShapeIds();d.stackShapes(S,"horizontal",d.options.adjacentShapeMargin),Qe(d,S)})))}},{id:"bring-to-front",label:"action.bring-to-front",kbd:"]",icon:"bring-to-front",onSelect(m){f()&&(p()||(o("reorder-shapes",{operation:"toFront",source:m}),d.markHistoryStoppingPoint("bring to front"),d.bringToFront(d.getSelectedShapeIds())))}},{id:"bring-forward",label:"action.bring-forward",icon:"bring-forward",kbd:"alt+]",onSelect(m){f()&&(p()||(o("reorder-shapes",{operation:"forward",source:m}),d.markHistoryStoppingPoint("bring forward"),d.bringForward(d.getSelectedShapeIds())))}},{id:"send-backward",label:"action.send-backward",icon:"send-backward",kbd:"alt+[",onSelect(m){f()&&(p()||(o("reorder-shapes",{operation:"backward",source:m}),d.markHistoryStoppingPoint("send backward"),d.sendBackward(d.getSelectedShapeIds())))}},{id:"send-to-back",label:"action.send-to-back",icon:"send-to-back",kbd:"[",onSelect(m){f()&&(p()||(o("reorder-shapes",{operation:"toBack",source:m}),d.markHistoryStoppingPoint("send to back"),d.sendToBack(d.getSelectedShapeIds())))}},{id:"cut",label:"action.cut",kbd:"cmd+x,ctrl+x",onSelect(m){f()&&(p()||(d.markHistoryStoppingPoint("cut"),r.cut(m)))}},{id:"copy",label:"action.copy",kbd:"cmd+c,ctrl+c",readonlyOk:!0,onSelect(m){f()&&(p()||r.copy(m))}},{id:"paste",label:"action.paste",kbd:"cmd+v,ctrl+v",onSelect(m){navigator.clipboard?.read().then(S=>{r.paste(S,m,m==="context-menu"?d.inputs.getCurrentPagePoint():void 0)}).catch(()=>{r.addToast({title:r.msg("action.paste-error-title"),description:r.msg("action.paste-error-description"),severity:"error"})})}},{id:"select-all",label:"action.select-all",kbd:"cmd+a,ctrl+a",readonlyOk:!0,onSelect(m){d.run(()=>{p()||(o("select-all-shapes",{source:m}),d.markHistoryStoppingPoint("select all kbd"),d.selectAll())})}},{id:"select-none",label:"action.select-none",readonlyOk:!0,onSelect(m){f()&&(p()||(o("select-none-shapes",{source:m}),d.markHistoryStoppingPoint("select none"),d.selectNone()))}},{id:"delete",label:"action.delete",kbd:"⌫,del",icon:"trash",onSelect(m){f()&&(p()||(o("delete-shapes",{source:m}),d.markHistoryStoppingPoint("delete"),d.deleteShapes(d.getSelectedShapeIds())))}},{id:"rotate-cw",label:"action.rotate-cw",icon:"rotate-cw",kbd:"shift+.,shift+alt+.",onSelect(m){if(!f()||p())return;const S=d.inputs.getAltKey();o("rotate-cw",{source:m,fine:S}),d.markHistoryStoppingPoint("rotate-cw"),d.run(()=>{const w=vt/(S?96:6),P=d.getSelectionRotation()%w,_=Dt(P,0)||Dt(P,w),I=d.getSelectedShapeIds();d.rotateShapesBy(I,w-(_?0:P)),Qe(d,I)})}},{id:"rotate-ccw",label:"action.rotate-ccw",icon:"rotate-ccw",kbd:"shift+,,shift+alt+,",onSelect(m){if(!f()||p())return;const S=d.inputs.getAltKey();o("rotate-ccw",{source:m,fine:S}),d.markHistoryStoppingPoint("rotate-ccw"),d.run(()=>{const w=vt/(S?96:6),P=d.getSelectionRotation()%w,_=Dt(P,0),I=d.getSelectedShapeIds();d.rotateShapesBy(I,_?-w:-P),Qe(d,I)})}},{id:"zoom-in",label:"action.zoom-in",kbd:"cmd+=,ctrl+=,=",readonlyOk:!0,onSelect(m){o("zoom-in",{source:m,towardsCursor:!1}),d.zoomIn(void 0,{animation:{duration:d.options.animationMediumMs}})}},{id:"zoom-in-on-cursor",label:"action.zoom-in",kbd:"shift+cmd+=,shift+ctrl+=,shift+=",readonlyOk:!0,onSelect(m){o("zoom-in",{source:m,towardsCursor:!0}),d.zoomIn(d.inputs.getCurrentScreenPoint(),{animation:{duration:d.options.animationMediumMs}})}},{id:"zoom-out",label:"action.zoom-out",kbd:"cmd+-,ctrl+-,-",readonlyOk:!0,onSelect(m){o("zoom-out",{source:m,towardsCursor:!1}),d.zoomOut(void 0,{animation:{duration:d.options.animationMediumMs}})}},{id:"zoom-out-on-cursor",label:"action.zoom-out",kbd:"shift+cmd+-,shift+ctrl+-,shift+-",readonlyOk:!0,onSelect(m){o("zoom-out",{source:m,towardsCursor:!0}),d.zoomOut(d.inputs.getCurrentScreenPoint(),{animation:{duration:d.options.animationMediumMs}})}},{id:"zoom-to-100",label:"action.zoom-to-100",icon:"reset-zoom",kbd:"shift+0",readonlyOk:!0,onSelect(m){o("reset-zoom",{source:m}),d.resetZoom(void 0,{animation:{duration:d.options.animationMediumMs}})}},{id:"zoom-to-fit",label:"action.zoom-to-fit",kbd:"shift+1",readonlyOk:!0,onSelect(m){o("zoom-to-fit",{source:m}),d.zoomToFit({animation:{duration:d.options.animationMediumMs}})}},{id:"zoom-to-selection",label:"action.zoom-to-selection",kbd:"shift+2",readonlyOk:!0,onSelect(m){f()&&(p()||(o("zoom-to-selection",{source:m}),d.zoomToSelection({animation:{duration:d.options.animationMediumMs}})))}},{id:"toggle-snap-mode",label:{default:"action.toggle-snap-mode",menu:"action.toggle-snap-mode.menu"},onSelect(m){o("toggle-snap-mode",{source:m}),d.user.updateUserPreferences({isSnapMode:!d.user.getIsSnapMode()})},checkbox:!0},{id:"toggle-dark-mode",label:{default:"action.toggle-dark-mode",menu:"action.toggle-dark-mode.menu"},kbd:"cmd+/,ctrl+/",readonlyOk:!0,onSelect(m){const S=d.user.getIsDarkMode()?"light":"dark";o("color-scheme",{source:m,value:S}),d.user.updateUserPreferences({colorScheme:S})},checkbox:!0},{id:"toggle-wrap-mode",label:{default:"action.toggle-wrap-mode",menu:"action.toggle-wrap-mode.menu"},readonlyOk:!0,onSelect(m){o("toggle-wrap-mode",{source:m}),d.user.updateUserPreferences({isWrapMode:!d.user.getIsWrapMode()})},checkbox:!0},{id:"toggle-dynamic-size-mode",label:{default:"action.toggle-dynamic-size-mode",menu:"action.toggle-dynamic-size-mode.menu"},readonlyOk:!1,onSelect(m){o("toggle-dynamic-size-mode",{source:m}),d.user.updateUserPreferences({isDynamicSizeMode:!d.user.getIsDynamicResizeMode()})},checkbox:!0},{id:"toggle-paste-at-cursor",label:{default:"action.toggle-paste-at-cursor",menu:"action.toggle-paste-at-cursor.menu"},readonlyOk:!1,onSelect(m){o("toggle-paste-at-cursor",{source:m}),d.user.updateUserPreferences({isPasteAtCursorMode:!d.user.getIsPasteAtCursorMode()})},checkbox:!0},{id:"toggle-reduce-motion",label:{default:"action.toggle-reduce-motion",menu:"action.toggle-reduce-motion.menu"},readonlyOk:!0,onSelect(m){o("toggle-reduce-motion",{source:m}),d.user.updateUserPreferences({animationSpeed:d.user.getAnimationSpeed()===0?1:0})},checkbox:!0},{id:"toggle-keyboard-shortcuts",label:{default:"action.toggle-keyboard-shortcuts",menu:"action.toggle-keyboard-shortcuts.menu"},readonlyOk:!0,onSelect(m){o("toggle-keyboard-shortcuts",{source:m}),d.user.updateUserPreferences({areKeyboardShortcutsEnabled:!d.user.getAreKeyboardShortcutsEnabled()})},checkbox:!0},{id:"enhanced-a11y-mode",label:{default:"action.enhanced-a11y-mode",menu:"action.enhanced-a11y-mode.menu"},readonlyOk:!0,onSelect(m){o("enhanced-a11y-mode",{source:m}),d.user.updateUserPreferences({enhancedA11yMode:!d.user.getEnhancedA11yMode()})},checkbox:!0},{id:"toggle-edge-scrolling",label:{default:"action.toggle-edge-scrolling",menu:"action.toggle-edge-scrolling.menu"},readonlyOk:!0,onSelect(m){o("toggle-edge-scrolling",{source:m}),d.user.updateUserPreferences({edgeScrollSpeed:d.user.getEdgeScrollSpeed()===0?1:0})},checkbox:!0},{id:"toggle-transparent",label:{default:"action.toggle-transparent",menu:"action.toggle-transparent.menu","context-menu":"action.toggle-transparent.context-menu"},readonlyOk:!0,onSelect(m){o("toggle-transparent",{source:m}),d.updateInstanceState({exportBackground:!d.getInstanceState().exportBackground})},checkbox:!0},{id:"toggle-tool-lock",label:{default:"action.toggle-tool-lock",menu:"action.toggle-tool-lock.menu"},kbd:"q",onSelect(m){o("toggle-tool-lock",{source:m}),d.updateInstanceState({isToolLocked:!d.getInstanceState().isToolLocked})},checkbox:!0},{id:"unlock-all",label:"action.unlock-all",onSelect(m){o("unlock-all",{source:m});const S=[];for(const w of d.getCurrentPageShapes())w.isLocked&&S.push({id:w.id,type:w.type,isLocked:!1});S.length>0&&d.updateShapes(S)}},{id:"toggle-focus-mode",label:{default:"action.toggle-focus-mode",menu:"action.toggle-focus-mode.menu"},readonlyOk:!0,kbd:"cmd+.,ctrl+.",checkbox:!0,onSelect(m){d.timers.requestAnimationFrame(()=>{d.run(()=>{o("toggle-focus-mode",{source:m}),r.clearDialogs(),r.clearToasts(),d.updateInstanceState({isFocusMode:!d.getInstanceState().isFocusMode})})})}},{id:"toggle-grid",label:{default:"action.toggle-grid",menu:"action.toggle-grid.menu"},readonlyOk:!0,kbd:"cmd+',ctrl+'",onSelect(m){o("toggle-grid-mode",{source:m}),d.updateInstanceState({isGridMode:!d.getInstanceState().isGridMode})},checkbox:!0},{id:"toggle-debug-mode",label:{default:"action.toggle-debug-mode",menu:"action.toggle-debug-mode.menu"},readonlyOk:!0,onSelect(m){o("toggle-debug-mode",{source:m}),d.updateInstanceState({isDebugMode:!d.getInstanceState().isDebugMode})},checkbox:!0},{id:"print",label:"action.print",kbd:"cmd+p,ctrl+p",readonlyOk:!0,onSelect(m){o("print",{source:m}),r.printSelectionOrPages()}},{id:"exit-pen-mode",label:"action.exit-pen-mode",icon:"cross-2",readonlyOk:!0,onSelect(m){o("exit-pen-mode",{source:m}),d.updateInstanceState({isPenMode:!1})}},{id:"stop-following",label:"action.stop-following",icon:"cross-2",readonlyOk:!0,onSelect(m){o("stop-following",{source:m}),d.stopFollowingUser()}},{id:"back-to-content",label:"action.back-to-content",icon:"arrow-left",readonlyOk:!0,onSelect(m){o("zoom-to-content",{source:m});const S=d.getSelectionPageBounds()??d.getCurrentPageBounds();S&&d.zoomToBounds(S,{targetZoom:Math.min(1,d.getZoomLevel()),animation:{duration:220}})}},{id:"toggle-lock",label:"action.toggle-lock",kbd:"shift+l",onSelect(m){d.markHistoryStoppingPoint("locking"),o("toggle-lock",{source:m}),d.toggleLock(d.getSelectedShapeIds())}},{id:"move-to-new-page",label:"context.pages.new-page",onSelect(m){const S=zn.createId(),w=d.getSelectedShapeIds();d.run(()=>{d.markHistoryStoppingPoint("move_shapes_to_page"),d.createPage({name:r.msg("page-menu.new-page-initial-name"),id:S}),d.moveShapesToPage(w,S)}),o("move-to-new-page",{source:m})}},{id:"select-white-color",label:"color-style.white",kbd:"alt+t",onSelect(m){const S=Un;d.run(()=>{d.markHistoryStoppingPoint("change-color"),d.isIn("select")&&d.setStyleForSelectedShapes(S,"white"),d.setStyleForNextShapes(S,"white")}),o("set-style",{source:m,id:S.id,value:"white"})}},{id:"select-fill-fill",label:"fill-style.fill",kbd:"alt+f",onSelect(m){const S=Ti;d.run(()=>{d.markHistoryStoppingPoint("change-fill"),d.isIn("select")&&d.setStyleForSelectedShapes(S,"fill"),d.setStyleForNextShapes(S,"fill")}),o("set-style",{source:m,id:S.id,value:"fill"})}},{id:"select-fill-lined-fill",label:"fill-style.lined-fill",kbd:"alt+shift+f",onSelect(m){const S=Ti;d.run(()=>{d.markHistoryStoppingPoint("change-fill"),d.isIn("select")&&d.setStyleForSelectedShapes(S,"lined-fill"),d.setStyleForNextShapes(S,"lined-fill")}),o("set-style",{source:m,id:S.id,value:"lined-fill"})}},{id:"flatten-to-image",label:"action.flatten-to-image",kbd:"shift+f",onSelect:async m=>{const S=d.getSelectedShapeIds();if(S.length===0)return;d.markHistoryStoppingPoint("flattening to image"),o("flatten-to-image",{source:m});const w=await VB(d,S,d.options.flattenImageBoundsExpand);w?.length&&d.setSelectedShapes(w)}},{id:"select-geo-tool",kbd:"g",onSelect:async m=>{o("select-tool",{source:m,id:"geo-previous"}),d.setCurrentTool("geo")}},{id:"change-page-prev",kbd:"alt+left,alt+up",readonlyOk:!0,onSelect:async m=>{const S=d.getPages(),w=S.findIndex(P=>P.id===d.getCurrentPageId());w<1||(o("change-page",{source:m,direction:"prev"}),d.setCurrentPage(S[w-1].id))}},{id:"change-page-next",kbd:"alt+right,alt+down",readonlyOk:!0,onSelect:async m=>{const S=d.getPages(),w=S.findIndex(P=>P.id===d.getCurrentPageId());if(w===-1||w>=S.length-1){if(d.getCurrentPageShapes().length<=0||d.getIsReadonly())return;o("new-page",{source:m}),d.run(()=>{d.markHistoryStoppingPoint("creating page");const P=zn.createId();d.createPage({name:r.msg("page-menu.new-page-initial-name"),id:P}),d.setCurrentPage(P)});return}d.setCurrentPage(S[w+1].id),o("change-page",{source:m,direction:"next"})}},{id:"adjust-shape-styles",label:"a11y.adjust-shape-styles",kbd:"cmd+Enter,ctrl+Enter",isRequiredA11yAction:!0,onSelect:async m=>{if(!f())return;const S=d.getOnlySelectedShape();if(S&&(d.isShapeOfType(S,"image")||d.isShapeOfType(S,"video"))){d.getContainer().querySelector(".tlui-contextual-toolbar button:first-child")?.focus();return}d.getContainer().querySelector(".tlui-style-panel button")?.focus(),o("adjust-shape-styles",{source:m})}},{id:"a11y-open-context-menu",kbd:"cmd+shift+Enter,ctrl+shift+Enter",isRequiredA11yAction:!0,readonlyOk:!0,onSelect:async m=>{if(!f())return;const S=d.getSelectionPageBounds();if(!S)return;const w=S.x+S.width/2,P=S.y+S.height/2,_=d.pageToScreen(new b(w,P));d.getContainer().querySelector(".tl-canvas")?.dispatchEvent(new PointerEvent("contextmenu",{clientX:_.x,clientY:_.y,bubbles:!0})),o("open-context-menu",{source:m})}},{id:"enlarge-shapes",label:"a11y.enlarge-shape",kbd:"cmd+alt+shift+=,ctrl+alt+shift+=",onSelect:async m=>{g(1.1),o("enlarge-shapes",{source:m})}},{id:"shrink-shapes",label:"a11y.shrink-shape",kbd:"cmd+alt+shift+-,ctrl+alt+shift+-",onSelect:async m=>{g(1/1.1),o("shrink-shapes",{source:m})}},{id:"a11y-repeat-shape-announce",kbd:"alt+r",label:"a11y.repeat-shape",isRequiredA11yAction:!0,readonlyOk:!0,onSelect:async m=>{const S=d.getSelectedShapeIds();if(!S.length)return;const w=LT({editor:d,selectedShapeIds:S,msg:c});w&&(a.announce({msg:""}),d.timers.requestAnimationFrame(()=>{a.announce({msg:w})}),o("a11y-repeat-shape-announce",{source:m}))}},{id:"image-replace",label:"tool.replace-media",icon:"arrow-cycle",readonlyOk:!1,onSelect:async m=>{o("image-replace",{source:m}),r.replaceImage()}},{id:"video-replace",label:"tool.replace-media",icon:"arrow-cycle",readonlyOk:!1,onSelect:async m=>{o("video-replace",{source:m}),r.replaceVideo()}},{id:"download-original",label:"action.download-original",readonlyOk:!0,onSelect:async m=>{const S=d.getSelectedShapes();if(S.length===0)return;const w=S.filter(P=>WE(P,d));if(w.length!==0){for(const P of w){const _=d.getAsset(P.props.assetId);if(!_||!_.props.src)continue;const I=await d.resolveAssetUrl(_.id,{shouldResolveToOriginal:!0});if(!I)return;const C=document.createElement("a");C.href=I,(_.type==="video"||_.type==="image")&&!_.props.src.startsWith("asset:")?C.download=_.props.name:C.download="download",document.body.appendChild(C),C.click(),document.body.removeChild(C)}o("download-original",{source:m})}}}];s&&x.push({id:"open-cursor-chat",label:"action.open-cursor-chat",readonlyOk:!0,kbd:"/",onSelect(m){o("open-cursor-chat",{source:m}),!d.getInstanceState().isCoarsePointer&&d.timers.requestAnimationFrame(()=>{d.updateInstanceState({isChatting:!0})})}});const y=Y8(x);return t?t(d,y,r):y},[r,n,o,t,l,s,c,a,i]);return h.jsx(KE.Provider,{value:u,children:e})}function Tr(){const t=v.useContext(KE);if(!t)throw new Error("useTools must be used within a ToolProvider");return t}function jc(t,e){return t?typeof t=="string"?t:e?t[e]??t.default:void 0:void 0}function Ts({actionId:t="",...e}){const s=Tr()[t];return s?h.jsx(ol,{...s,...e}):null}function qE(){return v6()?h.jsx(W,{actionId:"toggle-auto-size"}):null}function GE(){return lE()?h.jsx(W,{actionId:"edit-link"}):null}function X8(){return Yn(1)?h.jsx(W,{actionId:"duplicate"}):null}function YE(){const t=z();return $("should display flatten option",()=>{if(t.getSelectedShapeIds().length===0)return!1;const s=t.getOnlySelectedShape();return!(s&&t.isShapeOfType(s,"image"))},[t])?h.jsx(W,{actionId:"flatten-to-image"}):null}function Z8(){const t=z();return $("should display download original option",()=>{const n=t.getSelectedShapes();return n.length===0?!1:n.some(s=>WE(s,t))},[t])?h.jsx(W,{actionId:"download-original"}):null}function VE(){return oE()?h.jsx(W,{actionId:"group"}):null}function XE(){return aE()?h.jsx(W,{actionId:"ungroup"}):null}function ZE(){const t=z();return $("allow unframe",()=>{const n=t.getSelectedShapes();return n.length===0?!1:n.every(s=>t.isShapeOfType(s,"frame"))},[t])?h.jsx(W,{actionId:"remove-frame"}):null}function JE(){const t=z();return $("allow fit frame to content",()=>{const n=t.getOnlySelectedShape();return n?t.isShapeOfType(n,"frame")&&t.getSortedChildIdsForParent(n).length>0:!1},[t])?h.jsx(W,{actionId:"fit-frame-to-content"}):null}function QE(){const t=z();return $("selected shapes",()=>t.getSelectedShapes().length>0,[t])?h.jsx(W,{actionId:"toggle-lock"}):null}function Uy(){const t=z(),e=$("isTransparentBg",()=>!t.getInstanceState().exportBackground,[t]);return h.jsx(Ts,{actionId:"toggle-transparent",checked:e,toggle:!0})}function J8(){const t=z(),e=$("any shapes",()=>t.getCurrentPageShapeIds().size>0,[t]);return h.jsx(W,{actionId:"unlock-all",disabled:!e})}function Hy(){const t=z(),e=$("zoomed to 100",()=>t.getEfficientZoomLevel()===1,[t]);return h.jsx(W,{actionId:"zoom-to-100",noClose:!0,disabled:e})}function e2(){const t=z(),e=$("has shapes",()=>t.getCurrentPageShapeIds().size>0,[t]);return h.jsx(W,{actionId:"zoom-to-fit",disabled:!e,"data-testid":"minimap.zoom-menu.zoom-to-fit",noClose:!0})}function t2(){const t=z(),e=$("has shapes",()=>t.getSelectedShapeIds().length>0,[t]);return h.jsx(W,{actionId:"zoom-to-selection",disabled:!e,"data-testid":"minimap.zoom-menu.zoom-to-selection",noClose:!0})}function n2(){return h.jsxs(Ae,{id:"clipboard",children:[h.jsx(e9,{}),h.jsx(t9,{}),h.jsx(n9,{}),h.jsx(X8,{}),h.jsx(s9,{})]})}function Q8(){const t=z(),e=$("atLeastOneShapeOnPage",()=>t.getCurrentPageShapeIds().size>0,[t]);return h.jsxs(Tn,{id:"copy-as",label:"context-menu.copy-as",size:"small",disabled:!e,children:[h.jsxs(Ae,{id:"copy-as-group",children:[h.jsx(W,{actionId:"copy-as-svg"}),!!window.navigator.clipboard?.write&&h.jsx(W,{actionId:"copy-as-png"})]}),h.jsx(Ae,{id:"copy-as-bg",children:h.jsx(Uy,{})})]})}function e9(){const t=Yn(1);return h.jsx(W,{actionId:"cut",disabled:!t})}function t9(){const t=cE(1);return h.jsx(W,{actionId:"copy",disabled:!t})}function n9(){const t=w6;return h.jsx(W,{actionId:"paste",disabled:!t})}function s2(){const t=z();return $("atLeastOneShapeOnPage",()=>t.getCurrentPageShapeIds().size>0,[t])?h.jsxs(Ae,{id:"conversions",children:[h.jsx(Q8,{}),h.jsxs(Tn,{id:"export-as",label:"context-menu.export-as",size:"small",children:[h.jsxs(Ae,{id:"export-as-group",children:[h.jsx(W,{actionId:"export-as-svg"}),h.jsx(W,{actionId:"export-as-png"})]}),h.jsx(Ae,{id:"export-as-bg",children:h.jsx(Uy,{})})]}),h.jsx(Z8,{})]}):null}function r2(){const t=z(),e=$("atLeastOneShapeOnPage",()=>t.getCurrentPageShapeIds().size>0,[t]);return h.jsx(W,{actionId:"select-all",disabled:!e})}function s9(){const t=Yn(1);return h.jsx(W,{actionId:"delete",disabled:!t})}function r9(){const t=_s();return!cE(1)||t?null:h.jsxs(Tn,{id:"edit",label:"context-menu.edit",size:"small",children:[h.jsx(VE,{}),h.jsx(XE,{}),h.jsx(YE,{}),h.jsx(GE,{}),h.jsx(JE,{}),h.jsx(ZE,{}),h.jsx(o2,{}),h.jsx(i2,{}),h.jsx(qE,{}),h.jsx(QE,{})]})}function i9(){const t=Yn(2),e=P6();return _s()||!(t||e)?null:h.jsxs(Tn,{id:"arrange",label:"context-menu.arrange",size:"small",children:[t&&h.jsxs(Ae,{id:"align",children:[h.jsx(W,{actionId:"align-left"}),h.jsx(W,{actionId:"align-center-horizontal"}),h.jsx(W,{actionId:"align-right"}),h.jsx(W,{actionId:"align-top"}),h.jsx(W,{actionId:"align-center-vertical"}),h.jsx(W,{actionId:"align-bottom"})]}),h.jsx(o9,{}),t&&h.jsxs(Ae,{id:"stretch",children:[h.jsx(W,{actionId:"stretch-horizontal"}),h.jsx(W,{actionId:"stretch-vertical"})]}),(t||e)&&h.jsxs(Ae,{id:"flip",children:[h.jsx(W,{actionId:"flip-horizontal"}),h.jsx(W,{actionId:"flip-vertical"})]}),h.jsx(a9,{})]})}function o9(){return Yn(3)?h.jsxs(Ae,{id:"distribute",children:[h.jsx(W,{actionId:"distribute-horizontal"}),h.jsx(W,{actionId:"distribute-vertical"})]}):null}function a9(){const t=Yn(2),e=iE();return t?h.jsxs(Ae,{id:"order",children:[h.jsx(W,{actionId:"pack"}),e&&h.jsx(W,{actionId:"stack-horizontal"}),e&&h.jsx(W,{actionId:"stack-vertical"})]}):null}function c9(){const t=_s(),e=Yn(1);return t||!e?null:h.jsx(Tn,{id:"reorder",label:"context-menu.reorder",size:"small",children:h.jsxs(Ae,{id:"reorder",children:[h.jsx(W,{actionId:"bring-to-front"}),h.jsx(W,{actionId:"bring-forward"}),h.jsx(W,{actionId:"send-backward"}),h.jsx(W,{actionId:"send-to-back"})]})})}function l9(){const t=z(),e=$("pages",()=>t.getPages(),[t]),n=$("current page id",()=>t.getCurrentPageId(),[t]),{addToast:s}=oi(),r=St(),i=_s();return!Yn(1)||i?null:h.jsxs(Tn,{id:"move-to-page",label:"context-menu.move-to-page",size:"small",children:[h.jsx(Ae,{id:"pages",children:e.map(a=>h.jsx($e,{id:a.id,disabled:n===a.id,label:a.name.length>30?`${a.name.slice(0,30)}…`:a.name,onSelect:()=>{t.markHistoryStoppingPoint("move_shapes_to_page"),t.moveShapesToPage(t.getSelectedShapeIds(),a.id);const c=t.getPage(a.id);c&&s({title:"Changed page",description:`Moved to ${c.name}.`,actions:[{label:"Go back",type:"primary",onClick:()=>{t.markHistoryStoppingPoint("change-page"),t.setCurrentPage(n)}}]}),r("move-to-page",{source:"context-menu"})}},a.id))}),h.jsx(Ae,{id:"new-page",children:h.jsx(W,{actionId:"move-to-new-page"})})]})}function i2(){const t=z();return $("oneEmbedSelected",()=>{const n=t.getOnlySelectedShape();return n?!!(t.isShapeOfType(n,"embed")&&n.props.url&&!t.isShapeOrAncestorLocked(n)):!1},[t])?h.jsx(W,{actionId:"convert-to-bookmark"}):null}function o2(){const t=z(),e=ky();return $("oneEmbeddableBookmarkSelected",()=>{const s=t.getOnlySelectedShape();return s?!!(t.isShapeOfType(s,"bookmark")&&s.props.url&&e(s.props.url)&&!t.isShapeOrAncestorLocked(s)):!1},[t])?h.jsx(W,{actionId:"convert-to-embed"}):null}function d9(){const t=z(),e=$("isSnapMode",()=>t.user.getIsSnapMode(),[t]);return h.jsx(Ts,{actionId:"toggle-snap-mode",checked:e})}function u9(){const t=z(),e=$("isToolLock",()=>t.getInstanceState().isToolLocked,[t]);return h.jsx(Ts,{actionId:"toggle-tool-lock",checked:e})}function h9(){const t=z(),e=$("isGridMode",()=>t.getInstanceState().isGridMode,[t]);return h.jsx(Ts,{actionId:"toggle-grid",checked:e})}function p9(){const t=z(),e=$("isWrapMode",()=>t.user.getIsWrapMode(),[t]);return h.jsx(Ts,{actionId:"toggle-wrap-mode",checked:e})}function f9(){const t=z(),e=$("isFocusMode",()=>t.getInstanceState().isFocusMode,[t]);return h.jsx(Ts,{actionId:"toggle-focus-mode",checked:e})}function g9(){const t=z(),e=$("edgeScrollSpeed",()=>t.user.getEdgeScrollSpeed(),[t]);return h.jsx(Ts,{actionId:"toggle-edge-scrolling",checked:e===1})}function m9(){const t=z(),e=$("animationSpeed",()=>t.user.getAnimationSpeed(),[t]);return h.jsx(Ts,{actionId:"toggle-reduce-motion",checked:e===0})}function y9(){const t=z(),e=$("keyboardShortcuts",()=>t.user.getAreKeyboardShortcutsEnabled(),[t]);return h.jsx(Ts,{actionId:"toggle-keyboard-shortcuts",checked:e})}function S9(){const t=z(),e=$("enhancedA11yMode",()=>t.user.getEnhancedA11yMode(),[t]);return h.jsx(Ts,{actionId:"enhanced-a11y-mode",checked:e})}function x9(){const t=z(),e=$("isDebugMode",()=>t.getInstanceState().isDebugMode,[t]);return h.jsx(Ts,{actionId:"toggle-debug-mode",checked:e})}function b9(){const t=z(),e=$("dynamic resize",()=>t.user.getIsDynamicResizeMode(),[t]);return h.jsx(Ts,{actionId:"toggle-dynamic-size-mode",checked:e})}function w9(){const t=z(),e=$("paste at cursor",()=>t.user.getIsPasteAtCursorMode(),[t]);return h.jsx(Ts,{actionId:"toggle-paste-at-cursor",checked:e})}function v9(){const t=z();return $("show cursor chat",()=>t.getCurrentToolId()==="select"&&!t.getInstanceState().isCoarsePointer,[t])?h.jsx(W,{actionId:"open-cursor-chat"}):null}function P9(){return h.jsx(Tn,{id:"help menu accessibility",label:"menu.accessibility",children:h.jsxs(Ae,{id:"accessibility",children:[h.jsx(m9,{}),h.jsx(y9,{}),h.jsx(S9,{})]})})}class I9 extends u4{static type="arrow";static props=U1;static migrations=H1;getDefaultProps(){return{isPrecise:!1,isExact:!1,normalizedAnchor:{x:.5,y:.5},snap:"none"}}onAfterCreate({binding:e}){const n=this.editor.getShape(e.fromId);n&&og(this.editor,n)}onAfterChange({bindingAfter:e}){const n=this.editor.getShape(e.fromId);n&&og(this.editor,n)}onAfterChangeFromShape({shapeAfter:e}){og(this.editor,e)}onAfterChangeToShape({binding:e,shapeBefore:n,shapeAfter:s,reason:r}){r!=="ancestry"&&n.parentId===s.parentId&&n.index===s.index||a2(this.editor,e.fromId)}onBeforeIsolateFromShape({binding:e}){const n=this.editor.getShape(e.fromId);n&&Ud({editor:this.editor,arrow:n,terminal:e.props.terminal})}}function a2(t,e){const n=t.getShape(e);if(!n)return;const s=Vt(t,n),{start:r,end:i}=s,o=r?t.getShape(r.toId):void 0,a=i?t.getShape(i.toId):void 0,c=t.getAncestorPageId(n);if(!c)return;let l;if(o&&a)l=t.findCommonAncestor([o,a])??c;else if(o||a){const y=(o||a)?.parentId;y&&y===n.parentId?l=n.parentId:l=c}else return;l&&l!==n.parentId&&t.reparentShapes([e],l);const u=t.getShape(e);if(!u)throw Error("no reparented arrow");const d=t.getShapeNearestSibling(u,o),p=t.getShapeNearestSibling(u,a);let f;if(d&&p)f=d.index>p.index?d:p;else if(d&&!p)f=d;else if(p&&!d)f=p;else return;let g;const x=t.getSortedChildIdsForParent(f.parentId).map(y=>t.getShape(y)).filter(y=>y.index>f.index);if(x.length){const y=x.find(m=>m.type!=="arrow");if(u.index>f.index&&(!y||u.index<y.index))return;g=Qo(f.index,x[0].index)}else g=Ls(f.index);g!==u.index&&t.updateShapes([{id:e,type:"arrow",index:g}])}function og(t,e){const n=Vt(t,e);for(const s of["start","end"]){const r=n[s];if(!r)continue;const i=t.getShape(r.toId),o=t.getAncestorPageId(e)===t.getAncestorPageId(i);(!i||!o)&&Ud({editor:t,arrow:e,terminal:s,unbind:!0})}a2(t,e.id)}function Ud({editor:t,arrow:e,terminal:n,unbind:s=!1,useHandle:r=!1}){const i=Os(t,e);if(!i)throw new Error("expected arrow info");const o=r?i.start.handle:i.start.point,a=r?i.end.handle:i.end.point,c=n==="start"?o:a,l={id:e.id,type:"arrow",props:{[n]:{x:c.x,y:c.y},bend:e.props.bend}};if(i.type==="arc"){const u=n==="start"?o:i.start.handle,d=n==="end"?a:i.end.handle,p=b.Med(u,d),f=b.Sub(u,d).per().uni().mul(i.handleArc.radius*2*Math.sign(e.props.bend)),g=Xc(i.handleArc.center,b.Add(p,f),i.handleArc.center,i.handleArc.radius);le(g?.length===1);const x=b.Dist(p,g[0])*Math.sign(e.props.bend);Dt(x,l.props.bend)||(l.props.bend=x)}t.updateShape(l),s&&ec(t,e,n)}function _9({size:t,width:e,height:n,hideAlternateHandles:s}){const r=F(t/3),i=r/2,o=ae();return h.jsxs("svg",{className:"tl-overlays__item","aria-hidden":"true",children:[h.jsx("polyline",{className:"tl-corner-crop-handle",points:`
						${F(0-i)},${F(t)} 
						${F(0-i)},${F(0-i)} 
						${F(t)},${F(0-i)}`,strokeWidth:r,"data-testid":"selection.crop.top_left",role:"button","aria-label":o("handle.crop.top-left")}),h.jsx("line",{className:de("tl-corner-crop-edge-handle",{"tl-hidden":s}),x1:F(e/2-t),y1:F(0-i),x2:F(e/2+t),y2:F(0-i),strokeWidth:r,"data-testid":"selection.crop.top",role:"button","aria-label":o("handle.crop.top")}),h.jsx("polyline",{className:de("tl-corner-crop-handle",{"tl-hidden":s}),points:`
						${F(e-t)},${F(0-i)} 
						${F(e+i)},${F(0-i)} 
						${F(e+i)},${F(t)}`,strokeWidth:r,"data-testid":"selection.crop.top_right",role:"button","aria-label":o("handle.crop.top-right")}),h.jsx("line",{className:de("tl-corner-crop-edge-handle",{"tl-hidden":s}),x1:F(e+i),y1:F(n/2-t),x2:F(e+i),y2:F(n/2+t),strokeWidth:r,"data-testid":"selection.crop.right",role:"button","aria-label":o("handle.crop.right")}),h.jsx("polyline",{className:"tl-corner-crop-handle",points:`
						${F(e+i)},${F(n-t)} 
						${F(e+i)},${F(n+i)}
						${F(e-t)},${F(n+i)}`,strokeWidth:r,"data-testid":"selection.crop.bottom_right",role:"button","aria-label":o("handle.crop.bottom-right")}),h.jsx("line",{className:de("tl-corner-crop-edge-handle",{"tl-hidden":s}),x1:F(e/2-t),y1:F(n+i),x2:F(e/2+t),y2:F(n+i),strokeWidth:r,"data-testid":"selection.crop.bottom",role:"button","aria-label":o("handle.crop.bottom")}),h.jsx("polyline",{className:de("tl-corner-crop-handle",{"tl-hidden":s}),points:`
						${F(0+t)},${F(n+i)} 
						${F(0-i)},${F(n+i)}
						${F(0-i)},${F(n-t)}`,strokeWidth:r,"data-testid":"selection.crop.bottom_left",role:"button","aria-label":o("handle.crop.bottom-left")}),h.jsx("line",{className:de("tl-corner-crop-edge-handle",{"tl-hidden":s}),x1:F(0-i),y1:F(n/2-t),x2:F(0-i),y2:F(n/2+t),strokeWidth:r,"data-testid":"selection.crop.left",role:"button","aria-label":o("handle.crop.left")})]})}function C9({children:t}){const e=z();return $("shouldDisplayHandles",()=>{if(e.isInAny("select.idle","select.pointing_handle","select.pointing_shape"))return!0;if(e.isInAny("select.editing_shape")){const s=e.getOnlySelectedShape();return s&&e.isShapeOfType(s,"note")}return!1},[e])?h.jsx("svg",{className:"tl-user-handles tl-overlays__item","aria-hidden":"true",children:t}):null}const T9=new dn;function gc(t){return T9.get(t,()=>je("arrowTarget",null))}function E9(t){return gc(t).get()}function Ky(t){gc(t).set(null)}function $u({editor:t,pointInPageSpace:e,arrow:n,isPrecise:s,currentBinding:r,oppositeBinding:i}){const o=t.getShapeUtil("arrow");if(o.options.shouldIgnoreTargets(t))return gc(t).set(null),null;const a=n?n.props.kind:t.getStyleForNextShape(_d),c=t.getShapeAtPoint(e,{hitInside:!0,hitFrameInside:!0,margin:a==="elbow"?8:[8,0],filter:L=>!L.isLocked&&t.canBindShapes({fromShape:n??k9,toShape:L,binding:"arrow"})});if(!c)return gc(t).set(null),null;const l=t.getShapeGeometry(c),u=X.ZeroFix(l.bounds),d=l.center,p=t.getShapePageTransform(c),f=t.getPointInShapeSpace(c,e),g=Math.max(l.bounds.width,l.bounds.height),x=Oi(JB,(L,U)=>{const V=Ec[QB[L]],J=b.Mul(U,g).add(d);let Z=!1,Q=V.v(u[L],u[V.crossMid]),Y=0;const Ie=l.intersectLineSegment(d,J,Sr.EXCLUDE_NON_STANDARD);for(const me of Ie){const ne=b.Dist2(me,d);ne>Y&&(Y=ne,Q=me,Z=l.isClosed)}return{point:p.applyToPoint(Q),isEnabled:Z,far:p.applyToPoint(J)}}),y=t.getZoomLevel(),m=o.options.minElbowHandleDistance/y,S=p.applyToPoint(d);for(const L of ac(x)){const U=x[L];b.DistMin(U.point,S,m)&&(U.isEnabled=!1)}let w=s;w||(!r||r&&c.id!==r.toId)&&(w=t.inputs.getPointerVelocity().len()<.5),s||(l.isClosed||(w=!0),i&&c.id===i.toId&&i.props.isPrecise&&(w=!0));const P=o.options.shouldBeExact(t,w);P&&(w=!0);const _=!P&&w&&l.isClosed,I=!P&&(w&&a==="elbow"||!l.isClosed),C=!P&&w&&a==="elbow"&&l.isClosed,E=w&&(l.isClosed||P),O=!P&&w&&a==="elbow"&&l.isClosed;let k="none",T=e;if(E||(k="center",T=S),I){const L=E?Vl(t,u,o.options.elbowArrowEdgeSnapDistance):1/0,U=l.nearestPoint(f,{includeLabels:!1,includeInternal:!1}),V=p.applyToPoint(U);b.Dist(V,e)<L&&(k="edge",T=V)}if(O){const L=Vl(t,u,o.options.elbowArrowAxisSnapDistance),U=b.DistanceToLineSegment(x.left.far,x.right.far,e),V=b.DistanceToLineSegment(x.top.far,x.bottom.far,e),J=U<V&&U<L?"x":V<L?"y":null;if(J){const Z=Ec[J],Q=b.Dist2(x[Z.loEdge].far,e),Y=b.Dist2(x[Z.hiEdge].far,e),Ie=Q<Y?Z.loEdge:Z.hiEdge;x[Ie].isEnabled&&(k="edge-point",T=x[Ie].point)}}if(C){const L=Vl(t,u,o.options.elbowArrowPointSnapDistance);let U=null,V=1/0;for(const[J,Z]of zs(x)){if(!Z.isEnabled)continue;const Q=b.Dist(Z.point,e);Q<L&&Q<V&&(V=Q,U=J)}U&&(k="edge-point",T=x[U].point)}if(_){const L=Vl(t,u,a==="elbow"?o.options.elbowArrowCenterSnapDistance:o.options.arcArrowCenterSnapDistance);b.Dist(f,u.center)<L&&(k="center",T=S)}const D=t.getPointInShapeSpace(c,T),R={x:xc(u.minX,u.maxX,D.x),y:xc(u.minY,u.maxY,D.y)},M={target:c,arrowKind:a,handlesInPageSpace:x,centerInPageSpace:S,anchorInPageSpace:T,isExact:P,isPrecise:w,snap:k,normalizedAnchor:R};return gc(t).set(M),M}const k9={type:"arrow"};function Vl(t,e,n){return Ce(Math.min(e.width,e.height)*.15,4,n)/t.getZoomLevel()}function A9(){const t=z();return $("should show arrow hints",()=>{if(t.isInAny("arrow.idle","arrow.pointing"))return!0;if(t.isIn("select.pointing_handle")){const n=t.getStateDescendant("select.pointing_handle");if(n.info.shape.type==="arrow"&&(n.info.handle.id==="start"||n.info.handle.id==="end"))return!0}if(t.isIn("select.dragging_handle")){const n=t.getStateDescendant("select.dragging_handle");if(n.info.shape.type==="arrow"&&(n.info.handle.id==="start"||n.info.handle.id==="end"))return!0}return!1},[t])?h.jsx(M9,{}):null}function M9(){const t=z(),{ShapeIndicator:e}=nt(),n=$("arrow target info",()=>E9(t),[t]);if(!n)return null;const{handlesInPageSpace:s,snap:r,anchorInPageSpace:i,arrowKind:o,isExact:a,isPrecise:c}=n,l=!a&&o==="elbow";return h.jsxs(h.Fragment,{children:[e&&h.jsx(e,{shapeId:n.target.id}),l&&h.jsxs("svg",{className:"tl-overlays__item","aria-hidden":"true",children:[h.jsx("circle",{cx:i.x,cy:i.y,className:`tl-arrow-hint-snap tl-arrow-hint-snap__${c?r??"none":"none"}`}),Object.entries(s).map(([u,d])=>d.isEnabled?h.jsx("circle",{cx:d.point.x,cy:d.point.y,className:"tl-arrow-hint-handle"},u):null)]})]})}const{PI:j9}=Math,Zo=j9+1e-4;function c2(t,e={}){const{size:n=16,smoothing:s=.5}=e;if(t.length===0||n<=0)return{left:[],right:[]};const r=t[0],i=t[t.length-1],o=i.runningLength,a=Math.pow(n*s,2),c=[],l=[];let u=t[0].vector,d=t[0].point,p=d,f=d,g=p,x=!1,y;for(let m=0;m<t.length;m++){y=t[m];const{point:S,vector:w}=t[m],P=y.vector.dpr(u),_=(m<t.length-1?t[m+1]:t[m]).vector,I=m<t.length-1?_.dpr(y.vector):1,C=P<0&&!x,E=I!==null&&I<.2;if(C||E){if(I>-.62&&o-y.runningLength>y.radius){const k=u.clone().mul(y.radius);u.clone().cpr(_)<0?(f=b.Add(S,k),g=b.Sub(S,k)):(f=b.Sub(S,k),g=b.Add(S,k)),c.push(f),l.push(g)}else{const k=u.clone().mul(y.radius).per(),T=b.Sub(y.input,k);for(let D=1/13,R=0;R<1;R+=D)f=b.RotWith(T,y.input,Zo*R),c.push(f),g=b.RotWith(T,y.input,Zo+Zo*-R),l.push(g)}d=f,p=g,E&&(x=!0);continue}if(x=!1,y===r||y===i){const k=b.Per(w).mul(y.radius);c.push(b.Sub(S,k)),l.push(b.Add(S,k));continue}const O=b.Lrp(_,w,I).per().mul(y.radius);f=b.Sub(S,O),(m<=1||b.Dist2(d,f)>a)&&(c.push(f),d=f),g=b.Add(S,O),(m<=1||b.Dist2(p,g)>a)&&(l.push(g),p=g),u=w}return{left:c,right:l}}function l2(t,e={}){const{size:n=16,start:s={},end:r={},last:i=!1}=e,{cap:o=!0}=s,{cap:a=!0}=r;if(t.length===0||n<=0)return[];const c=t[0],l=t[t.length-1],u=l.runningLength,d=s.taper===!1?0:s.taper===!0?Math.max(n,u):s.taper,p=r.taper===!1?0:r.taper===!0?Math.max(n,u):r.taper,{left:f,right:g}=c2(t,e),x=c.point,y=t.length>1?t[t.length-1].point:b.AddXY(c.point,1,1);if(t.length===1&&(!(d||p)||i)){const P=b.Add(x,b.Sub(x,y).uni().per().mul(-c.radius)),_=[];for(let I=1/13,C=I;C<=1;C+=I)_.push(b.RotWith(P,x,Zo*2*C));return _}const m=[];if(!(d||p&&t.length===1))if(o)for(let P=1/8,_=P;_<=1;_+=P){const I=b.RotWith(g[0],x,Zo*_);m.push(I)}else{const P=b.Sub(f[0],g[0]),_=b.Mul(P,.5),I=b.Mul(P,.51);m.push(b.Sub(x,_),b.Sub(x,I),b.Add(x,I),b.Add(x,_))}const S=[],w=l.vector.clone().per().neg();if(p||d&&t.length===1)S.push(y);else if(a){const P=b.Add(y,b.Mul(w,l.radius));for(let _=1/29,I=_;I<1;I+=_)S.push(b.RotWith(P,y,Zo*3*I))}else S.push(b.Add(y,b.Mul(w,l.radius)),b.Add(y,b.Mul(w,l.radius*.99)),b.Sub(y,b.Mul(w,l.radius*.99)),b.Sub(y,b.Mul(w,l.radius)));return f.concat(S,g.reverse(),m)}const D9=.025,O9=.01;function Ai(t,e={}){const{streamline:n=.5,size:s=16,simulatePressure:r=!1}=e;if(t.length===0)return[];const i=.15+(1-n)*.85;let o=t.map(b.From),a=0;if(!r){let y=o[0];for(;y&&!(y.z>=D9);)o.shift(),y=o[0]}if(!r){let y=o[o.length-1];for(;y&&!(y.z>=O9);)o.pop(),y=o[o.length-1]}if(o.length===0)return[{point:b.From(t[0]),input:b.From(t[0]),pressure:r?.5:.15,vector:new b(1,1),distance:0,runningLength:0,radius:1}];let c=o[1];for(;c&&!(b.Dist2(c,o[0])>(s/3)**2);)o[0].z=Math.max(o[0].z,c.z),o.splice(1,1),c=o[1];const l=o.pop();for(c=o[o.length-1];c&&!(b.Dist2(c,l)>(s/3)**2);)o.pop(),c=o[o.length-1],a++;o.push(l);const u=e.last||!e.simulatePressure||o.length>1&&b.Dist2(o[o.length-1],o[o.length-2])<s**2||a>0;if(o.length===2&&e.simulatePressure){const y=o[1];o=o.slice(0,-1);for(let m=1;m<5;m++){const S=b.Lrp(o[0],y,m/4);S.z=(o[0].z+(y.z-o[0].z))*m/4,o.push(S)}}const d=[{point:o[0],input:o[0],pressure:r?.5:o[0].z,vector:new b(1,1),distance:0,runningLength:0,radius:1}];let p=0,f=d[0],g,x;u&&n>0&&o.push(o[o.length-1].clone());for(let y=1,m=o.length;y<m;y++)g=!i||e.last&&y===m-1?o[y].clone():o[y].clone().lrp(f.point,1-i),!f.point.equals(g)&&(x=b.Dist(g,f.point),p+=x,!(y<4&&p<s)&&(f={input:o[y],point:g,pressure:r?.5:o[y].z,vector:b.Sub(f.point,g).uni(),distance:x,runningLength:p,radius:1},d.push(f)));if(d[1]?.vector&&(d[0].vector=d[1].vector.clone()),p<1){const y=Math.max(.5,...d.map(m=>m.pressure));d.forEach(m=>m.pressure=y)}return d}const{min:mi}=Math,ag=.275;function Wy(t,e){const{size:n=16,thinning:s=.5,simulatePressure:r=!0,easing:i=y=>y,start:o={},end:a={}}=e,{easing:c=Pn.easeOutQuad}=o,{easing:l=Pn.easeOutCubic}=a,u=t[t.length-1].runningLength;let d,p=t[0].pressure,f;if(!r&&u<n){const y=t.reduce((m,S)=>Math.max(m,S.pressure),.5);return t.forEach(m=>{m.pressure=y,m.radius=n*i(.5-s*(.5-m.pressure))}),t}else{let y;for(let m=0,S=t.length;m<S&&(f=t[m],!(f.runningLength>n*5));m++){const w=mi(1,f.distance/n);if(r){const P=mi(1,1-w);y=mi(1,p+(P-p)*(w*ag))}else y=mi(1,p+(f.pressure-p)*.5);p=p+(y-p)*.5}for(let m=0;m<t.length;m++){if(f=t[m],s){let{pressure:S}=f;const w=mi(1,f.distance/n);if(r){const P=mi(1,1-w);S=mi(1,p+(P-p)*(w*ag))}else S=mi(1,p+(S-p)*(w*ag));f.radius=n*i(.5-s*(.5-S)),p=S}else f.radius=n/2;d===void 0&&(d=f.radius)}}const g=o.taper===!1?0:o.taper===!0?Math.max(n,u):o.taper,x=a.taper===!1?0:a.taper===!0?Math.max(n,u):a.taper;if(g||x)for(let y=0;y<t.length;y++){f=t[y];const{runningLength:m}=f,S=m<g?c(m/g):1,w=u-m<x?l((u-m)/x):1;f.radius=Math.max(.01,f.radius*Math.min(S,w))}return t}function L9(t,e={}){return l2(Wy(Ai(t,e),e),e)}function Ov({scribble:t,zoom:e,color:n,opacity:s,className:r}){if(!t.points.length)return null;const i=L9(t.points,{size:t.size/e,start:{taper:t.taper,easing:Pn.linear},last:t.state==="stopping",simulatePressure:!1,streamline:.32});let o;if(i.length<4){const a=t.size/e/2,{x:c,y:l}=t.points[t.points.length-1];o=`M ${c-a},${l} a ${a},${a} 0 1,0 ${a*2},0 a ${a},${a} 0 1,0 ${-a*2},0`}else o=bT(i);return h.jsx("svg",{className:r&&de("tl-overlays__item",r),children:h.jsx("path",{className:"tl-scribble",d:o,fill:n??`var(--tl-color-${t.color})`,opacity:s??t.opacity})})}const R9=Ot(function({bounds:e,rotation:n}){const s=z(),r=ae(),i=v.useRef(null),o=_s(),a=pr("top"),c=pr("right"),l=pr("bottom"),u=pr("left"),d=pr("top_left"),p=pr("top_right"),f=pr("bottom_right"),g=pr("bottom_left"),x=s.getInstanceState().cursor.type==="default",y=s.getInstanceState().isCoarsePointer,m=s.getOnlySelectedShape(),S=m&&s.isShapeOrAncestorLocked(m),w=m?s.getShapeUtil(m).expandSelectionOutlinePx(m):0,P=w instanceof X?e.clone().expand(w).zeroFix():e.clone().expandBy(w).zeroFix(),_=s.getSelectionRotation(),I=_/vt>1.6&&_/vt<2.4;if(qc(i,e?.x,e?.y,1,_,{x:P.x-e.x,y:P.y-e.y}),m&&s.isShapeHidden(m))return null;const C=s.getEfficientZoomLevel(),E=s.getInstanceState().isChangingStyle,O=P.width,k=P.height,T=8/C,D=O<T*2,R=k<T*2,M=O<T*4,L=k<T*4,U=O<T*5,V=k<T*5,J=y?1.75:1,Z=6/C*J,Q=(M?Z/2:Z)*(J*.75),Y=(L?Z/2:Z)*(J*.75),Ie=(m?!s.getShapeUtil(m).hideSelectionBoundsFg(m):!0)&&!E;let be=Ie&&s.isInAny("select.idle","select.brushing","select.scribble_brushing","select.pointing_canvas","select.pointing_selection","select.pointing_shape","select.crop.idle","select.crop.pointing_crop","select.crop.pointing_crop_handle","select.pointing_resize_handle")||Ie&&s.isIn("select.resizing")&&m&&s.isShapeOfType(m,"text");m&&be&&qe.isFirefox&&s.isShapeOfType(m,"embed")&&(be=!1);const me=s.isInAny("select.crop.idle","select.crop.pointing_crop","select.crop.pointing_crop_handle")&&!E&&!o,ne=s.isInAny("select.idle","select.pointing_selection","select.pointing_shape","select.crop.idle")&&!E&&!o,Me=!y&&!(D||R)&&(ne||me)&&(m?!s.getShapeUtil(m).hideRotateHandle(m):!0)&&!S,ge=y&&(!M||!L)&&(ne||me)&&(m?!s.getShapeUtil(m).hideRotateHandle(m):!0)&&!S,ce=ne&&(m?s.getShapeUtil(m).canResize(m)&&!s.getShapeUtil(m).hideResizeHandles(m):!0)&&!me&&!S,_e=D||R,ye=D&&R,ht=U||V,st=ce||me,Ze=!Me,rt=!ne||!ge,it=!ne||!st,en=!ne||!st||_e,Vn=!ne||!st||_e,cs=!ne||!st||ye&&!me;let ls=!0,kn=!0;if(me)ls=ht,kn=ht;else if(ce){ls=_e||ye||y;const li=y&&m&&m.type==="text";kn=ls&&!li}const pn=Math.min(24/C,k-Y*3),Er=ne&&y&&m&&s.isShapeOfType(m,"text")&&pn*C>=4,ci=m&&(s.isShapeOfType(m,"image")||s.isShapeOfType(m,"video"));return h.jsx("svg",{className:"tl-overlays__item tl-selection__fg","data-testid":"selection-foreground","aria-hidden":"true",children:h.jsxs("g",{ref:i,children:[be&&h.jsx("rect",{className:"tl-selection__fg__outline",width:F(O),height:F(k)}),h.jsx(Xl,{"data-testid":"selection.rotate.top-left",cx:0,cy:0,targetSize:Z,corner:"top_left_rotate",cursor:x?gs("nwse-rotate",n):void 0,isHidden:Ze}),h.jsx(Xl,{"data-testid":"selection.rotate.top-right",cx:O+Z*3,cy:0,targetSize:Z,corner:"top_right_rotate",cursor:x?gs("nesw-rotate",n):void 0,isHidden:Ze}),h.jsx(Xl,{"data-testid":"selection.rotate.bottom-left",cx:0,cy:k+Z*3,targetSize:Z,corner:"bottom_left_rotate",cursor:x?gs("swne-rotate",n):void 0,isHidden:Ze}),h.jsx(Xl,{"data-testid":"selection.rotate.bottom-right",cx:O+Z*3,cy:k+Z*3,targetSize:Z,corner:"bottom_right_rotate",cursor:x?gs("senw-rotate",n):void 0,isHidden:Ze}),h.jsx(B9,{"data-testid":"selection.rotate.mobile",cx:M?-Z*1.5:O/2,cy:M?k/2:ci&&!I?k+Z*1.5:-Z*1.5,size:T,isHidden:rt}),h.jsx(yi,{hide:ls,dataTestId:"selection.resize.top",ariaLabel:r("handle.resize-top"),x:0,y:F(0-(L?Y*2:Y)),width:F(O),height:F(Math.max(1,Y*2)),cursor:x?gs("ns-resize",n):void 0,events:a}),h.jsx(yi,{hide:kn,dataTestId:"selection.resize.right",ariaLabel:r("handle.resize-right"),x:F(O-(M?0:Q)),y:0,height:F(k),width:F(Math.max(1,Q*2)),cursor:x?gs("ew-resize",n):void 0,events:c}),h.jsx(yi,{hide:ls,dataTestId:"selection.resize.bottom",ariaLabel:r("handle.resize-bottom"),x:0,y:F(k-(L?0:Y)),width:F(O),height:F(Math.max(1,Y*2)),cursor:x?gs("ns-resize",n):void 0,events:l}),h.jsx(yi,{hide:kn,dataTestId:"selection.resize.left",ariaLabel:r("handle.resize-left"),x:F(0-(M?Q*2:Q)),y:0,height:F(k),width:F(Math.max(1,Q*2)),cursor:x?gs("ew-resize",n):void 0,events:u}),h.jsx(yi,{hide:it,dataTestId:"selection.target.top-left",ariaLabel:r("handle.resize-top-left"),x:F(0-(M?Q*2:Q*1.5)),y:F(0-(L?Y*2:Y*1.5)),width:F(Q*3),height:F(Y*3),cursor:x?gs("nwse-resize",n):void 0,events:d}),h.jsx(yi,{hide:en,dataTestId:"selection.target.top-right",ariaLabel:r("handle.resize-top-right"),x:F(O-(M?0:Q*1.5)),y:F(0-(L?Y*2:Y*1.5)),width:F(Q*3),height:F(Y*3),cursor:x?gs("nesw-resize",n):void 0,events:p}),h.jsx(yi,{hide:cs,dataTestId:"selection.target.bottom-right",ariaLabel:r("handle.resize-bottom-right"),x:F(O-(M?Q:Q*1.5)),y:F(k-(L?Y:Y*1.5)),width:F(Q*3),height:F(Y*3),cursor:x?gs("nwse-resize",n):void 0,events:f}),h.jsx(yi,{hide:Vn,dataTestId:"selection.target.bottom-left",ariaLabel:r("handle.resize-bottom-left"),x:F(0-(M?Q*3:Q*1.5)),y:F(k-(L?0:Y*1.5)),width:F(Q*3),height:F(Y*3),cursor:x?gs("nesw-resize",n):void 0,events:g}),ce&&h.jsxs(h.Fragment,{children:[h.jsx("rect",{"data-testid":"selection.resize.top-left",className:de("tl-corner-handle",{"tl-hidden":it}),x:F(0-T/2),y:F(0-T/2),width:F(T),height:F(T)}),h.jsx("rect",{"data-testid":"selection.resize.top-right",className:de("tl-corner-handle",{"tl-hidden":en}),x:F(O-T/2),y:F(0-T/2),width:F(T),height:F(T)}),h.jsx("rect",{"data-testid":"selection.resize.bottom-right",className:de("tl-corner-handle",{"tl-hidden":cs}),x:F(O-T/2),y:F(k-T/2),width:F(T),height:F(T)}),h.jsx("rect",{"data-testid":"selection.resize.bottom-left",className:de("tl-corner-handle",{"tl-hidden":Vn}),x:F(0-T/2),y:F(k-T/2),width:F(T),height:F(T)})]}),Er&&h.jsxs(h.Fragment,{children:[h.jsx("rect",{"data-testid":"selection.text-resize.left.handle",className:"tl-text-handle",x:F(0-T/4),y:F(k/2-pn/2),rx:T/4,width:F(T/2),height:F(pn)}),h.jsx("rect",{"data-testid":"selection.text-resize.right.handle",className:"tl-text-handle",rx:T/4,x:F(O-T/4),y:F(k/2-pn/2),width:F(T/2),height:F(pn)})]}),me&&h.jsx(_9,{size:T,width:O,height:k,hideAlternateHandles:ht})]})})}),yi=function({hide:e,dataTestId:n,ariaLabel:s,x:r,y:i,width:o,height:a,cursor:c,events:l}){return h.jsx("rect",{className:de("tl-resize-handle","tl-transparent",{"tl-hidden":e}),"data-testid":n,role:"button","aria-label":s,pointerEvents:"all",x:r,y:i,width:o,height:a,cursor:c,...l})},Xl=function({cx:e,cy:n,targetSize:s,corner:r,cursor:i,isHidden:o,"data-testid":a}){const c=pr(r),u=ae()(`handle.rotate.${r}`);return h.jsx("rect",{className:de("tl-transparent","tl-rotate-corner",{"tl-hidden":o}),"data-testid":a,role:"button","aria-label":u,pointerEvents:"all",x:F(e-s*3),y:F(n-s*3),width:F(Math.max(1,s*3)),height:F(Math.max(1,s*3)),cursor:i,...c})},F9=Math.sqrt(Math.PI),B9=function({cx:e,cy:n,size:s,isHidden:r,"data-testid":i}){const o=pr("mobile_rotate"),a=z(),c=$("zoom level",()=>a.getEfficientZoomLevel(),[a]),l=Math.max(14*(1/c),20/Math.max(1,c)),u=ae();return h.jsxs("g",{role:"button","aria-label":u("handle.rotate.mobile_rotate"),children:[h.jsx("circle",{"data-testid":i,pointerEvents:"all",className:de("tl-transparent","tl-mobile-rotate__bg",{"tl-hidden":r}),cx:e,cy:n,r:l,...o}),h.jsx("circle",{className:de("tl-mobile-rotate__fg",{"tl-hidden":r}),cx:e,cy:n,r:s/F9})]})};function z9(){const t=z(),e=$("is in a valid select state",()=>t.isInAny("select.idle","select.brushing","select.scribble_brushing","select.editing_shape","select.pointing_shape","select.pointing_selection","select.pointing_handle"),[t]);return h.jsx(wT,{hideAll:!e})}const d2=[I9],$n={lineHeight:1.35,fontWeight:"normal",fontVariant:"normal",fontStyle:"normal",padding:"0px"},Ht={s:2,m:3.5,l:5,xl:10},oa={s:18,m:24,l:36,xl:44},Mi={s:18,m:22,l:26,xl:32},$9={s:18,m:20,l:24,xl:28},ji={draw:"var(--tl-font-draw)",sans:"var(--tl-font-sans)",serif:"var(--tl-font-serif)",mono:"var(--tl-font-mono)"},N9=20,Vg=4.25,Rn=16;function U9(t,e){const n=t.w/e.w,s=t.h/e.h;return n<=1&&s<=1?t:n>s?{w:t.w/n,h:t.h/n}:{w:t.w/s,h:t.h/s}}async function H9(t,e,n){const{elements:s,files:r}=e,i={shapes:[],bindings:[],rootShapeIds:[],assets:[],schema:t.store.schema.serialize()},o=new Map,a=new Map,c=t.getCurrentPageId(),l=new Map,u=[],d=new Set;s.forEach(m=>{if(l.set(m.id,tt()),m.boundElements!==null)for(const S of m.boundElements)S.type==="text"&&d.add(S.id)});let p=fm;for(const m of s){if(d.has(m.id))continue;const S=l.get(m.id),w={id:S,typeName:"shape",parentId:c,index:p,x:m.x,y:m.y,rotation:0,isLocked:m.locked,opacity:K9(m.opacity),meta:{}};switch(m.angle!==0&&a.set(S,m.angle),m.groupIds&&m.groupIds.length>0?o.has(m.groupIds[0])?o.get(m.groupIds[0])?.push(S):o.set(m.groupIds[0],[S]):u.push(S),m.type){case"rectangle":case"ellipse":case"diamond":{let P="",_="middle";if(m.boundElements!==null){for(const C of m.boundElements)if(C.type==="text"){const E=s.find(O=>O.id===C.id);E&&(P=E.text,_=Z9[E.textAlign])}}const I=m.backgroundColor==="transparent"?m.strokeColor:m.backgroundColor;i.shapes.push({...w,type:"geo",props:{...t.getShapeUtil("geo").getDefaultProps(),geo:m.type,url:m.link??"",w:m.width,h:m.height,size:Zl[m.strokeWidth]??"draw",color:Na[I]??"black",richText:ln(P),align:_,dash:Jl(m),fill:eN(m)}});break}case"freedraw":{const P=m.points.map(([I,C,E=.5])=>({x:I,y:C,z:E})),_=He.encodePoints(P);i.shapes.push({...w,type:"draw",props:{...t.getShapeUtil("draw").getDefaultProps(),dash:Jl(m),size:Zl[m.strokeWidth],color:Na[m.strokeColor]??"black",segments:[{type:"free",path:_}]}});break}case"line":{if(m.points.slice().length<2)break;const _=bc(m.points.length);i.shapes.push({...w,type:"line",props:{...t.getShapeUtil("line").getDefaultProps(),dash:Jl(m),size:Zl[m.strokeWidth],color:Na[m.strokeColor]??"black",spline:m.roundness?"cubic":"line",points:{...Object.fromEntries(m.points.map(([I,C],E)=>{const O=_[E];return[O,{id:O,index:O,x:I,y:C}]}))}}});break}case"arrow":{let P="";if(m.boundElements!==null){for(const O of m.boundElements)if(O.type==="text"){const k=s.find(T=>T.id===O.id);k&&(P=k.text)}}const _=m.points[0],I=m.points[m.points.length-1],C=l.get(m.startBinding?.elementId),E=l.get(m.endBinding?.elementId);i.shapes.push({...w,type:"arrow",props:{...t.getShapeUtil("arrow").getDefaultProps(),richText:ln(P),kind:m.elbowed?"elbow":"arc",bend:Q9(m,_,I),dash:Jl(m),size:Zl[m.strokeWidth]??"m",color:Na[m.strokeColor]??"black",start:{x:_[0],y:_[1]},end:{x:I[0],y:I[1]},arrowheadEnd:Lv[m.endArrowhead]??"none",arrowheadStart:Lv[m.startArrowhead]??"none"}}),C&&i.bindings.push({id:Zi(),typeName:"binding",type:"arrow",fromId:S,toId:C,props:{terminal:"start",snap:"none",normalizedAnchor:{x:.5,y:.5},isPrecise:!1,isExact:!1},meta:{}}),E&&i.bindings.push({id:Zi(),typeName:"binding",type:"arrow",fromId:S,toId:E,props:{terminal:"end",snap:"none",normalizedAnchor:{x:.5,y:.5},isPrecise:!1,isExact:!1},meta:{}});break}case"text":{const{size:P,scale:_}=q9(m.fontSize);i.shapes.push({...w,type:"text",props:{...t.getShapeUtil("text").getDefaultProps(),size:P,scale:_,font:G9[m.fontFamily]??"draw",color:Na[m.strokeColor]??"black",richText:ln(m.text),textAlign:J9[m.textAlign]}});break}case"image":{const P=r[m.fileId];if(!P)break;const _=mo.createId();i.assets.push({id:_,typeName:"asset",type:"image",props:{w:m.width,h:m.height,fileSize:P.size,name:m.id??"Untitled",isAnimated:!1,mimeType:P.mimeType,src:P.dataURL},meta:{}}),i.shapes.push({...w,type:"image",props:{...t.getShapeUtil("image").getDefaultProps(),w:m.width,h:m.height,assetId:_}})}}p=Ls(p)}const f=n??(t.inputs.getShiftKey()?t.inputs.getCurrentPagePoint():void 0);t.putContentOntoCurrentPage(i,{point:f,select:!1,preserveIds:!0});for(const m of o.values())if(m.length>1){t.groupShapes(m);const S=t.getShape(m[0]);S?.parentId&&On(S.parentId)&&u.push(S.parentId)}for(const[m,S]of a)t.select(m),t.rotateShapesBy([m],S);const g=ve(u.map(m=>t.getShape(m))),x=X.Common(g.map(m=>t.getShapePageBounds(m))),y=t.getViewportPageBounds().center;t.updateShapes(g.map(m=>{const S={x:(m.x??0)-(x.x+x.w/2),y:(m.y??0)-(x.y+x.h/2)};return{id:m.id,type:m.type,x:y.x+S.x,y:y.y+S.y}})),t.setSelectedShapes(u)}const K9=t=>{const e=t/100;return e<.2?.1:e<.4?.25:e<.6?.5:e<.8?.75:1},Zl={1:"s",2:"m",3:"l",4:"xl"},W9={16:"s",20:"m",28:"l",36:"xl"};function q9(t){const e=W9[t];return e?{size:e,scale:1}:t<16?{size:"s",scale:t/16}:t>36?{size:"xl",scale:t/36}:{size:"m",scale:1}}const G9={1:"draw",2:"sans",3:"mono"},Y9={gray:["#f8f9fa","#e9ecef","#ced4da","#868e96","#343a40"],red:["#fff5f5","#ffc9c9","#ff8787","#fa5252","#e03131"],pink:["#fff0f6","#fcc2d7","#f783ac","#e64980","#c2255c"],grape:["#f8f0fc","#eebefa","#da77f2","#be4bdb","#9c36b5"],violet:["#f3f0ff","#d0bfff","#9775fa","#7950f2","#6741d9"],indigo:["#edf2ff","#bac8ff","#748ffc","#4c6ef5","#3b5bdb"],blue:["#e7f5ff","#a5d8ff","#4dabf7","#228be6","#1971c2"],cyan:["#e3fafc","#99e9f2","#3bc9db","#15aabf","#0c8599"],teal:["#e6fcf5","#96f2d7","#38d9a9","#12b886","#099268"],green:["#ebfbee","#b2f2bb","#69db7c","#40c057","#2f9e44"],lime:["#f4fce3","#d8f5a2","#a9e34b","#82c91e","#66a80f"],yellow:["#fff9db","#ffec99","#ffd43b","#fab005","#f08c00"],orange:["#fff4e6","#ffd8a8","#ffa94d","#fd7e14","#e8590c"]};function ur(t,e,n){const s=[0,1,2,3,4].map(r=>Y9[t][r]);return Object.fromEntries(s.map((r,i)=>[r,i<3?e:n]))}const Na={...ur("gray","grey","black"),...ur("red","light-red","red"),...ur("pink","light-red","red"),...ur("grape","light-violet","violet"),...ur("blue","light-blue","blue"),...ur("cyan","light-blue","blue"),...ur("teal","light-green","green"),...ur("green","light-green","green"),...ur("yellow","yellow","orange"),...ur("orange","yellow","orange"),"#ffffff":"white","#000000":"black"},V9={solid:"draw",dashed:"dashed",dotted:"dotted"},X9={"cross-hatch":"pattern",hachure:"pattern",solid:"solid"},Z9={left:"start",center:"middle",right:"end"},J9={left:"start",center:"middle",right:"end"},Lv={arrow:"arrow",dot:"dot",triangle:"triangle",bar:"pipe"};function Q9(t,e,n){let s=0;if(t.points.length>2){const r=new b(e[0],e[1]),i=new b(n[0],n[1]),o=new b(t.points[1][0],t.points[1][1]),a=b.Sub(i,r),c=b.Per(a),l=b.Med(i,r),u=b.Sub(l,c),d=b.Add(l,c),p=b.NearestPointOnLineSegment(u,d,o,!1);s=b.Dist(p,l),b.Clockwise(p,i,l)&&(s*=-1)}return s}const Jl=t=>{let e=V9[t.strokeStyle]??"draw";return e==="draw"&&t.roughness===0&&(e="solid"),e},eN=t=>t.backgroundColor==="transparent"?"none":X9[t.fillStyle]??"solid",u2={tldraw_draw:{normal:{normal:{family:"tldraw_draw",src:{url:"tldraw_draw",format:"woff2"},weight:"normal"},bold:{family:"tldraw_draw",src:{url:"tldraw_draw_bold",format:"woff2"},weight:"bold"}},italic:{normal:{family:"tldraw_draw",src:{url:"tldraw_draw_italic",format:"woff2"},weight:"normal",style:"italic"},bold:{family:"tldraw_draw",src:{url:"tldraw_draw_italic_bold",format:"woff2"},weight:"bold",style:"italic"}}},tldraw_sans:{normal:{normal:{family:"tldraw_sans",src:{url:"tldraw_sans",format:"woff2"},weight:"normal",style:"normal"},bold:{family:"tldraw_sans",src:{url:"tldraw_sans_bold",format:"woff2"},weight:"bold",style:"normal"}},italic:{normal:{family:"tldraw_sans",src:{url:"tldraw_sans_italic",format:"woff2"},weight:"normal",style:"italic"},bold:{family:"tldraw_sans",src:{url:"tldraw_sans_italic_bold",format:"woff2"},weight:"bold",style:"italic"}}},tldraw_serif:{normal:{normal:{family:"tldraw_serif",src:{url:"tldraw_serif",format:"woff2"},weight:"normal",style:"normal"},bold:{family:"tldraw_serif",src:{url:"tldraw_serif_bold",format:"woff2"},weight:"bold",style:"normal"}},italic:{normal:{family:"tldraw_serif",src:{url:"tldraw_serif_italic",format:"woff2"},weight:"normal",style:"italic"},bold:{family:"tldraw_serif",src:{url:"tldraw_serif_italic_bold",format:"woff2"},weight:"bold",style:"italic"}}},tldraw_mono:{normal:{normal:{family:"tldraw_mono",src:{url:"tldraw_mono",format:"woff2"},weight:"normal",style:"normal"},bold:{family:"tldraw_mono",src:{url:"tldraw_mono_bold",format:"woff2"},weight:"bold",style:"normal"}},italic:{normal:{family:"tldraw_mono",src:{url:"tldraw_mono_italic",format:"woff2"},weight:"normal",style:"italic"},bold:{family:"tldraw_mono",src:{url:"tldraw_mono_italic_bold",format:"woff2"},weight:"bold",style:"italic"}}}},tN=_t(u2).flatMap(t=>_t(t).flatMap(e=>Object.values(e))),nN=rA.create({name:"keyboardShiftEnterHandler",addKeyboardShortcuts(){return{"Shift-Enter":({editor:t})=>t.commands.enter()}}});iA.config.excludes=void 0;f0.config.priority=1100;const cl=[oA.configure({blockquote:!1,codeBlock:!1,horizontalRule:!1,link:{openOnClick:!1,autolink:!0},trailingNode:{notAfter:["paragraph","bulletList","orderedList","listItem"]}}),f0,nN,aA.TextDirection.configure({direction:"auto"})],sN=new dn;function qy(t,e){return sN.get(e,()=>{const n=t.getTextOptions().tipTapConfig?.extensions??cl;return cA(e,n).replaceAll('<p dir="auto"></p>',"<p><br /></p>")??""})}function Dc(t,e){return`<div class="tl-rich-text">${qy(t,e)}</div>`}const rN=new dn;function kt(t){return t.content.length===1&&!t.content[0].content}function co(t,e){return kt(e)?"":rN.get(e,()=>{const n=t.getTextOptions().tipTapConfig?.extensions??cl;return lA(e,n,{blockSeparator:`
`})})}function iN(t,e){const n=t.getTextOptions().tipTapConfig?.extensions??cl;return dA(e,n)}function h2(t,e,n){for(const o of t.marks)o.type.name==="bold"&&e.weight!=="bold"&&(e={...e,weight:"bold"}),o.type.name==="italic"&&e.style!=="italic"&&(e={...e,style:"italic"}),o.type.name==="code"&&e.family!=="tldraw_mono"&&(e={...e,family:"tldraw_mono"});const s=Nt(u2,e.family);if(!s)return e;const r=Nt(s,e.style);if(!r)return e;const i=Nt(r,e.weight);return i&&n(i),e}const oN="  ";class Oc{static fixNewLines=/\r?\n|\r/g;static normalizeText(e){return e.replace(Oc.fixNewLines,`
`)}static normalizeTextForDom(e){return e.replace(Oc.fixNewLines,`
`).split(`
`).map(n=>n||" ").join(`
`)}}const aN=/[\u0590-\u05FF\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/;function p2(t){return aN.test(t)}function cN(t){return t.replace(/\t/g,oN)}function lN(t){const e=t.split(`
`);for(;e[0]&&e[0].trim().length===0;)e.shift();let n=1/0;for(const s of e)if(s.trim().length>0){const r=s.length-s.trimStart().length;n=Math.min(n,r)}return e.map(s=>s.slice(n)).join(`
`)}const f2={"&amp;":"&","&quot;":'"',"&apos;":"'","&#27;":"'","&#34;":'"',"&#38;":"&","&#39;":"'","&#8211;":"–","&#8212;":"—","&#8216;":"‘","&#8217;":"’","&#8220;":"“","&#8221;":"”","&#8230;":"…"},dN=new RegExp(Object.keys(f2).join("|"),"g");function g2(t){return t.replace(dN,e=>f2[e])}function uN(t){return t.replace(/[ \t]+$/gm,"").replace(/\n+$/,"")}function hN(t){return uN(lN(cN(t)))}const pN=5e3,fN=10*1024*1024;function gN(t,e){t.registerExternalAssetHandler("file",async n=>mN(t,n,e)),t.registerExternalAssetHandler("url",async n=>SN(t,n,e)),t.registerExternalContentHandler("svg-text",async n=>xN(t,n)),t.registerExternalContentHandler("embed",n=>bN(t,n)),t.registerExternalContentHandler("files",async n=>wN(t,n,e)),t.registerExternalContentHandler("file-replace",async n=>yN(t,n,e)),t.registerExternalContentHandler("text",async n=>vN(t,n)),t.registerExternalContentHandler("url",async n=>PN(t,n,e)),t.registerExternalContentHandler("tldraw",async n=>IN(t,n)),t.registerExternalContentHandler("excalidraw",async n=>_N(t,n))}async function mN(t,{file:e,assetId:n},s){Gy(e,s)||le(!1,"File checks failed");const i=await S2(e,s,n),o=await t.uploadAsset(i,e);return i.props.src=o.src,o.meta&&(i.meta={...i.meta,...o.meta}),mo.create(i)}async function yN(t,{file:e,shapeId:n,isImage:s},r){Gy(e,r)||le(!1,"File checks failed");const o=t.getShape(n);o||le(!1,"Shape not found");const a=x0(await e.arrayBuffer()),c=mo.createId(a);t.createTemporaryAssetPreview(c,e);const l=await m2(e,c,s,!s);if(t.createAssets([l]),o.type==="image"){const d=o,p=d.props.crop;let f=l.props.w,g=l.props.h,x=d.x,y=d.y,m=p;if(p){const S=L$(d,l.props.w,l.props.h);m=S.crop,f=S.w,g=S.h,x=S.x,y=S.y}t.updateShapes([{id:d.id,type:d.type,props:{assetId:c,crop:m,w:f,h:g},x,y}])}else o.type==="video"&&t.updateShapes([{id:o.id,type:o.type,props:{assetId:c,w:l.props.w,h:l.props.h}}]);const u=await t.getAssetForExternalContent({type:"file",file:e,assetId:c});return t.updateAssets([{...u,id:c}]),u}async function SN(t,{url:e},{toasts:n,msg:s}){let r;try{const o=await(await Qr(e,{method:"GET",mode:"no-cors"})).text(),a=new DOMParser().parseFromString(o,"text/html");r={image:a.head.querySelector('meta[property="og:image"]')?.getAttribute("content")??"",favicon:a.head.querySelector('link[rel="apple-touch-icon"]')?.getAttribute("href")??a.head.querySelector('link[rel="icon"]')?.getAttribute("href")??"",title:a.head.querySelector('meta[property="og:title"]')?.getAttribute("content")??e,description:a.head.querySelector('meta[property="og:description"]')?.getAttribute("content")??""},r.image.startsWith("http")||(r.image=new URL(r.image,e).href),r.favicon.startsWith("http")||(r.favicon=new URL(r.favicon,e).href)}catch(i){console.error(i),n.addToast({title:s("assets.url.failed"),severity:"error"}),r={image:"",favicon:"",title:"",description:""}}return{id:mo.createId(S0(e)),typeName:"asset",type:"bookmark",props:{src:e,description:r.description,image:r.image,favicon:r.favicon,title:r.title},meta:{}}}async function xN(t,{point:e,text:n}){const s=e??(t.inputs.getShiftKey()?t.inputs.getCurrentPagePoint():t.getViewportPageBounds().center),r=new DOMParser().parseFromString(n,"image/svg+xml").querySelector("svg");if(!r)throw new Error("No <svg/> element present");let i=parseFloat(r.getAttribute("width")||"0"),o=parseFloat(r.getAttribute("height")||"0");if(!(i&&o)){document.body.appendChild(r);const c=r.getBoundingClientRect();document.body.removeChild(r),i=c.width,o=c.height}const a=await t.getAssetForExternalContent({type:"file",file:new File([n],"asset.svg",{type:"image/svg+xml"})});if(!a)throw Error("Could not create an asset");y2(t,[a],s)}function bN(t,{point:e,url:n,embed:s}){const r=e??(t.inputs.getShiftKey()?t.inputs.getCurrentPagePoint():t.getViewportPageBounds().center),{width:i,height:o}=s,a=tt(),c=vs(new b(r.x-(i||450)/2,r.y-(o||450)/2),t),l={id:a,type:"embed",x:c.x,y:c.y,props:{w:i,h:o,url:n}};t.canCreateShape(l)&&t.createShape(l).select(a)}async function wN(t,{point:e,files:n},s){const{acceptedImageMimeTypes:r=da,toasts:i,msg:o}=s;if(n.length>t.options.maxFilesAtOnce){i.addToast({title:o("assets.files.amount-too-many"),severity:"error"});return}const a=e??(t.inputs.getShiftKey()?t.inputs.getCurrentPagePoint():t.getViewportPageBounds().center),c=new b(a.x,a.y),l=[],u=[];for(const d of n){if(!Gy(d,s))continue;const f=await S2(d,s);r.includes(d.type)&&t.createTemporaryAssetPreview(f.id,d),l.push(f),u.push({asset:f,file:d})}Promise.allSettled(u.map(async d=>{try{const p=await t.getAssetForExternalContent({type:"file",file:d.file});if(!p)throw Error("Could not create an asset");t.updateAssets([{...p,id:d.asset.id}])}catch(p){i.addToast({title:o("assets.files.upload-failed"),severity:"error"}),console.error(p),t.deleteAssets([d.asset.id]);return}})),y2(t,l,c)}async function vN(t,{point:e,text:n,html:s}){const r=e??(t.inputs.getShiftKey()?t.inputs.getCurrentPagePoint():t.getViewportPageBounds().center),i=t.getShapeUtil("text").getDefaultProps(),o=hN(n),a=s?iN(t,s):ln(o);let c,l,u,d="middle";const p=s??o.replace(/\n/g,"<br>"),f=s?a.content.length>1:o.split(`
`).length>1,g=p2(o);f&&(d=f?g?"end":"start":"middle");const x=t.textMeasure.measureHtml(p,{...$n,fontFamily:ji[i.font],fontSize:oa[i.size],maxWidth:null}),y=Math.min(f?t.getViewportPageBounds().width*.9:920,Math.max(200,t.getViewportPageBounds().width*.9));if(x.w>y){const w=t.textMeasure.measureHtml(p,{...$n,fontFamily:ji[i.font],fontSize:oa[i.size],maxWidth:y});c=w.w,l=w.h,u=!1,d=g?"end":"start"}else c=Math.max(x.w,10),l=Math.max(x.h,10),u=!0;r.y-l/2<t.getViewportPageBounds().minY+40&&(r.y=t.getViewportPageBounds().minY+40+l/2);const m=vs(new b(r.x-c/2,r.y-l/2),t),S=tt();t.createShapes([{id:S,type:"text",x:m.x,y:m.y,props:{richText:a,textAlign:d,autoSize:u,w:c}}])}async function PN(t,{point:e,url:n},{toasts:s,msg:r}){const o=t.getShapeUtil("embed")?.getEmbedDefinition(n);if(o&&o.definition.embedOnPaste!==!1)return t.putExternalContent({type:"embed",url:o.url,point:e,embed:o.definition});const a=e??(t.inputs.getShiftKey()?t.inputs.getCurrentPagePoint():t.getViewportPageBounds().center);if(!(await FT(t,{url:n,center:a})).ok){s.addToast({title:r("assets.url.failed"),severity:"error"});return}}async function IN(t,{point:e,content:n}){t.run(()=>{const s=t.getSelectionPageBounds();t.markHistoryStoppingPoint("paste");for(const i of n.shapes)n.rootShapeIds.includes(i.id)&&(i.isLocked=!1);t.putContentOntoCurrentPage(n,{point:e,select:!0});const r=t.getSelectionPageBounds();s&&r&&s?.collides(r)&&(t.updateInstanceState({isChangingStyle:!0}),t.timers.setTimeout(()=>{t.updateInstanceState({isChangingStyle:!1})},150))})}async function _N(t,{point:e,content:n}){t.run(()=>{H9(t,n,e)})}async function m2(t,e,n,s,r){let i=t.type;t.type==="video/quicktime"&&(i="video/mp4");const o=n?await ms.getImageSize(t):await ms.getVideoSize(t),a=await ms.isAnimated(t)||s,c={id:e,type:n?"image":"video",typeName:"asset",props:{name:t.name,src:"",w:o.w,h:o.h,fileSize:t.size,mimeType:i,isAnimated:a},meta:{}};if(r&&isFinite(r)){const l={w:c.props.w,h:c.props.h},u=U9(l,{w:r,h:r});l!==u&&ms.isStaticImageType(t.type)&&(c.props.w=u.w,c.props.h=u.h)}return c}async function y2(t,e,n){if(!e.length)return[];const s=b.From(n),r=[];for(let i=0;i<e.length;i++){const o=e[i];switch(o.type){case"image":{r.push({id:tt(),type:"image",x:s.x,y:s.y,opacity:1,props:{assetId:o.id,w:o.props.w,h:o.props.h}}),s.x+=o.props.w;break}case"video":r.push({id:tt(),type:"video",x:s.x,y:s.y,opacity:1,props:{assetId:o.id,w:o.props.w,h:o.props.h}}),s.x+=o.props.w}}return t.run(()=>{const i=e.filter(o=>!t.getAsset(o.id));t.store.atomic(()=>{t.canCreateShapes(r)&&(i.length&&t.createAssets(i),t.createShapes(r).select(...r.map(o=>o.id)),CN(t,n))})}),r.map(i=>i.id)}function CN(t,e){const n=t.getViewportPageBounds();let s=t.getSelectionPageBounds();if(s){const r=s.center.sub(e);t.updateShapes(t.getSelectedShapes().map(i=>{const o=t.getShapeParentTransform(i).decompose().rotation,a=b.Rot(r,-o);return{id:i.id,type:i.type,x:i.x-a.x,y:i.y-a.y}}))}if(s=t.getSelectionPageBounds(),s&&t.getInstanceState().isGridMode){const r=t.getDocumentSettings().gridSize,i=new b(s.minX,s.minY),o=i.clone().snapToGrid(r),a=b.Sub(i,o);t.updateShapes(t.getSelectedShapes().map(c=>{const l={x:c.x-a.x,y:c.y-a.y};return{id:c.id,type:c.type,x:l.x,y:l.y}}))}s=t.getSelectionPageBounds(),s&&!n.contains(s)&&t.zoomToSelection({animation:{duration:t.options.animationMediumMs}})}function Gy(t,e){const{acceptedImageMimeTypes:n=da,acceptedVideoMimeTypes:s=Yd,maxAssetSize:r=fN,toasts:i,msg:o}=e,a=n.includes(t.type),c=s.includes(t.type);if(!a&&!c)return i.addToast({title:o("assets.files.type-not-allowed"),severity:"error"}),!1;if(t.size>r){const l=u=>{if(u===0)return"0 bytes";const d=["bytes","KB","MB","GB","TB","PB"],p=1024,f=Math.floor(Math.log(u)/Math.log(p)),g=u/Math.pow(p,f);return`${g%1===0?g.toString():g.toFixed(1)} ${d[f]}`};return i.addToast({title:o("assets.files.size-too-big"),description:o("assets.files.maximum-size").replace("{size}",l(r)),severity:"error"}),!1}return t.type?!0:(i.addToast({title:o("assets.files.upload-failed"),severity:"error"}),console.error("No mime type"),!1)}async function S2(t,e,n){const{acceptedImageMimeTypes:s=da,acceptedVideoMimeTypes:r=Yd,maxImageDimension:i=pN}=e,o=s.includes(t.type),a=r.includes(t.type),c=x0(await t.arrayBuffer());return n??=mo.createId(c),await m2(t,n,o,a,i)}let TN=class extends fe{static id="idle";isPrecise=!1;isPreciseTimerId=null;preciseTargetId=null;onPointerMove(){this.update()}onPointerDown(e){this.parent.transition("pointing",{...e,isPrecise:this.isPrecise})}onEnter(){this.editor.setCursor({type:"cross",rotation:0}),this.update()}onCancel(){this.editor.setCurrentTool("select")}onExit(){Ky(this.editor),this.isPreciseTimerId!==null&&clearTimeout(this.isPreciseTimerId)}onKeyDown(){this.update()}onKeyUp(e){if(this.update(),e.key==="Enter"){const n=this.editor.getOnlySelectedShape();this.editor.canEditShape(n)&&Hn(this.editor,n,{selectAll:!0})}}update(){const e=this.editor.getShapeUtil("arrow"),n=$u({editor:this.editor,pointInPageSpace:this.editor.inputs.getCurrentPagePoint(),arrow:void 0,isPrecise:this.isPrecise,currentBinding:void 0,oppositeBinding:void 0});n&&n.target.id!==this.preciseTargetId?(this.isPreciseTimerId!==null&&clearTimeout(this.isPreciseTimerId),this.preciseTargetId=n.target.id,this.isPreciseTimerId=this.editor.timers.setTimeout(()=>{this.isPrecise=!0,this.update()},e.options.hoverPreciseTimeout)):!n&&this.preciseTargetId&&(this.isPrecise=!1,this.preciseTargetId=null,this.isPreciseTimerId!==null&&clearTimeout(this.isPreciseTimerId))}},EN=class extends fe{static id="pointing";shape;isPrecise=!1;isPreciseTimerId=null;markId="";onEnter(e){if(this.markId="",this.isPrecise=!!e.isPrecise,!$u({editor:this.editor,pointInPageSpace:this.editor.inputs.getCurrentPagePoint(),arrow:void 0,isPrecise:this.isPrecise,currentBinding:void 0,oppositeBinding:void 0})&&(this.createArrowShape(),!this.shape)){this.cancel();return}this.startPreciseTimeout()}onExit(){this.shape=void 0,Ky(this.editor),this.clearPreciseTimeout()}onPointerMove(){if(this.editor.inputs.getIsDragging()){if(this.shape||this.createArrowShape(),!this.shape){this.cancel();return}this.updateArrowShapeEndHandle(),this.editor.setCurrentTool("select.dragging_handle",{shape:this.shape,handle:{id:"end",type:"vertex",index:"a3",x:0,y:0},isCreating:!0,creatingMarkId:this.markId||void 0,onInteractionEnd:"arrow"})}}onPointerUp(){this.cancel()}onCancel(){this.cancel()}onComplete(){this.cancel()}onInterrupt(){this.cancel()}cancel(){this.shape&&this.editor.bailToMark(this.markId),this.parent.transition("idle")}createArrowShape(){const e=this.editor.inputs.getOriginPagePoint(),n=tt();this.markId=this.editor.markHistoryStoppingPoint(`creating_arrow:${n}`);const s=vs(e,this.editor);this.editor.createShape({id:n,type:"arrow",x:s.x,y:s.y,props:{scale:this.editor.user.getIsDynamicResizeMode()?1/this.editor.getZoomLevel():1}});const r=this.editor.getShape(n);if(!r)return;const i=this.editor.getShapeHandles(r);if(!i)throw Error("expected handles for arrow");const o=this.editor.getShapeUtil("arrow"),a=this.shape,c=i.find(u=>u.id==="start"),l=o.onHandleDrag?.(r,{handle:{...c,x:0,y:0},isPrecise:!0,isCreatingShape:!0,initial:a});l&&this.editor.updateShapes([l]),this.shape=this.editor.getShape(n),this.editor.select(n)}updateArrowShapeEndHandle(){const e=this.shape;if(!e)throw Error("expected shape");const n=this.editor.getShapeHandles(e);if(!n)throw Error("expected handles for arrow");{const s=this.editor.getShapeUtil("arrow"),r=this.shape,i=n.find(a=>a.id==="start"),o=s.onHandleDrag?.(e,{handle:{...i,x:0,y:0},isPrecise:this.isPrecise,isCreatingShape:!0,initial:r});o&&this.editor.updateShapes([o])}{const s=this.editor.getShapeUtil("arrow"),r=this.shape,i=this.editor.getPointInShapeSpace(e,this.editor.inputs.getCurrentPagePoint()),o=n.find(c=>c.id==="end"),a=s.onHandleDrag?.(this.editor.getShape(e),{handle:{...o,x:i.x,y:i.y},isPrecise:this.isPrecise,isCreatingShape:!0,initial:r});a&&this.editor.updateShapes([a])}this.shape=this.editor.getShape(e.id)}startPreciseTimeout(){const e=this.editor.getShapeUtil("arrow");this.isPreciseTimerId=this.editor.timers.setTimeout(()=>{this.getIsActive()&&(this.isPrecise=!0)},e.options.pointingPreciseTimeout)}clearPreciseTimeout(){this.isPreciseTimerId!==null&&clearTimeout(this.isPreciseTimerId)}};class kN extends fe{static id="arrow";static initial="idle";static children(){return[TN,EN]}shapeType="arrow"}class x2 extends fe{static id="drawing";info={};initialShape;shapeType=this.parent.id==="highlight"?"highlight":"draw";util=this.editor.getShapeUtil(this.shapeType);isPen=!1;isPenOrStylus=!1;segmentMode="free";didJustShiftClickToExtendPreviousShapeLine=!1;pagePointWhereCurrentSegmentChanged={};pagePointWhereNextSegmentChanged=null;lastRecordedPoint={};mergeNextPoint=!1;currentLineLength=0;currentSegmentPoints=[];markId=null;onEnter(e){this.markId=null,this.info=e,this.lastRecordedPoint=this.editor.inputs.getCurrentPagePoint().clone(),this.startShape()}onPointerMove(){const{inputs:e}=this.editor,n=e.getIsPen();if(this.isPen&&!n&&this.markId){this.editor.bailToMark(this.markId),this.startShape();return}if(this.isPenOrStylus){const s=e.getCurrentPagePoint();b.Dist(s,this.lastRecordedPoint)>=1/this.editor.getZoomLevel()?(this.lastRecordedPoint=s.clone(),this.mergeNextPoint=!1):this.mergeNextPoint=!0}else this.mergeNextPoint=!1;this.updateDrawingShape()}onKeyDown(e){if(e.key==="Shift")switch(this.segmentMode){case"free":{this.segmentMode="starting_straight",this.pagePointWhereNextSegmentChanged=this.editor.inputs.getCurrentPagePoint().clone();break}case"starting_free":this.segmentMode="starting_straight"}this.updateDrawingShape()}onKeyUp(e){if(e.key==="Shift")switch(this.editor.snaps.clearIndicators(),this.segmentMode){case"straight":{this.segmentMode="starting_free",this.pagePointWhereNextSegmentChanged=this.editor.inputs.getCurrentPagePoint().clone();break}case"starting_straight":{this.pagePointWhereNextSegmentChanged=null,this.segmentMode="free";break}}this.updateDrawingShape()}onExit(){this.editor.snaps.clearIndicators(),this.pagePointWhereCurrentSegmentChanged=this.editor.inputs.getCurrentPagePoint().clone()}canClose(){return this.shapeType!=="highlight"}getIsClosed(e,n,s){if(!this.canClose())return!1;const r=Ht[n],i=He.decodeFirstPoint(e[0].path),o=e[e.length-1],a=He.decodeLastPoint(o.path);return i!==null&&a!==null&&i!==a&&this.currentLineLength>r*4*s&&b.DistMin(i,a,r*2*s)}startShape(){const e=this.editor.inputs,n=e.getOriginPagePoint(),s=e.getIsPen();this.markId=this.editor.markHistoryStoppingPoint("draw start");const{z:r=.5}=this.info.point;this.isPen=s,this.isPenOrStylus=s||r>0&&r<.5||r>.5&&r<1;const i=this.isPenOrStylus?r*1.25:.5;if(this.segmentMode=this.editor.inputs.getShiftKey()?"straight":"free",this.didJustShiftClickToExtendPreviousShapeLine=!1,this.lastRecordedPoint=n.clone(),this.initialShape){const l=this.editor.getShape(this.initialShape.id);if(l&&this.segmentMode==="straight"){this.didJustShiftClickToExtendPreviousShapeLine=!0;const u=Fs(l.props.segments);if(!u)throw Error("Expected a previous segment!");const d=He.decodeLastPoint(u.path);if(!d)throw Error("Expected a previous point!");const{x:p,y:f}=this.editor.getPointInShapeSpace(l,n).toFixed(),g={type:this.segmentMode,path:He.encodePoints([{x:d.x,y:d.y,z:+i.toFixed(2)},{x:p,y:f,z:+i.toFixed(2)}])},x=q.applyToPoint(this.editor.getShapePageTransform(l.id),d);this.pagePointWhereCurrentSegmentChanged=x,this.pagePointWhereNextSegmentChanged=null;const y=[...l.props.segments,g];this.currentLineLength<Ht[l.props.size]*4&&(this.currentLineLength=this.getLineLength(y));const m={id:l.id,type:this.shapeType,props:{segments:y}};this.canClose()&&(m.props.isClosed=this.getIsClosed(y,l.props.size,l.props.scale)),this.editor.updateShapes([m]);return}}this.pagePointWhereCurrentSegmentChanged=n.clone();const o=tt(),a=new b(0,0,+i.toFixed(2));if(this.currentSegmentPoints=[a],this.editor.createShape({id:o,type:this.shapeType,x:n.x,y:n.y,props:{isPen:this.isPenOrStylus,scale:this.editor.user.getIsDynamicResizeMode()?1/this.editor.getZoomLevel():1,segments:[{type:this.segmentMode,path:He.encodePoints([a])}]}}),!this.editor.getShape(o)){this.cancel();return}this.currentLineLength=0,this.initialShape=this.editor.getShape(o)}updateDrawingShape(){const{initialShape:e}=this,{inputs:n}=this.editor;if(!e)return;const{id:s,props:{size:r,scale:i}}=e,o=this.editor.getShape(s);if(!o)return;const{segments:a}=o.props,c=n.getCurrentPagePoint(),{x:l,y:u,z:d}=this.editor.getPointInShapeSpace(o,c).toFixed(),p=this.isPenOrStylus?+(c.z*1.25).toFixed(2):.5,f={x:l,y:u,z:p};switch(this.segmentMode){case"starting_straight":{const{pagePointWhereNextSegmentChanged:g}=this;if(g===null)throw Error("We should have a point where the segment changed");if(b.Dist2(g,n.getCurrentPagePoint())>this.editor.options.dragDistanceSquared){this.pagePointWhereCurrentSegmentChanged=this.pagePointWhereNextSegmentChanged.clone(),this.pagePointWhereNextSegmentChanged=null,this.segmentMode="straight";const y=Fs(a);if(!y)throw Error("Expected a previous segment!");const m=He.decodeLastPoint(y.path);if(!m)throw Error("Expected a previous last point!");let S;const w=this.editor.getPointInShapeSpace(o,this.pagePointWhereCurrentSegmentChanged).toFixed().toJson();if(y.type==="straight"){this.currentLineLength+=b.Dist(m,w),S={type:"straight",path:He.encodePoints([m,w])};const _=this.editor.getShapePageTransform(o);this.pagePointWhereCurrentSegmentChanged=q.applyToPoint(_,m)}else S={type:"straight",path:He.encodePoints([w,f])};const P={id:s,type:this.shapeType,props:{segments:[...a,S]}};this.canClose()&&(P.props.isClosed=this.getIsClosed(a,r,i)),this.editor.updateShapes([P])}break}case"starting_free":{const{pagePointWhereNextSegmentChanged:g}=this;if(g===null)throw Error("We should have a point where the segment changed");if(b.Dist2(g,n.getCurrentPagePoint())>this.editor.options.dragDistanceSquared){this.pagePointWhereCurrentSegmentChanged=this.pagePointWhereNextSegmentChanged.clone(),this.pagePointWhereNextSegmentChanged=null,this.segmentMode="free";const y=a.slice(),m=y[y.length-1],S=He.decodeLastPoint(m.path);if(!S)throw Error("No previous point!");const w=b.PointsBetween(S,f,6).map(C=>new b(Xr(C.x),Xr(C.y),Xr(C.z)));this.currentSegmentPoints=w;const P={type:"free",path:He.encodePoints(w)},_=[...y,P];this.currentLineLength<Ht[o.props.size]*4&&(this.currentLineLength=this.getLineLength(_));const I={id:s,type:this.shapeType,props:{segments:_}};this.canClose()&&(I.props.isClosed=this.getIsClosed(_,r,i)),this.editor.updateShapes([I])}break}case"straight":{const g=a.slice(),x=g[g.length-1],{pagePointWhereCurrentSegmentChanged:y}=this,m=this.editor.inputs,S=m.getCtrlKey(),w=m.getCurrentPagePoint();if(!y)throw Error("We should have a point where the segment changed");let P,_=!1;this.didJustShiftClickToExtendPreviousShapeLine?this.editor.inputs.getIsDragging()&&(_=!S,this.didJustShiftClickToExtendPreviousShapeLine=!1):_=!S;let I=this.editor.getPointInShapeSpace(o,w).toFixed().toJson(),C=!1,E;if((this.editor.user.getIsSnapMode()?!S:S)&&g.length>2){let T,D=8/this.editor.getZoomLevel();for(let R=0,M=a.length-2;R<M;R++){const L=a[R];if(!L)break;if(L.type==="free")continue;const U=He.decodeFirstPoint(L.path),V=He.decodeLastPoint(L.path);if(!(U&&V))continue;const J=b.NearestPointOnLineSegment(U,V,I);if(b.DistMin(J,I,D)){T=J.toFixed().toJson(),D=b.Dist(J,I),E=L;break}}T&&(C=!0,I=T)}if(C&&E){const T=this.editor.getShapePageTransform(o),D=He.decodeFirstPoint(E.path),R=He.decodeLastPoint(E.path);if(!D||!R)throw Error("Expected a last point!");const M=q.applyToPoint(T,D),L=q.applyToPoint(T,R),U=q.applyToPoint(T,I);this.editor.snaps.setIndicators([{id:Ge(),type:"points",points:[M,U,L]}])}else{if(this.editor.snaps.clearIndicators(),_){const T=b.Angle(y,w),R=Ad(T,24)-T;P=b.RotWith(w,y,R)}else P=w.clone();I=this.editor.getPointInShapeSpace(o,P).toFixed().toJson()}this.currentLineLength+=g.length&&He.decodeFirstPoint(x.path)?b.Dist(He.decodeFirstPoint(x.path),b.From(I)):0,g[g.length-1]={...x,type:"straight",path:He.encodePoints([He.decodeFirstPoint(x.path),b.From(I)])};const k={id:s,type:this.shapeType,props:{segments:g}};this.canClose()&&(k.props.isClosed=this.getIsClosed(a,r,i)),this.editor.updateShapes([k]);break}case"free":{const g=this.currentSegmentPoints;if(g.length&&this.mergeNextPoint){const S=g[g.length-1];S.x=f.x,S.y=f.y,S.z=S.z?Math.max(S.z,f.z):f.z}else this.currentLineLength+=g.length?b.Dist(g[g.length-1],f):0,g.push(new b(f.x,f.y,f.z));const x=a.slice(),y=x[x.length-1];x[x.length-1]={...y,path:He.encodePoints(g)},this.currentLineLength<Ht[o.props.size]*4&&(this.currentLineLength=this.getLineLength(x));const m={id:s,type:this.shapeType,props:{segments:x}};if(this.canClose()&&(m.props.isClosed=this.getIsClosed(x,r,i)),this.editor.updateShapes([m]),g.length>this.util.options.maxPointsPerShape){this.editor.updateShapes([{id:s,type:this.shapeType,props:{isComplete:!0}}]);const S=tt(),w=this.editor.getShape(s).props;if(!this.editor.canCreateShapes([S]))return this.cancel();const P=n.getCurrentPagePoint(),_=new b(0,0,this.isPenOrStylus?+(d*1.25).toFixed():.5);this.currentSegmentPoints=[_],this.editor.createShape({id:S,type:this.shapeType,x:Xr(P.x),y:Xr(P.y),props:{isPen:this.isPenOrStylus,scale:w.scale,segments:[{type:"free",path:He.encodePoints([_])}]}});const I=this.editor.getShape(S);if(!I)return this.cancel();this.initialShape=wt(I),this.mergeNextPoint=!1,this.lastRecordedPoint=P.clone(),this.currentLineLength=0}break}}}getLineLength(e){let n=0;for(let s=0;s<e.length;s++){const r=He.decodePoints(e[s].path);for(let i=0;i<r.length-1;i++)n+=b.Dist2(r[i],r[i+1])}return Math.sqrt(n)}onPointerUp(){this.complete()}onCancel(){this.cancel()}onComplete(){this.complete()}onInterrupt(){this.editor.inputs.getIsDragging()||(this.markId&&this.editor.bailToMark(this.markId),this.cancel())}complete(){const{initialShape:e}=this;e&&(this.editor.updateShapes([{id:e.id,type:e.type,props:{isComplete:!0}}]),this.parent.transition("idle"))}cancel(){this.parent.transition("idle",this.info)}}let b2=class extends fe{static id="idle";onPointerDown(e){this.parent.transition("drawing",e)}onEnter(){this.editor.setCursor({type:"cross",rotation:0})}onCancel(){this.editor.setCurrentTool("select")}};class AN extends fe{static id="draw";static initial="idle";static isLockable=!1;static useCoalescedEvents=!0;static children(){return[b2,x2]}shapeType="draw";onExit(){const e=this.children.drawing;e.initialShape=void 0}}class MN extends f4{static id="frame";static initial="idle";shapeType="frame";onCreate(e){if(!e)return;const n=this.editor.getShapePageBounds(e),s=[],r=this.editor.getShapeAncestors(e).map(i=>i.id);this.editor.getSortedChildIdsForParent(e.parentId).map(i=>{const o=this.editor.getShape(i);if(!o||o.id===e.id||o.isLocked)return;const a=this.editor.getShapePageBounds(o);a&&n.contains(a)&&jN(o,r,e)&&s.push(o.id)}),this.editor.reparentShapes(s,e.id),this.editor.getInstanceState().isToolLocked?this.editor.setCurrentTool("frame"):this.editor.setCurrentTool("select.idle")}}function jN(t,e,n){return e.includes(t.id)?!1:t.parentId===n.parentId}let DN=class extends fe{static id="idle";onPointerDown(e){this.parent.transition("pointing",e)}onEnter(){this.editor.setCursor({type:"cross",rotation:0})}onKeyUp(e){const{editor:n}=this;if(e.key==="Enter"){const s=n.getOnlySelectedShape();n.canEditShape(s)&&Hn(n,s,{selectAll:!0})}}onCancel(){this.editor.setCurrentTool("select")}},ON=class extends fe{static id="pointing";onPointerUp(){this.complete()}onPointerMove(e){if(this.editor.inputs.getIsDragging()){const n=this.editor.inputs.getOriginPagePoint(),s=tt(),r=this.editor.markHistoryStoppingPoint(`creating_geo:${s}`),i=vs(n,this.editor);if(this.editor.createShapes([{id:s,type:"geo",x:i.x,y:i.y,props:{w:1,h:1,geo:this.editor.getStyleForNextShape(yr),scale:this.editor.user.getIsDynamicResizeMode()?1/this.editor.getZoomLevel():1}}]).select(s),!this.editor.getShape(s)){this.cancel();return}this.editor.setCurrentTool("select.resizing",{...e,target:"selection",handle:"bottom_right",isCreating:!0,creatingMarkId:r,creationCursorOffset:{x:1,y:1},onInteractionEnd:"geo"})}}onCancel(){this.cancel()}onComplete(){this.complete()}onInterrupt(){this.cancel()}complete(){const e=this.editor.inputs.getOriginPagePoint(),n=tt();this.editor.markHistoryStoppingPoint(`creating_geo:${n}`);const s=this.editor.user.getIsDynamicResizeMode()?1/this.editor.getZoomLevel():1,r=this.editor.getStyleForNextShape(yr),i=r==="star"?{w:200,h:190}:r==="cloud"?{w:300,h:180}:{w:200,h:200};this.editor.createShapes([{id:n,type:"geo",x:e.x,y:e.y,props:{geo:this.editor.getStyleForNextShape(yr),scale:s,...i}}]);const o=this.editor.getShape(n);if(!o){this.cancel();return}const{w:a,h:c}=o.props,l=new b(a/2,c/2).mul(s),u=this.editor.getShapeParentTransform(o);u&&l.rot(-u.rotation());const d=vs(new b(o.x-l.x,o.y-l.y),this.editor);this.editor.select(n),this.editor.updateShape({id:o.id,type:"geo",x:d.x,y:d.y,props:{geo:this.editor.getStyleForNextShape(yr),w:a*s,h:c*s}}),this.editor.getInstanceState().isToolLocked?this.parent.transition("idle"):this.editor.setCurrentTool("select",{})}cancel(){this.parent.transition("idle")}};class LN extends fe{static id="geo";static initial="idle";static children(){return[DN,ON]}shapeType="geo"}class RN extends fe{static id="highlight";static initial="idle";static useCoalescedEvents=!0;static children(){return[b2,x2]}static isLockable=!1;shapeType="highlight";onExit(){const e=this.children.drawing;e.initialShape=void 0}}let FN=class extends fe{static id="idle";shapeId="";onEnter(e){this.shapeId=e.shapeId,this.editor.setCursor({type:"cross",rotation:0})}onPointerDown(){this.parent.transition("pointing",{shapeId:this.shapeId})}onCancel(){this.editor.setCurrentTool("select")}};const Rv=2;let BN=class extends fe{static id="pointing";shape={};markId;onEnter(e){const{inputs:n}=this.editor,s=n.getCurrentPagePoint();this.markId=void 0;const r=e.shapeId&&this.editor.getShape(e.shapeId);if(r&&n.getShiftKey()){this.markId=this.editor.markHistoryStoppingPoint(`creating_line:${r.id}`),this.shape=r;const i=this.editor.getShapeHandles(this.shape);if(!i)return;const o=i.filter(f=>f.type==="vertex").sort(Yt),a=o[o.length-1],c=o[o.length-2],l=q.applyToPoint(this.editor.getShapeParentTransform(this.shape),new b(this.shape.x,this.shape.y)),u=b.Sub(s,l).addXY(.1,.1),d=vs(u,this.editor),p=wt(this.shape.props.points);if(b.DistMin(a,c,Rv)||b.DistMin(d,a,Rv))p[a.id]={id:a.id,index:a.index,x:d.x,y:d.y};else{const f=Ls(a.index);p[f]={id:f,index:f,x:d.x,y:d.y}}this.editor.updateShapes([{id:this.shape.id,type:this.shape.type,props:{points:p}}])}else{const i=tt();this.markId=this.editor.markHistoryStoppingPoint(`creating_line:${i}`);const o=vs(s,this.editor);if(this.editor.createShapes([{id:i,type:"line",x:o.x,y:o.y,props:{scale:this.editor.user.getIsDynamicResizeMode()?1/this.editor.getZoomLevel():1}}]),!this.editor.getShape(i)){this.cancel();return}this.editor.select(i),this.shape=this.editor.getShape(i)}}onPointerMove(){if(this.shape&&this.editor.inputs.getIsDragging()){const e=this.editor.getShapeHandles(this.shape);if(!e)throw this.markId&&this.editor.bailToMark(this.markId),Error("No handles found");const n=Fs(e);this.editor.setCurrentTool("select.dragging_handle",{shape:this.shape,isCreating:!0,creatingMarkId:this.markId,handle:{...n,x:n.x-.1,y:n.y-.1},onInteractionEnd:"line"})}}onPointerUp(){this.complete()}onCancel(){this.cancel()}onComplete(){this.complete()}onInterrupt(){this.parent.transition("idle"),this.markId&&this.editor.bailToMark(this.markId),this.editor.snaps.clearIndicators()}complete(){this.parent.transition("idle",{shapeId:this.shape.id}),this.editor.snaps.clearIndicators()}cancel(){this.markId&&this.editor.bailToMark(this.markId),this.parent.transition("idle",{shapeId:this.shape.id}),this.editor.snaps.clearIndicators()}};class zN extends fe{static id="line";static initial="idle";static children(){return[FN,BN]}shapeType="line"}let $N=class extends fe{static id="idle";onPointerDown(e){this.parent.transition("pointing",e)}onEnter(){this.editor.setCursor({type:"cross",rotation:0})}onCancel(){this.editor.setCurrentTool("select")}};const NN=0,et=200,Nu=new b(et/2,et/2),w2=10,UN=t=>[[["a1"],new b(et*.5,et*-.5-t.options.adjacentShapeMargin)],[["a2"],new b(et*1.5+t.options.adjacentShapeMargin,et*.5)],[["a3"],new b(et*.5,et*1.5+t.options.adjacentShapeMargin)],[["a4"],new b(et*-.5-t.options.adjacentShapeMargin,et*.5)]];function HN(t,e){if(e===1)return UN(t);const n=et*e,s=t.options.adjacentShapeMargin*e;return[[["a1"],new b(n*.5,n*-.5-s)],[["a2"],new b(n*1.5+s,n*.5)],[["a3"],new b(n*.5,n*1.5+s)],[["a4"],new b(n*-.5-s,n*.5)]]}function v2(t,e,n,s,r,i){return Object.fromEntries(HN(t,i).map(([o,a],c)=>{const l=a.clone();return c===0&&r?l.y-=r:c===2&&s&&(l.y+=s),[o,l.rot(n).add(e)]}))}function P2(t,e,n,s){const r=new Set(t.getSelectedShapeIds()),i=(et+t.options.adjacentShapeMargin+s)**2,o=new Map,a=[];for(const u of t.getCurrentPageShapes()){if(!t.isShapeOfType(u,"note")||n!==u.props.scale||r.has(u.id))continue;const d=t.getShapePageTransform(u.id);e===d.rotation()&&(o.set(u,t.getShapePageBounds(u).center),a.push(...Object.values(v2(t,d.point(),e,u.props.growY,s,n))))}const c=a.length;let l;for(const[u,d]of o)for(let p=0;p<c;p++)l=a[p],l&&(b.Dist2(d,l)>i||t.isPointInShape(u,l)&&(a[p]=void 0));return ve(a)}function I2(t,e,n,s,r=!1){let i;const o=t.getCurrentPageShapesSorted(),a=(et+t.options.adjacentShapeMargin**2)**e.props.scale;for(let c=o.length-1;c>=0;c--){const l=o[c];if(l.type==="note"&&l.id!==e.id){const u=t.getShapePageBounds(l);if(u&&b.Dist2(u.center,n)<a&&t.isPointInShape(l,n)){i=l;break}}}if(t.complete(),!i||r){t.markHistoryStoppingPoint("creating note shape");const c=tt();t.createShape({id:c,type:"note",x:n.x,y:n.y,rotation:s,opacity:e.opacity,props:{...e.props,richText:ln(""),growY:0,fontSizeAdjustment:0,url:""}});const l=t.getShape(c);if(!l)return;const u=t.getPointInParentSpace(l,b.Sub(n,b.Rot(Nu.clone().mul(l.props.scale),s)));t.updateShape({id:c,type:"note",x:u.x,y:u.y}),i=t.getShape(c)}return t.zoomToSelectionIfOffscreen(16,{animation:{duration:t.options.animationMediumMs},inset:0}),i}let KN=class extends fe{static id="pointing";dragged=!1;info={};markId="";shape={};onEnter(){const{editor:e}=this,n=tt();this.markId=e.markHistoryStoppingPoint(`creating_note:${n}`);const s=this.editor.inputs.getOriginPagePoint().clone(),r=WN(this.editor,s,this.editor.user.getIsDynamicResizeMode()?1/this.editor.getZoomLevel():1);r&&s.sub(r);const i=qN(this.editor,n,s);i?this.shape=i:this.cancel()}onPointerMove(e){this.editor.inputs.getIsDragging()&&this.editor.setCurrentTool("select.translating",{...e,target:"shape",shape:this.shape,onInteractionEnd:"note",isCreating:!0,creatingMarkId:this.markId,onCreate:()=>{Hn(this.editor,this.shape.id)}})}onPointerUp(){this.complete()}onInterrupt(){this.cancel()}onComplete(){this.complete()}onCancel(){this.cancel()}complete(){this.editor.getInstanceState().isToolLocked?this.parent.transition("idle"):Hn(this.editor,this.shape.id,{info:this.info})}cancel(){this.editor.bailToMark(this.markId),this.parent.transition("idle",this.info)}};function WN(t,e,n){let s=w2/t.getZoomLevel(),r;for(const i of P2(t,0,n,0)){const o=b.Sub(e,i),a=o.len();a<s&&(s=a,r=o)}return r}function qN(t,e,n){t.createShape({id:e,type:"note",x:n.x,y:n.y,props:{scale:t.user.getIsDynamicResizeMode()?1/t.getZoomLevel():1}});const s=t.getShape(e);if(!s)return;t.select(e);const r=t.getShapeGeometry(s).bounds,i=vs(new b(s.x-r.width/2,s.y-r.height/2),t);return t.updateShapes([{id:e,type:"note",x:i.x,y:i.y}]),t.getShape(e)}class GN extends fe{static id="note";static initial="idle";static children(){return[$N,KN]}shapeType="note"}function YN(t){const e=t.getShapeAtPoint(t.inputs.getCurrentPagePoint(),{hitInside:!1,hitLabels:!1,margin:t.options.hitTestMargin/t.getZoomLevel(),renderingOnly:!0});if(!e)return t.setHoveredShape(null);let n;const s=t.getOutermostSelectableShape(e);return s===e||s.id===t.getFocusedGroupId()||t.getSelectedShapeIds().includes(s.id)?n=e:n=s,t.setHoveredShape(n.id)}const Zr=g0(YN,32);let VN=class extends fe{static id="idle";onPointerMove(e){switch(e.target){case"shape":case"canvas":Zr(this.editor)}}onPointerDown(e){this.parent.transition("pointing",e)}onEnter(){this.editor.setCursor({type:"cross",rotation:0})}onExit(){Zr.cancel()}onKeyDown(e){if(e.key==="Enter"){const n=this.editor.getOnlySelectedShape();if(!this.editor.canEditShape(n))return;this.editor.setCurrentTool("select"),Hn(this.editor,n.id,{info:e})}}onCancel(){this.editor.setCurrentTool("select")}},XN=class extends fe{static id="pointing";shape;markId="";enterTime=0;onEnter(){this.enterTime=Date.now()}onExit(){this.editor.setHintingShapes([])}onPointerMove(e){if(Date.now()-this.enterTime<150)return;const{editor:n}=this;if(!n.inputs.getIsPointing())return;const r=n.inputs.getOriginPagePoint(),i=n.inputs.getCurrentPagePoint(),o=Math.abs(r.x-i.x),c=Math.sqrt(n.getInstanceState().isCoarsePointer?n.options.coarseDragDistanceSquared:n.options.dragDistanceSquared)*6/n.getZoomLevel();if(o>c){const l=tt();this.markId=n.markHistoryStoppingPoint(`creating_text:${l}`);const u=this.createTextShape(l,r,!1,o);if(!u){this.cancel();return}this.shape=n.getShape(u),n.select(l);const d=this.editor.user.getIsDynamicResizeMode()?1/this.editor.getZoomLevel():1;n.setCurrentTool("select.resizing",{...e,target:"selection",handle:"right",isCreating:!0,creatingMarkId:this.markId,creationCursorOffset:{x:o*d,y:1},onInteractionEnd:"text",onCreate:()=>{Hn(n,u.id)}})}}onPointerUp(){this.complete()}onComplete(){this.cancel()}onCancel(){this.cancel()}onInterrupt(){this.cancel()}complete(){this.editor.markHistoryStoppingPoint("creating text shape");const e=tt(),n=this.editor.inputs.getOriginPagePoint();this.createTextShape(e,n,!0,20)&&(this.editor.select(e),Hn(this.editor,e))}cancel(){this.parent.transition("idle"),this.editor.bailToMark(this.markId)}createTextShape(e,n,s,r){this.editor.createShape({id:e,type:"text",x:n.x,y:n.y,props:{richText:ln(""),autoSize:s,w:r,scale:this.editor.user.getIsDynamicResizeMode()?1/this.editor.getZoomLevel():1}});const i=this.editor.getShape(e);if(!i){this.cancel();return}const o=this.editor.getShapePageBounds(i),a=new b;if(s)switch(i.props.textAlign){case"start":{a.x=0;break}case"middle":{a.x=-o.width/2;break}case"end":{a.x=-o.width;break}}else a.x=0;if(a.y=-o.height/2,On(i.parentId)){const u=this.editor.getShapeParentTransform(i);a.rot(-u.rotation())}const c=i.x+a.x,l=i.y+a.y;if(this.editor.getInstanceState().isGridMode){const u=new b(c,l),d=vs(u,this.editor),p=b.Sub(u,d);this.editor.updateShape({...i,x:c-p.x,y:l-p.y})}else this.editor.updateShape({...i,x:c,y:l});return i}};class ZN extends fe{static id="text";static initial="idle";static children(){return[VN,XN]}shapeType="text"}const JN=[ZN,AN,LN,GN,zN,MN,kN,RN],QN=Ye.forwardRef(function({shapeId:e,isEditing:n,richText:s,handleFocus:r,handleChange:i,handleBlur:o,handleKeyDown:a,handleDoubleClick:c,hasCustomTabBehavior:l,handlePaste:u},d){const p=z(),f=yo("tip-tap-editor"),g=p.getTextOptions().tipTapConfig,x=v.useRef(s),y=v.useRef(null),m=v.useRef(null);v.useLayoutEffect(()=>{y.current?x.current!==s&&y.current.commands.setContent(s):x.current=s},[s]);const S=v.useRef({selectAll:!1,caretPosition:null});v.useLayoutEffect(()=>{function O(T){T.shapeId===p.getEditingShapeId()&&(S.current.selectAll=!0)}function k(T){T.shapeId===p.getEditingShapeId()&&(S.current.caretPosition=T.point)}return p.on("select-all-text",O),p.on("place-caret",k),()=>{p.off("select-all-text",O),p.off("place-caret",k)}},[p,n]);const w=fr(i),P=fr(a),_=fr(r),I=fr(o),C=fr(c),E=fr(u);return v.useLayoutEffect(()=>{if(!n||!g||!m.current)return;const{editorProps:O,...k}=g,T=new uA({element:m.current,autofocus:!0,editable:n,onUpdate:R=>{const M=R.editor.state.doc.toJSON();x.current=M,w({richText:M})},onFocus:_,onBlur:I,onCreate:R=>{if(p.getEditingShapeId()!==e)return;const M=R.editor;p.setRichTextEditor(M);const{selectAll:L,caretPosition:U}=S.current;if(L)M.chain().focus().selectAll().run();else if(U){const V=M.view.posAtCoords({left:U.x,top:U.y})?.pos;V?M.chain().focus().setTextSelection(V).run():M.chain().focus().selectAll().run()}},editorProps:{handleKeyDown:(R,M)=>{!l&&M.key==="Tab"&&eU(p,R,M),P(M)},handlePaste:(R,M)=>{if(E(M),M.defaultPrevented)return!0},handleDoubleClick:(R,M,L)=>C(L),...O},coreExtensionOptions:{clipboardTextSerializer:{blockSeparator:`
`}},enableCoreExtensions:{textDirection:!1},textDirection:"auto",...k,content:x.current}),D=p.timers.setTimeout(()=>{S.current.caretPosition||S.current.selectAll?T.commands.focus():T.commands.focus("end"),S.current.selectAll=!1,S.current.caretPosition=null},100);return y.current=T,()=>{y.current=null,clearTimeout(D),T.destroy()}},[n,g,_,I,C,w,E,P,p,e,l]),!n||!g?null:h.jsx("div",{id:f,ref:d,tabIndex:-1,"data-testid":"rich-text-area",className:"tl-rich-text tl-text tl-text-input",onContextMenu:n?O=>O.stopPropagation():void 0,onPointerDownCapture:O=>O.stopPropagation(),onTouchEnd:O=>O.stopPropagation(),onDragStart:Pe,children:h.jsx("div",{className:"tl-rich-text",ref:m})})});function eU(t,e,n){n.preventDefault();const s=t.getRichTextEditor();if(s?.isActive("bulletList")||s?.isActive("orderedList"))return;const{state:r,dispatch:i}=e,{$from:o,$to:a}=r.selection,c=n.shiftKey;let l=r.tr,u=a.end();for(;u>=o.start();){const p=r.doc.resolve(u).blockRange();if(!p)break;const f=p.start,g=p.end,x=r.doc.textBetween(f,g,`
`);let y=!1;r.doc.nodesBetween(f,g,m=>{if(m.type.name==="bulletList"||m.type.name==="orderedList")return y=!0,!1}),y||(c?x.startsWith("	")&&(l=l.delete(f+1,f+2)):l=l.insertText("	",f+1)),u=f-1}const d=r.selection.map(l.doc,l.mapping);l.setSelection(d),l.docChanged&&i(l)}function _2(t){return t==="start-legacy"||t==="middle-legacy"||t==="end-legacy"}function tU(t,e,n){const s=C2(t),r=s.isEditing,i=z(),o=v.useRef(null),a=(n||"").trim().length===0;v.useEffect(()=>{function u(d){d.shapeId===t&&o.current?.select?.()}return i.on("select-all-text",u),()=>{i.off("select-all-text",u)}},[i,t,r]),v.useEffect(()=>{r&&(document.activeElement!==o.current&&o.current?.focus(),i.getInstanceState().isCoarsePointer&&o.current?.select(),qe.isSafari&&(o.current?.blur(),o.current?.focus()))},[i,r]);const c=v.useCallback(u=>{i.getEditingShapeId()===t&&u.key==="Enter"&&(u.ctrlKey||u.metaKey)&&i.complete()},[i,t]),l=v.useCallback(({plaintext:u})=>{if(i.getEditingShapeId()!==t)return;const d=Oc.normalizeText(u||"");i.updateShape({id:t,type:e,props:{text:d}})},[i,t,e]);return{rInput:o,handleKeyDown:c,handleChange:l,isEmpty:a,...s}}function Yy(t,e){return $("isReadyForEditing",()=>{const n=t.getEditingShapeId();return n!==null&&(n===e||t.getHoveredShapeId()===e)},[t,e])}function C2(t){const e=z(),n=$("isEditing",()=>e.getEditingShapeId()===t,[e]),s=Yy(e,t),r=v.useCallback(o=>{e.dispatch({...cn(e,o),type:"pointer",name:"pointer_down",target:"shape",shape:e.getShape(t)}),o.stopPropagation()},[e,t]),i=v.useCallback(o=>{if(e.getEditingShapeId()===t&&o.clipboardData){const a=o.clipboardData.getData("text/html");a&&a.includes("<div data-tldraw")&&Pe(o)}},[e,t]);return{handleFocus:yc,handleBlur:yc,handleInputPointerDown:r,handleDoubleClick:e.markEventAsHandled,handlePaste:i,isEditing:n,isReadyForEditing:s}}function nU(t,e,n){const s=C2(t),r=s.isEditing,i=z(),o=v.useRef(null),a=n&&kt(n);v.useEffect(()=>{if(!r)return;const u=o.current?.querySelector("[contenteditable]");u&&document.activeElement!==o.current&&u.focus()},[i,r]);const c=v.useCallback(u=>{i.getEditingShapeId()===t&&u.key==="Enter"&&At(u)&&i.complete()},[i,t]),l=v.useCallback(({richText:u})=>{i.getEditingShapeId()===t&&i.updateShape({id:t,type:e,props:{richText:u}})},[i,t,e]);return{rInput:o,handleKeyDown:c,handleChange:l,isEmpty:a,...s}}const Uu=Ye.memo(function({shapeId:e,type:n,richText:s,labelColor:r,font:i,fontSize:o,lineHeight:a,align:c,verticalAlign:l,wrap:u,isSelected:d,padding:p=0,onKeyDown:f,classNamePrefix:g,style:x,textWidth:y,textHeight:m,hasCustomTabBehavior:S,showTextOutline:w=!0}){const P=z(),_=Ye.useRef(!1),{rInput:I,isEmpty:C,isEditing:E,isReadyForEditing:O,...k}=nU(e,n,s),T=v.useMemo(()=>{if(s)return qy(P,s)},[P,s]),D=$("isSelectToolActive",()=>P.getCurrentToolId()==="select",[P]);Qd("isDragging",()=>{P.getInstanceState(),_.current=P.inputs.getIsDragging()},[P]);const R=_2(c),M=U=>{if(U.target instanceof HTMLElement&&(U.target.tagName==="A"||U.target.closest("a"))){if(Pe(U),!D)return;const V=U.target.closest("a")?.getAttribute("href")??"",J=Z=>{Z.name!=="pointer_up"||!V||(_.current||vy(V,"_blank",!1),P.off("event",J))};P.on("event",J)}};if(!E&&C)return null;const L=g||"tl-text";return h.jsx("div",{className:de(`${L}-label tl-text-wrapper tl-rich-text-wrapper`,w?"tl-text__outline":"tl-text__no-outline"),"aria-hidden":!E,"data-font":i,"data-align":c,"data-hastext":!C,"data-isediting":E,"data-textwrap":!!u,"data-isselected":d,style:{justifyContent:c==="middle"||R?"center":c,alignItems:l==="middle"?"center":l,padding:p,...x},children:h.jsxs("div",{className:`${L}-label__inner tl-text-content__wrapper`,style:{fontSize:o,lineHeight:a.toString(),minHeight:Math.floor(o*a)+"px",minWidth:Math.ceil(y||0),color:r,width:y?Math.ceil(y):void 0,height:m?Math.ceil(m):void 0},children:[h.jsx("div",{className:`${L} tl-text tl-text-content`,dir:"auto",children:s&&h.jsx("div",{className:"tl-rich-text","data-is-select-tool-active":D,dangerouslySetInnerHTML:{__html:T||""},onPointerDown:M,"data-is-ready-for-editing":O})}),(O||d)&&h.jsx(QN,{ref:I,richText:s,isEditing:E,shapeId:e,...k,hasCustomTabBehavior:S,handleKeyDown:f??k.handleKeyDown})]})})});function Hu({bounds:t,richText:e,fontSize:n,font:s,align:r,verticalAlign:i,wrap:o,labelColor:a,padding:c,showTextOutline:l=!0}){const u=z(),d=qy(u,e),p=r==="middle"?"center":r==="start"?"start":"end",f=r==="middle"?"center":r==="start"?"flex-start":"flex-end",g=i==="middle"?"center":i==="start"?"flex-start":"flex-end",x={display:"flex",fontFamily:bD[s],height:"100%",justifyContent:f,alignItems:g,padding:`${c}px`},y={fontSize:`${n}px`,wrap:o?"wrap":"nowrap",color:a,lineHeight:$n.lineHeight,textAlign:p,width:"100%",wordWrap:"break-word",overflowWrap:"break-word",whiteSpace:"pre-wrap",textShadow:l?"var(--tl-text-outline)":"none"};return h.jsx("foreignObject",{x:t.minX,y:t.minY,width:t.w,height:t.h,className:de("tl-export-embed-styles tl-rich-text tl-rich-text-svg",l?"tl-text__outline":"tl-text__no-outline"),children:h.jsx("div",{style:x,children:h.jsx("div",{dangerouslySetInnerHTML:{__html:d},style:y})})})}function Vy(t){return{key:`${Ei.id}:${t}`,async getElement(){return t!=="pattern"?null:h.jsx(sU,{})}}}function sU(){const t=Zy(),e=yo(),n=Us(),s=8/12;return h.jsxs(h.Fragment,{children:[h.jsxs("mask",{id:e,children:[h.jsx("rect",{x:"0",y:"0",width:"8",height:"8",fill:"white"}),h.jsxs("g",{strokeLinecap:"round",stroke:"black",children:[h.jsx("line",{x1:s*1,y1:s*3,x2:s*3,y2:s*1}),h.jsx("line",{x1:s*5,y1:s*7,x2:s*7,y2:s*5}),h.jsx("line",{x1:s*9,y1:s*11,x2:s*11,y2:s*9})]})]}),h.jsx("pattern",{id:t(1,n.id),width:"8",height:"8",patternUnits:"userSpaceOnUse",children:h.jsx("rect",{x:"0",y:"0",width:"8",height:"8",fill:n.solid,mask:`url(#${e})`})})]})}function Xy(){return{key:`${Ei.id}:pattern`,component:aU}}const sc=8,Fv=(t,e,n)=>new Promise((s,r)=>{const i=sc*e*t,o=document.createElement("canvas");o.width=i,o.height=i;const a=o.getContext("2d");if(!a)return;a.fillStyle=n?Id.darkMode.solid:Id.lightMode.solid,a.fillRect(0,0,i,i),a.globalCompositeOperation="destination-out",a.lineCap="round",a.lineWidth=1.25*e*t;const c=8/12,l=u=>u*e*t;a.beginPath(),a.moveTo(l(c*1),l(c*3)),a.lineTo(l(c*3),l(c*1)),a.moveTo(l(c*5),l(c*7)),a.lineTo(l(c*7),l(c*5)),a.moveTo(l(c*9),l(c*11)),a.lineTo(l(c*11),l(c*9)),a.stroke(),o.toBlob(u=>{!u||mt.throwToBlob.get()?r():s(u)})}),Bv=(t,e)=>{const n=document.createElement("canvas");n.width=t[0],n.height=t[1];const s=n.getContext("2d");return s?(e(s),n.toDataURL()):""};let cg=null;function rU(){return cg||(cg={white:Bv([1,1],t=>{t.fillStyle="#f8f9fa",t.fillRect(0,0,1,1)}),black:Bv([1,1],t=>{t.fillStyle="#212529",t.fillRect(0,0,1,1)})}),cg}function T2(t){return Math.ceil(Math.log2(Math.max(1,t)))}function Zy(){const t=tr("hash_pattern");return v.useCallback((e,n)=>{const s=T2(e);return ty(t,`${n}_${s}`)},[t])}function E2(t){const e=[],s=T2(t);for(let r=0;r<=s;r++)e.push(Math.pow(2,r));return e}function iU(t){const e=rU();return E2(t).flatMap(n=>[{zoom:n,url:e.white,theme:"light"},{zoom:n,url:e.black,theme:"dark"}])}function oU(){const t=z(),e=$("devicePixelRatio",()=>t.getInstanceState().devicePixelRatio,[t]),n=$("maxZoom",()=>Math.ceil(Fs(t.getCameraOptions().zoomSteps)),[t]),[s,r]=v.useState(!1),[i,o]=v.useState(()=>iU(n)),a=Zy();return v.useEffect(()=>{const l=Promise.all(E2(n).flatMap(d=>[Fv(e,d,!1).then(p=>({zoom:d,theme:"light",url:URL.createObjectURL(p)})),Fv(e,d,!0).then(p=>({zoom:d,theme:"dark",url:URL.createObjectURL(p)}))]));let u=!1;return l.then(d=>{u||(o(d),r(!0))}),()=>{u=!0,r(!1),l.then(d=>{for(const{url:p}of d)URL.revokeObjectURL(p)})}},[e,n]),{defs:h.jsx(h.Fragment,{children:i.map(l=>{const u=a(l.zoom,l.theme);return h.jsx("pattern",{id:u,width:sc,height:sc,patternUnits:"userSpaceOnUse",children:h.jsx("image",{href:l.url,width:sc,height:sc})},u)})}),isReady:s}}function aU(){const t=z(),e=v.useRef(null),{defs:n,isReady:s}=oU();return v.useEffect(()=>{if(s&&qe.isSafari){const r=k2(e.current);r&&t.timers.requestAnimationFrame(()=>{r.style.display="none",t.timers.requestAnimationFrame(()=>{r.style.display=""})})}},[t,s]),h.jsx("g",{ref:e,"data-testid":s?"ready-pattern-fill-defs":void 0,children:n})}function k2(t){return t.classList.contains("tl-html-layer")?t:t.parentElement?k2(t.parentElement):null}const Lc=Ye.memo(function({theme:e,d:n,color:s,fill:r,scale:i}){switch(r){case"none":return null;case"solid":return h.jsx("path",{fill:Ue(e,s,"semi"),d:n});case"semi":return h.jsx("path",{fill:e.solid,d:n});case"fill":return h.jsx("path",{fill:Ue(e,s,"fill"),d:n});case"pattern":return h.jsx(cU,{theme:e,color:s,fill:r,d:n,scale:i});case"lined-fill":return h.jsx("path",{fill:Ue(e,s,"linedFill"),d:n})}});function cU({d:t,color:e,theme:n}){const s=z(),r=Jc(),i=$("zoomLevel",()=>s.getEfficientZoomLevel(),[s]),o=Zy(),a=i<=.18;return h.jsxs(h.Fragment,{children:[h.jsx("path",{fill:Ue(n,e,"pattern"),d:t}),h.jsx("path",{fill:r?`url(#${o(1,n.id)})`:a?Ue(n,e,"semi"):`url(#${o(i,n.id)})`,d:t})]})}function Rc(t=.25){const e=z();return $("efficient zoom threshold",()=>e.getEfficientZoomLevel()<t,[e,t])}function A2(t,e,n){switch(e.type){case"straight":return new We().moveTo(e.start.point.x,e.start.point.y,{offset:0,roundness:0}).lineTo(e.end.point.x,e.end.point.y,{offset:0,roundness:0}).toSvg(n);case"arc":return new We().moveTo(e.start.point.x,e.start.point.y,{offset:0,roundness:0}).circularArcTo(e.bodyArc.radius,!!e.bodyArc.largeArcFlag,!!e.bodyArc.sweepFlag,e.end.point.x,e.end.point.y,{offset:0,roundness:0}).toSvg(n);case"elbow":{const s=new We;s.moveTo(e.start.point.x,e.start.point.y,{offset:0});for(let r=1;r<e.route.points.length;r++){const i=e.route.points[r];e.route.skipPointsWhenDrawing.has(i)||s.lineTo(i.x,i.y,{offset:r===e.route.points.length-1?0:void 0})}return s.toSvg(n)}default:Ke(e,"type")}}function lU(t,e){switch(t.type){case"straight":return new We().moveTo(t.start.handle.x,t.start.handle.y).lineTo(t.end.handle.x,t.end.handle.y).toSvg(e);case"arc":return new We().moveTo(t.start.handle.x,t.start.handle.y).circularArcTo(t.handleArc.radius,!!t.handleArc.largeArcFlag,!!t.handleArc.sweepFlag,t.end.handle.x,t.end.handle.y).toSvg(e);case"elbow":{const n=d6(t.elbow,t.route);return We.lineThroughPoints(n.points).toSvg(e)}default:Ke(t,"type")}}function aa(t,e){const n=Os(t,e);switch(n.type){case"straight":return new sa({start:b.From(n.start.point),end:b.From(n.end.point)});case"arc":return new kT({center:b.Cast(n.handleArc.center),start:b.Cast(n.start.point),end:b.Cast(n.end.point),sweepFlag:n.bodyArc.sweepFlag,largeArcFlag:n.bodyArc.largeArcFlag});case"elbow":return new Zc({points:n.route.points});default:Ke(n,"type")}}const dU=su("arrow label size",(t,e)=>{t.fonts.trackFontsForShape(e);let n=0,s=0;const r=aa(t,e),i=kt(e.props.richText),o=Dc(t,i?ln("i"):e.props.richText),a=r.bounds,c=Xg(e),{w:l,h:u}=t.textMeasure.measureHtml(o,{...$n,fontFamily:ji[e.props.font],fontSize:c,maxWidth:null});n=l,s=u;let d=!1;const p=Os(t,e),f=j2(e),g=p.type==="elbow"?Math.max(p.elbow.A.arrowheadOffset+f,32)+Math.max(p.elbow.B.arrowheadOffset+f,32):64;if(a.width>a.height?(n=Math.max(Math.min(l,g),Math.min(a.width-g,l)),d=!0):n>16*c&&(n=16*c,d=!0),d){const{w:x,h:y}=t.textMeasure.measureHtml(o,{...$n,fontFamily:ji[e.props.font],fontSize:c,maxWidth:n});n=x,s=y}return new b(n,s).addScalar(Vg*2*e.props.scale)},{areRecordsEqual:(t,e)=>{if(t.props===e.props)return!0;const n=BA(t.props,e.props);return n.length===1&&n[0]==="labelPosition"}});function M2(t,e){return dU.get(t,e.id)??new b(0,0)}function j2(t){const e=Ht[t.props.size];return(N9+(e-Ht.s)*2+(e===Ht.xl?20:0))*t.props.scale}function uU(t,e,n){const s=aa(t,e),r=[],i=[new os({children:[s],debugColor:"lime"})],o=M2(t,e),a=j2(e),c=a/s.length;let l,u;if(n.type==="elbow")r.push(n.start.point,n.end.point),l=X.FromCenter(n.start.point,o).expandBy(a),u=X.FromCenter(n.end.point,o).expandBy(a);else{const m=s.interpolateAlongEdge(c),S=s.interpolateAlongEdge(1-c);r.push(m,S),l=X.FromCenter(m,o),u=X.FromCenter(S,o)}const d=s.intersectPolygon(l.corners),p=s.intersectPolygon(u.corners),f=zv(n.start.point,d),g=zv(n.end.point,p);let x=f?s.uninterpolateAlongEdge(f):.5,y=g?s.uninterpolateAlongEdge(g):.5;x>y&&(x=.5,y=.5);for(const m of[...d,...p,...r])i.push(new Rd({x:m.x-3,y:m.y-3,radius:3,isFilled:!1,debugColor:"magenta",ignore:!0}));return i.push(new Ic({points:l.corners,debugColor:"lime",isFilled:!1,ignore:!0}),new Ic({points:u.corners,debugColor:"lime",isFilled:!1,ignore:!0})),{start:x,end:y,dbg:i}}function dd(t,e){if(!(t.getEditingShapeId()===e.id)&&kt(e.props.richText)){const p=aa(t,e).interpolateAlongEdge(.5);return{box:X.FromCenter(p,new b(0,0)),debugGeom:[]}}const s=[],r=Os(t,e),i={hasStartBinding:!!r.bindings.start,hasEndBinding:!!r.bindings.end,hasStartArrowhead:r.start.arrowhead!=="none",hasEndArrowhead:r.end.arrowhead!=="none"},o=uU(t,e,r);o.dbg&&s.push(...o.dbg);const a=hU(e,o,i),l=aa(t,e).interpolateAlongEdge(a),u=M2(t,e);return{box:X.FromCenter(l,u),debugGeom:s}}function hU(t,e,n){const{hasEndArrowhead:s,hasEndBinding:r,hasStartBinding:i,hasStartArrowhead:o}=n;return Ce(t.props.labelPosition,o||i?e.start:0,s||r?e.end:1)}function zv(t,e){let n=null,s=-1/0;for(const r of e){const i=b.Dist2(t,r);i>s&&(n=r,s=i)}return n}function Xg(t){return $9[t.props.size]*t.props.scale}function D2(t,e){const n=Os(t,e);switch(n.type){case"straight":case"arc":return .5;case"elbow":{const s=n.route.midpointHandle,r=aa(t,e);return s&&r?r.uninterpolateAlongEdge(s.point):.5}default:Ke(n,"type")}}function O2(t,e){if(!t.isShapeOfType(e,"arrow"))return!1;const n=t.getPointInShapeSpace(e,t.inputs.getCurrentPagePoint()),s=t.getShapeGeometry(e).children[1];return s&&Bn(n,s.vertices)}function pU(t,e,n){const s=e==="end"?t.end.point:t.start.point;let r;switch(t.type){case"straight":{const i=e==="end"?t.start.point:t.end.point,o=b.Dist(i,s),a=Ce(o/5,n,n*3);r=b.Nudge(s,i,a);break}case"arc":{const i=Math.abs(t.bodyArc.length),o=Ce(i/5,n,n*3),a=bL(s,o,t.handleArc.center,t.handleArc.radius);r=e==="end"?t.handleArc.sweepFlag?a[0]:a[1]:t.handleArc.sweepFlag?a[1]:a[0];break}case"elbow":{const i=e==="end"?t.route.points[t.route.points.length-2]:t.route.points[1],o=b.ManhattanDist(i,s),a=Ce(o/2,n,n*3);r=i?b.Nudge(s,i,a):s;break}default:Ke(t,"type")}return b.IsNaN(r)&&(r=s),{point:s,int:r}}function fU({point:t,int:e}){const n=b.RotWith(e,t,Ve/6),s=b.RotWith(e,t,-Ve/6);return`M ${n.x} ${n.y} L ${t.x} ${t.y} L ${s.x} ${s.y}`}function gU({point:t,int:e}){const n=b.RotWith(e,t,Ve/6),s=b.RotWith(e,t,-Ve/6);return`M ${n.x} ${n.y} L ${s.x} ${s.y} L ${t.x} ${t.y} Z`}function mU({point:t,int:e}){const n=b.Sub(e,t).div(2),s=b.Add(t,b.Rot(n,vt)),r=b.Sub(t,b.Rot(n,vt));return`M ${s.x} ${s.y} L ${e.x} ${e.y} L ${r.x} ${r.y} Z`}function yU({point:t,int:e}){const n=b.Lrp(t,e,.45),s=b.Dist(n,t);return`M ${n.x-s},${n.y}
  a ${s},${s} 0 1,0 ${s*2},0
  a ${s},${s} 0 1,0 -${s*2},0 `}function SU({point:t,int:e}){const n=b.Lrp(t,e,.75),s=b.RotWith(n,t,Ve/4),r=b.RotWith(n,t,-Ve/4),i=b.Lrp(s,r,.5);return i.add(b.Sub(i,t)),`M ${i.x} ${i.y} L ${r.x} ${r.y} ${t.x} ${t.y} L ${s.x} ${s.y} Z`}function xU({int:t,point:e}){const n=b.Lrp(e,t,.85),s=b.Sub(n,e).div(2),r=b.Add(e,b.Rot(s,vt)),i=b.Sub(e,b.Rot(s,vt)),o=b.Add(n,b.Rot(s,vt)),a=b.Sub(n,b.Rot(s,vt));return`M ${r.x} ${r.y} L ${o.x} ${o.y} L ${a.x} ${a.y} L ${i.x} ${i.y} Z`}function bU({int:t,point:e}){const n=b.Sub(t,e).div(2),s=b.Add(e,b.Rot(n,vt)),r=b.Sub(e,b.Rot(n,vt));return`M ${s.x} ${s.y} L ${r.x} ${r.y}`}function Hd(t,e,n){const s=e==="end"?t.end.arrowhead:t.start.arrowhead;if(s==="none")return;const r=pU(t,e,n);if(r){switch(s){case"bar":return bU(r);case"square":return xU(r);case"diamond":return SU(r);case"dot":return yU(r);case"inverted":return mU(r);case"arrow":return fU(r);case"triangle":return gU(r)}return""}}function wU({arrow:t}){const e=z(),n=$("elbow arrow grid",()=>{try{return rE(e,e.getShape(t.id),Vt(e,t))}catch(o){console.error(o);return}},[e,t.id]);if(!n)return null;const s=X.Common([n.A.original,n.B.original]).expandBy(50),r=n.route?.name??"",i=n.route?.midpointHandle;return h.jsxs(h.Fragment,{children:[n.midX!==null&&h.jsx(Vi,{a:{x:n.midX,y:s.minY},b:{x:n.midX,y:s.maxY},stroke:"red"}),n.midY!==null&&h.jsx(Vi,{a:{x:s.minX,y:n.midY},b:{x:s.maxX,y:n.midY},stroke:"blue"}),i?.axis==="x"&&n.midXRange&&h.jsx(Vi,{a:{x:n.midXRange.lo,y:i.point.y},b:{x:n.midXRange.hi,y:i.point.y},stroke:"red",strokeDasharray:"0 2"}),i?.axis==="y"&&n.midYRange&&h.jsx(Vi,{a:{x:i.point.x,y:n.midYRange.lo},b:{x:i.point.x,y:n.midYRange.hi},stroke:"blue",strokeDasharray:"0 2"}),h.jsx(Do,{box:n.A.original,stroke:"orange"}),h.jsx(Do,{box:n.A.expanded,stroke:"orange",strokeWidth:.5}),h.jsx(Do,{box:n.A.original.clone().expandBy(n.options.minElbowLegLength),stroke:"orange",strokeWidth:.5}),h.jsx(Do,{box:n.B.original,stroke:"lightskyblue"}),h.jsx(Do,{box:n.B.expanded,stroke:"lightskyblue",strokeWidth:.5}),h.jsx(Do,{box:n.B.original.clone().expandBy(n.options.minElbowLegLength),stroke:"lightskyblue",strokeWidth:.5}),h.jsx(Si,{edge:n.A.edges.top,axis:"x",stroke:"orange"}),h.jsx(Si,{edge:n.B.edges.top,axis:"x",stroke:"lightskyblue"}),h.jsx(Si,{edge:n.A.edges.right,axis:"y",stroke:"orange"}),h.jsx(Si,{edge:n.B.edges.right,axis:"y",stroke:"lightskyblue"}),h.jsx(Si,{edge:n.A.edges.bottom,axis:"x",stroke:"orange"}),h.jsx(Si,{edge:n.B.edges.bottom,axis:"x",stroke:"lightskyblue"}),h.jsx(Si,{edge:n.A.edges.left,axis:"y",stroke:"orange"}),h.jsx(Si,{edge:n.B.edges.left,axis:"y",stroke:"lightskyblue"}),n.route&&h.jsx(vU,{route:n.route.points,strokeWidth:10}),h.jsx("text",{x:s.minX+5,y:s.minY-3,fontSize:10,fill:"black",stroke:"var(--tl-color-background)",strokeWidth:2,paintOrder:"stroke",children:r}),h.jsxs("text",{x:n.A.expanded.x,y:n.A.expanded.y,fontSize:10,fill:"black",stroke:"var(--tl-color-background)",strokeWidth:2,paintOrder:"stroke",children:["A",n.route&&`, ${n.route.aEdgePicking}`,n.A.isPoint&&", point"]}),h.jsxs("text",{x:n.B.expanded.x,y:n.B.expanded.y,fontSize:10,fill:"black",stroke:"var(--tl-color-background)",strokeWidth:2,paintOrder:"stroke",children:["B",n.route&&`, ${n.route.bEdgePicking}`,n.B.isPoint&&", point"]})]})}function Vi({a:t,b:e,...n}){return h.jsx("line",{fill:"none",strokeWidth:1,strokeDasharray:"4,4",stroke:"green",x1:t.x,y1:t.y,x2:e.x,y2:e.y,...n})}function vU({route:t,...e}){return h.jsx("polyline",{fill:"none",stroke:"darkorchid",strokeWidth:3,opacity:.5,points:t.map(n=>`${n.x},${n.y}`).join(" "),...e})}function Si({edge:t,axis:e,...n}){if(!t||t.expanded===null)return null;const s=r=>e==="x"?{x:r.y,y:r.x}:r;return h.jsxs("g",{children:[h.jsx(Vi,{a:s({x:t.expanded,y:t.cross.min}),b:s({x:t.expanded,y:t.cross.max}),strokeDasharray:"0",strokeWidth:1.5,...n}),h.jsx(Vi,{a:s({x:t.expanded-4,y:t.cross.min}),b:s({x:t.expanded+4,y:t.cross.min}),strokeDasharray:"0",strokeWidth:1.5,...n}),h.jsx(Vi,{a:s({x:t.expanded-4,y:t.cross.max}),b:s({x:t.expanded+4,y:t.cross.max}),strokeDasharray:"0",strokeWidth:1.5,...n})]})}function Do({box:t,...e}){return h.jsx("rect",{x:t.minX,y:t.minY,width:t.width,height:t.height,strokeDasharray:"4,4",strokeWidth:1,fill:"none",...e})}const PU=new dn;function IU(t){return PU.get(t,e=>{const n=K("current selected arrow shape",()=>{const r=e.getOnlySelectedShape();return!r||!e.isShapeOfType(r,"arrow")?null:r.id}),s=e.store.query.ids("shape",()=>{const r=n.get();return r?{type:{eq:"arrow"},id:{neq:r}}:{type:{eq:"arrow"}}});return K("elbow arrow snap lines",()=>{const r=new Map,i=e.getCurrentPageShapeIds(),o=e.getViewportPageBounds();for(const a of s.get()){if(!i.has(a))continue;const c=e.getShape(a);if(c?.type!=="arrow")continue;const l=e.getShapePageBounds(a);if(!l||!o.includes(l))continue;const u=Vt(e,c),d=e.getShapePageTransform(a);if(!d)continue;const p=e.getShapeGeometry(a),f=d.applyToPoints(p.vertices);for(let g=1;g<f.length;g++){const x=f[g-1],y=f[g];let m=b.Angle(x,y);m<0&&(m+=Math.PI);let S=r.get(m);S||(S=new Set,r.set(m,S));const w=rc(x,m);S.add({perpDistance:w,startBoundShapeId:u.start?.toId,endBoundShapeId:u.end?.toId})}}return r})}).get()}function rc(t,e){const n=b.FromAngle(e).per();return b.Dpr(t,n)}class _U extends zi{static type="arrow";static props=$1;static migrations=N1;options={expandElbowLegLength:{s:28,m:36,l:44,xl:66},minElbowLegLength:{s:Ht.s*3,m:Ht.m*3,l:Ht.l*3,xl:Ht.xl*3},minElbowHandleDistance:16,arcArrowCenterSnapDistance:16,elbowArrowCenterSnapDistance:24,elbowArrowEdgeSnapDistance:20,elbowArrowPointSnapDistance:24,elbowArrowAxisSnapDistance:16,labelCenterSnapDistance:10,elbowMidpointSnapDistance:10,elbowMinSegmentLengthToShowMidpointHandle:20,hoverPreciseTimeout:600,pointingPreciseTimeout:320,shouldBeExact(e){return e.inputs.getAltKey()},shouldIgnoreTargets(e){return e.inputs.getCtrlKey()},showTextOutline:!0};canEdit(){return!0}canBind({toShapeType:e}){return e!=="arrow"}canSnap(){return!1}hideResizeHandles(){return!0}hideRotateHandle(){return!0}hideSelectionBoundsBg(){return!0}hideSelectionBoundsFg(){return!0}hideInMinimap(){return!0}canBeLaidOut(e,n){if(n.type==="flip"){const s=Vt(this.editor,e),{start:r,end:i}=s,{shapes:o=[]}=n;if(r&&!o.find(a=>a.id===r.toId)||i&&!o.find(a=>a.id===i.toId))return!1}return!0}getFontFaces(e){return kt(e.props.richText)?Ct:Cu(this.editor,e.props.richText,{family:`tldraw_${e.props.font}`,weight:"normal",style:"normal"})}getDefaultProps(){return{kind:"arc",elbowMidPoint:.5,dash:"draw",size:"m",fill:"none",color:"black",labelColor:"black",bend:0,start:{x:0,y:0},end:{x:2,y:0},arrowheadStart:"none",arrowheadEnd:"arrow",richText:ln(""),labelPosition:.5,font:"draw",scale:1}}getGeometry(e){const n=this.editor.getEditingShapeId()===e.id,s=Os(this.editor,e),r=[],i=s.type==="straight"?new sa({start:b.From(s.start.point),end:b.From(s.end.point)}):s.type==="arc"?new kT({center:b.Cast(s.handleArc.center),start:b.Cast(s.start.point),end:b.Cast(s.end.point),sweepFlag:s.bodyArc.sweepFlag,largeArcFlag:s.bodyArc.largeArcFlag}):new Zc({points:s.route.points});let o;if(n||!kt(e.props.richText)){const a=dd(this.editor,e);mt.debugGeometry.get()&&r.push(...a.debugGeom),o=new rr({x:a.box.x,y:a.box.y,width:a.box.w,height:a.box.h,isFilled:!0,isLabel:!0})}return new os({children:[...o?[i,o]:[i],...r]})}getHandles(e){const n=Os(this.editor,e),s=[{id:"start",type:"vertex",index:"a1",x:n.start.handle.x,y:n.start.handle.y},{id:"end",type:"vertex",index:"a3",x:n.end.handle.x,y:n.end.handle.y}];if(e.props.kind==="arc"&&(n.type==="straight"||n.type==="arc")&&s.push({id:"middle",type:"virtual",index:"a2",x:n.middle.x,y:n.middle.y}),e.props.kind==="elbow"&&n.type==="elbow"&&n.route.midpointHandle){const r=this.editor.getShapePageTransform(e.id),i=r.applyToPoint(n.route.midpointHandle.segmentStart),o=r.applyToPoint(n.route.midpointHandle.segmentEnd);b.Dist(i,o)*this.editor.getEfficientZoomLevel()>this.options.elbowMinSegmentLengthToShowMidpointHandle&&s.push({id:"middle",type:"vertex",index:"a2",x:n.route.midpointHandle.point.x,y:n.route.midpointHandle.point.y})}return s}getText(e){return co(this.editor,e.props.richText)}onHandleDrag(e,n){const s=n.handle.id;switch(s){case"middle":switch(e.props.kind){case"arc":return this.onArcMidpointHandleDrag(e,n);case"elbow":return this.onElbowMidpointHandleDrag(e,n);default:Ke(e.props.kind)}case"start":case"end":return this.onTerminalHandleDrag(e,n,s);default:Ke(s)}}onArcMidpointHandleDrag(e,{handle:n}){const s=Vt(this.editor,e),{start:r,end:i}=Uo(this.editor,e,s),o=b.Sub(i,r),a=b.Per(o),c=b.Med(i,r),l=b.Sub(c,a),u=b.Add(c,a),d=b.NearestPointOnLineSegment(l,u,n,!1);let p=b.Dist(d,c);return b.Clockwise(d,i,c)&&(p*=-1),{id:e.id,type:e.type,props:{bend:p}}}onElbowMidpointHandleDrag(e,{handle:n}){const s=Os(this.editor,e);if(s?.type!=="elbow")return;const r=this.editor.getShapePageTransform(e.id),i=r.applyToPoint(n),o=s.route.midpointHandle?.axis;if(!o)return;const a=Ec[o],c=s.elbow[a.midRange];if(!c)return;let l=b.Angle(r.applyToPoint(a.v(0,0)),r.applyToPoint(a.v(0,1)));l<0&&(l+=Math.PI);const u=rc(i,l),d=rc(r.applyToPoint(a.v(c.lo,0)),l),p=rc(r.applyToPoint(a.v(c.hi,0)),l),f=this.options.elbowMidpointSnapDistance/this.editor.getEfficientZoomLevel(),g=rc(r.applyToPoint(a.v(ke(c.lo,c.hi,.5),0)),l);let x=g,y=Math.abs(g-u);for(const[S,w]of IU(this.editor)){const{isParallel:P,isFlippedParallel:_}=EU(l,S);if(P||_)for(const I of w){const C=I.startBoundShapeId&&(I.startBoundShapeId===s.bindings.start?.toId||I.startBoundShapeId===s.bindings.end?.toId),E=I.endBoundShapeId&&(I.endBoundShapeId===s.bindings.start?.toId||I.endBoundShapeId===s.bindings.end?.toId);if(!C&&!E)continue;const O=_?-I.perpDistance:I.perpDistance,k=Math.abs(O-u);k<y&&(x=O,y=k)}}y>f&&(x=u);const m=Ce(xc(d,p,x),0,1);return{id:e.id,type:e.type,props:{elbowMidPoint:m}}}onTerminalHandleDrag(e,{handle:n,isPrecise:s},r){const i=Vt(this.editor,e),o={id:e.id,type:"arrow",props:{}},a=i[r],l=i[r==="start"?"end":"start"],u=$u({editor:this.editor,pointInPageSpace:this.editor.getShapePageTransform(e.id).applyToPoint(n),arrow:e,isPrecise:s,currentBinding:a,oppositeBinding:l});if(!u){ec(this.editor,e,r);const f=vs(new b(n.x,n.y),this.editor);return o.props[r]={x:f.x,y:f.y},o}const d={terminal:r,normalizedAnchor:u.normalizedAnchor,isPrecise:u.isPrecise,isExact:u.isExact,snap:u.snap};Fa(this.editor,e,u.target.id,d);const p=Vt(this.editor,e);return p.start&&p.end&&p.start.toId===p.end.toId&&b.Equals(p.start.props.normalizedAnchor,p.end.props.normalizedAnchor)&&Fa(this.editor,e,p.end.toId,{...p.end.props,normalizedAnchor:{x:p.end.props.normalizedAnchor.x+.05,y:p.end.props.normalizedAnchor.y}}),o}onTranslateStart(e){const n=Vt(this.editor,e);if(e.props.kind==="elbow"&&this.editor.getOnlySelectedShapeId()===e.id){const o=Os(this.editor,e);if(!o)return;const a={id:e.id,type:"arrow",props:{}};return n.start&&(a.props.start={x:o.start.point.x,y:o.start.point.y},ec(this.editor,e,"start")),n.end&&(a.props.end={x:o.end.point.x,y:o.end.point.y},ec(this.editor,e,"end")),a}const s=Uo(this.editor,e,n),r=this.editor.getShapePageTransform(e.id),i=this.editor.getSelectedShapeIds();if(!(n.start&&(i.includes(n.start.toId)||this.editor.isAncestorSelected(n.start.toId))||n.end&&(i.includes(n.end.toId)||this.editor.isAncestorSelected(n.end.toId)))){Nv.set(e,{pagePosition:r.applyToPoint(e),terminalBindings:Oi(s,(o,a)=>{const c=n[o];return c?{binding:c,shapePosition:a,pagePosition:r.applyToPoint(a)}:null})}),n.start&&(Ud({editor:this.editor,arrow:e,terminal:"start",useHandle:!0}),e=this.editor.getShape(e.id)),n.end&&Ud({editor:this.editor,arrow:e,terminal:"end",useHandle:!0});for(const o of["start","end"]){const a=n[o];a&&this.editor.updateBinding({...a,props:{...a.props,isPrecise:!0}})}}}onTranslate(e,n){const s=Nv.get(e);if(!s)return;const r=this.editor.getShapePageTransform(n.id),i=b.Sub(r.applyToPoint(n),s.pagePosition);for(const o of Object.values(s.terminalBindings)){if(!o)continue;const a=b.Add(o.pagePosition,b.Mul(i,.5)),c=this.editor.getShapeAtPoint(a,{hitInside:!0,hitFrameInside:!0,margin:0,filter:l=>!l.isLocked&&this.editor.canBindShapes({fromShape:n,toShape:l,binding:"arrow"})});if(c?.id===o.binding.toId){const l=X.ZeroFix(this.editor.getShapeGeometry(c).bounds),u=this.editor.getPointInShapeSpace(c,a),d={x:(u.x-l.minX)/l.width,y:(u.y-l.minY)/l.height};Fa(this.editor,n,c.id,{...o.binding.props,normalizedAnchor:d,isPrecise:!0})}else ec(this.editor,n,o.binding.props.terminal)}}_resizeInitialBindings=new dn;onResize(e,n){const{scaleX:s,scaleY:r}=n,i=this._resizeInitialBindings.get(e,()=>Vt(this.editor,e)),o=Uo(this.editor,e,i),{start:a,end:c}=wt(e.props);let{bend:l}=e.props;i.start||(a.x=o.start.x*s,a.y=o.start.y*r),i.end||(c.x=o.end.x*s,c.y=o.end.y*r);const u=Math.abs(s),d=Math.abs(r),p=i?.start?b.From(i.start.props.normalizedAnchor):null,f=i?.end?b.From(i.end.props.normalizedAnchor):null;return s<0&&r>=0?(l!==0&&(l*=-1,l*=Math.max(u,d)),p&&(p.x=1-p.x),f&&(f.x=1-f.x)):s>=0&&r<0?(l!==0&&(l*=-1,l*=Math.max(u,d)),p&&(p.y=1-p.y),f&&(f.y=1-f.y)):s>=0&&r>=0?l!==0&&(l*=Math.max(u,d)):s<0&&r<0&&(l!==0&&(l*=Math.max(u,d)),p&&(p.x=1-p.x,p.y=1-p.y),f&&(f.x=1-f.x,f.y=1-f.y)),i.start&&p&&Fa(this.editor,e,i.start.toId,{...i.start.props,normalizedAnchor:p.toJson()}),i.end&&f&&Fa(this.editor,e,i.end.toId,{...i.end.props,normalizedAnchor:f.toJson()}),{props:{start:a,end:c,bend:l}}}onDoubleClickHandle(e,n){switch(n.id){case"start":return{id:e.id,type:e.type,props:{...e.props,arrowheadStart:e.props.arrowheadStart==="none"?"arrow":"none"}};case"end":return{id:e.id,type:e.type,props:{...e.props,arrowheadEnd:e.props.arrowheadEnd==="none"?"arrow":"none"}}}}component(e){const n=Us(),s=this.editor.getOnlySelectedShape(),r=this.editor.isInAny("select.idle","select.pointing_handle","select.dragging_handle","select.translating","arrow.dragging")&&!this.editor.getIsReadonly();if(!Os(this.editor,e)?.isValid)return null;const o=dd(this.editor,e),a=e.id===this.editor.getOnlySelectedShapeId(),l=this.editor.getEditingShapeId()===e.id||!kt(e.props.richText);return h.jsxs(h.Fragment,{children:[h.jsxs(ki,{style:{minWidth:50,minHeight:50},children:[h.jsx($v,{shape:e,shouldDisplayHandles:r&&s?.id===e.id}),e.props.kind==="elbow"&&mt.debugElbowArrows.get()&&h.jsx(wU,{arrow:e})]}),l&&h.jsx(Uu,{shapeId:e.id,type:"arrow",font:e.props.font,fontSize:Xg(e),lineHeight:$n.lineHeight,align:"middle",verticalAlign:"middle",labelColor:Ue(n,e.props.labelColor,"solid"),richText:e.props.richText,textWidth:o.box.w-Vg*2*e.props.scale,isSelected:a,padding:0,showTextOutline:this.options.showTextOutline,style:{transform:`translate(${o.box.center.x}px, ${o.box.center.y}px)`}})]})}indicator(e){const n=nl(e.id),s=tr(e.id+"_clip"),r=Os(this.editor,e);if(!r)return null;const{start:i,end:o}=Uo(this.editor,e,r?.bindings),a=this.editor.getShapeGeometry(e),c=a.bounds,l=kt(e.props.richText),u=n||!l?a.children[1]:null;if(b.Equals(i,o))return null;const d=Ht[e.props.size]*e.props.scale,p=r.start.arrowhead&&Hd(r,"start",d),f=r.end.arrowhead&&Hd(r,"end",d),g=p&&r.start.arrowhead!=="arrow"||f&&r.end.arrowhead!=="arrow"||!!u,x=u?u.getBounds():new X(0,0,0,0);if(n&&u)return h.jsx("rect",{x:F(x.x),y:F(x.y),width:x.w,height:x.h,rx:3.5*e.props.scale,ry:3.5*e.props.scale});const y=!(r.start.arrowhead==="none"||r.start.arrowhead==="arrow"),m=!(r.end.arrowhead==="none"||r.end.arrowhead==="arrow");return h.jsxs("g",{children:[g&&h.jsx("defs",{children:h.jsx(L2,{radius:3.5*e.props.scale,hasText:!l,bounds:c,labelBounds:x,as:y&&p?p:"",ae:m&&f?f:""})}),h.jsxs("g",{style:{clipPath:g?`url(#${s})`:void 0,WebkitClipPath:g?`url(#${s})`:void 0},children:[g&&h.jsx("rect",{x:c.minX-100,y:c.minY-100,width:c.width+200,height:c.height+200,opacity:0}),A2(e,r,e.props.dash==="draw"?{style:"draw",randomSeed:e.id,strokeWidth:1,passes:1,offset:0,roundness:d*2,props:{strokeWidth:void 0}}:{style:"solid",strokeWidth:1,props:{strokeWidth:void 0}})]}),p&&h.jsx("path",{d:p}),f&&h.jsx("path",{d:f}),u&&h.jsx("rect",{x:F(x.x),y:F(x.y),width:x.w,height:x.h,rx:3.5,ry:3.5})]})}onEditStart(e){if(kt(e.props.richText)){const n=D2(this.editor,e);this.editor.updateShape({id:e.id,type:e.type,props:{labelPosition:n}})}}toSvg(e,n){n.addExportDef(Vy(e.props.fill));const s=Fi(n),r=1/e.props.scale;return h.jsxs("g",{transform:`scale(${r})`,children:[h.jsx($v,{shape:e,shouldDisplayHandles:!1}),h.jsx(Hu,{fontSize:Xg(e),font:e.props.font,align:"middle",verticalAlign:"middle",labelColor:Ue(s,e.props.labelColor,"solid"),richText:e.props.richText,bounds:dd(this.editor,e).box.clone().expandBy(-Vg*e.props.scale),padding:0,showTextOutline:this.options.showTextOutline})]})}getCanvasSvgDefs(){return[Xy(),{key:"arrow:dot",component:CU},{key:"arrow:cross",component:TU}]}getInterpolatedProps(e,n,s){return{...s>.5?n.props:e.props,scale:ke(e.props.scale,n.props.scale,s),start:{x:ke(e.props.start.x,n.props.start.x,s),y:ke(e.props.start.y,n.props.start.y,s)},end:{x:ke(e.props.end.x,n.props.end.x,s),y:ke(e.props.end.y,n.props.end.y,s)},bend:ke(e.props.bend,n.props.bend,s),labelPosition:ke(e.props.labelPosition,n.props.labelPosition,s)}}}const $v=Ot(function({shape:e,shouldDisplayHandles:n}){const s=z(),r=Us(),i=Os(s,e),o=Rc(e.props.scale*.25),a=tr(e.id+"_clip"),c=tr("arrowhead-dot"),l=tr("arrowhead-cross"),u=nl(e.id),d=s.getShapeGeometry(e);if(!d)return null;const p=X.ZeroFix(d.bounds),f=Vt(s,e),g=kt(e.props.richText);if(!i?.isValid)return null;const x=Ht[e.props.size]*e.props.scale,y=i.start.arrowhead&&Hd(i,"start",x),m=i.end.arrowhead&&Hd(i,"end",x);let S=null;n&&(f.start||f.end)&&(S=lU(i,{style:"dashed",start:"skip",end:"skip",lengthRatio:2.5,strokeWidth:2/s.getEfficientZoomLevel(),props:{className:"tl-arrow-hint",markerStart:f.start?f.start.props.isExact?"":f.start.props.isPrecise?`url(#${l})`:`url(#${c})`:"",markerEnd:f.end?f.end.props.isExact?"":f.end.props.isPrecise?`url(#${l})`:`url(#${c})`:"",opacity:.16}}));const w=dd(s,e),P=!(i.start.arrowhead==="none"||i.start.arrowhead==="arrow"),_=!(i.end.arrowhead==="none"||i.end.arrowhead==="arrow");return h.jsxs(h.Fragment,{children:[h.jsx("defs",{children:h.jsx("clipPath",{id:a,children:h.jsx(L2,{radius:3.5*e.props.scale,hasText:u||!g,bounds:p,labelBounds:w.box,as:P&&y?y:"",ae:_&&m?m:""})})}),h.jsxs("g",{fill:"none",stroke:Ue(r,e.props.color,"solid"),strokeWidth:x,strokeLinejoin:"round",strokeLinecap:"round",pointerEvents:"none",children:[S,h.jsxs("g",{style:{clipPath:`url(#${a})`,WebkitClipPath:`url(#${a})`},children:[h.jsx("rect",{x:F(p.minX-100),y:F(p.minY-100),width:F(p.width+200),height:F(p.height+200),opacity:0}),A2(e,i,{style:e.props.dash,strokeWidth:x,forceSolid:o,randomSeed:e.id})]}),y&&P&&e.props.fill!=="none"&&h.jsx(Lc,{theme:r,d:y,color:e.props.color,fill:e.props.fill,scale:e.props.scale}),m&&_&&e.props.fill!=="none"&&h.jsx(Lc,{theme:r,d:m,color:e.props.color,fill:e.props.fill,scale:e.props.scale}),y&&h.jsx("path",{d:y}),m&&h.jsx("path",{d:m})]})]})});function L2({radius:t,hasText:e,bounds:n,labelBounds:s,as:r,ae:i}){const o=v.useMemo(()=>{const a=new We;return a.moveTo(n.left-100,n.top-100).lineTo(n.right+100,n.top-100).lineTo(n.right+100,n.bottom+100).lineTo(n.left-100,n.bottom+100).close(),e&&a.moveTo(s.left,s.top+t).lineTo(s.left,s.bottom-t).circularArcTo(t,!1,!1,s.left+t,s.bottom).lineTo(s.right-t,s.bottom).circularArcTo(t,!1,!1,s.right,s.bottom-t).lineTo(s.right,s.top+t).circularArcTo(t,!1,!1,s.right-t,s.top).lineTo(s.left+t,s.top).circularArcTo(t,!1,!1,s.left,s.top+t).close(),a.toD()},[t,e,n.bottom,n.left,n.right,n.top,s.bottom,s.left,s.right,s.top]);return h.jsx("path",{d:`${o}${r}${i}`})}const Nv=new WeakMap;function CU(){const t=tr("arrowhead-dot");return h.jsx("marker",{id:t,className:"tl-arrow-hint",refX:"3.0",refY:"3.0",orient:"0",children:h.jsx("circle",{cx:"3",cy:"3",r:"2",strokeDasharray:"100%"})})}function TU(){const t=tr("arrowhead-cross");return h.jsxs("marker",{id:t,className:"tl-arrow-hint",refX:"3.0",refY:"3.0",orient:"auto",children:[h.jsx("line",{x1:"1.5",y1:"1.5",x2:"4.5",y2:"4.5",strokeDasharray:"100%"}),h.jsx("line",{x1:"1.5",y1:"4.5",x2:"4.5",y2:"1.5",strokeDasharray:"100%"})]})}function EU(t,e,n=1e-4){const s=Math.abs(t-e),r=s<n,i=Math.abs(s-Math.PI)<n,o=Math.abs(s-at)<n;return{isParallel:r||o,isFlippedParallel:i}}const Uv="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' fill='none'%3E%3Cpath stroke='%23000' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13 5H7a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6M19 5h6m0 0v6m0-6L13 17'/%3E%3C/svg%3E";function ca({url:t}){const e=z(),n=Rc(),s=v.useCallback(r=>{e.inputs.getShiftKey()||e.markEventAsHandled(r)},[e]);return h.jsx("a",{className:de("tl-hyperlink-button",{"tl-hyperlink-button__hidden":n}),href:t,target:"_blank",rel:"noopener noreferrer",onPointerDown:s,onPointerUp:s,title:t,draggable:!1,children:h.jsx("div",{className:"tl-hyperlink__icon",style:{mask:`url("${Uv}") center 100% / 100% no-repeat`,WebkitMask:`url("${Uv}") center 100% / 100% no-repeat`}})})}const Hv="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' fill='none'%3E%3Cpath stroke='%23000' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13 5H7a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6M19 5h6m0 0v6m0-6L13 17'/%3E%3C/svg%3E",kU=[{offsetX:0,offsetY:2,blur:4,spread:0,color:"#00000029"},{offsetX:0,offsetY:3,blur:6,spread:0,color:"#0000001f"}];function Kd(t){return kU.map(n=>{const{offsetX:s,offsetY:r,blur:i,spread:o,color:a}=n,c=new b(s,r),{x:l,y:u}=c.rot(-t);return`${l}px ${u}px ${i}px ${o}px ${a}`}).join(", ")}class AU extends xa{static type="bookmark";static props=G1;static migrations=Y1;canResize(){return!1}hideSelectionBoundsFg(){return!0}getText(e){return e.props.url}getAriaDescriptor(e){const n=e.props.assetId?this.editor.getAsset(e.props.assetId):null;if(n?.props.title)return g2(n.props.title)+(n.props.description?", "+n.props.description:"")}getDefaultProps(){return{url:"",w:Cc,h:Cy,assetId:null}}component(e){const{assetId:n,url:s,h:r}=e.props,i=this.editor.getShapePageTransform(e).rotation();return h.jsx(F2,{assetId:n,url:s,h:r,rotation:i})}indicator(e){return h.jsx(R2,{w:e.props.w,h:e.props.h})}onBeforeCreate(e){return Qw(this.editor,e)}onBeforeUpdate(e,n){if(e.props.url!==n.props.url)if(ws.isValid(n.props.url))H4(this.editor,n);else return{...n,props:{...n.props,url:e.props.url}};if(e.props.assetId!==n.props.assetId)return Qw(this.editor,n)}getInterpolatedProps(e,n,s){return{...s>.5?n.props:e.props,w:ke(e.props.w,n.props.w,s),h:ke(e.props.h,n.props.h,s)}}}function R2({w:t,h:e}){return h.jsx("rect",{width:F(t),height:F(e),rx:"6",ry:"6"})}function F2({assetId:t,rotation:e,url:n,h:s,showImageContainer:r=!0}){const i=z(),o=t?i.getAsset(t):null,a=!!Jc()&&qe.isSafari,c=U4(n),[l,u]=v.useState(!0),d=()=>u(!1),p=v.useCallback(f=>{i.inputs.getShiftKey()||i.markEventAsHandled(f)},[i]);return h.jsx(Ci,{children:h.jsxs("div",{className:de("tl-bookmark__container",a&&"tl-bookmark__container--safariExport"),style:{boxShadow:a?void 0:Kd(e),maxHeight:s},children:[r&&(!o||o.props.image)&&h.jsxs("div",{className:"tl-bookmark__image_container",children:[o?h.jsx("img",{className:"tl-bookmark__image",draggable:!1,referrerPolicy:"strict-origin-when-cross-origin",src:o?.props.image,alt:o?.props.title||""}):h.jsx("div",{className:"tl-bookmark__placeholder"}),o?.props.image&&h.jsx(ca,{url:n})]}),h.jsxs("div",{className:"tl-bookmark__copy_container",children:[o?.props.title?h.jsx("a",{className:"tl-bookmark__link",href:n||"",target:"_blank",rel:"noopener noreferrer",draggable:!1,onPointerDown:p,onPointerUp:p,children:h.jsx("h2",{className:"tl-bookmark__heading",children:g2(o.props.title)})}):null,o?.props.description&&o?.props.image?h.jsx("p",{className:"tl-bookmark__description",children:o.props.description}):null,h.jsxs("a",{className:"tl-bookmark__link",href:n||"",target:"_blank",rel:"noopener noreferrer",draggable:!1,onPointerDown:p,onPointerUp:p,children:[l&&o?.props.favicon?h.jsx("img",{className:"tl-bookmark__favicon",src:o?.props.favicon,referrerPolicy:"strict-origin-when-cross-origin",onError:d,alt:`favicon of ${c}`}):h.jsx("div",{className:"tl-hyperlink__icon",style:{mask:`url("${Hv}") center 100% / 100% no-repeat`,WebkitMask:`url("${Hv}") center 100% / 100% no-repeat`}}),h.jsx("span",{children:c})]})]})]})})}function Fc(t,e=!1){const n=t.length;if(n<2)return"";let s=t[0].point,r=t[1].point;if(n===2)return`M${rn(s)}L${rn(r)}`;let i="";for(let o=2,a=n-1;o<a;o++)s=t[o].point,r=t[o+1].point,i+=ns(s,r);return e?`M${ns(t[0].point,t[1].point)}Q${rn(t[1].point)}${ns(t[1].point,t[2].point)}T${i}${ns(t[n-1].point,t[0].point)}${ns(t[0].point,t[1].point)}Z`:`M${rn(t[0].point)}Q${rn(t[1].point)}${ns(t[1].point,t[2].point)}${t.length>3?"T":""}${i}L${rn(t[n-1].point)}`}function MU(t,e={}){const{start:n={},end:s={}}=e,{cap:r=!0}=n,{cap:i=!0}=s;le(!n.taper&&!s.taper,"cap taper not supported here"),le(!n.easing&&!s.easing,"cap easing not supported here"),le(r&&i,"cap must be true");const o=Ai(t,e);Wy(o,e);const a=jU(o);let c="";for(const l of a)c+=OU(l,e);return c}function jU(t){if(t.length<=2)return[t];const e=[];let n=[t[0]],s=b.Sub(t[1].point,t[0].point).uni(),r,i,o,a,c;for(let l=1,u=t.length;l<u-1;l++){if(o=t[l-1],a=t[l],c=t[l+1],r=b.Sub(c.point,a.point).uni(),i=b.Dpr(s,r),s=r,i<-.8){const d={...a,point:a.input};n.push(d),e.push(lg(n)),n=[d];continue}if(n.push(a),!(i>.7)&&(b.Dist2(o.point,a.point)+b.Dist2(a.point,c.point))/((o.radius+a.radius+c.radius)/3)**2<1.5){n.push(a),e.push(lg(n)),n=[a];continue}}return n.push(t[t.length-1]),e.push(lg(n)),e}function lg(t){const e=t[0];let n;for(;t.length>2&&(n=t[1],b.Dist2(e.point,n.point)<((e.radius+n.radius)/2*.5)**2);)t.splice(1,1);const s=t[t.length-1];let r;for(;t.length>2&&(r=t[t.length-2],b.Dist2(s.point,r.point)<((s.radius+r.radius)/2*.5)**2);)t.splice(t.length-2,1);return t.length>1&&(t[0]={...t[0],vector:b.Sub(t[0].point,t[1].point).uni()},t[t.length-1]={...t[t.length-1],vector:b.Sub(t[t.length-2].point,t[t.length-1].point).uni()}),t}function DU(t,e,n){return"M "+t+" "+e+" m -"+n+", 0 a "+n+","+n+" 0 1,1 "+n*2+",0 a "+n+","+n+" 0 1,1 -"+n*2+",0"}function OU(t,e={}){if(t.length===0)return"";if(t.length===1)return DU(t[0].point.x,t[0].point.y,t[0].radius);const{left:n,right:s}=c2(t,e);s.reverse();let r=`M${rn(n[0])}T`;for(let i=1;i<n.length;i++)r+=ns(n[i-1],n[i]);{const i=t[t.length-1],o=i.radius,a=i.vector.clone().per().neg(),c=b.Add(i.point,b.Mul(a,o)),l=b.Add(i.point,b.Mul(a,-o));r+=`${rn(c)}A${F(o)},${F(o)} 0 0 1 ${rn(l)}T`}for(let i=1;i<s.length;i++)r+=ns(s[i-1],s[i]);{const i=t[0],o=i.radius,a=i.vector.clone().per(),c=b.Add(i.point,b.Mul(a,o)),l=b.Add(i.point,b.Mul(a,-o));r+=`${rn(c)}A${F(o)},${F(o)} 0 0 1 ${rn(l)}Z`}return r}const B2=(t,e,n)=>{const s=[],r=[];t.forEach(l=>s.push(...He.decodePoints(l.path))),e.forEach(l=>r.push(...He.decodePoints(l.path)));const i=Math.max(s.length,r.length),o=[],a=[];for(let l=0;l<i;l++)o.push(s[l]||s[s.length-1]),a.push(r[l]||r[r.length-1]);const c=o.map((l,u)=>{let d=.5;return a[u].z!==void 0&&l.z!==void 0&&(d=ke(l.z,a[u].z,n)),{x:ke(l.x,a[u].x,n),y:ke(l.y,a[u].y,n),z:d}});return[{type:"free",path:He.encodePoints(c)}]};class LU extends zi{static type="draw";static props=J1;static migrations=Q1;options={maxPointsPerShape:600};hideResizeHandles(e){return dg(e)}hideRotateHandle(e){return dg(e)}hideSelectionBoundsFg(e){return dg(e)}getDefaultProps(){return{segments:[],color:"black",fill:"none",dash:"draw",size:"m",isComplete:!1,isClosed:!1,isPen:!1,scale:1,scaleX:1,scaleY:1}}getGeometry(e){const n=ia(e.props.segments,e.props.scaleX,e.props.scaleY),s=(Ht[e.props.size]+1)*e.props.scale;if(e.props.segments.length===1){const i=X.FromPoints(n);if(i.width<s*2&&i.height<s*2)return new Rd({x:-s,y:-s,radius:s,isFilled:!0})}const r=Ai(n,Fg(e.props,s,e.props.isPen,!0)).map(i=>i.point);return e.props.isClosed&&r.length>2?new Ic({points:r,isFilled:e.props.fill!=="none"}):r.length===1?new Rd({x:-s,y:-s,radius:s,isFilled:!0}):new Zc({points:r})}component(e){return h.jsx(ki,{children:h.jsx(Kv,{shape:e})})}indicator(e){const n=ia(e.props.segments,e.props.scaleX,e.props.scaleY);let s=(Ht[e.props.size]+1)*e.props.scale;!$("force solid",()=>{const l=this.editor.getEfficientZoomLevel();return l<.5&&l<1.5/s},[this.editor,s])&&!e.props.isPen&&e.props.dash==="draw"&&n.length===1&&(s+=uo(e.id)()*(s/6));const i=e.props.isComplete||Fs(e.props.segments)?.type==="straight",o=Fg(e.props,s,i,!0),a=Ai(n,o),c=a.length>1?Fc(a,e.props.isClosed):z2(n[0],s);return h.jsx("path",{d:c})}toSvg(e,n){n.addExportDef(Vy(e.props.fill));const s=1/e.props.scale;return h.jsx("g",{transform:`scale(${s})`,children:h.jsx(Kv,{shape:e,zoomOverride:1})})}getCanvasSvgDefs(){return[Xy()]}onResize(e,n){const{scaleX:s,scaleY:r}=n;return{props:{scaleX:s*e.props.scaleX,scaleY:r*e.props.scaleY}}}expandSelectionOutlinePx(e){const n=e.props.dash==="draw"?1.6:1;return Ht[e.props.size]*n/2*e.props.scale}getInterpolatedProps(e,n,s){return{...s>.5?n.props:e.props,segments:B2(e.props.segments,n.props.segments,s),scale:ke(e.props.scale,n.props.scale,s)}}}function z2(t,e){const n=(e+1)*.5;return`M ${t.x} ${t.y} m -${n}, 0 a ${n},${n} 0 1,0 ${n*2},0 a ${n},${n} 0 1,0 -${n*2},0`}function dg(t){return t.props.segments.length===1&&t.props.segments[0].path.length<24}function Kv({shape:t,zoomOverride:e}){const n=Us(),s=z(),r=ia(t.props.segments,t.props.scaleX,t.props.scaleY),i=t.props.isComplete||Fs(t.props.segments)?.type==="straight";let o=(Ht[t.props.size]+1)*t.props.scale;const a=$("force solid",()=>{const f=e??s.getEfficientZoomLevel();return f<.5&&f<1.5/o},[s,o,e]),c=$("dot adjustment",()=>(e??s.getEfficientZoomLevel())<.2?9:.1,[s,e]);!a&&!t.props.isPen&&t.props.dash==="draw"&&r.length===1&&(o+=uo(t.id)()*(o/6));const l=Fg(t.props,o,i,a);if(!a&&t.props.dash==="draw")return h.jsxs(h.Fragment,{children:[t.props.isClosed&&t.props.fill&&r.length>1?h.jsx(Lc,{d:Fc(Ai(r,l),t.props.isClosed),theme:n,color:t.props.color,fill:t.props.isClosed?t.props.fill:"none",scale:t.props.scale}):null,h.jsx("path",{d:MU(r,l),strokeLinecap:"round",fill:Ue(n,t.props.color,"solid")})]});const u=Ai(r,l),d=u.length<2,p=d?z2(r[0],0):Fc(u,t.props.isClosed);return h.jsxs(h.Fragment,{children:[h.jsx(Lc,{d:p,theme:n,color:t.props.color,fill:d||t.props.isClosed?t.props.fill:"none",scale:t.props.scale}),h.jsx("path",{d:p,strokeLinecap:"round",fill:d?Ue(n,t.props.color,"solid"):"none",stroke:Ue(n,t.props.color,"solid"),strokeWidth:o,strokeDasharray:d?"none":M4(t,o,c),strokeDashoffset:"0"})]})}function RU(t){if(typeof t!="string")throw new TypeError("Expected a string");return t.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&").replace(/-/g,"\\x2d")}function FU(t,e){const n=Ee(e);if(!n)return;const s=n.host.replace("www.","");for(const r of t)if($2(r.hostnames,s)){const i=r.fromEmbedUrl(e);if(i)return{definition:r,url:i,embedUrl:e}}}const BU=t=>t.split("*").map(e=>RU(e)).join(".+"),$2=(t,e)=>!!t.find(n=>{const s=new RegExp(BU(n));return e.match(s)});function zU(t,e){const n=Ee(e);if(!n)return;const s=n.host.replace("www.","");for(const r of t)if($2(r.hostnames,s)){const i=r.toEmbedUrl(e);if(i)return{definition:r,embedUrl:i,url:e}}}function $U(t,e){try{return zU(t,e)??FU(t,e)}catch{return}}const NU=t=>Object.entries(t).filter(([e,n])=>n).map(([e])=>e).join(" ");class Jo extends xa{static type="embed";static props=eP;static migrations=tP;static embedDefinitions=Ey;canEditWhileLocked(e){const n=this.getEmbedDefinition(e.props.url);return n?n.definition.canEditWhileLocked??!0:!0}static setEmbedDefinitions(e){Jo.embedDefinitions=e}getEmbedDefinitions(){return Jo.embedDefinitions}getEmbedDefinition(e){return $U(Jo.embedDefinitions,e)}getText(e){return e.props.url}getAriaDescriptor(e){return this.getEmbedDefinition(e.props.url)?.definition.title}hideSelectionBoundsFg(e){return!this.canResize(e)}canEdit(){return!0}canResize(e){return!!this.getEmbedDefinition(e.props.url)?.definition?.doesResize}canEditInReadonly(){return!0}getDefaultProps(){return{w:300,h:300,url:""}}getGeometry(e){return this.getEmbedDefinition(e.props.url)?.definition?super.getGeometry(e):new rr({width:Cc,height:Ng,isFilled:!0})}isAspectRatioLocked(e){return this.getEmbedDefinition(e.props.url)?.definition.isAspectRatioLocked??!1}onResize(e,n){const s=this.isAspectRatioLocked(e),r=this.getEmbedDefinition(e.props.url);let i=r?.definition.minWidth??200,o=r?.definition.minHeight??200;if(s){const a=e.props.w/e.props.h;a>1?i*=a:o/=a}return Iu(e,n,{minWidth:i,minHeight:o})}component(e){const n=Jc(),{w:s,h:r,url:i}=e.props,o=nl(e.id),a=this.getEmbedDefinition(i),c=$("is hovering",()=>{const{editingShapeId:f,hoveredShapeId:g}=this.editor.getCurrentPageState();if(f&&g!==f){const x=this.editor.getShape(f);if(x&&this.editor.isShapeOfType(x,"embed"))return!0}return!1},[]),l=this.editor.getShapePageTransform(e).rotation();if(n)return h.jsx(Ci,{className:"tl-embed-container",id:e.id,children:h.jsx("div",{className:"tl-embed",style:{border:0,boxShadow:Kd(l),borderRadius:a?.definition.overrideOutlineRadius??8,background:a?.definition.backgroundColor??"var(--tl-color-background)",width:s,height:r}})});const u=o||c;if(typeof window<"u"&&(window!==window.top||window.self!==window.parent)&&a?.definition.type==="tldraw")return null;if(a?.definition.type==="github_gist"){const f=a.url.split("/").pop();if(!f)throw Error("No gist id!");return h.jsx(Ci,{className:"tl-embed-container",id:e.id,children:h.jsx(UU,{id:f,width:F(s),height:F(r),isInteractive:u,pageRotation:l})})}const p=NU({...X4,...a?.definition.overridePermissions??{}});return h.jsx(Ci,{className:"tl-embed-container",id:e.id,children:a?.definition?h.jsx("iframe",{className:"tl-embed",sandbox:p,src:a.embedUrl,width:F(s),height:F(r),draggable:!1,frameBorder:"0",referrerPolicy:"no-referrer-when-downgrade",tabIndex:o?0:-1,allowFullScreen:!0,style:{border:0,pointerEvents:u?"auto":"none",zIndex:u?"":"-1",boxShadow:Kd(l),borderRadius:a?.definition.overrideOutlineRadius??8,background:a?.definition.backgroundColor}}):h.jsx(F2,{url:i,h:r,rotation:l,assetId:null,showImageContainer:!1})})}indicator(e){const n=this.getEmbedDefinition(e.props.url);return n?.definition?h.jsx("rect",{width:F(e.props.w),height:F(e.props.h),rx:n?.definition.overrideOutlineRadius??8,ry:n?.definition.overrideOutlineRadius??8}):h.jsx(R2,{w:Cc,h:Ng})}getInterpolatedProps(e,n,s){return{...s>.5?n.props:e.props,w:ke(e.props.w,n.props.w,s),h:ke(e.props.h,n.props.h,s)}}}function UU({id:t,isInteractive:e,width:n,height:s,style:r,pageRotation:i}){if(!t.match(/^[0-9a-f]+$/))throw Error("No gist id!");return h.jsx("iframe",{className:"tl-embed",draggable:!1,width:F(n),height:F(s),frameBorder:"0",scrolling:"no",referrerPolicy:"no-referrer-when-downgrade",tabIndex:e?0:-1,style:{...r,pointerEvents:e?"all":"none",zIndex:e?"":"-1",boxShadow:Kd(i)},srcDoc:`
			<html>
				<head>
					<base target="_blank">
				</head>
				<body>
					<script src=${`https://gist.github.com/${t}.js`}><\/script>
					<style type="text/css">
						* { margin: 0px; }
						table { height: 100%; background-color: red; }
						.gist { background-color: none; height: 100%;  }
						.gist .gist-file { height: calc(100vh - 2px); padding: 0px; display: grid; grid-template-rows: 1fr auto; }
					</style>
				</body>
			</html>`})}function HU(t){return t.replace(/\s/g," ")}function KU(t,e,n){const{padding:s=0}=n;if(e.length===0)return null;const r=X.From(e[0].box);for(const{box:l}of e)r.union(l);const i=s+(n.offsetX??0),o=(n.offsetY??0)+n.fontSize/2+(n.verticalTextAlign==="start"?s:n.verticalTextAlign==="end"?n.height-s-r.height:(Math.ceil(n.height)-r.height)/2);let a=null;const c=[];for(const{text:l,box:u}of e)a!==null&&u.y>a&&c.push(h.jsx("tspan",{alignmentBaseline:"mathematical",x:i,y:u.y+o,children:`
`},c.length)),c.push(h.jsx("tspan",{alignmentBaseline:"mathematical",x:u.x+i,y:u.y+o,unicodeBidi:"plaintext",children:HU(l)},c.length)),a=u.y;return h.jsx("text",{fontSize:n.fontSize,fontFamily:n.fontFamily,fontStyle:n.fontStyle,fontWeight:n.fontWeight,dominantBaseline:"mathematical",alignmentBaseline:"mathematical",stroke:n.stroke,strokeWidth:n.strokeWidth,fill:n.fill,children:c})}function Zg(t,e){const r=((kd(t.getShapePageTransform(e.id).rotation())+Math.PI/4)*(2/Math.PI)+4)%4;return Math.floor(r)}const Wv=new WeakMap;function qv(t,e,n){let s=Wv.get(e.props);if(!s){const r=Jy(e.props.name,"Frame")+"​",i=t.textMeasure.measureTextSpans(r,n),o=i[0],a=Fs(i);s=a.box.w+a.box.x-o.box.x,Wv.set(e.props,s)}return new X(0,-n.height,s,n.height)}function Gv(t,e){return{fontSize:12,fontFamily:e?"Arial":"Inter, sans-serif",textAlign:"start",width:t,height:24,padding:0,lineHeight:1,fontStyle:"normal",fontWeight:"normal",overflow:"truncate-ellipsis",verticalTextAlign:"middle",offsetY:-34,offsetX:0}}function N2(t,e,n){const s=n?"":"px",r=n?"":"deg";let i;switch(e){case 0:i="";break;case 3:i=`translate(${F(t.props.w)}${s}, 0${s}) rotate(90${r})`;break;case 2:i=`translate(${F(t.props.w)}${s}, ${F(t.props.h)}${s}) rotate(180${r})`;break;case 1:i=`translate(0${s}, ${F(t.props.h)}${s}) rotate(270${r})`;break;default:throw Error("labelSide out of bounds")}return i}const WU=v.forwardRef(({id:t,name:e,isEditing:n},s)=>{const r=z(),i=hn(),o=$("isCoarsePointer",()=>r.getInstanceState().isCoarsePointer,[r]),a=i<yt.TABLET_SM&&o,c=v.useRef(!1),l=ae(),u=v.useCallback(x=>{n&&r.markEventAsHandled(x)},[r,n]),d=v.useCallback(x=>{x.key==="Enter"&&!x.nativeEvent.isComposing&&(r.markEventAsHandled(x),x.currentTarget.blur(),r.setEditingShape(null))},[r]),p=v.useCallback(x=>{const y=r.getShape(t);!y||y.props.name===x||r.updateShapes([{id:t,type:"frame",props:{name:x}}])},[t,r]),f=v.useCallback(x=>{p(x.currentTarget.value)},[p]),g=v.useCallback(x=>{p(x.currentTarget.value)},[p]);return v.useEffect(()=>{if(!n){c.current=!1;return}if(n&&a&&!c.current){c.current=!0;const y=r.getShape(t)?.props.name??"",m=window.prompt(l("action.rename"),y);c.current=!1,m!==null&&p(m),r.setEditingShape(null)}},[n,a,t,l,p,r]),h.jsxs("div",{className:`tl-frame-label ${n&&!a?"tl-frame-label__editing":""}`,children:[h.jsx("input",{className:"tl-frame-name-input",ref:s,disabled:!n||a,readOnly:!n||a,style:{display:n?void 0:"none"},value:e,autoFocus:!a,onKeyDown:d,onBlur:f,onChange:g,onPointerDown:u,draggable:!1}),Jy(e,"Frame")+"​"]})}),qU=v.memo(function({id:e,name:n,width:s,height:r,fill:i,stroke:o,color:a,offsetX:c,showColors:l}){const u=z(),{side:d,translation:p}=$("shape rotation",()=>{const x=u.getShape(e);if(!x)return{side:0,translation:"translate(0, 0)"};const y=Zg(u,x);return{side:y,translation:N2(x,y,!1)}},[u,c,e]),f=v.useRef(null),g=nl(e);return v.useEffect(()=>{const x=f.current;x&&g&&(x.focus(),x.select())},[f,g]),h.jsx("div",{className:"tl-frame-heading",style:{overflow:g?"visible":"hidden",maxWidth:`calc(var(--tl-zoom) * ${Math.ceil(d===0||d===2?s:r)}px + ${l?"0px":"var(--tl-frame-offset-width)"})`,bottom:"100%",transform:`${p} scale(var(--tl-scale)) translateX(${c}px)`},children:h.jsx("div",{className:"tl-frame-heading-hit-area",style:{color:a,backgroundColor:i,boxShadow:`inset 0px 0px 0px 1px ${o}`},children:h.jsx(WU,{ref:f,id:e,name:n,isEditing:g})})})}),GU=12,YU=32,VU=-7,XU=4;function Jy(t,e){return t.match(/^\s*$/)?e:t}class ZU extends xa{static type="frame";static props=nP;static migrations=sP;options={showColors:!1,resizeChildren:!1};static configure(e){const n=super.configure.call(this,e);return e.showColors&&(n.props={...n.props,color:Un}),n}canEdit(e,n){return n.type==="click-header"||n.type==="unknown"}canResize(){return!0}canResizeChildren(){return this.options.resizeChildren}isExportBoundsContainer(){return!0}getDefaultProps(){return{w:320,h:180,name:"",color:"black"}}getAriaDescriptor(e){return e.props.name}getGeometry(e){const{editor:n}=this,s=n.getEfficientZoomLevel(),r=Zg(n,e),i=r%2===1,o=i?e.props.h:e.props.w,a=Gv(o,!1),c=qv(n,e,a),l=this.options.showColors,u=GU/s,d=YU/s,p=o+(l?1:u),f=c.w/s,g=c.h/s,x=Ce(f+u,d,p),y=(l?-1:VU)/s,m=XU/s,S=i?g:x,w=i?x:g;let P,_;switch(r){case 0:{P=y,_=-(g+m);break}case 1:{P=-(g+m),_=e.props.h-(y+x);break}case 2:{P=e.props.w-(y+x),_=e.props.h+m;break}case 3:{P=e.props.w+m,_=y;break}}return new os({children:[new rr({width:e.props.w,height:e.props.h,isFilled:!1}),new rr({x:P,y:_,width:S,height:w,isFilled:!0,isLabel:!0,excludeFromShapeBounds:!0})]})}getText(e){return e.props.name}component(e){const n=Us(),s=$("is creating this shape",()=>{const d=this.editor.getStateDescendant("select.resizing");if(!d||!d.getIsActive())return!1;const p=d?.info;return p?p.isCreating&&this.editor.getOnlySelectedShapeId()===e.id:!1},[e.id]),r=this.options.showColors,i=r?e.props.color:"black",o=Ue(n,i,"frameFill"),a=Ue(n,i,"frameStroke"),c=r?Ue(n,i,"frameHeadingStroke"):n.background,l=r?Ue(n,i,"frameHeadingFill"):n.background,u=Ue(n,i,"frameText");return h.jsxs(h.Fragment,{children:[h.jsx(ki,{children:h.jsx("rect",{className:de("tl-frame__body",{"tl-frame__creating":s}),fill:o,stroke:a,style:{width:`calc(${e.props.w}px + 1px / var(--tl-zoom))`,height:`calc(${e.props.h}px + 1px / var(--tl-zoom))`,transform:"translate(calc(-0.5px / var(--tl-zoom)), calc(-0.5px / var(--tl-zoom)))"}})}),s?null:h.jsx(qU,{id:e.id,name:e.props.name,fill:l,stroke:c,color:u,width:e.props.w,height:e.props.h,offsetX:r?-1:-7,showColors:this.options.showColors})]})}toSvg(e,n){const s=Fi({isDarkMode:n.isDarkMode}),r=Zg(this.editor,e),o=r%2===1?e.props.h:e.props.w,a=N2(e,r,!0),c=Gv(o-12,!0),l=Jy(e.props.name,"Frame")+"​",u=qv(this.editor,e,c),d=this.editor.textMeasure.measureTextSpans(l,c),p=KU(this.editor,d,c),f=this.options.showColors,g=f?e.props.color:"black",x=Ue(s,g,"frameFill"),y=Ue(s,g,"frameStroke"),m=f?Ue(s,g,"frameHeadingStroke"):s.background,S=f?Ue(s,g,"frameHeadingFill"):s.background,w=Ue(s,g,"frameText");return h.jsxs(h.Fragment,{children:[h.jsx("rect",{width:e.props.w,height:e.props.h,fill:x,stroke:y,strokeWidth:1,x:0,rx:0,ry:0}),h.jsxs("g",{fill:w,transform:a,children:[h.jsx("rect",{x:u.x-(f?0:6),y:u.y-6,width:Math.min(o,u.width+12),height:u.height,fill:S,stroke:m,rx:4,ry:4}),h.jsx("g",{transform:`translate(${f?8:0}, 4)`,children:p})]})]})}indicator(e){return h.jsx("rect",{width:F(e.props.w),height:F(e.props.h),className:"tl-frame-indicator"})}providesBackgroundForChildren(){return!0}getClipPath(e){return this.editor.getShapeGeometry(e.id).vertices}canReceiveNewChildrenOfType(e){return!e.isLocked}onResize(e,n){return Iu(e,n)}getInterpolatedProps(e,n,s){return{...s>.5?n.props:e.props,w:ke(e.props.w,n.props.w,s),h:ke(e.props.h,n.props.h,s)}}onDoubleClickEdge(e,n){if(n.target!=="selection")return;const{handle:s}=n;if(!s)return;const r=s==="left"||s==="right",i=s==="top"||s==="bottom",o=this.editor.getSortedChildIdsForParent(e.id),a=ve(o.map(p=>this.editor.getShape(p)));if(!a.length)return;const{dx:c,dy:l,w:u,h:d}=BT(a,this.editor,{padding:10});return this.editor.run(()=>{const p=o.map(f=>{const g=this.editor.getShape(f);return{id:g.id,type:g.type,x:r?g.x+c:g.x,y:i?g.y+l:g.y}});this.editor.updateShapes(p)}),{id:e.id,type:e.type,props:{w:r?u:e.props.w,h:i?d:e.props.h}}}onDoubleClickCorner(e){return zT(this.editor,e.id,{padding:10}),{id:e.id,type:e.type}}onDragShapesIn(e,n,{initialParentIds:s,initialIndices:r}){const{editor:i}=this;if(n.every(c=>c.parentId===e.id))return;let o=!1;const a=n.filter(c=>e.id===s.get(c.id));if(a.length>0){const c=ve(i.getSortedChildIdsForParent(e).map(l=>i.getShape(l)));a.every(l=>!c.find(u=>u.index===l.index))&&(o=!0)}if(!n.some(c=>i.hasAncestor(e,c.id))&&(i.reparentShapes(n,e.id),o))for(const c of a)i.updateShape({id:c.id,type:c.type,index:r.get(c.id)})}onDragShapesOut(e,n,s){const{editor:r}=this;s.nextDraggingOverShapeId||r.reparentShapes(n.filter(i=>i.parentId===e.id&&this.canReceiveNewChildrenOfType(i)),r.getCurrentPageId())}}const JU=new dn;function Jg(t){return JU.get(t,QU)}function QU(t){const e=Math.max(1,t.props.w),n=Math.max(1,t.props.h+t.props.growY),s=e/2,r=n/2,i=ys[t.props.size]*t.props.scale,o=t.props.fill!=="none";switch(t.props.geo){case"arrow-down":{const a=e*.16,c=Math.min(e,n)*.38;return new We().moveTo(a,0,{geometry:{isFilled:o}}).lineTo(e-a,0).lineTo(e-a,n-c).lineTo(e,n-c).lineTo(e/2,n).lineTo(0,n-c).lineTo(a,n-c).close()}case"arrow-left":{const a=Math.min(e,n)*.38,c=n*.16;return new We().moveTo(a,0,{geometry:{isFilled:o}}).lineTo(a,c).lineTo(e,c).lineTo(e,n-c).lineTo(a,n-c).lineTo(a,n).lineTo(0,n/2).close()}case"arrow-right":{const a=Math.min(e,n)*.38,c=n*.16;return new We().moveTo(0,c,{geometry:{isFilled:o}}).lineTo(e-a,c).lineTo(e-a,0).lineTo(e,n/2).lineTo(e-a,n).lineTo(e-a,n-c).lineTo(0,n-c).close()}case"arrow-up":{const a=e*.16,c=Math.min(e,n)*.38;return new We().moveTo(e/2,0,{geometry:{isFilled:o}}).lineTo(e,c).lineTo(e-a,c).lineTo(e-a,n).lineTo(a,n).lineTo(a,c).lineTo(0,c).close()}case"check-box":{const a=Math.min(e,n)*.82,c=(e-a)/2,l=(n-a)/2;return new We().moveTo(0,0,{geometry:{isFilled:o}}).lineTo(e,0).lineTo(e,n).lineTo(0,n).close().moveTo(Ce(c+a*.25,0,e),Ce(l+a*.52,0,n),{geometry:{isInternal:!0,isFilled:!1},offset:0}).lineTo(Ce(c+a*.45,0,e),Ce(l+a*.82,0,n)).lineTo(Ce(c+a*.82,0,e),Ce(l+a*.22,0,n),{offset:0})}case"diamond":return new We().moveTo(s,0,{geometry:{isFilled:o}}).lineTo(e,r).lineTo(s,n).lineTo(0,r).close();case"ellipse":return new We().moveTo(0,r,{geometry:{isFilled:o}}).arcTo(s,r,!1,!0,0,e,r).arcTo(s,r,!1,!0,0,0,r).close();case"heart":{const a=e/4,c=n/4;return new We().moveTo(s,n,{geometry:{isFilled:o}}).cubicBezierTo(0,c*1.2,a*1.5,c*3,0,c*2.5).cubicBezierTo(s,c*.9,0,-c*.32,a*1.85,-c*.32).cubicBezierTo(e,c*1.2,a*2.15,-c*.32,e,-c*.32).cubicBezierTo(s,n,e,c*2.5,a*2.5,c*3).close()}case"hexagon":return We.lineThroughPoints(jf(e,n,6),{geometry:{isFilled:o}}).close();case"octagon":return We.lineThroughPoints(jf(e,n,8),{geometry:{isFilled:o}}).close();case"oval":return t7(e,n,o);case"pentagon":return We.lineThroughPoints(jf(e,n,5),{geometry:{isFilled:o}}).close();case"rectangle":return new We().moveTo(0,0,{geometry:{isFilled:o}}).lineTo(e,0).lineTo(e,n).lineTo(0,n).close();case"rhombus":{const a=Math.min(e*.38,n*.38);return new We().moveTo(a,0,{geometry:{isFilled:o}}).lineTo(e,0).lineTo(e-a,n).lineTo(0,n).close()}case"rhombus-2":{const a=Math.min(e*.38,n*.38);return new We().moveTo(0,0,{geometry:{isFilled:o}}).lineTo(e-a,0).lineTo(e,n).lineTo(a,n).close()}case"star":return n7(e,n,o);case"trapezoid":{const a=Math.min(e*.38,n*.38);return new We().moveTo(a,0,{geometry:{isFilled:o}}).lineTo(e-a,0).lineTo(e,n).lineTo(0,n).close()}case"triangle":return new We().moveTo(s,0,{geometry:{isFilled:o}}).lineTo(e,n).lineTo(0,n).close();case"x-box":return e7(e,n,i,t.props.dash,o);case"cloud":return o7(e,n,t.id,t.props.size,t.props.scale,o);default:Ke(t.props.geo)}}function e7(t,e,n,s,r){const i=t/2,o=e/2,a=new We().moveTo(0,0,{geometry:{isFilled:r}}).lineTo(t,0).lineTo(t,e).lineTo(0,e).close();if(s==="dashed"||s==="dotted")return a.moveTo(0,0,{geometry:{isInternal:!0,isFilled:!1},dashStart:"skip",dashEnd:"outset"}).lineTo(i,o).moveTo(t,e,{geometry:{isInternal:!0,isFilled:!1},dashStart:"skip",dashEnd:"outset"}).lineTo(i,o).moveTo(0,e,{geometry:{isInternal:!0,isFilled:!1},dashStart:"skip",dashEnd:"outset"}).lineTo(i,o).moveTo(t,0,{geometry:{isInternal:!0,isFilled:!1},dashStart:"skip",dashEnd:"outset"}).lineTo(i,o);const c=s==="draw"?.62:0;return a.moveTo(Ce(n*c,0,t),Ce(n*c,0,e),{geometry:{isInternal:!0,isFilled:!1}}).lineTo(Ce(t-n*c,0,t),Ce(e-n*c,0,e)).moveTo(Ce(t-n*c,0,t),Ce(n*c,0,e)).lineTo(Ce(n*c,0,t),Ce(e-n*c,0,e)),a}function t7(t,e,n){if(e>t){const r=t/2;return new We().moveTo(0,r,{geometry:{isFilled:n}}).arcTo(r,r,!1,!0,0,t,r).lineTo(t,e-r).arcTo(r,r,!1,!0,0,0,e-r).close()}const s=e/2;return new We().moveTo(s,e,{geometry:{isFilled:n}}).arcTo(s,s,!1,!0,0,s,0).lineTo(t-s,0).arcTo(s,s,!1,!0,0,t-s,e).close()}function n7(t,e,n){const r=at/5/2,i=Math.floor(5/4)*2,o=10-i,a=0,c=Math.floor(5/2)*2,l=Math.cos(-vt+i*r)*t/2,u=Math.cos(-vt+o*r)*t/2,d=Math.sin(-vt+a*r)*e/2,p=Math.sin(-vt+c*r)*e/2,f=t-Math.abs(l-u),g=e-Math.abs(p-d),x=t/2+u-(t/2-l),y=e/2+d-(e/2-p),m=1,S=(t-x)/2,w=(e-y)/2,P=(t+f)/2,_=(e+g)/2,I=P*m/2,C=_*m/2;return We.lineThroughPoints(Array.from(Array(10),(E,O)=>{const k=-vt+O*r;return new b(S+(O%2?I:P)*Math.cos(k),w+(O%2?C:_)*Math.sin(k))}),{geometry:{isFilled:n}}).close()}function Yv(t,e){return t>e?(Ve*(e/2)+(t-e))*2:(Ve*(t/2)+(e-t))*2}function s7(t,e,n){const s=Math.min(t,e)/2,r=Math.max(t,e)-s*2,o=(Math.PI*(s*2)+2*r)/n,a=t>e?[{type:"straight",start:new b(s,0),delta:new b(1,0)},{type:"arc",center:new b(t-s,s),startAngle:-Ve/2},{type:"straight",start:new b(t-s,e),delta:new b(-1,0)},{type:"arc",center:new b(s,s),startAngle:Ve/2}]:[{type:"straight",start:new b(t,s),delta:new b(0,1)},{type:"arc",center:new b(s,e-s),startAngle:0},{type:"straight",start:new b(0,e-s),delta:new b(0,-1)},{type:"arc",center:new b(s,s),startAngle:Ve}];let c=0;const l=[];for(let u=0;u<n;u++){const d=a[0];d.type==="straight"?l.push(b.Add(d.start,b.Mul(d.delta,c))):l.push(Qm(d.center,s,d.startAngle+c/s)),c+=o;let p=d.type==="straight"?r:Ve*s;for(;c>p;)c-=p,a.push(a.shift()),p=a[0].type==="straight"?r:Ve*s}return l}const r7={s:50,m:70,l:100,xl:130},i7=.2;function o7(t,e,n,s,r,i){const o=new We,a=uo(n),c=Yv(t,e),l=Math.max(Math.ceil(c/r7[s]),6,Math.ceil(c/Math.min(t,e))),u=c/l*i7,d=Math.max(t-u*2,1),p=Math.max(e-u*2,1),g=Yv(d,p)/l,x=(t-d)/2,y=(e-p)/2,m=s7(d,p,l).map(_=>_.addXY(x,y)),S=t<20?0:u*.3,w=e<20?0:u*.3,P=m.slice(0);for(let _=0;_<Math.floor(l/2);_++)P[_]=b.AddXY(P[_],a()*S*r,a()*w*r),P[l-_-1]=b.AddXY(P[l-_-1],a()*S*r,a()*w*r);for(let _=0;_<P.length;_++){const I=_===P.length-1?0:_+1,C=P[_],E=P[I],O=m[_],k=m[I],T=b.Dist(O,k),D=g-T,M=b.Dist(C,E)/T,L=(Math.max(x,y)+D)*M,U=b.Lrp(O,k,.5).add(b.Sub(k,O).uni().per().mul(L));U.x<0?U.x=0:U.x>t&&(U.x=t),U.y<0?U.y=0:U.y>e&&(U.y=e);const V=wP(C,E,U),J=b.Dist(V||b.Average([C,E]),C);_===0&&o.moveTo(C.x,C.y,{geometry:{isFilled:i}}),o.circularArcTo(J,!1,!0,E.x,E.y)}return o.close()}function Vv({shape:t,shouldScale:e,forceSolid:n}){const s=e?t.props.scale:1,r=Us(),{props:i}=t,{color:o,fill:a,dash:c,size:l}=i,u=Ht[l]*s,d=Jg(t),p=c==="draw"&&!n?d.toDrawD({strokeWidth:u,randomSeed:t.id,passes:1,offset:0,onlyFilled:!0}):d.toD({onlyFilled:!0});return h.jsxs(h.Fragment,{children:[h.jsx(Lc,{theme:r,d:p,color:o,fill:a,scale:s}),d.toSvg({style:c,strokeWidth:u,forceSolid:n,randomSeed:t.id,props:{fill:"none",stroke:Ue(r,o,"solid")}})]})}const Ko=51;class a7 extends xa{static type="geo";static props=rP;static migrations=iP;options={showTextOutline:!0};canEdit(){return!0}getDefaultProps(){return{w:100,h:100,geo:"rectangle",dash:"draw",growY:0,url:"",scale:1,color:"black",labelColor:"black",fill:"none",size:"m",font:"draw",align:"middle",verticalAlign:"middle",richText:ln("")}}getGeometry(e){const{props:n}=e,{scale:s}=n,i=Jg(e).toGeometry(),o=Math.max(1,n.w),a=Math.max(1,n.h+n.growY),c=o/s,l=a/s,u=kt(n.richText),d=u?d7:Ql(this.editor,e),p=u7(c,l,d,n.size,n.align,n.verticalAlign,s);return new os({children:[i,new rr({...p,isFilled:!0,isLabel:!0,excludeFromShapeBounds:!0,isEmptyLabel:u})]})}getHandleSnapGeometry(e){const n=this.getGeometry(e),s=n.children[0];switch(e.props.geo){case"arrow-down":case"arrow-left":case"arrow-right":case"arrow-up":case"check-box":case"diamond":case"hexagon":case"octagon":case"pentagon":case"rectangle":case"rhombus":case"rhombus-2":case"star":case"trapezoid":case"triangle":case"x-box":return{outline:s,points:[...s.vertices,n.bounds.center]};case"cloud":case"ellipse":case"heart":case"oval":return{outline:s,points:[n.bounds.center]};default:Ke(e.props.geo)}}getText(e){return co(this.editor,e.props.richText)}getFontFaces(e){return kt(e.props.richText)?Ct:Cu(this.editor,e.props.richText,{family:`tldraw_${e.props.font}`,weight:"normal",style:"normal"})}component(e){const{id:n,type:s,props:r}=e,{fill:i,font:o,align:a,verticalAlign:c,size:l,richText:u}=r,d=Us(),{editor:p}=this,f=$("isGeoOnlySelected",()=>e.id===p.getOnlySelectedShapeId(),[p]),g=Yy(p,e.id),x=kt(e.props.richText),y=g||!x,m=Rc(e.props.scale*.25);return h.jsxs(h.Fragment,{children:[h.jsx(ki,{children:h.jsx(Vv,{shape:e,shouldScale:!0,forceSolid:m})}),y&&h.jsx(Ci,{style:{overflow:"hidden",width:e.props.w,height:e.props.h+r.growY},children:h.jsx(Uu,{shapeId:n,type:s,font:o,fontSize:Mi[l]*e.props.scale,lineHeight:$n.lineHeight,padding:Rn*e.props.scale,fill:i,align:a,verticalAlign:c,richText:u,isSelected:f,labelColor:Ue(d,r.labelColor,"solid"),wrap:!0,showTextOutline:this.options.showTextOutline})}),e.props.url&&h.jsx(ca,{url:e.props.url})]})}indicator(e){const n=Rc(e.props.scale*.25),{size:s,dash:r,scale:i}=e.props,o=Ht[s];return Jg(e).toSvg({style:r==="draw"?"draw":"solid",strokeWidth:1,passes:1,randomSeed:e.id,offset:0,roundness:o*2*i,props:{strokeWidth:void 0},forceSolid:n})}toSvg(e,n){const s=e.props.scale,r={...e,props:{...e.props,w:e.props.w/s,h:(e.props.h+e.props.growY)/s,growY:0}},i=r.props;n.addExportDef(Vy(i.fill));let o;if(!kt(i.richText)){const a=Fi(n),c=new X(0,0,i.w,(e.props.h+e.props.growY)/s);o=h.jsx(Hu,{fontSize:Mi[i.size],font:i.font,align:i.align,verticalAlign:i.verticalAlign,richText:i.richText,labelColor:Ue(a,i.labelColor,"solid"),bounds:c,padding:Rn,showTextOutline:this.options.showTextOutline})}return h.jsxs(h.Fragment,{children:[h.jsx(Vv,{shouldScale:!1,shape:r,forceSolid:!1}),o]})}getCanvasSvgDefs(){return[Xy()]}onResize(e,{handle:n,newPoint:s,scaleX:r,scaleY:i,initialShape:o}){const a=Zv(o.props);let c=a.w*r,l=(a.h+a.growY)*i,u=0,d=0;if(!kt(e.props.richText)){const m=Ql(this.editor,o),S=Math.abs(c),w=Math.abs(l),P=Math.max(S,m.w,Ko),_=Math.max(w,m.h,Ko);u=P-S,d=_-w,c=P*Math.sign(c||1),l=_*Math.sign(l||1)}const p=c*e.props.scale,f=l*e.props.scale,g=new b(0,0);r<0&&(g.x+=p),(n==="left"||n==="top_left"||n==="bottom_left")&&(g.x+=r<0?u:-u),i<0&&(g.y+=f),(n==="top"||n==="top_left"||n==="top_right")&&(g.y+=i<0?d:-d);const{x,y}=g.rot(e.rotation).add(s);return{x,y,props:{w:Math.max(Math.abs(p),1),h:Math.max(Math.abs(f),1),growY:0}}}onBeforeCreate(e){const{props:n}=e;if(kt(n.richText))return n.growY!==0?{...e,props:{...n,growY:0}}:void 0;const s=n.h/n.scale,r=Ql(this.editor,e).h,i=Jv(s,r,n.growY/n.scale);if(i!==null)return{...e,props:{...n,growY:i*n.scale}}}onBeforeUpdate(e,n){const{props:s}=e,{props:r}=n;if(xr(s.richText,r.richText)&&s.font===r.font&&s.size===r.size)return;const i=kt(s.richText),o=kt(r.richText);if(i&&o)return;if(o)return r.growY!==0?{...n,props:{...r,growY:0}}:void 0;const a=Zv(s),c=Ql(this.editor,n),{scale:l}=r;if(i&&!o){const f=h7(a.w,a.h,c);return{...n,props:{...r,w:f.w*l,h:f.h*l,growY:0}}}const u=n.props.w/l,d=c.w>u,p=Jv(a.h,c.h,a.growY);if(p!==null||d)return{...n,props:{...r,growY:(p??a.growY)*l,w:Math.max(u,c.w)*l}}}onDoubleClick(e){if(this.editor.inputs.getAltKey())switch(e.props.geo){case"rectangle":return{...e,props:{geo:"check-box"}};case"check-box":return{...e,props:{geo:"rectangle"}}}}getInterpolatedProps(e,n,s){return{...s>.5?n.props:e.props,w:ke(e.props.w,n.props.w,s),h:ke(e.props.h,n.props.h,s),scale:ke(e.props.scale,n.props.scale,s)}}}const c7=Object.freeze({s:12,m:14,l:16,xl:20}),l7=Object.freeze({s:2,m:3.5,l:5,xl:10}),d7=Object.freeze({w:0,h:0}),Xv=8;function u7(t,e,n,s,r,i,o){const a=Math.min(100,t/2),c=Math.min(Mi[s]*$n.lineHeight+Rn*2,e/2),l=Math.min(t,Math.max(n.w,Math.min(a,Math.max(1,t-Xv)))),u=Math.min(e,Math.max(n.h,Math.min(c,Math.max(1,e-Xv)))),d=r==="start"?0:r==="end"?t-l:(t-l)/2,p=i==="start"?0:i==="end"?e-u:(e-u)/2;return{x:d*o,y:p*o,width:l*o,height:u*o}}function Zv(t){const{w:e,h:n,growY:s,scale:r}=t;return{w:e/r,h:n/r,growY:s/r}}function Jv(t,e,n){return e>t?e-t:n>0?0:null}function h7(t,e,n){let s=Math.max(t,n.w),r=Math.max(e,n.h);if(t<Ko&&e<Ko){s=Math.max(s,Ko),r=Math.max(r,Ko);const i=Math.max(s,r);s=i,r=i}return{w:s,h:r}}const p7=new dn;function Ql(t,e){return p7.get(e,()=>f7(t,e))}function f7(t,e){const{richText:n,font:s,size:r,w:i}=e.props,o=c7[r],a=Dc(t,n),c=t.textMeasure.measureHtml(a,{...$n,fontFamily:ji[s],fontSize:Mi[r],minWidth:o,maxWidth:Math.max(0,Math.ceil(o+l7[r]),Math.ceil(i/e.props.scale-Rn*2))});return{w:c.w+Rn*2,h:c.h+Rn*2}}function g7(){const[t,e]=v.useState(!1);return v.useEffect(()=>{const s=CSS.supports("color","color(display-p3 1 1 1)"),r=matchMedia("(color-gamut: p3)");e(s&&r.matches);const i=()=>e(s&&r.matches);return r.addEventListener("change",i),()=>r.removeEventListener("change",i)},[]),$(mt.forceSrgb)||!t?"srgb":"p3"}class m7 extends zi{static type="highlight";static props=cP;static migrations=lP;options={maxPointsPerShape:600,underlayOpacity:.82,overlayOpacity:.35};hideResizeHandles(e){return ed(e)}hideRotateHandle(e){return ed(e)}hideSelectionBoundsFg(e){return ed(e)}getDefaultProps(){return{segments:[],color:"black",size:"m",isComplete:!1,isPen:!1,scale:1,scaleX:1,scaleY:1}}getGeometry(e){const n=Gi(e);if(ed(e))return new Rd({x:-n/2,y:-n/2,radius:n/2,isFilled:!0});const{strokePoints:s,sw:r}=Qv(e,n,!0),i=Py({strokeWidth:r,showAsComplete:!0});return Wy(s,i),new Ic({points:l2(s,i),isFilled:!0})}component(e){const n=ug(this.editor,e),s=Gi(e);return h.jsx(ki,{children:h.jsx(td,{shape:e,forceSolid:n,strokeWidth:s,opacity:this.options.overlayOpacity})})}backgroundComponent(e){const n=ug(this.editor,e),s=Gi(e);return h.jsx(ki,{children:h.jsx(td,{shape:e,forceSolid:n,strokeWidth:s,opacity:this.options.underlayOpacity})})}indicator(e){const n=ug(this.editor,e),s=Gi(e),{strokePoints:r,sw:i}=Qv(e,s,n),o=ia(e.props.segments,e.props.scaleX,e.props.scaleY);let a;return r.length<2?a=S7(o[0],i):a=Fc(r,!1),h.jsx("path",{d:a})}toSvg(e){const n=Gi(e),s=n<1.5,r=1/e.props.scale;return h.jsx("g",{transform:`scale(${r})`,children:h.jsx(td,{forceSolid:s,strokeWidth:n,shape:e,opacity:this.options.overlayOpacity})})}toBackgroundSvg(e){const n=Gi(e),s=n<1.5,r=1/e.props.scale;return h.jsx("g",{transform:`scale(${r})`,children:h.jsx(td,{forceSolid:s,strokeWidth:n,shape:e,opacity:this.options.underlayOpacity})})}onResize(e,n){const{scaleX:s,scaleY:r}=n;return{props:{scaleX:s*e.props.scaleX,scaleY:r*e.props.scaleY}}}getInterpolatedProps(e,n,s){return{...s>.5?n.props:e.props,...n.props,segments:B2(e.props.segments,n.props.segments,s),scale:ke(e.props.scale,n.props.scale,s)}}}function y7(t){return`M ${t.x} ${t.y} m -${.1}, 0 a ${.1},${.1} 0 1,0 ${.1*2},0 a ${.1},${.1} 0 1,0 -${.1*2},0`}function S7(t,e){const n=e/2;return`M ${t.x} ${t.y} m -${n}, 0 a ${n},${n} 0 1,0 ${n*2},0 a ${n},${n} 0 1,0 -${n*2},0`}function Qv(t,e,n){const s=ia(t.props.segments,t.props.scaleX,t.props.scaleY),r=t.props.isComplete||Fs(t.props.segments)?.type==="straight";let i=e;!n&&!t.props.isPen&&s.length===1&&(i+=uo(t.id)()*(e/6));const o=Py({strokeWidth:i,showAsComplete:r});return{strokePoints:Ai(s,o),sw:i}}function Gi(t){return oa[t.props.size]*1.12*t.props.scale}function ed(t){return t.props.segments.length===1&&t.props.segments[0].path.length<24}function td({strokeWidth:t,forceSolid:e,shape:n,opacity:s}){const r=Us(),i=ia(n.props.segments,n.props.scaleX,n.props.scaleY);let o=t;!e&&!n.props.isPen&&i.length===1&&(o+=uo(n.id)()*(o/6));const a=Py({strokeWidth:o,showAsComplete:n.props.isComplete||Fs(n.props.segments)?.type==="straight"}),c=Ai(i,a),l=c.length>1?Fc(c,!1):y7(i[0]),u=g7(),d=Ue(r,n.props.color,u==="p3"?"highlightP3":"highlightSrgb");return h.jsx("path",{d:l,strokeLinecap:"round",fill:"none",pointerEvents:"all",stroke:d,strokeWidth:o,opacity:s})}function ug(t,e){return $("forceSolid",()=>{const n=Gi(e),s=t.getEfficientZoomLevel();return n/s<1.5},[t])}function U2(){return h.jsxs("svg",{width:"15",height:"15",viewBox:"0 0 30 30",xmlns:"http://www.w3.org/2000/svg",fill:"none",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",children:[h.jsx("path",{d:"M3,11 L3,3 11,3",strokeWidth:"2"}),h.jsx("path",{d:"M19,27 L27,27 L27,19",strokeWidth:"2"}),h.jsx("path",{d:"M27,3 L3,27",strokeWidth:"2"})]})}function H2({shapeId:t,assetId:e,width:n}){const s=z(),r=Jc(),i=sR(),[o,a]=v.useState(()=>({asset:e?s.getAsset(e)??null:null,url:null})),c=v.useRef(!1),l=v.useRef(null);return v.useEffect(()=>{if(!e)return;let u=!1,d;const p=is("update state",()=>{if(!r&&t&&s.getCulledShapes().has(t))return;const f=s.getAsset(e);if(!f){a(y=>({...y,asset:null,url:null}));return}if(!f.props.src){const y=s.getTemporaryAssetPreview(f.id);if(y){l.current!==y&&(l.current=y,a(m=>({...m,isPlaceholder:!0,url:y})),i());return}}const g=r?r.scale*(n/f.props.w):s.getEfficientZoomLevel()*(n/f.props.w);function x(y,m){u||l.current!==m&&(c.current=!0,l.current=m,a({asset:y,url:m}),i())}if(c.current){let y=0;const m=()=>{y++,y>500/16&&(e0(s,e,g,r,S=>x(f,S)),d?.())};d?.(),s.on("tick",m),d=()=>s.off("tick",m)}else e0(s,e,g,r,y=>x(f,y))});return()=>{p(),d?.(),u=!0}},[s,e,r,i,t,n]),o}function e0(t,e,n,s,r){t.resolveAssetUrl(e,{screenScale:n,shouldResolveToOriginal:s?s.pixelRatio===null:!1,dpr:s?.pixelRatio??void 0}).then(i=>{r(i)})}async function x7(t){const n=await(await Qr(t)).blob();return vn.blobToDataUrl(n)}const b7=new dn;class w7 extends xa{static type="image";static props=dP;static migrations=uP;isAspectRatioLocked(){return!0}canCrop(){return!0}isExportBoundsContainer(){return!0}getDefaultProps(){return{w:100,h:100,assetId:null,playing:!0,url:"",crop:null,flipX:!1,flipY:!1,altText:""}}getGeometry(e){return e.props.crop?.isCircle?new b4({width:e.props.w,height:e.props.h,isFilled:!0}):new rr({width:e.props.w,height:e.props.h,isFilled:!0})}getAriaDescriptor(e){return e.props.altText}onResize(e,n){let s=Iu(e,n);const{flipX:r,flipY:i}=n.initialShape.props,{scaleX:o,scaleY:a,mode:c}=n;if(s={...s,props:{...s.props,flipX:o<0!==r,flipY:a<0!==i}},!e.props.crop)return s;const l=c==="scale_shape"&&o===-1||c==="resize_bounds"&&r!==s.props.flipX,u=c==="scale_shape"&&a===-1||c==="resize_bounds"&&i!==s.props.flipY,{topLeft:d,bottomRight:p}=e.props.crop;return s.props.crop={topLeft:{x:l?1-p.x:d.x,y:u?1-p.y:d.y},bottomRight:{x:l?1-d.x:p.x,y:u?1-d.y:p.y},isCircle:e.props.crop.isCircle},s}component(e){return h.jsx(v7,{shape:e})}indicator(e){return this.editor.getCroppingShapeId()===e.id?null:e.props.crop?.isCircle?h.jsx("ellipse",{cx:F(e.props.w/2),cy:F(e.props.h/2),rx:F(e.props.w/2),ry:F(e.props.h/2)}):h.jsx("rect",{width:F(e.props.w),height:F(e.props.h)})}async toSvg(e,n){const s=e.props;if(!s.assetId)return null;const r=this.editor.getAsset(s.assetId);if(!r)return null;const{w:i}=ir(e.props,s.crop),o=await b7.get(r,async()=>{let a=await n.resolveAssetUrl(r.id,i);if(!a)return null;if((a.startsWith("blob:")||a.startsWith("http")||a.startsWith("/")||a.startsWith("./"))&&(a=await x7(a)||""),K2(this.editor,r.id)){const{promise:c}=q2(a);a=await c}return a});return o?h.jsx(P7,{shape:e,src:o}):null}onDoubleClickEdge(e){const n=e.props;if(!n||this.editor.getCroppingShapeId()!==e.id)return;const s=wt(n.crop)||{topLeft:{x:0,y:0},bottomRight:{x:1,y:1}},{w:r,h:i}=ir(e.props,s),o=new b(s.topLeft.x*r,s.topLeft.y*i).rot(e.rotation),a={id:e.id,type:e.type,x:e.x-o.x,y:e.y-o.y,props:{crop:{topLeft:{x:0,y:0},bottomRight:{x:1,y:1}},w:r,h:i}};this.editor.updateShapes([a])}getInterpolatedProps(e,n,s){function r(i,o){if(i.props.crop===null&&o.props.crop===null)return null;const a=i.props.crop?.topLeft||{x:0,y:0},c=i.props.crop?.bottomRight||{x:1,y:1},l=o.props.crop?.topLeft||{x:0,y:0},u=o.props.crop?.bottomRight||{x:1,y:1};return{topLeft:{x:ke(a.x,l.x,s),y:ke(a.y,l.y,s)},bottomRight:{x:ke(c.x,u.x,s),y:ke(c.y,u.y,s)}}}return{...s>.5?n.props:e.props,w:ke(e.props.w,n.props.w,s),h:ke(e.props.h,n.props.h,s),crop:r(e,n)}}}const v7=v.memo(function({shape:e}){const n=z(),{w:s}=ir(e.props,e.props.crop),{asset:r,url:i}=H2({shapeId:e.id,assetId:e.props.assetId,width:s}),o=AT(),[a,c]=v.useState(""),[l,u]=v.useState(null),d=r&&K2(n,r.id);v.useEffect(()=>{if(i&&d){const{promise:S,cancel:w}=q2(i);return S.then(P=>{c(P),u(i)}),()=>{w()}}},[n,d,o,i]);const p=$("show crop preview",()=>e.id===n.getOnlySelectedShapeId()&&n.getCroppingShapeId()===e.id&&n.isIn("select.crop"),[n,e.id]),f=o&&(r?.props.mimeType?.includes("video")||d),g=W2(e),x=i===l?null:i,y=f?a:l;if(!i&&!r?.props.src)return h.jsxs(Ci,{id:e.id,style:{overflow:"hidden",width:e.props.w,height:e.props.h,color:"var(--tl-color-text-3)",backgroundColor:"var(--tl-color-low)",border:"1px solid var(--tl-color-low-border)"},children:[h.jsx("div",{className:de("tl-image-container",r&&"tl-image-container-loading"),style:g,children:r?null:h.jsx(U2,{})}),"url"in e.props&&e.props.url&&h.jsx(ca,{url:e.props.url})]});const m=d?"anonymous":void 0;return h.jsxs(h.Fragment,{children:[p&&y&&h.jsx("div",{style:g,children:h.jsx("img",{className:"tl-image",style:{...mc(e),opacity:.1},crossOrigin:m,src:y,referrerPolicy:"strict-origin-when-cross-origin",draggable:!1,alt:""})}),h.jsxs(Ci,{id:e.id,style:{overflow:"hidden",width:e.props.w,height:e.props.h,borderRadius:e.props.crop?.isCircle?"50%":void 0},children:[h.jsxs("div",{className:de("tl-image-container"),style:g,children:[y&&h.jsx("img",{className:"tl-image",style:mc(e),crossOrigin:m,src:y,referrerPolicy:"strict-origin-when-cross-origin",draggable:!1,alt:""},y),x&&h.jsx("img",{className:"tl-image",style:mc(e),crossOrigin:m,src:x,referrerPolicy:"strict-origin-when-cross-origin",draggable:!1,alt:e.props.altText,onLoad:()=>u(x)},x)]}),e.props.url&&h.jsx(ca,{url:e.props.url})]})]})});function K2(t,e){const n=e?t.getAsset(e):void 0;return n?"mimeType"in n.props&&ms.isAnimatedImageType(n?.props.mimeType)||"isAnimated"in n.props&&n.props.isAnimated:!1}function W2(t){const e=t.props.crop,n=e?.topLeft;if(!n)return{width:t.props.w,height:t.props.h};const{w:s,h:r}=ir(t.props,e),i=-n.x*s,o=-n.y*r;return{transform:`translate(${i}px, ${o}px)`,width:s,height:r}}function mc(t,e){const{flipX:n,flipY:s,crop:r}=t.props;if(!n&&!s)return;let i,o;if(r){const{w:l,h:u}=ir(t.props,r),d=r.bottomRight.x-r.topLeft.x,p=r.bottomRight.y-r.topLeft.y;i=sr(r.topLeft.x,[0,1-d],[0,l-t.props.w]),o=sr(r.topLeft.y,[0,1-p],[0,u-t.props.h])}const a=`scale(${n?-1:1}, ${s?-1:1})`;return{transform:`${e?`translate(${(n?e.width:0)-(i||0)}px,
		             ${(s?e.height:0)-(o||0)}px)`:""} ${a}`,transformOrigin:e?"0 0":"center center"}}function P7({shape:t,src:e}){const n=yo(),s=W2(t),r=t.props.crop;if(s.transform&&r){const{transform:i,width:o,height:a}=s,c=(r.bottomRight.x-r.topLeft.x)*o,l=(r.bottomRight.y-r.topLeft.y)*a,u=[new b(0,0),new b(c,0),new b(c,l),new b(0,l)],d=mc(t,{width:o,height:a});return h.jsxs(h.Fragment,{children:[h.jsx("defs",{children:h.jsx("clipPath",{id:n,children:r.isCircle?h.jsx("ellipse",{cx:c/2,cy:l/2,rx:c/2,ry:l/2}):h.jsx("polygon",{points:u.map(p=>`${p.x},${p.y}`).join(" ")})})}),h.jsx("g",{clipPath:`url(#${n})`,children:h.jsx("image",{href:e,width:o,height:a,"aria-label":t.props.altText,style:d?{...d}:{transform:i}})})]})}else return h.jsx("image",{href:e,width:t.props.w,height:t.props.h,"aria-label":t.props.altText,style:mc(t,{width:t.props.w,height:t.props.h})})}function q2(t){let e=!1;return{promise:new Promise(s=>{const r=Sc();r.onload=()=>{if(e)return;const i=document.createElement("canvas");i.width=r.width,i.height=r.height;const o=i.getContext("2d");o&&(o.drawImage(r,0,0),s(i.toDataURL()))},r.crossOrigin="anonymous",r.src=t}),cancel:()=>e=!0}}const I7=new dn;class _7 extends zi{static type="line";static props=hP;static migrations=pP;hideResizeHandles(){return!0}hideRotateHandle(){return!0}hideSelectionBoundsFg(){return!0}hideSelectionBoundsBg(){return!0}hideInMinimap(){return!0}getDefaultProps(){const[e,n]=bc(2);return{dash:"draw",size:"m",color:"black",spline:"line",points:{[e]:{id:e,index:e,x:0,y:0},[n]:{id:n,index:n,x:.1,y:.1}},scale:1}}getGeometry(e){const n=Qg(e).toGeometry();return le(n instanceof Bg),n}getHandles(e){return I7.get(e.props,()=>{const n=this.getGeometry(e),s=ic(e),r=s.map(i=>({...i,id:i.index,type:"vertex",canSnap:!0}));for(let i=0;i<s.length-1;i++){const o=Qo(s[i].index,s[i+1].index),c=n.getSegments()[i].interpolateAlongEdge(.5);r.push({id:o,type:"create",index:o,x:c.x,y:c.y,canSnap:!0})}return r.sort(Yt)})}onResize(e,n){const{scaleX:s,scaleY:r}=n;return{props:{points:Oi(e.props.points,(i,{id:o,index:a,x:c,y:l})=>({id:o,index:a,x:c*s,y:l*r}))}}}onBeforeCreate(e){const{props:{points:n}}=e,s=Object.keys(n);if(s.length<2)return;const r=n[s[0]];if(s.every(o=>{const a=n[o];return a.x===r.x&&a.y===r.y})){const o=s[s.length-1];return n[o]={...n[o],x:n[o].x+.1,y:n[o].y+.1},e}}onHandleDrag(e,{handle:n}){const s=vs(new b(n.x,n.y),this.editor);return{...e,props:{...e.props,points:{...e.props.points,[n.id]:{id:n.id,index:n.index,x:s.x,y:s.y}}}}}onHandleDragStart(e,{handle:n}){if(n.type==="create")return{...e,props:{...e.props,points:{...e.props.points,[n.index]:{id:n.index,index:n.index,x:n.x,y:n.y}}}}}component(e){return h.jsx(ki,{style:{minWidth:50,minHeight:50},children:h.jsx(t0,{shape:e})})}indicator(e){const n=ys[e.props.size]*e.props.scale,s=Qg(e),{dash:r}=e.props;return s.toSvg({style:r==="draw"?"draw":"solid",strokeWidth:1,passes:1,randomSeed:e.id,offset:0,roundness:n*2,props:{strokeWidth:void 0}})}toSvg(e){return h.jsx(t0,{shouldScale:!0,shape:e})}getHandleSnapGeometry(e){const n=ic(e);return{points:n,getSelfSnapPoints:s=>{const r=this.getHandles(e).filter(i=>i.type==="vertex").findIndex(i=>i.id===s.id);return n.filter((i,o)=>Math.abs(o-r)>1).map(b.From)},getSelfSnapOutline:s=>{const r=this.getHandles(e).filter(o=>o.type==="vertex").findIndex(o=>o.id===s.id),i=this.getGeometry(e).getSegments().filter((o,a)=>a!==r-1&&a!==r);return i.length?new os({children:i}):null}}}getInterpolatedProps(e,n,s){const r=ic(e),i=ic(n),o=[],a=[];let c=fm;if(r.length>i.length)for(let l=0;l<r.length;l++)o[l]={...r[l]},i[l]===void 0?a[l]={...i[i.length-1],id:c}:a[l]={...i[l],id:c},c=Ls(c);else if(i.length>r.length)for(let l=0;l<i.length;l++)a[l]={...i[l]},r[l]===void 0?o[l]={...r[r.length-1],id:c}:o[l]={...r[l],id:c},c=Ls(c);else for(let l=0;l<i.length;l++)o[l]=r[l],a[l]=i[l];return{...s>.5?n.props:e.props,points:Object.fromEntries(o.map((l,u)=>{const d=a[u];return[l.id,{...l,x:ke(l.x,d.x,s),y:ke(l.y,d.y,s)}]})),scale:ke(e.props.scale,n.props.scale,s)}}}function ic(t){return Object.values(t.props.points).sort(Yt)}const C7=new dn;function Qg(t){return C7.get(t,()=>{const e=ic(t).map(b.From);switch(t.props.spline){case"cubic":return We.cubicSplineThroughPoints(e,{endOffsets:0});case"line":return We.lineThroughPoints(e,{endOffsets:0})}})}function t0({shape:t,shouldScale:e=!1,forceSolid:n=!1}){const s=Us(),r=Qg(t),{dash:i,color:o,size:a}=t.props,c=1/t.props.scale,l=e?c:1,u=ys[a]*t.props.scale;return r.toSvg({style:i,strokeWidth:u,forceSolid:n,randomSeed:t.id,props:{transform:`scale(${l})`,stroke:Ue(s,o,"solid"),fill:"none"}})}class T7 extends zi{static type="note";static props=fP;static migrations=gP;options={resizeMode:"none"};canEdit(){return!0}hideResizeHandles(){const{resizeMode:e}=this.options;switch(e){case"none":return!0;case"scale":return!1;default:throw Ke(e)}}isAspectRatioLocked(){return this.options.resizeMode==="scale"}hideSelectionBoundsFg(){return!1}getDefaultProps(){return{color:"black",richText:ln(""),size:"m",font:"draw",align:"middle",verticalAlign:"middle",labelColor:"black",growY:0,fontSizeAdjustment:0,url:"",scale:1}}getGeometry(e){const{labelHeight:n,labelWidth:s}=G2(this.editor,e),{scale:r}=e.props,i=n*r,o=s*r,a=et*r,c=nd(e);return new os({children:[new rr({width:a,height:c,isFilled:!0}),new rr({x:e.props.align==="start"?0:e.props.align==="end"?a-o:(a-o)/2,y:e.props.verticalAlign==="start"?0:e.props.verticalAlign==="end"?c-i:(c-i)/2,width:o,height:i,isFilled:!0,isLabel:!0,excludeFromShapeBounds:!0})]})}getHandles(e){const{scale:n}=e.props;if(this.editor.getInstanceState().isCoarsePointer)return[];const r=this.editor.getEfficientZoomLevel();if(r*n<.25)return[];const i=nd(e),o=et*n,a=NN/r*n;return r*n<.5?[{id:"bottom",index:"a3",type:"clone",x:o/2,y:i+a}]:[{id:"top",index:"a1",type:"clone",x:o/2,y:-a},{id:"right",index:"a2",type:"clone",x:o+a,y:i/2},{id:"bottom",index:"a3",type:"clone",x:o/2,y:i+a},{id:"left",index:"a4",type:"clone",x:-a,y:i/2}]}onResize(e,n){const{resizeMode:s}=this.options;switch(s){case"none":return;case"scale":return ET(e,n);default:throw Ke(s)}}getText(e){return co(this.editor,e.props.richText)}getFontFaces(e){return kt(e.props.richText)?Ct:Cu(this.editor,e.props.richText,{family:`tldraw_${e.props.font}`,weight:"normal",style:"normal"})}component(e){const{id:n,type:s,props:{labelColor:r,scale:i,color:o,font:a,size:c,align:l,richText:u,verticalAlign:d,fontSizeAdjustment:p}}=e,f=A7(n),g=Us(),x=et*i,y=nd(e),m=$("shape rotation",()=>this.editor.getShapePageTransform(n)?.rotation()??0,[this.editor]),S=$("dark mode",()=>this.editor.user.getIsDarkMode(),[this.editor]);let w=Rc(i*.25);S&&(w=!0);const P=e.id===this.editor.getOnlySelectedShapeId(),_=Yy(this.editor,e.id),I=kt(u);return h.jsxs(h.Fragment,{children:[h.jsx("div",{id:n,className:"tl-note__container",style:{width:x,height:y,backgroundColor:Ue(g,o,"noteFill"),borderBottom:w?S?`${2*i}px solid rgb(20, 20, 20)`:`${2*i}px solid rgb(144, 144, 144)`:"none",boxShadow:w?"none":M7(e.id,m,i)},children:(P||_||!I)&&h.jsx(Uu,{shapeId:n,type:s,font:a,fontSize:(p||Mi[c])*i,lineHeight:$n.lineHeight,align:l,verticalAlign:d,richText:u,isSelected:P,labelColor:r==="black"?Ue(g,o,"noteText"):Ue(g,r,"fill"),wrap:!0,padding:Rn*i,hasCustomTabBehavior:!0,showTextOutline:!1,onKeyDown:f})}),"url"in e.props&&e.props.url&&h.jsx(ca,{url:e.props.url})]})}indicator(e){const{scale:n}=e.props;return h.jsx("rect",{rx:n,width:F(et*n),height:F(nd(e))})}toSvg(e,n){const s=Fi({isDarkMode:n.isDarkMode}),r=j7(e),i=h.jsx(Hu,{fontSize:e.props.fontSizeAdjustment||Mi[e.props.size],font:e.props.font,align:e.props.align,verticalAlign:e.props.verticalAlign,richText:e.props.richText,labelColor:Ue(s,e.props.color,"noteText"),bounds:r,padding:Rn,showTextOutline:!1});return h.jsxs(h.Fragment,{children:[h.jsx("rect",{x:5,y:5,rx:1,width:et-10,height:r.h,fill:"rgba(0,0,0,.1)"}),h.jsx("rect",{rx:1,width:et,height:r.h,fill:Ue(s,e.props.color,"noteFill")}),i]})}onBeforeCreate(e){return n0(this.editor,e)}onBeforeUpdate(e,n){if(!(xr(e.props.richText,n.props.richText)&&e.props.font===n.props.font&&e.props.size===n.props.size))return n0(this.editor,n)}getInterpolatedProps(e,n,s){return{...s>.5?n.props:e.props,scale:ke(e.props.scale,n.props.scale,s)}}}function n0(t,e){const{labelHeight:n,fontSizeAdjustment:s}=G2(t,e),r=Math.max(0,n-et);if(r!==e.props.growY||s!==e.props.fontSizeAdjustment)return{...e,props:{...e.props,growY:r,fontSizeAdjustment:s}}}function E7(t,e){const{richText:n}=e.props;if(kt(n))return{labelHeight:Mi[e.props.size]*$n.lineHeight+Rn*2,labelWidth:100,fontSizeAdjustment:0};const s=Mi[e.props.size];let r=0,i=0,o=et,a=et;const c=1;do{r=Math.min(s,s-i);const l=Dc(t,n),u=t.textMeasure.measureHtml(l,{...$n,fontFamily:ji[e.props.font],fontSize:r,maxWidth:et-Rn*2-c,disableOverflowWrapBreaking:!0,measureScrollWidth:!0});if(o=u.h+Rn*2,a=u.w+Rn*2,r<=14){const d=Dc(t,n),p=t.textMeasure.measureHtml(d,{...$n,fontFamily:ji[e.props.font],fontSize:r,maxWidth:et-Rn*2-c});o=p.h+Rn*2,a=p.w+Rn*2;break}if(u.scrollWidth.toFixed(0)===u.w.toFixed(0))break}while(i++<50);return{labelHeight:o,labelWidth:a,fontSizeAdjustment:r}}const k7=new dn;function G2(t,e){return k7.get(e,()=>E7(t,e))}function A7(t){const e=z(),n=v.useContext(_y);return v.useCallback(s=>{const r=e.getShape(t);if(!r)return;const i=s.key==="Tab",o=(s.metaKey||s.ctrlKey)&&s.key==="Enter";if(i||o){s.preventDefault();const a=e.getShapePageTransform(t),c=a.rotation(),l=!!(n?.dir==="rtl"||p2(co(e,r.props.richText))),u=(et+e.options.adjacentShapeMargin+(o&&!s.shiftKey?r.props.growY:0))*r.props.scale,d=new b(i?s.shiftKey!=l?-1:1:0,o?s.shiftKey?-1:1:0).mul(u).add(Nu.clone().mul(r.props.scale)).rot(c).add(a.point()),p=I2(e,r,d,c);p&&Hn(e,p,{selectAll:!0})}},[t,e,n?.dir])}function nd(t){return(et+t.props.growY)*t.props.scale}function M7(t,e,n){const s=uo(t),r=Math.abs(s())+.5,i=Math.cos(e),o=5*n,a=4*n,c=6*n,l=7*n;return`0px ${o-r}px ${o}px -${o}px rgba(15, 23, 31, .6),
	0px ${(a+r*l)*Math.max(0,i)}px ${c+r*l}px -${a+r*c}px rgba(15, 23, 31, ${(.3+r*.1).toFixed(2)}), 
	0px ${48*n}px ${10*n}px -${10*n}px inset rgba(15, 23, 44, ${((.022+s()*.005)*((1+i)/2)).toFixed(2)})`}function j7(t){return new X(0,0,et,et+t.props.growY)}const D7=su("text size",(t,e)=>(t.fonts.trackFontsForShape(e),Y2(t,e.props)),{areRecordsEqual:(t,e)=>t.props===e.props});class O7 extends zi{static type="text";static props=mP;static migrations=yP;options={extraArrowHorizontalPadding:10,showTextOutline:!0};getDefaultProps(){return{color:"black",size:"m",w:8,font:"draw",textAlign:"start",autoSize:!0,scale:1,richText:ln("")}}getMinDimensions(e){return D7.get(this.editor,e.id)}getGeometry(e,n){const{scale:s}=e.props,{width:r,height:i}=this.getMinDimensions(e),o=n?.context??"none";return new rr({x:(o==="@tldraw/arrow-without-arrowhead"?-this.options.extraArrowHorizontalPadding:0)*s,width:(r+(o==="@tldraw/arrow-without-arrowhead"?this.options.extraArrowHorizontalPadding*2:0))*s,height:i*s,isFilled:!0,isLabel:!0})}getFontFaces(e){return Cu(this.editor,e.props.richText,{family:`tldraw_${e.props.font}`,weight:"normal",style:"normal"})}getText(e){return co(this.editor,e.props.richText)}canEdit(){return!0}isAspectRatioLocked(){return!0}component(e){const{id:n,props:{font:s,size:r,richText:i,color:o,scale:a,textAlign:c}}=e,{width:l,height:u}=this.getMinDimensions(e),d=e.id===this.editor.getOnlySelectedShapeId(),p=Us(),f=L7(n);return h.jsx(Uu,{shapeId:n,classNamePrefix:"tl-text-shape",type:"text",font:s,fontSize:oa[r],lineHeight:$n.lineHeight,align:c,verticalAlign:"middle",richText:i,labelColor:Ue(p,o,"solid"),isSelected:d,textWidth:l,textHeight:u,showTextOutline:this.options.showTextOutline,style:{transform:`scale(${a})`,transformOrigin:"top left"},wrap:!0,onKeyDown:f})}indicator(e){const n=this.editor.getShapeGeometry(e).bounds,s=z();return e.props.autoSize&&s.getEditingShapeId()===e.id?null:h.jsx("rect",{width:F(n.width),height:F(n.height)})}toSvg(e,n){const s=this.editor.getShapeGeometry(e).bounds,r=s.width/(e.props.scale??1),i=s.height/(e.props.scale??1),o=Fi(n),a=new X(0,0,r,i);return h.jsx(Hu,{fontSize:oa[e.props.size],font:e.props.font,align:e.props.textAlign,verticalAlign:"middle",richText:e.props.richText,labelColor:Ue(o,e.props.color,"solid"),bounds:a,padding:0,showTextOutline:this.options.showTextOutline})}onResize(e,n){const{newPoint:s,initialBounds:r,initialShape:i,scaleX:o,handle:a}=n;if(n.mode==="scale_shape"||a!=="right"&&a!=="left")return{id:e.id,type:e.type,...ET(e,n)};{const c=Math.max(1,Math.abs(r.width*o)),{x:l,y:u}=o<0?b.Sub(s,b.FromAngle(e.rotation).mul(c)):s;return{id:e.id,type:e.type,x:l,y:u,props:{w:c/i.props.scale,autoSize:!1}}}}onEditEnd(e){co(this.editor,e.props.richText).trimEnd().length===0&&this.editor.deleteShapes([e.id])}onBeforeUpdate(e,n){if(!n.props.autoSize)return;const s=e.props.size!==n.props.size||e.props.textAlign!==n.props.textAlign||e.props.font!==n.props.font||e.props.scale!==1&&n.props.scale===1,r=!xr(e.props.richText,n.props.richText);if(!s&&!r)return;const i=this.getMinDimensions(e),o=Y2(this.editor,n.props),a=i.width*e.props.scale,c=i.height*e.props.scale,l=o.width*n.props.scale,u=o.height*n.props.scale;let d;switch(n.props.textAlign){case"middle":{d=new b((l-a)/2,r?0:(u-c)/2);break}case"end":{d=new b(l-a,r?0:(u-c)/2);break}default:{if(r)break;d=new b(0,(u-c)/2);break}}if(d){d.rot(n.rotation);const{x:p,y:f}=n;return{...n,x:p-d.x,y:f-d.y,props:{...n.props,w:l}}}else return{...n,props:{...n.props,w:l}}}}function Y2(t,e){const{font:n,richText:s,size:r,w:i}=e,o=16,a=oa[r],c=e.autoSize?null:Math.max(o,Math.floor(i)),l=Dc(t,s),u=t.textMeasure.measureHtml(l,{...$n,fontFamily:ji[n],fontSize:a,maxWidth:c});return{width:c??Math.max(o,u.w+1),height:Math.max(a,u.h)}}function L7(t){const e=z();return v.useCallback(n=>{e.getEditingShapeId()===t&&n.key==="Enter"&&(n.ctrlKey||n.metaKey)&&e.complete()},[e,t])}const R7=new dn;class F7 extends xa{static type="video";static props=SP;static migrations=xP;options={autoplay:!0};canEdit(){return!0}isAspectRatioLocked(){return!0}getDefaultProps(){return{w:100,h:100,assetId:null,autoplay:this.options.autoplay,url:"",altText:"",time:0,playing:!0}}getAriaDescriptor(e){return e.props.altText}component(e){return h.jsx(B7,{shape:e})}indicator(e){return h.jsx("rect",{width:F(e.props.w),height:F(e.props.h)})}async toSvg(e,n){const s=e.props;if(!s.assetId)return null;const r=this.editor.getAsset(s.assetId);if(!r)return null;const i=await R7.get(r,async()=>{const o=await n.resolveAssetUrl(r.id,s.w);if(!o)return null;const a=await ms.loadVideo(o);return await ms.getVideoFrameAsDataUrl(a,0)});return i?h.jsx("image",{href:i,width:s.w,height:s.h,"aria-label":e.props.altText}):null}}const B7=v.memo(function({shape:e}){const n=z(),s=n.getShapeGeometry(e).bounds.w*n.getEfficientZoomLevel()>=110,r=nl(e.id),i=AT(),{Spinner:o}=nt(),{asset:a,url:c}=H2({shapeId:e.id,assetId:e.props.assetId,width:e.props.w}),l=v.useRef(null),[u,d]=v.useState(!1),p=v.useCallback(x=>{x.currentTarget&&d(!0)},[]),[f,g]=v.useState(!1);return v.useEffect(()=>{const x=()=>g(document.fullscreenElement===l.current);return document.addEventListener("fullscreenchange",x),()=>document.removeEventListener("fullscreenchange",x)}),v.useEffect(()=>{const x=l.current;x&&r&&document.activeElement!==x&&x.focus()},[r,u]),h.jsxs(h.Fragment,{children:[h.jsx(Ci,{id:e.id,style:{color:"var(--tl-color-text-3)",backgroundColor:a?"transparent":"var(--tl-color-low)",border:a?"none":"1px solid var(--tl-color-low-border)"},children:h.jsx("div",{className:"tl-counter-scaled",children:h.jsx("div",{className:"tl-video-container",children:a?o&&!a.props.src?h.jsx(o,{}):c?h.jsxs(h.Fragment,{children:[h.jsx("video",{ref:l,style:r?{pointerEvents:"all"}:u?void 0:{display:"none"},className:de("tl-video",`tl-video-shape-${e.id.split(":")[1]}`,{"tl-video-is-fullscreen":f}),width:"100%",height:"100%",draggable:!1,playsInline:!0,autoPlay:e.props.autoplay&&!i,muted:!0,loop:!0,disableRemotePlayback:!0,disablePictureInPicture:!0,controls:r&&s,onLoadedData:p,hidden:!u,"aria-label":e.props.altText,children:h.jsx("source",{src:c})},c),!u&&o&&h.jsx(o,{})]}):null:h.jsx(U2,{})})})}),"url"in e.props&&e.props.url&&h.jsx(ca,{url:e.props.url})]})}),V2=[O7,AU,LU,a7,T7,_7,ZU,_U,m7,Jo,w7,F7];function z7(t){return t.sideEffects.register({instance_page_state:{afterChange:(e,n)=>{if(e.croppingShapeId!==n.croppingShapeId){const s=t.isIn("select.crop");!e.croppingShapeId&&n.croppingShapeId?s||t.setCurrentTool("select.crop.idle"):e.croppingShapeId&&!n.croppingShapeId&&s&&t.setCurrentTool("select.idle")}if(e.editingShapeId!==n.editingShapeId)if(!e.editingShapeId&&n.editingShapeId){if(!t.isIn("select.editing_shape")){const s=t.getEditingShape();s&&s.type==="text"&&t.isInAny("text.pointing","select.resizing")&&t.getInstanceState().isToolLocked?t.setCurrentTool("select.editing_shape",{target:"shape",shape:s,isCreatingTextWhileToolLocked:!0}):t.setCurrentTool("select.editing_shape",{target:"shape",shape:s})}}else e.editingShapeId&&!n.editingShapeId&&t.isIn("select.editing_shape")&&t.setCurrentTool("select.idle")}}})}class $7 extends fe{static id="erasing";info={};scribbleId="id";markId="";excludedShapeIds=new Set;_isHoldingAccelKey=!1;_firstErasingShapeId=null;_erasingShapeIds=[];onEnter(e){this._isHoldingAccelKey=At(this.editor.inputs),this._firstErasingShapeId=this.editor.getErasingShapeIds()[0],this._erasingShapeIds=this.editor.getErasingShapeIds(),this.markId=this.editor.markHistoryStoppingPoint("erase scribble begin"),this.info=e;const n=this.editor.inputs.getOriginPagePoint();this.excludedShapeIds=new Set(this.editor.getCurrentPageShapes().filter(r=>{if(this.editor.isShapeOrAncestorLocked(r))return!0;if(this.editor.isShapeOfType(r,"group")||this.editor.isShapeOfType(r,"frame")){const i=this.editor.getPointInShapeSpace(r,n);return this.editor.getShapeGeometry(r).bounds.containsPoint(i)}return!1}).map(r=>r.id));const s=this.editor.scribbles.addScribble({color:"muted-1",size:12});this.scribbleId=s.id,this.update()}pushPointToScribble(){const{x:e,y:n}=this.editor.inputs.getCurrentPagePoint();this.editor.scribbles.addPoint(this.scribbleId,e,n)}onExit(){this.editor.setErasingShapes([]),this.editor.scribbles.stop(this.scribbleId)}onPointerMove(){this.update()}onPointerUp(){this.complete()}onCancel(){this.cancel()}onComplete(){this.complete()}onKeyUp(){this._isHoldingAccelKey=At(this.editor.inputs),this.update()}onKeyDown(){this._isHoldingAccelKey=At(this.editor.inputs),this.update()}update(){const{editor:e,excludedShapeIds:n}=this,s=e.getErasingShapeIds(),r=e.getZoomLevel(),i=e.getCurrentPageRenderingShapesSorted(),o=e.inputs.getCurrentPagePoint(),a=e.inputs.getPreviousPagePoint();this.pushPointToScribble();const c=new Set(s),l=this.editor.options.hitTestMargin/r;for(const u of i){if(e.isShapeOfType(u,"group"))continue;const d=e.getShapeMask(u.id);if(d&&!Bn(o,d))continue;const p=e.getShapeGeometry(u),f=e.getShapePageTransform(u);if(!p||!f)continue;const g=f.clone().invert(),x=g.applyToPoint(a),y=g.applyToPoint(o),{bounds:m}=p;m.minX-l>Math.max(x.x,y.x)||m.minY-l>Math.max(x.y,y.y)||m.maxX+l<Math.min(x.x,y.x)||m.maxY+l<Math.min(x.y,y.y)||(p.hitTestLineSegment(x,y,l)&&c.add(e.getOutermostSelectableShape(u).id),this._erasingShapeIds=[...c])}if(this._isHoldingAccelKey&&this._firstErasingShapeId){const u=this._firstErasingShapeId;u&&this.editor.getShape(u)&&e.setErasingShapes([u]);return}this.editor.setErasingShapes(this._erasingShapeIds.filter(u=>!n.has(u)))}complete(){const{editor:e}=this;e.deleteShapes(e.getCurrentPageState().erasingShapeIds),this.parent.transition("idle"),this._erasingShapeIds=[],this._firstErasingShapeId=null}cancel(){const{editor:e}=this;e.bailToMark(this.markId),this.parent.transition("idle",this.info)}}let N7=class extends fe{static id="idle";onPointerDown(e){this.parent.transition("pointing",e)}onCancel(){this.editor.setCurrentTool("select")}},U7=class extends fe{static id="pointing";_isHoldingAccelKey=!1;onEnter(){this._isHoldingAccelKey=At(this.editor.inputs);const e=this.editor.getZoomLevel(),n=this.editor.getCurrentPageRenderingShapesSorted(),s=this.editor.inputs.getCurrentPagePoint(),r=new Set,i=r.size;for(let o=n.length,a=o-1;a>=0;a--){const c=n[a];if(!(this.editor.isShapeOrAncestorLocked(c)||this.editor.isShapeOfType(c,"group"))&&this.editor.isPointInShape(c,s,{hitInside:!1,margin:this.editor.options.hitTestMargin/e})){const l=this.editor.getOutermostSelectableShape(c);if(this.editor.isShapeOfType(l,"frame")&&r.size>i||(r.add(l.id),this._isHoldingAccelKey))break}}this.editor.setErasingShapes([...r])}onKeyUp(){this._isHoldingAccelKey=At(this.editor.inputs)}onKeyDown(){this._isHoldingAccelKey=At(this.editor.inputs)}onLongPress(e){this.startErasing(e)}onExit(e,n){n!=="erasing"&&this.editor.setErasingShapes([])}onPointerMove(e){this._isHoldingAccelKey||this.editor.inputs.getIsDragging()&&this.startErasing(e)}onPointerUp(){this.complete()}onCancel(){this.cancel()}onComplete(){this.complete()}onInterrupt(){this.cancel()}startErasing(e){this.parent.transition("erasing",e)}complete(){const e=this.editor.getErasingShapeIds();e.length&&(this.editor.markHistoryStoppingPoint("erase end"),this.editor.deleteShapes(e)),this.parent.transition("idle")}cancel(){this.parent.transition("idle")}};class H7 extends fe{static id="eraser";static initial="idle";static isLockable=!1;static children(){return[N7,U7,$7]}onEnter(){this.editor.setCursor({type:"cross",rotation:0})}}class K7 extends fe{static id="dragging";initialCamera=new b;onEnter(){this.initialCamera=b.From(this.editor.getCamera()),this.update()}onPointerMove(){this.update()}onPointerUp(){this.complete()}onCancel(){this.parent.transition("idle")}onComplete(){this.complete()}update(){const{initialCamera:e,editor:n}=this,s=n.inputs.getCurrentScreenPoint(),r=n.inputs.getOriginScreenPoint(),i=b.Sub(s,r).div(n.getZoomLevel());i.len2()!==0&&n.setCamera(e.clone().add(i))}complete(){const{editor:e}=this,n=e.inputs.getPointerVelocity(),s=Math.min(n.len(),2);s>.1&&this.editor.slideCamera({speed:s,direction:n}),this.parent.transition("idle")}}let W7=class extends fe{static id="idle";onEnter(){this.editor.setCursor({type:"grab",rotation:0})}onPointerDown(e){this.parent.transition("pointing",e)}onCancel(){this.editor.setCurrentTool("select")}},q7=class extends fe{static id="pointing";onEnter(){this.editor.stopCameraAnimation(),this.editor.setCursor({type:"grabbing",rotation:0})}onLongPress(){this.startDragging()}onPointerMove(){this.editor.inputs.getIsDragging()&&this.startDragging()}startDragging(){this.parent.transition("dragging")}onPointerUp(){this.complete()}onCancel(){this.complete()}onComplete(){this.complete()}onInterrupt(){this.complete()}complete(){this.parent.transition("idle")}};class G7 extends fe{static id="hand";static initial="idle";static isLockable=!1;static children(){return[W7,q7,K7]}onDoubleClick(e){if(e.phase==="settle"){const n=this.editor.inputs.getCurrentScreenPoint();this.editor.zoomIn(n,{animation:{duration:220,easing:Pn.easeOutQuint}})}}onTripleClick(e){if(e.phase==="settle"){const n=this.editor.inputs.getCurrentScreenPoint();this.editor.zoomOut(n,{animation:{duration:320,easing:Pn.easeOutQuint}})}}onQuadrupleClick(e){if(e.phase==="settle"){const n=this.editor.getZoomLevel(),s=this.editor.inputs.getCurrentScreenPoint();n===1?this.editor.zoomToFit({animation:{duration:400,easing:Pn.easeOutQuint}}):this.editor.resetZoom(s,{animation:{duration:320,easing:Pn.easeOutQuint}})}}}let Y7=class extends fe{static id="idle";onCancel(){this.editor.setCurrentTool("select")}onPointerDown(e){this.parent.transition("lasering",e)}};class V7 extends fe{static id="lasering";scribbleId="id";onEnter(){const e=this.editor.scribbles.addScribble({color:"laser",opacity:.7,size:4,delay:this.editor.options.laserDelayMs,shrink:.05,taper:!0});this.scribbleId=e.id,this.pushPointToScribble()}onExit(){this.editor.scribbles.stop(this.scribbleId)}onPointerMove(){this.pushPointToScribble()}onPointerUp(){this.complete()}pushPointToScribble(){const{x:e,y:n}=this.editor.inputs.getCurrentPagePoint();this.editor.scribbles.addPoint(this.scribbleId,e,n)}onCancel(){this.cancel()}onComplete(){this.complete()}complete(){this.parent.transition("idle")}cancel(){this.parent.transition("idle")}}class X7 extends fe{static id="laser";static initial="idle";static children(){return[Y7,V7]}static isLockable=!1;onEnter(){this.editor.setCursor({type:"cross",rotation:0})}}class Z7 extends fe{static id="brushing";info={};initialSelectedShapeIds=[];excludedShapeIds=new Set;isWrapMode=!1;viewportDidChange=!1;cleanupViewportChangeReactor(){}onEnter(e){const{editor:n}=this,s=n.inputs.getAltKey();this.isWrapMode=n.user.getIsWrapMode(),this.viewportDidChange=!1;let r=!0;if(this.cleanupViewportChangeReactor=is("viewport change while brushing",()=>{n.getViewportPageBounds(),!r&&!this.viewportDidChange&&(this.viewportDidChange=!0)}),s){this.parent.transition("scribble_brushing",e);return}this.excludedShapeIds=new Set(n.getCurrentPageShapes().filter(i=>n.isShapeOfType(i,"group")||n.isShapeOrAncestorLocked(i)).map(i=>i.id)),this.info=e,this.initialSelectedShapeIds=n.getSelectedShapeIds().slice(),this.hitTestShapes(),r=!1}onExit(){this.initialSelectedShapeIds=[],this.editor.updateInstanceState({brush:null}),this.cleanupViewportChangeReactor()}onTick({elapsed:e}){const{editor:n}=this;n.edgeScrollManager.updateEdgeScrolling(e)}onPointerMove(){this.hitTestShapes()}onPointerUp(){this.complete()}onComplete(){this.complete()}onCancel(e){this.editor.setSelectedShapes(this.initialSelectedShapeIds),this.parent.transition("idle",e)}onKeyDown(e){this.editor.inputs.getAltKey()?this.parent.transition("scribble_brushing",e):this.hitTestShapes()}onKeyUp(){this.hitTestShapes()}complete(){this.hitTestShapes(),this.parent.transition("idle")}hitTestShapes(){const{editor:e,excludedShapeIds:n,isWrapMode:s}=this,r=e.inputs.getOriginPagePoint(),i=e.inputs.getCurrentPagePoint(),o=e.inputs.getShiftKey(),a=e.inputs.getCtrlKey(),c=new Set(o?this.initialSelectedShapeIds:[]),l=s?!a:a,u=X.FromPoints([r,i]),{corners:d}=u;let p,f,g,x,y,m;const w=e.getViewportPageBounds().contains(u)&&!this.viewportDidChange?e.getCurrentPageRenderingShapesSorted():e.getCurrentPageShapesSorted(),P=e.getCurrentPageId();e:for(let C=0,E=w.length;C<E;C++){if(g=w[C],n.has(g.id)||c.has(g.id)||(x=e.getShapePageBounds(g),!x))continue e;if(u.contains(x)){this.handleHit(g,i,P,c,d);continue e}if(l||e.isShapeOfType(g,"frame"))continue e;if(u.collides(x)){if(y=e.getShapePageTransform(g),!y)continue e;m=y.clone().invert().applyToPoints(d);const O=e.getShapeGeometry(g);t:for(let k=0;k<4;k++)if(p=m[k],f=m[(k+1)%4],O.hitTestLineSegment(p,f,0)){this.handleHit(g,i,P,c,d);break t}}}const _=e.getInstanceState().brush;(!_||!u.equals(_))&&e.updateInstanceState({brush:{...u.toJson()}});const I=e.getSelectedShapeIds();(I.length!==c.size||I.some(C=>!c.has(C)))&&e.setSelectedShapes(Array.from(c))}onInterrupt(){this.editor.updateInstanceState({brush:null})}handleHit(e,n,s,r,i){if(e.parentId===s){r.add(e.id);return}const o=this.editor.getOutermostSelectableShape(e),a=this.editor.getShapeMask(o.id);a&&!YP(a,i)&&!Bn(n,a)||r.add(o.id)}}const la={bottom:"ns-resize",top:"ns-resize",left:"ew-resize",right:"ew-resize",bottom_left:"nesw-resize",bottom_right:"nwse-resize",top_left:"nwse-resize",top_right:"nesw-resize",bottom_left_rotate:"swne-rotate",bottom_right_rotate:"senw-rotate",top_left_rotate:"nwse-rotate",top_right_rotate:"nesw-rotate",mobile_rotate:"grabbing"};class J7 extends fe{static id="pointing_resize_handle";info={};updateCursor(){const e=this.editor.getSelectedShapes(),n=la[this.info.handle];this.editor.setCursor({type:n,rotation:e.length===1?this.editor.getSelectionRotation():0})}onEnter(e){this.info=e,typeof e.onInteractionEnd=="string"&&this.parent.setCurrentToolIdMask(e.onInteractionEnd),this.updateCursor()}onExit(){this.parent.setCurrentToolIdMask(void 0)}onPointerMove(){this.editor.inputs.getIsDragging()&&this.startResizing()}onLongPress(){this.startResizing()}startResizing(){this.editor.getIsReadonly()||this.parent.transition("resizing",this.info)}onPointerUp(){this.complete()}onCancel(){this.cancel()}onComplete(){this.cancel()}onInterrupt(){this.cancel()}complete(){const{onInteractionEnd:e}=this.info;if(e){typeof e=="string"?this.editor.setCurrentTool(e,{}):e();return}this.parent.transition("idle")}cancel(){const{onInteractionEnd:e}=this.info;if(e){typeof e=="string"?this.editor.setCurrentTool(e,{}):e();return}this.parent.transition("idle")}}class X2 extends fe{static id="cropping";info={};markId="";snapshot={};onEnter(e){this.info=e,typeof e.onInteractionEnd=="string"&&this.parent.setCurrentToolIdMask(e.onInteractionEnd),this.markId=this.editor.markHistoryStoppingPoint("cropping"),this.snapshot=this.createSnapshot(),this.updateShapes()}onPointerMove(){this.updateShapes()}onKeyDown(){this.updateShapes()}onKeyUp(){this.updateShapes()}onPointerUp(){this.complete()}onComplete(){this.complete()}onCancel(){this.cancel()}onExit(){this.parent.setCurrentToolIdMask(void 0)}updateCursor(){if(!this.editor.getSelectedShapes()[0])return;const n=la[this.info.handle];this.editor.setCursor({type:n,rotation:this.editor.getSelectionRotation()})}updateShapes(){const{shape:e,cursorHandleOffset:n}=this.snapshot;if(!e)return;const s=this.editor.getShapeUtil(e.type);if(!s)return;const r=this.editor.inputs.getShiftKey(),i=this.editor.inputs.getCurrentPagePoint().clone().sub(n),o=this.editor.inputs.getOriginPagePoint().clone().sub(n),a=i.clone().sub(o).rot(-e.rotation),c=e.props.crop??er(),l=ir(e.props,c),d=(s.onCrop?.bind(s)??j$)(e,{handle:this.info.handle,change:a,crop:c,uncroppedSize:l,initialShape:this.snapshot.shape,aspectRatioLocked:r});d&&(this.editor.updateShapes([{id:e.id,type:e.type,...d}]),this.updateCursor())}complete(){this.updateShapes(),Qe(this.editor,[this.snapshot.shape.id]);const{onInteractionEnd:e}=this.info;e?typeof e=="string"?this.editor.setCurrentTool(e,this.info):e():(this.editor.setCroppingShape(null),this.editor.setCurrentTool("select.idle"))}cancel(){this.editor.bailToMark(this.markId);const{onInteractionEnd:e}=this.info;e?typeof e=="string"?this.editor.setCurrentTool(e,this.info):e():(this.editor.setCroppingShape(null),this.editor.setCurrentTool("select.idle"))}createSnapshot(){const e=this.editor.getSelectionRotation(),n=this.editor.inputs.getOriginPagePoint(),s=this.editor.getOnlySelectedShape(),r=this.editor.getSelectionRotatedPageBounds(),i=b.RotWith(r.getHandlePoint(this.info.handle),r.point,e),o=b.Sub(n,i);return{shape:s,cursorHandleOffset:o}}}function Qy(t,e=!1){const n=t.getZoomLevel(),s=t.inputs.getCurrentPagePoint();return t.getShapeAtPoint(s,{hitInside:!1,hitLabels:e,margin:t.options.hitTestMargin/n,renderingOnly:!0})??t.getSelectedShapeAtPoint(s)}function Z2(t,e,n){if(!e)throw Error("Needs to translate a cropped shape!");const{crop:s}=e.props;if(!s)return;const r=t.inputs.getShiftKey()?Math.abs(n.x)<Math.abs(n.y)?"x":"y":null;r==="x"?n.x=0:r==="y"&&(n.y=0),n.rot(-e.rotation);const{w:i,h:o}=ir(e.props,s),a=s.bottomRight.x-s.topLeft.x,c=s.bottomRight.y-s.topLeft.y,l=wt(s),u=1-a,d=1-c;return l.topLeft.x=Ce(l.topLeft.x-n.x/i,0,u),l.topLeft.y=Ce(l.topLeft.y-n.y/o,0,d),l.bottomRight.x=l.topLeft.x+a,l.bottomRight.y=l.topLeft.y+c,{id:e.id,type:e.type,props:{crop:l}}}let Q7=class extends fe{static id="idle";onEnter(){this.editor.setCursor({type:"default",rotation:0});const e=this.editor.getOnlySelectedShape();e&&this.editor.setCroppingShape(e.id)}onExit(){this.editor.setCursor({type:"default",rotation:0})}onCancel(){this.editor.setCroppingShape(null),this.editor.setCurrentTool("select.idle",{})}onPointerDown(e){if(e.accelKey){this.cancel(),this.editor.root.handleEvent(e);return}switch(e.target){case"canvas":{const n=Qy(this.editor);if(n&&!this.editor.isShapeOfType(n,"group")){this.onPointerDown({...e,shape:n,target:"shape"});return}this.cancel(),this.editor.root.handleEvent(e);break}case"shape":{if(e.shape.id===this.editor.getCroppingShapeId()){this.editor.setCurrentTool("select.crop.pointing_crop",e);return}else this.editor.getShapeUtil(e.shape)?.canCrop(e.shape)?(this.editor.setCroppingShape(e.shape.id),this.editor.setSelectedShapes([e.shape.id]),this.editor.setCurrentTool("select.crop.pointing_crop",e)):(this.cancel(),this.editor.root.handleEvent(e));break}case"selection":{switch(e.handle){case"mobile_rotate":case"top_left_rotate":case"top_right_rotate":case"bottom_left_rotate":case"bottom_right_rotate":{this.editor.setCurrentTool("select.pointing_rotate_handle",{...e,onInteractionEnd:"select.crop.idle"});break}case"top":case"right":case"bottom":case"left":case"top_left":case"top_right":case"bottom_left":case"bottom_right":{this.editor.setCurrentTool("select.crop.pointing_crop_handle",{...e,onInteractionEnd:"select.crop.idle"});break}default:this.cancel()}break}}}onDoubleClick(e){if(this.editor.inputs.getShiftKey()||e.phase!=="up")return;const n=this.editor.getCroppingShapeId();if(!n)return;const s=this.editor.getShape(n);if(!s)return;const r=this.editor.getShapeUtil(s);if(r){if(e.target==="selection"){r.onDoubleClickEdge?.(s,e);return}this.cancel(),this.editor.root.handleEvent(e)}}onKeyDown(){this.nudgeCroppingImage(!1)}onKeyRepeat(){this.nudgeCroppingImage(!0)}onKeyUp(e){e.key==="Enter"&&(this.editor.setCroppingShape(null),this.editor.setCurrentTool("select.idle",{}))}cancel(){this.editor.setCroppingShape(null),this.editor.setCurrentTool("select.idle",{})}nudgeCroppingImage(e=!1){const{editor:{inputs:{keys:n}}}=this,s=n.has("ShiftLeft"),r=new b(0,0);if(n.has("ArrowLeft")&&(r.x+=1),n.has("ArrowRight")&&(r.x-=1),n.has("ArrowUp")&&(r.y+=1),n.has("ArrowDown")&&(r.y-=1),r.equals(new b(0,0)))return;s&&r.mul(10);const i=this.editor.getShape(this.editor.getCroppingShapeId());if(!i)return;const o=Z2(this.editor,i,r);o&&(e||this.editor.markHistoryStoppingPoint("translate crop"),this.editor.updateShapes([o]))}};class eH extends fe{static id="pointing_crop";onCancel(){this.editor.setCurrentTool("select.crop.idle",{})}onPointerMove(e){this.editor.inputs.getIsDragging()&&this.startDragging(e)}onLongPress(e){this.startDragging(e)}onPointerUp(e){this.editor.setCurrentTool("select.crop.idle",e)}startDragging(e){this.editor.setCurrentTool("select.crop.translating_crop",e)}}class J2 extends fe{static id="pointing_crop_handle";info={};onEnter(e){this.info=e,typeof e.onInteractionEnd=="string"&&this.parent.setCurrentToolIdMask(e.onInteractionEnd);const n=this.editor.getSelectedShapes()[0];if(!n)return;const s=la[this.info.handle];this.editor.setCursor({type:s,rotation:this.editor.getSelectionRotation()}),this.editor.setCroppingShape(n.id)}onExit(){this.editor.setCursor({type:"default",rotation:0}),this.parent.setCurrentToolIdMask(void 0)}onPointerMove(){this.editor.inputs.getIsDragging()&&this.startCropping()}onLongPress(){this.startCropping()}startCropping(){this.editor.getIsReadonly()||this.parent.transition("cropping",{...this.info,onInteractionEnd:this.info.onInteractionEnd})}onPointerUp(){const{onInteractionEnd:e}=this.info;if(e){typeof e=="string"?this.editor.setCurrentTool(e,this.info):e();return}this.editor.setCroppingShape(null),this.editor.setCurrentTool("select.idle")}onCancel(){this.cancel()}onComplete(){this.cancel()}onInterrupt(){this.cancel()}cancel(){const{onInteractionEnd:e}=this.info;if(e){typeof e=="string"?this.editor.setCurrentTool(e,this.info):e();return}this.editor.setCroppingShape(null),this.editor.setCurrentTool("select.idle")}}class tH extends fe{static id="translating_crop";info={};markId="";snapshot={};onEnter(e){this.info=e,this.snapshot=this.createSnapshot(),this.markId=this.editor.markHistoryStoppingPoint("translating_crop"),this.editor.setCursor({type:"move",rotation:0}),this.updateShapes()}onExit(){this.editor.setCursor({type:"default",rotation:0})}onPointerMove(){this.updateShapes()}onPointerUp(){this.complete()}onComplete(){this.complete()}onCancel(){this.cancel()}onKeyDown(e){switch(e.key){case"Alt":case"Shift":{this.updateShapes();return}}}onKeyUp(e){switch(e.key){case"Enter":{this.complete();return}case"Alt":case"Shift":this.updateShapes()}}complete(){this.updateShapes(),this.editor.setCurrentTool("select.crop.idle",this.info)}cancel(){this.editor.bailToMark(this.markId),this.editor.setCurrentTool("select.crop.idle",this.info)}createSnapshot(){return{shape:this.editor.getOnlySelectedShape()}}updateShapes(){const e=this.snapshot.shape;if(!e)return;const n=this.editor.inputs.getOriginPagePoint(),r=this.editor.inputs.getCurrentPagePoint().clone().sub(n),i=Z2(this.editor,e,r);i&&this.editor.updateShapes([i])}}class nH extends fe{static id="crop";static initial="idle";static children(){return[Q7,tH,eH,J2,X2]}markId="";onEnter(){this.didExit=!1,this.markId=this.editor.markHistoryStoppingPoint("crop")}didExit=!1;onExit(){this.didExit||(this.didExit=!0,this.editor.squashToMark(this.markId))}onCancel(){this.didExit||(this.didExit=!0,this.editor.bailToMark(this.markId))}}class sH extends fe{static id="dragging_handle";shapeId;initialHandle;initialAdjacentHandle;initialPagePoint;markId;initialPageTransform;initialPageRotation;info;isPrecise=!1;isPreciseId=null;pointingId=null;onEnter(e){const{shape:n,isCreating:s,creatingMarkId:r,handle:i}=e;if(this.info=e,typeof e.onInteractionEnd=="string"&&this.parent.setCurrentToolIdMask(e.onInteractionEnd),this.shapeId=n.id,this.markId="",s)if(r)this.markId=r;else{const d=this.editor.getMarkIdMatching(`creating:${this.editor.getOnlySelectedShapeId()}`);d&&(this.markId=d)}else this.markId=this.editor.markHistoryStoppingPoint("dragging handle");this.initialHandle=wt(i),this.initialPageTransform=this.editor.getShapePageTransform(n),this.initialPageRotation=this.initialPageTransform.rotation(),this.initialPagePoint=this.editor.inputs.getOriginPagePoint().clone(),this.editor.setCursor({type:s?"cross":"grabbing",rotation:0});const o=this.editor.getShapeHandles(n).sort(Yt),a=o.findIndex(d=>d.id===e.handle.id);if(this.initialAdjacentHandle=null,e.handle.snapReferenceHandleId){const d=o.find(p=>p.id===e.handle.snapReferenceHandleId);d&&(this.initialAdjacentHandle=d)}if(!this.initialAdjacentHandle){for(let d=a+1;d<o.length;d++){const p=o[d];if(p.type==="vertex"&&p.id!=="middle"&&p.id!==e.handle.id){this.initialAdjacentHandle=p;break}}if(!this.initialAdjacentHandle)for(let d=o.length-1;d>=0;d--){const p=o[d];if(p.type==="vertex"&&p.id!=="middle"&&p.id!==e.handle.id){this.initialAdjacentHandle=p;break}}}if(this.editor.isShapeOfType(n,"arrow")){const d=Vt(this.editor,n)[e.handle.id];this.isPrecise=!1,d&&(this.isPrecise=d.props.isPrecise,this.isPrecise?this.isPreciseId=d.toId:this.resetExactTimeout())}const c={handle:this.initialHandle,isPrecise:this.isPrecise,isCreatingShape:!!this.info.isCreating,initial:n},u=this.editor.getShapeUtil(n).onHandleDragStart?.(n,c);u&&this.editor.updateShapes([{...u,id:n.id,type:n.type}]),this.update(),this.editor.select(this.shapeId)}exactTimeout=-1;resetExactTimeout(){const n=this.editor.getShapeUtil("arrow").options.pointingPreciseTimeout;this.exactTimeout!==-1&&this.clearExactTimeout(),this.exactTimeout=this.editor.timers.setTimeout(()=>{this.getIsActive()&&!this.isPrecise&&(this.isPrecise=!0,this.isPreciseId=this.pointingId,this.update()),this.exactTimeout=-1},n)}clearExactTimeout(){this.exactTimeout!==-1&&(clearTimeout(this.exactTimeout),this.exactTimeout=-1)}onPointerMove(){this.update()}onKeyDown(){this.update()}onKeyUp(){this.update()}onPointerUp(){this.complete()}onComplete(){this.update(),this.complete()}onCancel(){this.cancel()}onExit(){this.parent.setCurrentToolIdMask(void 0),Ky(this.editor),this.editor.snaps.clearIndicators(),this.editor.setCursor({type:"default",rotation:0})}complete(){this.editor.snaps.clearIndicators(),Qe(this.editor,[this.shapeId]);const e=this.editor.getShape(this.shapeId);if(e){const s=this.editor.getShapeUtil(e),r={handle:this.initialHandle,isPrecise:this.isPrecise,isCreatingShape:!!this.info.isCreating,initial:this.info.shape},i=s.onHandleDragEnd?.(e,r);i&&this.editor.updateShapes([{...i,id:e.id}])}const{onInteractionEnd:n}=this.info;if(n)if(typeof n=="string"){if(this.editor.getInstanceState().isToolLocked&&n){this.editor.setCurrentTool(n,{shapeId:this.shapeId});return}}else{n?.();return}this.parent.transition("idle")}cancel(){const e=this.editor.getShape(this.shapeId);if(e){const s=this.editor.getShapeUtil(e),r={handle:this.initialHandle,isPrecise:this.isPrecise,isCreatingShape:!!this.info.isCreating,initial:this.info.shape};s.onHandleDragCancel?.(e,r)}this.editor.bailToMark(this.markId),this.editor.snaps.clearIndicators();const{onInteractionEnd:n}=this.info;if(n){typeof n=="string"?this.editor.setCurrentTool(n,{shapeId:this.shapeId}):n?.();return}this.parent.transition("idle")}update(){const{editor:e,shapeId:n,initialPagePoint:s}=this,{initialHandle:r,initialPageRotation:i,initialAdjacentHandle:o}=this,a=this.editor.user.getIsSnapMode(),{snaps:c}=e,l=e.inputs.getCurrentPagePoint(),u=e.inputs.getShiftKey(),d=e.inputs.getCtrlKey(),p=e.inputs.getAltKey(),f=e.inputs.getPointerVelocity(),g=this.info.shape,x=e.getShape(n);if(!x)return;const y=e.getShapeUtil(x),m=e.isShapeOfType(x,"arrow")?Vt(e,x)[r.id]:void 0;let S=l.clone().sub(s).rot(-i).add(r);if(u&&o&&r.id!=="middle"){const C=b.Angle(o,S),O=Ad(C,24)-C;S=b.RotWith(S,o,O)}e.snaps.clearIndicators();let w={...r,x:S.x,y:S.y},P=!1;if(r.canSnap&&r.snapType?eM("canSnap is deprecated. Cannot use both canSnap and snapType together - snapping disabled. Please use only snapType."):P=r.canSnap||r.snapType!==void 0,P&&(a?!d:d)){if(!e.getShapePageTransform(x.id))throw Error("Expected a page transform");const E=c.handles.snapHandle({currentShapeId:n,handle:w});E&&(E.nudge.rot(-e.getShapeParentTransform(x).rotation()),S.add(E.nudge),w={...r,x:S.x,y:S.y})}const _=y.onHandleDrag?.(x,{handle:w,isPrecise:this.isPrecise||p,isCreatingShape:!!this.info.isCreating,initial:g}),I={id:x.id,type:x.type,..._};if(r.type==="vertex"&&this.editor.isShapeOfType(x,"arrow")){const C=Vt(e,x)[r.id];C?m?.toId!==C.toId&&(this.pointingId=C.toId,this.isPrecise=f.len()<.5||p,this.isPreciseId=this.isPrecise?C.toId:null,this.resetExactTimeout()):m&&(this.pointingId=null,this.isPrecise=!1,this.isPreciseId=null,this.resetExactTimeout())}_&&e.updateShapes([I])}}function Q2(t){return t.isLabel?[t]:t instanceof os?t.children.filter(e=>e.isLabel):[]}class rH extends fe{static id="editing_shape";hitLabelOnShapeForPointerUp=null;info={};didPointerDownOnEditingShape=!1;isTextInputFocused(){return this.editor.getContainer().contains(document.activeElement)&&(document.activeElement?.nodeName==="INPUT"||document.activeElement?.nodeName==="TEXTAREA"||document.activeElement?.isContentEditable)}onEnter(e){const n=this.editor.getEditingShape();if(!n)throw Error("Entered editing state without an editing shape");this.hitLabelOnShapeForPointerUp=null,this.didPointerDownOnEditingShape=!1,this.info=e,e.isCreatingTextWhileToolLocked&&this.parent.setCurrentToolIdMask("text"),Zr(this.editor),this.editor.select(n)}onExit(){const{editingShapeId:e}=this.editor.getCurrentPageState();e&&(this.editor.setEditingShape(null),Zr.cancel(),this.info.isCreatingTextWhileToolLocked&&(this.parent.setCurrentToolIdMask(void 0),this.editor.setCurrentTool("text",{})))}onPointerMove(e){if(this.hitLabelOnShapeForPointerUp&&this.editor.inputs.getIsDragging()){if(this.editor.getIsReadonly()||this.hitLabelOnShapeForPointerUp.isLocked)return;this.editor.select(this.hitLabelOnShapeForPointerUp),this.parent.transition("translating",e),this.hitLabelOnShapeForPointerUp=null;return}if(this.didPointerDownOnEditingShape&&this.editor.inputs.isDragging){if(this.editor.getIsReadonly())return;const n=this.editor.getEditingShape();if(!n||n.isLocked)return;if(!this.isTextInputFocused()){this.editor.select(n),this.parent.transition("translating",e),this.didPointerDownOnEditingShape=!1;return}this.didPointerDownOnEditingShape=!1}switch(e.target){case"shape":case"canvas":{Zr(this.editor);return}}}onPointerDown(e){switch(this.hitLabelOnShapeForPointerUp=null,this.didPointerDownOnEditingShape=!1,e.target){case"canvas":{const n=Qy(this.editor,!0);if(n){this.onPointerDown({...e,shape:n,target:"shape"});return}break}case"shape":{const{shape:n}=e,s=this.editor.getEditingShape();if(!s)throw Error("Expected an editing shape!");const r=this.editor.getShapeUtil(n).getGeometry(n),i=Q2(r),o=i.length===1?i[0]:void 0,a=this.editor.isShapeOfType(s,"text")&&co(this.editor,s.props.richText).trim()==="";if(o&&!a){const c=this.editor.getPointInShapeSpace(n,this.editor.inputs.getCurrentPagePoint());if(o.bounds.containsPoint(c,0)&&o.hitTestPoint(c))if(n.id===s.id){this.didPointerDownOnEditingShape=!0;return}else{this.hitLabelOnShapeForPointerUp=n,this.editor.markHistoryStoppingPoint("editing on pointer up"),this.editor.select(n.id);return}}else{if(n.id===s.id)this.editor.isShapeOfType(n,"frame")&&(this.editor.setEditingShape(null),this.parent.transition("idle",e));else{this.parent.transition("pointing_shape",e);return}return}break}}this.parent.transition("idle",e),this.editor.root.handleEvent(e)}onPointerUp(e){if(this.didPointerDownOnEditingShape&&(this.didPointerDownOnEditingShape=!1,!this.isTextInputFocused())){this.editor.getRichTextEditor()?.commands.focus("all");return}const n=this.hitLabelOnShapeForPointerUp;if(!n)return;this.hitLabelOnShapeForPointerUp=null;const s=this.editor.getShapeUtil(n);if(n.isLocked)return;if(this.editor.getIsReadonly()&&!s.canEditInReadonly(n)){this.parent.transition("pointing_shape",e);return}this.editor.select(n.id);const r=this.editor.getEditingShape(),i=r&&r.id!==n.id;this.editor.setEditingShape(n.id);const o=qe.isIos||qe.isAndroid;!o||!i?this.editor.emit("place-caret",{shapeId:n.id,point:e.point}):o&&i&&this.editor.emit("select-all-text",{shapeId:n.id}),Zr(this.editor)}onComplete(e){this.editor.getContainer().focus(),this.parent.transition("idle",e)}onCancel(e){this.editor.getContainer().focus(),this.parent.transition("idle",e)}}function Wd(t,e){const n=t.getSelectedShapeIds(),s=t.inputs.getCurrentPagePoint(),{shiftKey:r,altKey:i,accelKey:o}=e,a=r||o,c=t.getShapeAtPoint(s,{hitInside:!1,margin:t.options.hitTestMargin/t.getZoomLevel(),hitLabels:!0,renderingOnly:!0,filter:l=>!l.isLocked});if(c){const l=t.getOutermostSelectableShape(c);if(a&&!i)t.cancelDoubleClick(),n.includes(l.id)?(t.markHistoryStoppingPoint("deselecting shape"),t.deselect(l)):(t.markHistoryStoppingPoint("shift selecting shape"),t.setSelectedShapes([...n,l.id]));else{let u;l===c||l.id===t.getFocusedGroupId()||n.includes(l.id)?u=c:u=l,u&&!n.includes(u.id)&&(t.markHistoryStoppingPoint("selecting shape"),t.select(u.id))}}else{if(a)return;{n.length>0&&(t.markHistoryStoppingPoint("selecting none"),t.selectNone());const l=t.getFocusedGroupId();if(On(l)){const u=t.getShape(l);t.isPointInShape(u,s,{margin:0,hitInside:!0})||t.setFocusedGroup(null)}}}}const iH=["Delete","Backspace","[","]","Enter"," ","Shift","Tab"];let oH=class extends fe{static id="idle";selectedShapesOnKeyDown=[];onEnter(){this.parent.setCurrentToolIdMask(void 0),Zr(this.editor),this.selectedShapesOnKeyDown=[],this.editor.setCursor({type:"default",rotation:0})}onExit(){Zr.cancel()}onPointerMove(){Zr(this.editor)}onPointerDown(e){switch(e.target){case"canvas":{const n=Qy(this.editor);if(n&&!n.isLocked){this.onPointerDown({...e,shape:n,target:"shape"});return}const s=this.editor.getSelectedShapeIds(),r=this.editor.getOnlySelectedShape(),i=this.editor.inputs.getCurrentPagePoint();if((s.length>1||r&&!this.editor.getShapeUtil(r).hideSelectionBoundsBg(r))&&s0(this.editor,i)){this.onPointerDown({...e,target:"selection"});return}this.parent.transition("pointing_canvas",e);break}case"shape":{const{shape:n}=e;if(this.editor.isShapeOrAncestorLocked(n)){this.parent.transition("pointing_canvas",e);break}this.parent.transition("pointing_shape",e);break}case"handle":{if(this.editor.getIsReadonly())break;this.editor.inputs.getAltKey()?this.parent.transition("pointing_shape",e):this.parent.transition("pointing_handle",e);break}case"selection":{switch(e.handle){case"mobile_rotate":case"top_left_rotate":case"top_right_rotate":case"bottom_left_rotate":case"bottom_right_rotate":{if(e.accelKey){this.parent.transition("brushing",e);break}this.parent.transition("pointing_rotate_handle",e);break}case"top":case"right":case"bottom":case"left":case"top_left":case"top_right":case"bottom_left":case"bottom_right":{const n=this.editor.getOnlySelectedShape();if(e.ctrlKey&&this.editor.canCropShape(n))this.parent.transition("crop.pointing_crop_handle",e);else{if(e.accelKey){this.parent.transition("brushing",e);break}this.parent.transition("pointing_resize_handle",e)}break}default:{const n=this.editor.getHoveredShape();if(n&&!this.editor.getSelectedShapeIds().includes(n.id)&&!n.isLocked){this.onPointerDown({...e,shape:n,target:"shape"});return}this.parent.transition("pointing_selection",e)}}break}}}onDoubleClick(e){if(!(this.editor.inputs.getShiftKey()||e.phase!=="up")&&!(e.ctrlKey||e.shiftKey))switch(e.target){case"canvas":{const n=this.editor.getHoveredShape(),s=this.editor.inputs.getCurrentPagePoint(),r=n&&!this.editor.isShapeOfType(n,"group")?n:this.editor.getSelectedShapeAtPoint(s)??this.editor.getShapeAtPoint(s,{margin:this.editor.options.hitTestMargin/this.editor.getZoomLevel(),hitInside:!1}),i=this.editor.getFocusedGroupId();if(r){if(this.editor.isShapeOfType(r,"group")){Wd(this.editor,e);return}else{const o=this.editor.getShape(r.parentId);if(o&&this.editor.isShapeOfType(o,"group")&&!(i&&o.id===i)){Wd(this.editor,e);return}}this.onDoubleClick({...e,shape:r,target:"shape"});return}this.editor.inputs.getShiftKey()||this.handleDoubleClickOnCanvas(e);break}case"selection":{const n=this.editor.getOnlySelectedShape();if(n){const s=this.editor.getShapeUtil(n),r=e.handle==="right"||e.handle==="left"||e.handle==="top"||e.handle==="bottom",i=e.handle==="top_left"||e.handle==="top_right"||e.handle==="bottom_right"||e.handle==="bottom_left";if(this.editor.getIsReadonly()){this.editor.canEditShape(n,{type:i?"double-click-corner":r?"double-click-edge":"double-click"})&&this.startEditingShape(n,e,!0);break}if(r){const o=s.onDoubleClickEdge?.(n,e);if(o){this.editor.markHistoryStoppingPoint("double click edge"),this.editor.updateShapes([o]),Qe(this.editor,[n.id]);return}}if(i){const o=s.onDoubleClickCorner?.(n,e);if(o){this.editor.markHistoryStoppingPoint("double click corner"),this.editor.updateShapes([o]),Qe(this.editor,[n.id]);return}}if(this.editor.canCropShape(n)){this.parent.transition("crop",e);return}this.editor.canEditShape(n)&&this.startEditingShape(n,e,!0)}break}case"shape":{const{shape:n}=e,s=this.editor.getShapeUtil(n);if(n.type!=="video"&&n.type!=="embed"&&this.editor.getIsReadonly())break;if(s.onDoubleClick){const r=s.onDoubleClick?.(n);if(r){this.editor.updateShapes([r]);return}}if(s.canCrop(n)&&!this.editor.isShapeOrAncestorLocked(n)){this.editor.markHistoryStoppingPoint("select and crop"),this.editor.select(e.shape?.id),this.parent.transition("crop",e);return}this.editor.canEditShape(n)?this.startEditingShape(n,e,!0):this.handleDoubleClickOnCanvas(e);break}case"handle":{if(this.editor.getIsReadonly())break;const{shape:n,handle:s}=e,i=this.editor.getShapeUtil(n).onDoubleClickHandle?.(n,s);i?this.editor.updateShapes([i]):this.editor.canEditShape(n)&&this.startEditingShape(n,e,!0)}}}onRightClick(e){switch(e.target){case"canvas":{const n=this.editor.getHoveredShape(),s=n&&!this.editor.isShapeOfType(n,"group")?n:this.editor.getShapeAtPoint(this.editor.inputs.getCurrentPagePoint(),{margin:this.editor.options.hitTestMargin/this.editor.getZoomLevel(),hitInside:!1,hitLabels:!0,hitLocked:!0,hitFrameInside:!0,renderingOnly:!0});if(s){this.onRightClick({...e,shape:s,target:"shape"});return}const r=this.editor.getSelectedShapeIds(),i=this.editor.getOnlySelectedShape(),o=this.editor.inputs.getCurrentPagePoint();if((r.length>1||i&&!this.editor.getShapeUtil(i).hideSelectionBoundsBg(i))&&s0(this.editor,o)){this.onRightClick({...e,target:"selection"});return}this.editor.selectNone();break}case"shape":{const{selectedShapeIds:n}=this.editor.getCurrentPageState(),{shape:s}=e,r=this.editor.getOutermostSelectableShape(s,i=>!n.includes(i.id));!n.includes(r.id)&&!this.editor.findShapeAncestor(r,i=>n.includes(i.id))&&(this.editor.markHistoryStoppingPoint("selecting shape"),this.editor.setSelectedShapes([r.id]));break}}}onCancel(){this.editor.getFocusedGroupId()!==this.editor.getCurrentPageId()&&this.editor.getSelectedShapeIds().length>0?this.editor.popFocusedGroupId():(this.editor.markHistoryStoppingPoint("clearing selection"),this.editor.selectNone())}onKeyDown(e){switch(this.selectedShapesOnKeyDown=this.editor.getSelectedShapes(),e.code){case"ArrowLeft":case"ArrowRight":case"ArrowUp":case"ArrowDown":{if(e.accelKey){e.shiftKey?e.code==="ArrowDown"?this.editor.selectFirstChildShape():e.code==="ArrowUp"&&this.editor.selectParentShape():this.editor.selectAdjacentShape(e.code.replace("Arrow","").toLowerCase());return}this.nudgeSelectedShapes(!1);return}}if(mt.editOnType.get()&&!iH.includes(e.key)&&!e.altKey&&!e.ctrlKey){const n=this.editor.getOnlySelectedShape();if(n&&this.editor.isShapeOfType(n,"note")&&this.editor.canEditShape(n)){this.startEditingShape(n,{...e,target:"shape",shape:n},!0);return}}}onKeyRepeat(e){switch(e.code){case"ArrowLeft":case"ArrowRight":case"ArrowUp":case"ArrowDown":{if(e.accelKey){this.editor.selectAdjacentShape(e.code.replace("Arrow","").toLowerCase());return}this.nudgeSelectedShapes(!0);break}case"Tab":{this.editor.getSelectedShapes().length&&!e.altKey&&this.editor.selectAdjacentShape(e.shiftKey?"prev":"next");break}}}onKeyUp(e){switch(e.key){case"Enter":{if(!this.selectedShapesOnKeyDown.length)return;const n=this.editor.getSelectedShapes();if(n.every(r=>this.editor.isShapeOfType(r,"group"))){this.editor.setSelectedShapes(n.flatMap(r=>this.editor.getSortedChildIdsForParent(r.id)));return}const s=this.editor.getOnlySelectedShape();if(s&&this.editor.canEditShape(s,{type:"press_enter"})){this.startEditingShape(s,{...e,target:"shape",shape:s},!0);return}this.editor.canCropShape(s)&&this.parent.transition("crop",e);break}case"Tab":{this.editor.getSelectedShapes().length&&!e.altKey&&this.editor.selectAdjacentShape(e.shiftKey?"prev":"next");break}}}startEditingShape(e,n,s){const{editor:r}=this;this.editor.markHistoryStoppingPoint("editing shape"),MT(e)?Hn(r,e,{selectAll:s}):r.setEditingShape(e),this.parent.transition("editing_shape",n)}isOverArrowLabelTest(e){return e?O2(this.editor,e):!1}handleDoubleClickOnCanvas(e){if(this.editor.getIsReadonly()||!this.editor.options.createTextOnCanvasDoubleClick)return;this.editor.markHistoryStoppingPoint("creating text shape");const n=tt(),{x:s,y:r}=this.editor.inputs.getCurrentPagePoint();this.editor.createShapes([{id:n,type:"text",x:s,y:r,props:{richText:ln(""),autoSize:!0}}]);const i=this.editor.getShape(n);i&&this.editor.canEditShape(i)&&Hn(this.editor,n,{info:e})}nudgeSelectedShapes(e=!1){const{editor:{inputs:{keys:n}}}=this,s=n.has("ShiftLeft"),r=new b(0,0);if(n.has("ArrowLeft")&&(r.x-=1),n.has("ArrowRight")&&(r.x+=1),n.has("ArrowUp")&&(r.y-=1),n.has("ArrowDown")&&(r.y+=1),r.equals(new b(0,0)))return;e||this.editor.markHistoryStoppingPoint("nudge shapes");const{gridSize:i}=this.editor.getDocumentSettings(),o=this.editor.getInstanceState().isGridMode?s?i*lH:i:s?aH:cH,a=this.editor.getSelectedShapeIds();this.editor.nudgeShapes(a,r.mul(o)),Qe(this.editor,a)}};const aH=10,cH=1,lH=5;function s0(t,e){const n=t.getSelectionRotatedPageBounds();if(!n)return!1;const s=t.getSelectionRotation();return s?Bn(e,n.corners.map(r=>b.RotWith(r,n.point,s))):n.containsPoint(e)}class dH extends fe{static id="pointing_arrow_label";shapeId="";markId="";wasAlreadySelected=!1;didDrag=!1;didCtrlOnEnter=!1;info={};updateCursor(){this.editor.setCursor({type:"grabbing",rotation:0})}onEnter(e){const{shape:n}=e;typeof e.onInteractionEnd=="string"&&this.parent.setCurrentToolIdMask(e.onInteractionEnd),this.info=e,this.shapeId=n.id,this.didDrag=!1,this.didCtrlOnEnter=e.accelKey,this.wasAlreadySelected=this.editor.getOnlySelectedShapeId()===n.id,this.updateCursor();const r=this.editor.getShapeGeometry(n).children[1];if(!r)throw Error(`Expected to find an arrow label geometry for shape: ${n.id}`);const i=this.editor.inputs.getCurrentPagePoint(),o=this.editor.getPointInShapeSpace(n,i);if(this._labelDragOffset=b.Sub(r.center,o),this.markId=this.editor.markHistoryStoppingPoint("label-drag start"),e.shiftKey||e.accelKey){const c=this.editor.getSelectedShapeIds();this.editor.setSelectedShapes([...c,this.shapeId]);return}this.editor.setSelectedShapes([this.shapeId])}onExit(){this.parent.setCurrentToolIdMask(void 0),this.editor.setCursor({type:"default",rotation:0})}_labelDragOffset=new b(0,0);onPointerMove(){if(!this.editor.inputs.getIsDragging())return;if(this.didCtrlOnEnter){this.parent.transition("brushing",this.info);return}const n=this.editor.getShape(this.shapeId);if(!n)return;const s=this.editor.getShapeUtil("arrow").options,r=aa(this.editor,n),i=this.editor.getShapePageTransform(n.id),o=this.editor.getPointInShapeSpace(n,this.editor.inputs.getCurrentPagePoint()).add(this._labelDragOffset),a=D2(this.editor,n);let c=r.uninterpolateAlongEdge(o);isNaN(c)&&(c=a);const l=i.applyToPoint(r.interpolateAlongEdge(c)),u=i.applyToPoint(r.interpolateAlongEdge(a));b.DistMin(l,u,s.labelCenterSnapDistance/this.editor.getZoomLevel())&&(c=a),this.didDrag=!0,this.editor.updateShape({id:n.id,type:n.type,props:{labelPosition:c}})}onPointerUp(){const e=this.editor.getShape(this.shapeId);e&&(this.didDrag||!this.wasAlreadySelected?this.complete():this.editor.canEditShape(e)&&Hn(this.editor,e.id))}onCancel(){this.cancel()}onComplete(){this.cancel()}onInterrupt(){this.cancel()}complete(){const{onInteractionEnd:e}=this.info;if(e){typeof e=="string"?this.editor.setCurrentTool(e,{}):e();return}this.parent.transition("idle")}cancel(){this.editor.bailToMark(this.markId);const{onInteractionEnd:e}=this.info;if(e){typeof e=="string"?this.editor.setCurrentTool(e,{}):e();return}this.parent.transition("idle")}}class uH extends fe{static id="pointing_canvas";onEnter(e){e.shiftKey||e.accelKey||this.editor.getSelectedShapeIds().length>0&&(this.editor.markHistoryStoppingPoint("selecting none"),this.editor.selectNone())}onPointerMove(e){this.editor.inputs.getIsDragging()&&this.parent.transition("brushing",e)}onPointerUp(e){Wd(this.editor,e),this.complete()}onComplete(){this.complete()}onInterrupt(){this.parent.transition("idle")}complete(){this.parent.transition("idle")}}class hH extends fe{static id="pointing_handle";didCtrlOnEnter=!1;info={};onEnter(e){this.info=e,this.didCtrlOnEnter=e.accelKey;const{shape:n}=e;if(this.editor.isShapeOfType(n,"arrow")){const s=Vt(this.editor,n),r=s[e.handle.id],i=s[e.handle.id==="start"?"end":"start"],o=this.editor.getShapePageTransform(n.id);r&&$u({editor:this.editor,pointInPageSpace:o.applyToPoint(e.handle),arrow:n,isPrecise:r.props.isPrecise,currentBinding:r,oppositeBinding:i})}this.editor.setCursor({type:"grabbing",rotation:0})}onExit(){this.editor.setHintingShapes([]),this.editor.setCursor({type:"default",rotation:0})}onPointerUp(){const{shape:e,handle:n}=this.info;if(this.editor.isShapeOfType(e,"note")){const{editor:s}=this,r=r0(s,e,n,!1);if(r){Hn(s,r,{selectAll:!0});return}}this.parent.transition("idle",this.info)}onPointerMove(e){const{editor:n}=this;n.inputs.getIsDragging()&&(this.didCtrlOnEnter?this.parent.transition("brushing",e):this.startDraggingHandle())}onLongPress(){this.startDraggingHandle()}startDraggingHandle(){const{editor:e}=this;if(e.getIsReadonly())return;const{shape:n,handle:s}=this.info;if(e.isShapeOfType(n,"note")){const r=r0(e,n,s,!0);if(r){const i=e.getPointInParentSpace(r,e.inputs.getOriginPagePoint()).sub(b.Rot(Nu.clone().mul(n.props.scale),r.rotation));e.updateShape({...r,x:i.x,y:i.y}),e.setHoveredShape(r.id).select(r.id).setCurrentTool("select.translating",{...this.info,target:"shape",shape:e.getShape(r),onInteractionEnd:"note",isCreating:!0,onCreate:()=>{Hn(e,r,{selectAll:!0})}});return}}this.parent.transition("dragging_handle",this.info)}onCancel(){this.cancel()}onComplete(){this.cancel()}onInterrupt(){this.cancel()}cancel(){this.parent.transition("idle")}}function r0(t,e,n,s){const r=t.getShapePageTransform(e.id),i=r.point(),o=r.rotation(),c=v2(t,i,o,e.props.growY*e.props.scale,0,e.props.scale)[n.index];if(c)return I2(t,e,c,o,s)}class pH extends fe{static id="pointing_rotate_handle";info={};updateCursor(){this.editor.setCursor({type:la[this.info.handle],rotation:this.editor.getSelectionRotation()})}onEnter(e){this.info=e,typeof e.onInteractionEnd=="string"&&this.parent.setCurrentToolIdMask(e.onInteractionEnd),this.updateCursor()}onExit(){this.parent.setCurrentToolIdMask(void 0),this.editor.setCursor({type:"default",rotation:0})}onPointerMove(){this.editor.inputs.getIsDragging()&&this.startRotating()}onLongPress(){this.startRotating()}startRotating(){this.editor.getIsReadonly()||this.parent.transition("rotating",this.info)}onPointerUp(){this.complete()}onCancel(){this.cancel()}onComplete(){this.cancel()}onInterrupt(){this.cancel()}complete(){const{onInteractionEnd:e}=this.info;if(e){typeof e=="string"?this.editor.setCurrentTool(e,{}):e?.();return}this.parent.transition("idle")}cancel(){const{onInteractionEnd:e}=this.info;if(e){typeof e=="string"?this.editor.setCurrentTool(e,{}):e();return}this.parent.transition("idle")}}class fH extends fe{static id="pointing_selection";info={};onEnter(e){this.info=e}onPointerUp(e){Wd(this.editor,e),this.parent.transition("idle",e)}onPointerMove(e){this.editor.inputs.getIsDragging()&&this.startTranslating(e)}onLongPress(e){this.startTranslating(e)}startTranslating(e){this.editor.getIsReadonly()||this.parent.transition("translating",e)}onDoubleClick(e){const n=this.editor.getHoveredShape(),s=n&&!this.editor.isShapeOfType(n,"group")?n:this.editor.getShapeAtPoint(this.editor.inputs.getCurrentPagePoint(),{hitInside:!0,margin:0,renderingOnly:!0});if(s){this.parent.transition("idle"),this.parent.onDoubleClick?.({...e,target:"shape",shape:this.editor.getShape(s)});return}}onCancel(){this.cancel()}onComplete(){this.cancel()}onInterrupt(){this.cancel()}cancel(){this.parent.transition("idle")}}class gH extends fe{static id="pointing_shape";hitShape={};hitShapeForPointerUp={};isDoubleClick=!1;didCtrlOnEnter=!1;didSelectOnEnter=!1;onEnter(e){const n=this.editor.getSelectedShapeIds(),s=this.editor.getSelectionRotatedPageBounds(),r=this.editor.getFocusedGroupId(),i=this.editor.inputs.getCurrentPagePoint(),{shiftKey:o,altKey:a,accelKey:c}=e;this.hitShape=e.shape,this.isDoubleClick=!1,this.didCtrlOnEnter=c;const l=this.editor.getOutermostSelectableShape(e.shape),u=this.editor.findShapeAncestor(l,d=>n.includes(d.id));if(this.didCtrlOnEnter||this.editor.getShapeUtil(e.shape).onClick||l.id===r||n.includes(l.id)||u||n.length>1&&s?.containsPoint(i)){this.didSelectOnEnter=!1,this.hitShapeForPointerUp=l;return}this.didSelectOnEnter=!0,o&&!a?(this.editor.cancelDoubleClick(),n.includes(l.id)||(this.editor.markHistoryStoppingPoint("shift selecting shape"),this.editor.setSelectedShapes([...n,l.id]))):(this.editor.markHistoryStoppingPoint("selecting shape"),this.editor.setSelectedShapes([l.id]))}onPointerUp(e){const n=this.editor.getSelectedShapeIds(),s=this.editor.getFocusedGroupId(),r=this.editor.getZoomLevel(),i=this.editor.inputs.getCurrentPagePoint(),o=e.shiftKey||e.accelKey,a=this.editor.getShapeAtPoint(i,{margin:this.editor.options.hitTestMargin/r,hitInside:!0,renderingOnly:!0})??this.hitShape,c=a?this.editor.getOutermostSelectableShape(a):this.hitShapeForPointerUp;if(c){const l=this.editor.getShapeUtil(c);if(l.onClick){const u=l.onClick?.(c);if(u){this.editor.markHistoryStoppingPoint("shape on click"),this.editor.updateShapes([u]),this.parent.transition("idle",e);return}}if(c.id===s){n.length>0?(this.editor.markHistoryStoppingPoint("clearing shape ids"),this.editor.setSelectedShapes([])):this.editor.popFocusedGroupId(),this.parent.transition("idle",e);return}}if(!this.didSelectOnEnter){const l=this.editor.getOutermostSelectableShape(a,u=>!n.includes(u.id));if(n.includes(l.id))if(o)this.editor.markHistoryStoppingPoint("deselecting on pointer up"),this.editor.deselect(c);else if(n.includes(c.id)){if(n.length===1){const u=this.editor.getShapeUtil(c).getGeometry(c),d=Q2(u),p=d.length===1?d[0]:void 0;if(p){const f=this.editor.getPointInShapeSpace(c,i);if(p.bounds.containsPoint(f,0)&&p.hitTestPoint(f)){this.editor.run(()=>{this.editor.markHistoryStoppingPoint("editing on pointer up"),this.editor.select(c.id),this.editor.canEditShape(c)&&(this.editor.setEditingShape(c.id),this.editor.setCurrentTool("select.editing_shape"),this.isDoubleClick?this.editor.emit("select-all-text",{shapeId:c.id}):this.editor.emit("place-caret",{shapeId:c.id,point:e.point}))});return}}}this.editor.markHistoryStoppingPoint("selecting on pointer up"),this.editor.select(c.id)}else this.editor.markHistoryStoppingPoint("selecting on pointer up"),this.editor.select(c);else if(o){const u=this.editor.getShapeAncestors(l);this.editor.markHistoryStoppingPoint("shift deselecting on pointer up"),this.editor.setSelectedShapes([...this.editor.getSelectedShapeIds().filter(d=>!u.find(p=>p.id===d)),l.id])}else this.editor.markHistoryStoppingPoint("selecting on pointer up"),this.editor.setSelectedShapes([l.id])}this.parent.transition("idle",e)}onDoubleClick(){this.isDoubleClick=!0}onPointerMove(e){if(this.editor.inputs.getIsDragging()){if(O2(this.editor,this.hitShape)){this.parent.transition("pointing_arrow_label",{...e,shape:this.hitShape});return}this.didCtrlOnEnter?this.parent.transition("brushing",e):this.startTranslating(e)}}onLongPress(e){this.startTranslating(e)}startTranslating(e){this.editor.getIsReadonly()||(this.editor.focus(),this.parent.transition("translating",e))}onCancel(){this.cancel()}onComplete(){this.cancel()}onInterrupt(){this.cancel()}cancel(){this.parent.transition("idle")}}class mH extends fe{static id="resizing";info={};markId="";didHoldCommand=!1;creationCursorOffset={x:0,y:0};snapshot={};onEnter(e){const{isCreating:n=!1,creatingMarkId:s,creationCursorOffset:r={x:0,y:0}}=e;this.info=e,this.didHoldCommand=!1,typeof e.onInteractionEnd=="string"&&this.parent.setCurrentToolIdMask(e.onInteractionEnd),this.creationCursorOffset=r;try{this.snapshot=this._createSnapshot()}catch(i){console.error(i),this.cancel();return}if(this.markId="",n)if(s)this.markId=s;else{const i=this.editor.getMarkIdMatching(`creating:${this.editor.getOnlySelectedShapeId()}`);i&&(this.markId=i)}else this.markId=this.editor.markHistoryStoppingPoint("starting resizing");n&&this.editor.setCursor({type:"cross",rotation:0}),this.handleResizeStart(),this.updateShapes()}onTick({elapsed:e}){const{editor:n}=this;n.edgeScrollManager.updateEdgeScrolling(e)}onPointerMove(){this.updateShapes()}onKeyDown(){this.updateShapes()}onKeyUp(){this.updateShapes()}onPointerUp(){this.complete()}onComplete(){this.complete()}onCancel(){this.cancel()}cancel(){const{shapeSnapshots:e}=this.snapshot;e.forEach(({shape:s})=>{const r=this.editor.getShape(s.id);r&&this.editor.getShapeUtil(s).onResizeCancel?.(s,r)}),this.editor.bailToMark(this.markId);const{onInteractionEnd:n}=this.info;if(n){typeof n=="string"?this.editor.setCurrentTool(n,{}):n();return}this.parent.transition("idle")}complete(){if(Qe(this.editor,this.snapshot.selectedShapeIds),this.handleResizeEnd(),this.info.isCreating&&this.info.onCreate){this.info.onCreate?.(this.editor.getOnlySelectedShape());return}const{onInteractionEnd:e}=this.info;if(e)if(typeof e=="string"){if(this.editor.getInstanceState().isToolLocked){this.editor.setCurrentTool(e,{});return}}else{e();return}this.parent.transition("idle")}handleResizeStart(){const{shapeSnapshots:e}=this.snapshot,n=[];e.forEach(({shape:s})=>{const i=this.editor.getShapeUtil(s).onResizeStart?.(s);i&&n.push(i)}),n.length>0&&this.editor.updateShapes(n)}handleResizeEnd(){const{shapeSnapshots:e}=this.snapshot,n=[];e.forEach(({shape:s})=>{const r=this.editor.getShape(s.id),o=this.editor.getShapeUtil(s).onResizeEnd?.(s,r);o&&n.push(o)}),n.length>0&&this.editor.updateShapes(n)}updateShapes(){const e=this.editor.inputs.getAltKey(),n=this.editor.inputs.getShiftKey(),{frames:s,shapeSnapshots:r,selectionBounds:i,cursorHandleOffset:o,selectedShapeIds:a,selectionRotation:c,canShapesDeform:l}=this.snapshot;let u=n||!l;if(r.size===1){const C=[...r.values()][0];this.editor.isShapeOfType(C.shape,"text")&&(u=!(this.info.handle==="left"||this.info.handle==="right"))}const d=At(this.editor.inputs),p=this.editor.inputs.getCurrentPagePoint().clone().sub(o).sub(this.creationCursorOffset),f=this.editor.inputs.getOriginPagePoint().clone().sub(o);if(this.editor.getInstanceState().isGridMode&&!d){const{gridSize:C}=this.editor.getDocumentSettings();p.snapToGrid(C)}const g=this.info.handle,x=i0(g,Math.PI);if(this.editor.snaps.clearIndicators(),(this.editor.user.getIsSnapMode()?!d:d)&&c%vt===0){const{nudge:C}=this.editor.snaps.shapeBounds.snapResizeShapes({dragDelta:b.Sub(p,f),initialSelectionPageBounds:this.snapshot.initialSelectionPageBounds,handle:i0(g,c),isAspectRatioLocked:u,isResizingFromCenter:e});p.add(C)}const m=b.RotWith(e?i.center:i.getHandlePoint(x),i.point,c),S=b.Sub(p,m).rot(-c),w=b.Sub(f,m).rot(-c),P=b.DivV(S,w);Number.isFinite(P.x)||(P.x=1),Number.isFinite(P.y)||(P.y=1);const _=g==="top"||g==="bottom",I=g==="left"||g==="right";u?I?P.y=Math.abs(P.x):_?P.x=Math.abs(P.y):Math.abs(P.x)>Math.abs(P.y)?P.y=Math.abs(P.x)*(P.y<0?-1:1):P.x=Math.abs(P.y)*(P.x<0?-1:1):(_&&(P.x=1),I&&(P.y=1)),this.info.isCreating||this.updateCursor({dragHandle:g,isFlippedX:P.x<0,isFlippedY:P.y<0,rotation:c});for(const C of r.keys()){const E=r.get(C);this.editor.resizeShape(C,P,{initialShape:E.shape,initialBounds:E.bounds,initialPageTransform:E.pageTransform,dragHandle:g,mode:a.length===1&&C===a[0]?"resize_bounds":"scale_shape",scaleOrigin:m,isAspectRatioLocked:u,scaleAxisRotation:c,skipStartAndEndCallbacks:!0})}if(d){this.didHoldCommand=!0;for(const{id:C,children:E}of s){if(!E.length)continue;const O=r.get(C).shape,k=this.editor.getShape(C);if(!(O&&k))continue;const T=k.x-O.x,D=k.y-O.y,R=new b(T,D).rot(-O.rotation);if(R.x!==0||R.y!==0)for(const M of E)this.editor.updateShape({id:M.id,type:M.type,x:M.x-R.x,y:M.y-R.y})}}else if(this.didHoldCommand){this.didHoldCommand=!1;for(const{children:C}of s)if(C.length)for(const E of C)this.editor.updateShape({id:E.id,type:E.type,x:E.x,y:E.y})}}updateCursor({dragHandle:e,isFlippedX:n,isFlippedY:s,rotation:r}){const i={...this.editor.getInstanceState().cursor};switch(e){case"top_left":case"bottom_right":{i.type="nwse-resize",n!==s&&(i.type="nesw-resize");break}case"top_right":case"bottom_left":{i.type="nesw-resize",n!==s&&(i.type="nwse-resize");break}}i.rotation=r,this.editor.setCursor(i)}onExit(){this.parent.setCurrentToolIdMask(void 0),this.editor.setCursor({type:"default",rotation:0}),this.editor.snaps.clearIndicators()}_createSnapshot(){const{editor:e}=this,n=e.getSelectedShapeIds(),s=e.getSelectionRotation(),r=e.inputs.getOriginPagePoint(),i=e.getSelectionRotatedPageBounds();if(!i)throw Error("Resizing but nothing is selected");const o=b.RotWith(i.getHandlePoint(this.info.handle),i.point,s),a=b.Sub(r,o),c=new Map,l=[],u=p=>{const f=e.getShape(p);if(!f)return!1;const g=e.getShapeUtil(f);if(g.canResize(f)){const x=e.getShapePageTransform(f);c.set(f.id,{shape:f,bounds:e.getShapeGeometry(f).bounds,pageTransform:x,pageRotation:q.Decompose(x).rotation,isAspectRatioLocked:g.isAspectRatioLocked(f)})}if(e.isShapeOfType(f,"frame")&&l.push({id:f.id,children:ve(e.getSortedChildIdsForParent(f).map(x=>e.getShape(x)))}),!g.canResizeChildren(f))return!1};n.forEach(p=>{u(p)!==!1&&e.visitDescendants(p,u)});const d=![...c.values()].some(p=>!bP(p.pageRotation,s)||p.isAspectRatioLocked);return{shapeSnapshots:c,selectionBounds:i,cursorHandleOffset:a,selectionRotation:s,selectedShapeIds:n,canShapesDeform:d,initialSelectionPageBounds:this.editor.getSelectionPageBounds(),frames:l}}}const hg=["top","top_right","right","bottom_right","bottom","bottom_left","left","top_left"];function i0(t,e){e=e%at;const n=Math.round(e/(Ve/4)),s=hg.indexOf(t);return hg[(s+n)%hg.length]}const o0=Math.PI/180;class yH extends fe{static id="rotating";snapshot={};info={};markId="";onEnter(e){this.info=e,typeof e.onInteractionEnd=="string"&&this.parent.setCurrentToolIdMask(e.onInteractionEnd),this.markId=this.editor.markHistoryStoppingPoint("rotate start");const n=PI({editor:this.editor,ids:this.editor.getSelectedShapeIds()});if(!n)return this.parent.transition("idle",this.info);this.snapshot=n;const s=this._getRotationFromPointerPosition({snapToNearestDegree:!1});ad({editor:this.editor,delta:this._getRotationFromPointerPosition({snapToNearestDegree:!1}),snapshot:this.snapshot,stage:"start"}),this.editor.setCursor({type:la[this.info.handle],rotation:s+this.snapshot.initialShapesRotation})}onExit(){this.editor.setCursor({type:"default",rotation:0}),this.parent.setCurrentToolIdMask(void 0),this.snapshot={}}onPointerMove(){this.update()}onKeyDown(){this.update()}onKeyUp(){this.update()}onPointerUp(){this.complete()}onComplete(){this.complete()}onCancel(){this.cancel()}update(){const e=this._getRotationFromPointerPosition({snapToNearestDegree:!1});ad({editor:this.editor,delta:e,snapshot:this.snapshot,stage:"update"}),this.editor.setCursor({type:la[this.info.handle],rotation:e+this.snapshot.initialShapesRotation})}cancel(){const{shapeSnapshots:e}=this.snapshot;e.forEach(({shape:s})=>{const r=this.editor.getShape(s.id);r&&this.editor.getShapeUtil(s).onRotateCancel?.(s,r)}),this.editor.bailToMark(this.markId);const{onInteractionEnd:n}=this.info;if(n){typeof n=="string"?this.editor.setCurrentTool(n,this.info):n();return}this.parent.transition("idle",this.info)}complete(){ad({editor:this.editor,delta:this._getRotationFromPointerPosition({snapToNearestDegree:!0}),snapshot:this.snapshot,stage:"end"}),Qe(this.editor,this.snapshot.shapeSnapshots.map(n=>n.shape.id));const{onInteractionEnd:e}=this.info;if(e){typeof e=="string"?this.editor.setCurrentTool(e,this.info):e();return}this.parent.transition("idle",this.info)}_getRotationFromPointerPosition({snapToNearestDegree:e}){const n=this.editor.inputs.getShiftKey(),s=this.editor.inputs.getCurrentPagePoint(),{initialCursorAngle:r,initialShapesRotation:i,initialPageCenter:o}=this.snapshot,a=o.angle(s)-r;let c=i+a;if(n)c=Ad(c,24);else if(e&&(c=Math.round(c/o0)*o0,this.editor.getInstanceState().isCoarsePointer)){const l=Ad(c,4),u=id(c,l);Math.abs(u)<OO(5)&&(c=l)}return c-i}}class SH extends fe{static id="scribble_brushing";hits=new Set;size=0;scribbleId="id";initialSelectedShapeIds=new Set;newlySelectedShapeIds=new Set;onEnter(){this.initialSelectedShapeIds=new Set(this.editor.inputs.getShiftKey()?this.editor.getSelectedShapeIds():[]),this.newlySelectedShapeIds=new Set,this.size=0,this.hits.clear();const e=this.editor.scribbles.addScribble({color:"selection-stroke",opacity:.32,size:12});this.scribbleId=e.id,this.updateScribbleSelection(!0),this.editor.updateInstanceState({brush:null})}onExit(){this.editor.scribbles.stop(this.scribbleId)}onPointerMove(){this.updateScribbleSelection(!0)}onPointerUp(){this.complete()}onKeyDown(){this.updateScribbleSelection(!1)}onKeyUp(){this.editor.inputs.getAltKey()?this.updateScribbleSelection(!1):this.parent.transition("brushing")}onCancel(){this.cancel()}onComplete(){this.complete()}pushPointToScribble(){const{x:e,y:n}=this.editor.inputs.getCurrentPagePoint();this.editor.scribbles.addPoint(this.scribbleId,e,n)}updateScribbleSelection(e){const{editor:n}=this,s=this.editor.getCurrentPageRenderingShapesSorted(),r=this.editor.inputs.getShiftKey(),i=this.editor.inputs.getOriginPagePoint(),o=this.editor.inputs.getPreviousPagePoint(),a=this.editor.inputs.getCurrentPagePoint(),{newlySelectedShapeIds:c,initialSelectedShapeIds:l}=this;e&&this.pushPointToScribble();const u=s;let d,p,f,g;const x=0;for(let S=0,w=u.length;S<w;S++){if(d=u[S],n.isShapeOfType(d,"group")||c.has(d.id)||n.isShapeOrAncestorLocked(d)||(p=n.getShapeGeometry(d),n.isShapeOfType(d,"frame")&&p.bounds.containsPoint(n.getPointInShapeSpace(d,i))))continue;const P=n.getShapePageTransform(d);if(!p||!P)continue;const _=P.clone().invert();f=_.applyToPoint(o),g=_.applyToPoint(a);const{bounds:I}=p;if(!(I.minX-x>Math.max(f.x,g.x)||I.minY-x>Math.max(f.y,g.y)||I.maxX+x<Math.min(f.x,g.x)||I.maxY+x<Math.min(f.y,g.y))&&p.hitTestLineSegment(f,g,x)){const C=this.editor.getOutermostSelectableShape(d),E=this.editor.getShapeMask(C.id);if(E&&GP(o,a,E)!==null&&!Bn(a,E))continue;c.add(C.id)}}const y=n.getSelectedShapeIds(),m=new Set(r?[...c,...l]:[...c]);(y.length!==m.size||y.some(S=>!m.has(S)))&&this.editor.setSelectedShapes(Array.from(m))}complete(){this.updateScribbleSelection(!0),this.parent.transition("idle")}cancel(){this.editor.setSelectedShapes([...this.initialSelectedShapeIds]),this.parent.transition("idle")}}var xH=Object.create,ek=Object.defineProperty,bH=Object.getOwnPropertyDescriptor,wH=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),tk=t=>{throw TypeError(t)},nk=(t,e,n)=>e in t?ek(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,vH=t=>[,,,xH(null)],sk=["class","method","getter","setter","accessor","field","value","get","set"],rk=t=>t!==void 0&&typeof t!="function"?tk("Function expected"):t,PH=(t,e,n,s,r)=>({kind:sk[t],name:e,metadata:s,addInitializer:i=>n._?tk("Already initialized"):r.push(rk(i||null))}),IH=(t,e)=>nk(e,wH("metadata"),t[3]),_H=(t,e,n,s)=>{for(var r=0,i=t[e>>1],o=i&&i.length;r<o;r++)i[r].call(n);return s},CH=(t,e,n,s,r,i)=>{for(var o,a,c,l,u=e&7,d=!1,p=!1,f=2,g=sk[u+5],x=t[f]||(t[f]=[]),y=(r=r.prototype,bH(r,n)),m=s.length-1;m>=0;m--)c=PH(u,n,a={},t[3],x),c.static=d,c.private=p,l=c.access={has:S=>n in S},l.get=S=>S[n],o=(0,s[m])(y[g],c),a._=1,rk(o)&&(y[g]=o);return y&&ek(r,n,y),r},qr=(t,e,n)=>nk(t,typeof e!="symbol"?e+"":e,n),ik,Ku;const TH=320,EH=60;ik=[rs];class eS{constructor(e){this.editor=e,_H(Ku,5,this),qr(this,"shapesToActuallyMove",[]),qr(this,"draggedOverShapeIds",new Set),qr(this,"initialGroupIds",new Map),qr(this,"initialParentIds",new Map),qr(this,"initialIndices",new Map),qr(this,"initialDraggingOverShape"),qr(this,"prevDraggingOverShape"),qr(this,"prevPagePoint",new b),qr(this,"intervalTimerId",-1),e.disposables.add(this.dispose)}startDraggingShapes(e,n,s){const{editor:r}=this;if(this.intervalTimerId!==-1)return;const i=new Set(e),o=new Set;for(const l of i){const u=r.getShapeParent(l);u&&r.isShapeOfType(u,"group")&&(o.has(u)||o.add(u))}for(const l of o){const u=ve(r.getSortedChildIdsForParent(l).map(d=>r.getShape(d)));i.add(l);for(const d of u)i.delete(d)}this.initialParentIds.clear();for(const l of i){const u=r.getShapeParent(l);u&&this.initialParentIds.set(l.id,u.id),this.initialIndices.set(l.id,l.index);const d=r.findShapeAncestor(l,p=>r.isShapeOfType(p,"group"));d&&this.initialGroupIds.set(l.id,d.id)}const a=r.getCurrentPageShapesSorted();this.shapesToActuallyMove=Array.from(i).filter(l=>!l.isLocked).sort((l,u)=>a.indexOf(l)-a.indexOf(u)),this.initialDraggingOverShape=r.getDraggingOverShape(n,this.shapesToActuallyMove),this.prevDraggingOverShape=this.initialDraggingOverShape,this.updateDraggingShapes(n,s);let c=0;this.intervalTimerId=this.editor.timers.setInterval(()=>{c++,!(c%3&&this.editor.inputs.getPointerVelocity().len()>.5)&&this.updateDraggingShapes(r.inputs.getCurrentPagePoint(),s)},e.length>10?TH:EH)}dropShapes(e){const{editor:n}=this,s=n.inputs.getCurrentPagePoint();this.updateDraggingShapes(s);const r=n.getDraggingOverShape(s,e);r&&n.getShapeUtil(r).onDropShapesOver?.(r,e,{initialDraggingOverShapeId:this.initialDraggingOverShape?.id??null,initialParentIds:this.initialParentIds,initialIndices:this.initialIndices}),this.dispose()}clear(){clearInterval(this.intervalTimerId),this.intervalTimerId=-1,this.initialParentIds.clear(),this.initialIndices.clear(),this.shapesToActuallyMove=[],this.initialDraggingOverShape=void 0,this.prevDraggingOverShape=void 0,this.editor.setHintingShapes([])}dispose(){this.clear()}updateDraggingShapes(e,n){const{editor:s}=this,r=ve(this.shapesToActuallyMove.map(c=>s.getShape(c)));if(!r.length)return;const i=s.getDraggingOverShape(e,this.shapesToActuallyMove),o=s.inputs.getCurrentPagePoint(),a=!this.prevPagePoint.equals(o);this.prevPagePoint.setTo(o),s.run(()=>{if(this.prevDraggingOverShape?.id===i?.id){a&&i&&On(i.id)&&!s.inputs.getPreviousPagePoint().equals(o)&&s.getShapeUtil(i).onDragShapesOver?.(i,r,{initialDraggingOverShapeId:this.initialDraggingOverShape?.id??null,initialParentIds:this.initialParentIds,initialIndices:this.initialIndices});return}this.prevDraggingOverShape&&s.getShapeUtil(this.prevDraggingOverShape).onDragShapesOut?.(this.editor.getShape(this.prevDraggingOverShape),r,{nextDraggingOverShapeId:i?.id??null,initialDraggingOverShapeId:this.initialDraggingOverShape?.id??null,initialParentIds:this.initialParentIds,initialIndices:this.initialIndices}),i?(s.getShapeUtil(i).onDragShapesIn?.(i,r,{initialDraggingOverShapeId:this.initialDraggingOverShape?.id??null,prevDraggingOverShapeId:this.prevDraggingOverShape?.id??null,initialParentIds:this.initialParentIds,initialIndices:this.initialIndices}),s.setHintingShapes([i.id])):this.prevDraggingOverShape&&s.setHintingShapes([]),n?.()}),this.prevDraggingOverShape=i}}Ku=vH();CH(Ku,1,"dispose",ik,eS);IH(Ku,eS);var kH=Object.create,ok=Object.defineProperty,AH=Object.getOwnPropertyDescriptor,ak=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),ck=t=>{throw TypeError(t)},lk=(t,e,n)=>e in t?ok(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,MH=t=>[,,,kH(t?.[ak("metadata")]??null)],dk=["class","method","getter","setter","accessor","field","value","get","set"],uk=t=>t!==void 0&&typeof t!="function"?ck("Function expected"):t,jH=(t,e,n,s,r)=>({kind:dk[t],name:e,metadata:s,addInitializer:i=>n._?ck("Already initialized"):r.push(uk(i||null))}),DH=(t,e)=>lk(e,ak("metadata"),t[3]),OH=(t,e,n,s)=>{for(var r=0,i=t[e>>1],o=i&&i.length;r<o;r++)i[r].call(n);return s},LH=(t,e,n,s,r,i)=>{for(var o,a,c,l,u=e&7,d=!1,p=!1,f=2,g=dk[u+5],x=t[f]||(t[f]=[]),y=(r=r.prototype,AH(r,n)),m=s.length-1;m>=0;m--)c=jH(u,n,a={},t[3],x),c.static=d,c.private=p,l=c.access={has:S=>n in S},l.get=S=>S[n],o=(0,s[m])(y[g],c),a._=1,uk(o)&&(y[g]=o);return y&&ok(r,n,y),r},bi=(t,e,n)=>lk(t,typeof e!="symbol"?e+"":e,n),hk,em,Wu;class qu extends(em=fe,hk=[rs],em){constructor(){super(...arguments),OH(Wu,5,this),bi(this,"info",{}),bi(this,"selectionSnapshot",{}),bi(this,"snapshot",{}),bi(this,"markId",""),bi(this,"isCloning",!1),bi(this,"isCreating",!1),bi(this,"dragAndDropManager",new eS(this.editor))}onCreate(e){}onEnter(e){const{isCreating:n=!1,creatingMarkId:s,onCreate:r=()=>{}}=e;if(!this.editor.getSelectedShapeIds()?.length){this.parent.transition("idle");return}if(this.info=e,typeof e.onInteractionEnd=="string"&&this.parent.setCurrentToolIdMask(e.onInteractionEnd),this.isCreating=n,this.markId="",n)if(s)this.markId=s;else{const i=this.editor.getMarkIdMatching(`creating:${this.editor.getOnlySelectedShapeId()}`);i&&(this.markId=i)}else this.markId=this.editor.markHistoryStoppingPoint("translating");this.onCreate=r,this.isCloning=!1,this.info=e,this.editor.setCursor({type:"move",rotation:0}),this.selectionSnapshot=a0(this.editor),!(!this.isCreating&&this.editor.inputs.getAltKey()&&(this.startCloning(),this.isCloning))&&(this.snapshot=this.selectionSnapshot,this.handleStart(),this.updateShapes())}onExit(){this.parent.setCurrentToolIdMask(void 0),this.selectionSnapshot={},this.snapshot={},this.editor.snaps.clearIndicators(),this.editor.setCursor({type:"default",rotation:0}),this.dragAndDropManager.clear()}onTick({elapsed:e}){const{editor:n}=this;n.edgeScrollManager.updateEdgeScrolling(e)}onPointerMove(){this.updateShapes()}onKeyDown(){this.editor.inputs.getAltKey()&&!this.isCloning&&(this.startCloning(),this.isCloning)||this.updateShapes()}onKeyUp(){if(!this.editor.inputs.getAltKey()&&this.isCloning){this.stopCloning();return}this.updateShapes()}onPointerUp(){this.complete()}onComplete(){this.complete()}onCancel(){this.cancel()}startCloning(){if(this.isCreating)return;const e=Array.from(this.editor.getSelectedShapeIds());this.editor.canCreateShapes(e)&&(this.isCloning=!0,this.reset(),this.markId=this.editor.markHistoryStoppingPoint("translate cloning"),this.editor.duplicateShapes(Array.from(this.editor.getSelectedShapeIds())),this.snapshot=a0(this.editor),this.handleStart(),this.updateShapes())}stopCloning(){this.isCloning=!1,this.snapshot=this.selectionSnapshot,this.reset(),this.markId=this.editor.markHistoryStoppingPoint("translate"),this.updateShapes()}reset(){this.editor.bailToMark(this.markId)}complete(){this.updateShapes(),this.dragAndDropManager.dropShapes(this.snapshot.movingShapes),this.handleEnd(),Qe(this.editor,this.snapshot.movingShapes.map(n=>n.id));const{onInteractionEnd:e}=this.info;if(e)if(typeof e=="string"){if(this.editor.getInstanceState().isToolLocked){this.editor.setCurrentTool(e);return}}else{e();return}this.isCreating?this.onCreate?.(this.editor.getOnlySelectedShape()):this.parent.transition("idle")}cancel(){const{movingShapes:e}=this.snapshot;e.forEach(s=>{const r=this.editor.getShape(s.id);r&&this.editor.getShapeUtil(s).onTranslateCancel?.(s,r)}),this.reset();const{onInteractionEnd:n}=this.info;if(n){typeof n=="string"?this.editor.setCurrentTool(n):n();return}this.parent.transition("idle",this.info)}handleStart(){const{movingShapes:e}=this.snapshot,n=[];e.forEach(s=>{const i=this.editor.getShapeUtil(s).onTranslateStart?.(s);i&&n.push(i)}),n.length>0&&this.editor.updateShapes(n),this.dragAndDropManager.startDraggingShapes(ve(this.snapshot.movingShapes.map(s=>this.editor.getShape(s.id))),this.editor.inputs.getOriginPagePoint(),this.updateParentTransforms),this.editor.setHoveredShape(null)}handleEnd(){const{movingShapes:e}=this.snapshot;if(this.isCloning&&e.length>0){const s=b.Average(e.map(i=>this.editor.getShapePageTransform(i.id).point())),r=b.Sub(s,this.selectionSnapshot.averagePagePoint);b.IsNaN(r)||this.editor.updateInstanceState({duplicateProps:{shapeIds:e.map(i=>i.id),offset:{x:r.x,y:r.y}}})}const n=[];e.forEach(s=>{const r=this.editor.getShape(s.id),o=this.editor.getShapeUtil(s).onTranslateEnd?.(s,r);o&&n.push(o)}),n.length>0&&this.editor.updateShapes(n)}updateShapes(){const{snapshot:e}=this;this.dragAndDropManager.startDraggingShapes(e.movingShapes,this.editor.inputs.getOriginPagePoint(),this.updateParentTransforms),RH({editor:this.editor,snapshot:e});const{movingShapes:n}=e,s=[];n.forEach(r=>{const i=this.editor.getShape(r.id),a=this.editor.getShapeUtil(r).onTranslate?.(r,i);a&&s.push(a)}),s.length>0&&this.editor.updateShapes(s)}updateParentTransforms(){const{editor:e,snapshot:{shapeSnapshots:n}}=this;n.forEach(s=>{const r=e.getShape(s.shape.id);if(!r)return null;const i=nn(r.parentId)?null:q.Inverse(e.getShapePageTransform(r.parentId));s.parentTransform=i})}}Wu=MH(em);LH(Wu,1,"updateParentTransforms",hk,qu);DH(Wu,qu);bi(qu,"id","translating");function a0(t){const e=[],n=[],s=t.getSelectedShapeIds(),r=ve(s.map(d=>{const p=t.getShape(d);if(!p)return null;e.push(p);const f=t.getShapePageTransform(d),g=f.point(),x=f.rotation();n.push(g);const y=zn.isId(p.parentId)?null:q.Inverse(t.getShapePageTransform(p.parentId));return{shape:p,pagePoint:g,pageRotation:x,parentTransform:y}})),i=t.getOnlySelectedShape();let o=[];if(i)o=t.snaps.shapeBounds.getSnapPoints(i.id);else{const d=t.getSelectionPageBounds();d&&(o=d.cornersAndCenter.map((p,f)=>({id:"selection:"+f,x:p.x,y:p.y})))}let a,c;const l=t.inputs.getOriginPagePoint(),u=r.filter(d=>t.isShapeOfType(d.shape,"note")&&t.isPointInShape(d.shape,l));if(u.length!==0)if(u.length===1)c=u[0];else{const d=t.getCurrentPageShapesSorted();c=u.map(p=>({snapshot:p,index:d.findIndex(f=>f.id===p.shape.id)})).sort((p,f)=>f.index-p.index)[0]?.snapshot}return c&&(a=P2(t,c.pageRotation,c.shape.props.scale,c.shape.props.growY??0)),{averagePagePoint:b.Average(n),movingShapes:e,shapeSnapshots:r,initialPageBounds:t.getSelectionPageBounds(),initialSnapPoints:o,noteAdjacentPositions:a,noteSnapshot:c}}function RH({editor:t,snapshot:e}){const{inputs:n}=t,{noteSnapshot:s,noteAdjacentPositions:r,initialPageBounds:i,initialSnapPoints:o,shapeSnapshots:a,averagePagePoint:c}=e,l=t.inputs.getShiftKey(),u=t.inputs.getAccelKey(),d=t.getInstanceState().isGridMode,p=t.getDocumentSettings().gridSize,f=b.Sub(n.getCurrentPagePoint(),n.getOriginPagePoint()),g=l?Math.abs(f.x)<Math.abs(f.y)?"x":"y":null;g==="x"?f.x=0:g==="y"&&(f.y=0),t.snaps.clearIndicators();const x=t.user.getIsSnapMode()?!u:u;let y=!1;if(x&&t.inputs.getPointerVelocity().len()<.5){const{nudge:P}=t.snaps.shapeBounds.snapTranslateShapes({dragDelta:f,initialSelectionPageBounds:i,lockedAxis:g,initialSelectionSnapPoints:o});f.add(P)}else if(s&&r){const{scale:P}=s.shape.props,_=s.pagePoint.clone().add(f).add(Nu.clone().mul(P).rot(s.pageRotation));let I=w2/t.getZoomLevel(),C=new b(0,0);for(const E of r){const O=b.Sub(_,E),k=O.len();k<I&&(y=!0,I=k,C=O)}f.sub(C)}const m=b.Add(c,f),S=t.snaps.getIndicators();d&&!u&&!y&&S.length===0&&m.snapToGrid(p);const w=b.Sub(m,c);t.updateShapes(ve(a.map(({shape:P,pagePoint:_,parentTransform:I})=>{const C=b.Add(_,w),E=I?q.applyToPoint(I,C):C;return{id:P.id,type:P.type,x:E.x,y:E.y}})))}class FH extends fe{static id="select";static initial="idle";static isLockable=!1;reactor=void 0;static children(){return[nH,X2,oH,uH,gH,qu,Z7,SH,J2,fH,J7,rH,mH,yH,pH,dH,hH,sH]}cleanUpDuplicateProps(){const e=this.editor.getSelectedShapeIds(),n=this.editor.getInstanceState();if(!n.duplicateProps)return;const s=new Set(n.duplicateProps.shapeIds);e.length===s.size&&e.every(r=>s.has(r))||this.editor.updateInstanceState({duplicateProps:null})}onEnter(){this.reactor=is("clean duplicate props",()=>{try{this.cleanUpDuplicateProps()}catch(e){console.error(e)}})}onExit(){this.reactor?.(),this.editor.getCurrentPageState().editingShapeId&&this.editor.setEditingShape(null)}}class BH extends fe{static id="idle";info={};onEnter(e){this.info=e}onPointerDown(){this.parent.transition("pointing",this.info)}}class zH extends fe{static id="pointing";info={};onEnter(e){this.info=e}onPointerUp(){this.complete()}onPointerMove(){this.editor.inputs.getIsDragging()&&this.parent.transition("zoom_brushing",this.info)}onCancel(){this.cancel()}complete(){const e=this.editor.inputs.getCurrentScreenPoint();this.editor.inputs.getAltKey()?this.editor.zoomOut(e,{animation:{duration:220}}):this.editor.zoomIn(e,{animation:{duration:220}}),this.parent.transition("idle",this.info)}cancel(){this.parent.transition("idle",this.info)}}class $H extends fe{static id="zoom_brushing";info={};zoomBrush=new X;onEnter(e){this.info=e,this.update()}onExit(){this.editor.updateInstanceState({zoomBrush:null})}onPointerMove(){this.update()}onPointerUp(){this.complete()}onCancel(){this.cancel()}update(){const e=this.editor.inputs.getOriginPagePoint(),n=this.editor.inputs.getCurrentPagePoint();this.zoomBrush.setTo(X.FromPoints([e,n])),this.editor.updateInstanceState({zoomBrush:this.zoomBrush.toJson()})}cancel(){this.parent.transition("idle",this.info)}complete(){const{zoomBrush:e}=this,n=8/this.editor.getZoomLevel();if(e.width<n&&e.height<n){const s=this.editor.inputs.getCurrentScreenPoint();this.editor.inputs.getAltKey()?this.editor.zoomOut(s,{animation:{duration:220}}):this.editor.zoomIn(s,{animation:{duration:220}})}else{const s=this.editor.inputs.getAltKey()?this.editor.getZoomLevel()/2:void 0;this.editor.zoomToBounds(e,{targetZoom:s,animation:{duration:220}})}this.parent.transition("idle",this.info)}}class NH extends fe{static id="zoom";static initial="idle";static children(){return[BH,$H,zH]}static isLockable=!1;info={};onEnter(e){this.info=e,this.parent.setCurrentToolIdMask(e.onInteractionEnd),this.updateCursor()}onExit(){this.parent.setCurrentToolIdMask(void 0),this.editor.updateInstanceState({zoomBrush:null,cursor:{type:"default",rotation:0}}),this.parent.setCurrentToolIdMask(void 0)}onKeyDown(){this.updateCursor()}onKeyUp(e){this.updateCursor(),e.code==="KeyZ"&&this.complete()}onInterrupt(){this.complete()}complete(){this.info.onInteractionEnd&&this.info.onInteractionEnd!=="select"?this.editor.setCurrentTool(this.info.onInteractionEnd,this.info):this.parent.transition("select")}updateCursor(){this.editor.inputs.getAltKey()?this.editor.setCursor({type:"zoom-out",rotation:0}):this.editor.setCursor({type:"zoom-in",rotation:0})}}const UH=[H7,G7,X7,NH,FH],HH=Ye.forwardRef(function({isEditing:e,text:n,handleFocus:s,handleChange:r,handleKeyDown:i,handlePaste:o,handleBlur:a,handleInputPointerDown:c,handleDoubleClick:l},u){const d=z(),p=f=>{r({plaintext:f.target.value})};return h.jsx("textarea",{ref:u,className:"tl-text tl-text-input",name:"text",tabIndex:-1,disabled:!e,readOnly:!e,autoComplete:"off",autoCapitalize:"off",autoCorrect:"off",autoSave:"off",placeholder:"",spellCheck:"true",wrap:"off",dir:"auto",defaultValue:n,onFocus:s,onChange:p,onKeyDown:f=>i(f.nativeEvent),onBlur:a,onTouchEnd:d.markEventAsHandled,onContextMenu:e?f=>f.stopPropagation():void 0,onPointerDown:c,onPaste:o,onDoubleClick:l,onDragStart:Pe})});Ye.memo(function({shapeId:e,type:n,text:s,labelColor:r,font:i,fontSize:o,lineHeight:a,align:c,verticalAlign:l,wrap:u,isSelected:d,padding:p=0,onKeyDown:f,classNamePrefix:g,style:x,textWidth:y,textHeight:m,showTextOutline:S=!0}){const{rInput:w,isEmpty:P,isEditing:_,isReadyForEditing:I,...C}=tU(e,n,s),E=Oc.normalizeTextForDom(s||""),O=E.length>0,k=_2(c);if(!_&&!O)return null;const T=g||"tl-text";return h.jsx("div",{className:`${T}-label tl-text-wrapper tl-plain-text-wrapper`,"aria-hidden":!_,"data-font":i,"data-align":c,"data-hastext":!P,"data-isediting":_,"data-is-ready-for-editing":I,"data-textwrap":!!u,"data-isselected":d,style:{justifyContent:c==="middle"||k?"center":c,alignItems:l==="middle"?"center":l,padding:p,...x},children:h.jsxs("div",{className:`${T}-label__inner tl-text-content__wrapper`,style:{fontSize:o,lineHeight:a.toString(),minHeight:Math.floor(o*a)+"px",minWidth:Math.ceil(y||0),color:r,width:y?Math.ceil(y):void 0,height:m?Math.ceil(m):void 0},children:[h.jsx("div",{className:de(`${T} tl-text tl-text-content`,S?"tl-text__outline":"tl-text__no-outline"),dir:"auto",children:E.split(`
`).map((D,R)=>h.jsx("div",{dir:"auto",children:D},R))}),(I||d)&&h.jsx(HH,{ref:w,text:s,isEditing:_,shapeId:e,...C,handleKeyDown:f??C.handleKeyDown})]})})});let tm={fonts:{tldraw_mono:`${Bt()}/fonts/IBMPlexMono-Medium.woff2`,tldraw_mono_italic:`${Bt()}/fonts/IBMPlexMono-MediumItalic.woff2`,tldraw_mono_bold:`${Bt()}/fonts/IBMPlexMono-Bold.woff2`,tldraw_mono_italic_bold:`${Bt()}/fonts/IBMPlexMono-BoldItalic.woff2`,tldraw_serif:`${Bt()}/fonts/IBMPlexSerif-Medium.woff2`,tldraw_serif_italic:`${Bt()}/fonts/IBMPlexSerif-MediumItalic.woff2`,tldraw_serif_bold:`${Bt()}/fonts/IBMPlexSerif-Bold.woff2`,tldraw_serif_italic_bold:`${Bt()}/fonts/IBMPlexSerif-BoldItalic.woff2`,tldraw_sans:`${Bt()}/fonts/IBMPlexSans-Medium.woff2`,tldraw_sans_italic:`${Bt()}/fonts/IBMPlexSans-MediumItalic.woff2`,tldraw_sans_bold:`${Bt()}/fonts/IBMPlexSans-Bold.woff2`,tldraw_sans_italic_bold:`${Bt()}/fonts/IBMPlexSans-BoldItalic.woff2`,tldraw_draw:`${Bt()}/fonts/Shantell_Sans-Informal_Regular.woff2`,tldraw_draw_italic:`${Bt()}/fonts/Shantell_Sans-Informal_Regular_Italic.woff2`,tldraw_draw_bold:`${Bt()}/fonts/Shantell_Sans-Informal_Bold.woff2`,tldraw_draw_italic_bold:`${Bt()}/fonts/Shantell_Sans-Informal_Bold_Italic.woff2`}};function pk(t){return v.useMemo(()=>t?{fonts:{...tm.fonts,...t?.fonts}}:tm,[t])}const KH=["align-bottom","align-center-horizontal","align-center-vertical","align-left","align-right","align-top","alt","arrow-arc","arrow-cycle","arrow-elbow","arrow-left","arrowhead-arrow","arrowhead-bar","arrowhead-diamond","arrowhead-dot","arrowhead-none","arrowhead-square","arrowhead-triangle-inverted","arrowhead-triangle","blob","bold","bookmark","bring-forward","bring-to-front","broken","bulletList","check-circle","check","chevron-down","chevron-left","chevron-right","chevron-up","chevrons-ne","chevrons-sw","clipboard-copied","clipboard-copy","code","color","comment","corners","crop","cross-2","cross-circle","dash-dashed","dash-dotted","dash-draw","dash-solid","disconnected","discord","distribute-horizontal","distribute-vertical","dot","dots-horizontal","dots-vertical","download","drag-handle-dots","duplicate","edit","external-link","fill-fill","fill-none","fill-pattern","fill-semi","fill-solid","follow","following","font-draw","font-mono","font-sans","font-serif","geo-arrow-down","geo-arrow-left","geo-arrow-right","geo-arrow-up","geo-check-box","geo-cloud","geo-diamond","geo-ellipse","geo-heart","geo-hexagon","geo-octagon","geo-oval","geo-pentagon","geo-rectangle","geo-rhombus-2","geo-rhombus","geo-star","geo-trapezoid","geo-triangle","geo-x-box","github","group","heading","help-circle","highlight","horizontal-align-end","horizontal-align-middle","horizontal-align-start","info-circle","italic","leading","link","list","lock","manual","menu","minus","mixed","pack","plus","question-mark-circle","question-mark","redo","reset-zoom","rotate-ccw","rotate-cw","send-backward","send-to-back","share-1","size-extra-large","size-large","size-medium","size-small","spline-cubic","spline-line","stack-horizontal","stack-vertical","status-offline","stretch-horizontal","stretch-vertical","strike","text-align-center","text-align-left","text-align-right","toggle-off","toggle-on","tool-arrow","tool-eraser","tool-frame","tool-hand","tool-highlight","tool-laser","tool-line","tool-media","tool-note","tool-pencil","tool-pointer","tool-screenshot","tool-text","trash","twitter","underline","undo","ungroup","unlock","vertical-align-end","vertical-align-middle","vertical-align-start","warning-triangle","zoom-in","zoom-out"];let Ua={...tm,icons:Object.fromEntries(KH.map(t=>[t,`${Bt()}/icons/icon/0_merged.svg#${t}`])),translations:Object.fromEntries(vc.map(t=>[t.locale,`${Bt()}/translations/${t.locale}.json`])),embedIcons:Object.fromEntries(Ey.map(t=>[t.type,`${Bt()}/embed-icons/${t.type}.png`]))};function fk(t){return v.useMemo(()=>t?{fonts:Object.assign({...Ua.fonts},{...t?.fonts}),icons:Object.assign({...Ua.icons},{...t?.icons}),embedIcons:Object.assign({...Ua.embedIcons},{...t?.embedIcons}),translations:Object.assign({...Ua.translations},{...t?.translations})}:Ua,[t])}const WH=Ot(function({overrides:e,components:n,assetUrls:s,onUiEvent:r,forceMobile:i,mediaMimeTypes:o,children:a}){const c=Tt();return h.jsx(QT.Provider,{value:o,children:h.jsx(hB,{children:h.jsx(DT,{assetUrls:fk(s),children:h.jsx(OT,{overrides:tE(e),locale:c?.user.getLocale()??Jn.locale,children:h.jsx(rB,{onEvent:r,children:h.jsx(xB,{children:h.jsx(SB,{context:"tla",children:h.jsx(j4,{children:h.jsx(tB,{forceMobile:i,children:h.jsx(G8,{overrides:n,children:h.jsx(qH,{overrides:e,children:a})})})})})})})})})})})});function qH({overrides:t,children:e}){const n=qB(t);return h.jsx(V8,{overrides:n.actions,children:h.jsx(GB,{overrides:n.tools,children:e})})}function GH(){const t=z(),{addToast:e}=oi();v.useEffect(()=>{function n({name:s,count:r}){e({title:"Maximum shapes reached",description:`You've reached the maximum number of shapes allowed on ${s} (${r}). Please delete some shapes or move to a different page to continue.`,severity:"warning"})}return t.addListener("max-shapes",n),()=>{t.removeListener("max-shapes",n)}},[t,e])}const YH=Ye.memo(function({renderDebugMenuItems:e,children:n,hideUi:s,components:r,...i}){return h.jsx(WH,{...i,components:r,children:h.jsx(VH,{hideUi:s,renderDebugMenuItems:e,children:n})})}),VH=Ye.memo(function({children:e,hideUi:n,...s}){return O8(),RB(),h.jsxs(h.Fragment,{children:[e,n?null:h.jsx(XH,{...s})]})}),XH=Ye.memo(function(){const e=z(),n=ae(),s=hn(),r=_s(),i=$("focus",()=>e.getInstanceState().isFocusMode,[e]),o=$("debug",()=>e.getInstanceState().isDebugMode,[e]),{SharePanel:a,TopPanel:c,MenuPanel:l,StylePanel:u,Toolbar:d,HelpMenu:p,NavigationPanel:f,HelperButtons:g,DebugPanel:x,Toasts:y,Dialogs:m,A11y:S}=Cr();GH();const w=v.useRef(!1),P=v.useRef(-1),[_,I]=v.useState(!1);Qd("update hide toolbar while delayed",()=>{if(!(qe.isIos||qe.isAndroid))return;if(e.getEditingShapeId()===null){w.current&&(w.current=!1,clearTimeout(P.current),qe.isAndroid?P.current=e.timers.setTimeout(()=>{I(!1)},150):I(!1));return}w.current||(w.current=!0,clearTimeout(P.current),I(!0))},[]);const{"toggle-focus-mode":C}=Tr(),{breakpointsAbove:E,breakpointsBelow:O}=v.useMemo(()=>{const k=[],T=[];for(let D=0;D<cd.length;D++)D<=s?k.push(D):T.push(D);return{breakpointsAbove:k,breakpointsBelow:T}},[s]);return h.jsxs("div",{className:de("tlui-layout",{"tlui-layout__mobile":s<yt.TABLET_SM}),"data-iseditinganything":_,"data-breakpoint":s,"data-breakpoints-above":E.join(" "),"data-breakpoints-below":O.join(" "),children:[h.jsx(F4,{}),i?h.jsx("div",{className:"tlui-layout__top",children:h.jsx(Re,{type:"icon",className:"tlui-focus-button",title:n("focus-mode.toggle-focus-mode"),onClick:()=>C.onSelect("menu"),children:h.jsx(Se,{icon:"dot"})})}):h.jsxs(h.Fragment,{children:[h.jsxs("div",{className:"tlui-layout__top",children:[h.jsxs("div",{className:"tlui-layout__top__left",children:[l&&h.jsx(l,{}),g&&h.jsx(g,{})]}),h.jsx("div",{className:"tlui-layout__top__center",children:c&&h.jsx(c,{})}),h.jsxs("div",{className:"tlui-layout__top__right",children:[a&&h.jsx(a,{}),u&&s>=yt.TABLET_SM&&!r&&h.jsx(u,{})]})]}),h.jsxs("div",{className:"tlui-layout__bottom",children:[h.jsxs("div",{className:"tlui-layout__bottom__main",children:[f&&h.jsx(f,{}),d&&h.jsx(d,{}),p&&h.jsx(p,{})]}),o&&x&&h.jsx(x,{}),S&&h.jsx(S,{})]})]}),y&&h.jsx(y,{}),m&&h.jsx(m,{})]})});function c0(){const{RichTextToolbar:t,ImageToolbar:e,VideoToolbar:n,CursorChatBubble:s,FollowingIndicator:r}=Cr();return h.jsxs(h.Fragment,{children:[t&&h.jsx(t,{}),e&&h.jsx(e,{}),n&&h.jsx(n,{}),r&&h.jsx(r,{}),s&&h.jsx(s,{})]})}const ZH=()=>{const{Spinner:t}=nt();return h.jsx(ST,{children:t?h.jsx(t,{}):null})},JH=[...UH,...JN];function CK(t){const{children:e,maxImageDimension:n,maxAssetSize:s,acceptedImageMimeTypes:r,acceptedVideoMimeTypes:i,onMount:o,components:a={},shapeUtils:c=[],bindingUtils:l=[],tools:u=[],embeds:d,textOptions:p,...f}=t,g=ma(a),x=a?.InFrontOfTheCanvas,y=v.useMemo(()=>f.hideUi?x??null:x?()=>h.jsxs(h.Fragment,{children:[h.jsx(c0,{}),h.jsx(x,{})]}):c0,[f.hideUi,x]),m=v.useMemo(()=>({Scribble:Ov,ShapeIndicators:z9,CollaboratorScribble:Ov,SelectionForeground:R9,Handles:C9,Overlays:A9,Spinner:qT,LoadingScreen:ZH,...g,InFrontOfTheCanvas:y}),[g,y]),S=vi(c),w=v.useMemo(()=>oc("type",S,V2),[S]),P=vi(l),_=v.useMemo(()=>oc("type",P,d2),[P]),I=vi(u),C=v.useMemo(()=>oc("id",I,JH),[I]),E=vi(r??da),O=vi(i??Yd),k=v.useMemo(()=>({addFontsFromNode:h2,...p,tipTapConfig:{extensions:cl,...p?.tipTapConfig}}),[p]),T=v.useMemo(()=>[...E,...O],[E,O]),D=pk(f.assetUrls);return w.find(M=>M.type==="embed")&&d&&Jo.setEmbedDefinitions(d),h.jsx(DT,{assetUrls:fk(f.assetUrls),children:h.jsx(OT,{overrides:tE(f.overrides),locale:f.user?.userPreferences.get().locale??Jn.locale,children:h.jsx(h5,{initialState:"select",...f,components:m,shapeUtils:w,bindingUtils:_,tools:C,textOptions:k,assetUrls:D,children:h.jsxs(YH,{...f,components:m,mediaMimeTypes:T,children:[h.jsx(QH,{maxImageDimension:n,maxAssetSize:s,acceptedImageMimeTypes:E,acceptedVideoMimeTypes:O,onMount:o}),e]})})})})}function QH({maxImageDimension:t,maxAssetSize:e,acceptedImageMimeTypes:n,acceptedVideoMimeTypes:s,onMount:r}){const i=z(),o=oi(),a=ae(),c=St();xT(()=>{const d=[];return d.push(z7(i)),i.fonts.requestFonts(tN),i.once("edit",()=>c("edit",{source:"unknown"})),gN(i,{maxImageDimension:t,maxAssetSize:e,acceptedImageMimeTypes:n,acceptedVideoMimeTypes:s,toasts:o,msg:a}),d.push(i.store.props.onMount(i)),d.push(r?.(i)),()=>{d.forEach(p=>p?.())}});const{Canvas:l}=nt(),{ContextMenu:u}=Cr();return u?h.jsx(u,{}):l?h.jsx(l,{}):null}const eK={tipTapConfig:{extensions:cl},addFontsFromNode:h2};v.memo(function(e){const[n,s]=v.useState(null),[r,i]=v.useState(null),o=vi(e.shapeUtils??[]),a=v.useMemo(()=>oc("type",o,V2),[o]),c=vi(e.bindingUtils??[]),l=v.useMemo(()=>oc("type",c,d2),[c]),u=y4({snapshot:e.snapshot,shapeUtils:a}),{pageId:d,bounds:p,scale:f,pixelRatio:g,background:x,padding:y,darkMode:m,preserveAspectRatio:S,format:w="svg",licenseKey:P,assetUrls:_,textOptions:I=eK}=e,C=pk(_);return v.useLayoutEffect(()=>{if(!r||!u)return;let E=!1;const O=document.createElement("div");r.appendChild(O),r.classList.add("tl-container","tl-theme__light");const k=new re({store:u,shapeUtils:a,bindingUtils:l,tools:[],getContainer:()=>O,licenseKey:P,fontAssetUrls:C.fonts,textOptions:I});d&&k.setCurrentPage(d);const T=k.getCurrentPageShapeIds();async function D(){await k.fonts.loadRequiredFontsForCurrentPage(k.options.maxFontsToLoadBeforeRender);const R=await k.toImage([...T],{bounds:p,scale:f,background:x,padding:y,darkMode:m,preserveAspectRatio:S,format:w});if(!R||E)return;const M=URL.createObjectURL(R.blob);s(M),k.dispose()}return D(),()=>{E=!0}},[w,r,u,a,l,d,p,f,x,y,m,S,P,g,C,I]),v.useEffect(()=>()=>{n&&URL.revokeObjectURL(n)},[n]),h.jsx("div",{ref:i,style:{position:"relative",width:"100%",height:"100%"},children:n&&h.jsx("img",{src:n,referrerPolicy:"strict-origin-when-cross-origin",style:{width:"100%",height:"100%"}})})});v.memo(function({children:e}){const n=ae(),s=hn(),r=v.useRef(null);Ir(r);const i=e??h.jsx(uz,{});return s<yt.MOBILE?null:h.jsx("div",{ref:r,className:"tlui-help-menu",children:h.jsxs(Du,{id:"help menu",children:[h.jsx(Ou,{children:h.jsx(Re,{type:"help",title:n("help-menu.title"),"data-testid":"help-menu.button",children:h.jsx(Se,{icon:"question-mark",small:!0})})}),h.jsx(Lu,{side:"top",align:"end",alignOffset:0,sideOffset:8,children:h.jsx(Kn,{type:"menu",sourceId:"help-menu",children:i})})]})})});const tK=Ne({schemaVersion:In(1),storeVersion:rd,recordVersions:Pd(De,Ne({version:rd,subTypeVersions:Pd(De,rd).optional(),subTypeKey:De.optional()}))}),nK=Ne({schemaVersion:In(2),sequences:Pd(De,rd)});Ne({tldrawFileFormatVersion:rD,schema:iD("schemaVersion",{1:tK,2:nK}),records:on(Ne({id:De,typeName:De}).allowUnknownProperties())});Di("tldraw","4.3.1","esm");export{mo as A,Un as D,Ci as H,rr as R,zi as S,CK as T,Ti as a,Td as b,tt as c,so as d,br as e,Ei as f,Ot as t,z as u};
